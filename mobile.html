<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />
    <title>MML</title>
    <link rel="icon" href="./favicon.ico" />
    
    <style>
        :root {
            --bg: #fafafa;
            --panel: #fff;
            --border: #e0e0e0;
            --text: #222;
            --transport-blue: #3a6fdc;
            --transport-red: #e53935;
            --primary-color: #3a7afe;
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            overscroll-behavior: none; /* 브라우저 오버스클롤 내비게이션 방지 */
        }
        
        body {
            background: var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            touch-action: manipulation;
        }
        
        .mobile-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overscroll-behavior: none; /* 컨테이너에서도 오버스클롤 방지 */
        }
        
        /* 상단바 - 10% */
        .top-bar {
            height: 10vh;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            flex-shrink: 0;
            box-sizing: border-box;
            position: relative;
            gap: 8px;
        }
        
        .top-bar-left, .top-bar-center, .top-bar-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .top-bar-left {
            flex-shrink: 0;
        }
        
        .top-bar-center {
            flex: 1;
            justify-content: center;
            min-width: 0;
        }
        
        .top-bar-right {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: nowrap;
        }
        
    .divider {
            width: 1px;
            height: calc(10vh * 0.4);
            background: var(--border);
            flex-shrink: 0;
        }
        
        .time-sig-section, .tempo-section {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 16px;
            height: calc(10vh * 0.5);
        }
        
        .tempo-display {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 50px;
            text-align: center;
            height: calc(10vh * 0.5);
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }
        
        .tempo-display:hover {
            background: #f0f0f0;
        }
        
        .time-sig-select {
            width: 60px;
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--panel);
            font-size: 16px;
            cursor: pointer;
            height: calc(10vh * 0.5);
            box-sizing: border-box;
            text-align: center;
        }
        
        .track-select, .instrument-select {
            min-width: 120px;
            max-width: 160px;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--panel);
            font-size: 16px;
            cursor: pointer;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            height: calc(10vh * 0.5);
            box-sizing: border-box;
        }
        
        .lang-controls {
            display: flex;
            gap: 3px;
        }
        /* Ensure 3 language buttons are in a row */
        .lang-controls__group {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 3px;
        }
        
        /* 피아노롤 - 35% */
        .pianoroll-area {
            height: 35vh;
            background: #ffffff;
            border-bottom: 2px solid var(--border);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }
        
        .time-ruler {
            height: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        
        .pianoroll-main {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #ffffff;
            touch-action: none; /* 기본 제스처(뒤로가기 등) 비활성화, 사용자 정의 제스처만 처리 */
        }

        /* pianoroll-content가 부모 높이를 넘지 않도록 flex 컨테이너로 구성 */
        .pianoroll-content {
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
            min-height: 0; /* flex 자식 높이 수축 허용 */
        }

        /* flex 레이아웃에서 자식 캔버스 영역이 넘치지 않도록 */
        .pianoroll-main { min-height: 0; }
        
        .playhead {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(255, 0, 0, 0.9);
            z-index: 100;
            pointer-events: none;
            left: 100px;
        }
        
        /* 중단바 - 10% */
        .middle-bar {
            height: 10vh;
            background: linear-gradient(135deg, #f1f3f4 0%, #e8eaed 100%);
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            flex-shrink: 0;
            box-sizing: border-box;
            position: relative;
            gap: 12px;
        }
        
        .middle-bar-left, .middle-bar-center, .middle-bar-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .middle-bar-left {
            flex-shrink: 0;
        }
        
        .middle-bar-center {
            flex: 1;
            justify-content: center;
        }
        
        .middle-bar-right {
            flex-shrink: 0;
        }
        
        .time-display {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 6px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            font-weight: 400;
            font-size: 16px;
            min-width: 140px;
            text-align: center;
            height: calc(10vh * 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }
        
        .transport-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .transport-controls .btn {
            background: none;
            border: none;
            padding: 12px;
            border-radius: 8px;
            min-width: 56px;
            height: 56px;
            transition: background-color 0.2s ease;
        }
        
        .transport-controls .btn:hover {
            background: rgba(0, 0, 0, 0.1);
            transform: none;
        }
        
        .transport-controls .btn:active {
            background: rgba(0, 0, 0, 0.2);
            transform: none;
        }
        
        .transport-controls .btn img {
            width: 24px;
            height: 24px;
        }
        
        .btn--record {
            background: none;
            color: var(--transport-red);
            border: none;
        }
        
        .btn--record:hover {
            background: rgba(229, 57, 53, 0.1);
        }
        
        .btn--record:active {
            background: rgba(229, 57, 53, 0.2);
        }
        
        .btn--metronome {
            background: var(--panel);
            color: var(--text);
            border-color: var(--border);
            min-width: 48px;
            height: calc(10vh * 0.5);
        }
        
        .btn--metronome img {
            width: 20px;
            height: 20px;
        }
        
        .btn--metronome.active {
            background: #e3f2fd;
            color: #1976d2;
            border-color: #90caf9;
        }
        
        .btn--metronome:hover {
            background: #f5f5f5;
        }
        
        .btn--metronome.active:hover {
            background: #bbdefb;
        }
        
        /* 피아노롤 편집 버튼 활성화 스타일 */
        #btnEditPianoroll.active {
            background: #e3f2fd;
            color: #1976d2;
            border-color: #90caf9;
        }
        
        #btnEditPianoroll:hover {
            background: #f5f5f5;
        }
        
        #btnEditPianoroll.active:hover {
            background: #bbdefb;
        }
        
        /* 편집 모드 스타일 */
        .edit-mode .keyboard-area {
            display: none;
        }
        
        .edit-mode .pianoroll-area {
            /* 새 편집 도구 바(8vh)를 추가하므로 피아노롤은 72vh로 축소 */
            height: 72vh;
            display: flex;
            flex-direction: row;
        }
        
        .edit-mode .tracks-panel {
            display: block;
            background: var(--panel);
            border-right: 1px solid #ddd; /* 좌측 패널 분리선 */
            padding: 8px 4px; /* 스크롤 시 좌우 여백 */
            overflow-y: auto; /* 스크롤 허용 */
            overflow-x: hidden;
            order: -1; /* 좌측 배치 */
        }
        
        .tracks-panel {
            display: none;
            width: 200px;
            min-width: 200px;
            max-width: 200px;
        }
        
        /* 트랙 리스트: 6등분 제거, 넉넉한 카드 높이 + 스크롤 */
        .tracks {
            padding: 8px;
            display: grid;
            grid-auto-rows: 108px; /* 각 트랙 카드 높이 */
            row-gap: 8px;
            box-sizing: border-box;
            /* 세로 스크롤은 부모(.tracks-panel)의 overflow-y:auto가 담당 */
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        .track-card {
            display: grid;
            grid-template-columns: 10px 1fr;
            gap: 8px;
            padding: 10px;
            border-radius: 6px;
            align-items: center;
            cursor: pointer;
            border: 1px solid #ddd;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
            transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.25s ease;
            background: #fff;
            height: auto; /* 내용에 맞게, grid-auto-rows로 기본 높이 제어 */
        }
        .track-card.is-active {
            border-color: #3a7afe;
            box-shadow: 0 0 0 2px rgba(58, 122, 254, 0.1) inset;
            background: #ffffe0;
        }
        .track-card:not(.is-active):hover { background: #fcfcff; }
        .track-color { width: 10px; height: 100%; border-radius: 4px; }
    .track-main { display: grid; grid-template-rows: auto auto auto; row-gap: 8px; height: 100%; min-width: 0; }
        .track-row { display: flex; gap: 8px; align-items: center; min-width: 0; }
        .track-row--bottom { display: grid; grid-template-columns: 1fr auto; align-items: center; column-gap: 8px; }
        .track-name { flex: 1 1 auto; min-width: 0; }
        .track-name input { width: 100%; box-sizing: border-box; padding: 4px 6px; font-size: 12px; }
    .track-instrument { min-width: 0; }
    .track-instrument select { width: 100%; min-width: 0; }
    .track-controls { display: inline-flex; gap: 4px; }
    .track-controls button { width: 24px; height: 24px; font-size: 12px; font-weight: 700; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; background: #fff; color: #000; padding: 0; transition: background-color 0.15s ease, color 0.15s ease, border-color 0.15s ease; }
    .track-controls button.is-active[data-kind="mute"] { background: #f44336; color: #fff; border-color: #d32f2f; }
    .track-controls button.is-active[data-kind="solo"] { background: #ff9800; color: #fff; border-color: #ef6c00; }
        .track-charcount { font-size: 11px; color: #666; white-space: nowrap; justify-self: end; }

        /* 편집 모드에서 중단바 트랙/악기 선택 숨김 */
        .edit-mode .middle-bar-left .track-select,
        .edit-mode .middle-bar-left .instrument-select { display: none; }
    /* 편집 모드에서 좌측 컨테이너 자체 제거하여 불필요 여백 제거 */
    .edit-mode .middle-bar-left { display: none; }
    /* 편집 모드에서는 가운데 영역을 좌측 정렬하여 공백 최소화 */
    .edit-mode .middle-bar-center { justify-content: flex-start; }

    /* 편집 모드에서는 녹음 버튼을 완전히 숨김 */
    .edit-mode #btnRecord { display: none; }

    /* 녹음 중: 정지 버튼(#btnStop) 제외 모든 인터랙션 비활성화/시각적 흐림 */
    .recording-mode .btn:not(#btnStop),
    .recording-mode select,
    .recording-mode input,
    .recording-mode textarea,
    .recording-mode .dropdown {
        filter: grayscale(1);
        opacity: 0.5;
        pointer-events: none;
    }

    /* 재생 중: 일시정지/정지 버튼만 활성, 나머지 비활성화/시각적 흐림 */
    .playing-mode .btn:not(#btnPause):not(#btnStop),
    .playing-mode select,
    .playing-mode input,
    .playing-mode textarea,
    .playing-mode .dropdown {
        filter: grayscale(1);
        opacity: 0.5;
        pointer-events: none;
    }

    /* 모달 기본 스타일 (피아노롤을 가리지 않도록 투명 오버레이 + 상단 고정 작은 패널) */
    .modal-overlay { position: fixed; inset: 0; background: transparent; display: none; align-items: flex-end; justify-content: center; padding: 0 12px 12px; z-index: 9999; pointer-events: none; }
    .modal-overlay.open { display: flex; }
    .modal { background: #fff; color: #222; border-radius: 12px; width: min(92vw, 440px); box-shadow: 0 10px 24px rgba(0,0,0,0.25); pointer-events: auto; }
    .modal__header { padding: 14px 16px; border-bottom: 1px solid #eee; font-weight: 600; font-size: 16px; }
    .modal__body { padding: 16px; display: grid; gap: 12px; }
    .modal__row { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 8px; }
    .modal__footer { padding: 12px 16px; border-top: 1px solid #eee; display: flex; gap: 8px; justify-content: flex-end; }
    .modal label { font-size: 14px; }
    .modal select, .modal input[type="checkbox"] { font-size: 14px; }

    /* 스냅 단위 버튼 그룹 */
    .quant-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
    .grid-btn { display: inline-flex; align-items: center; justify-content: center; height: 40px; border-radius: 10px; border: 1px solid #d0d0d0; background: #fff; color: #222; font-weight: 600; }
    .grid-btn.active { background: #3a7afe; color: #fff; border-color: #3a7afe; }
    .grid-btn:active { transform: translateY(1px); }

    /* 재생/녹음 모드에서도 모달 상호작용은 허용 */
    .playing-mode .modal-overlay *, .recording-mode .modal-overlay * { pointer-events: auto !important; filter: none !important; opacity: 1 !important; }

    /* 전송바 구분선 및 키 높이 슬라이더 */
    /* 기본적으로 구분선/노트 길이 선택 숨김 */
    .transport-divider { display: none; width: 1px; height: calc(10vh * 0.5); background: var(--border); margin: 0 8px; }
    #noteLengthSelect { display: none; }
    .edit-mode #noteLengthSelect { display: inline-block; }
    .keyheight-controls { display: none; align-items: center; gap: 6px; }
    .keyheight-label { font-size: 12px; color: #666; min-width: 28px; text-align: right; }
    #keyHeightRangeMobile { height: calc(10vh * 0.35); accent-color: var(--primary-color); width: 120px; }
    .edit-mode .keyheight-controls { display: inline-flex; }

    /* 노트 생성 버튼: 기본 숨김, 편집 모드에서만 표시 */
    #btnNoteCreate { display: none; }
    .edit-mode #btnNoteCreate { display: inline-block; }
    /* 노트 생성 버튼 활성화 시 파란색 하이라이트 */
    #btnNoteCreate.active { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }
    #btnNoteCreate.active:hover { background: #2f65d2; }

    /* 녹음 볼륨 버튼: 편집 모드에서는 숨김 */
    .edit-mode #btnRecVolume { display: none; }

    /* 편집 도구 바: 편집 모드에서만 표시되는 하단 도구영역 */
    .edit-tools-bar { display: none; height: 8vh; background: linear-gradient(135deg, #f1f3f4 0%, #e8eaed 100%); border-top: 2px solid var(--border); border-bottom: 2px solid var(--border); padding: 0 16px; box-sizing: border-box; align-items: center; justify-content: space-between; gap: 12px; }
    .edit-mode .edit-tools-bar { display: flex; }
    .edit-tools-left, .edit-tools-right { display: flex; align-items: center; gap: 8px; }
    /* 편집툴바 안의 구분선은 높이를 더 줄임 */
    .edit-tools-bar .divider { height: 60%; }
        
        /* 편집 모드에서 피아노롤과 트랙 패널을 가로 배치 */
        .edit-mode .pianoroll-area {
            display: flex;
            flex-direction: row;
        }
        
        .edit-mode .pianoroll-content {
            flex: 1;
        }
        
        /* 건반 - 45% */
        .keyboard-area {
            height: 45vh;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            touch-action: none;
        }
        
        .keyboard-container {
            position: relative;
            width: 100%;
            height: calc(100% - 20px);
            overflow: hidden;
            flex: 1;
        }
        
        .keyboard-scrollbar {
            height: 20px;
            width: 100%;
            background: #f5f5f5;
            border-top: 1px solid var(--border);
            position: relative;
            cursor: pointer;
        }
        
        .scrollbar-track {
            width: 100%;
            height: 100%;
            position: relative;
            background: linear-gradient(to right, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .scrollbar-thumb {
            position: absolute;
            top: 0px;
            height: 20px;
            background: #6c757d;
            border-radius: 4px;
            cursor: grab;
            transition: background 0.2s ease;
            min-width: 40px;
            border: 1px solid #495057;
        }
        
        .scrollbar-thumb:hover {
            background: #5a6268;
        }
        
        .scrollbar-thumb:active {
            cursor: grabbing;
            background: #495057;
        }
        
        .keyboard {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            display: flex;
            touch-action: none;
        }
        
        .key {
            position: relative;
            cursor: pointer;
            user-select: none;
            border: 1px solid #ccc;
            transition: background-color 0.1s ease;
            touch-action: none;
        }
        
        .key.white {
            background: #ffffff;
            border-color: #ddd;
            width: 60px;
            height: 100%;
            position: absolute;
            z-index: 1;
            border-radius: 0 0 6px 6px;
        }
        
        .key.black {
            background: #2c2c2c;
            border-color: #1a1a1a;
            width: 36px;
            height: 65%;
            position: absolute;
            z-index: 2;
            color: #fff;
            border-radius: 0 0 4px 4px;
        }
        
        .key-label {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: 500;
            pointer-events: none;
            user-select: none;
        }
        
        .key.white .key-label {
            color: #999;
        }
        
        .key.black .key-label {
            color: #ccc;
        }
        
        .key.white:active,
        .key.white.pressed {
            background: #fff3cd;
            border-color: #ffeaa7;
        }
        
        .key.black:active,
        .key.black.pressed {
            background: #4a4a4a;
            border-color: #666;
        }
        
        .key.white:hover {
            background: #f8f9fa;
        }
        
        .key.black:hover {
            background: #3c3c3c;
        }
        
        .btn {
            appearance: none;
            -webkit-appearance: none;
            border: none;
            background: var(--panel);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            height: calc(10vh * 0.5);
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn img {
            width: 16px;
            height: 16px;
            pointer-events: none;
        }
        
        .btn:hover {
            background: #f5f5f5;
            transform: translateY(-1px);
        }
        
        .btn:active {
            transform: translateY(0px);
        }
        
        .btn--primary {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .btn--primary:hover {
            background: #2f65d2;
        }
        
        .btn--lang {
            min-width: 40px;
            padding: 8px 10px;
            font-size: 16px;
            white-space: nowrap;
        }
        
        .btn--lang.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
    </style>
  <script type="module" crossorigin src="./assets/mobile-D7b82T5C.js"></script>
  <link rel="modulepreload" crossorigin href="./assets/languages-BtlVKnIV.js">
</head>
<body>
    <div class="mobile-container">
        <!-- 상단바 - 10% -->
        <div class="top-bar">
            <div class="top-bar-left">
                <div class="time-sig-section">
                    <select class="time-sig-select" id="timeSigSelect">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4" selected>4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                    </select>
                    <span>/ 4</span>
                </div>
                
                <div class="divider"></div>
            </div>
            
            <div class="top-bar-center">
                <button class="btn" id="btnUndo">Undo</button>
                <button class="btn" id="btnRedo">Redo</button>
            </div>
            
            <div class="top-bar-right">
                <button class="btn" id="btnPasteMML" data-i18n="paste">MML@... 붙여넣기</button>
                <button class="btn" id="btnConvert" data-i18n="convert">변환</button>
                <button class="btn" id="btnLoad" data-i18n="load">불러오기</button>
                
                <div class="divider"></div>
                
                <button class="btn" id="btnGuide" data-i18n="guide">조작 가이드</button>
                
                <div class="lang-controls">
                                        <div class="lang-controls__group" role="radiogroup" aria-label="Language">
                                            <button class="btn btn--lang active" id="langKo" role="radio" aria-checked="true" data-i18n-title="tooltipLangKo" title="Korean">한</button>
                                            <button class="btn btn--lang" id="langJa" role="radio" aria-checked="false" data-i18n-title="tooltipLangJa" title="Japanese">日</button>
                                            <button class="btn btn--lang" id="langEn" role="radio" aria-checked="false" data-i18n-title="tooltipLangEn" title="English">En</button>
                                        </div>
                </div>
                
                <button class="btn" id="btnDesktop" data-i18n="btnGoToDesktop" data-i18n-title="tooltipGoToDesktop" title="PC 버전">PC 버전</button>
            </div>
        </div>
        
        <!-- 피아노롤 - 35% -->
        <div class="pianoroll-area">
            <div class="pianoroll-content">
                <div class="time-ruler">
                    <canvas id="timeRulerCanvas" style="width: 100%; height: 100%; display: block;"></canvas>
                </div>
                
                <div class="pianoroll-main">
                    <canvas id="pianorollCanvas" style="width: 100%; height: 100%; display: block;"></canvas>
                    <div class="playhead" id="playhead"></div>
                </div>
            </div>
            
            <!-- 편집 모드 전용 트랙 패널 (좌측) -->
            <div class="tracks-panel" id="tracksPanel">
                <div class="tracks" id="tracks"></div>
            </div>
        </div>
        
        <!-- 중단바 - 10% -->
        <div class="middle-bar">
            <div class="middle-bar-left">
                <select class="track-select" id="trackSelect">
                    <option value="0">Track 1</option>
                    <option value="1">Track 2</option>
                    <option value="2">Track 3</option>
                    <option value="3">Track 4</option>
                    <option value="4">Track 5</option>
                    <option value="5">Track 6</option>
                </select>
                
                <select class="instrument-select" id="instrumentSelect"></select>
            </div>
            
            <div class="middle-bar-center">
                <button class="btn btn--metronome" id="btnMetronome"><img src="./images/metronome.svg" alt="Metronome" /></button>
                
                <div class="time-display" id="timeDisplay">00:00.000 / 00:00.000</div>
                
                <div class="transport-controls">
                    <button class="btn btn--transport" id="btnPlay"><img src="./images/play.svg" alt="Play" /></button>
                    <button class="btn btn--record" id="btnRecord"><img src="./images/rec.svg" alt="Record" /></button>
                    <button class="btn btn--transport" id="btnPause"><img src="./images/pause.svg" alt="Pause" /></button>
                    <button class="btn btn--stop" id="btnStop"><img src="./images/stop.svg" alt="Stop" /></button>
                    <div class="transport-divider"></div>
                </div>
            </div>
            
            <div class="middle-bar-right">
                <button class="btn" id="btnRecVolume" data-i18n="btnRecVolume">녹음 볼륨</button>
                <div class="keyheight-controls">
                    <span class="keyheight-label" id="keyHeightLabel">24px</span>
                    <input type="range" id="keyHeightRangeMobile" min="16" max="32" step="1" value="24" />
                </div>
                
                <button class="btn" id="btnEditPianoroll" data-i18n="btnEditPianoroll">편집 모드</button>
            </div>
        </div>

        <!-- 편집 도구 모음(편집 모드 전용, 중단바 아래) -->
        <div class="edit-tools-bar">
            <div class="edit-tools-left">
                <select class="instrument-select" id="noteLengthSelect" title="노트 길이">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="4">4</option>
                    <option value="8">8</option>
                    <option value="16" selected>16</option>
                    <option value="32">32</option>
                    <option value="12">12</option>
                    <option value="24">24</option>
                    <option value="48">48</option>
                </select>
                <button class="btn" id="btnNoteCreate" data-i18n="btnNoteCreateLabel" data-i18n-title="tooltipNoteCreate" title="노트 생성 모드 토글">노트 생성</button>
                <div class="divider"></div>
                <!-- Beat+/Bar+/Beat-/Bar- (데스크톱 타임라인 조작 포팅) -->
                <button class="btn" id="btnPushBeat" data-i18n="btnBeatPlus" data-i18n-title="tooltipBeatPlus" title="플레이헤드 오른쪽을 한 박 밀기">Beat+</button>
                <button class="btn" id="btnPushBar" data-i18n="btnBarPlus" data-i18n-title="tooltipBarPlus" title="플레이헤드 오른쪽을 한 마디 밀기">Bar+</button>
                <button class="btn" id="btnCutBeat" data-i18n="btnBeatMinus" data-i18n-title="tooltipBeatMinus" title="플레이헤드 오른쪽 한 박을 잘라내고 당기기">Beat-</button>
                <button class="btn" id="btnCutBar" data-i18n="btnBarMinus" data-i18n-title="tooltipBarMinus" title="플레이헤드 오른쪽 한 마디를 잘라내고 당기기">Bar-</button>
                <div class="divider"></div>
                <button class="btn" id="btnCopy" data-i18n="btnCopyLabel" data-i18n-title="tooltipCopyNotes" title="선택 노트 복사">복사</button>
                <button class="btn" id="btnCut" data-i18n="btnCutLabel" data-i18n-title="tooltipCutNotes" title="잘라내기">잘라내기</button>
                <button class="btn" id="btnPaste" data-i18n="btnPasteLabel" data-i18n-title="tooltipPasteNotes" title="붙여넣기">붙여넣기</button>
                <div class="divider"></div>
                <button class="btn" id="btnVolumeDown" data-i18n="btnVolumeDownLabel" data-i18n-title="tooltipVolumeDown" title="선택 볼륨 감소">볼륨-</button>
                <button class="btn" id="btnVolumeUp" data-i18n="btnVolumeUpLabel" data-i18n-title="tooltipVolumeUp" title="선택 볼륨 증가">볼륨+</button>
            </div>
            <div class="edit-tools-right"></div>
        </div>
        
        <!-- 건반 - 45% -->
        <div class="keyboard-area">
            <div class="keyboard-container" id="keyboardContainer">
                <div class="keyboard" id="keyboard">
                    <!-- 건반은 JavaScript로 동적 생성 -->
                </div>
            </div>
            <div class="keyboard-scrollbar" id="keyboardScrollbar">
                <div class="scrollbar-track">
                    <div class="scrollbar-thumb" id="scrollbarThumb"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quantize Modal -->
    <div class="modal-overlay" id="quantizeModal">
        <div class="modal" style="margin-bottom: env(safe-area-inset-bottom, 12px);">
            <div class="modal__header">녹음 적용 옵션</div>
            <div class="modal__body">
                <div class="modal__row" style="grid-template-columns: 1fr;">
                    <label>스냅 단위</label>
                    <div class="quant-grid" id="quantGridButtons">
                        <button class="grid-btn" data-grid="1">1</button>
                        <button class="grid-btn" data-grid="2">2</button>
                        <button class="grid-btn" data-grid="4">4</button>
                        <button class="grid-btn" data-grid="8">8</button>
                        <button class="grid-btn active" data-grid="16">16</button>
                        <button class="grid-btn" data-grid="32">32</button>
                    </div>
                </div>
                <div class="modal__row">
                    <label for="quantTriplet">셋잇단 포함</label>
                    <input type="checkbox" id="quantTriplet" />
                </div>
            </div>
            <div class="modal__footer">
                <button class="btn" id="quantCancel">취소</button>
                <button class="btn btn--primary" id="quantApply">적용</button>
            </div>
        </div>
    </div>

        <script>
        // 크롬 DevTools 기기 툴바 등에서 좌/우 스와이프에 의한 뒤로가기 방지
        (function(){
            // history에 더미 상태를 push하고 popstate를 가로채서 되돌리지 않음
            const push = () => { try { history.pushState({preventBack: true}, '', location.href); } catch(e) {} };
            push();
            window.addEventListener('popstate', (e) => {
                if (e.state && e.state.preventBack) {
                    push();
                }
            });

            // 터치 제스처 중 기본 동작 억제 (필요시)
            const main = document.querySelector('.pianoroll-main');
            if (main) {
                const prevent = (ev) => { ev.preventDefault(); };
                main.addEventListener('touchmove', prevent, { passive: false });
                main.addEventListener('touchstart', prevent, { passive: false });
            }
        })();
        </script>
</body>
</html>
