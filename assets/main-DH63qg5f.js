import{I as yt,M as Je,T as S,P as _,D,c as Eo,s as Co,E as Lt,B as St,H as nn,a as Et,b as _t,L as Ne,e as an,t as we,d as rn,p as ut,_ as Ct,f as Jt,g as ln,h as dn,i as sn,j as pt,k as Po,l as te,m as cn}from"./timeline-U0IUL4mT.js";import{notesToMMLRaw as zt,notesToMML as un,newOptimizeBody as Do,mmlToNotes as pn}from"./converter-mdVI9f7q.js";let Qt=!1;function ve(){if(Qt)return;const e=document.createElement("style");e.id="app-button-styles",e.textContent=`
  :root {
    --btn-font: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    --btn-radius: 8px;
    --btn-pad-y: 6px; --btn-pad-x: 12px;
    --btn-fg: #1f2937; --btn-bg: #ffffff; --btn-bd: #cfd3d8;
    --btn-fg-primary: #ffffff; --btn-bg-primary: #3a7afe; --btn-bd-primary: #2f65d2;
    --btn-fg-danger: #ffffff; --btn-bg-danger: #ef4444; --btn-bd-danger: #dc2626;
    --btn-fg-ghost: #374151; --btn-bg-ghost: transparent; --btn-bd-ghost: #d1d5db;
    --btn-hover: 0.97; --btn-active: 0.94;
  }
  .btn { font: 500 13px/1 var(--btn-font); padding: var(--btn-pad-y) var(--btn-pad-x); border-radius: var(--btn-radius); cursor: pointer; border:1px solid var(--btn-bd); background: var(--btn-bg); color: var(--btn-fg); transition: filter .15s ease, background .15s ease, border-color .15s ease, transform .15s ease, box-shadow .15s ease; }
  .btn:hover { filter: brightness(var(--btn-hover)); }
  .btn:active { filter: brightness(var(--btn-active)); transform: translateY(0.5px); }
  .btn:disabled { opacity: .6; cursor: not-allowed; }
  .btn--primary { color: var(--btn-fg-primary); background: var(--btn-bg-primary); border-color: var(--btn-bd-primary); }
  .btn--danger { color: var(--btn-fg-danger); background: var(--btn-bg-danger); border-color: var(--btn-bd-danger); }
  .btn--ghost { color: var(--btn-fg-ghost); background: var(--btn-bg-ghost); border-color: var(--btn-bd-ghost); }
  .btn--secondary { /* defaults already set by .btn */ }
  .btn--sm { padding: 4px 8px; font-size: 12px; }
  .btn--md { padding: 6px 12px; font-size: 13px; }
  .btn--lg { padding: 10px 16px; font-size: 15px; }
  `,document.head.appendChild(e),Qt=!0}function gn(e,t){ve();const o=t?.variant??"secondary",n=t?.size??"md";return e.classList.add("btn",`btn--${o}`,`btn--${n}`),t?.label!=null&&(e.textContent=t.label),t?.title&&(e.title=t.title),t?.disabled!=null&&(e.disabled=t.disabled),t?.onClick&&(e.onclick=t.onClick),t?.attrs&&Object.entries(t.attrs).forEach(([r,a])=>e.setAttribute(r,a)),e}function de(e){const t=document.createElement("button");return gn(t,e)}let eo=!1;function mn(){if(eo)return;const e=`
  :root {
    --dd-radius: 6px;
    --dd-border: #cfcfcf;
    --dd-border-hover: #b5b5b5;
    --dd-bg: #fff;
    --dd-text: #111;
    --dd-muted: #6b7280;
    --dd-shadow: 0 8px 24px rgba(0,0,0,0.12), 0 2px 6px rgba(0,0,0,0.08);
    --dd-focus: 0 0 0 3px rgba(33,150,243,0.15);
  }

  .dropdown { position: relative; display: inline-flex; }
  .dropdown--full { width: 100%; }

  .dropdown__button {
    display: inline-flex; align-items: center; justify-content: space-between;
    gap: 8px; width: 100%;
    background: var(--dd-bg);
    color: var(--dd-text);
    border: 1px solid var(--dd-border);
    border-radius: var(--dd-radius);
    cursor: pointer; user-select: none;
    transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
  }
  .dropdown__button:hover { border-color: var(--dd-border-hover); }
  .dropdown__button:focus-visible { outline: none; box-shadow: var(--dd-focus); }

  .dropdown__button--sm { height: 28px; padding: 4px 8px; font-size: 12px; }
  .dropdown__button--md { height: 34px; padding: 6px 10px; font-size: 14px; }
  .dropdown__button--lg { height: 40px; padding: 8px 12px; font-size: 16px; }

  .dropdown__caret { width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 6px solid #888; }

  .dropdown__menu {
    position: absolute; left: 0; top: calc(100% + 4px);
    min-width: 100%;
    background: #fff; border: 1px solid var(--dd-border);
    border-radius: var(--dd-radius);
    box-shadow: var(--dd-shadow);
    padding: 6px; margin: 0; list-style: none;
    z-index: 1000; display: block; opacity: 0; transform: var(--dd-transform, translateY(4px));
    pointer-events: none; transition: opacity .16s ease, transform .16s ease;
  }
  .dropdown__menu[data-open="true"] { opacity: 1; transform: translateY(0); pointer-events: auto; }

  .dropdown__item {
    padding: 6px 8px; border-radius: 6px; cursor: pointer;
    white-space: nowrap; color: var(--dd-text);
  }
  .dropdown__item[aria-selected="true"] { background: #eef6ff; }
  .dropdown__item:hover { background: #f3f4f6; }
  .dropdown__item:focus { outline: none; box-shadow: var(--dd-focus); }
  `,t=document.createElement("style");t.id="dropdown-styles",t.textContent=e,document.head.appendChild(t),eo=!0}function hn(e){mn();const t=e.size??"md";let o=e.value??e.items[0]?.value??"",n=e.items;const r=document.createElement("div");r.className="dropdown",r.classList.add("dropdown--full");const a=document.createElement("button");a.type="button",a.className=`dropdown__button dropdown__button--${t}`,a.setAttribute("aria-haspopup","listbox"),a.setAttribute("aria-expanded","false");const l=document.createElement("span");l.textContent=e.items.find(T=>T.value===o)?.label??"";const u=document.createElement("i");u.className="dropdown__caret",a.append(l,u);const d=document.createElement("ul");d.className="dropdown__menu",d.setAttribute("role","listbox"),d.setAttribute("tabindex","-1");const s=r;let c=!1;function g(){d.innerHTML="";for(const T of n){const x=document.createElement("li");x.className="dropdown__item",x.setAttribute("role","option"),x.setAttribute("tabindex","0"),x.setAttribute("aria-selected",String(T.value===o)),x.textContent=T.label,x.addEventListener("click",()=>M(T.value)),x.addEventListener("keydown",w=>{w.key==="Enter"||w.key===" "?(w.preventDefault(),M(T.value)):w.key==="Escape"?(w.preventDefault(),h(),a.focus()):w.key==="ArrowDown"?(w.preventDefault(),C(x)):w.key==="ArrowUp"&&(w.preventDefault(),B(x))}),d.appendChild(x)}}function m(){g(),c||(document.body.appendChild(d),c=!0,d.style.position="fixed",d.style.zIndex="1000");const T=a.getBoundingClientRect();d.style.minWidth=T.width+"px",L(),d.dataset.open="true",a.setAttribute("aria-expanded","true"),window.addEventListener("mousedown",v,{capture:!0}),window.addEventListener("scroll",k,!0),window.addEventListener("resize",k)}function h(){delete d.dataset.open,a.setAttribute("aria-expanded","false"),c&&(s.appendChild(d),c=!1,d.style.position="",d.style.left="",d.style.top="",d.style.minWidth="",d.style.zIndex=""),window.removeEventListener("mousedown",v,{capture:!0}),window.removeEventListener("scroll",k,!0),window.removeEventListener("resize",k)}function f(){d.dataset.open==="true"?h():m()}function v(T){const x=T.target;r.contains(x)||d.contains(x)||h()}function k(){d.dataset.open==="true"&&L()}function L(){const T=a.getBoundingClientRect(),x=d.getBoundingClientRect(),w=window.innerHeight,E=window.innerWidth,N=8,Z=4,se=Math.max(x.width,T.width);let it=Math.min(Math.max(T.left,N),Math.max(N,E-se-N));const bt=w-T.bottom-N,jt=T.top-N;let Yt=!1,at=Math.min(360,Math.max(bt-Z,120));x.height>bt&&jt>bt&&(Yt=!0,at=Math.min(360,Math.max(jt-Z,120)));let vt;Yt?(vt=Math.max(N,T.top-Z-Math.min(x.height,at)),d.dataset.placement="top",d.style.setProperty("--dd-transform","translateY(-4px)")):(vt=Math.min(w-N-Math.min(x.height,at),T.bottom+Z),d.dataset.placement="bottom",d.style.setProperty("--dd-transform","translateY(4px)")),d.style.top=`${Math.round(vt)}px`,d.style.left=`${Math.round(it)}px`,d.style.maxHeight=`${at}px`,d.style.overflowY="auto"}function M(T){if(T===o){h(),a.focus();return}o=T,l.textContent=n.find(x=>x.value===o)?.label??"",h(),a.focus(),e.onChange(o)}function C(T){const x=Array.from(d.querySelectorAll(".dropdown__item")),w=x.indexOf(T);x[Math.min(x.length-1,w+1)]?.focus()}function B(T){const x=Array.from(d.querySelectorAll(".dropdown__item")),w=x.indexOf(T);x[Math.max(0,w-1)]?.focus()}a.addEventListener("click",()=>f()),a.addEventListener("keydown",T=>{if(T.key==="ArrowDown"||T.key==="Enter"||T.key===" ")T.preventDefault(),m();else if(T.key==="ArrowUp"){T.preventDefault(),m();const x=d.querySelectorAll(".dropdown__item");x[x.length-1]?.focus()}});function V(T){n=T;const x=n.find(w=>w.value===o);x?l.textContent=x.label:l.textContent="",d.dataset.open==="true"&&g()}return r.append(a,d),{el:r,get value(){return o},set value(T){M(T)},updateItems:V}}let to=!1;function Bo(){if(to)return;const e=`
  :root {
    --fc-radius: 6px;
    --fc-border: #cfcfcf;
    --fc-border-hover: #b5b5b5;
    --fc-border-focus: #2196f3;
    --fc-bg: #ffffff;
    --fc-bg-disabled: #f7f7f7;
    --fc-text: #111;
    --fc-placeholder: #9aa0a6;
    --fc-shadow-focus: 0 0 0 3px rgba(33,150,243,0.15);
  }

  .input, .select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    box-sizing: border-box;
    font: inherit;
    color: var(--fc-text);
    background: var(--fc-bg);
    border: 1px solid var(--fc-border);
    border-radius: var(--fc-radius);
    outline: none;
    transition: border-color .2s ease, box-shadow .2s ease, background .2s ease, transform .15s ease;
  }

  .input::placeholder {
    color: var(--fc-placeholder);
  }

  .input:hover, .select:hover {
    border-color: var(--fc-border-hover);
  }

  .input:focus, .select:focus {
    border-color: var(--fc-border-focus);
    box-shadow: var(--fc-shadow-focus);
  }

  /* Sizes */
  .fc--sm { height: 28px; padding: 4px 8px; font-size: 12px; }
  .fc--md { height: 34px; padding: 6px 10px; font-size: 14px; }
  .fc--lg { height: 40px; padding: 8px 12px; font-size: 16px; }

  /* Full width helper */
  .fc--full { width: 100%; }

  /* Number inputs: right align helper */
  .fc--num-right { text-align: right; }

  /* Disabled */
  .input:disabled, .select:disabled { background: var(--fc-bg-disabled); color: #888; cursor: not-allowed; }

  /* Select arrow */
  .select {
    background-image: url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5' stroke='%23888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 16px 16px;
    padding-right: 28px; /* space for arrow */
  }

  /* Remove default arrow on some browsers */
  .select::-ms-expand { display: none; }
  `,t=document.createElement("style");t.id="form-control-styles",t.textContent=e,document.head.appendChild(t),to=!0}function fn(e,t){Bo(),e.classList.add("input");const o=t?.size;e.classList.add(yn(o)),e.classList.add("fc--full"),t?.rightAlign&&e.classList.add("fc--num-right")}function yn(e){return e==="sm"?"fc--sm":e==="lg"?"fc--lg":"fc--md"}const b={ko:{whatsNewTitle:"업데이트 안내",whatsNew_20250827_heading:"불러오기 방식 변경",whatsNew_20250827_p1:"페이지 로드시 자동 불러오기를 제거했습니다.",whatsNew_20250827_p2:"저장된 작업을 복구하려면 툴바의 '불러오기' 버튼을 눌러주세요.",loadPrevious:"이전 작업을 불러올까요? (확인: 이어서 작업, 취소: 새 프로젝트)",tempoLabel:"Tempo",tempoModalTitle:"템포 설정",ok:"확인",cancel:"취소",modalClose:"닫기",playheadAreaLabel:"플레이헤드: 영역",playheadLineLabel:"플레이헤드: 막대",tooltipPlayheadToggle:"플레이헤드 표시 전환 (영역/막대)",convertCopy:"클립보드에 복사",convertSaveTxt:"TXT로 저장",convertFilenameLabel:"파일명",convertFilenamePlaceholder:"예: my-song.txt",copied:"복사됨!",savedToLocal:"로컬 스토리지에 저장됨",trackMMLLabel:"트랙MML",edit:"편집",bpm:"bpm",convert:"변환",paste:"붙여넣기",guide:"조작가이드",track:"트랙",charUnit:"자",instrumentLute:"류트",instrumentMandolin:"만돌린",instrumentPiano:"피아노",instrumentXylophone:"실로폰",instrumentViolin:"바이올린",instrumentFlute:"플루트",instrumentChalumeau:"샬루모",guideTitle:"조작 가이드",guideTabDesktop:"키마조작",guideTabTouch:"터치조작",guideNoteCreate:"노트 생성",guideNoteCreateDesc:"피아노롤 빈 공간 좌클릭",guideNoteSelect:"노트 선택",guideNoteSelectDesc:"노트 좌클릭",guideNoteMultiSelect:"다중 노트 선택",guideNoteMultiSelectDesc:"Ctrl + 노트 좌클릭",guideNoteMove:"노트 이동",guideNoteMoveDesc:"선택된 노트 드래그",guideNoteOctaveMove:"옥타브 이동",guideNoteOctaveMoveDesc:"Shift + ↑/↓ (선택 노트 1옥타브 이동, 범위: 1~7옥타브)",guideNoteResize:"노트 길이 조절",guideNoteResizeDesc:"노트의 좌우 가장자리 드래그",guideNoteDelete:"노트 삭제",guideNoteDeleteDesc:"선택된 노트 Delete 키",guideNoteRangeSelect:"범위 선택",guideNoteRangeSelectDesc:"피아노롤에서 우클릭 드래그",guideSectionNotes:"노트 조작",guideSectionEdit:"편집/선택",guideSectionPlayback:"재생/스크롤/변환",guideVolumePopup:"볼륨 팝업 열기",guideVolumePopupDesc:"선택 노트 우클릭 → 슬라이더로 조절 후 ‘변경’ 또는 ‘선택한 노트만 변경’",guideVolumeWheelChain:"볼륨 조절 (체인 유지)",guideVolumeWheelChainDesc:"Alt + Shift + 마우스 휠: 선택된 구간을 ±1로 조절하며 주변 체인과 단절되지 않게 유지",guideVolumeWheelForward:"볼륨 조절 (앞으로 적용)",guideVolumeWheelForwardDesc:"Alt + 마우스 휠: 가장 이른 선택 노트부터 다음 앵커 전까지 ±1",guideVolumeButtons:"볼륨 버튼",guideVolumeButtonsDesc:"툴바의 ‘볼륨 -1 / +1’로 선택 노트 볼륨을 ±1",guideTip:"Tip: 단축키와 마우스 조작을 조합하면 더욱 빠르게 작업할 수 있습니다.",guideUndo:"실행 취소",guideUndoDesc:"Ctrl + Z",guideRedo:"다시 실행",guideRedoDesc:"Ctrl + Y",guideTrackOrder:"선택 트랙 변경",guideTrackOrderDesc:"↑/↓ (수정키 없음)",guideSelectAll:"전체 선택",guideSelectAllDesc:"Ctrl + A",guideCopy:"복사",guideCopyDesc:"Ctrl + C",guidePaste:"붙여넣기",guidePasteDesc:"Ctrl + V",guideCut:"잘라내기",guideCutDesc:"Ctrl + X",guidePlayheadMoveRuler:"플레이헤드 이동 (타임룰러)",guidePlayheadMoveRulerDesc:"타임룰러 좌클릭",guidePlayheadMoveRoll:"플레이헤드 이동 (피아노롤)",guidePlayheadMoveRollDesc:"피아노롤 가운데 클릭",guideZoomPlayhead:"확대/축소 (플레이헤드 기준)",guideZoomPlayheadDesc:"Ctrl + 마우스 휠 스크롤",guideScrollHorizontal:"수평 스크롤",guideScrollHorizontalDesc:"Shift + 마우스 휠 스크롤",guideScrollVertical:"수직 스크롤",guideScrollVerticalDesc:"마우스 휠 스크롤",guideMMLConvert:"MML 변환",guideMMLConvertDesc:'"변환" 버튼 클릭',guideMMLPaste:"MML 붙여넣기",guideMMLPasteDesc:'"붙여넣기" 버튼 클릭 (클립보드에서 MML 가져오기)',guidePlaybackWhilePlaying:"재생 중 스크롤",guidePlaybackWhilePlayingDesc:"Shift + 마우스 휠로 수평 스크롤 가능 (플레이헤드가 화면 밖으로 나가지 않음)",guidePlayheadToggle:"플레이헤드 표시 전환",guidePlayheadToggleDesc:"툴바의 플레이헤드 버튼으로 영역/막대 전환",guideRulerPrevNext:"룰러 마디 이동",guideRulerPrevNextDesc:"룰러 좌/우 버튼으로 한 마디씩 이동",guideKeyHeight:"노트 높이 조절",guideKeyHeightDesc:"상단 슬라이더로 16~32 단계 조절",guideLengthNew64:"64분음표 추가 및 단축키",guideLengthNew64Desc:"길이 버튼에 64분음표가 추가되었습니다. 단축키: 0. (주의: 인게임 박자가 어긋날 수 있음)",guideColAction:"항목",guideColHow:"조작/단축키",guideThemeToggle:"테마 전환",guideThemeToggleDesc:"상단 버튼으로 Light/Dark 테마 전환",guideSectionTimeline:"타임라인 편집",guideTimelineBeatPlus:"1박 밀기",guideTimelineBeatPlusDesc:"플레이헤드 오른쪽을 1박 뒤로 밀기",guideTimelineBeatMinus:"1박 자르기",guideTimelineBeatMinusDesc:"플레이헤드 오른쪽 1박을 잘라내고 왼쪽으로 당기기",guideTimelineBarPlus:"마디 밀기",guideTimelineBarPlusDesc:"플레이헤드 오른쪽을 1마디 뒤로 밀기",guideTimelineBarMinus:"마디 자르기",guideTimelineBarMinusDesc:"플레이헤드 오른쪽 1마디를 잘라내고 왼쪽으로 당기기",btnBarPlus:"마디+",btnBarMinus:"마디-",btnBeatPlus:"1박+",btnBeatMinus:"1박-",tooltipBarPlus:"플레이헤드 오른쪽을 한 마디 밀기",tooltipBarMinus:"플레이헤드 오른쪽 한 마디를 잘라내고 땡기기",tooltipBeatPlus:"플레이헤드 오른쪽을 한 박 밀기",tooltipBeatMinus:"플레이헤드 오른쪽 한 박을 잘라내고 땡기기",volLabel:"볼륨",volApplyRange:"변경",volApplySelected:"선택한 노트만 변경",tooltipPlay:"재생",tooltipPause:"일시정지",tooltipStop:"정지",tooltipConvert:"MML 변환",tooltipPaste:"클립보드에서 MML 붙여넣기",tooltipGuide:"조작 가이드 열기",save:"저장",load:"불러오기",tooltipSave:"프로젝트를 브라우저에 저장 (Ctrl+S)",tooltipLoad:"브라우저에서 프로젝트 불러오기",noSavedProject:"저장된 프로젝트가 없습니다",invalidSavedProject:"저장된 데이터가 올바르지 않습니다",loadedFromLocal:"로컬 스토리지에서 불러옴",saveFailed:"저장에 실패했습니다",loadFailed:"불러오기에 실패했습니다",tooltipLangKo:"한국어",tooltipLangJa:"일본어",tooltipLangEn:"영어",tooltipTempoInput:"템포 설정",tooltipProgress:"표시 형식 전환 (틱/마디.박/시간)",tooltipInstrument:"악기 선택",tooltipTrackName:"트랙 이름",extendedMoreLabel:"더 많은 단위",extendedLessLabel:"더 적은 단위",tooltipExtendedMore:"더 많은 단위 사용 (64/128/5/7/11)",tooltipExtendedLess:"기본 단위로 돌아가기",confirmEnableExtendedUnits:"더 많은 단위를 켜면 64,128,5,7,11분 음표를 사용할 수 있습니다. 하지만, 이 단위들은 게임 내에서 박자가 어긋날 수 있습니다. 계속하시겠습니까?",tooltipMute:"뮤트",tooltipSolo:"솔로",tooltipCharCount:"MML 문자 수",tooltipPianoRoll:"피아노롤: 클릭/드래그로 노트 편집",tooltipRuler:"타임 룰러: 클릭으로 플레이헤드 이동",tooltipRulerPrevBar:"한 마디 왼쪽으로",tooltipRulerNextBar:"한 마디 오른쪽으로",tooltipEditMML:"현재 트랙 MML 편집",tooltipLength:"길이",tooltipTouchToggleShow:"터치 조작 보이기",tooltipTouchToggleHide:"터치 조작 숨기기",btnGoToMobile:"모바일 페이지",tooltipGoToMobile:"모바일 최적화 페이지로 이동",tooltipDrawMode:"그리기 모드",tooltipSelectMode:"선택 모드",selectModeLabel:"선택모드",tooltipClearSelection:"선택 해제",tooltipCopyNotes:"노트 복사",tooltipCutNotes:"노트 잘라내기",tooltipPasteNotes:"플레이헤드 위치에 붙여넣기",tooltipDeleteNotes:"선택 노트 삭제",tooltipVolumeDown:"볼륨 -1",tooltipVolumeUp:"볼륨 +1",tooltipZoomOut:"축소",tooltipZoomIn:"확대",tooltipDisplayTimeSig:"표시용 박자 (n/4)",tooltipSelectAll:"활성 트랙 전체 선택",btnClearSelectionLabel:"선택 해제",btnSelectAllLabel:"전체 선택",tooltipKeyHeight:"노트 높이 (16-32)",guideTouchIntro:"모바일/터치 환경에서 아래 버튼으로 조작할 수 있습니다.",guideTouchToggle:"Mobile UI 토글",guideTouchToggleDesc:"상단의 'Mobile UI' 버튼으로 모바일 도구 모음을 보이기/숨기기",guideTouchSelectMode:"선택모드 토글",guideTouchSelectModeDesc:"그리기/선택 모드를 전환합니다.",guideTouchClear:"선택 해제",guideTouchClearDesc:"현재 선택을 모두 해제합니다.",guideTouchCopy:"복사",guideTouchCopyDesc:"선택한 노트를 클립보드에 복사합니다.",guideTouchCut:"잘라내기",guideTouchCutDesc:"선택한 노트를 잘라내어 클립보드에 저장합니다.",guideTouchPaste:"붙여넣기",guideTouchPasteDesc:"플레이헤드 위치에 붙여넣습니다.",guideTouchDelete:"삭제",guideTouchDeleteDesc:"선택한 노트를 삭제합니다.",guideTouchVolDown:"볼륨 -1",guideTouchVolDownDesc:"선택한 노트의 볼륨을 1 낮춥니다.",guideTouchVolUp:"볼륨 +1",guideTouchVolUpDesc:"선택한 노트의 볼륨을 1 높입니다.",guideTouchZoomOut:"축소",guideTouchZoomOutDesc:"가로 축을 축소합니다.",guideTouchZoomIn:"확대",guideTouchZoomInDesc:"가로 축을 확대합니다.",guideTouchSelectAll:"전체 선택",guideTouchSelectAllDesc:"활성 트랙의 모든 노트를 선택합니다.",guideTouchUndo:"실행 취소",guideTouchUndoDesc:"이전 상태로 되돌립니다.",guideTouchRedo:"다시 실행",guideTouchRedoDesc:"되돌린 작업을 다시 적용합니다.",guideTouchTrackReorder:"트랙 순서",guideTouchTrackReorderDesc:"선택된 트랙 카드의 ▲/▼ 버튼으로 한 칸씩 이동",convertMidTempoLabel:"중간템포 적용",convertMidTempoHelp:"이 모달에서만 적용: 원본 MML의 t 변경/세분화를 보존하여 중간 템포 호환 형태로 내보냅니다."},ja:{whatsNewTitle:"更新のお知らせ",whatsNew_20250827_heading:"読み込み方法の変更",whatsNew_20250827_p1:"ページ読み込み時の自動読み込みを廃止しました。",whatsNew_20250827_p2:"保存済みの作業を復元するには、ツールバーの『読み込み』ボタンを押してください。",loadPrevious:"前回の作業を読み込みますか？（OK: 続行、キャンセル: 新規）",tempoLabel:"Tempo",tempoModalTitle:"テンポ設定",ok:"OK",cancel:"キャンセル",modalClose:"閉じる",playheadAreaLabel:"再生ヘッド: 領域",playheadLineLabel:"再生ヘッド: 線",tooltipPlayheadToggle:"再生ヘッド表示の切替（領域/線）",convertCopy:"クリップボードにコピー",convertSaveTxt:"TXTとして保存",convertFilenameLabel:"ファイル名",convertFilenamePlaceholder:"例: my-song.txt",copied:"コピーしました！",trackMMLLabel:"トラックMML",edit:"編集",bpm:"bpm",convert:"変換",paste:"貼り付け",guide:"操作ガイド",track:"トラック",charUnit:"字",instrumentLute:"リュート",instrumentMandolin:"マンドリン",instrumentPiano:"ピアノ",instrumentXylophone:"シロフォン",instrumentViolin:"バイオリン",instrumentFlute:"フルート",instrumentChalumeau:"シャリュモー",guideTitle:"操作ガイド",guideTabDesktop:"キマ操作",guideTabTouch:"タッチ操作",guideNoteCreate:"ノート作成",guideNoteCreateDesc:"ピアノロールの空白部分を左クリック",guideNoteSelect:"ノート選択",guideNoteSelectDesc:"ノートを左クリック",guideNoteMultiSelect:"複数ノート選択",guideNoteMultiSelectDesc:"Ctrl + ノートを左クリック",guideNoteMove:"ノート移動",guideNoteMoveDesc:"選択したノートをドラッグ",guideNoteOctaveMove:"オクターブ移動",guideNoteOctaveMoveDesc:"Shift + ↑/↓（選択ノートを1オクターブ移動、範囲: 1～7オクターブ）",guideNoteResize:"ノートの長さ調整",guideNoteResizeDesc:"ノートの左右の端をドラッグ",guideNoteDelete:"ノート削除",guideNoteDeleteDesc:"選択したノートを Delete キーで削除",guideNoteRangeSelect:"範囲選択",guideNoteRangeSelectDesc:"ピアノロールで右クリックしながらドラッグ",guideSectionNotes:"ノート操作",guideSectionEdit:"編集/選択",guideSectionPlayback:"再生/スクロール/変換",guideVolumePopup:"ボリュームポップアップを開く",guideVolumePopupDesc:"選択ノートを右クリック → スライダーで調整。「変更」または「選択ノートのみ」",guideVolumeWheelChain:"ボリューム調整（チェーン維持）",guideVolumeWheelChainDesc:"Alt + Shift + マウスホイール：選択範囲を±1。前後のチェーンを維持",guideVolumeWheelForward:"ボリューム調整（後続に適用）",guideVolumeWheelForwardDesc:"Alt + マウスホイール：最も早い選択ノートから次のアンカー直前まで±1",guideVolumeButtons:"ボリュームボタン",guideVolumeButtonsDesc:"ツールバーの「ボリューム -1 / +1」で選択ノートを±1",guideTip:"ヒント: ショートカットとマウス操作を組み合わせると、より効率的に作業できます。",guideUndo:"元に戻す",guideUndoDesc:"Ctrl + Z",guideRedo:"やり直し",guideRedoDesc:"Ctrl + Y",guideTrackOrder:"選択中トラックの切替",guideTrackOrderDesc:"↑/↓（修飾キーなし）",guideSelectAll:"すべて選択",guideSelectAllDesc:"Ctrl + A",guideCopy:"コピー",guideCopyDesc:"Ctrl + C",guidePaste:"貼り付け",guidePasteDesc:"Ctrl + V",guideCut:"切り取り",guideCutDesc:"Ctrl + X",guidePlayheadMoveRuler:"再生ヘッド移動 (タイムルーラー)",guidePlayheadMoveRulerDesc:"タイムルーラーを左クリック",guidePlayheadMoveRoll:"再生ヘッド移動 (ピアノロール)",guidePlayheadMoveRollDesc:"ピアノロールを中クリック",guideZoomPlayhead:"拡大/縮小 (再生ヘッド基準)",guideZoomPlayheadDesc:"Ctrl + マウスホイールスクロール",guideScrollHorizontal:"水平スクロール",guideScrollHorizontalDesc:"Shift + マウスホイールスクロール",guideScrollVertical:"垂直スクロール",guideScrollVerticalDesc:"マウスホイールスクロール",guideMMLConvert:"MML変換",guideMMLConvertDesc:'"変換"ボタンをクリック',guideMMLPaste:"MML貼り付け",guideMMLPasteDesc:'"貼り付け"ボタンをクリック (クリップボードからMMLを取得)',guidePlaybackWhilePlaying:"再生中のスクロール",guidePlaybackWhilePlayingDesc:"Shift + マウスホイールで水平スクロール可（再生ヘッドは画面内に維持）",guidePlayheadToggle:"再生ヘッド表示の切替",guidePlayheadToggleDesc:"ツールバーのボタンで領域/線を切替",guideRulerPrevNext:"ルーラー小節移動",guideRulerPrevNextDesc:"左右ボタンで1小節ずつ移動",guideKeyHeight:"ノートの高さ調整",guideKeyHeightDesc:"上部スライダーで 16～32 を調整",guideLengthNew64:"64分音符の追加とショートカット",guideLengthNew64Desc:"長さボタンに64分音符を追加しました。ショートカット: 0。（注意：ゲーム内で拍がずれる可能性あり）",guideColAction:"項目",guideColHow:"操作/ショートカット",guideThemeToggle:"テーマ切替",guideThemeToggleDesc:"上部ボタンでライト/ダークを切り替え",guideSectionTimeline:"タイムライン編集",guideTimelineBeatPlus:"1拍押し出し",guideTimelineBeatPlusDesc:"再生ヘッドより右側を1拍後ろに押し出す",guideTimelineBeatMinus:"1拍カット",guideTimelineBeatMinusDesc:"再生ヘッドより右側の1拍を切り取り前へ詰める",guideTimelineBarPlus:"1小節押し出し",guideTimelineBarPlusDesc:"再生ヘッドより右側を1小節後ろに押し出す",guideTimelineBarMinus:"1小節カット",guideTimelineBarMinusDesc:"再生ヘッドより右側の1小節を切り取り前へ詰める",btnBarPlus:"小節+",btnBarMinus:"小節-",btnBeatPlus:"1拍+",btnBeatMinus:"1拍-",tooltipBarPlus:"再生ヘッドより右側を1小節後ろに押し出す",tooltipBarMinus:"再生ヘッドより右側の1小節を切り取り前へ詰める",tooltipBeatPlus:"再生ヘッドより右側を1拍後ろに押し出す",tooltipBeatMinus:"再生ヘッドより右側の1拍を切り取り前へ詰める",volLabel:"ボリューム",volApplyRange:"変更",volApplySelected:"選択ノートのみ",tooltipPlay:"再生",tooltipPause:"一時停止",tooltipStop:"停止",tooltipConvert:"MML変換",tooltipPaste:"クリップボードからMMLを貼り付け",tooltipGuide:"操作ガイドを開く",savedToLocal:"ローカルストレージに保存しました",save:"保存",load:"読み込み",tooltipSave:"プロジェクトをブラウザに保存 (Ctrl+S)",tooltipLoad:"ブラウザからプロジェクトを読み込み",noSavedProject:"保存されたプロジェクトが見つかりません",invalidSavedProject:"保存データが正しくありません",loadedFromLocal:"ローカルストレージから読み込みました",saveFailed:"保存に失敗しました",loadFailed:"読み込みに失敗しました",tooltipLangKo:"韓国語",tooltipLangJa:"日本語",tooltipLangEn:"英語",tooltipTempoInput:"テンポ設定",tooltipProgress:"表示形式の切替（tick/小節.拍/時間）",tooltipInstrument:"楽器を選択",tooltipTrackName:"トラック名",extendedMoreLabel:"より多い単位",extendedLessLabel:"少ない単位",tooltipExtendedMore:"より多い単位を使用 (64/128/5/7/11)",tooltipExtendedLess:"基本の単位に戻す",confirmEnableExtendedUnits:"「より多い単位」を有効にすると、64/128/5/7/11 分音符が使用できます。ただし、ゲーム内で拍がずれる場合があります。続行しますか？",tooltipMute:"ミュート",tooltipSolo:"ソロ",tooltipCharCount:"MML文字数",tooltipPianoRoll:"ピアノロール：クリック/ドラッグで編集",tooltipRuler:"タイムルーラー：クリックで再生ヘッド移動",tooltipRulerPrevBar:"1小節左へ",tooltipRulerNextBar:"1小節右へ",tooltipEditMML:"現在のトラックMMLを編集",tooltipLength:"長さ",tooltipTouchToggleShow:"タッチ操作を表示",tooltipTouchToggleHide:"タッチ操作を非表示",btnGoToMobile:"モバイルページ",tooltipGoToMobile:"モバイル最適化ページに移動",tooltipDrawMode:"描画モード",tooltipSelectMode:"選択モード",selectModeLabel:"選択モード",tooltipClearSelection:"選択解除",tooltipCopyNotes:"ノートをコピー",tooltipCutNotes:"ノートを切り取り",tooltipPasteNotes:"再生ヘッド位置に貼り付け",tooltipDeleteNotes:"選択ノートを削除",tooltipVolumeDown:"ボリューム -1",tooltipVolumeUp:"ボリューム +1",tooltipZoomOut:"ズームアウト",tooltipZoomIn:"ズームイン",tooltipDisplayTimeSig:"表示用拍子 (n/4)",tooltipSelectAll:"アクティブトラックを全選択",btnClearSelectionLabel:"選択解除",btnSelectAllLabel:"全選択",tooltipKeyHeight:"ノートの高さ (16-32)",guideTouchIntro:"モバイル/タッチ環境では下のボタンで操作できます。",guideTouchToggle:"Mobile UI トグル",guideTouchToggleDesc:"上部の『Mobile UI』ボタンでツールバーの表示/非表示を切替",guideTouchSelectMode:"選択モード切替",guideTouchSelectModeDesc:"描画/選択モードを切り替えます。",guideTouchClear:"選択解除",guideTouchClearDesc:"現在の選択をすべて解除します。",guideTouchCopy:"コピー",guideTouchCopyDesc:"選択したノートをクリップボードにコピーします。",guideTouchCut:"切り取り",guideTouchCutDesc:"選択したノートを切り取り、クリップボードに保存します。",guideTouchPaste:"貼り付け",guideTouchPasteDesc:"再生ヘッド位置に貼り付けます。",guideTouchDelete:"削除",guideTouchDeleteDesc:"選択したノートを削除します。",guideTouchVolDown:"ボリューム -1",guideTouchVolDownDesc:"選択ノートのボリュームを1下げます。",guideTouchVolUp:"ボリューム +1",guideTouchVolUpDesc:"選択ノートのボリュームを1上げます。",guideTouchZoomOut:"縮小",guideTouchZoomOutDesc:"横方向のズームを縮小します。",guideTouchZoomIn:"拡大",guideTouchZoomInDesc:"横方向のズームを拡大します。",guideTouchSelectAll:"すべて選択",guideTouchSelectAllDesc:"アクティブトラックのすべてのノートを選択します。",guideTouchUndo:"元に戻す",guideTouchUndoDesc:"前の状態に戻します。",guideTouchRedo:"やり直し",guideTouchRedoDesc:"取り消した操作を再適用します。",guideTouchTrackReorder:"トラック順",guideTouchTrackReorderDesc:"選択中のトラックカードの▲/▼で1つずつ移動",convertMidTempoLabel:"中間テンポ適用",convertMidTempoHelp:"このモーダル出力のみ：元のMMLのt変更/分割を保持し、中間テンポ互換の形式で出力します。"},en:{whatsNewTitle:"What's new",whatsNew_20250827_heading:"Changed load behavior",whatsNew_20250827_p1:"Removed auto-load on page start.",whatsNew_20250827_p2:"Use the 'Load' button in the toolbar to restore saved work.",loadPrevious:"Load previous session? (OK: continue, Cancel: new)",tempoLabel:"Tempo",tempoModalTitle:"Set Tempo",ok:"OK",cancel:"Cancel",modalClose:"Close",playheadAreaLabel:"Playhead: Area",playheadLineLabel:"Playhead: Line",tooltipPlayheadToggle:"Toggle playhead display (area/line)",convertCopy:"Copy to clipboard",convertSaveTxt:"Save as TXT",convertFilenameLabel:"Filename",convertFilenamePlaceholder:"e.g., my-song.txt",copied:"Copied!",trackMMLLabel:"Track MML",edit:"Edit",bpm:"bpm",convert:"Convert",paste:"Paste",guide:"User Guide",track:"Track",charUnit:"chars",instrumentLute:"Lute",instrumentMandolin:"Mandolin",instrumentPiano:"Piano",instrumentXylophone:"Xylophone",instrumentViolin:"Violin",instrumentFlute:"Flute",instrumentChalumeau:"Chalumeau",guideTitle:"User Guide",guideTabDesktop:"Keyboard/Mouse",guideTabTouch:"Touch/Mobile",guideNoteCreate:"Create Note",guideNoteCreateDesc:"Left-click empty space on the piano roll",guideNoteSelect:"Select Note",guideNoteSelectDesc:"Left-click a note",guideNoteMultiSelect:"Select multiple notes",guideNoteMultiSelectDesc:"Ctrl + Left-click notes",guideNoteMove:"Move notes",guideNoteMoveDesc:"Drag selected notes",guideNoteOctaveMove:"Octave move",guideNoteOctaveMoveDesc:"Shift + ↑/↓ (move selected notes by 1 octave, bounds: octaves 1–7)",guideNoteResize:"Adjust note length",guideNoteResizeDesc:"Drag left/right edges of a note",guideNoteDelete:"Delete Note",guideNoteDeleteDesc:"Delete key on selected notes",guideNoteRangeSelect:"Range selection",guideNoteRangeSelectDesc:"Right-click and drag on the piano roll",guideSectionNotes:"Note editing",guideSectionEdit:"Editing/Selection",guideSectionPlayback:"Playback/Scrolling/Conversion",guideVolumePopup:"Open volume popup",guideVolumePopupDesc:"Right-click a selected note → adjust slider; click ‘Apply’ or ‘Apply to selected only’",guideVolumeWheelChain:"Adjust volume (preserve chains)",guideVolumeWheelChainDesc:"Alt + Shift + Mouse wheel: ±1 for selected runs while preserving surrounding chains",guideVolumeWheelForward:"Adjust volume (apply forward)",guideVolumeWheelForwardDesc:"Alt + Mouse wheel: ±1 from the earliest selected note forward until the next anchor",guideVolumeButtons:"Volume buttons",guideVolumeButtonsDesc:"Use toolbar ‘Volume -1 / +1’ to change selected notes by ±1",guideTip:"Tip: Combine shortcuts and mouse actions to work more efficiently.",guideUndo:"Undo",guideUndoDesc:"Ctrl + Z",guideRedo:"Redo",guideRedoDesc:"Ctrl + Y",guideTrackOrder:"Change selected track",guideTrackOrderDesc:"↑/↓ (no modifiers)",guideSelectAll:"Select All",guideSelectAllDesc:"Ctrl + A",guideCopy:"Copy",guideCopyDesc:"Ctrl + C",guidePaste:"Paste",guidePasteDesc:"Ctrl + V",guideCut:"Cut",guideCutDesc:"Ctrl + X",guidePlayheadMoveRuler:"Move playhead (Time Ruler)",guidePlayheadMoveRulerDesc:"Left-click on time ruler",guidePlayheadMoveRoll:"Move playhead (Piano Roll)",guidePlayheadMoveRollDesc:"Middle-click the piano roll",guideZoomPlayhead:"Zoom (centered on playhead)",guideZoomPlayheadDesc:"Ctrl + Mouse wheel scroll",guideScrollHorizontal:"Horizontal Scroll",guideScrollHorizontalDesc:"Shift + Mouse wheel scroll",guideScrollVertical:"Vertical Scroll",guideScrollVerticalDesc:"Mouse wheel scroll",guideMMLConvert:"Convert MML",guideMMLConvertDesc:'Click "Convert"',guideMMLPaste:"Paste MML",guideMMLPasteDesc:'Click "Paste" to load MML from the clipboard',guidePlaybackWhilePlaying:"Scroll while playing",guidePlaybackWhilePlayingDesc:"Shift + mouse wheel to scroll horizontally; playhead stays visible.",guidePlayheadToggle:"Toggle playhead display",guidePlayheadToggleDesc:"Use the toolbar button to switch area/line.",guideRulerPrevNext:"Ruler bar navigation",guideRulerPrevNextDesc:"Use left/right buttons to move by one bar.",guideKeyHeight:"Adjust note key height",guideKeyHeightDesc:"Use the top slider to set 16–32.",guideLengthNew64:"64th note length and shortcut",guideLengthNew64Desc:"Length buttons now include 64th. Hotkey: 0. (Warning: may desync in-game)",guideColAction:"Item",guideColHow:"Operation/Shortcut",guideThemeToggle:"Toggle theme",guideThemeToggleDesc:"Use the top button to switch Light/Dark",guideSectionTimeline:"Timeline edit",guideTimelineBeatPlus:"Push 1 beat",guideTimelineBeatPlusDesc:"Push notes to the right of the playhead by 1 beat",guideTimelineBeatMinus:"Cut 1 beat",guideTimelineBeatMinusDesc:"Cut 1 beat to the right of the playhead and pull left",guideTimelineBarPlus:"Push 1 bar",guideTimelineBarPlusDesc:"Push notes to the right of the playhead by 1 bar",guideTimelineBarMinus:"Cut 1 bar",guideTimelineBarMinusDesc:"Cut 1 bar to the right of the playhead and pull left",btnBarPlus:"Bar+",btnBarMinus:"Bar-",btnBeatPlus:"Beat+",btnBeatMinus:"Beat-",tooltipBarPlus:"Push right of playhead by 1 bar",tooltipBarMinus:"Cut 1 bar to the right of playhead and pull left",tooltipBeatPlus:"Push right of playhead by 1 beat",tooltipBeatMinus:"Cut 1 beat to the right of playhead and pull left",volLabel:"Volume",volApplyRange:"Apply",volApplySelected:"Apply to selected only",tooltipPlay:"Play",tooltipPause:"Pause",tooltipStop:"Stop",tooltipConvert:"Convert MML",tooltipPaste:"Paste MML from clipboard",tooltipGuide:"Open user guide",savedToLocal:"Saved to local storage",save:"Save",load:"Load",tooltipSave:"Save project to browser (Ctrl+S)",tooltipLoad:"Load project from browser",noSavedProject:"No saved project found",invalidSavedProject:"Saved data is invalid",loadedFromLocal:"Loaded from local storage",saveFailed:"Save failed",loadFailed:"Load failed",tooltipLangKo:"Korean",tooltipLangJa:"Japanese",tooltipLangEn:"English",tooltipTempoInput:"Set tempo",tooltipProgress:"Toggle display (ticks/bar.beat/time)",tooltipInstrument:"Select instrument",tooltipTrackName:"Track name",extendedMoreLabel:"More units",extendedLessLabel:"Fewer units",tooltipExtendedMore:"Use more units (64/128/5/7/11)",tooltipExtendedLess:"Return to basic units",confirmEnableExtendedUnits:"Enabling more units lets you use 64/128/5/7/11 notes, but they may be off-beat in-game. Continue?",tooltipMute:"Mute",tooltipSolo:"Solo",tooltipCharCount:"MML characters",tooltipPianoRoll:"Piano roll: click/drag to edit",tooltipRuler:"Time ruler: click to move playhead",tooltipRulerPrevBar:"Move one bar left",tooltipRulerNextBar:"Move one bar right",tooltipEditMML:"Edit current track MML",tooltipLength:"Length",tooltipTouchToggleShow:"Show touch controls",tooltipTouchToggleHide:"Hide touch controls",btnGoToMobile:"Mobile Page",tooltipGoToMobile:"Go to mobile optimized page",tooltipDrawMode:"Draw mode",tooltipSelectMode:"Select mode",selectModeLabel:"Select mode",tooltipClearSelection:"Clear selection",tooltipCopyNotes:"Copy notes",tooltipCutNotes:"Cut notes",tooltipPasteNotes:"Paste notes at playhead",tooltipDeleteNotes:"Delete selected notes",tooltipVolumeDown:"Volume -1",tooltipVolumeUp:"Volume +1",tooltipZoomOut:"Zoom out",tooltipZoomIn:"Zoom in",tooltipDisplayTimeSig:"Display time signature (n/4)",tooltipSelectAll:"Select all in active track",btnClearSelectionLabel:"Clear",btnSelectAllLabel:"Select All",tooltipKeyHeight:"Note height (16-32)",guideTouchIntro:"On mobile/touch, use the buttons below to operate.",guideTouchToggle:"Toggle Mobile UI",guideTouchToggleDesc:"Use the 'Mobile UI' button at the top to show/hide the toolbar.",guideTouchSelectMode:"Toggle Select mode",guideTouchSelectModeDesc:"Switch between draw and select modes.",guideTouchClear:"Clear selection",guideTouchClearDesc:"Clear the current selection.",guideTouchCopy:"Copy",guideTouchCopyDesc:"Copy selected notes to the clipboard.",guideTouchCut:"Cut",guideTouchCutDesc:"Cut selected notes and store in the clipboard.",guideTouchPaste:"Paste",guideTouchPasteDesc:"Paste at the playhead position.",guideTouchDelete:"Delete",guideTouchDeleteDesc:"Delete selected notes.",guideTouchVolDown:"Volume -1",guideTouchVolDownDesc:"Decrease selected notes' velocity by 1.",guideTouchVolUp:"Volume +1",guideTouchVolUpDesc:"Increase selected notes' velocity by 1.",guideTouchZoomOut:"Zoom out",guideTouchZoomOutDesc:"Zoom out horizontally.",guideTouchZoomIn:"Zoom in",guideTouchZoomInDesc:"Zoom in horizontally.",guideTouchSelectAll:"Select All",guideTouchSelectAllDesc:"Select all notes in the active track.",guideTouchUndo:"Undo",guideTouchUndoDesc:"Revert the last action.",guideTouchRedo:"Redo",guideTouchRedoDesc:"Re-apply the reverted action.",guideTouchTrackReorder:"Track order",guideTouchTrackReorderDesc:"Use ▲/▼ on the selected track card to move by one.",convertMidTempoLabel:"Apply mid-song tempo",convertMidTempoHelp:"Modal output only: preserve original MML t-changes/segmentation for mid-tempo compatibility."}},bn="mml_editor_lang";let y=vn();const Io="mml_editor_guide_tab";let oo=xn();function vn(){const e=typeof localStorage<"u"?localStorage.getItem(bn):null;return e==="ja"||e==="en"||e==="ko"?e:"ko"}function No(e){y=e;try{localStorage.setItem("mml_editor_lang",e)}catch{}document.querySelectorAll("[data-i18n]").forEach(d=>{const s=d.getAttribute("data-i18n");s&&b[y][s]&&(d.textContent=b[y][s])}),document.querySelectorAll("[data-i18n-title]").forEach(d=>{const s=d.getAttribute("data-i18n-title");s&&b[y][s]&&d.setAttribute("title",b[y][s])});const n=document.querySelector('label[for="tempoInput"]');n&&(n.textContent=b[y].tempoLabel);const r=document.querySelector('#tempoBox span[data-i18n="bpm"]');r&&(r.textContent=b[y].bpm),document.querySelectorAll(".track-card span").forEach(d=>{if(d.textContent&&(d.textContent.endsWith("자")||d.textContent.endsWith("字")||d.textContent.endsWith("chars"))){const s=parseInt(d.textContent,10);isNaN(s)||(d.textContent=`${s}${b[y].charUnit}`)}}),document.querySelectorAll(".track-card select").forEach(d=>{Array.from(d.options).forEach(s=>{const c=s,g=`instrument${c.value.charAt(0).toUpperCase()+c.value.slice(1)}`;b[y][g]&&(c.textContent=b[y][g])})});const u=document.querySelector("#guideModalContent");u&&Ao(u)}function xn(){return(typeof localStorage<"u"?localStorage.getItem(Io):null)==="touch"?"touch":"desktop"}function Tn(e){try{localStorage.setItem(Io,e)}catch{}}function Ao(e){const t=b[y];e.innerHTML=`
        <h2 style="margin: 0 0 12px; text-align: center;">${t.guideTitle}</h2>
        <div style="display:flex; gap:6px; margin: 0 auto 12px; justify-content:center;">
            <button id="guideTabDesktopBtn" type="button" data-tab="desktop" style="padding:6px 10px; border:1px solid #cfcfcf; border-radius:6px; background:#fff; cursor:pointer;">
                ${t.guideTabDesktop}
            </button>
            <button id="guideTabTouchBtn" type="button" data-tab="touch" style="padding:6px 10px; border:1px solid #cfcfcf; border-radius:6px; background:#fff; cursor:pointer;">
                ${t.guideTabTouch}
            </button>
        </div>
        <div id="guidePanels">
            <div id="guideTabDesktopPanel" data-panel="desktop">
                <div style="margin-bottom: 14px;">
                    <h3 style="margin:0 0 8px; border-bottom: 1px solid #eee; padding-bottom: 4px;">${t.guideSectionNotes}</h3>
                    <table style="width:100%; border-collapse:collapse; font-size:13px;">
                        <thead>
                            <tr>
                                <th style="text-align:left; padding:6px; border-bottom:1px solid #eee; width:36%">${t.guideColAction}</th>
                                <th style="text-align:left; padding:6px; border-bottom:1px solid #eee;">${t.guideColHow}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td style="padding:6px;">${t.guideNoteCreate}</td><td style="padding:6px;">${t.guideNoteCreateDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideNoteSelect}</td><td style="padding:6px;">${t.guideNoteSelectDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideNoteMultiSelect}</td><td style="padding:6px;">${t.guideNoteMultiSelectDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideNoteRangeSelect}</td><td style="padding:6px;">${t.guideNoteRangeSelectDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideNoteMove}</td><td style="padding:6px;">${t.guideNoteMoveDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideNoteOctaveMove}</td><td style="padding:6px;">${t.guideNoteOctaveMoveDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideNoteResize}</td><td style="padding:6px;">${t.guideNoteResizeDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideNoteDelete}</td><td style="padding:6px;">${t.guideNoteDeleteDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideVolumePopup}</td><td style="padding:6px;">${t.guideVolumePopupDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideVolumeWheelChain}</td><td style="padding:6px;">${t.guideVolumeWheelChainDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideVolumeWheelForward}</td><td style="padding:6px;">${t.guideVolumeWheelForwardDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideVolumeButtons}</td><td style="padding:6px;">${t.guideVolumeButtonsDesc}</td></tr>
                            
                        </tbody>
                    </table>
                </div>
                <div style="margin-bottom: 14px;">
                    <h3 style="margin:0 0 8px; border-bottom: 1px solid #eee; padding-bottom: 4px;">${t.guideSectionEdit}</h3>
                    <table style="width:100%; border-collapse:collapse; font-size:13px;">
                        <thead>
                            <tr>
                                <th style="text-align:left; padding:6px; border-bottom:1px solid #eee; width:36%">${t.guideColAction}</th>
                                <th style="text-align:left; padding:6px; border-bottom:1px solid #eee;">${t.guideColHow}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td style="padding:6px;">${t.guideUndo}</td><td style="padding:6px;">${t.guideUndoDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideRedo}</td><td style="padding:6px;">${t.guideRedoDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideTrackOrder}</td><td style="padding:6px;">${t.guideTrackOrderDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideSelectAll}</td><td style="padding:6px;">${t.guideSelectAllDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideCopy}</td><td style="padding:6px;">${t.guideCopyDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guidePaste}</td><td style="padding:6px;">${t.guidePasteDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideCut}</td><td style="padding:6px;">${t.guideCutDesc}</td></tr>
                        </tbody>
                    </table>
                </div>
                <div style="margin-bottom: 14px;">
                    <h3 style="margin:0 0 8px; border-bottom: 1px solid #eee; padding-bottom: 4px;">${t.guideSectionPlayback}</h3>
                    <table style="width:100%; border-collapse:collapse; font-size:13px;">
                        <thead>
                            <tr>
                                <th style="text-align:left; padding:6px; border-bottom:1px solid #eee; width:36%">${t.guideColAction}</th>
                                <th style="text-align:left; padding:6px; border-bottom:1px solid #eee;">${t.guideColHow}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td style="padding:6px;">${t.guidePlayheadMoveRuler}</td><td style="padding:6px;">${t.guidePlayheadMoveRulerDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guidePlayheadMoveRoll}</td><td style="padding:6px;">${t.guidePlayheadMoveRollDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideZoomPlayhead}</td><td style="padding:6px;">${t.guideZoomPlayheadDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideScrollHorizontal}</td><td style="padding:6px;">${t.guideScrollHorizontalDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideScrollVertical}</td><td style="padding:6px;">${t.guideScrollVerticalDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guidePlaybackWhilePlaying}</td><td style="padding:6px;">${t.guidePlaybackWhilePlayingDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guidePlayheadToggle}</td><td style="padding:6px;">${t.guidePlayheadToggleDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideRulerPrevNext}</td><td style="padding:6px;">${t.guideRulerPrevNextDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideKeyHeight}</td><td style="padding:6px;">${t.guideKeyHeightDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideThemeToggle}</td><td style="padding:6px;">${t.guideThemeToggleDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideMMLConvert}</td><td style="padding:6px;">${t.guideMMLConvertDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideMMLPaste}</td><td style="padding:6px;">${t.guideMMLPasteDesc}</td></tr>
                        </tbody>
                    </table>
                </div>
                <div style="font-size: 13px; color: #888; text-align: right;">${t.guideTip}</div>
            </div>

            <div id="guideTabTouchPanel" data-panel="touch" style="display:none;">
                <div style="margin-bottom: 10px; color:#666; font-size: 13px;">${t.guideTouchIntro}</div>
                <div style="margin-bottom: 12px;">
                    <h3 style="margin:0 0 8px; border-bottom: 1px solid #eee; padding-bottom: 4px;">Mobile UI</h3>
                    <table style="width:100%; border-collapse:collapse; font-size:13px;">
                        <thead>
                            <tr>
                                <th style="text-align:left; padding:6px; border-bottom:1px solid #eee; width:36%">${t.guideColAction}</th>
                                <th style="text-align:left; padding:6px; border-bottom:1px solid #eee;">${t.guideColHow}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td style="padding:6px;">${t.guideTouchToggle}</td><td style="padding:6px;">${t.guideTouchToggleDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideTouchSelectMode}</td><td style="padding:6px;">${t.guideTouchSelectModeDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideTouchClear}</td><td style="padding:6px;">${t.guideTouchClearDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideTouchCopy}</td><td style="padding:6px;">${t.guideTouchCopyDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideTouchCut}</td><td style="padding:6px;">${t.guideTouchCutDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideTouchPaste}</td><td style="padding:6px;">${t.guideTouchPasteDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideTouchDelete}</td><td style="padding:6px;">${t.guideTouchDeleteDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideTouchVolDown}</td><td style="padding:6px;">${t.guideTouchVolDownDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideTouchVolUp}</td><td style="padding:6px;">${t.guideTouchVolUpDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideTouchZoomOut}</td><td style="padding:6px;">${t.guideTouchZoomOutDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideTouchZoomIn}</td><td style="padding:6px;">${t.guideTouchZoomInDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideTouchSelectAll}</td><td style="padding:6px;">${t.guideTouchSelectAllDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideTouchUndo}</td><td style="padding:6px;">${t.guideTouchUndoDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideTouchRedo}</td><td style="padding:6px;">${t.guideTouchRedoDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideTouchTrackReorder}</td><td style="padding:6px;">${t.guideTouchTrackReorderDesc}</td></tr>
                        </tbody>
                    </table>
                </div>
                <div style="margin-bottom: 12px;">
                    <h3 style="margin:0 0 8px; border-bottom: 1px solid #eee; padding-bottom: 4px;">${t.guideSectionPlayback}</h3>
                    <table style="width:100%; border-collapse:collapse; font-size:13px;">
                        <thead>
                            <tr>
                                <th style="text-align:left; padding:6px; border-bottom:1px solid #eee; width:36%">${t.guideColAction}</th>
                                <th style="text-align:left; padding:6px; border-bottom:1px solid #eee;">${t.guideColHow}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td style="padding:6px;">${t.guidePlayheadMoveRuler}</td><td style="padding:6px;">${t.guidePlayheadMoveRulerDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guidePlayheadMoveRoll}</td><td style="padding:6px;">${t.guidePlayheadMoveRollDesc}</td></tr>
                            <tr><td style="padding:6px;">${t.guideZoomPlayhead}</td><td style="padding:6px;">${t.guideZoomPlayheadDesc}</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;const o=e.querySelector("#guideTabDesktopBtn"),n=e.querySelector("#guideTabTouchBtn"),r=e.querySelector("#guideTabDesktopPanel"),a=e.querySelector("#guideTabTouchPanel"),l=u=>{oo=u,Tn(u);const d=u==="desktop"?o:n,s=u==="desktop"?n:o;d&&(d.style.background="#E6F0FF",d.style.borderColor="#b7d2ff",d.setAttribute("aria-current","true")),s&&(s.style.background="#fff",s.style.borderColor="#cfcfcf",s.removeAttribute("aria-current")),r&&a&&(r.style.display=u==="desktop"?"":"none",a.style.display=u==="touch"?"":"none")};o?.addEventListener("click",()=>l("desktop")),n?.addEventListener("click",()=>l("touch")),l(oo)}function kn(e,t=y){const o=b[t],n=e.charAt(0).toUpperCase()+e.slice(1);return o[`instrument${n}`]||e}function Mn(){return yt.map(e=>({value:e,label:kn(e,y)}))}document.addEventListener("DOMContentLoaded",()=>{No(y)});function wn(e,t){const o=document.createElement("div");o.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
   `;const n=document.createElement("div");n.style.cssText=`
      background: #fff;
      padding: 24px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
   `;const r=document.createElement("div");r.style.cssText=`
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #eee;
      padding: 8px;
      margin-bottom: 16px;
   `;const a=document.createElement("div");a.style.cssText=`
            display: flex;
            align-items: center;
            gap: 8px;
        `;const l=document.createElement("label");l.setAttribute("for","convertFilenameInput"),l.textContent=b[y].convertFilenameLabel||"파일명",l.setAttribute("data-i18n","convertFilenameLabel"),l.style.cssText=`
            min-width: 72px;
            color: #666;
            font-size: 12px;
        `;const u=document.createElement("input");u.type="text",u.id="convertFilenameInput",u.placeholder=b[y].convertFilenamePlaceholder||"예: my-song.txt",u.setAttribute("data-i18n-placeholder","convertFilenamePlaceholder"),u.style.cssText=`
            flex: 1 1 auto;
            padding: 6px 8px;
            border: 1px solid #cfcfcf;
            border-radius: 6px;
            font-size: 12px;
        `;const d=new Date().toISOString().replace(/[:.]/g,"-");u.value=`mml-${d}.txt`,a.append(l,u);const s=document.createElement("textarea");s.style.cssText=`
            width: 100%;
            min-height: 200px;
            box-sizing: border-box;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            word-break: break-all;
            overflow-y: auto;
        `,s.readOnly=!0;const c=document.createElement("div");c.style.cssText=`
      display: flex;
      justify-content: flex-end;
      gap: 8px;
   `,ve();const g=de({label:b[y].convertCopy,variant:"primary",attrs:{"data-i18n":"convertCopy"}}),m=de({label:b[y].convertSaveTxt,variant:"secondary",attrs:{"data-i18n":"convertSaveTxt"}}),h=de({label:b[y].modalClose,variant:"secondary",attrs:{"data-i18n":"modalClose"}});c.append(g,m,h),n.append(r,a,s,c),o.appendChild(n),document.body.appendChild(o);function f(){window.removeEventListener("keydown",v,!0),o.parentNode&&document.body.removeChild(o)}function v(T){T.key==="Escape"&&f()}r.innerHTML="";let k=[];const L=new Map,M=T=>{const x=T.optimizedMML;if(x&&x.length>0)return x;const w=un(T.notes??[])||"";return w.length>0?w:T.mmlString||""},C=()=>{let x=s.value||"";x.startsWith("MML@")&&(x=x.slice(4)),x.endsWith(";")&&(x=x.slice(0,-1));const w=x.length>0?x.split(",").map(E=>E.trim()):[];for(const E of e.tracks){const N=L.get(E.id);if(!N)continue;const Z=k.indexOf(E.id),se=Z>=0&&Z<w.length?w[Z].length:0;N.textContent=`${E.name} (${se}${b[y].charUnit})`}};[...e.tracks].slice().sort((T,x)=>T.order-x.order).forEach(T=>{const x=document.createElement("div");x.style.cssText=`
            display: flex;
            align-items: center;
            margin-bottom: 8px;
         `;const w=document.createElement("input");w.type="checkbox",w.id=`track-${T.id}`,w.value=String(T.id),w.checked=T.notes.length>0,w.disabled=T.notes.length===0,w.style.margin="0 4px 0 0",w.style.cursor="pointer";const E=document.createElement("label");E.htmlFor=`track-${T.id}`,L.set(T.id,E),E.textContent=`${T.name}`,E.style.cssText=`
                margin-left: 8px;
                ${T.notes.length===0?"color: #aaa;":""}
            `,w.addEventListener("change",()=>{V(),C()}),x.append(w,E),r.appendChild(x)});function B(T,x){if(t?.prebuiltDefault)return t.prebuiltDefault;const w=T.slice().sort((Z,se)=>Z.order-se.order),E=[];for(const Z of w){const se=M(Z);se&&se.length>0&&E.push(se);const it=zt(Z.notes??[]);it&&it.length>0}const N=E.join(",");return`MML@t${Math.min(x,Je)}${N};`}function V(){const T=[];r.querySelectorAll('input[type="checkbox"]').forEach(E=>{E.checked&&T.push(parseInt(E.value))});const x=e.tracks.filter(E=>T.includes(E.id));k=x.slice().sort((E,N)=>E.order-N.order).map(E=>E.id);const w=B(x,e.bpm);s.value=w}V(),C(),h.onclick=f,o.onclick=T=>{T.target===o&&f()},g.onclick=()=>{navigator.clipboard.writeText(s.value),g.textContent=b[y].copied,setTimeout(()=>{g.textContent=b[y].convertCopy},2e3)},m.onclick=()=>{try{const T=new Blob([s.value],{type:"text/plain;charset=utf-8"}),x=document.createElement("a");x.href=URL.createObjectURL(T);const w=(u.value||"").trim(),E=`mml-${new Date().toISOString().replace(/[:.]/g,"-")}.txt`;let N=w.length>0?w:E;N=N.replace(/[\\\/:*?"<>|]/g,"_"),/\.txt$/i.test(N)||(N+=".txt"),x.download=N,document.body.appendChild(x),x.click(),setTimeout(()=>{URL.revokeObjectURL(x.href),x.parentNode&&x.parentNode.removeChild(x)},0)}catch{}},window.addEventListener("keydown",v,!0)}function no(){const e=document.createElement("div");e.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `;const t=document.createElement("div");t.id="guideModalContent",t.style.cssText=`
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        max-width: 600px;
        width: 90%;
        max-height: 80%;
        overflow-y: auto;
        position: relative;
    `,ve();const o=de({label:"✕",variant:"ghost",size:"sm",title:b[y].modalClose,attrs:{"data-i18n-title":"modalClose"}});o.style.position="absolute",o.style.top="10px",o.style.right="10px";const n=a=>{a.key==="Escape"&&r()};function r(){window.removeEventListener("keydown",n,!0),e.parentNode&&document.body.removeChild(e)}o.onclick=r,Ao(t),t.appendChild(o),e.appendChild(t),document.body.appendChild(e),window.addEventListener("keydown",n,!0)}let pe=null,J=null,Oe=null,We=null,_e=null;function Ln(e,t,o){if(pe||Sn(),!pe||!J||!Oe||!We)return;J.value=(o??e.mmlString)||"",pe.style.display="flex",J.focus();const n=a=>{a.stopPropagation()};J.addEventListener("keydown",n),J.addEventListener("keyup",n);function r(){pe.style.display="none",J.removeEventListener("keydown",n),J.removeEventListener("keyup",n),Oe.onclick=null,We.onclick=null,_e&&(window.removeEventListener("keydown",_e,!0),_e=null)}Oe.onclick=()=>{t(J.value),r()},We.onclick=r,_e=a=>{a.key==="Escape"&&(a.stopPropagation(),r())},window.addEventListener("keydown",_e,!0)}function Sn(){pe=document.createElement("div"),pe.id="mmlEditModal",pe.style.cssText=`
    position: fixed; 
    left: 0; top: 0; 
    width: 100vw; 
    height: 100vh;
    background: rgba(0,0,0,0.25); 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    z-index: 200;
    display: none;
  `;const e=document.createElement("div");e.style.cssText=`
            background: #fff;
            padding: 24px;
            border-radius: 8px;
            min-width: 400px;
            box-shadow: 0 2px 16px #0002;
            display: flex;
            flex-direction: column;
            gap: 12px;
        `,J=document.createElement("textarea"),J.style.cssText=`
            width: 100%;
            min-height: 120px;
            font-family: monospace;
            font-size: 15px;
            word-break: break-all;
            overflow-y: auto;
        `,J.wrap="off",ve(),Oe=de({label:b[y].ok,variant:"primary",attrs:{"data-i18n":"ok"}}),We=de({label:b[y].cancel,variant:"secondary",attrs:{"data-i18n":"cancel"}});const t=document.createElement("div");t.style.cssText=`
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        `,t.append(We,Oe),e.append(J,t),pe.appendChild(e),document.body.appendChild(pe)}function En(){return{scrollX:0,scrollY:0,keyHeight:16,activeTrackId:1,selectedLength:16,hover:{noteId:null,edge:null},drag:null,ghost:null,ghostGroup:null,selected:new Set,marquee:{active:!1,x0:0,y0:0,x1:0,y1:0,mode:"replace"},clipboard:null,volumeLabels:new Set}}function Cn(e,t,o,n,r,a,l){e.save();const u=window.devicePixelRatio||1;e.setTransform(u,0,0,u,0,0);const d=e.canvas.clientWidth||e.canvas.width/u,s=e.canvas.clientHeight||e.canvas.height/u;e.clearRect(0,0,d,s),Bn(e,t,o,n,r),Nn(e,o,t,n),An(e,t,o,n,r),Rn(e,t,o,n,r),$n(e,o,n),e.restore()}function Ro(e,t,o,n,r){const a=window.devicePixelRatio||1;e.setTransform(a,0,0,a,0,0);const l=t.clientWidth||t.width/a,u=t.clientHeight||t.height/a;e.clearRect(0,0,l,u),e.fillStyle="#ffffff",e.fillRect(0,0,l,u);const d=84*n.keyHeight;Pn(e,0,l,n),Dn(e,o,0,l,d,r)}function Fe(e,t,o,n,r,a){const l=Math.max(0,Math.min(a,Math.floor(Math.min(n,r)/2))),u=Math.floor(t),d=Math.floor(o),s=u+Math.max(0,n),c=d+Math.max(0,r);if(e.beginPath(),l<=0){e.rect(u,d,n,r);return}e.moveTo(u+l,d),e.lineTo(s-l,d),e.arcTo(s,d,s,d+l,l),e.lineTo(s,c-l),e.arcTo(s,c,s-l,c,l),e.lineTo(u+l,c),e.arcTo(u,c,u,c-l,l),e.lineTo(u,d+l),e.arcTo(u,d,u+l,d,l)}function Pn(e,t,o,n){const r=n.keyHeight,a=84*r,l=Math.ceil(a/r);for(let u=0;u<l;u++){const d=u*r,c=((95-u)%12+12)%12,g=c===1||c===3||c===6||c===8||c===10;e.fillStyle=g?"#d6d6d6":"#ffffff",e.fillRect(t,d,Math.max(0,o),r);const m=c===11;e.strokeStyle=m?"#000000":"rgb(153,153,153)",e.beginPath(),e.moveTo(t,d+.5),e.lineTo(t+Math.max(0,o),d+.5),e.stroke()}}function Dn(e,t,o,n,r,a){const l=_[t.zoomLevel-1],u=a&&a>=1?a:t.timeSig.beatsPerBar,d=Math.max(0,Math.floor(o/l)-2),s=Math.floor((o+n)/l)+2;for(let g=d;g<=s;g++){const m=Math.floor(g*l),h=g%u===0;e.strokeStyle=h?"#000":"rgb(128,128,128)",e.beginPath(),e.moveTo(m,0),e.lineTo(m,r),e.stroke()}const c=t.zoomLevel;c>=4&&xt(e,o,n,r,l,2,"rgb(191,191,191)"),c>=6&&xt(e,o,n,r,l,4,"rgb(191,191,191)"),c>=8&&xt(e,o,n,r,l,8,"rgb(191,191,191)")}function xt(e,t,o,n,r,a,l){const u=Math.max(0,Math.floor(t/r)-2),d=Math.floor((t+o)/r)+2;e.strokeStyle=l;for(let s=u;s<=d;s++)for(let c=1;c<a;c+=2){const g=Math.floor((s+c/a)*r);e.beginPath(),e.moveTo(g,0),e.lineTo(g,n),e.stroke()}}function Bn(e,t,o,n,r){const a=_[t.zoomLevel-1],l=o.activeTrackId,u=[...t.tracks].sort((d,s)=>d.id===l?1:s.id===l?-1:0);for(const d of u){const s=d.id===l?1:.5;e.globalAlpha=s;for(const c of d.notes){const g=Math.round(c.startTick/S*a),m=Math.max(1,Math.round(c.durationTick/S*a));if(g+m<n||g>n+r)continue;const h=g-Math.floor(n);In(e,h,c,d.color,a,o.keyHeight,o.hover,d.id===l,o.selected.has(c.id))}}e.globalAlpha=1}function In(e,t,o,n,r,a,l,u,d){const s=Math.max(1,Math.round(o.durationTick/S*r)),c=(95-o.pitch)*a+1,g=a-1,m=Math.min(6,Math.floor(g/2));if(e.fillStyle=n,Fe(e,t,c,s,g,m),e.fill(),e.strokeStyle="rgba(0,0,0,0.3)",e.lineWidth=1,Fe(e,t,c,s-1,g-1,Math.max(0,m-1)),e.stroke(),d&&(e.strokeStyle="#3a7afe",e.lineWidth=2,Fe(e,t,c,s-1,g-1,Math.max(0,m-1)),e.stroke(),e.lineWidth=1),u&&l.noteId===o.id){const h=Math.min(8,Math.floor(s/3));e.fillStyle="rgba(0,0,0,0.15)",e.fillRect(t,c,h,g),e.fillRect(t+s-h,c,h,g)}}function Nn(e,t,o,n){const r=_[o.zoomLevel-1],a=l=>{const u=Math.round(l.startTick/S*r)-Math.floor(n),d=Math.max(1,Math.round(l.durationTick/S*r)),s=(95-l.pitch)*t.keyHeight+1,c=t.keyHeight-1;e.globalAlpha=.7,e.fillStyle=l.color;const g=Math.min(6,Math.floor(c/2));Fe(e,u,s,d,c,g),e.fill(),e.globalAlpha=1};if(t.ghost&&a(t.ghost),t.ghostGroup)for(const l of t.ghostGroup)a(l)}function An(e,t,o,n,r){const a=_[t.zoomLevel-1],l=o.keyHeight;e.strokeStyle="#3a7afe",e.lineWidth=2;for(const u of t.tracks)for(const d of u.notes){if(!o.selected.has(d.id))continue;const s=Math.round(d.startTick/S*a)-Math.floor(n),c=Math.max(1,Math.round(d.durationTick/S*a)),g=s+Math.floor(n);if(g+c<n||g>n+r)continue;const m=(95-d.pitch)*l+1,h=l-1,f=Math.min(6,Math.floor(h/2));Fe(e,s,m,c-1,h-1,Math.max(0,f-1)),e.stroke()}e.lineWidth=1}function Rn(e,t,o,n,r){if(!o.volumeLabels||o.volumeLabels.size===0)return;const a=_[t.zoomLevel-1],l=o.keyHeight;e.font="10px sans-serif",e.textAlign="left",e.textBaseline="bottom";for(const u of t.tracks)for(const d of u.notes){if(!o.volumeLabels.has(d.id))continue;const s=Math.round(d.startTick/S*a),c=Math.max(1,Math.round(d.durationTick/S*a));if(s+c<n||s>n+r)continue;const g=s-Math.floor(n),m=(95-d.pitch)*l+1,h="V"+String(d.volume??D);e.fillStyle="rgba(255,255,255,0.9)",e.fillText(h,g+1,m-1),e.fillStyle="rgba(0,0,0,0.85)",e.fillText(h,g,m-2)}}function $n(e,t,o){if(!t.marquee.active)return;const n=Math.min(t.marquee.x0,t.marquee.x1)-Math.floor(o),r=Math.min(t.marquee.y0,t.marquee.y1),a=Math.abs(t.marquee.x1-t.marquee.x0),l=Math.abs(t.marquee.y1-t.marquee.y0);e.fillStyle="rgba(58,122,254,0.15)",e.fillRect(n,r,a,l),e.strokeStyle="rgba(58,122,254,0.8)",e.setLineDash([4,3]),e.strokeRect(n+.5,r+.5,a-1,l-1),e.setLineDash([])}function Pt(e,t,o,n,r){for(let a=o.length-1;a>=0;a--){const l=o[a],u=Math.round(l.startTick/S*n),d=Math.max(1,Math.round(l.durationTick/S*n)),s=(95-l.pitch)*r+1,c=r-1;if(e>=u&&e<=u+d&&t>=s&&t<=s+c){const g=Math.min(8,Math.floor(d/3)),m=e<=u+g?"left":e>=u+d-g?"right":"center";return{note:l,edge:m}}}}function _n(e,t,o,n,r,a,l){const u=Math.min(e,o),d=Math.max(e,o),s=Math.min(t,n),c=Math.max(t,n),g=[];for(const m of r){const h=Math.round(m.startTick/S*a),f=Math.max(1,Math.round(m.durationTick/S*a)),v=(95-m.pitch)*l+1,k=l-1,L=h+f,M=v+k;L>=u&&h<=d&&M>=s&&v<=c&&g.push(m)}return g}function zn(e,t,o){e.clearRect(0,0,t.width,t.height);const n=window.devicePixelRatio||1,r=12*o;for(let a=0;a<7;a++){const l=(6-a)*r,u=a%2===1;e.fillStyle=u?"#e6e6e6":"#ffffff",e.fillRect(0,l,t.width/n,r),e.fillStyle="#222",e.font=`${Math.max(10,Math.round(12))}px system-ui, sans-serif`,e.textBaseline="middle",e.textAlign="center";const d="o"+(a+1),s=l+r/2;e.fillText(d,Math.floor(t.width/n/2),Math.floor(s))}}function Vn(e,t,o,n,r,a){const l=t.width,u=t.height,d=window.devicePixelRatio||1;e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,l,u),d!==1&&e.setTransform(d,0,0,d,0,0);const s=l/d,c=u/d;e.fillStyle="#ffffff",e.fillRect(0,0,s,c);const g=Math.floor(o/n),m=Math.ceil((o+s)/n);for(let h=g;h<=m;h++){const f=Math.round(h*n-o)+.5;if(h%r===0){e.strokeStyle="#000000",e.beginPath(),e.moveTo(f,0),e.lineTo(f,c),e.stroke();const k=Math.floor(h/r)+1;e.fillStyle="#222",e.font="12px system-ui, sans-serif",e.textAlign="left",e.textBaseline="top",e.fillText(String(k),f+4,2)}else{e.strokeStyle="rgb(128,128,128)";const k=Math.floor(c*.5);e.beginPath(),e.moveTo(f,k),e.lineTo(f,c),e.stroke()}}}function io(e,t,o){const n=window.devicePixelRatio||1,r=t.clientHeight||t.height/n;e.save(),e.setTransform(n,0,0,n,0,0),e.strokeStyle="rgba(255,0,0,0.9)",e.lineWidth=2,e.beginPath(),e.moveTo(Math.floor(o)+.5,0),e.lineTo(Math.floor(o)+.5,r),e.stroke(),e.restore()}function Hn(e,t,o,n){const r=window.devicePixelRatio||1,a=t.clientHeight||t.height/r;e.save(),e.setTransform(r,0,0,r,0,0),e.fillStyle="rgba(255,0,0,0.12)",e.fillRect(Math.floor(o),0,Math.ceil(n),a),e.restore()}function Un(e,t){const o=document.createElement("div");o.style.cssText=`
    position: fixed; inset: 0; background: rgba(0,0,0,0.5);
    display: flex; align-items: center; justify-content: center; z-index: 1000;`;const n=document.createElement("div");n.style.cssText=`
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        width: 320px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
        gap: 12px;
    `;const r=document.createElement("div");r.textContent=b[y].tempoModalTitle,r.setAttribute("data-i18n","tempoModalTitle"),r.style.cssText=`
        font-weight: 600;
        font-size: 14px;
    `;const a=document.createElement("input");a.type="number",a.min="20",a.max=String(Je),a.step="1",a.value=String(e.bpm),a.style.cssText=`
        width: 100%;
        box-sizing: border-box;
        padding: 8px;
        font-size: 14px;
    `;const l=document.createElement("div");l.style.cssText=`
        display: flex;
        justify-content: flex-end;
        gap: 8px;
    `,ve();const u=de({label:b[y].cancel,variant:"secondary",attrs:{"data-i18n":"cancel"}}),d=de({label:b[y].ok,variant:"primary",attrs:{"data-i18n":"ok"}});l.append(u,d),n.append(r,a,l),o.appendChild(n),document.body.appendChild(o);const s=()=>{o.parentNode&&document.body.removeChild(o)};u.onclick=s,d.onclick=()=>{const c=Math.max(20,Math.min(Je,Math.round(Number(a.value||e.bpm))));t(c),s()},a.addEventListener("keydown",c=>{c.key==="Enter"&&d.click(),c.key==="Escape"&&s()}),setTimeout(()=>a.focus(),0)}function On(e,t){const o=document.createElement("div");o.style.cssText=`
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    `;const n=document.createElement("div");n.style.cssText=`
        background: #fff;
        width: min(640px, 92vw);
        max-height: 80vh;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        padding: 18px 18px 14px;
        position: relative;
        overflow: auto;
    `;const r=document.createElement("h2");r.textContent=b[y].whatsNewTitle||"What's new",r.style.margin="0 0 8px 0",r.style.fontSize="18px",r.setAttribute("data-i18n","whatsNewTitle");const a=document.createElement("div"),l=document.createElement("h3");l.textContent=b[y].whatsNew_20250827_heading||"Load behavior changed",l.setAttribute("data-i18n","whatsNew_20250827_heading"),l.style.margin="8px 0 6px 0";const u=document.createElement("ul");u.style.margin="6px 0 0 18px",u.style.padding="0";const d=document.createElement("li");d.textContent=b[y].whatsNew_20250827_p1||"Removed auto-load on page start.",d.setAttribute("data-i18n","whatsNew_20250827_p1");const s=document.createElement("li");s.textContent=b[y].whatsNew_20250827_p2||"Use the 'Load' button in the toolbar to restore saved work.",s.setAttribute("data-i18n","whatsNew_20250827_p2"),u.append(d,s),a.append(l,u),ve();const c=de({label:b[y].ok||"OK",size:"sm",variant:"primary"});c.setAttribute("data-i18n","ok"),c.style.marginTop="12px",c.style.alignSelf="flex-end";const g=()=>{o.remove();try{localStorage.setItem("mml_editor_whatsnew_shown_"+e,"1")}catch{}};c.addEventListener("click",g);const m=h=>{h.key==="Escape"&&g()};window.addEventListener("keydown",m,{once:!0}),o.addEventListener("click",h=>{h.target===o&&g()}),n.append(r,a,c),o.appendChild(n),document.body.appendChild(o)}const Be=document.getElementById("footerMmlEditBtn"),Tt=document.getElementById("footerMMLText"),Te=document.getElementById("footerLabel"),rt=document.getElementById("btnPasteMML"),$o="mml_editor_project";let p=Eo();const K=new nn,i=En(),Vt=new Worker(new URL(""+new URL("mmlOptimizerWorker-Dw_ZSwXZ.js",import.meta.url).href,import.meta.url),{type:"module"}),kt=new Map,Wn=300;let Mt=null;const Xe=document.getElementById("progress");let gt="time";const $=document.getElementById("roll"),W=document.getElementById("rollBg"),Q=document.getElementById("octaveCanvas");let P=null,O=null,ze=null,Ve=null,ke=null;const X=document.getElementById("timeRuler"),ie=$.getContext("2d"),mt=W?W.getContext("2d"):null,_o=Q.getContext("2d"),Dt=X.getContext("2d"),ao=document.getElementById("tracks"),qe=document.getElementById("lenBar"),ee=document.getElementById("dispSigN");let Le=4;const ro="mml_editor_display_timesig_n",he=document.getElementById("tempoDisplay"),A=document.getElementById("rollViewport"),Ae=document.getElementById("rulerContainer"),He=document.getElementById("customScrollbar"),Ke=document.getElementById("customScrollbarThumb"),Bt=document.getElementById("btnPlay"),It=document.getElementById("btnPause"),Nt=document.getElementById("btnStop"),ue=document.getElementById("btnPlayheadMode"),lt=document.getElementById("btnConvert"),Ze=document.getElementById("btnGuide"),ce=document.getElementById("btnLoad"),me=document.getElementById("btnToggleTouch"),lo=document.getElementById("btnGoToMobile"),dt=document.getElementById("langKo"),st=document.getElementById("langJa"),ct=document.getElementById("langEn"),Fn=document.getElementById("btnPushBeat"),Xn=document.getElementById("btnPushBar"),qn=document.getElementById("btnCutBeat"),Kn=document.getElementById("btnCutBar"),Y=document.getElementById("btnModeSelect"),so=document.getElementById("btnClearSelection"),co=document.getElementById("btnCopyNotes"),uo=document.getElementById("btnCutNotes"),po=document.getElementById("btnPasteNotes"),go=document.getElementById("btnDeleteNotes"),Ee=document.getElementById("btnUndo"),Ce=document.getElementById("btnRedo"),mo=document.getElementById("btnVolumeDown"),ho=document.getElementById("btnVolumeUp"),fo=document.getElementById("btnZoomOut"),yo=document.getElementById("btnZoomIn"),bo=document.getElementById("btnSelectAll"),ae=document.getElementById("keyHeightRange"),Ie=document.getElementById("keyHeightLabel"),re="rgba(255,215,0,0.8)";let R=!1,G=0,At=0,Se=!1,Zn=0,Ge=0,je=0,Ht=!1;const le={pitch:null,sampler:null};let ge=-1,fe="area",Ue=!1;const zo="mml_editor_key_height",Pe=document.getElementById("rulerOverlayLeft"),De=document.getElementById("rulerOverlayRight"),H=document.createElement("button");function Me(){const e=document.activeElement;if(!e)return;const t=e.tagName.toLowerCase();if((t==="input"||t==="select"||t==="textarea"||t==="button"||e.isContentEditable)&&!e.closest("#rollViewport, #roll, #rollBg, #timeRuler, #rulerContainer"))try{e.blur()}catch{}}function Vo(e){const t=e.target;return t?!!t.closest("#rollViewport, #roll, #rollBg, #timeRuler, #rulerContainer, .ruler-overlay"):!1}function vo(e){const t={bpm:120,timeSig:{beatsPerBar:4},zoomLevel:1,tracks:[],maxEndTick:0,tpqn:e?.tpqn??S,extendedUnitsEnabled:e?.extendedUnitsEnabled??te},o=Number(e?.bpm);t.bpm=Number.isFinite(o)&&o>0?o:120;const n=Number(e?.timeSig?.beatsPerBar);t.timeSig={beatsPerBar:Number.isFinite(n)&&n>=1?n:4};const r=Number(e?.zoomLevel);t.zoomLevel=Number.isFinite(r)&&r>=1&&r<=9?r:1;const a=Array.isArray(e?.tracks)?e.tracks:[],l=Math.max(1,Math.min(6,a.length||6));for(let d=0;d<l;d++){const s=a[d]??{},g=(Array.isArray(s?.notes)?s.notes:[]).map(V=>{const T=typeof V?.id=="string"&&V.id?V.id:crypto.randomUUID(),x=Math.max(0,Math.floor(Number(V?.startTick)||0)),w=Math.max(1,Math.floor(Number(V?.durationTick)||1)),E=Math.max(0,Math.floor(Number(V?.pitch)||0)),N=Math.max(0,Math.min(15,Math.floor(Number(V?.volume)||D)));return{id:T,startTick:x,durationTick:w,pitch:E,volume:N}}),m=typeof s?.instrument=="string"&&yt.includes(s.instrument)?s.instrument:_t,h=Number(s?.id)||d+1,f=Number.isFinite(Number(s?.order))?Number(s.order):d,v=typeof s?.name=="string"&&s.name?s.name:`Track ${d+1}`,k=typeof s?.color=="string"&&s.color?s.color:Et[d%Et.length],L=!!s?.mute,M=!!s?.solo,C=typeof s?.mmlString=="string"?s.mmlString:"",B=typeof s?.optimizedMML=="string"?s.optimizedMML:"";t.tracks.push({id:h,order:f,name:v,color:k,instrument:m,mmlString:C,optimizedMML:B,mute:L,solo:M,notes:g})}t.tracks.sort((d,s)=>d.order-s.order),t.tracks.forEach((d,s)=>{d.order=s});let u=0;for(const d of t.tracks)for(const s of d.notes)u=Math.max(u,s.startTick+s.durationTick);return t.maxEndTick=u,t}function $e(){Mt==null&&(Mt=requestAnimationFrame(()=>{Mt=null,z()}))}function U(e,t,o){e.setAttribute("data-i18n-title",t),e.title=o||b[y][t]||""}function oe(e,t,o){e.classList.add("btn",`btn--${t}`,`btn--${o}`)}function ye(e){return Math.max(0,Math.min(15,e))}function Ye(e){return Math.max(12,Math.min(95,e))}function ht(e){return e.sort((t,o)=>t.startTick-o.startTick||t.pitch-o.pitch)}function Ho(e){return e.sort((t,o)=>t.startTick-o.startTick||t.id.localeCompare(o.id))}function Uo(e,t){const o=t.volume??D;if(!i.volumeLabels)return;const n=Ho(e.notes.slice()),r=n.findIndex(u=>u.id===t.id),a=r>0?n[r-1].volume??D:D,l=n.slice(0,r).some((u,d,s)=>{const c=i.volumeLabels.has(u.id),g=d>0?s[d-1].volume??D:D,m=(u.volume??D)!==g;return c||m});o===D?l?i.volumeLabels.add(t.id):i.volumeLabels.delete(t.id):o!==a?i.volumeLabels.add(t.id):i.volumeLabels.delete(t.id)}function et(e){return Ho(e.notes.slice())}function Oo(e,t,o){if(t<0||t>=e.length)return!1;const n=e[t],r=t>0?e[t-1].volume??D:D,a=n.volume??D;return(o?.has(n.id)??!1)||a!==r}function Wo(e,t,o){const n=et(e),r=n.findIndex(l=>l.id===t.id);if(r<0)return;let a=n.length;for(let l=r+1;l<n.length;l++)if(Oo(n,l,i.volumeLabels)){a=l;break}for(let l=r;l<a;l++)n[l].volume=ye(o)}function Gn(e,t,o){const n=et(e),r=new Map(n.map(u=>[u.id,u.volume??D])),a=n.map((u,d)=>({n:u,i:d})).filter(u=>t.has(u.n.id)).map(u=>u.i).sort((u,d)=>u-d);let l=0;for(;l<a.length;){const u=a[l];let d=l+1;for(;d<a.length&&a[d]===a[d-1]+1;)d++;const s=u,c=a[d-1],g=s>0?r.get(n[s-1].id)??D:D;for(let h=s;h<=c;h++)n[h].volume=ye(o);let m=c+1;for(;m<n.length&&t.has(n[m].id);)m++;m<n.length&&(n[m].volume=g),l=d}}function Ut(e){if(!i.volumeLabels)return;const t=et(e),o=new Set(t.map(r=>r.id));for(const r of Array.from(i.volumeLabels))o.has(r)&&i.volumeLabels.delete(r);let n=D;for(const r of t){const a=r.volume??D;a!==n&&i.volumeLabels.add(r.id),n=a}}function jn(){if(P)return;P=document.createElement("div"),P.style.position="fixed",P.style.zIndex="10000",P.style.background="#fff",P.style.border="1px solid #ccc",P.style.boxShadow="0 4px 12px rgba(0,0,0,0.15)",P.style.borderRadius="8px",P.style.padding="10px 12px",P.style.minWidth="220px",P.style.display="none",P.addEventListener("wheel",a=>a.stopPropagation(),{passive:!1});const e=document.createElement("div");e.style.marginBottom="8px",e.textContent=(b[y].volLabel||"볼륨")+" (0-15)",O=document.createElement("input"),O.type="range",O.min="0",O.max="15",O.step="1",O.value=String(D),O.style.width="100%";const t=document.createElement("div");t.style.fontSize="12px",t.style.color="#555",t.style.marginTop="6px";const o=()=>{t.textContent="V"+(O?.value??String(D))};O.addEventListener("input",o),o();const n=document.createElement("div");n.style.display="flex",n.style.gap="8px",n.style.marginTop="10px",ze=document.createElement("button"),ze.className="btn btn--primary btn--sm",ze.textContent=b[y].volApplyRange||"변경",Ve=document.createElement("button"),Ve.className="btn btn--secondary btn--sm",Ve.textContent=b[y].volApplySelected||"선택한 노트만 변경",n.append(ze,Ve),P.append(e,O,t,n),document.body.appendChild(P);const r=()=>{P&&(P.style.display="none"),ke=null};document.addEventListener("keydown",a=>{P&&P.style.display!=="none"&&a.key==="Escape"&&r()}),document.addEventListener("mousedown",a=>{!P||P.style.display==="none"||P.contains(a.target)||r()}),ze.addEventListener("click",()=>{if(!ke||!O)return;const a=p.tracks.find(d=>d.id===i.activeTrackId);if(!a)return;const l=a.notes.find(d=>d.id===ke);if(!l)return;j();const u=ye(parseInt(O.value,10));Wo(a,l,u),ne({track:a,recomputeLabels:!0}),P.style.display="none",ke=null}),Ve.addEventListener("click",()=>{if(!O)return;const a=p.tracks.find(u=>u.id===i.activeTrackId);if(!a)return;j();const l=ye(parseInt(O.value,10));Gn(a,new Set(i.selected),l),ne({track:a,recomputeLabels:!0}),P.style.display="none",ke=null})}function Ot(){P&&P.style.display!=="none"&&(P.style.display="none",ke=null)}function Yn(e,t,o){if(jn(),!P||!O)return;ke=e.id;const n=e.volume??D;O.value=String(n);const r=P.querySelector("div:nth-child(3)");r&&(r.textContent="V"+n),P.style.display="block";const a=P.getBoundingClientRect(),l=window.innerWidth,u=window.innerHeight;let d=t,s=o;d+a.width>l&&(d=Math.max(0,l-a.width-8)),s+a.height>u&&(s=Math.max(0,u-a.height-8)),P.style.left=`${d}px`,P.style.top=`${s}px`}function Fo(e){const t=Math.floor(G);if(e!==0){j();for(const o of p.tracks){for(const n of o.notes)(n.startTick>=t||n.startTick+n.durationTick>t)&&(n.startTick+=e);ht(o.notes)}p.maxEndTick+=Math.max(0,e),Wt(p.tracks),F(),$e()}}function Xo(e){const t=Math.floor(G);if(e!==0){j();for(const o of p.tracks){const n=[];for(const r of o.notes){const a=r.startTick,l=r.startTick+r.durationTick;if(l<=t)n.push(r);else{if(a>=t&&a<t+e)continue;if(a>=t+e)n.push({...r,startTick:Math.max(t,a-e)});else if(a<t&&l>t){const u=t-a;u>0&&n.push({...r,durationTick:u})}}}ht(n),o.notes=n}p.maxEndTick=Math.max(0,p.maxEndTick-e),Wt(p.tracks),F(),$e()}}function qo(){return p.timeSig.beatsPerBar}function Jn(){try{p.selectedLength=i.selectedLength,p.playheadVisualMode=fe,p.tpqn=S,p.extendedUnitsEnabled=te,p.tempoChanges&&Array.isArray(p.tempoChanges);const e={...p,tracks:p.tracks.map(t=>({id:t.id,notes:t.notes,name:t.name,instrument:t.instrument,optimizedMML:t.optimizedMML,order:t.order,mute:t.mute,solo:t.solo,color:t.color}))};return localStorage.setItem($o,JSON.stringify(e)),!0}catch(e){try{console.error("Save failed",e)}catch{}return!1}}let wt=null;function F(){wt&&window.clearTimeout(wt),wt=window.setTimeout(()=>{Jn()},300)}function j(){K.push(p),F()}function Ko(e){const t=kt.get(e.id);t&&clearTimeout(t);const o=setTimeout(()=>{try{Vt.postMessage({track:e,tpqn:p.tpqn??S})}catch{}kt.delete(e.id)},Wn);kt.set(e.id,o)}function Wt(e){for(const t of e)try{Vt.postMessage({track:t,tpqn:p.tpqn??S})}catch{}}function ne(e={}){const{track:t,recomputeLabels:o}=e;t&&(o&&Ut(t),Ko(t),be()),$e()}function Ft(){const e=document.querySelector(".panel.canvas-wrap");e&&(e.style.height="")}function be(){if(!Tt)return;const e=p.tracks.find(o=>o.id===i.activeTrackId)||p.tracks[0];let t=e&&(e.optimizedMML?.trim?.()||e.mmlString?.trim?.())||"";t=t.replace(/[\r\n]+/g,""),Tt.textContent=t,Tt.title=t}function Zo(e,t){const o=(t||"").replace(/[\r\n]+/g,"").trim();e.mmlString=o;try{j();let n=p.bpm;const r=o.match(/^t(\d+)/);r&&(n=parseInt(r[1],10)),e.notes=pn("MML@"+o),p.tracks[0]===e&&(p.bpm=n),Ut(e),Ko(e),F(),$e()}catch{e.notes=[]}}function Qn(){const e=p.tracks.filter(r=>r.solo),t=e.length>0?e:p.tracks.filter(r=>!r.mute),o=r=>yt.includes(r)?r:_t,n=[];for(const r of t){const a=o(r.instrument||"lute");for(const l of r.notes)n.push({startTick:l.startTick,durationTick:l.durationTick,pitch:l.pitch,trackId:r.id,instrumentKey:a,volume:l.volume})}return n}function ei(){q(),Jo(),A&&new ResizeObserver(()=>{ge=-1,z()}).observe(A);const e=document.getElementById("mobileTools"),t="mml_editor_touch_visible",o=c=>{!e||!me||(e.style.display=c?"flex":"none",me.setAttribute("data-i18n-title",c?"tooltipTouchToggleHide":"tooltipTouchToggleShow"),me.title=b[y][c?"tooltipTouchToggleHide":"tooltipTouchToggleShow"],me.setAttribute("aria-label",me.title),me.classList.toggle("is-active",c),localStorage.setItem(t,c?"1":"0"))},n=localStorage.getItem(t);o(n?n==="1":!1),me?.addEventListener("click",()=>{const c=e?.style.display!=="none";o(!c)}),lo?.addEventListener("click",()=>{window.location.href="./mobile.html"});const a=(c,g="ghost")=>{c&&oe(c,g,"sm")};if(a(me,"ghost"),a(lo,"primary"),a(Y,"ghost"),a(so,"ghost"),a(co,"ghost"),a(uo,"ghost"),a(po,"secondary"),a(go,"secondary"),a(mo,"ghost"),a(ho,"ghost"),a(fo,"ghost"),a(yo,"ghost"),a(bo,"ghost"),$.addEventListener("pointermove",c=>{Vo(c)&&Me(),ui(c)}),$.addEventListener("pointerdown",c=>{Me(),c.preventDefault(),pi(c)},{passive:!1}),window.addEventListener("pointerup",mi),window.addEventListener("pointermove",gi),window.addEventListener("pointermove",c=>{window.lastPointerX=c.clientX,window.lastPointerY=c.clientY}),window.addEventListener("keydown",ii),window.addEventListener("keyup",ni),window.addEventListener("wheel",ri,{passive:!1}),window.addEventListener("contextmenu",c=>{c.preventDefault()},{passive:!1}),A.addEventListener("scroll",ai),X.addEventListener("click",c=>{Me(),nt(c)}),X.addEventListener("pointerdown",c=>{Me(),c.preventDefault(),yi(c)},{passive:!1}),window.addEventListener("pointermove",bi),window.addEventListener("pointerup",vi),Bt.addEventListener("click",on),It.addEventListener("click",$t),Nt.addEventListener("click",Qo),Y){const c=()=>{Y.setAttribute("data-i18n","selectModeLabel"),Y.textContent=b[y].selectModeLabel||"선택모드";const g=Ue?"tooltipSelectMode":"tooltipDrawMode";Y.setAttribute("data-i18n-title",g),Y.title=b[y][g],Y.setAttribute("aria-label",Y.title),Y.classList.toggle("is-active",Ue)};Y.addEventListener("click",()=>{Ue=!Ue,c()}),c()}so?.addEventListener("click",()=>{i.selected.clear(),i.marquee.active=!1,i.drag=null,i.ghost=null,z(),F()}),co?.addEventListener("click",()=>qt()),uo?.addEventListener("click",()=>jo()),po?.addEventListener("click",()=>{R||Yo()}),go?.addEventListener("click",()=>{Xt(),F()}),bo?.addEventListener("click",()=>{Go(),F()}),mo?.addEventListener("click",()=>xo(-1)),ho?.addEventListener("click",()=>xo(1)),ae?.addEventListener("input",()=>{const c=Math.max(16,Math.min(32,parseInt(ae.value,10)));if(c!==i.keyHeight){i.keyHeight=c;try{localStorage.setItem(zo,String(c))}catch{}Ie&&(Ie.textContent=String(c)),ge=-1,Ft(),z()}}),fo?.addEventListener("click",()=>To(-1)),yo?.addEventListener("click",()=>To(1)),ue&&ue.addEventListener("click",()=>{fe=fe==="area"?"line":"area",ue&&(ue.textContent=fe==="area"?b[y].playheadAreaLabel:b[y].playheadLineLabel),I(),F()}),lt.addEventListener("click",ti),rt.addEventListener("click",()=>{R||Ti()}),Xe&&Xe.addEventListener("click",()=>{gt=gt==="barbeat"?"time":"barbeat",Re()}),he&&(he.textContent=String(p.bpm),he.addEventListener("click",()=>{R||Un(p,c=>{K.push(p),p.bpm=c,p.bpm=Math.min(c,Je),he&&(he.textContent=String(p.bpm)),Re?.(),I(),F()})}));let l=!1,u=0,d=0;Ke.addEventListener("pointerdown",c=>{l=!0,u=c.clientX,d=i.scrollX,Ke.setPointerCapture(c.pointerId)}),window.addEventListener("pointermove",c=>{if(!l||R)return;const g=c.clientX-u,m=xe(),h=Math.max(0,m-A.clientWidth),f=Math.max(1,He.clientWidth-Ke.clientWidth),v=h/f,k=d+g*v;i.scrollX=Qe(k),I()}),window.addEventListener("pointerup",()=>{l=!1}),Ze.addEventListener("click",no),ce&&(oe(ce,"secondary","md"),ce.textContent=b[y].load||"Load",U(ce,"tooltipLoad",b[y].tooltipLoad||"Load project"),ce.addEventListener("click",()=>{try{const c=localStorage.getItem($o);if(!c){alert(b[y].noSavedProject||"No saved project found");return}const g=JSON.parse(c);if(!g||!g.tracks){alert(b[y].invalidSavedProject||"Saved data is invalid");return}let m=vo(g);const h=!!m.extendedUnitsEnabled;Co(h);const f=h?Lt:St,v=m.tpqn||f;if(v!==f){const k=f/v;Rt(m,k)}m.tpqn=f,m.extendedUnitsEnabled=h,typeof m.selectedLength=="number"&&(i.selectedLength=m.selectedLength),(m.playheadVisualMode==="area"||m.playheadVisualMode==="line")&&(fe=m.playheadVisualMode),m=vo(m),p=m,i.selected.clear();try{i.volumeLabels?.clear()}catch{}for(const k of p.tracks)Ut(k);be(),q(),z(),alert(b[y].loadedFromLocal||"Loaded from local storage")}catch(c){try{console.error("Load failed",c)}catch{}alert(b[y].loadFailed||"Load failed")}}));const s=c=>{No(c),tn(),ue&&(ue.textContent=fe==="area"?b[y].playheadAreaLabel:b[y].playheadLineLabel),Y&&(Y.textContent=b[y].selectModeLabel||(c==="ja"?"選択モード":c==="en"?"Select mode":"선택모드")),Te&&(Te.textContent=b[y].trackMMLLabel||(c==="ja"?"トラックMML":c==="en"?"Track MML":"트랙MML")),Ee&&(Ee.title=b[y].guideUndo),Ce&&(Ce.title=b[y].guideRedo),ce&&(ce.textContent=b[y].load||(c==="ja"?"読み込み":c==="en"?"Load":"불러오기"),U(ce,"tooltipLoad",b[y].tooltipLoad||ce.title||"Load project")),ae&&(ae.title=b[y].tooltipKeyHeight||ae.title),Ie&&(Ie.textContent=String(i.keyHeight)),q(),be()};dt.addEventListener("click",()=>s("ko")),st.addEventListener("click",()=>s("ja")),ct.addEventListener("click",()=>s("en")),Ee&&(oe(Ee,"secondary","sm"),U(Ee,"guideUndo",b[y].guideUndo)),Ce&&(oe(Ce,"secondary","sm"),U(Ce,"guideRedo",b[y].guideRedo)),Ee?.addEventListener("click",()=>{const c=K.undo(p);c&&(p=c,i.selected.clear(),z(),q(),F())}),Ce?.addEventListener("click",()=>{const c=K.redo(p);c&&(p=c,i.selected.clear(),z(),q(),F())}),Ze.addEventListener("click",no)}function ti(){const e=p.tracks.slice().sort((r,a)=>r.order-a.order),t=[];for(const r of e){const a=(r.optimizedMML||"").trim();if(a)t.push(a);else{let l=(zt(r.notes??[])||"").trim();if(l||(l=(r.mmlString||"").trim()),l){const u=Do(l,!0);t.push(u||l)}}}const n=`${`MML@t${Math.min(p.bpm,Je)}`}${t.join(",")};`;wn(p,{prebuiltDefault:n})}function ft(e){const t=$.getBoundingClientRect(),o=e.clientX-t.left+i.scrollX,n=e.clientY-t.top;return{x:o,y:n}}function oi(e){const t=X.getBoundingClientRect();return{x:e.clientX-t.left+i.scrollX}}function ni(e){e.key==="Alt"&&(Ht=!1,z())}function ii(e){Ot();const t=document.activeElement;if(t&&(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.tagName==="SELECT"||t.isContentEditable))return;e.key==="Alt"&&(e.preventDefault(),Ht=!0,z());for(let a=1;a<=9;a++)e.key===a.toString()&&wo(a-1);if(e.key==="0"&&wo(Ne.length-1),R){e.code==="Space"&&(e.preventDefault(),$t());return}if((e.key==="ArrowUp"||e.key==="ArrowDown")&&e.shiftKey){const a=document.activeElement;if(a&&(a.tagName==="INPUT"||a.tagName==="SELECT"))return;e.preventDefault();const l=p.tracks.find(m=>m.id===i.activeTrackId);if(!l)return;const u=l.notes.filter(m=>i.selected.has(m.id));if(u.length===0)return;const d=m=>Math.floor(Jt(m)/12),s=Math.min(...u.map(m=>d(m.pitch))),c=Math.max(...u.map(m=>d(m.pitch)));if(e.key==="ArrowUp"&&c>=7||e.key==="ArrowDown"&&s<=1)return;j();const g=e.key==="ArrowUp"?12:-12;for(const m of l.notes)i.selected.has(m.id)&&(m.pitch=Jt(m.pitch+g));ne({track:l,recomputeLabels:!0});return}if((e.key==="ArrowUp"||e.key==="ArrowDown")&&!e.shiftKey&&!e.ctrlKey&&!e.metaKey&&!e.altKey){const a=document.activeElement;if(a&&(a.tagName==="INPUT"||a.tagName==="SELECT"))return;e.preventDefault();const l=p.tracks.slice().sort((c,g)=>c.order-g.order),u=l.findIndex(c=>c.id===i.activeTrackId);if(u===-1)return;const d=e.key==="ArrowUp"?-1:1,s=Math.max(0,Math.min(l.length-1,u+d));s!==u&&(i.activeTrackId=l[s].id,q(),z(),be());return}const o=e.ctrlKey||e.metaKey;if(o&&e.key.toLowerCase()==="z"){e.preventDefault();const a=K.undo(p);a&&(p=a,i.selected.clear(),z(),q());return}if(o&&e.key.toLowerCase()==="y"){e.preventDefault();const a=K.redo(p);a&&(p=a,i.selected.clear(),z(),q());return}if(o&&e.key.toLowerCase()==="a"){e.preventDefault(),Go();return}if(e.key==="Escape"){i.selected.clear(),i.marquee.active=!1,i.drag=null,i.ghost=null,z();return}if(e.key==="Delete"){Xt();return}if(o&&e.key.toLowerCase()==="c"){e.preventDefault(),qt();return}if(o&&e.key.toLowerCase()==="v"){e.preventDefault(),Yo();return}if(o&&e.key.toLowerCase()==="x"){e.preventDefault(),jo();return}if(e.code==="Space"){e.preventDefault(),R?$t():on();return}const n=_[p.zoomLevel-1],r=p.timeSig.beatsPerBar*n;if(e.key==="PageDown"){e.preventDefault(),i.scrollX=Math.max(0,Math.ceil((i.scrollX+1)/r)*r),I();return}if(e.key==="PageUp"){e.preventDefault(),i.scrollX=Math.max(0,Math.floor((i.scrollX-1)/r)*r),I();return}if(e.key==="Home"){e.preventDefault(),i.scrollX=0,I();return}if(e.key==="End"){e.preventDefault();const a=xe();i.scrollX=Qe(Math.max(0,a-A.clientWidth)),I();return}}function Go(){i.selected.clear();const e=p.tracks.find(t=>t.id===i.activeTrackId);for(const t of e.notes)i.selected.add(t.id);z()}function Xt(){if(i.selected.size===0)return;K.push(p);const e=p.tracks.find(t=>t.id===i.activeTrackId);e.notes=e.notes.filter(t=>!i.selected.has(t.id)),i.selected.clear(),ne({track:e})}function qt(){const t=p.tracks.find(n=>n.id===i.activeTrackId).notes.filter(n=>i.selected.has(n.id));if(t.length===0)return;const o=Math.min(...t.map(n=>n.startTick));i.clipboard=t.map(n=>({...n,startTick:n.startTick-o}))}function jo(){qt(),Xt()}function Yo(){if(!i.clipboard||i.clipboard.length===0)return;K.push(p);const e=Math.max(0,Math.floor(G)),t=p.tracks.find(o=>o.id===i.activeTrackId);t&&Ct(async()=>{const{insertNoteWithOverlap:o,ensureBars:n}=await import("./timeline-U0IUL4mT.js").then(r=>r.r);return{insertNoteWithOverlap:o,ensureBars:n}},[],import.meta.url).then(({insertNoteWithOverlap:o,ensureBars:n})=>{if(i.selected.clear(),i.clipboard!=null)for(const r of i.clipboard){const a=crypto.randomUUID(),l={...r,id:a,startTick:Math.max(0,e+r.startTick)};o(p,t.id,l),n(p,l.startTick+l.durationTick),i.selected.add(a)}ne({track:t})})}function xo(e){const t=p.tracks.find(n=>n.id===i.activeTrackId);if(!t)return;const o=t.notes.filter(n=>i.selected.has(n.id));if(o.length!==0){K.push(p);for(const n of o){const r=(n.volume??D)+e;n.volume=ye(r),Uo(t,n)}ne({track:t})}}function To(e){const t=Math.max(1,Math.min(9,p.zoomLevel+e));t!==p.zoomLevel&&(p.zoomLevel=t,ge=-1,z())}function ai(){const t=-A.scrollTop+i.keyHeight;Q.style.transform=`translateY(${t}px)`}function ri(e){if(Vo(e)&&Me(),Ot(),e.ctrlKey){e.preventDefault(),li(e);return}if(e.altKey&&e.shiftKey&&i.selected.size>0&&!R){e.preventDefault(),j();const t=e.deltaY>0?-1:1,o=p.tracks.find(s=>s.id===i.activeTrackId),n=et(o),r=new Map(n.map(s=>[s.id,s.volume??D])),a=new Set([...i.selected]),l=n.map((s,c)=>({n:s,i:c})).filter(s=>a.has(s.n.id)).map(s=>s.i).sort((s,c)=>s-c),u=new Map;for(const s of l){const c=n[s].id,g=r.get(c)??D;u.set(s,ye(g+t))}let d=0;for(;d<l.length;){const s=l[d],c=u.get(s);let g=d+1;for(;g<l.length&&l[g]===l[g-1]+1&&u.get(l[g])===c;)g++;const m=s,h=l[g-1],f=m>0?r.get(n[m-1].id)??D:D;for(let k=m;k<=h;k++)n[k].volume=ye(u.get(k));let v=h+1;for(;v<n.length&&a.has(n[v].id);)v++;v<n.length&&(n[v].volume=f,Uo(o,n[v])),d=g}ne({track:o,recomputeLabels:!0});return}if(e.altKey&&!e.shiftKey&&i.selected.size>0&&!R){e.preventDefault(),j();const t=e.deltaY>0?-1:1,o=p.tracks.find(r=>r.id===i.activeTrackId),n=o.notes.filter(r=>i.selected.has(r.id));if(n.length>0){const r=n.reduce((u,d)=>d.startTick<u.startTick?d:u),a=r.volume??D,l=ye(a+t);Wo(o,r,l)}ne({track:o,recomputeLabels:!0});return}if(e.shiftKey){e.preventDefault();const t=_[p.zoomLevel-1],o=p.timeSig.beatsPerBar*t,r=(Math.abs(e.deltaX)>Math.abs(e.deltaY)?e.deltaX:e.deltaY)>0?1:-1,a=xe(),l=Math.max(0,a-A.clientWidth);let u=Math.max(0,Math.min(l,i.scrollX+r*o));if(R){const d=G/S*t,s=A.clientWidth,c=Math.max(0,Math.min(l,Math.floor(d-s))),g=Math.max(0,Math.min(l,Math.floor(d)));u=Math.max(c,Math.min(g,u));let m=Qe(u);const h=Math.max(0,Math.min(l,Math.ceil(c/o)*o)),f=Math.max(0,Math.min(l,Math.floor(g/o)*o));h<=f?((m<h||m>f)&&(m=r>0?f:h),u=m):u=i.scrollX}i.scrollX=Qe(u),I();return}}function li(e){const t=e.deltaY>0?-1:1,o=Math.max(1,Math.min(9,p.zoomLevel+t));if(o===p.zoomLevel)return;const n=_[p.zoomLevel-1],r=A.getBoundingClientRect(),a=Math.max(0,Math.min(e.clientX-r.left,r.width)),l=i.scrollX+a,u=n*p.timeSig.beatsPerBar,s=Math.max(0,Math.round(l/u)*u)/n*S;p.zoomLevel=o;const c=_[o-1],g=s/S*c,m=xe(),h=Math.max(0,m-A.clientWidth);i.scrollX=Math.max(0,Math.min(h,g-a));const f=c*p.timeSig.beatsPerBar;i.scrollX=Math.max(0,Math.min(h,Math.floor(i.scrollX/f)*f)),ge=-1,z(),tt()}function q(){be();const e=Et;ao.innerHTML="",p.tracks.slice().sort((o,n)=>o.order-n.order).forEach((o,n)=>{o.color=e[n%e.length],(!o.instrument||!yt.includes(o.instrument))&&(o.instrument=_t);const r=document.createElement("div");r.dataset.trackId=String(o.id),r.dataset.order=String(o.order);const a=o.id===i.activeTrackId;r.className="track-card",a&&r.classList.add("is-active");const l=document.createElement("div");l.className="track-color",l.style.cssText=`
            background: ${o.color};
        `;const u=document.createElement("div");u.className="track-main";const d=document.createElement("div");d.className="track-row track-row--top";const s=document.createElement("input");s.value=o.name,s.setAttribute("data-i18n-title","tooltipTrackName"),s.title=b[y].tooltipTrackName,d.style.width="100%",s.classList.add("track-name-input"),fn(s,{size:"sm"}),s.addEventListener("change",()=>{K.push(p),o.name=s.value});const c=document.createElement("div");if(c.className="track-name",c.appendChild(s),d.appendChild(c),a){const h=document.createElement("div");h.className="track-reorder",h.style.marginLeft="auto",h.style.display="inline-flex",h.style.gap="6px";const f=document.createElement("button");f.type="button",f.textContent="▲",f.title="Move up",f.setAttribute("aria-label","Move track up"),f.style.width="24px",f.style.height="24px",f.style.fontSize="12px";const v=document.createElement("button");v.type="button",v.textContent="▼",v.title="Move down",v.setAttribute("aria-label","Move track down"),v.style.width="24px",v.style.height="24px",v.style.fontSize="12px";const k=p.tracks.length-1;f.disabled=o.order===0,v.disabled=o.order===k,f.addEventListener("click",L=>{L.stopPropagation(),ko(-1)}),v.addEventListener("click",L=>{L.stopPropagation(),ko(1)}),h.append(f,v),d.appendChild(h)}{const h=document.createElement("div");h.className="track-row track-row--middle",h.style.width="100%";const f=Mn(),v=hn({items:f,value:o.instrument,size:"sm",fullWidth:!0,onChange:T=>{K.push(p),o.instrument=T}});v.el.setAttribute("data-i18n-title","tooltipInstrument"),v.el.title=b[y].tooltipInstrument;const k=document.createElement("div");k.className="track-instrument",k.appendChild(v.el),h.appendChild(k);const L=document.createElement("div");L.className="track-row track-row--bottom";const M=ci(o),C=document.createElement("span");C.className="track-charcount";const B=o.optimizedMML?.length||0,V=b[y].charUnit;C.textContent=`${B}${V}`,C.setAttribute("data-i18n-title","tooltipCharCount"),C.title=b[y].tooltipCharCount,L.append(M,C),u.append(d,h,L)}const g=[s];{const h=u.querySelector(".dropdown");h instanceof HTMLElement&&g.push(h),u.querySelectorAll(".track-controls button").forEach(v=>g.push(v))}d.querySelectorAll(".track-reorder button").forEach(h=>g.push(h)),g.forEach(h=>{h.addEventListener("mousedown",f=>f.stopPropagation()),h.addEventListener("mouseup",f=>f.stopPropagation())}),r.addEventListener("click",h=>{const f=h.target.tagName;f==="INPUT"||f==="SELECT"||f==="BUTTON"||h.target.isContentEditable||i.activeTrackId!==o.id&&(i.activeTrackId=o.id,q(),z())}),r.append(l,u),ao.appendChild(r)})}function ko(e){const t=p.tracks.find(l=>l.id===i.activeTrackId);if(!t)return;const o=t.order,n=p.tracks.length-1,r=o+e;if(r<0||r>n)return;j();const a=p.tracks.find(l=>l.order===r);a&&(t.order=r,a.order=o),q(),F()}function Jo(){qe.innerHTML="",ve(),Ne.forEach(e=>{const t=de({label:String(e),size:"sm",variant:e===i.selectedLength?"primary":"secondary"});e===i.selectedLength&&t.classList.add("active"),t.setAttribute("data-i18n-title","tooltipLength"),e===64?t.title=(b[y].tooltipLength||"Length")+" - 0 (주의: 인게임에서 박자가 어긋날 수 있음)":t.title=b[y].tooltipLength,t.addEventListener("click",()=>{Kt(e)}),e===48&&(t.style.marginRight="12px"),qe.appendChild(t)}),H.textContent=te?b[y].extendedLessLabel||"더 적은 단위":b[y].extendedMoreLabel||"더 많은 단위",H.title=te?b[y].tooltipExtendedLess||"기본 단위로 돌아가기":b[y].tooltipExtendedMore||"더 많은 단위 사용 (64/128/5/7/11)",H.setAttribute("data-i18n",te?"extendedLessLabel":"extendedMoreLabel"),U(H,te?"tooltipExtendedLess":"tooltipExtendedMore",H.title),H.setAttribute("aria-label",H.title),H.onclick=di,qe.appendChild(H)}function di(){if(!te){const t="mml_editor_warn_extended_shown";let o=!1;try{o=localStorage.getItem(t)==="1"}catch{}if(!o){if(!window.confirm(b[y].confirmEnableExtendedUnits||"Enable more units to use 64/128/5/7/11; existing ticks will be converted. Continue?"))return;try{localStorage.setItem(t,"1")}catch{}}Mo(!0)}else Mo(!1)}function Mo(e){j();const n=(e?Lt:St)/(e?St:Lt);Rt(p,n),Co(e),p.tpqn=S,p.extendedUnitsEnabled=e;try{K.transformSnapshots?.(r=>Rt(r,n))}catch{}si(),Jo(),z()}function si(){if(!Ne.includes(i.selectedLength)){let e=Ne[0],t=Math.abs(e-i.selectedLength);for(const o of Ne){const n=Math.abs(o-i.selectedLength);n<t&&(e=o,t=n)}Kt(e)}}function Rt(e,t){if(!(!Number.isFinite(t)||t<=0)){for(const o of e.tracks)for(const n of o.notes)n.startTick=Math.round(n.startTick*t),n.durationTick=Math.max(1,Math.round(n.durationTick*t));e.maxEndTick=Math.round(e.maxEndTick*t)}}function Kt(e){if(!qe)return;i.selectedLength=e;const t=Array.from(qe.children);t.forEach(o=>o.classList.remove("active")),t.forEach(o=>{if(o instanceof HTMLButtonElement){const r=parseInt(o.textContent||"0",10)===e;r&&o.classList.add("active"),o.classList.remove("btn--primary","btn--secondary"),o.classList.add(r?"btn--primary":"btn--secondary")}}),z(),F()}function ci(e){const t=document.createElement("div");t.className="track-controls";const o=(a,l,u)=>{const d=document.createElement("button");return d.textContent=a,d.style.cssText=`
            width: 24px;
            height: 24px;
            font-size: 12px;
            font-weight: bold;
            border-radius: 4px;
            border: 1px solid #ccc;
            cursor: pointer;
            background-color: ${l?u:"#fff"};
            color: ${l?"#fff":"#000"};
        `,d},n=o("M",e.mute,"#f44336");n.setAttribute("data-i18n-title","tooltipMute"),n.title=b[y].tooltipMute,n.addEventListener("click",()=>{j(),e.mute=!e.mute,q()});const r=o("S",e.solo,"#ff9800");return r.setAttribute("data-i18n-title","tooltipSolo"),r.title=b[y].tooltipSolo,r.addEventListener("click",()=>{j(),e.solo=!e.solo,q()}),t.append(n,r),t}function wo(e){const t=Ne[e];typeof t=="number"&&Kt(t)}function ui(e){if(R){i.hover.noteId=null,i.hover.edge=null,$.style.cursor="not-allowed";return}const{x:t,y:o}=ft(e),n=_[p.zoomLevel-1],r=p.tracks.find(a=>a.id===i.activeTrackId);if(!i.drag&&!i.marquee.active){const a=Pt(t,o,r.notes,n,i.keyHeight);a?(i.hover.noteId=a.note.id,i.hover.edge=a.edge,$.style.cursor=a.edge==="center"?"move":"ew-resize"):(i.hover.noteId=null,i.hover.edge=null,$.style.cursor="default"),I();return}if(i.marquee.active){i.marquee.x1=t,i.marquee.y1=o;const a=e.ctrlKey||e.metaKey,l=e.shiftKey;i.marquee.mode=a?"toggle":l?"add":"replace";const u=_n(i.marquee.x0,i.marquee.y0,i.marquee.x1,i.marquee.y1,r.notes,n,i.keyHeight),d=new Set(i.selected);if(i.marquee.mode==="replace"){i.selected.clear();for(const s of u)i.selected.add(s.id)}else if(i.marquee.mode==="add")for(const s of u)i.selected.add(s.id);else{i.selected=d;for(const s of u)i.selected.has(s.id)?i.selected.delete(s.id):i.selected.add(s.id)}I()}}function pi(e){if(Me(),an(),R){e.preventDefault(),$.style.cursor="not-allowed";return}if(Ot(),e.button===1){e.preventDefault(),Se=!0,nt(e);return}if(e.button===2){e.preventDefault();const{x:g,y:m}=ft(e),h=_[p.zoomLevel-1],f=p.tracks.find(k=>k.id===i.activeTrackId),v=Pt(g,m,f.notes,h,i.keyHeight);if(v)i.selected.has(v.note.id)||(i.selected.clear(),i.selected.add(v.note.id),I()),Yn(v.note,e.clientX,e.clientY);else{const k=e.ctrlKey||e.metaKey,L=e.shiftKey;i.drag=null,i.ghost=null,i.marquee.active=!0,i.marquee.x0=g,i.marquee.y0=m,i.marquee.x1=g,i.marquee.y1=m,i.marquee.mode=k?"toggle":L?"add":"replace",I()}return}if(e.button!==0)return;const{x:t,y:o}=ft(e),n=_[p.zoomLevel-1],r=p.tracks.find(g=>g.id===i.activeTrackId),a=Pt(t,o,r.notes,n,i.keyHeight);if(!a){if(Ue){const M=e.ctrlKey||e.metaKey,C=e.shiftKey;i.drag=null,i.ghost=null,i.marquee.active=!0,i.marquee.x0=t,i.marquee.y0=o,i.marquee.x1=t,i.marquee.y1=o,i.marquee.mode=M?"toggle":C?"add":"replace",I();return}const g=we(i.selectedLength),m=t/n*S,h=rn(m,g),f=Ye(95-Math.floor(o/i.keyHeight)),v=we(i.selectedLength),k=crypto.randomUUID();i.drag={kind:"create",trackId:i.activeTrackId,noteId:k,startTick:h,durationTick:v,pitch:f},i.ghost={startTick:h,durationTick:v,pitch:f,color:re};const L=p.tracks.find(M=>M.id===i.activeTrackId);L&&ut(f,L.id,L.instrument,le),I();return}const l=a.note,u=e.ctrlKey||e.metaKey,d=i.selected.has(l.id);u?d||i.selected.add(l.id):d||(i.selected.clear(),i.selected.add(l.id));{const g=p.tracks.find(m=>m.id===i.activeTrackId);g&&ut(l.pitch,g.id,g.instrument,le)}const s=l.startTick,c=l.startTick+l.durationTick;if(a.edge==="center"){const g=Array.from(i.selected),m=p.tracks.find(f=>f.id===r.id).notes.filter(f=>i.selected.has(f.id)).map(f=>({id:f.id,startTick:f.startTick,pitch:f.pitch,durationTick:f.durationTick,volume:f.volume})),h=we(i.selectedLength);Ge=0,je=0,i.moveGroup={trackId:r.id,ids:g,base:m,mouseStartX:t,mouseStartY:o,grid:h},i.drag={kind:"move",trackId:r.id,noteId:l.id,startTick0:s,yPitch0:l.pitch,mouseStartX:t,mouseStartY:o},i.ghost={startTick:l.startTick,durationTick:l.durationTick,pitch:l.pitch,color:re},I();return}else a.edge==="left"?(i.drag={kind:"resize-left",trackId:r.id,noteId:l.id,startTick0:s,endTick0:c,mouseStartX:t},i.ghost={startTick:l.startTick,durationTick:l.durationTick,pitch:l.pitch,color:re}):a.edge==="right"&&(i.drag={kind:"resize-right",trackId:r.id,noteId:l.id,startTick0:s,endTick0:c,mouseStartX:t},i.ghost={startTick:l.startTick,durationTick:l.durationTick,pitch:l.pitch,color:re});I()}function gi(e){if(R)return;if(Se){nt(e);return}if(i.marquee.active||!i.drag)return;const{x:t,y:o}=ft(e),n=_[p.zoomLevel-1],r=we(i.selectedLength);if(i.drag.kind==="move"||i.drag.kind==="resize-left"||i.drag.kind==="resize-right"){if(i.drag.kind==="move"){const s=document.elementFromPoint(e.clientX,e.clientY)?.closest?.(".track-card");document.querySelectorAll(".track-card.drop-hover").forEach(c=>c.classList.remove("drop-hover")),s&&parseInt(s.dataset.trackId||"-1",10)!==i.drag.trackId&&s.classList.add("drop-hover")}const a=p.tracks.find(d=>i.drag!=null&&d.id===i.drag.trackId),l=a.notes.findIndex(d=>i.drag!=null&&d.id===i.drag.noteId);if(l<0)return;const u=a.notes[l];if(i.drag.kind==="move"){const d=i.moveGroup;if(!d)return;const s=(t-d.mouseStartX)/n,c=Math.floor((d.mouseStartY-o)/i.keyHeight),g=s*S,m=Math.round(g/d.grid)*d.grid;Ge=m,je=c;const h=Ye(i.drag.yPitch0+c),f=p.tracks.find(M=>M.id===i.activeTrackId);f&&ut(h,f.id,f.instrument,le),I();const v=n,k=i.scrollX,L=window.devicePixelRatio||1;ie.save(),ie.setTransform(L,0,0,L,0,0),ie.globalAlpha=.7,ie.fillStyle=re;for(const M of d.base){const C=Math.max(0,M.startTick+m),B=Math.round(C/S*v)-Math.floor(k)+.5,V=Math.max(1,Math.round(M.durationTick/S*v)),x=(95-Ye(M.pitch+c))*i.keyHeight+.5,w=i.keyHeight-1;ie.fillRect(B,x,V,w)}ie.globalAlpha=1,ie.restore();return}if(i.drag.kind==="resize-left"){const d=(t-i.drag.mouseStartX)/n;let s=i.drag.startTick0+d*S,c=Math.max(0,Math.floor(s/r)*r);c=Math.min(c,i.drag.endTick0-r);const g=i.drag.endTick0-c;i.ghost={startTick:c,durationTick:g,pitch:u.pitch,color:re};const m=i.drag.endTick0-i.drag.startTick0,h=Math.max(0,m-g),f=we(32),v=p.tracks.find(M=>M.id===i.drag.trackId),k=new Set(i.selected),L=[];if(h>0)for(const M of v.notes){if(M.id===i.drag.noteId||!k.has(M.id))continue;const C=Math.max(f,M.durationTick-h);L.push({startTick:M.startTick,durationTick:C,pitch:M.pitch,color:re})}i.ghostGroup=L.length?L:null,I();return}if(i.drag.kind==="resize-right"){const d=(t-i.drag.mouseStartX)/n;let s=i.drag.endTick0+d*S,c=Math.max(i.drag.startTick0+r,Math.ceil(s/r)*r);const g=p.tracks.find(B=>B.id===i.drag.trackId),m=i.drag.startTick0,h=g.notes.filter(B=>B.startTick>m).sort((B,V)=>B.startTick-V.startTick)[0];h&&(c=Math.min(c,h.startTick));const f=c-i.drag.startTick0;i.ghost={startTick:i.drag.startTick0,durationTick:f,pitch:u.pitch,color:re};const v=i.drag.endTick0-i.drag.startTick0,k=Math.max(0,f-v),L=p.tracks.find(B=>B.id===i.drag.trackId),M=new Set(i.selected),C=[];if(k>0)for(const B of L.notes){if(B.id===i.drag.noteId||!M.has(B.id))continue;const V=L.notes.filter(E=>E.startTick>B.startTick).sort((E,N)=>E.startTick-N.startTick)[0];let T=Number.POSITIVE_INFINITY;V&&(T=Math.max(0,V.startTick-(B.startTick+B.durationTick)));const x=Math.max(0,Math.min(k,T)),w=B.durationTick+x;C.push({startTick:B.startTick,durationTick:w,pitch:B.pitch,color:re})}i.ghostGroup=C.length?C:null,I();return}}if(i.drag.kind==="create"){const a=i.drag.startTick,l=(t-a/S*n)/n,u=a+Math.max(r,Math.round(l*S)),s=Math.max(a+r,Math.ceil(u/r)*r)-a,c=Ye(95-Math.floor(o/i.keyHeight));i.ghost={startTick:a,durationTick:s,pitch:c,color:re};const g=p.tracks.find(m=>m.id===i.activeTrackId);g&&ut(c,g.id,g.instrument,le),I()}}function mi(){if(R)return;if(Se){Se=!1;return}le.sampler&&le.pitch!==null&&(cn(le.sampler,le.pitch),le.pitch=null,le.sampler=null);const e=document.activeElement;if(e&&(e.tagName==="INPUT"||e.tagName==="SELECT"||e.isContentEditable))return;if(i.marquee.active){i.marquee.active=!1,I();return}if(!i.drag)return;if(i.drag.kind==="move"&&i.moveGroup){const l=document.elementFromPoint(window.lastPointerX??0,window.lastPointerY??0)?.closest?.(".track-card");if(l){const s=parseInt(l.dataset.trackId||"-1",10),c=i.moveGroup.trackId;if(!Number.isNaN(s)&&s>0&&s!==c){const g=p.tracks.find(v=>v.id===c),m=p.tracks.find(v=>v.id===s),h=new Set(i.moveGroup.ids),f=g.notes.filter(v=>h.has(v.id));if(f.length>0){const v=Math.min(...f.map(M=>M.startTick)),k=Math.max(...f.map(M=>M.startTick+M.durationTick)),L=m.notes.filter(M=>M.startTick<k&&M.startTick+M.durationTick>v);K.push(p),g.notes=g.notes.filter(M=>!h.has(M.id)).concat(L),m.notes=m.notes.filter(M=>!L.includes(M)).concat(f),ht(g.notes),ht(m.notes),i.selected.clear();for(const M of f)i.selected.add(M.id);i.moveGroup=null,i.drag=null,i.ghost=null,ne({track:g}),ne({track:m}),q();return}}}const u=i.moveGroup;if(Ge===0&&je===0){i.moveGroup=null,i.drag=null,i.ghost=null;return}j();const d=p.tracks.find(s=>s.id===u.trackId);d.notes=d.notes.filter(s=>!u.ids.includes(s.id)),Ct(async()=>{const{insertNoteWithOverlap:s,ensureBars:c}=await import("./timeline-U0IUL4mT.js").then(g=>g.r);return{insertNoteWithOverlap:s,ensureBars:c}},[],import.meta.url).then(({insertNoteWithOverlap:s,ensureBars:c})=>{i.selected.clear();for(const g of u.base){const m={id:g.id,startTick:Math.max(0,g.startTick+Ge),durationTick:g.durationTick,pitch:Ye(g.pitch+je),velocity:100,volume:g.volume??D};s(p,u.trackId,m),c(p,m.startTick+m.durationTick),i.selected.add(m.id)}i.moveGroup=null,i.drag=null,i.ghost=null,Ge=0,je=0,ne({track:d}),F()});return}if(!i.ghost){i.drag=null,document.querySelectorAll(".track-card.drop-hover").forEach(l=>l.classList.remove("drop-hover"));return}const t=i.ghost,o=i.drag.trackId,n=p.tracks.find(l=>l.id===o);let r=D;if(n){const l=et(n);let u=D;for(let d=0;d<l.length;d++){const s=l[d];if(s.startTick>=t.startTick)break;const c=s.volume??D;Oo(l,d,i.volumeLabels),u=c}r=u}const a={id:i.drag.noteId,startTick:t.startTick,durationTick:t.durationTick,pitch:t.pitch,velocity:100,volume:r};K.push(p),Ct(async()=>{const{insertNoteWithOverlap:l,ensureBars:u}=await import("./timeline-U0IUL4mT.js").then(d=>d.r);return{insertNoteWithOverlap:l,ensureBars:u}},[],import.meta.url).then(({insertNoteWithOverlap:l,ensureBars:u})=>{const d=p.tracks.find(s=>s.id===o);if(i.drag.kind==="resize-left"||i.drag.kind==="resize-right"){const s=d.notes.findIndex(f=>f.id===i.drag.noteId);s>=0&&d.notes.splice(s,1);const c=i.drag.endTick0-i.drag.startTick0,g=t.durationTick,m=Math.max(0,c-g);if(m>0){const f=we(32),v=new Set(i.selected);for(const k of d.notes)k.id!==i.drag.noteId&&v.has(k.id)&&(k.durationTick=Math.max(f,k.durationTick-m))}const h=Math.max(0,g-c);if(h>0){const f=new Set(i.selected);for(const v of d.notes){if(v.id===i.drag.noteId||!f.has(v.id))continue;const k=d.notes.filter(C=>C.startTick>v.startTick).sort((C,B)=>C.startTick-B.startTick)[0];let L=Number.POSITIVE_INFINITY;k&&(L=Math.max(0,k.startTick-(v.startTick+v.durationTick)));const M=Math.max(0,Math.min(h,L));M>0&&(v.durationTick+=M,u(p,v.startTick+v.durationTick))}}}l(p,o,a),u(p,a.startTick+a.durationTick),i.drag=null,i.ghost=null,i.ghostGroup=null,document.querySelectorAll(".track-card.drop-hover").forEach(s=>s.classList.remove("drop-hover")),ne({track:d,recomputeLabels:!0}),F()})}function I(){hi(),i.isAltDown=Ht;const e=_[p.zoomLevel-1],t=G/S*e,o=i.scrollX,n=A.clientWidth,r=o+n;A.clientHeight;const a=p.timeSig.beatsPerBar*e,l=(Le||p.timeSig.beatsPerBar)*e,u=Math.floor(o/a),d=o-u*a,s=Math.floor(o/l),c=o-s*l;$.style.left=`${-d}px`,W&&(W.style.left=`${-c}px`),W&&mt&&Ro(mt,W,p,i,Le),Cn(ie,p,i,u*a,n+a);const g=t-o;if(R)if(fe==="area"){const f=_[p.zoomLevel-1],v=Le||p.timeSig.beatsPerBar,k=f*v,M=Math.floor(t/k)*k-o;Hn(ie,$,M,k)}else io(ie,$,g);else io(ie,$,g);zn(_o,Q,i.keyHeight);const h=-A.scrollTop+i.keyHeight;if(Q.style.transform=`translateY(${h}px)`,fi(),R&&t>=r){const f=_[p.zoomLevel-1],v=p.timeSig.beatsPerBar*f,k=G/S*f,L=Math.floor(k/v)*v,M=xe(),C=Math.max(0,M-A.clientWidth);i.scrollX=Math.max(0,Math.min(C,L))}Re(),Zt()}function hi(){const e=window.devicePixelRatio||1,t=_[p.zoomLevel-1],n=p.timeSig.beatsPerBar*t,r=(A.clientWidth||800)+n,a=84*i.keyHeight,l=a;$.style.width!==`${r}px`&&($.style.width=`${r}px`),$.style.height!==`${l}px`&&($.style.height=`${l}px`);const u=Math.max(1,Math.floor(r*e)),d=Math.max(1,Math.floor(l*e));if(($.width!==u||$.height!==d)&&($.width=u,$.height=d),W&&mt){const f=(A.clientWidth||800)+n,v=a;W.style.width!==`${f}px`&&(W.style.width=`${f}px`),W.style.height!==`${v}px`&&(W.style.height=`${v}px`);const k=Math.max(1,Math.floor(f*e)),L=Math.max(1,Math.floor(v*e)),M=W.width!==k,C=W.height!==L;(M||C)&&(W.width=k,W.height=L),(M||C||ge!==p.zoomLevel)&&(Ro(mt,W,p,i,Le),ge=p.zoomLevel)}const s=84*i.keyHeight;(Q.width!==Math.floor(48*e)||Q.height!==Math.floor(s*e))&&(Q.width=Math.floor(48*e),Q.height=Math.floor(s*e),e!==1&&_o.setTransform(e,0,0,e,0,0)),Q.style.width!=="48px"&&(Q.style.width="48px");const c=`${s}px`;Q.style.height!==c&&(Q.style.height=c),Ae.style.height!==i.keyHeight+"px"&&(Ae.style.height=i.keyHeight+"px");const g=Ae.clientWidth||A.clientWidth||800,m=Math.max(1,Math.floor(g*e)),h=Math.max(1,Math.floor(i.keyHeight*e));(X.width!==m||X.height!==h)&&(X.width=m,X.height=h,e!==1&&Dt.setTransform(e,0,0,e,0,0))}function tt(){he&&he.textContent!==String(p.bpm)&&(he.textContent=String(p.bpm))}function $t(){R=!1,pt().stop(),Po(),tt(),Re(),Zt()}function Qo(){R=!1,pt().stop(),pt().position=0,Po(),G=Zn,tt(),Re(),I()}function fi(){const e=_[p.zoomLevel-1],t=Le||p.timeSig.beatsPerBar,o=window.devicePixelRatio||1,n=i.keyHeight;Ae.style.height!==n+"px"&&(Ae.style.height=n+"px");const r=Ae.clientWidth||A.clientWidth||800,a=Math.max(1,Math.floor(r*o)),l=Math.max(1,Math.floor(n*o));X.width!==a&&(X.width=a),X.height!==l&&(X.height=l),o!==1&&Dt.setTransform(o,0,0,o,0,0);const u=i.scrollX;Vn(Dt,X,u,e,t)}function z(){tt(),ge=-1,I()}function en(){if(!R)return;const e=performance.now(),t=Math.max(0,e-At);At=e;const o=S*(p.bpm/60)/1e3;G+=t*o;const n=ot();if(G>=n){Qo();return}I(),requestAnimationFrame(en)}function ot(){let e=0;for(const t of p.tracks)for(const o of t.notes){const n=o.startTick+o.durationTick;n>e&&(e=n)}return e}function Re(){if(!Xe)return;const e=ot(),t=Math.max(0,Math.floor(G));if(gt==="barbeat"){const o=p.timeSig.beatsPerBar,n=Lo(t,p.bpm,o),r=Lo(e,p.bpm,o),a=(n.beatInBar+1).toFixed(1).replace(/\.0$/,""),l=(r.beatInBar+1).toFixed(1).replace(/\.0$/,"");Xe.textContent=`${n.bar}.${a} / ${r.bar}.${l}`;return}if(gt==="time"){const o=So(t,p.bpm),n=So(e,p.bpm);Xe.textContent=`${o} / ${n}`;return}}function Lo(e,t,o){const n=e/S,r=Math.floor(n/o)+1,a=n%o;return{bar:r,beatInBar:a}}function So(e,t){const o=e/S*(60/t),n=Math.floor(o/60),r=Math.floor(o%60),a=Math.floor((o-Math.floor(o))*1e3),l=String(n).padStart(2,"0"),u=String(r).padStart(2,"0"),d=String(a).padStart(3,"0");return`${l}:${u}.${d}`}function yi(e){e.button!==2&&(R||(Se=!0,nt(e)))}function bi(e){Se&&nt(e)}function vi(){Se=!1}function nt(e){const{x:t}=oi(e),o=_[p.zoomLevel-1],n=t/o*S,r=we(i.selectedLength);G=Math.max(0,Math.floor(n/r)*r),R&&(R=!1),I()}function Zt(){const e=xe(),t=e-A.clientWidth;if(t<=1){He.style.display="none";return}He.style.display="block";const o=Math.max(20,A.clientWidth/e*He.clientWidth);Ke.style.width=`${o}px`;const r=i.scrollX/t*(He.clientWidth-o);Ke.style.left=`${r}px`}function xe(){const e=_[p.zoomLevel-1],t=Math.ceil(ot()/S);return Math.max(A.clientWidth,Math.ceil(t*e)+A.clientWidth)}function Qe(e){const t=_[p.zoomLevel-1],o=p.timeSig.beatsPerBar*t,n=Math.round(e/o)*o;return Math.max(0,n)}function xi(e){const t=_[p.zoomLevel-1],o=p.timeSig.beatsPerBar*t,n=xe(),r=Math.max(0,n-A.clientWidth),a=Math.max(0,Math.min(r,i.scrollX+e*o));i.scrollX=Qe(a),Zt(),I()}function tn(){const e=b[y];if(Pe&&(Pe.title=e.tooltipRulerPrevBar||"Prev bar",Pe.setAttribute("data-i18n-title","tooltipRulerPrevBar"),Pe.setAttribute("aria-label",Pe.title)),De&&(De.title=e.tooltipRulerNextBar||"Next bar",De.setAttribute("data-i18n-title","tooltipRulerNextBar"),De.setAttribute("aria-label",De.title)),H&&(H.textContent=te?e.extendedLessLabel||"더 적은 단위":e.extendedMoreLabel||"더 많은 단위",H.title=te?e.tooltipExtendedLess||"기본 단위로 돌아가기":e.tooltipExtendedMore||"더 많은 단위 사용 (64/128/5/7/11)",H.setAttribute("data-i18n",te?"extendedLessLabel":"extendedMoreLabel"),H.setAttribute("data-i18n-title",te?"tooltipExtendedLess":"tooltipExtendedMore"),H.setAttribute("aria-label",H.title)),ee){const t=e.tooltipDisplayTimeSig||"Display time signature (n/4)";ee.title=t,ee.setAttribute("data-i18n-title","tooltipDisplayTimeSig"),ee.setAttribute("aria-label",t)}}oe(H,"ghost","sm");if(ee){const e=r=>Math.max(1,Math.min(16,Math.floor(r)));let t=null;try{const r=localStorage.getItem(ro);if(r!=null){const a=Number(r);Number.isFinite(a)&&(t=e(a))}}catch{}const o=t??e(Number(p.timeSig?.beatsPerBar)||4);Le=o,ee.value!==String(o)&&(ee.value=String(o));const n=()=>{const r=Number(ee.value),a=Number.isFinite(r)?e(r):o;Le=a,ee.value!==String(a)&&(ee.value=String(a));try{localStorage.setItem(ro,String(a))}catch{}ge=-1,z()};ee.addEventListener("change",n),ee.addEventListener("input",n)}window.addEventListener("resize",()=>{Ft(),ge=-1,z()});setTimeout(Ft,0);ve();Bo();Bt&&U(Bt,"tooltipPlay",b[y].tooltipPlay);It&&U(It,"tooltipPause",b[y].tooltipPause);ue&&(ue.textContent=fe==="area"?b[y].playheadAreaLabel:b[y].playheadLineLabel,U(ue,"tooltipPlayheadToggle",b[y].tooltipPlayheadToggle));Nt&&U(Nt,"tooltipStop",b[y].tooltipStop);Be&&(oe(Be,"secondary","md"),Be.setAttribute("data-i18n","edit"),U(Be,"tooltipEditMML",b[y].tooltipEditMML));lt&&(oe(lt,"secondary","md"),U(lt,"tooltipConvert",b[y].tooltipConvert));rt&&(oe(rt,"secondary","md"),U(rt,"tooltipPaste",b[y].tooltipPaste));Ze&&(oe(Ze,"ghost","md"),U(Ze,"tooltipGuide",b[y].tooltipGuide));if(ae){const e=(()=>{try{return localStorage.getItem(zo)}catch{return null}})(),t=Math.max(16,Math.min(32,e?parseInt(e,10):i.keyHeight));i.keyHeight=t,ae.value=String(t),Ie&&(Ie.textContent=String(t)),ae.min="16",ae.max="32",ae.step="1",U(ae,"tooltipKeyHeight",b[y].tooltipKeyHeight||"노트 높이 (16-32)")}dt&&(oe(dt,"ghost","sm"),U(dt,"tooltipLangKo",b[y].tooltipLangKo));st&&(oe(st,"ghost","sm"),U(st,"tooltipLangJa",b[y].tooltipLangJa));ct&&(oe(ct,"ghost","sm"),U(ct,"tooltipLangEn",b[y].tooltipLangEn));$&&($.setAttribute("data-i18n-title","tooltipPianoRoll"),$.title=b[y].tooltipPianoRoll);X&&(X.setAttribute("data-i18n-title","tooltipRuler"),X.title=b[y].tooltipRuler);ei();z();be();Be?Be.onclick=()=>{const e=p.tracks.find(o=>o.id===i.activeTrackId);if(!e)return;let t=e.optimizedMML?.trim?.()||e.mmlString?.trim?.()||"";if(t=t.replace(/[\r\n]+/g,""),!t)try{t=(zt(e.notes??[])||"").trim().replace(/[\r\n]+/g,"")}catch{}Ln(e,o=>{Zo(e,o),p.maxEndTick=ot(),be(),q()},t)}:p=Eo();tn();H.id="btnToggleExtended";H.style.marginLeft="8px";H.textContent=te?b[y].extendedLessLabel||"더 적은 단위":b[y].extendedMoreLabel||"더 많은 단위";Vt.onmessage=e=>{const{trackId:t,optimizedMML:o,originalBody:n}=e.data,r=p.tracks.find(a=>a.id===t);r&&(r.optimizedMML=o,r.originalBody=n??"",q(),be(),$e())};Fn?.addEventListener("click",()=>{Fo(S)});Xn?.addEventListener("click",()=>{const e=S*qo();Fo(e)});qn?.addEventListener("click",()=>{Xo(S)});Kn?.addEventListener("click",()=>{const e=S*qo();Xo(e)});(function(){Te&&(Te.textContent=b[y].trackMMLLabel||"트랙MML",Te.setAttribute("data-i18n","trackMMLLabel"),Te.setAttribute("data-i18n-title","tooltipEditMML"),Te.title=b[y].tooltipEditMML)})();i.moveGroup=null;(function(){const t=(o,n)=>{if(!o)return;let r=null,a=null;const l=()=>{r!==null&&(window.clearTimeout(r),r=null),a!==null&&(window.clearInterval(a),a=null)},u=()=>xi(n);o.addEventListener("pointerdown",d=>{d.preventDefault(),Me(),u(),r=window.setTimeout(()=>{a=window.setInterval(u,120)},350),d.target.setPointerCapture?.(d.pointerId)},{passive:!1}),window.addEventListener("pointerup",l),window.addEventListener("pointercancel",l),o.addEventListener("pointerleave",l)};t(Pe,-1),t(De,1)})();(function(){const t="2025-08-27-load-change",o="mml_editor_whatsnew_shown_"+t;let n=!1;try{n=localStorage.getItem(o)==="1"}catch{}n||setTimeout(()=>On(t),0)})();async function Ti(){try{K.push(p);const e=await navigator.clipboard.readText();if(!e.trim().startsWith("MML@")){alert(b[y].invalid_mml_format||"MML 형식이 아닙니다.");return}let t=e.trim().substring(4);t=t.replace(/\r?\n/g,"").replace(/;+$/g,"");const o=t.split(",").map(r=>r.replace(/;+$/g,"").trim());if(o.length>6){alert("트랙은 최대 6개까지만 지원합니다.");return}const n=[];for(let r=0;r<p.tracks.length;r++){const a=o[r]?o[r]:"",l=p.tracks[r],u=l.notes?.length||0;try{if(a&&a.length>0)try{l.optimizedMML=Do(a)||a}catch{l.optimizedMML=a}else l.optimizedMML="";Zo(l,a),(l.notes?.length||0)>u&&n.push(l)}catch{alert(b[y].invalid_mml_format||"MML 형식이 아닙니다.");return}}p.maxEndTick=ot(),n.length>0&&Wt(n),q(),$e(),F()}catch{}}async function on(){if(R)return;R=!0,await ln();const e=Qn();await dn(e,p.bpm),pt().position=sn(G,p.bpm),At=performance.now();{const t=_[p.zoomLevel-1],o=p.timeSig.beatsPerBar*t,n=G/S*t,r=Math.floor(n/o)*o,a=xe(),l=Math.max(0,a-A.clientWidth);i.scrollX=Math.max(0,Math.min(l,r))}tt?.(),Re?.(),en()}const Gt=()=>{const e=window.visualViewport?window.visualViewport.height:window.innerHeight;document.documentElement.style.setProperty("--app-100dvh",e+"px")};Gt();window.addEventListener("resize",Gt);window.visualViewport?.addEventListener("resize",Gt);
