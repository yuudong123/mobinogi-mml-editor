import{e as Gt,c as Mt}from"./button-WIurEURm.js";import{F as qt,G,J as q,U as jt,t as st,c as it}from"./languages-BQGPFjgN.js";class Z extends qt{static META=81;static INITIAL_TEMPO=120;tempo;isFirst;constructor(t,e,n=!1){if(super(e),t<=0||t>1e3)throw new Error("tempo "+t);this.tempo=t,this.isFirst=n}getTempo(){return this.tempo}setTempo(t){this.tempo=t}toString(){return`${this.getTickOffset()}T${this.tempo}`}static fromString(t){if(!t||t.length===0)return null;const e=t.split("T");return e.length!==2?null:new Z(parseInt(e[1],10),parseInt(e[0],10))}toMMLString(){return"t"+this.tempo}appendToListElement(t){let e=0;const n=this.getTickOffset();for(;e<t.length;e++){const s=t[e];if(s.getTickOffset()===n){t.splice(e,1);break}else if(s.getTickOffset()>n)break}(e===0||t[e-1].getTempo()!==this.tempo||!this.isFirst)&&t.splice(e,0,this)}static mergeTempoList(t,e){if(t!==e)for(const n of t)n.appendToListElement(e);return e}static searchOnTick(t,e){let n=Z.INITIAL_TEMPO;for(const s of t){if(e<s.getTickOffset())break;n=s.getTempo()}return n}static searchEqualsTick(t,e){for(const n of t){if(n.getTickOffset()===e)return!0;if(n.getTickOffset()>e)break}return!1}static getMaxTempoEvent(t){const e=new Z(Z.INITIAL_TEMPO,0);for(const n of t){const s=n.getTempo();e.getTempo()<s&&e.setTempo(s)}return e}getMetaData(){const t=Math.trunc(6e7/this.tempo),e=new Uint8Array(3);return e[0]=t>>16&255,e[1]=t>>8&255,e[2]=t&255,e}clone(){return new Z(this.tempo,this.getTickOffset(),this.isFirst)}equals(t){return t instanceof Z?this.tempo===t.tempo&&super.equals(t):!1}}class Ut{index=0;tokens=[];currentOct=4;currentVelocity=G.INIT_VOL;tickOffset;pendingTie=!1;lastNote=null;defaultLengthBase=4;defaultLengthDotted=!1;constructor(t,e){this.tickOffset=e|0;const n=(t||"").toLowerCase().replace(/\s+/g,"").replace(/^mml@/,""),s=/(t\d{1,4})|(o\d)|(l\d+\.)|(l\d+)|(>>+|>+|<<+|<+)|([a-gA-G][+#-]?\d+\.)|([a-gA-G][+#-]?\d*\.)|([a-gA-G][+#-]?\d*)|(r\d+\.)|(r\d*\.)|(r\d*)|(n\d+)|(v\d{1,3})|(&)|([^])/g;let i;for(;i=s.exec(n);){const o=i[0];o.trim().length!==0&&this.tokens.push(o)}}hasNext(){return this.index<this.tokens.length}next(){if(!this.hasNext())return null;const t=this.tokens[this.index++];if(t==="&")return this.pendingTie=!0,null;const e=t.charAt(0).toLowerCase();if(e==="t"){const n=parseInt(t.substring(1),10);return Number.isFinite(n)&&n>0?new Z(n,this.tickOffset,this.tickOffset===0):null}if(e==="o"){const n=parseInt(t.substring(1),10);return Number.isFinite(n)&&(this.currentOct=Math.max(0,Math.min(9,n))),null}if(e==="l"){const n=/^l(\d+)(\.)?$/.exec(t);if(n){const s=parseInt(n[1],10);Number.isFinite(s)&&s>0&&(this.defaultLengthBase=s,this.defaultLengthDotted=!!n[2])}return null}if(e===">"||e==="<"){for(const n of t)n===">"?this.currentOct=Math.min(9,this.currentOct+1):n==="<"&&(this.currentOct=Math.max(0,this.currentOct-1));return null}if(e==="v"){const n=parseInt(t.substring(1),10);return Number.isFinite(n)&&(this.currentVelocity=Math.max(0,Math.min(15,n))),null}if(e==="n"){const n=parseInt(t.substring(1),10);if(Number.isFinite(n)){const s=this.defaultLengthBase+(this.defaultLengthDotted?".":""),i=this.parseLength(s)||q.getTick("4"),o=this.currentVelocity;if(this.pendingTie&&this.lastNote&&this.lastNote.getNote()===n&&this.lastNote.getVelocity()===o)return this.lastNote.setTick(this.lastNote.getTick()+i),this.tickOffset+=i,this.pendingTie=!1,null;const r=new G(n,i,this.tickOffset,o);return this.lastNote=r,this.pendingTie=!1,this.tickOffset+=i,r}return null}if(e==="r"){let n=t.substring(1);n==="."?n=this.defaultLengthBase+".":n===""&&(n=this.defaultLengthBase+(this.defaultLengthDotted?".":""));const s=this.parseLength(n)||this.parseLength(this.defaultLengthBase+(this.defaultLengthDotted?".":""))||q.getTick("4");return this.tickOffset+=s,null}if(e>="a"&&e<="g"){const n=/^([a-gA-G][+#-]?)(\d*\.?)*$/.exec(t);if(n){const s=n[1];let o=t.substring(s.length);o==="."?o=this.defaultLengthBase+".":o===""&&(o=this.defaultLengthBase+(this.defaultLengthDotted?".":""));const r=this.calcPitch(s,this.currentOct),c=this.defaultLengthBase+(this.defaultLengthDotted?".":""),a=this.parseLength(o)||this.parseLength(c)||q.getTick("4"),l=this.currentVelocity;if(this.pendingTie&&this.lastNote&&this.lastNote.getNote()===r&&this.lastNote.getVelocity()===l)return this.lastNote.setTick(this.lastNote.getTick()+a),this.tickOffset+=a,this.pendingTie=!1,null;const h=new G(r,a,this.tickOffset,l);return this.lastNote=h,this.pendingTie=!1,this.tickOffset+=a,h}}return null}parseLength(t){if(!t)return null;const e=/^(\d+)(\.)?$/.exec(t);if(!e)return null;const n=parseInt(e[1],10);if(!Number.isFinite(n)||n<=0)return null;const s=q.getTick("4");let i=Math.round(4/n*s);return e[2]&&(i+=i/2),Math.round(i)}calcPitch(t,e){const n={c:0,d:2,e:4,f:5,g:7,a:9,b:11},s=t.charAt(0).toLowerCase();let i=n[s]??0;const o=t.charAt(1);return o==="+"||o==="#"?i+=1:o==="-"&&(i-=1),e*12+i}}class J extends Error{static Entry=class{event;exception;constructor(e,n){this.event=e,this.exception=n}getNote(){return this.event}getException(){return this.exception}};errList;constructor(t){super(t[0].exception.message),this.errList=t,Object.setPrototypeOf(this,J.prototype)}getErr(){return this.errList}get message(){return this.errList[0].exception.message}getLocalizedMessage(){return this.errList[0].exception.message}}class ht extends q{static REST="r";static ALT="c";static DIV=4294967295;replaced=!1;lastReplaced=!1;prevNoteEvent;constructor(t,e=null){super(ht.REST,t,!1),this.prevNoteEvent=e}calcDivTick(t){return Math.ceil(ht.DIV*t/6e7)}vZero(t){for(let e=t.length-1;e>=0;e--){const n=t[e].lastIndexOf(ht.REST);if(n>=0){t[e]=t[e].substring(0,n)+ht.ALT+t[e].substring(n+1),this.prevNoteEvent&&this.prevNoteEvent.getVelocity()>0&&(t[e]=t[e].substring(0,n)+"v0"+t[e].substring(n),this.prevNoteEvent.setVelocity(0));return}}}getPrevNoteEvent(){return this.prevNoteEvent}isReplaced(){return this.replaced}isLastReplaced(){return this.lastReplaced}toMMLTextWithMotionFix(t){let e=this.tick,n="",s=0;const i=this.calcDivTick(t),o=q.getTick("1."),r=q.getTick("1");for(;e>r*2;){if(n+=this.mmlNotePart("1."),s+=o,s>=i){s=o;const c=[n];this.vZero(c),n=c[0],this.replaced=!0}e-=o}if(s+=e,n=this.makeMMLText(n,e),s>=i){const c=[n];this.vZero(c),n=c[0],this.replaced=this.lastReplaced=!0}return n}}class Y{static globalVZeroTempo=!0;static setMMLVZeroTempo(t){this.globalVZeroTempo=t}eventList;startOffset;initOct;errList=[];percussionMotionFix;currentTempo=Z.INITIAL_TEMPO;static INIT_OCT=4;constructor(t,e,n,s){this.eventList=t,this.startOffset=e,this.initOct=n,this.percussionMotionFix=s}static create(t,e=0,n=Y.INIT_OCT,s=!1){return new Y(t,e,n,s)}makeTempoChar(t,e,n){const s=[!0,!0,!0,!0,!0,!0,!0];if(t)for(const i of[e.getTickOffset(),e.getEndTick()])for(const o of t){const r=o.searchOnTickOffset(i);if(r&&r.getOctave()===n){const a=r.toMMLString().toLowerCase().charAt(0).charCodeAt(0)-97;a>=0&&a<s.length&&(s[a]=!1)}}for(let i=0;i<s.length;i++){const o=(i+2)%s.length;if(s[o])return String.fromCharCode(97+o)}return"c"}insertRestNoteEvent(t,e,n){const s=n.getTickOffset()-e.getEndTick(),i=e.clone(),o=new ht(s,i);if(s>0)try{t.push(this.percussionMotionFix?o.toMMLTextWithMotionFix(this.currentTempo):o.toMMLText()),i.setTick(e.getTick()+s)}catch(r){this.errList.push(new J.Entry(e,r))}return o}insertTempoMML(t,e,n,s,i){let o=e.clone();if(e.getEndTick()<n.getTickOffset()){const r=e.getOctave(),c=this.insertRestNoteEvent(t,e,n);if(o=c.getPrevNoteEvent()??o,s&&Y.globalVZeroTempo&&!c.isLastReplaced()){const a=t.lastIndexOf("r");if(a>=0){t[a]="c";const l=new rt(t.join("")).getLastNote();try{const h=this.makeTempoChar(i??null,l,r),d=e.getVelocity()!==0?"v0"+h:""+h;t[a]=d}catch(h){this.errList.push(new J.Entry(l,h))}o.setVelocity(0)}}}return t.push(n.toMMLString()),o}insertNoteWithTempo(t,e,n,s,i,o){const r=s.clone();for(;i&&e.length>0&&r.getTickOffset()<e[0].getTickOffset()&&e[0].getTickOffset()<r.getEndTick();){const c=e[0].getTickOffset(),a=c-r.getTickOffset();try{const h=q.minimumTick(),d=(()=>{try{return new q("c",a).toMMLText(),!0}catch{return!1}})();if(a<h||!d){console.warn("[builder tempo split skipped]",{segLen:a,minTick:h,anchorTick:c,noteStart:s.getTickOffset(),noteEnd:s.getEndTick()});break}}catch{}try{a<=32&&console.warn("[builder tempo split small segment]",{noteStart:s.getTickOffset(),noteEnd:s.getEndTick(),anchorTick:c,segLen:a,remainingBefore:r.getTick(),workingStart:r.getTickOffset(),tempo:e[0].getTempo()})}catch{}const l=new G(r.getNote(),a,r.getTickOffset(),r.getVelocity());try{n=this.insertRestNoteEvent(t,n,l).getPrevNoteEvent()??n,t.push(l.toMMLStringWithPrev(n))}catch(h){this.errList.push(new J.Entry(l,h))}i&&t.push(e[0].toMMLString()),this.currentTempo=e[0].getTempo(),e.shift(),r.setTick(r.getTick()-a),r.setTickOffset(r.getTickOffset()+a),n=l,i&&r.getTick()>0&&t.push("&")}if(r.getTick()>0)try{n=this.insertRestNoteEvent(t,n,r).getPrevNoteEvent()??n,t.push(r.toMMLStringWithPrev(n))}catch(c){this.errList.push(new J.Entry(r,c))}}makeLocalTempoList(t){const e=[...this.eventList.getGlobalTempoList()];for(;e.length>1&&e[1].getTickOffset()<=this.startOffset;)this.currentTempo=e[0].getTempo(),e.shift();return e}totalTickRelationPart(t){let e=this.eventList.getTickLength();if(t)for(const n of t)e<n.getTickLength()&&(e=n.getTickLength());return e}static searchRelationPartCanInsertTempo(t,e){if(t)for(const n of t){const s=n.searchOnTickOffset(e);if(!s||s.getTickOffset()===e)return!0}return!1}static searchRelationPartOnTick(t,e){if(t)for(const n of t){const s=n.searchOnTickOffset(e),i=n.searchPrevNoteOnTickOffset(e);if(s&&s.getTickOffset()===e||i&&i.getEndTick()===e)return!0}return!1}tickDeltaCheck(t){if(t===0)return!0;t<0&&(t=-t);const e=q.minimumTick();return!(t<e)}insertNoteWithTempoMusicQ(t,e,n,s,i,o){let r=i.clone(),c=n;for(;e.length>c;){const a=e[c],l=a.getTickOffset();if(r.getTickOffset()>=l||l>=r.getEndTick())break;if(Y.searchRelationPartCanInsertTempo(o??null,l)){c++;continue}const h=a.getTickOffset()-r.getTickOffset(),d=new G(r.getNote(),h,r.getTickOffset(),r.getVelocity());try{s=this.insertRestNoteEvent(t,s,d).getPrevNoteEvent()??s,t.push(d.toMMLStringWithPrev(s))}catch(b){this.errList.push(new J.Entry(d,b))}t.push(a.toMMLString()),e.splice(c,1),r.setTick(r.getTick()-h),r.setTickOffset(r.getTickOffset()+h),s=d,r.setVelocity(0)}if(r.getTick()>0)try{s=this.insertRestNoteEvent(t,s,r).getPrevNoteEvent()??s,t.push(r.toMMLStringWithPrev(s))}catch(a){this.errList.push(new J.Entry(r,a))}return i.getVelocity()!==r.getVelocity()&&t.push("v"+i.getVelocity()),c}toMMLStringMusicQ(t,e,n=!1){const s=this.totalTickRelationPart(e),i=[];let o=0;for(;t.length>o+1&&t[o+1].getTickOffset()<=this.startOffset;)t.splice(o,1);let r=new G(12*this.initOct,0,this.startOffset,G.INIT_VOL);for(const c of this.eventList.getMMLNoteEventList()){for(;t.length>o;){const a=t[o],l=c.getTickOffset()-a.getTickOffset(),h=a.getTickOffset()-r.getEndTick();if(l>=0)!n||this.tickDeltaCheck(l)&&this.tickDeltaCheck(h)?(r=this.insertTempoMML(i,r,a,!0,e),this.currentTempo=t[o].getTempo(),t.splice(o,1)):o++;else break}o=this.insertNoteWithTempoMusicQ(i,t,o,r,c,e),r=c}for(;t.length>o;){const c=t[o].getTickOffset();if(c>=s)break;Y.searchRelationPartOnTick(e??null,c)?o++:(r=this.insertTempoMML(i,r,t[o],!0,e),this.currentTempo=t[o].getTempo(),t.splice(o,1))}if(this.errList.length>0)throw new J(this.errList);return i.join("")}toMMLString(){return this.toMMLStringFull(!1,!0)}toMMLStringFull(t,e,n){const s=this.totalTickRelationPart(n),i=this.makeLocalTempoList(s),o=[];let r=new G(12*this.initOct,0,this.startOffset,G.INIT_VOL);for(const c of this.eventList.getMMLNoteEventList()){for(;i.length>0&&i[0].getTickOffset()<=c.getTickOffset();)t&&(r=this.insertTempoMML(o,r,i[0],e,n)),this.currentTempo=i[0].getTempo(),i.shift();this.insertNoteWithTempo(o,i,r,c,t,e),r=c}for(;i.length>0;){const c=i[0];if(e&&c.getTickOffset()>=s)break;t&&(r=this.insertTempoMML(o,r,c,e,n)),this.currentTempo=i[0].getTempo(),i.shift()}if(this.errList.length>0)throw new J(this.errList);return o.join("")}}class rt{noteList=[];tempoList;constructor(t,e,n=0){this.tempoList=e??[],this.parseMML(t,n)}parseMML(t,e){const n=new Ut(t,e);for(;n.hasNext();){const s=n.next();s instanceof Z?s.appendToListElement(this.tempoList):s instanceof G&&this.noteList.push(s)}}setGlobalTempoList(t){this.tempoList=t}getGlobalTempoList(){return this.tempoList}getTickLength(){return this.noteList.length>0?this.noteList[this.noteList.length-1].getEndTick():0}isEmpty(){return this.noteList.length===0}getMMLNoteEventList(){return this.noteList}searchOnTickOffset(t){for(const e of this.noteList)if(e.getTickOffset()<=t){if(t<e.getEndTick())return e}else break;return null}searchOnTickOffsetNextNote(t){for(let e=0;e<this.noteList.length-1;e++){const n=this.noteList[e];if(n.getTickOffset()<=t&&t<n.getEndTick())return this.noteList[e+1]}return null}searchPrevNoteOnTickOffset(t){let e=null;for(const n of this.noteList){if(n.getTickOffset()>=t)break;e=n}return e}indexOfMMLString(t){let e=0;for(const n of this.noteList){const s=n.getIndexOfMMLString();if(s){if(n.getTickOffset()<=t){if(t<n.getEndTick())return s}else return[e,s[0]];e=s[1]}}return[e,e]}addMMLNoteEvent(t){if(t.getNote()<-1||t.getTick()<=0||t.getEndTick()<=0)return;let e=t.getTickOffset();e<0&&(t.setTick(t.getTick()+e),t.setTickOffset(0));let n=0;for(;n<this.noteList.length;n++){const s=this.noteList[n],i=s.getEndTick()-t.getTickOffset();if(t.getTickOffset()<s.getTickOffset())break;if(i>=0){const o=s.getTick()-i;if(o===0){this.noteList.splice(n,1);break}else{s.setTick(o),n++;break}}}for(this.noteList.splice(n++,0,t);n<this.noteList.length;){const s=this.noteList[n];if(t.getEndTick()-s.getTickOffset()>0)this.noteList.splice(n,1);else break}}isOverlapNote(t){let e=0;const n=this.noteList.length;for(;e<n;e++){const s=this.noteList[e];if(t.getTickOffset()<s.getEndTick()){if(t.getTickOffset()>=s.getTickOffset())return!0;break}}for(;e<n;e++){const s=this.noteList[e];if(t.getEndTick()<=s.getEndTick()){if(t.getEndTick()-1>=s.getTickOffset())return!0;break}}return!1}deleteMMLEvent(t){const e=this.noteList.indexOf(t);e>=0&&this.noteList.splice(e,1)}setVelocityCommand(t,e){this.setUnsetVelocityCommand(t,e,!0)}unsetVelocityCommand(t){this.setUnsetVelocityCommand(t,0,!1)}setUnsetVelocityCommand(t,e,n){const s=t.getVelocity();let i=G.INIT_VOL;for(const o of this.noteList)if(o.getTickOffset()>=t.getTickOffset())if(s===o.getVelocity())o.setVelocity(n?e:i);else break;else i=o.getVelocity()}toString(){return this.tempoList.toString()+this.noteList.toString()}clone(){const t=new rt("",this.tempoList.map(e=>e.clone()),0);return t.noteList=this.noteList.map(e=>e.clone()),t}getAlignmentStartTick(t,e){const n=t.searchOnTickOffset(e);return n==null||n.getTickOffset()===e?e:t.getAlignmentStartTick(this,n.getTickOffset())}getAlignmentEndTick(t,e){const n=t.searchOnTickOffset(e-1);return n==null||n.getEndTick()===e?e:t.getAlignmentEndTick(this,n.getEndTick())}swap(t,e,n){const s=[],i=[];for(const o of this.noteList)o.getTickOffset()>=e&&o.getEndTick()<=n&&s.push(o);for(const o of s)this.noteList.splice(this.noteList.indexOf(o),1);for(const o of t.getMMLNoteEventList())o.getTickOffset()>=e&&o.getEndTick()<=n&&i.push(o);for(const o of i)t.getMMLNoteEventList().splice(t.getMMLNoteEventList().indexOf(o),1),this.addMMLNoteEvent(o);for(const o of s)t.addMMLNoteEvent(o)}move(t,e,n){const s=[];for(const i of this.noteList)i.getTickOffset()>=e&&i.getEndTick()<=n&&s.push(i);for(const i of s)this.deleteMMLEvent(i),t.addMMLNoteEvent(i)}copy(t,e,n){for(const s of this.noteList)s.getTickOffset()>=e&&s.getEndTick()<=n&&t.addMMLNoteEvent(s.clone())}deleteMinRest(){const t=q.minimumTick();for(let e=1;e<this.noteList.length;e++){const n=this.noteList[e-1],i=this.noteList[e].getTickOffset()-n.getEndTick();if(i>0&&i<t){const o=n.getTick()-t+i;o>=t?n.setTick(o):n.setTick(n.getTick()+i)}}}transpose(t){for(const e of this.noteList)e.setNote(e.getNote()+t)}equals(t){if(!(t instanceof rt))return!1;const e=t,n=this.noteList.length===e.noteList.length&&this.noteList.every((i,o)=>i.equals(e.noteList[o])),s=this.tempoList.length===e.tempoList.length&&this.tempoList.every((i,o)=>i.equals(e.tempoList[o]));return n&&s}getLastNote(){return this.noteList.length>0?this.noteList[this.noteList.length-1]:null}getInternalMMLString(){return Y.create(this).toMMLStringFull(!1,!1)}static maxEndTick(t){let e=0;for(const n of t){const s=n.getLastNote();s&&e<s.getEndTick()&&(e=s.getEndTick())}return e}}class A{static noteString="abcdefgABCDEFGnNrR";static tokenString=A.noteString+"tToOlLvV<>&, ";static tokenCache=new Map;mml_src;mml_length;mml_charArray;startIndex=0;endIndex=0;constructor(t){this.mml_src=t,this.mml_length=t.length,this.mml_charArray=t.split("")}hasNext(){return this.endIndex<this.mml_length}next(){return this.startIndex=this.endIndex,this.endIndex=this.searchToken(this.endIndex+1),this.mml_src.substring(this.startIndex,this.endIndex)}remove(){this.startIndex=0,this.endIndex=0}getStart(){return this.startIndex}getEnd(){return this.endIndex}getIndex(){return[this.startIndex,this.endIndex]}static isToken(t){return A.tokenString.indexOf(t)>=0}static isNote(t){return A.noteString.indexOf(t)>=0}static noteName(t){let e=t.substring(0,1);if(t.length>1){const n=t.charAt(1);(n==="+"||n==="-"||n==="#")&&(e+=n)}return e}static noteNames(t){const e=this.tokenCache.get(t);if(e)return e;const n=this.noteName(t),s=t.substring(n.length),i=[n,s];return this.tokenCache.set(t,i),i}static isLenOnly(t){return t.endsWith(".")&&(t=t.substring(0,t.length-1)),/^[0-9]+$/.test(t)}searchToken(t){let e;for(e=t;e<this.mml_length;e++){const n=this.mml_charArray[e];if(A.isToken(n))break}return e}backSearchToken(t){let e;for(e=t-1;e>=0;e--){const n=this.mml_charArray[e];if(A.isToken(n))break}return e}}class ut{static getOctaveString(t,e){const n=t-e;return Math.abs(n)>2?"o"+e:(n<0?">>":"<<").substring(0,Math.abs(n))}class_OptimizerMap=class extends Map{updateMapMinLength(e,n){const s=this.get(e);(!s||n.length()<s.length())&&this.set(e,n)}};createOptimizerMap(){return new this.class_OptimizerMap}map=this.createOptimizerMap();section="4";octave=4;octD=0;tokenStack=0;constructor(){this.map.set("4",new ct)}getMinString(){let t,e=Number.MAX_SAFE_INTEGER;for(const n of this.map.values()){const s=n.length();s<e&&(t=n,e=s)}return t?t.toString():""}addString(t,e=0){for(const n of this.map.values())e===0?n.append(t):n.insert(n.length()-e,t)}newBuilder(t,e,n,s){const i=t.length();return t.insert(i-s,"l"+e),t.append(n),t}extendPatternBuilder(t,e,n,s,i){}fixPattern(t){}addNoteText(t,e,n){let s=e;s===""?s=this.section:s==="."&&(s=this.section+".");const i=new Map,o=this.getMinString(),r=(c,a)=>{if(a.append(t),c!==s){s===c+"."?a.append("."):a.append(s);const l=new ct().append(o),h=this.newBuilder(l,s,t,n);if(this.updateMapMinLength(i,s,h),s.endsWith(".")){const d=s.substring(0,s.length-1),b=new ct().append(o),I=this.newBuilder(b,d,t+".",n);this.updateMapMinLength(i,d,I)}this.extendPatternBuilder(i,o,t,s,n)}};for(const[c,a]of this.map.entries())r(c,a);for(const[c,a]of i.entries())this.updateMapMinLength(this.map,c,a);Ot.updateFlexDot(this.map,t,s),this.fixPattern(this.map)}updateMapMinLength(t,e,n){const s=t.get(e);(!s||n.length()<s.length())&&t.set(e,n)}cleanMap(){const t=this.getMinString().length;for(const[e,n]of[...this.map.entries()])n.length()>t+e.length+1&&this.map.delete(e)}resetOctave(){this.octave=4,this.octD=0}insertOxPattern(t){if(this.octD!==0){const e=this.octave+this.octD;this.addString(ut.getOctaveString(this.octave,e),t),this.octave=e,this.octD=0}}insertLxPattern(t,e,n){this.addNoteText(t,e,n)}doPattern(t,e,n){this.insertOxPattern(n),this.insertLxPattern(t,e,n)}doToken(t,e){if(t==="o")this.octD=parseInt(e,10)-this.octave;else if(t===">")this.octD++;else if(t==="<")this.octD--;else if(t==="l"){if(e&&this.section!==e){this.section=e,this.addString("l"+e,this.tokenStack);const n=this.getMinString(),s=this.createOptimizerMap();s.set(e,new class extends ct{}().append(n)),this.map=s}}else return!1;return!0}nextToken(t){const e=t.charAt(0).toLowerCase(),n=A.noteNames(t);if(e==="n"&&/^n\d+\.?$/i.test(t)){this.addString(t),this.tokenStack>0?this.tokenStack+=t.length:this.tokenStack=0;return}A.isNote(e)?(this.doPattern(n[0],n[1],this.tokenStack),this.tokenStack=0,this.cleanMap()):(this.doToken(e,n[1])||this.addString(t),e==="&"&&(this.tokenStack+=t.length))}}class ct{parts=[];append(t){return this.parts.push(t),this}toString(){return this.parts.join("")}length(){return this.parts.reduce((t,e)=>t+e.length,0)}reset(t){return this.parts=[t],this}insert(t,e){const n=this.toString(),s=n.slice(0,t),i=n.slice(t);return this.parts=[s,e,i],this}}class Ot{static flexList=[64,32,16,8,4].map(t=>new Ot(t));lCur;lNext;lPrev;constructor(t){this.lCur=t/2+".",this.lNext=""+t,this.lPrev=""+t/4}updatePattern(t,e,n){let s=e;/^[rR]$/.test(e)||(s="&"+e);const i=new Map,o=e+this.lPrev+s+this.lCur;for(const r of t.keys())if(r===this.lNext){const c=t.get(r).toString();if(c.endsWith(o)){const a=c.substring(0,c.length-o.length),l=this.lPrev+".",h=a+e+s+l,d=a+e+"l"+l+s,b=a+e+"l"+this.lPrev+s+".";i.set(r,new ct().append(h)),i.set(l,new ct().append(d)),i.set(this.lPrev,new ct().append(b))}}for(const[r,c]of i.entries()){const a=t.get(r);(!a||c.length()<a.length())&&t.set(r,c)}}static updateFlexDot(t,e,n){for(const s of this.flexList)if(n===s.lCur){s.updatePattern(t,e,n);break}}}class xt{builder=[];nCount=0;prevOct;offsetIndex=null;constructor(t,e=""){this.prevOct=t,e&&this.builder.push(e)}clone(){const t=new xt(this.prevOct);return t.builder=[...this.builder],t.nCount=this.nCount,this.offsetIndex!=null&&(t.offsetIndex=this.offsetIndex),t}length(){return this.builder.join("").length}toString(){return this.builder.join("")}addOctToken(t){this.offsetIndex==null&&(this.offsetIndex=t)}}class Ft{octave=4;builderList=[new xt(4)];lastNoteNumber=-1;minStack(t){return!Array.isArray(t)||t.length===0?new xt(this.octave):t.reduce((e,n)=>{const s=typeof e.length=="function"?e.length():String(e.toString?.()??"").length,i=typeof n.length=="function"?n.length():String(n.toString?.()??"").length;if(s!==i)return s<i?e:n;const o=e.nCount??0,r=n.nCount??0;return o!==r?o<r?e:n:e})}getCurrentNoteNumber(){return this.lastNoteNumber}calcNoteNumber(t){const e={c:0,d:2,e:4,f:5,g:7,a:9,b:11},n=t.toLowerCase(),s=n.charAt(0);if(!(s in e))return-1;let i=e[s];if(n.length>1){const r=n.charAt(1);r==="+"?i+=1:r==="-"?i-=1:r==="#"&&(i+=1)}return this.octave*12+i}listClone(){return this.builderList.map(t=>t.clone())}cleanList(){const t=this.minStack(this.builderList);this.builderList.length=0,this.builderList.push(t)}clearOctToken(){this.builderList.forEach(t=>t.offsetIndex=null)}addNoteToken(t){this.builderList.forEach(e=>{e.builder.push(this.getOctaveString(e.prevOct,this.octave)),e.builder.push(t),e.prevOct=this.octave}),this.clearOctToken()}addToken(t){this.builderList.forEach(e=>e.builder.push(t))}addPattern(t){const e=this.getCurrentNoteNumber();e<0||e>96||(t.forEach(n=>{n.builder.push("n"+e),n.nCount++}),this.builderList.push(this.minStack(t)),this.clearOctToken())}notePattern(t,e,n){const s=this.listClone();this.addNoteToken(t),this.cleanList(),n.length===0&&this.addPattern(s)}doToken(t){const e=A.noteNames(t),n=e[0].charAt(0).toLowerCase();n>="a"&&n<="g"?(this.lastNoteNumber=this.calcNoteNumber(e[0]),this.notePattern(t,e[0],e[1])):n===">"?(this.octave++,this.addOctToken(t)):n==="<"?(this.octave--,this.addOctToken(t)):n==="o"?(this.octave=parseInt(e[1]||"4",10),this.addOctToken(t)):this.addToken(t)}getOctaveString(t,e){const n=t-e;return Math.abs(n)>2?"o"+e:n===0?"":n<0?">".repeat(-n):"<".repeat(n)}addOctToken(t){this.builderList.forEach(e=>{try{if(e&&typeof e.addOctToken=="function"&&Array.isArray(e.builder))e.addOctToken(e.builder.join("").length);else{const n=Array.isArray(e.builder)?e.builder.join("").length:0;e.offsetIndex==null&&(e.offsetIndex=n)}}catch{}})}nextToken(t){this.doToken(t)}getMinString(){return this.minStack(this.builderList).toString()}}class dt extends Ft{map=new Map;disableNopt;constructor(t,e,n){typeof t=="boolean"?(super(),this.disableNopt=t):(super(),this.octave=t,this.disableNopt=n===!0,this.builderList.length=0,this.builderList.push(new class{builder=[e||""];nCount=0;prevOct=t;offsetIndex=null}),this.parser.setOctave(t))}addTokenVariant(t,e,n){let s=t.builder.join("");t.prevOct!==e&&(s+=this.getOctaveString(t.prevOct,e)),s+=n;const i=this.map.get(e);(!i||i.length>s.length)&&this.map.set(e,s)}notePattern(t,e,n){this.builderList.forEach(s=>{if(this.addTokenVariant(s,this.octave,t),e==="b"?this.addTokenVariant(s,this.octave+1,"c-"+n):e==="c"&&this.addTokenVariant(s,this.octave-1,"b+"+n),!this.disableNopt&&s.prevOct!==this.octave&&n.length===0){const i=this.getCurrentNoteNumber();i>=0&&i<=96&&this.addTokenVariant(s,s.prevOct,"n"+i)}}),this.builderList=[];for(const[s,i]of this.map.entries())this.builderList.push(new class{builder=[i];nCount=0;prevOct=s;offsetIndex=null});this.map.clear()}getOptimizedLength(){return this.getMinString().length}static optimizeTail(t,e,n,s){const i=new dt(t,e,s),o=new A(n);for(;o.hasNext();)i.nextToken(o.next());return i.getOptimizedLength()}}class z extends ut{constructor(t){super(),this.disableNopt=t}static FixPattern=class{constructor(e,n,s){this.lStr=e,this.match=n,this.replace=s}patternApply(e,n){if(e===this.lStr||this.lStr==="*"){const s=n.toString();if(s.endsWith(this.match)){const i=s.length-this.match.length,o=s.substring(0,i)+this.replace;n.reset(o)}}}};static pattern=[new z.FixPattern("32","r16.","rrr"),new z.FixPattern("64","r32.","rrr")];createOptimizerMap(){const t=super.createOptimizerMap(),e=this.disableNopt,n=(r,c)=>{let a=0;const l=Math.min(r.length,c.length);for(;a<l&&r.charAt(a)===c.charAt(a);)a++;for(a--,a<0&&(a=0);a>0;){const h=r.charAt(a);if(A.isToken(h)||A.isNote(h))break;a--}return a},s=r=>{let c=4;const a=r.split("");for(let l=0;l<a.length;l++)switch(a[l]){case"<":c--;break;case">":c++;break;case"o":case"O":l++,l<a.length&&(c=a[l].charCodeAt(0)-48);break}return c},i=new Map;S.addCacheList(i);const o=(r,c,a)=>{const l=r.length+":"+c+":"+a+":"+(e?"1":"0"),h=i.get(l);if(h!==void 0)return h;const d=new dt(a,r,e),b=new A(c);for(;b.hasNext();)d.nextToken(b.next());const I=d.getMinString().length;return i.set(l,I),I};return t.updateMapMinLength=(r,c)=>{const a=t.get(r);if(!a){t.set(r,c);return}const l=c.toString(),h=a.toString(),d=n(l,h),b=s(l.substring(0,d)),I=l.substring(0,d),R=o(I,l.substring(d),b),V=o(I,h.substring(d),b);R<V&&t.set(r,c)},t}fixPattern(t){for(const[e,n]of t.entries())for(const s of z.pattern)s.patternApply(e,n)}extendPatternBuilder(t,e,n,s,i){const o=e.lastIndexOf("l");let r="4";if(o>=0&&(r=new A(e.substring(o)).next().substring(1)),i>0&&!r.endsWith(".")&&e.endsWith(n+"&")&&s===((parseInt(r)<<1)+".").toString()){const c=""+(parseInt(r)<<2),a=e.substring(0,e.length-1)+"."+e.substring(e.length-1);let l=t.get(c);l||(l=new class{parts=[];append(h){return this.parts.push(h),this}toString(){return this.parts.join("")}length(){return this.parts.reduce((h,d)=>h+d.length,0)}insert(h,d){const b=this.toString();return this.parts=[b.slice(0,h),d,b.slice(h)],this}reset(h){return this.parts=[h],this}}),l.reset(a),t.set(c,l)}}}class Zt extends Map{constructor(t){super(),this.max=t}order=[];get(t){const e=super.get(t);if(e!==void 0){const n=this.order.indexOf(t);n>=0&&(this.order.splice(n,1),this.order.push(t))}return e}set(t,e){if(super.has(t)){const n=this.order.indexOf(t);n>=0&&(this.order.splice(n,1),this.order.push(t))}else if(this.order.push(t),this.order.length>this.max){const n=this.order.shift();n!==void 0&&super.delete(n)}return super.set(t,e)}delete(t){const e=this.order.indexOf(t);return e>=0&&this.order.splice(e,1),super.delete(t)}clear(){this.order=[],super.clear()}}class Tt{constructor(t=""){this.buf=t}append(t){return this.buf+=t,this}toString(){return this.buf}length(){return this.buf.length}delete(t,e){return this.buf=this.buf.slice(0,t)+this.buf.slice(e),this}replace(t,e,n){return this.buf=this.buf.slice(0,t)+n+this.buf.slice(e),this}substring(t,e){return this.buf.substring(t,e)}insert(t,e){return this.buf=this.buf.slice(0,t)+e+this.buf.slice(t),this}}class vt extends z{static altPatterns=[new z.FixPattern("64","42","."),new z.FixPattern("32","21","."),new z.FixPattern("24","r12","rr"),new z.FixPattern("32","r16","rr"),new z.FixPattern("48","r24","rr"),new z.FixPattern("64","r32","rr"),new z.FixPattern("24","r12.","rrr"),new z.FixPattern("32","r16.","rrr"),new z.FixPattern("48","r24.","rrr"),new z.FixPattern("64","r32.","rrr"),new z.FixPattern("4","r3r9r16","rr5r17")];altPatternMap=new z.OptimizerMap;constructor(t){super(t)}fixPattern(t){this.altPatternMap.clear();for(const[e,n]of t.entries())this.tickAltPattern(this.altPatternMap,e,n);for(const[e,n]of this.altPatternMap.entries())t.updateMapMinLength(e,n);for(const[e,n]of t.entries())for(const s of vt.altPatterns)s.patternApply(e,n);super.fixPattern(t)}tickAltPattern(t,e,n){const s=n.toString();let i=s.length,o=i;for(;o>0&&!A.isNote(s.charAt(--o)););if(o===0)return;const r=A.noteNames(s.substring(o,i));let c=o-1;if(r[0]==="r")c++;else if(s.charAt(c)!=="&")return;let a=c;for(;a>0&&!A.isNote(s.charAt(--a)););const l=A.noteNames(s.substring(a,c));if(l[0]!==r[0]||l[0]==="n"||r[0]==="n")return;const h=l[0]!=="r"?"&":"";try{const d=at.getAltList(l[1],r[1],e);if(d){const b=s.substring(0,a),I=d.filter(R=>!R.getLStr().present).map(R=>l[0]+(R.getNeedDot()?"."+h:h)+r[0]+R.getAltPattern()).sort();I.length>0&&(n.delete(a,i),n.append(I[0]));for(const R of d){const V=R.getAltPattern(),Q=R.getLStr();if(Q.present)t.updateMapMinLength(Q.value,new Tt(b+"l"+Q.value+l[0]+V+h+r[0]));else if(R.getNeedDot())t.updateMapMinLength(V,new Tt(b+l[0]+"."+(e!==V?"l"+V:"")+h+r[0]));else{if(V.endsWith(".")){const X=V.slice(0,-1);t.updateMapMinLength(X,new Tt(b+l[0]+(e!==X?"l"+X:"")+h+r[0]+"."))}t.updateMapMinLength(V,new Tt(b+l[0]+"l"+V+h+r[0]))}}}}catch{}}}class at{constructor(t,e,n=null){this.altPattern=t,this.needDot=e,this.lStr=n}static altCache=new Zt(256);getAltPattern(){return this.altPattern}getNeedDot(){return this.needDot}getLStr(){return{present:this.lStr!=null,value:this.lStr}}static getAltList(t,e,n){if(!A.isLenOnly(t)||!A.isLenOnly(e))return null;const s=t+"&"+e+":"+n,i=this.altCache.get(s);if(i!==void 0)return i;const o=q.getTick(t)+q.getTick(e),r=q.getAlt(o),c=[];if(r&&r.alt)for(const l of r.alt){let h=!1;for(let d=0;d<l.length;d++){const b=l[d===0?1:0],I=l[d];n===I?(c.push(new at(b,!1)),h=!0):n+"."===I&&(b.endsWith(".")||(c.push(new at(b,!0)),h=!0))}if(!h){const d=l[0],b=l[1];b+"."===d&&(c.push(new at(".",!1,b)),c.push(new at(b,!1,d)))}}const a=c.length>0?c:null;return this.altCache.set(s,a),a}}const Qt=at.altCache;class wt{static pattern=[new z.FixPattern("*","r1.r2","r1r1")];sb="";nextToken(t){this.sb+=t;for(const e of wt.pattern)e.patternApply("",{toString:()=>this.sb,reset:n=>(this.sb=n,this)})}getMinString(){return this.sb}}class Et{tokens=[];nextToken(t){this.tokens.push(t)}getMinString(){if(this.tokens.length===0)return"";const t=this.tokens.join(""),e=[],n=o=>/[a-gA-G]/.test(o),s=o=>{let r=o+1;if(r<t.length){const c=t[r];(c==="+"||c==="-"||c==="#")&&r++}for(;r<t.length&&/[0-9.]/.test(t[r]);)r++;return{token:t.slice(o,r),next:r}};let i=0;for(;i<t.length;){const o=t[i];if(o==="<"){const r=i+1;if(r<t.length&&n(t[r])&&t[r].toLowerCase()==="b"){const{token:c,next:a}=s(r);if(/^[bB][+#-]/.test(c)){e.push(o),i++;continue}if(a<t.length&&t[a]===">"){let l=!1;for(let h=r+1;h<a;h++)if(n(t[h])){l=!0;break}if(!l){const h=(c[0]==="B"?"C-":"c-")+c.slice(1).replace(/^[+#-]?/,"").replace(/^([0-9].*)$/,"$1");e.push(h),i=a+1;continue}}}}else if(o===">"){const r=i+1;if(r<t.length&&n(t[r])&&t[r].toLowerCase()==="c"){const{token:c,next:a}=s(r);if(/^[cC][+#-]/.test(c)){e.push(o),i++;continue}if(a<t.length&&t[a]==="<"){let l=!1;for(let h=r+1;h<a;h++)if(n(t[h])){l=!0;break}if(!l){const h=(c[0]==="C"?"B+":"b+")+c.slice(1).replace(/^[+#-]?/,"").replace(/^([0-9].*)$/,"$1");e.push(h),i=a+1;continue}}}}e.push(o),i++}return e.join("")}}class S{constructor(t){this.originalMML=t}static GEN1=1;static GEN2=2;static GEN3=3;static debug=!1;static optLevel=1;static mmlCache=new Map;static cacheList=[S.mmlCache];static currentContext=null;static setDebug(t){this.debug=t}static getDebug(){return this.debug}static setOptimizeLevel(t){this.optLevel=t}static clearAllCache(){this.cacheList.forEach(t=>t.clear())}static addCacheList(t){this.cacheList.includes(t)||this.cacheList.push(t)}static setContext(t){this.currentContext=t}static getContext(){return this.currentContext}static initAltPatternCache=(S.addCacheList(Qt),!0);disableNopt=!1;toString(){return this.cachedOptimize(S.GEN1,!1)}preciseOptimize(){return this.cachedOptimize(S.optLevel,this.disableNopt)}setDisableNopt(t){return this.disableNopt=t,this}cachedOptimize(t,e){const n=t+":"+e+":"+this.originalMML,s=S.mmlCache.get(n);if(s)return s;let i;if(t===S.GEN2){const o=this.optimizeGen2();i=this.fallbackIfChanged(o,e)}else if(t===S.GEN3){const o=this.optimizeGen3();i=this.fallbackIfChanged(o,e)}else i=this.optimize(e);return S.mmlCache.set(n,i),i}optimizeGen2(){return this.optimizeChain([new z(this.disableNopt),new dt(this.disableNopt)])}optimizeGen3(){return this.optimizeChain([new vt(this.disableNopt),new dt(this.disableNopt),new wt])}optimizeForTextEditor(){return this.optimizeChain([new z(!0)])}optimize(t){return t?this.optimizeChain([new ut,new Et]):this.optimizeChain([new ut,new Et,new Ft])}optimizeChain(t){let e=this.originalMML;for(const n of t){const s=new A(e);for(;s.hasNext();){let i=null;try{i=s.next(),n.nextToken(i)}catch{}}e=n.getMinString()}return e}fallbackIfChanged(t,e){return this.quickEquivalent(this.originalMML,t)?t:this.optimize(e)}quickEquivalent(t,e){if(t===e)return!0;const n=this.tokenCounts(t),s=this.tokenCounts(e),i=Object.keys(n),o=Object.keys(s);if(i.length!==o.length)return!1;for(const r of i)if(n[r]!==s[r])return!1;return!0}tokenCounts(t){const e={},n=new A(t);for(;n.hasNext();){const s=n.next();e[s]=(e[s]||0)+1}return e}}function Ht(x,t,e=0){const n=[];t.slice().sort((r,c)=>r.tickOffset-c.tickOffset).forEach((r,c)=>new Z(r.tempo,r.tickOffset,c===0).appendToListElement(n));const s=new rt("",n,e),i=x.slice().sort((r,c)=>r.offset-c.offset);for(const r of i)try{const c=r.velocity==null?G.INIT_VOL:r.velocity;if(!(r.tick>0)){console.warn("[buildEventList skip non-positive tick]",{ctx:S.getContext?.(),n:r});continue}const a=new G(r.note,r.tick,r.offset,c);s.addMMLNoteEvent(a)}catch(c){console.warn("[buildEventList note error]",{ctx:S.getContext?.(),n:r,err:c})}return s.getMMLNoteEventList().length===0&&i.length>0&&console.warn("[buildEventList result empty]",{ctx:S.getContext?.(),inputCount:i.length,first:i[0],last:i[i.length-1]}),s}function Dt(x,t,e={}){try{console.log("[noteToMML enter]",{ctx:S.getContext?.(),notes:x?.length,tempos:t?.length})}catch{}Array.isArray(x)||(x=[]),Array.isArray(t)||(t=[]);const{startOffset:n=0,initOct:s=4,percussionMotionFix:i=!1,mabiTempo:o=!0,includeTempo:r=!0,optimizeLevel:c=2,disableNopt:a=!1}=e,l=Ht(x,t,n),d=Y.create(l,n,s,i).toMMLStringFull(r,o),b=S.optLevel;let I=d;try{S.setOptimizeLevel(c),I=new S(d).setDisableNopt(a).preciseOptimize()}catch(Q){try{console.warn("[noteToMML optimize error]",{ctx:S.getContext?.(),err:Q})}catch{}I=d}finally{try{S.setOptimizeLevel(b)}catch{}}let R=I,V=!1;try{const Q=new rt(I,[],n);if(!l.equals(Q)){try{const X=d,ft=I;let tt=0;const pt=Math.min(X.length,ft.length);for(;tt<pt&&X[tt]===ft[tt];tt++);}catch{}R=d,V=!0}}catch{R=d,V=!0}return{original:d,optimized:R,fallbackUsed:V}}function Kt(x,t=0){const e=new rt(x,[],t),n=e.getMMLNoteEventList().map(i=>({note:i.getNote(),tick:i.getTick(),offset:i.getTickOffset(),velocity:i.getVelocity()})),s=e.getGlobalTempoList().map((i,o)=>({tempo:i.getTempo(),tickOffset:i.getTickOffset()}));return{eventList:e,notes:n,tempos:s}}function zt(x){return x.map(t=>({note:t.pitch,tick:t.durationTick,offset:t.startTick,velocity:t.volume}))}function It(x,t=[],e=!0){try{const n=Dt(zt(x),t,{includeTempo:e});return n.optimized||n.original||""}catch{return Vt(x,t)}}function At(x,t=[],e=!0){try{const n=Dt(zt(x),t,{includeTempo:e});return n.original||n.optimized||""}catch{return Vt(x,t)}}function Pt(x){const t=S.optLevel;S.setOptimizeLevel(2);const e=new S(x).preciseOptimize();return S.setOptimizeLevel(t),e}function ie(x){const t=Kt(x),e=t.notes.map(s=>new jt(crypto.randomUUID(),s.note,s.offset,s.tick,s.velocity??15)),n=t.tempos.map(s=>({tempo:s.tempo,tickOffset:s.tickOffset}));return{notes:e,tempos:n}}function Vt(x,t){try{const e=[];t.slice().sort((i,o)=>i.tickOffset-o.tickOffset).forEach((i,o)=>new Z(i.tempo,i.tickOffset,o===0).appendToListElement(e));const n=new rt("",e,0);return x.slice().sort((i,o)=>i.startTick-o.startTick).forEach(i=>{try{n.addMMLNoteEvent(new G(i.pitch,i.durationTick,i.startTick,i.volume??15))}catch{}}),Y.create(n,0,4,!1).toMMLStringFull(!0,!0)||""}catch{return""}}function Jt(x){try{const M=x.tracks.map(L=>({trackId:L.id,name:L.name,order:L.order,notes:(L.notes||[]).map(p=>({startTick:p.startTick,durationTick:p.durationTick,pitch:p.pitch,volume:p.volume}))})),k=x.tempoAnchors||[];console.log("[convertModal open] track events snapshot",{tracks:M,tempoAnchors:k})}catch(M){try{console.warn("[convertModal open] logging failed",M)}catch{}}const t=document.createElement("div");t.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
   `;const e=document.createElement("div");e.style.cssText=`
      background: #fff;
      padding: 24px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
   `;const n=document.createElement("div");n.style.cssText=`
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #eee;
      padding: 8px;
      margin-bottom: 16px;
   `;const s=document.createElement("div");s.style.cssText=`
            display: flex;
            align-items: center;
            gap: 8px;
        `;const i=document.createElement("label");i.setAttribute("for","convertFilenameInput"),i.textContent=st[it].convertFilenameLabel||"파일명",i.setAttribute("data-i18n","convertFilenameLabel"),i.style.cssText=`
            min-width: 72px;
            color: #666;
            font-size: 12px;
        `;const o=document.createElement("input");o.type="text",o.id="convertFilenameInput",o.placeholder=st[it].convertFilenamePlaceholder||"예: my-song.txt",o.setAttribute("data-i18n-placeholder","convertFilenamePlaceholder"),o.style.cssText=`
            flex: 1 1 auto;
            padding: 6px 8px;
            border: 1px solid #cfcfcf;
            border-radius: 6px;
            font-size: 12px;
        `;const r=new Date().toISOString().replace(/[:.]/g,"-");o.value=`mml-${r}.txt`,s.append(i,o);const c=document.createElement("textarea");c.style.cssText=`
            width: 100%;
            min-height: 200px;
            box-sizing: border-box;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            word-break: break-all;
            overflow-y: auto;
        `,c.readOnly=!1;const a=document.createElement("div");a.style.cssText=`
      display: flex;
      justify-content: flex-end;
      gap: 8px;
   `,Gt();const l=document.createElement("label");l.style.cssText=`
            display: flex;
            align-items: center;
            gap: 4px;
            margin-right: auto; /* 왼쪽으로 붙여 나머지 버튼들과 공간 확보 */
            font-size: 12px;
            cursor: pointer;
            user-select: none;
            color: #555;
        `;const h=document.createElement("input");h.type="checkbox",h.id="mobinogiSpeedBugFix",h.style.cursor="pointer";const d=document.createElement("span");d.textContent="모비노기 변속버그 수정",l.append(h,d),h.addEventListener("change",()=>{h.checked?$t():gt()});const b=Mt({label:st[it].convertCopy,variant:"primary",attrs:{"data-i18n":"convertCopy"}}),I=Mt({label:st[it].convertSaveTxt,variant:"secondary",attrs:{"data-i18n":"convertSaveTxt"}}),R=Mt({label:st[it].modalClose,variant:"secondary",attrs:{"data-i18n":"modalClose"}});a.append(l,b,I,R),e.append(n,s,a,c),t.appendChild(e),document.body.appendChild(t);function V(){window.removeEventListener("keydown",Q,!0),t.parentNode&&document.body.removeChild(t)}function Q(M){M.key==="Escape"&&V()}n.innerHTML="";let X=[];const ft=new Map,tt=()=>{let k=c.value||"";k.startsWith("MML@")&&(k=k.slice(4)),k.endsWith(";")&&(k=k.slice(0,-1));const L=k.length>0?k.split(",").map(p=>p.trim()):[];for(const p of x.tracks){const g=ft.get(p.id);if(!g)continue;const w=X.indexOf(p.id),T=w>=0&&w<L.length?L[w].length:0;g.textContent=`${p.name} (${T}${st[it].charUnit})`}};[...x.tracks].slice().sort((M,k)=>M.order-k.order).forEach(M=>{const k=document.createElement("div");k.style.cssText=`
            display: flex;
            align-items: center;
            margin-bottom: 8px;
         `;const L=document.createElement("input");L.type="checkbox",L.id=`track-${M.id}`,L.value=String(M.id),L.checked=M.notes.length>0,L.disabled=M.notes.length===0,L.style.margin="0 4px 0 0",L.style.cursor="pointer";const p=document.createElement("label");p.htmlFor=`track-${M.id}`,ft.set(M.id,p),p.textContent=`${M.name}`,p.style.cssText=`
                margin-left: 8px;
                ${M.notes.length===0?"color: #aaa;":""}
            `,L.addEventListener("change",()=>{gt(),tt()}),k.append(L,p),n.appendChild(k)});function pt(M){return(M.tempoAnchors||[]).map(g=>{if(!g)return null;const w=typeof g.getTickOffset=="function"?g.getTickOffset():typeof g.tick=="number"?g.tick:0,T=typeof g.getTempo=="function"?g.getTempo():typeof g.bpm=="number"?g.bpm:typeof g.tempo=="number"?g.tempo:120;return{tick:w,tempo:T}}).filter(Boolean).slice().sort((g,w)=>g.tick-w.tick).map((g,w)=>({tickOffset:g.tick,tempo:g.tempo,isFirst:w===0}))}function Rt(M){const k=M.slice().sort((T,ot)=>T.order-ot.order),L=[],p=pt(x);let g=p.length===0,w=0;for(const T of k){if(!(Array.isArray(T.notes)&&T.notes.length>0)){try{console.warn("[convertModal skip track - no notes]",{trackId:T.id,name:T.name})}catch{}continue}try{S.setContext(`track-${T.id}:${T.name}`)}catch{}let m="";try{console.log("[convertModal gen start]",{trackId:T.id,name:T.name,notes:T.notes?.length,tempos:p.length});const P=w===0;if(m=It(T.notes??[],p,P)||"",m||(m=At(T.notes??[],p,P)||""),!m)try{const F=window.notesToMMLFallback?window.notesToMMLFallback:null;F&&(m=F(T.notes,p)||"")}catch{}console.log("[convertModal gen after noteToMML]",{trackId:T.id,bodyLen:m.length,startsWithTempo:/^t\d+/i.test(m)})}catch(P){console.warn("[convertModal gen error noteToMML]",{trackId:T.id,err:P})}if(!m)try{const P=(()=>{const F=T.notes.map(D=>D.durationTick).sort((D,lt)=>D-lt);return{noteCount:T.notes.length,minDur:F[0],maxDur:F[F.length-1],uniqueSmall:Array.from(new Set(F.filter(D=>D<=64))).slice(0,10)}})();console.warn("[convertModal empty body diagnostics]",{trackId:T.id,stats:P,firstNote:T.notes[0]})}catch{}if(w===0)if(!g&&m){const P=p.length?p[0].tempo:120;/^t\d+/i.test(m)||(m="t"+P+m),g=!0}else g&&p.length===0&&m&&!/^t\d+/i.test(m)&&(m="t120"+m,g=!0);else m=m.replace(/^t\d+/i,"");if(m)try{const P=m;m=Pt(m)||m,console.log("[convertModal optimize done]",{trackId:T.id,beforeLen:P.length,afterLen:m.length})}catch(P){console.warn("[convertModal optimize error]",{trackId:T.id,err:P})}m?(L.push(m),w++,console.log("[convertModal track included]",{trackId:T.id,finalLen:m.length})):console.warn("[convertModal track empty after generation]",{trackId:T.id});try{S.setContext(null)}catch{}}return`MML@${L.join(",")};`}let yt=null;function Bt(M,k,L,p){const g=yt;let w=g&&g[L]?g[L][p]:"";if(!w)return"";const T=g?g[L]:null;if(T&&p===T.length-1||!M||k<=0)return w;const ot=C=>{const N=[],U=/(l\d+\.?|r\d*\.?)/gi;let _,H=4,B=!1;for(;(_=U.exec(C))!==null;){const W=_[0];if(/^l/i.test(W)){const K=W.match(/l(\d+)(\.)?/i);K&&(H=parseInt(K[1],10)||H,B=!!K[2]);continue}if(/^r/i.test(W)){const K=W.match(/r(\d*)(\.)?/i);let nt=null,Nt=!1;if(K){const St=K[1];St&&(nt=parseInt(St,10)),Nt=!!K[2]}const bt=nt??H,Ct=Nt||nt==null&&B,Wt=Ct?bt*1.5:bt;N.push({token:W,rawLen:bt,effectiveLen:Wt,index:_.index,dotted:Ct,explicit:nt!=null,baseLAtToken:H,baseLDottedAtToken:B})}}return N};let m=ot(w);if(m.length===0)return w;let P=m.filter(C=>!C.dotted),F=k;if(P.length===0){const C=m.filter(N=>N.dotted);if(C.length>0){let N=C[0];for(let B=1;B<C.length;B++)C[B].effectiveLen>N.effectiveLen&&(N=C[B]);const U=N.rawLen,_="r"+U,H="r"+U*2;F=Math.max(0,F-1);try{const B=w.slice(0,N.index),W=w.slice(N.index+N.token.length);!/\./.test(N.token)&&N.baseLDottedAtToken,w=B+_+H+W}catch{}m=ot(w),P=m.filter(B=>!B.dotted)}}if(P.length===0)return w;let D=P[0];for(let C=1;C<P.length;C++){const N=P[C];(N.effectiveLen>D.effectiveLen||N.effectiveLen===D.effectiveLen&&D.explicit&&!N.explicit)&&(D=N)}const lt=w.slice(0,D.index),u=w.slice(D.index+D.token.length),O=D.baseLAtToken,f=D.baseLDottedAtToken,y=D.rawLen;let E=F,v=[y];for(;E>0;){let C=0;for(let U=1;U<v.length;U++)v[U]<v[C]&&(C=U);const N=v[C];v.splice(C,1,N*2,N*2),E--}v.sort((C,N)=>C-N);let $="",j=-1,et=0;const mt=()=>{et>0&&($+="l"+j+"r".repeat(et))};for(const C of v)C!==j?(mt(),j=C,et=1):et++;mt(),(O!==j||f)&&($+="l"+O+(f?".":""));const kt=lt+$+u;return(C=>{let N="",U=0,_=null,H=!1;const B=/l(\d+)(\.)?/gi;let W;for(;(W=B.exec(C))!==null;){N+=C.slice(U,W.index);const K=parseInt(W[1],10),nt=!!W[2];_===K&&H===nt||(N+=W[0],_=K,H=nt),U=B.lastIndex}return N+=C.slice(U),N})(kt)}function gt(){const M=[];n.querySelectorAll('input[type="checkbox"]').forEach(p=>{p.checked&&M.push(parseInt(p.value))});const k=x.tracks.filter(p=>M.includes(p.id));X=k.slice().sort((p,g)=>p.order-g.order).map(p=>p.id);const L=Rt(k);c.value=L,tt()}function $t(){const M=[];n.querySelectorAll('input[type="checkbox"]').forEach(u=>{const O=u;O.checked&&M.push(parseInt(O.value))});const k=x.tracks.filter(u=>M.includes(u.id)).slice().sort((u,O)=>u.order-O.order);if(k.length===0){try{console.log("[tempoFix] no selected tracks")}catch{}return}const L=pt(x),p=[],g=[];k.forEach(u=>{if(!(Array.isArray(u.notes)&&u.notes.length>0))return;try{S.setContext(`tempoFix-track-${u.id}:${u.name}`)}catch{}let f="";try{if(f=It(u.notes??[],L,!0)||"",f||(f=At(u.notes??[],L,!0)||""),!f)try{const v=window.notesToMMLFallback?window.notesToMMLFallback:null;v&&(f=v(u.notes,L)||"")}catch{}}catch(v){try{console.warn("[updateMMLOutputWithTempoFix gen error]",{trackId:u.id,err:v})}catch{}}if(!f)return;if(/^t\d+/i.test(f)||(f="t"+(L.length?L[0].tempo:120)+f),!/n\d+/i.test(f))try{f=Pt(f)||f}catch{}const E=[];f.replace(/t\d+/gi,v=>(E.push(v),v)),g.push(E),f=w(f),p.push(f);try{S.setContext(null)}catch{}});function w(u){let O="4",f=!1;const y=/(t\d+|l\d+\.?)/gi;let E="",v=0,$;for(;($=y.exec(u))!==null;){E+=u.slice(v,$.index);const j=$[0];if(/^l/i.test(j))O=j.slice(1),E+=j;else if(/^t/i.test(j))if(E+=j,!f)f=!0;else{const et=u.slice(y.lastIndex);/^l\d+/i.test(et)||(E+="l"+O)}v=y.lastIndex}return E+=u.slice(v),E}const T=p.map(u=>{const O=[],f=/t\d+/gi;let y=0,E;for(;(E=f.exec(u))!==null;){const $=u.slice(y,E.index);$.length>0&&O.push($),y=f.lastIndex}const v=u.slice(y);return v.length>0&&O.push(v),O});yt=T;const ot=/[abcdefgrn]/gi,m=T.map(u=>u.map(O=>{if(!O)return 0;const f=O.match(ot);return f?f.length:0})),P=Math.max(...m.map(u=>u.length)),F=m.map(u=>new Array(u.length).fill(0));for(let u=0;u<P;u++){let O=0;for(let f=0;f<m.length;f++){const y=m[f][u];typeof y=="number"&&!isNaN(y)&&y>O&&(O=y)}for(let f=0;f<m.length;f++){const y=m[f][u];typeof y=="number"&&u<F[f].length&&(F[f][u]=O-y)}}for(let u=0;u<T.length;u++){const O=T[u];for(let f=0;f<O.length-1;f++)if(f<F[u].length&&F[u][f]>0){const y=O[f]||"";if(!/r\d*\.?/i.test(y)){const E=k[u],v=g[u]||[],$=v[f]||v[v.length-1]||"t?",j=v[f+1]||"끝",et=$.replace(/[^0-9]/g,""),mt=j==="끝"?"끝":j.replace(/[^0-9]/g,""),kt=`${E?.name||"트랙"} 트랙의 t${et} ~ t${mt} 구간에 쉼표가 없어 분할을 할 수 없습니다.`;try{alert(kt)}catch{console.warn(kt)}const Lt=document.querySelector("#tempo-fix-checkbox");Lt&&(Lt.checked=!1);try{gt()}catch{}return}}}const D=T.map((u,O)=>u.map((f,y)=>{if(y<F[O].length&&F[O][y]>0){const E=!!(f&&/r/i.test(f));return Bt(E,F[O][y],O,y)}return f})),lt=D.map((u,O)=>{const f=g[O]||[];let y=[];for(let E=0;E<u.length;E++){const v=f[E];O===0&&v&&y.push(v);const $=u[E].trim();$&&y.push($)}return y.join("")});c.value="MML@"+lt.join(",")+";",tt();try{console.log("[updateMMLOutputWithTempoFix tempoSplitMatrix]",{tempoSplitMatrix:T,tempoNoteRestCounts:m,needs:F,tempoSplitMatrixFixed:D,rebuiltBodies:lt})}catch{}}gt(),R.onclick=V,t.onclick=M=>{M.target===t&&V()},b.onclick=()=>{navigator.clipboard.writeText(c.value),b.textContent=st[it].copied,setTimeout(()=>{b.textContent=st[it].convertCopy},2e3)},I.onclick=()=>{try{const M=new Blob([c.value],{type:"text/plain;charset=utf-8"}),k=document.createElement("a");k.href=URL.createObjectURL(M);const L=(o.value||"").trim(),p=`mml-${new Date().toISOString().replace(/[:.]/g,"-")}.txt`;let g=L.length>0?L:p;g=g.replace(/[\\\/:*?"<>|]/g,"_"),/\.txt$/i.test(g)||(g+=".txt"),k.download=g,document.body.appendChild(k),k.click(),setTimeout(()=>{URL.revokeObjectURL(k.href),k.parentNode&&k.parentNode.removeChild(k)},0)}catch{}},window.addEventListener("keydown",Q,!0)}const re=Object.freeze(Object.defineProperty({__proto__:null,showConvertModal:Jt},Symbol.toStringTag,{value:"Module"}));export{Z as M,It as a,Pt as b,re as c,ie as m,At as n,Jt as s};
