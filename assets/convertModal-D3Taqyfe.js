import{e as Gt,c as Mt}from"./button-WIurEURm.js";import{F as qt,G as W,J as G,U as Ut,t as st,c as it}from"./languages-BQGPFjgN.js";class Z extends qt{static META=81;static INITIAL_TEMPO=120;tempo;isFirst;constructor(t,e,n=!1){if(super(e),t<=0||t>1e3)throw new Error("tempo "+t);this.tempo=t,this.isFirst=n}getTempo(){return this.tempo}setTempo(t){this.tempo=t}toString(){return`${this.getTickOffset()}T${this.tempo}`}static fromString(t){if(!t||t.length===0)return null;const e=t.split("T");return e.length!==2?null:new Z(parseInt(e[1],10),parseInt(e[0],10))}toMMLString(){return"t"+this.tempo}appendToListElement(t){let e=0;const n=this.getTickOffset();for(;e<t.length;e++){const s=t[e];if(s.getTickOffset()===n){t.splice(e,1);break}else if(s.getTickOffset()>n)break}(e===0||t[e-1].getTempo()!==this.tempo||!this.isFirst)&&t.splice(e,0,this)}static mergeTempoList(t,e){if(t!==e)for(const n of t)n.appendToListElement(e);return e}static searchOnTick(t,e){let n=Z.INITIAL_TEMPO;for(const s of t){if(e<s.getTickOffset())break;n=s.getTempo()}return n}static searchEqualsTick(t,e){for(const n of t){if(n.getTickOffset()===e)return!0;if(n.getTickOffset()>e)break}return!1}static getMaxTempoEvent(t){const e=new Z(Z.INITIAL_TEMPO,0);for(const n of t){const s=n.getTempo();e.getTempo()<s&&e.setTempo(s)}return e}getMetaData(){const t=Math.trunc(6e7/this.tempo),e=new Uint8Array(3);return e[0]=t>>16&255,e[1]=t>>8&255,e[2]=t&255,e}clone(){return new Z(this.tempo,this.getTickOffset(),this.isFirst)}equals(t){return t instanceof Z?this.tempo===t.tempo&&super.equals(t):!1}}class jt{index=0;tokens=[];currentOct=4;currentVelocity=W.INIT_VOL;tickOffset;pendingTie=!1;lastNote=null;defaultLengthBase=4;defaultLengthDotted=!1;constructor(t,e){this.tickOffset=e|0;const n=(t||"").toLowerCase().replace(/\s+/g,"").replace(/^mml@/,""),s=/(t\d{1,4})|(o\d)|(l\d+\.)|(l\d+)|(>>+|>+|<<+|<+)|([a-gA-G][+#-]?\d+\.)|([a-gA-G][+#-]?\d*\.)|([a-gA-G][+#-]?\d*)|(r\d+\.)|(r\d*\.)|(r\d*)|(n\d+)|(v\d{1,3})|(&)|([^])/g;let i;for(;i=s.exec(n);){const r=i[0];r.trim().length!==0&&this.tokens.push(r)}if(globalThis.MML_DEBUG)try{console.log("[MMLEventParser tokens]",{body:n,tokens:this.tokens})}catch{}}hasNext(){return this.index<this.tokens.length}next(){if(!this.hasNext())return null;const t=this.tokens[this.index++];if(t==="&")return this.pendingTie=!0,null;const e=t.charAt(0).toLowerCase();if(e==="t"){const n=parseInt(t.substring(1),10);return Number.isFinite(n)&&n>0?new Z(n,this.tickOffset,this.tickOffset===0):null}if(e==="o"){const n=parseInt(t.substring(1),10);return Number.isFinite(n)&&(this.currentOct=Math.max(0,Math.min(9,n))),null}if(e==="l"){const n=/^l(\d+)(\.)?$/.exec(t);if(n){const s=parseInt(n[1],10);Number.isFinite(s)&&s>0&&(this.defaultLengthBase=s,this.defaultLengthDotted=!!n[2])}return null}if(e===">"||e==="<"){for(const n of t)n===">"?this.currentOct=Math.min(9,this.currentOct+1):n==="<"&&(this.currentOct=Math.max(0,this.currentOct-1));return null}if(e==="v"){const n=parseInt(t.substring(1),10);return Number.isFinite(n)&&(this.currentVelocity=Math.max(0,Math.min(15,n))),null}if(e==="n"){const n=parseInt(t.substring(1),10);if(Number.isFinite(n)){const s=this.defaultLengthBase+(this.defaultLengthDotted?".":""),i=this.parseLength(s)||G.getTick("4"),r=this.currentVelocity;if(this.pendingTie&&this.lastNote&&this.lastNote.getNote()===n&&this.lastNote.getVelocity()===r)return this.lastNote.setTick(this.lastNote.getTick()+i),this.tickOffset+=i,this.pendingTie=!1,null;const o=new W(n,i,this.tickOffset,r);return this.lastNote=o,this.pendingTie=!1,this.tickOffset+=i,o}return null}if(e==="r"){let n=t.substring(1);n==="."?n=this.defaultLengthBase+".":n===""&&(n=this.defaultLengthBase+(this.defaultLengthDotted?".":""));const s=this.parseLength(n)||this.parseLength(this.defaultLengthBase+(this.defaultLengthDotted?".":""))||G.getTick("4");return this.tickOffset+=s,null}if(e>="a"&&e<="g"){const n=/^([a-gA-G][+#-]?)(\d*\.?)*$/.exec(t);if(n){const s=n[1];let r=t.substring(s.length);r==="."?r=this.defaultLengthBase+".":r===""&&(r=this.defaultLengthBase+(this.defaultLengthDotted?".":""));const o=this.calcPitch(s,this.currentOct),c=this.defaultLengthBase+(this.defaultLengthDotted?".":""),a=this.parseLength(r)||this.parseLength(c)||G.getTick("4"),l=this.currentVelocity;if(this.pendingTie&&this.lastNote&&this.lastNote.getNote()===o&&this.lastNote.getVelocity()===l)return this.lastNote.setTick(this.lastNote.getTick()+a),this.tickOffset+=a,this.pendingTie=!1,null;const h=new W(o,a,this.tickOffset,l);return this.lastNote=h,this.pendingTie=!1,this.tickOffset+=a,h}}return null}parseLength(t){if(!t)return null;const e=/^(\d+)(\.)?$/.exec(t);if(!e)return null;const n=parseInt(e[1],10);if(!Number.isFinite(n)||n<=0)return null;const s=G.getTick("4");let i=Math.round(4/n*s);return e[2]&&(i+=i/2),Math.round(i)}calcPitch(t,e){const n={c:0,d:2,e:4,f:5,g:7,a:9,b:11},s=t.charAt(0).toLowerCase();let i=n[s]??0;const r=t.charAt(1);return r==="+"||r==="#"?i+=1:r==="-"&&(i-=1),e*12+i}}class Y extends Error{static Entry=class{event;exception;constructor(e,n){this.event=e,this.exception=n}getNote(){return this.event}getException(){return this.exception}};errList;constructor(t){super(t[0].exception.message),this.errList=t,Object.setPrototypeOf(this,Y.prototype)}getErr(){return this.errList}get message(){return this.errList[0].exception.message}getLocalizedMessage(){return this.errList[0].exception.message}}class ft extends G{static REST="r";static ALT="c";static DIV=4294967295;replaced=!1;lastReplaced=!1;prevNoteEvent;constructor(t,e=null){super(ft.REST,t,!1),this.prevNoteEvent=e}calcDivTick(t){return Math.ceil(ft.DIV*t/6e7)}vZero(t){for(let e=t.length-1;e>=0;e--){const n=t[e].lastIndexOf(ft.REST);if(n>=0){t[e]=t[e].substring(0,n)+ft.ALT+t[e].substring(n+1),this.prevNoteEvent&&this.prevNoteEvent.getVelocity()>0&&(t[e]=t[e].substring(0,n)+"v0"+t[e].substring(n),this.prevNoteEvent.setVelocity(0));return}}}getPrevNoteEvent(){return this.prevNoteEvent}isReplaced(){return this.replaced}isLastReplaced(){return this.lastReplaced}toMMLTextWithMotionFix(t){let e=this.tick,n="",s=0;const i=this.calcDivTick(t),r=G.getTick("1."),o=G.getTick("1");for(;e>o*2;){if(n+=this.mmlNotePart("1."),s+=r,s>=i){s=r;const c=[n];this.vZero(c),n=c[0],this.replaced=!0}e-=r}if(s+=e,n=this.makeMMLText(n,e),s>=i){const c=[n];this.vZero(c),n=c[0],this.replaced=this.lastReplaced=!0}return n}}class et{static globalVZeroTempo=!0;static setMMLVZeroTempo(t){this.globalVZeroTempo=t}eventList;startOffset;initOct;errList=[];percussionMotionFix;currentTempo=Z.INITIAL_TEMPO;static INIT_OCT=4;constructor(t,e,n,s){this.eventList=t,this.startOffset=e,this.initOct=n,this.percussionMotionFix=s}static create(t,e=0,n=et.INIT_OCT,s=!1){return new et(t,e,n,s)}makeTempoChar(t,e,n){const s=[!0,!0,!0,!0,!0,!0,!0];if(t)for(const i of[e.getTickOffset(),e.getEndTick()])for(const r of t){const o=r.searchOnTickOffset(i);if(o&&o.getOctave()===n){const a=o.toMMLString().toLowerCase().charAt(0).charCodeAt(0)-97;a>=0&&a<s.length&&(s[a]=!1)}}for(let i=0;i<s.length;i++){const r=(i+2)%s.length;if(s[r])return String.fromCharCode(97+r)}return"c"}insertRestNoteEvent(t,e,n){const s=n.getTickOffset()-e.getEndTick(),i=e.clone(),r=new ft(s,i);if(s>0)try{t.push(this.percussionMotionFix?r.toMMLTextWithMotionFix(this.currentTempo):r.toMMLText()),i.setTick(e.getTick()+s)}catch(o){this.errList.push(new Y.Entry(e,o))}return r}insertTempoMML(t,e,n,s,i){let r=e.clone();if(e.getEndTick()<n.getTickOffset()){const o=e.getOctave(),c=this.insertRestNoteEvent(t,e,n);if(r=c.getPrevNoteEvent()??r,s&&et.globalVZeroTempo&&!c.isLastReplaced()){const a=t.lastIndexOf("r");if(a>=0){t[a]="c";const l=new rt(t.join("")).getLastNote();try{const h=this.makeTempoChar(i??null,l,o),d=e.getVelocity()!==0?"v0"+h:""+h;t[a]=d}catch(h){this.errList.push(new Y.Entry(l,h))}r.setVelocity(0)}}}return t.push(n.toMMLString()),r}insertNoteWithTempo(t,e,n,s,i,r){const o=s.clone();for(;i&&e.length>0&&o.getTickOffset()<e[0].getTickOffset()&&e[0].getTickOffset()<o.getEndTick();){const c=e[0].getTickOffset(),a=c-o.getTickOffset();try{const h=G.minimumTick(),d=(()=>{try{return new G("c",a).toMMLText(),!0}catch{return!1}})();if(a<h||!d){console.warn("[builder tempo split skipped]",{segLen:a,minTick:h,anchorTick:c,noteStart:s.getTickOffset(),noteEnd:s.getEndTick()});break}}catch{}try{a<=32&&console.warn("[builder tempo split small segment]",{noteStart:s.getTickOffset(),noteEnd:s.getEndTick(),anchorTick:c,segLen:a,remainingBefore:o.getTick(),workingStart:o.getTickOffset(),tempo:e[0].getTempo()})}catch{}const l=new W(o.getNote(),a,o.getTickOffset(),o.getVelocity());try{n=this.insertRestNoteEvent(t,n,l).getPrevNoteEvent()??n,t.push(l.toMMLStringWithPrev(n))}catch(h){this.errList.push(new Y.Entry(l,h))}i&&t.push(e[0].toMMLString()),this.currentTempo=e[0].getTempo(),e.shift(),o.setTick(o.getTick()-a),o.setTickOffset(o.getTickOffset()+a),n=l,i&&o.getTick()>0&&t.push("&")}if(o.getTick()>0)try{n=this.insertRestNoteEvent(t,n,o).getPrevNoteEvent()??n,t.push(o.toMMLStringWithPrev(n))}catch(c){this.errList.push(new Y.Entry(o,c))}}makeLocalTempoList(t){const e=[...this.eventList.getGlobalTempoList()];for(;e.length>1&&e[1].getTickOffset()<=this.startOffset;)this.currentTempo=e[0].getTempo(),e.shift();return e}totalTickRelationPart(t){let e=this.eventList.getTickLength();if(t)for(const n of t)e<n.getTickLength()&&(e=n.getTickLength());return e}static searchRelationPartCanInsertTempo(t,e){if(t)for(const n of t){const s=n.searchOnTickOffset(e);if(!s||s.getTickOffset()===e)return!0}return!1}static searchRelationPartOnTick(t,e){if(t)for(const n of t){const s=n.searchOnTickOffset(e),i=n.searchPrevNoteOnTickOffset(e);if(s&&s.getTickOffset()===e||i&&i.getEndTick()===e)return!0}return!1}tickDeltaCheck(t){if(t===0)return!0;t<0&&(t=-t);const e=G.minimumTick();return!(t<e)}insertNoteWithTempoMusicQ(t,e,n,s,i,r){let o=i.clone(),c=n;for(;e.length>c;){const a=e[c],l=a.getTickOffset();if(o.getTickOffset()>=l||l>=o.getEndTick())break;if(et.searchRelationPartCanInsertTempo(r??null,l)){c++;continue}const h=a.getTickOffset()-o.getTickOffset(),d=new W(o.getNote(),h,o.getTickOffset(),o.getVelocity());try{s=this.insertRestNoteEvent(t,s,d).getPrevNoteEvent()??s,t.push(d.toMMLStringWithPrev(s))}catch(M){this.errList.push(new Y.Entry(d,M))}t.push(a.toMMLString()),e.splice(c,1),o.setTick(o.getTick()-h),o.setTickOffset(o.getTickOffset()+h),s=d,o.setVelocity(0)}if(o.getTick()>0)try{s=this.insertRestNoteEvent(t,s,o).getPrevNoteEvent()??s,t.push(o.toMMLStringWithPrev(s))}catch(a){this.errList.push(new Y.Entry(o,a))}return i.getVelocity()!==o.getVelocity()&&t.push("v"+i.getVelocity()),c}toMMLStringMusicQ(t,e,n=!1){const s=this.totalTickRelationPart(e),i=[];let r=0;for(;t.length>r+1&&t[r+1].getTickOffset()<=this.startOffset;)t.splice(r,1);let o=new W(12*this.initOct,0,this.startOffset,W.INIT_VOL);for(const c of this.eventList.getMMLNoteEventList()){for(;t.length>r;){const a=t[r],l=c.getTickOffset()-a.getTickOffset(),h=a.getTickOffset()-o.getEndTick();if(l>=0)!n||this.tickDeltaCheck(l)&&this.tickDeltaCheck(h)?(o=this.insertTempoMML(i,o,a,!0,e),this.currentTempo=t[r].getTempo(),t.splice(r,1)):r++;else break}r=this.insertNoteWithTempoMusicQ(i,t,r,o,c,e),o=c}for(;t.length>r;){const c=t[r].getTickOffset();if(c>=s)break;et.searchRelationPartOnTick(e??null,c)?r++:(o=this.insertTempoMML(i,o,t[r],!0,e),this.currentTempo=t[r].getTempo(),t.splice(r,1))}if(this.errList.length>0)throw new Y(this.errList);return i.join("")}toMMLString(){return this.toMMLStringFull(!1,!0)}toMMLStringFull(t,e,n){const s=this.totalTickRelationPart(n),i=this.makeLocalTempoList(s),r=[];let o=new W(12*this.initOct,0,this.startOffset,W.INIT_VOL);for(const c of this.eventList.getMMLNoteEventList()){for(;i.length>0&&i[0].getTickOffset()<=c.getTickOffset();)t&&(o=this.insertTempoMML(r,o,i[0],e,n)),this.currentTempo=i[0].getTempo(),i.shift();this.insertNoteWithTempo(r,i,o,c,t,e),o=c}for(;i.length>0;){const c=i[0];if(e&&c.getTickOffset()>=s)break;t&&(o=this.insertTempoMML(r,o,c,e,n)),this.currentTempo=i[0].getTempo(),i.shift()}if(this.errList.length>0)throw new Y(this.errList);return r.join("")}}class rt{noteList=[];tempoList;constructor(t,e,n=0){this.tempoList=e??[],this.parseMML(t,n)}parseMML(t,e){const n=new jt(t,e);for(;n.hasNext();){const s=n.next();s instanceof Z?s.appendToListElement(this.tempoList):s instanceof W&&this.noteList.push(s)}}setGlobalTempoList(t){this.tempoList=t}getGlobalTempoList(){return this.tempoList}getTickLength(){return this.noteList.length>0?this.noteList[this.noteList.length-1].getEndTick():0}isEmpty(){return this.noteList.length===0}getMMLNoteEventList(){return this.noteList}searchOnTickOffset(t){for(const e of this.noteList)if(e.getTickOffset()<=t){if(t<e.getEndTick())return e}else break;return null}searchOnTickOffsetNextNote(t){for(let e=0;e<this.noteList.length-1;e++){const n=this.noteList[e];if(n.getTickOffset()<=t&&t<n.getEndTick())return this.noteList[e+1]}return null}searchPrevNoteOnTickOffset(t){let e=null;for(const n of this.noteList){if(n.getTickOffset()>=t)break;e=n}return e}indexOfMMLString(t){let e=0;for(const n of this.noteList){const s=n.getIndexOfMMLString();if(s){if(n.getTickOffset()<=t){if(t<n.getEndTick())return s}else return[e,s[0]];e=s[1]}}return[e,e]}addMMLNoteEvent(t){if(t.getNote()<-1||t.getTick()<=0||t.getEndTick()<=0)return;let e=t.getTickOffset();e<0&&(t.setTick(t.getTick()+e),t.setTickOffset(0));let n=0;for(;n<this.noteList.length;n++){const s=this.noteList[n],i=s.getEndTick()-t.getTickOffset();if(t.getTickOffset()<s.getTickOffset())break;if(i>=0){const r=s.getTick()-i;if(r===0){this.noteList.splice(n,1);break}else{s.setTick(r),n++;break}}}for(this.noteList.splice(n++,0,t);n<this.noteList.length;){const s=this.noteList[n];if(t.getEndTick()-s.getTickOffset()>0)this.noteList.splice(n,1);else break}}isOverlapNote(t){let e=0;const n=this.noteList.length;for(;e<n;e++){const s=this.noteList[e];if(t.getTickOffset()<s.getEndTick()){if(t.getTickOffset()>=s.getTickOffset())return!0;break}}for(;e<n;e++){const s=this.noteList[e];if(t.getEndTick()<=s.getEndTick()){if(t.getEndTick()-1>=s.getTickOffset())return!0;break}}return!1}deleteMMLEvent(t){const e=this.noteList.indexOf(t);e>=0&&this.noteList.splice(e,1)}setVelocityCommand(t,e){this.setUnsetVelocityCommand(t,e,!0)}unsetVelocityCommand(t){this.setUnsetVelocityCommand(t,0,!1)}setUnsetVelocityCommand(t,e,n){const s=t.getVelocity();let i=W.INIT_VOL;for(const r of this.noteList)if(r.getTickOffset()>=t.getTickOffset())if(s===r.getVelocity())r.setVelocity(n?e:i);else break;else i=r.getVelocity()}toString(){return this.tempoList.toString()+this.noteList.toString()}clone(){const t=new rt("",this.tempoList.map(e=>e.clone()),0);return t.noteList=this.noteList.map(e=>e.clone()),t}getAlignmentStartTick(t,e){const n=t.searchOnTickOffset(e);return n==null||n.getTickOffset()===e?e:t.getAlignmentStartTick(this,n.getTickOffset())}getAlignmentEndTick(t,e){const n=t.searchOnTickOffset(e-1);return n==null||n.getEndTick()===e?e:t.getAlignmentEndTick(this,n.getEndTick())}swap(t,e,n){const s=[],i=[];for(const r of this.noteList)r.getTickOffset()>=e&&r.getEndTick()<=n&&s.push(r);for(const r of s)this.noteList.splice(this.noteList.indexOf(r),1);for(const r of t.getMMLNoteEventList())r.getTickOffset()>=e&&r.getEndTick()<=n&&i.push(r);for(const r of i)t.getMMLNoteEventList().splice(t.getMMLNoteEventList().indexOf(r),1),this.addMMLNoteEvent(r);for(const r of s)t.addMMLNoteEvent(r)}move(t,e,n){const s=[];for(const i of this.noteList)i.getTickOffset()>=e&&i.getEndTick()<=n&&s.push(i);for(const i of s)this.deleteMMLEvent(i),t.addMMLNoteEvent(i)}copy(t,e,n){for(const s of this.noteList)s.getTickOffset()>=e&&s.getEndTick()<=n&&t.addMMLNoteEvent(s.clone())}deleteMinRest(){const t=G.minimumTick();for(let e=1;e<this.noteList.length;e++){const n=this.noteList[e-1],i=this.noteList[e].getTickOffset()-n.getEndTick();if(i>0&&i<t){const r=n.getTick()-t+i;r>=t?n.setTick(r):n.setTick(n.getTick()+i)}}}transpose(t){for(const e of this.noteList)e.setNote(e.getNote()+t)}equals(t){if(!(t instanceof rt))return!1;const e=t,n=this.noteList.length===e.noteList.length&&this.noteList.every((i,r)=>i.equals(e.noteList[r])),s=this.tempoList.length===e.tempoList.length&&this.tempoList.every((i,r)=>i.equals(e.tempoList[r]));return n&&s}getLastNote(){return this.noteList.length>0?this.noteList[this.noteList.length-1]:null}getInternalMMLString(){return et.create(this).toMMLStringFull(!1,!1)}static maxEndTick(t){let e=0;for(const n of t){const s=n.getLastNote();s&&e<s.getEndTick()&&(e=s.getEndTick())}return e}}class P{static noteString="abcdefgABCDEFGnNrR";static tokenString=P.noteString+"tToOlLvV<>&, ";static tokenCache=new Map;mml_src;mml_length;mml_charArray;startIndex=0;endIndex=0;constructor(t){this.mml_src=t,this.mml_length=t.length,this.mml_charArray=t.split("")}hasNext(){return this.endIndex<this.mml_length}next(){return this.startIndex=this.endIndex,this.endIndex=this.searchToken(this.endIndex+1),this.mml_src.substring(this.startIndex,this.endIndex)}remove(){this.startIndex=0,this.endIndex=0}getStart(){return this.startIndex}getEnd(){return this.endIndex}getIndex(){return[this.startIndex,this.endIndex]}static isToken(t){return P.tokenString.indexOf(t)>=0}static isNote(t){return P.noteString.indexOf(t)>=0}static noteName(t){let e=t.substring(0,1);if(t.length>1){const n=t.charAt(1);(n==="+"||n==="-"||n==="#")&&(e+=n)}return e}static noteNames(t){const e=this.tokenCache.get(t);if(e)return e;const n=this.noteName(t),s=t.substring(n.length),i=[n,s];return this.tokenCache.set(t,i),i}static isLenOnly(t){return t.endsWith(".")&&(t=t.substring(0,t.length-1)),/^[0-9]+$/.test(t)}searchToken(t){let e;for(e=t;e<this.mml_length;e++){const n=this.mml_charArray[e];if(P.isToken(n))break}return e}backSearchToken(t){let e;for(e=t-1;e>=0;e--){const n=this.mml_charArray[e];if(P.isToken(n))break}return e}}class ut{static getOctaveString(t,e){const n=t-e;return Math.abs(n)>2?"o"+e:(n<0?">>":"<<").substring(0,Math.abs(n))}class_OptimizerMap=class extends Map{updateMapMinLength(e,n){const s=this.get(e);(!s||n.length()<s.length())&&this.set(e,n)}};createOptimizerMap(){return new this.class_OptimizerMap}map=this.createOptimizerMap();section="4";octave=4;octD=0;tokenStack=0;constructor(){this.map.set("4",new ot)}getMinString(){let t,e=Number.MAX_SAFE_INTEGER;for(const n of this.map.values()){const s=n.length();s<e&&(t=n,e=s)}return t?t.toString():""}addString(t,e=0){for(const n of this.map.values())e===0?n.append(t):n.insert(n.length()-e,t)}newBuilder(t,e,n,s){const i=t.length();return t.insert(i-s,"l"+e),t.append(n),t}extendPatternBuilder(t,e,n,s,i){}fixPattern(t){}addNoteText(t,e,n){let s=e;s===""?s=this.section:s==="."&&(s=this.section+".");const i=new Map,r=this.getMinString(),o=(c,a)=>{if(a.append(t),c!==s){s===c+"."?a.append("."):a.append(s);const l=new ot().append(r),h=this.newBuilder(l,s,t,n);if(this.updateMapMinLength(i,s,h),s.endsWith(".")){const d=s.substring(0,s.length-1),M=new ot().append(r),A=this.newBuilder(M,d,t+".",n);this.updateMapMinLength(i,d,A)}this.extendPatternBuilder(i,r,t,s,n)}};for(const[c,a]of this.map.entries())o(c,a);for(const[c,a]of i.entries())this.updateMapMinLength(this.map,c,a);vt.updateFlexDot(this.map,t,s),this.fixPattern(this.map)}updateMapMinLength(t,e,n){const s=t.get(e);(!s||n.length()<s.length())&&t.set(e,n)}cleanMap(){const t=this.getMinString().length;for(const[e,n]of[...this.map.entries()])n.length()>t+e.length+1&&this.map.delete(e)}resetOctave(){this.octave=4,this.octD=0}insertOxPattern(t){if(this.octD!==0){const e=this.octave+this.octD;this.addString(ut.getOctaveString(this.octave,e),t),this.octave=e,this.octD=0}}insertLxPattern(t,e,n){this.addNoteText(t,e,n)}doPattern(t,e,n){this.insertOxPattern(n),this.insertLxPattern(t,e,n)}doToken(t,e){if(t==="o")this.octD=parseInt(e,10)-this.octave;else if(t===">")this.octD++;else if(t==="<")this.octD--;else if(t==="l"){if(e&&this.section!==e){this.section=e,this.addString("l"+e,this.tokenStack);const n=this.getMinString(),s=this.createOptimizerMap();s.set(e,new class extends ot{}().append(n)),this.map=s}}else return!1;return!0}nextToken(t){const e=t.charAt(0).toLowerCase(),n=P.noteNames(t);if(e==="n"&&/^n\d+\.?$/i.test(t)){this.addString(t),this.tokenStack>0?this.tokenStack+=t.length:this.tokenStack=0;return}P.isNote(e)?(this.doPattern(n[0],n[1],this.tokenStack),this.tokenStack=0,this.cleanMap()):(this.doToken(e,n[1])||this.addString(t),e==="&"&&(this.tokenStack+=t.length))}}class ot{parts=[];append(t){return this.parts.push(t),this}toString(){return this.parts.join("")}length(){return this.parts.reduce((t,e)=>t+e.length,0)}reset(t){return this.parts=[t],this}insert(t,e){const n=this.toString(),s=n.slice(0,t),i=n.slice(t);return this.parts=[s,e,i],this}}class vt{static flexList=[64,32,16,8,4].map(t=>new vt(t));lCur;lNext;lPrev;constructor(t){this.lCur=t/2+".",this.lNext=""+t,this.lPrev=""+t/4}updatePattern(t,e,n){let s=e;/^[rR]$/.test(e)||(s="&"+e);const i=new Map,r=e+this.lPrev+s+this.lCur;for(const o of t.keys())if(o===this.lNext){const c=t.get(o).toString();if(c.endsWith(r)){const a=c.substring(0,c.length-r.length),l=this.lPrev+".",h=a+e+s+l,d=a+e+"l"+l+s,M=a+e+"l"+this.lPrev+s+".";i.set(o,new ot().append(h)),i.set(l,new ot().append(d)),i.set(this.lPrev,new ot().append(M))}}for(const[o,c]of i.entries()){const a=t.get(o);(!a||c.length()<a.length())&&t.set(o,c)}}static updateFlexDot(t,e,n){for(const s of this.flexList)if(n===s.lCur){s.updatePattern(t,e,n);break}}}class kt{builder=[];nCount=0;prevOct;offsetIndex=null;constructor(t,e=""){this.prevOct=t,e&&this.builder.push(e)}clone(){const t=new kt(this.prevOct);return t.builder=[...this.builder],t.nCount=this.nCount,this.offsetIndex!=null&&(t.offsetIndex=this.offsetIndex),t}length(){return this.builder.join("").length}toString(){return this.builder.join("")}addOctToken(t){this.offsetIndex==null&&(this.offsetIndex=t)}}class Ft{octave=4;builderList=[new kt(4)];lastNoteNumber=-1;minStack(t){return!Array.isArray(t)||t.length===0?new kt(this.octave):t.reduce((e,n)=>{const s=typeof e.length=="function"?e.length():String(e.toString?.()??"").length,i=typeof n.length=="function"?n.length():String(n.toString?.()??"").length;if(s!==i)return s<i?e:n;const r=e.nCount??0,o=n.nCount??0;return r!==o?r<o?e:n:e})}getCurrentNoteNumber(){return this.lastNoteNumber}calcNoteNumber(t){const e={c:0,d:2,e:4,f:5,g:7,a:9,b:11},n=t.toLowerCase(),s=n.charAt(0);if(!(s in e))return-1;let i=e[s];if(n.length>1){const o=n.charAt(1);o==="+"?i+=1:o==="-"?i-=1:o==="#"&&(i+=1)}return this.octave*12+i}listClone(){return this.builderList.map(t=>t.clone())}cleanList(){const t=this.minStack(this.builderList);this.builderList.length=0,this.builderList.push(t)}clearOctToken(){this.builderList.forEach(t=>t.offsetIndex=null)}addNoteToken(t){this.builderList.forEach(e=>{e.builder.push(this.getOctaveString(e.prevOct,this.octave)),e.builder.push(t),e.prevOct=this.octave}),this.clearOctToken()}addToken(t){this.builderList.forEach(e=>e.builder.push(t))}addPattern(t){const e=this.getCurrentNoteNumber();e<0||e>96||(t.forEach(n=>{n.builder.push("n"+e),n.nCount++}),this.builderList.push(this.minStack(t)),this.clearOctToken())}notePattern(t,e,n){const s=this.listClone();this.addNoteToken(t),this.cleanList(),n.length===0&&this.addPattern(s)}doToken(t){const e=P.noteNames(t),n=e[0].charAt(0).toLowerCase();n>="a"&&n<="g"?(this.lastNoteNumber=this.calcNoteNumber(e[0]),this.notePattern(t,e[0],e[1])):n===">"?(this.octave++,this.addOctToken(t)):n==="<"?(this.octave--,this.addOctToken(t)):n==="o"?(this.octave=parseInt(e[1]||"4",10),this.addOctToken(t)):this.addToken(t)}getOctaveString(t,e){const n=t-e;return Math.abs(n)>2?"o"+e:n===0?"":n<0?">".repeat(-n):"<".repeat(n)}addOctToken(t){this.builderList.forEach(e=>{try{if(e&&typeof e.addOctToken=="function"&&Array.isArray(e.builder))e.addOctToken(e.builder.join("").length);else{const n=Array.isArray(e.builder)?e.builder.join("").length:0;e.offsetIndex==null&&(e.offsetIndex=n)}}catch{}})}nextToken(t){this.doToken(t)}getMinString(){return this.minStack(this.builderList).toString()}}class dt extends Ft{map=new Map;disableNopt;constructor(t,e,n){typeof t=="boolean"?(super(),this.disableNopt=t):(super(),this.octave=t,this.disableNopt=n===!0,this.builderList.length=0,this.builderList.push(new class{builder=[e||""];nCount=0;prevOct=t;offsetIndex=null}),this.parser.setOctave(t))}addTokenVariant(t,e,n){let s=t.builder.join("");t.prevOct!==e&&(s+=this.getOctaveString(t.prevOct,e)),s+=n;const i=this.map.get(e);(!i||i.length>s.length)&&this.map.set(e,s)}notePattern(t,e,n){this.builderList.forEach(s=>{if(this.addTokenVariant(s,this.octave,t),e==="b"?this.addTokenVariant(s,this.octave+1,"c-"+n):e==="c"&&this.addTokenVariant(s,this.octave-1,"b+"+n),!this.disableNopt&&s.prevOct!==this.octave&&n.length===0){const i=this.getCurrentNoteNumber();i>=0&&i<=96&&this.addTokenVariant(s,s.prevOct,"n"+i)}}),this.builderList=[];for(const[s,i]of this.map.entries())this.builderList.push(new class{builder=[i];nCount=0;prevOct=s;offsetIndex=null});this.map.clear()}getOptimizedLength(){return this.getMinString().length}static optimizeTail(t,e,n,s){const i=new dt(t,e,s),r=new P(n);for(;r.hasNext();)i.nextToken(r.next());return i.getOptimizedLength()}}class F extends ut{constructor(t){super(),this.disableNopt=t}static FixPattern=class{constructor(e,n,s){this.lStr=e,this.match=n,this.replace=s}patternApply(e,n){if(e===this.lStr||this.lStr==="*"){const s=n.toString();if(s.endsWith(this.match)){const i=s.length-this.match.length,r=s.substring(0,i)+this.replace;n.reset(r)}}}};static pattern=[new F.FixPattern("32","r16.","rrr"),new F.FixPattern("64","r32.","rrr")];createOptimizerMap(){const t=super.createOptimizerMap(),e=this.disableNopt,n=(o,c)=>{let a=0;const l=Math.min(o.length,c.length);for(;a<l&&o.charAt(a)===c.charAt(a);)a++;for(a--,a<0&&(a=0);a>0;){const h=o.charAt(a);if(P.isToken(h)||P.isNote(h))break;a--}return a},s=o=>{let c=4;const a=o.split("");for(let l=0;l<a.length;l++)switch(a[l]){case"<":c--;break;case">":c++;break;case"o":case"O":l++,l<a.length&&(c=a[l].charCodeAt(0)-48);break}return c},i=new Map;b.addCacheList(i);const r=(o,c,a)=>{const l=o.length+":"+c+":"+a+":"+(e?"1":"0"),h=i.get(l);if(h!==void 0)return h;const d=new dt(a,o,e),M=new P(c);for(;M.hasNext();)d.nextToken(M.next());const A=d.getMinString().length;return i.set(l,A),A};return t.updateMapMinLength=(o,c)=>{const a=t.get(o);if(!a){t.set(o,c);return}const l=c.toString(),h=a.toString(),d=n(l,h),M=s(l.substring(0,d)),A=l.substring(0,d),R=r(A,l.substring(d),M),D=r(A,h.substring(d),M);R<D&&t.set(o,c)},t}fixPattern(t){for(const[e,n]of t.entries())for(const s of F.pattern)s.patternApply(e,n)}extendPatternBuilder(t,e,n,s,i){const r=e.lastIndexOf("l");let o="4";if(r>=0&&(o=new P(e.substring(r)).next().substring(1)),i>0&&!o.endsWith(".")&&e.endsWith(n+"&")&&s===((parseInt(o)<<1)+".").toString()){const c=""+(parseInt(o)<<2),a=e.substring(0,e.length-1)+"."+e.substring(e.length-1);let l=t.get(c);l||(l=new class{parts=[];append(h){return this.parts.push(h),this}toString(){return this.parts.join("")}length(){return this.parts.reduce((h,d)=>h+d.length,0)}insert(h,d){const M=this.toString();return this.parts=[M.slice(0,h),d,M.slice(h)],this}reset(h){return this.parts=[h],this}}),l.reset(a),t.set(c,l)}}}class Zt extends Map{constructor(t){super(),this.max=t}order=[];get(t){const e=super.get(t);if(e!==void 0){const n=this.order.indexOf(t);n>=0&&(this.order.splice(n,1),this.order.push(t))}return e}set(t,e){if(super.has(t)){const n=this.order.indexOf(t);n>=0&&(this.order.splice(n,1),this.order.push(t))}else if(this.order.push(t),this.order.length>this.max){const n=this.order.shift();n!==void 0&&super.delete(n)}return super.set(t,e)}delete(t){const e=this.order.indexOf(t);return e>=0&&this.order.splice(e,1),super.delete(t)}clear(){this.order=[],super.clear()}}class mt{constructor(t=""){this.buf=t}append(t){return this.buf+=t,this}toString(){return this.buf}length(){return this.buf.length}delete(t,e){return this.buf=this.buf.slice(0,t)+this.buf.slice(e),this}replace(t,e,n){return this.buf=this.buf.slice(0,t)+n+this.buf.slice(e),this}substring(t,e){return this.buf.substring(t,e)}insert(t,e){return this.buf=this.buf.slice(0,t)+e+this.buf.slice(t),this}}class Ot extends F{static altPatterns=[new F.FixPattern("64","42","."),new F.FixPattern("32","21","."),new F.FixPattern("24","r12","rr"),new F.FixPattern("32","r16","rr"),new F.FixPattern("48","r24","rr"),new F.FixPattern("64","r32","rr"),new F.FixPattern("24","r12.","rrr"),new F.FixPattern("32","r16.","rrr"),new F.FixPattern("48","r24.","rrr"),new F.FixPattern("64","r32.","rrr"),new F.FixPattern("4","r3r9r16","rr5r17")];altPatternMap=new F.OptimizerMap;constructor(t){super(t)}fixPattern(t){this.altPatternMap.clear();for(const[e,n]of t.entries())this.tickAltPattern(this.altPatternMap,e,n);for(const[e,n]of this.altPatternMap.entries())t.updateMapMinLength(e,n);for(const[e,n]of t.entries())for(const s of Ot.altPatterns)s.patternApply(e,n);super.fixPattern(t)}tickAltPattern(t,e,n){const s=n.toString();let i=s.length,r=i;for(;r>0&&!P.isNote(s.charAt(--r)););if(r===0)return;const o=P.noteNames(s.substring(r,i));let c=r-1;if(o[0]==="r")c++;else if(s.charAt(c)!=="&")return;let a=c;for(;a>0&&!P.isNote(s.charAt(--a)););const l=P.noteNames(s.substring(a,c));if(l[0]!==o[0]||l[0]==="n"||o[0]==="n")return;const h=l[0]!=="r"?"&":"";try{const d=ct.getAltList(l[1],o[1],e);if(d){const M=s.substring(0,a),A=d.filter(R=>!R.getLStr().present).map(R=>l[0]+(R.getNeedDot()?"."+h:h)+o[0]+R.getAltPattern()).sort();A.length>0&&(n.delete(a,i),n.append(A[0]));for(const R of d){const D=R.getAltPattern(),Q=R.getLStr();if(Q.present)t.updateMapMinLength(Q.value,new mt(M+"l"+Q.value+l[0]+D+h+o[0]));else if(R.getNeedDot())t.updateMapMinLength(D,new mt(M+l[0]+"."+(e!==D?"l"+D:"")+h+o[0]));else{if(D.endsWith(".")){const H=D.slice(0,-1);t.updateMapMinLength(H,new mt(M+l[0]+(e!==H?"l"+H:"")+h+o[0]+"."))}t.updateMapMinLength(D,new mt(M+l[0]+"l"+D+h+o[0]))}}}}catch{}}}class ct{constructor(t,e,n=null){this.altPattern=t,this.needDot=e,this.lStr=n}static altCache=new Zt(256);getAltPattern(){return this.altPattern}getNeedDot(){return this.needDot}getLStr(){return{present:this.lStr!=null,value:this.lStr}}static getAltList(t,e,n){if(!P.isLenOnly(t)||!P.isLenOnly(e))return null;const s=t+"&"+e+":"+n,i=this.altCache.get(s);if(i!==void 0)return i;const r=G.getTick(t)+G.getTick(e),o=G.getAlt(r),c=[];if(o&&o.alt)for(const l of o.alt){let h=!1;for(let d=0;d<l.length;d++){const M=l[d===0?1:0],A=l[d];n===A?(c.push(new ct(M,!1)),h=!0):n+"."===A&&(M.endsWith(".")||(c.push(new ct(M,!0)),h=!0))}if(!h){const d=l[0],M=l[1];M+"."===d&&(c.push(new ct(".",!1,M)),c.push(new ct(M,!1,d)))}}const a=c.length>0?c:null;return this.altCache.set(s,a),a}}const Qt=ct.altCache;class wt{static pattern=[new F.FixPattern("*","r1.r2","r1r1")];sb="";nextToken(t){this.sb+=t;for(const e of wt.pattern)e.patternApply("",{toString:()=>this.sb,reset:n=>(this.sb=n,this)})}getMinString(){return this.sb}}class Et{tokens=[];nextToken(t){this.tokens.push(t)}getMinString(){if(this.tokens.length===0)return"";const t=this.tokens.join(""),e=[],n=r=>/[a-gA-G]/.test(r),s=r=>{let o=r+1;if(o<t.length){const c=t[o];(c==="+"||c==="-"||c==="#")&&o++}for(;o<t.length&&/[0-9.]/.test(t[o]);)o++;return{token:t.slice(r,o),next:o}};let i=0;for(;i<t.length;){const r=t[i];if(r==="<"){const o=i+1;if(o<t.length&&n(t[o])&&t[o].toLowerCase()==="b"){const{token:c,next:a}=s(o);if(/^[bB][+#-]/.test(c)){e.push(r),i++;continue}if(a<t.length&&t[a]===">"){let l=!1;for(let h=o+1;h<a;h++)if(n(t[h])){l=!0;break}if(!l){const h=(c[0]==="B"?"C-":"c-")+c.slice(1).replace(/^[+#-]?/,"").replace(/^([0-9].*)$/,"$1");e.push(h),i=a+1;continue}}}}else if(r===">"){const o=i+1;if(o<t.length&&n(t[o])&&t[o].toLowerCase()==="c"){const{token:c,next:a}=s(o);if(/^[cC][+#-]/.test(c)){e.push(r),i++;continue}if(a<t.length&&t[a]==="<"){let l=!1;for(let h=o+1;h<a;h++)if(n(t[h])){l=!0;break}if(!l){const h=(c[0]==="C"?"B+":"b+")+c.slice(1).replace(/^[+#-]?/,"").replace(/^([0-9].*)$/,"$1");e.push(h),i=a+1;continue}}}}e.push(r),i++}return e.join("")}}class b{constructor(t){this.originalMML=t}static GEN1=1;static GEN2=2;static GEN3=3;static debug=!1;static optLevel=1;static mmlCache=new Map;static cacheList=[b.mmlCache];static currentContext=null;static setDebug(t){this.debug=t}static getDebug(){return this.debug}static setOptimizeLevel(t){this.optLevel=t}static clearAllCache(){this.cacheList.forEach(t=>t.clear())}static addCacheList(t){this.cacheList.includes(t)||this.cacheList.push(t)}static setContext(t){this.currentContext=t}static getContext(){return this.currentContext}static initAltPatternCache=(b.addCacheList(Qt),!0);disableNopt=!1;toString(){return this.cachedOptimize(b.GEN1,!1)}preciseOptimize(){return this.cachedOptimize(b.optLevel,this.disableNopt)}setDisableNopt(t){return this.disableNopt=t,this}cachedOptimize(t,e){const n=t+":"+e+":"+this.originalMML,s=b.mmlCache.get(n);if(s)return s;let i;if(t===b.GEN2){const r=this.optimizeGen2();i=this.fallbackIfChanged(r,e)}else if(t===b.GEN3){const r=this.optimizeGen3();i=this.fallbackIfChanged(r,e)}else i=this.optimize(e);return b.mmlCache.set(n,i),i}optimizeGen2(){return this.optimizeChain([new F(this.disableNopt),new dt(this.disableNopt)])}optimizeGen3(){return this.optimizeChain([new Ot(this.disableNopt),new dt(this.disableNopt),new wt])}optimizeForTextEditor(){return this.optimizeChain([new F(!0)])}optimize(t){return t?this.optimizeChain([new ut,new Et]):this.optimizeChain([new ut,new Et,new Ft])}optimizeChain(t){let e=this.originalMML;for(const n of t){const s=new P(e);for(;s.hasNext();){let i=null;try{i=s.next(),n.nextToken(i)}catch(r){try{console.error("[MML optimize token error]",{context:b.getContext(),optimizer:n?.constructor?.name,token:i,index:s.getIndex(),mmlSnippet:e.slice(Math.max(0,s.getStart()-20),Math.min(e.length,s.getEnd()+20)),error:r})}catch{}throw r}}e=n.getMinString()}return e}fallbackIfChanged(t,e){return this.quickEquivalent(this.originalMML,t)?t:this.optimize(e)}quickEquivalent(t,e){if(t===e)return!0;const n=this.tokenCounts(t),s=this.tokenCounts(e),i=Object.keys(n),r=Object.keys(s);if(i.length!==r.length)return!1;for(const o of i)if(n[o]!==s[o])return!1;return!0}tokenCounts(t){const e={},n=new P(t);for(;n.hasNext();){const s=n.next();e[s]=(e[s]||0)+1}return e}}function Ht(T,t,e=0){const n=[];t.slice().sort((o,c)=>o.tickOffset-c.tickOffset).forEach((o,c)=>new Z(o.tempo,o.tickOffset,c===0).appendToListElement(n));const s=new rt("",n,e),i=T.slice().sort((o,c)=>o.offset-c.offset);for(const o of i)try{const c=o.velocity==null?W.INIT_VOL:o.velocity;if(!(o.tick>0)){console.warn("[buildEventList skip non-positive tick]",{ctx:b.getContext?.(),n:o});continue}const a=new W(o.note,o.tick,o.offset,c);s.addMMLNoteEvent(a)}catch(c){console.warn("[buildEventList note error]",{ctx:b.getContext?.(),n:o,err:c})}return s.getMMLNoteEventList().length===0&&i.length>0&&console.warn("[buildEventList result empty]",{ctx:b.getContext?.(),inputCount:i.length,first:i[0],last:i[i.length-1]}),s}function Dt(T,t,e={}){try{console.log("[noteToMML enter]",{ctx:b.getContext?.(),notes:T?.length,tempos:t?.length})}catch{}Array.isArray(T)||(T=[]),Array.isArray(t)||(t=[]);const{startOffset:n=0,initOct:s=4,percussionMotionFix:i=!1,mabiTempo:r=!0,includeTempo:o=!0,optimizeLevel:c=2,disableNopt:a=!1}=e,l=Ht(T,t,n),d=et.create(l,n,s,i).toMMLStringFull(o,r),M=b.optLevel;let A=d;try{b.setOptimizeLevel(c),A=new b(d).setDisableNopt(a).preciseOptimize()}catch(Q){try{console.warn("[noteToMML optimize error]",{ctx:b.getContext?.(),err:Q})}catch{}A=d}finally{try{b.setOptimizeLevel(M)}catch{}}let R=A,D=!1;try{const Q=new rt(A,[],n);if(!l.equals(Q)){try{const H=d,at=A;let q=0;const gt=Math.min(H.length,at.length);for(;q<gt&&H[q]===at[q];q++);console.warn("[MML optimize fallback mismatch]",{context:b.getContext?.(),reason:"event-inequality",firstDiffPos:q,origSnippet:H.slice(Math.max(0,q-20),q+20),optSnippet:at.slice(Math.max(0,q-20),q+20)})}catch{}R=d,D=!0}}catch{R=d,D=!0}try{console.log("[noteToMML exit]",{ctx:b.getContext?.(),rawLen:d.length,finalLen:R.length,fallbackUsed:D})}catch{}return{original:d,optimized:R,fallbackUsed:D}}function Kt(T,t=0){const e=new rt(T,[],t),n=e.getMMLNoteEventList().map(i=>({note:i.getNote(),tick:i.getTick(),offset:i.getTickOffset(),velocity:i.getVelocity()})),s=e.getGlobalTempoList().map((i,r)=>({tempo:i.getTempo(),tickOffset:i.getTickOffset()}));return{eventList:e,notes:n,tempos:s}}function zt(T){return T.map(t=>({note:t.pitch,tick:t.durationTick,offset:t.startTick,velocity:t.volume}))}function It(T,t=[],e=!0){try{console.log("[notesToMML enter]",{ctx:b.getContext?.(),noteCount:T?.length,tempoCount:t?.length});const n=Dt(zt(T),t,{includeTempo:e});return console.log("[notesToMML result]",{ctx:b.getContext?.(),optimizedLen:n.optimized?.length,originalLen:n.original?.length,fallback:n.fallbackUsed}),n.optimized||n.original||""}catch(n){return console.warn("[notesToMML error]",{ctx:b.getContext?.(),err:n}),Rt(T,t)}}function At(T,t=[],e=!0){try{console.log("[notesToMMLRaw enter]",{ctx:b.getContext?.(),noteCount:T?.length,tempoCount:t?.length});const n=Dt(zt(T),t,{includeTempo:e});return console.log("[notesToMMLRaw result]",{ctx:b.getContext?.(),optimizedLen:n.optimized?.length,originalLen:n.original?.length,fallback:n.fallbackUsed}),n.original||n.optimized||""}catch(n){return console.warn("[notesToMMLRaw error]",{ctx:b.getContext?.(),err:n}),Rt(T,t)}}function Pt(T){const t=b.optLevel;b.setOptimizeLevel(2);const e=new b(T).preciseOptimize();return b.setOptimizeLevel(t),e}function se(T){const t=Kt(T),e=t.notes.map(s=>new Ut(crypto.randomUUID(),s.note,s.offset,s.tick,s.velocity??15)),n=t.tempos.map(s=>({tempo:s.tempo,tickOffset:s.tickOffset}));return{notes:e,tempos:n}}function Rt(T,t){try{const e=[];t.slice().sort((i,r)=>i.tickOffset-r.tickOffset).forEach((i,r)=>new Z(i.tempo,i.tickOffset,r===0).appendToListElement(e));const n=new rt("",e,0);return T.slice().sort((i,r)=>i.startTick-r.startTick).forEach(i=>{try{n.addMMLNoteEvent(new W(i.pitch,i.durationTick,i.startTick,i.volume??15))}catch{}}),et.create(n,0,4,!1).toMMLStringFull(!0,!0)||""}catch{return""}}function Jt(T){try{const v=T.tracks.map(x=>({trackId:x.id,name:x.name,order:x.order,notes:(x.notes||[]).map(g=>({startTick:g.startTick,durationTick:g.durationTick,pitch:g.pitch,volume:g.volume}))})),m=T.tempoAnchors||[];console.log("[convertModal open] track events snapshot",{tracks:v,tempoAnchors:m})}catch(v){try{console.warn("[convertModal open] logging failed",v)}catch{}}const t=document.createElement("div");t.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
   `;const e=document.createElement("div");e.style.cssText=`
      background: #fff;
      padding: 24px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
   `;const n=document.createElement("div");n.style.cssText=`
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #eee;
      padding: 8px;
      margin-bottom: 16px;
   `;const s=document.createElement("div");s.style.cssText=`
            display: flex;
            align-items: center;
            gap: 8px;
        `;const i=document.createElement("label");i.setAttribute("for","convertFilenameInput"),i.textContent=st[it].convertFilenameLabel||"파일명",i.setAttribute("data-i18n","convertFilenameLabel"),i.style.cssText=`
            min-width: 72px;
            color: #666;
            font-size: 12px;
        `;const r=document.createElement("input");r.type="text",r.id="convertFilenameInput",r.placeholder=st[it].convertFilenamePlaceholder||"예: my-song.txt",r.setAttribute("data-i18n-placeholder","convertFilenamePlaceholder"),r.style.cssText=`
            flex: 1 1 auto;
            padding: 6px 8px;
            border: 1px solid #cfcfcf;
            border-radius: 6px;
            font-size: 12px;
        `;const o=new Date().toISOString().replace(/[:.]/g,"-");r.value=`mml-${o}.txt`,s.append(i,r);const c=document.createElement("textarea");c.style.cssText=`
            width: 100%;
            min-height: 200px;
            box-sizing: border-box;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            word-break: break-all;
            overflow-y: auto;
        `,c.readOnly=!1;const a=document.createElement("div");a.style.cssText=`
      display: flex;
      justify-content: flex-end;
      gap: 8px;
   `,Gt();const l=document.createElement("label");l.style.cssText=`
            display: flex;
            align-items: center;
            gap: 4px;
            margin-right: auto; /* 왼쪽으로 붙여 나머지 버튼들과 공간 확보 */
            font-size: 12px;
            cursor: pointer;
            user-select: none;
            color: #555;
        `;const h=document.createElement("input");h.type="checkbox",h.id="mobinogiSpeedBugFix",h.style.cursor="pointer";const d=document.createElement("span");d.textContent="모비노기 변속버그 수정",l.append(h,d),h.addEventListener("change",()=>{h.checked?Bt():pt()});const M=Mt({label:st[it].convertCopy,variant:"primary",attrs:{"data-i18n":"convertCopy"}}),A=Mt({label:st[it].convertSaveTxt,variant:"secondary",attrs:{"data-i18n":"convertSaveTxt"}}),R=Mt({label:st[it].modalClose,variant:"secondary",attrs:{"data-i18n":"modalClose"}});a.append(l,M,A,R),e.append(n,s,a,c),t.appendChild(e),document.body.appendChild(t);function D(){window.removeEventListener("keydown",Q,!0),t.parentNode&&document.body.removeChild(t)}function Q(v){v.key==="Escape"&&D()}n.innerHTML="";let H=[];const at=new Map,q=()=>{let m=c.value||"";m.startsWith("MML@")&&(m=m.slice(4)),m.endsWith(";")&&(m=m.slice(0,-1));const x=m.length>0?m.split(",").map(g=>g.trim()):[];for(const g of T.tracks){const k=at.get(g.id);if(!k)continue;const I=H.indexOf(g.id),L=I>=0&&I<x.length?x[I].length:0;k.textContent=`${g.name} (${L}${st[it].charUnit})`}};[...T.tracks].slice().sort((v,m)=>v.order-m.order).forEach(v=>{const m=document.createElement("div");m.style.cssText=`
            display: flex;
            align-items: center;
            margin-bottom: 8px;
         `;const x=document.createElement("input");x.type="checkbox",x.id=`track-${v.id}`,x.value=String(v.id),x.checked=v.notes.length>0,x.disabled=v.notes.length===0,x.style.margin="0 4px 0 0",x.style.cursor="pointer";const g=document.createElement("label");g.htmlFor=`track-${v.id}`,at.set(v.id,g),g.textContent=`${v.name}`,g.style.cssText=`
                margin-left: 8px;
                ${v.notes.length===0?"color: #aaa;":""}
            `,x.addEventListener("change",()=>{pt(),q()}),m.append(x,g),n.appendChild(m)});function gt(v){return(v.tempoAnchors||[]).map(k=>{if(!k)return null;const I=typeof k.getTickOffset=="function"?k.getTickOffset():typeof k.tick=="number"?k.tick:0,L=typeof k.getTempo=="function"?k.getTempo():typeof k.bpm=="number"?k.bpm:typeof k.tempo=="number"?k.tempo:120;return{tick:I,tempo:L}}).filter(Boolean).slice().sort((k,I)=>k.tick-I.tick).map((k,I)=>({tickOffset:k.tick,tempo:k.tempo,isFirst:I===0}))}function Vt(v){const m=v.slice().sort((L,K)=>L.order-K.order),x=[],g=gt(T);let k=g.length===0,I=0;for(const L of m){if(!(Array.isArray(L.notes)&&L.notes.length>0)){try{console.warn("[convertModal skip track - no notes]",{trackId:L.id,name:L.name})}catch{}continue}try{b.setContext(`track-${L.id}:${L.name}`)}catch{}let p="";try{console.log("[convertModal gen start]",{trackId:L.id,name:L.name,notes:L.notes?.length,tempos:g.length});const z=I===0;if(p=It(L.notes??[],g,z)||"",p||(p=At(L.notes??[],g,z)||""),!p)try{const C=window.notesToMMLFallback?window.notesToMMLFallback:null;C&&(p=C(L.notes,g)||"")}catch{}console.log("[convertModal gen after noteToMML]",{trackId:L.id,bodyLen:p.length,startsWithTempo:/^t\d+/i.test(p)})}catch(z){console.warn("[convertModal gen error noteToMML]",{trackId:L.id,err:z})}if(!p)try{const z=(()=>{const C=L.notes.map(J=>J.durationTick).sort((J,lt)=>J-lt);return{noteCount:L.notes.length,minDur:C[0],maxDur:C[C.length-1],uniqueSmall:Array.from(new Set(C.filter(J=>J<=64))).slice(0,10)}})();console.warn("[convertModal empty body diagnostics]",{trackId:L.id,stats:z,firstNote:L.notes[0]})}catch{}if(I===0)if(!k&&p){const z=g.length?g[0].tempo:120;/^t\d+/i.test(p)||(p="t"+z+p),k=!0}else k&&g.length===0&&p&&!/^t\d+/i.test(p)&&(p="t120"+p,k=!0);else p=p.replace(/^t\d+/i,"");if(p)try{const z=p;p=Pt(p)||p,console.log("[convertModal optimize done]",{trackId:L.id,beforeLen:z.length,afterLen:p.length})}catch(z){console.warn("[convertModal optimize error]",{trackId:L.id,err:z})}p?(x.push(p),I++,console.log("[convertModal track included]",{trackId:L.id,finalLen:p.length})):console.warn("[convertModal track empty after generation]",{trackId:L.id});try{b.setContext(null)}catch{}}return`MML@${x.join(",")};`}let yt=null;function $t(v,m,x,g){if(!v)return`[split:note need=${m} i=${x} j=${g}]`;const k=yt;let I=k&&k[x]?k[x][g]:"";if(!I)return`[split:rest need=${m} i=${x} j=${g} status=empty]`;const L=E=>{const N=[],j=/(l\d+\.?|r\d*\.?)/gi;let tt,X=4,$=!1;for(;(tt=j.exec(E))!==null;){const B=tt[0];if(/^l/i.test(B)){const _=B.match(/l(\d+)(\.)?/i);_&&(X=parseInt(_[1],10)||X,$=!!_[2]);continue}if(/^r/i.test(B)){const _=B.match(/r(\d*)(\.)?/i);let nt=null,Nt=!1;if(_){const St=_[1];St&&(nt=parseInt(St,10)),Nt=!!_[2]}const bt=nt??X,Ct=Nt||nt==null&&$,Wt=Ct?bt*1.5:bt;N.push({token:B,rawLen:bt,effectiveLen:Wt,index:tt.index,dotted:Ct,explicit:nt!=null,baseLAtToken:X,baseLDottedAtToken:$})}}return N};let K=L(I);if(K.length===0)return`[split:rest need=${m} i=${x} j=${g} status=noRestFound]`;let p=K.filter(E=>!E.dotted),z=m;if(p.length===0){const E=K.filter(N=>N.dotted);if(E.length>0){let N=E[0];for(let $=1;$<E.length;$++)E[$].effectiveLen>N.effectiveLen&&(N=E[$]);const j=N.rawLen,tt="r"+j,X="r"+j*2;z=Math.max(0,z-1);try{const $=I.slice(0,N.index),B=I.slice(N.index+N.token.length);!/\./.test(N.token)&&N.baseLDottedAtToken,I=$+tt+X+B}catch{}K=L(I),p=K.filter($=>!$.dotted)}}if(p.length===0)return`[split:rest need=${z} i=${x} j=${g} status=noNonDottedAfterSplit]`;let C=p[0];for(let E=1;E<p.length;E++){const N=p[E];(N.effectiveLen>C.effectiveLen||N.effectiveLen===C.effectiveLen&&C.explicit&&!N.explicit)&&(C=N)}const J=I.slice(0,C.index),lt=I.slice(C.index+C.token.length),f=C.baseLAtToken,O=C.baseLDottedAtToken,u=C.rawLen;let w=z,y=[u];for(;w>0;){let E=0;for(let j=1;j<y.length;j++)y[j]<y[E]&&(E=j);const N=y[E];y.splice(E,1,N*2,N*2),w--}y.sort((E,N)=>E-N);let S="",V=-1,U=0;const ht=()=>{U>0&&(S+="l"+V+"r".repeat(U))};for(const E of y)E!==V?(ht(),V=E,U=1):U++;ht(),(f!==V||O)&&(S+="l"+f+(O?".":""));const Tt=J+S+lt;return(E=>{let N="",j=0,tt=null,X=!1;const $=/l(\d+)(\.)?/gi;let B;for(;(B=$.exec(E))!==null;){N+=E.slice(j,B.index);const _=parseInt(B[1],10),nt=!!B[2];tt===_&&X===nt||(N+=B[0],tt=_,X=nt),j=$.lastIndex}return N+=E.slice(j),N})(Tt)}function pt(){const v=[];n.querySelectorAll('input[type="checkbox"]').forEach(g=>{g.checked&&v.push(parseInt(g.value))});const m=T.tracks.filter(g=>v.includes(g.id));H=m.slice().sort((g,k)=>g.order-k.order).map(g=>g.id);const x=Vt(m);c.value=x,q()}function Bt(){const v=[];n.querySelectorAll('input[type="checkbox"]').forEach(f=>{const O=f;O.checked&&v.push(parseInt(O.value))});const m=T.tracks.filter(f=>v.includes(f.id)).slice().sort((f,O)=>f.order-O.order);if(m.length===0){try{console.log("[tempoFix] no selected tracks")}catch{}return}const x=gt(T),g=[],k=[];m.forEach(f=>{if(!(Array.isArray(f.notes)&&f.notes.length>0))return;try{b.setContext(`tempoFix-track-${f.id}:${f.name}`)}catch{}let u="";try{if(u=It(f.notes??[],x,!0)||"",u||(u=At(f.notes??[],x,!0)||""),!u)try{const S=window.notesToMMLFallback?window.notesToMMLFallback:null;S&&(u=S(f.notes,x)||"")}catch{}}catch(S){try{console.warn("[updateMMLOutputWithTempoFix gen error]",{trackId:f.id,err:S})}catch{}}if(!u)return;if(/^t\d+/i.test(u)||(u="t"+(x.length?x[0].tempo:120)+u),!/n\d+/i.test(u))try{u=Pt(u)||u}catch{}const y=[];u.replace(/t\d+/gi,S=>(y.push(S),S)),k.push(y),u=I(u),g.push(u);try{b.setContext(null)}catch{}});function I(f){let O="4",u=!1;const w=/(t\d+|l\d+\.?)/gi;let y="",S=0,V;for(;(V=w.exec(f))!==null;){y+=f.slice(S,V.index);const U=V[0];if(/^l/i.test(U))O=U.slice(1),y+=U;else if(/^t/i.test(U))if(y+=U,!u)u=!0;else{const ht=f.slice(w.lastIndex);/^l\d+/i.test(ht)||(y+="l"+O)}S=w.lastIndex}return y+=f.slice(S),y}const L=g.map(f=>{const O=[],u=/t\d+/gi;let w=0,y;for(;(y=u.exec(f))!==null;){const V=f.slice(w,y.index);V.length>0&&O.push(V),w=u.lastIndex}const S=f.slice(w);return S.length>0&&O.push(S),O});yt=L;const K=/[abcdefgrn]/gi,p=L.map(f=>f.map(O=>{if(!O)return 0;const u=O.match(K);return u?u.length:0})),z=Math.max(...p.map(f=>f.length)),C=p.map(f=>new Array(f.length).fill(0));for(let f=0;f<z;f++){let O=0;for(let u=0;u<p.length;u++){const w=p[u][f];typeof w=="number"&&!isNaN(w)&&w>O&&(O=w)}for(let u=0;u<p.length;u++){const w=p[u][f];typeof w=="number"&&f<C[u].length&&(C[u][f]=O-w)}}for(let f=0;f<L.length;f++){const O=L[f];for(let u=0;u<O.length-1;u++)if(u<C[f].length&&C[f][u]>0){const w=O[u]||"";if(!/r\d*\.?/i.test(w)){const y=m[f],S=k[f]||[],V=S[u]||S[S.length-1]||"t?",U=S[u+1]||"끝",ht=V.replace(/[^0-9]/g,""),Tt=U==="끝"?"끝":U.replace(/[^0-9]/g,""),xt=`${y?.name||"트랙"} 트랙의 t${ht} ~ t${Tt} 구간에 쉼표가 없어 분할을 할 수 없습니다.`;try{alert(xt)}catch{console.warn(xt)}const Lt=document.querySelector("#tempo-fix-checkbox");Lt&&(Lt.checked=!1);try{pt()}catch{}return}}}const J=L.map((f,O)=>f.map((u,w)=>{if(w<C[O].length&&C[O][w]>0){const y=!!(u&&/r/i.test(u));return $t(y,C[O][w],O,w)}return u})),lt=J.map((f,O)=>{const u=k[O]||[];let w=[];for(let y=0;y<f.length;y++){const S=u[y];O===0&&S&&w.push(S);const V=f[y].trim();V&&w.push(V)}return w.join("")});c.value="MML@"+lt.join(",")+";",q();try{console.log("[updateMMLOutputWithTempoFix tempoSplitMatrix]",{tempoSplitMatrix:L,tempoNoteRestCounts:p,needs:C,tempoSplitMatrixFixed:J,rebuiltBodies:lt})}catch{}}pt(),R.onclick=D,t.onclick=v=>{v.target===t&&D()},M.onclick=()=>{navigator.clipboard.writeText(c.value),M.textContent=st[it].copied,setTimeout(()=>{M.textContent=st[it].convertCopy},2e3)},A.onclick=()=>{try{const v=new Blob([c.value],{type:"text/plain;charset=utf-8"}),m=document.createElement("a");m.href=URL.createObjectURL(v);const x=(r.value||"").trim(),g=`mml-${new Date().toISOString().replace(/[:.]/g,"-")}.txt`;let k=x.length>0?x:g;k=k.replace(/[\\\/:*?"<>|]/g,"_"),/\.txt$/i.test(k)||(k+=".txt"),m.download=k,document.body.appendChild(m),m.click(),setTimeout(()=>{URL.revokeObjectURL(m.href),m.parentNode&&m.parentNode.removeChild(m)},0)}catch{}},window.addEventListener("keydown",Q,!0)}const ie=Object.freeze(Object.defineProperty({__proto__:null,showConvertModal:Jt},Symbol.toStringTag,{value:"Module"}));export{Z as M,It as a,Pt as b,ie as c,se as m,At as n,Jt as s};
