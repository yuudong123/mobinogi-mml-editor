import{t as b,c as v,T,P as C,D as I,a as sn,H as Dn,e as cn,s as ln,E as ye,B as be,b as ve,I as Ne,d as _e,i as Hn,L as At,f as at,g as de,p as oe,_ as xe,h as Fe,j as Xn,k as Wn,l as ze,m as we,n as re,o as dn,q as J,M as Me,r as qn,u as $e,v as On,w as Vn}from"./languages-Cgt_gsPd.js";import{notesToMMLRaw as un,notesToMML as Kn,extractTempoAnchorsFromMMLBodies as mn,newOptimizeBody as Un,mmlToNotes as Fn}from"./converter-Bxff0mca.js";import{e as ue,c as ae}from"./button-WIurEURm.js";import{showConvertModal as $n}from"./convertModal-BoFIxvxa.js";import{showGuideModal as Ye}from"./guideModal-DTHVvsmR.js";let Ge=!1;function Yn(){if(Ge)return;const t=`
  :root {
    --dd-radius: 6px;
    --dd-border: #cfcfcf;
    --dd-border-hover: #b5b5b5;
    --dd-bg: #fff;
    --dd-text: #111;
    --dd-muted: #6b7280;
    --dd-shadow: 0 8px 24px rgba(0,0,0,0.12), 0 2px 6px rgba(0,0,0,0.08);
    --dd-focus: 0 0 0 3px rgba(33,150,243,0.15);
  }

  .dropdown { position: relative; display: inline-flex; }
  .dropdown--full { width: 100%; }

  .dropdown__button {
    display: inline-flex; align-items: center; justify-content: space-between;
    gap: 8px; width: 100%;
    background: var(--dd-bg);
    color: var(--dd-text);
    border: 1px solid var(--dd-border);
    border-radius: var(--dd-radius);
    cursor: pointer; user-select: none;
    transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
  }
  .dropdown__button:hover { border-color: var(--dd-border-hover); }
  .dropdown__button:focus-visible { outline: none; box-shadow: var(--dd-focus); }

  .dropdown__button--sm { height: 28px; padding: 4px 8px; font-size: 12px; }
  .dropdown__button--md { height: 34px; padding: 6px 10px; font-size: 14px; }
  .dropdown__button--lg { height: 40px; padding: 8px 12px; font-size: 16px; }

  .dropdown__caret { width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 6px solid #888; }

  .dropdown__menu {
    position: absolute; left: 0; top: calc(100% + 4px);
    min-width: 100%;
    background: #fff; border: 1px solid var(--dd-border);
    border-radius: var(--dd-radius);
    box-shadow: var(--dd-shadow);
    padding: 6px; margin: 0; list-style: none;
    z-index: 1000; display: block; opacity: 0; transform: var(--dd-transform, translateY(4px));
    pointer-events: none; transition: opacity .16s ease, transform .16s ease;
  }
  .dropdown__menu[data-open="true"] { opacity: 1; transform: translateY(0); pointer-events: auto; }

  .dropdown__item {
    padding: 6px 8px; border-radius: 6px; cursor: pointer;
    white-space: nowrap; color: var(--dd-text);
  }
  .dropdown__item[aria-selected="true"] { background: #eef6ff; }
  .dropdown__item:hover { background: #f3f4f6; }
  .dropdown__item:focus { outline: none; box-shadow: var(--dd-focus); }
  `,e=document.createElement("style");e.id="dropdown-styles",e.textContent=t,document.head.appendChild(e),Ge=!0}function Gn(t){Yn();const e=t.size??"md";let n=t.value??t.items[0]?.value??"",r=t.items;const a=document.createElement("div");a.className="dropdown",a.classList.add("dropdown--full");const o=document.createElement("button");o.type="button",o.className=`dropdown__button dropdown__button--${e}`,o.setAttribute("aria-haspopup","listbox"),o.setAttribute("aria-expanded","false");const s=document.createElement("span");s.textContent=t.items.find(M=>M.value===n)?.label??"";const d=document.createElement("i");d.className="dropdown__caret",o.append(s,d);const c=document.createElement("ul");c.className="dropdown__menu",c.setAttribute("role","listbox"),c.setAttribute("tabindex","-1");const l=a;let m=!1;function f(){c.innerHTML="";for(const M of r){const E=document.createElement("li");E.className="dropdown__item",E.setAttribute("role","option"),E.setAttribute("tabindex","0"),E.setAttribute("aria-selected",String(M.value===n)),E.textContent=M.label,E.addEventListener("click",()=>x(M.value)),E.addEventListener("keydown",P=>{P.key==="Enter"||P.key===" "?(P.preventDefault(),x(M.value)):P.key==="Escape"?(P.preventDefault(),g(),o.focus()):P.key==="ArrowDown"?(P.preventDefault(),L(E)):P.key==="ArrowUp"&&(P.preventDefault(),S(E))}),c.appendChild(E)}}function p(){f(),m||(document.body.appendChild(c),m=!0,c.style.position="fixed",c.style.zIndex="1000");const M=o.getBoundingClientRect();c.style.minWidth=M.width+"px",w(),c.dataset.open="true",o.setAttribute("aria-expanded","true"),window.addEventListener("mousedown",k,{capture:!0}),window.addEventListener("scroll",y,!0),window.addEventListener("resize",y)}function g(){delete c.dataset.open,o.setAttribute("aria-expanded","false"),m&&(l.appendChild(c),m=!1,c.style.position="",c.style.left="",c.style.top="",c.style.minWidth="",c.style.zIndex=""),window.removeEventListener("mousedown",k,{capture:!0}),window.removeEventListener("scroll",y,!0),window.removeEventListener("resize",y)}function h(){c.dataset.open==="true"?g():p()}function k(M){const E=M.target;a.contains(E)||c.contains(E)||g()}function y(){c.dataset.open==="true"&&w()}function w(){const M=o.getBoundingClientRect(),E=c.getBoundingClientRect(),P=window.innerHeight,Z=window.innerWidth,U=8,kt=4,Ue=Math.max(E.width,M.width);let Mt=Math.min(Math.max(M.left,U),Math.max(U,Z-Ue-U));const It=P-M.bottom-U,jt=M.top-U;let Jt=!1,Tt=Math.min(360,Math.max(It-kt,120));E.height>It&&jt>It&&(Jt=!0,Tt=Math.min(360,Math.max(jt-kt,120)));let Ct;Jt?(Ct=Math.max(U,M.top-kt-Math.min(E.height,Tt)),c.dataset.placement="top",c.style.setProperty("--dd-transform","translateY(-4px)")):(Ct=Math.min(P-U-Math.min(E.height,Tt),M.bottom+kt),c.dataset.placement="bottom",c.style.setProperty("--dd-transform","translateY(4px)")),c.style.top=`${Math.round(Ct)}px`,c.style.left=`${Math.round(Mt)}px`,c.style.maxHeight=`${Tt}px`,c.style.overflowY="auto"}function x(M){if(M===n){g(),o.focus();return}n=M,s.textContent=r.find(E=>E.value===n)?.label??"",g(),o.focus(),t.onChange(n)}function L(M){const E=Array.from(c.querySelectorAll(".dropdown__item")),P=E.indexOf(M);E[Math.min(E.length-1,P+1)]?.focus()}function S(M){const E=Array.from(c.querySelectorAll(".dropdown__item")),P=E.indexOf(M);E[Math.max(0,P-1)]?.focus()}o.addEventListener("click",()=>h()),o.addEventListener("keydown",M=>{if(M.key==="ArrowDown"||M.key==="Enter"||M.key===" ")M.preventDefault(),p();else if(M.key==="ArrowUp"){M.preventDefault(),p();const E=c.querySelectorAll(".dropdown__item");E[E.length-1]?.focus()}});function X(M){r=M;const E=r.find(P=>P.value===n);E?s.textContent=E.label:s.textContent="",c.dataset.open==="true"&&f()}return a.append(o,c),{el:a,get value(){return n},set value(M){x(M)},updateItems:X}}let je=!1;function fn(){if(je)return;const t=`
  :root {
    --fc-radius: 6px;
    --fc-border: #cfcfcf;
    --fc-border-hover: #b5b5b5;
    --fc-border-focus: #2196f3;
    --fc-bg: #ffffff;
    --fc-bg-disabled: #f7f7f7;
    --fc-text: #111;
    --fc-placeholder: #9aa0a6;
    --fc-shadow-focus: 0 0 0 3px rgba(33,150,243,0.15);
  }

  .input, .select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    box-sizing: border-box;
    font: inherit;
    color: var(--fc-text);
    background: var(--fc-bg);
    border: 1px solid var(--fc-border);
    border-radius: var(--fc-radius);
    outline: none;
    transition: border-color .2s ease, box-shadow .2s ease, background .2s ease, transform .15s ease;
  }

  .input::placeholder {
    color: var(--fc-placeholder);
  }

  .input:hover, .select:hover {
    border-color: var(--fc-border-hover);
  }

  .input:focus, .select:focus {
    border-color: var(--fc-border-focus);
    box-shadow: var(--fc-shadow-focus);
  }

  /* Sizes */
  .fc--sm { height: 28px; padding: 4px 8px; font-size: 12px; }
  .fc--md { height: 34px; padding: 6px 10px; font-size: 14px; }
  .fc--lg { height: 40px; padding: 8px 12px; font-size: 16px; }

  /* Full width helper */
  .fc--full { width: 100%; }

  /* Number inputs: right align helper */
  .fc--num-right { text-align: right; }

  /* Disabled */
  .input:disabled, .select:disabled { background: var(--fc-bg-disabled); color: #888; cursor: not-allowed; }

  /* Select arrow */
  .select {
    background-image: url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5' stroke='%23888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 16px 16px;
    padding-right: 28px; /* space for arrow */
  }

  /* Remove default arrow on some browsers */
  .select::-ms-expand { display: none; }
  `,e=document.createElement("style");e.id="form-control-styles",e.textContent=t,document.head.appendChild(e),je=!0}function jn(t,e){fn(),t.classList.add("input");const n=e?.size;t.classList.add(Jn(n)),t.classList.add("fc--full"),e?.rightAlign&&t.classList.add("fc--num-right")}function Jn(t){return t==="sm"?"fc--sm":t==="lg"?"fc--lg":"fc--md"}let lt=null,Q=null,Rt=null,Dt=null,Pt=null;function Zn(t,e,n){if(lt||Qn(),!lt||!Q||!Rt||!Dt)return;Q.value=(n??t.mmlString)||"",lt.style.display="flex",Q.focus();const r=o=>{o.stopPropagation()};Q.addEventListener("keydown",r),Q.addEventListener("keyup",r);function a(){lt.style.display="none",Q.removeEventListener("keydown",r),Q.removeEventListener("keyup",r),Rt.onclick=null,Dt.onclick=null,Pt&&(window.removeEventListener("keydown",Pt,!0),Pt=null)}Rt.onclick=()=>{e(Q.value),a()},Dt.onclick=a,Pt=o=>{o.key==="Escape"&&(o.stopPropagation(),a())},window.addEventListener("keydown",Pt,!0)}function Qn(){lt=document.createElement("div"),lt.id="mmlEditModal",lt.style.cssText=`
    position: fixed; 
    left: 0; top: 0; 
    width: 100vw; 
    height: 100vh;
    background: rgba(0,0,0,0.25); 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    z-index: 200;
    display: none;
  `;const t=document.createElement("div");t.style.cssText=`
            background: #fff;
            padding: 24px;
            border-radius: 8px;
            min-width: 400px;
            box-shadow: 0 2px 16px #0002;
            display: flex;
            flex-direction: column;
            gap: 12px;
        `,Q=document.createElement("textarea"),Q.style.cssText=`
            width: 100%;
            min-height: 120px;
            font-family: monospace;
            font-size: 15px;
            word-break: break-all;
            overflow-x: wrap;
        `,ue(),Rt=ae({label:b[v].ok,variant:"primary",attrs:{"data-i18n":"ok"}}),Dt=ae({label:b[v].cancel,variant:"secondary",attrs:{"data-i18n":"cancel"}});const e=document.createElement("div");e.style.cssText=`
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        `,e.append(Dt,Rt),t.append(Q,e),lt.appendChild(t),document.body.appendChild(lt)}function to(){return{scrollX:0,scrollY:0,keyHeight:16,activeTrackId:1,selectedLength:16,hover:{noteId:null,edge:null},drag:null,ghost:null,ghostGroup:null,selected:new Set,marquee:{active:!1,x0:0,y0:0,x1:0,y1:0,mode:"replace"},clipboard:null,volumeLabels:new Set}}function eo(t,e,n,r,a,o,s){t.save();const d=window.devicePixelRatio||1;t.setTransform(d,0,0,d,0,0);const c=t.canvas.clientWidth||t.canvas.width/d,l=t.canvas.clientHeight||t.canvas.height/d;t.clearRect(0,0,c,l),ao(t,e,n,r,a),so(t,n,e,r),co(t,e,n,r,a),lo(t,e,n,r,a),uo(t,n,r),ro(t,e,r,a,l),t.restore()}function pn(t,e,n,r,a){const o=window.devicePixelRatio||1;t.setTransform(o,0,0,o,0,0);const s=e.clientWidth||e.width/o,d=e.clientHeight||e.height/o;t.clearRect(0,0,s,d),t.fillStyle="#ffffff",t.fillRect(0,0,s,d);const c=84*r.keyHeight;no(t,0,s,r),oo(t,n,0,s,c,a)}function Ht(t,e,n,r,a,o){const s=Math.max(0,Math.min(o,Math.floor(Math.min(r,a)/2))),d=Math.floor(e),c=Math.floor(n),l=d+Math.max(0,r),m=c+Math.max(0,a);if(t.beginPath(),s<=0){t.rect(d,c,r,a);return}t.moveTo(d+s,c),t.lineTo(l-s,c),t.arcTo(l,c,l,c+s,s),t.lineTo(l,m-s),t.arcTo(l,m,l-s,m,s),t.lineTo(d+s,m),t.arcTo(d,m,d,m-s,s),t.lineTo(d,c+s),t.arcTo(d,c,d+s,c,s)}function no(t,e,n,r){const a=r.keyHeight,o=84*a,s=Math.ceil(o/a);for(let d=0;d<s;d++){const c=d*a,m=((95-d)%12+12)%12,f=m===1||m===3||m===6||m===8||m===10;t.fillStyle=f?"#d6d6d6":"#ffffff",t.fillRect(e,c,Math.max(0,n),a);const p=m===11;t.strokeStyle=p?"#000000":"rgb(153,153,153)",t.beginPath(),t.moveTo(e,c+.5),t.lineTo(e+Math.max(0,n),c+.5),t.stroke()}}function oo(t,e,n,r,a,o){const s=C[e.zoomLevel-1],d=o&&o>=1?o:e.timeSig.beatsPerBar,c=Math.max(0,Math.floor(n/s)-2),l=Math.floor((n+r)/s)+2;for(let f=c;f<=l;f++){const p=Math.floor(f*s),g=f%d===0;t.strokeStyle=g?"#000":"rgb(128,128,128)",t.beginPath(),t.moveTo(p,0),t.lineTo(p,a),t.stroke()}const m=e.zoomLevel;m>=4&&fe(t,n,r,a,s,2,"rgb(191,191,191)"),m>=6&&fe(t,n,r,a,s,4,"rgb(191,191,191)"),m>=8&&fe(t,n,r,a,s,8,"rgb(191,191,191)")}function fe(t,e,n,r,a,o,s){const d=Math.max(0,Math.floor(e/a)-2),c=Math.floor((e+n)/a)+2;t.strokeStyle=s;for(let l=d;l<=c;l++)for(let m=1;m<o;m+=2){const f=Math.floor((l+m/o)*a);t.beginPath(),t.moveTo(f,0),t.lineTo(f,r),t.stroke()}}function ro(t,e,n,r,a){const o=e.tempoAnchors||[];if(!o||o.length===0)return;const s=C[e.zoomLevel-1];t.save(),t.strokeStyle="rgba(159, 215, 255, 0.9)",t.lineWidth=1;for(const d of o){const c=Math.round(d.tick/T*s);if(c+1<n||c-1>n+r)continue;const l=c-Math.floor(n)+.5;t.beginPath(),t.moveTo(l,0),t.lineTo(l,a),t.stroke()}t.restore()}function ao(t,e,n,r,a){const o=C[e.zoomLevel-1],s=n.activeTrackId,d=[...e.tracks].sort((c,l)=>c.id===s?1:l.id===s?-1:0);for(const c of d){const l=c.id===s?1:.5;t.globalAlpha=l;for(const m of c.notes){const f=Math.round(m.startTick/T*o),p=Math.max(1,Math.round(m.durationTick/T*o));if(f+p<r||f>r+a)continue;const g=f-Math.floor(r);io(t,g,m,c.color,o,n.keyHeight,n.hover,c.id===s,n.selected.has(m.id))}}t.globalAlpha=1}function io(t,e,n,r,a,o,s,d,c){const l=Math.max(1,Math.round(n.durationTick/T*a)),m=(95-n.pitch)*o+1,f=o-1,p=Math.min(6,Math.floor(f/2));if(t.fillStyle=r,Ht(t,e,m,l,f,p),t.fill(),t.strokeStyle="rgba(0,0,0,0.3)",t.lineWidth=1,Ht(t,e,m,l-1,f-1,Math.max(0,p-1)),t.stroke(),c&&(t.strokeStyle="#3a7afe",t.lineWidth=2,Ht(t,e,m,l-1,f-1,Math.max(0,p-1)),t.stroke(),t.lineWidth=1),d&&s.noteId===n.id){const g=Math.min(8,Math.floor(l/3));t.fillStyle="rgba(0,0,0,0.15)",t.fillRect(e,m,g,f),t.fillRect(e+l-g,m,g,f)}}function so(t,e,n,r){const a=C[n.zoomLevel-1],o=s=>{const d=Math.round(s.startTick/T*a)-Math.floor(r),c=Math.max(1,Math.round(s.durationTick/T*a)),l=(95-s.pitch)*e.keyHeight+1,m=e.keyHeight-1;t.globalAlpha=.7,t.fillStyle=s.color;const f=Math.min(6,Math.floor(m/2));Ht(t,d,l,c,m,f),t.fill(),t.globalAlpha=1};if(e.ghost&&o(e.ghost),e.ghostGroup)for(const s of e.ghostGroup)o(s)}function co(t,e,n,r,a){const o=C[e.zoomLevel-1],s=n.keyHeight;t.strokeStyle="#3a7afe",t.lineWidth=2;for(const d of e.tracks)for(const c of d.notes){if(!n.selected.has(c.id))continue;const l=Math.round(c.startTick/T*o)-Math.floor(r),m=Math.max(1,Math.round(c.durationTick/T*o)),f=l+Math.floor(r);if(f+m<r||f>r+a)continue;const p=(95-c.pitch)*s+1,g=s-1,h=Math.min(6,Math.floor(g/2));Ht(t,l,p,m-1,g-1,Math.max(0,h-1)),t.stroke()}t.lineWidth=1}function lo(t,e,n,r,a){if(!n.volumeLabels||n.volumeLabels.size===0)return;const o=C[e.zoomLevel-1],s=n.keyHeight;t.font="10px sans-serif",t.textAlign="left",t.textBaseline="bottom";for(const d of e.tracks)for(const c of d.notes){if(!n.volumeLabels.has(c.id))continue;const l=Math.round(c.startTick/T*o),m=Math.max(1,Math.round(c.durationTick/T*o));if(l+m<r||l>r+a)continue;const f=l-Math.floor(r),p=(95-c.pitch)*s+1,g="V"+String(c.volume??I);t.fillStyle="rgba(255,255,255,0.9)",t.fillText(g,f+1,p-1),t.fillStyle="rgba(0,0,0,0.85)",t.fillText(g,f,p-2)}}function uo(t,e,n){if(!e.marquee.active)return;const r=Math.min(e.marquee.x0,e.marquee.x1)-Math.floor(n),a=Math.min(e.marquee.y0,e.marquee.y1),o=Math.abs(e.marquee.x1-e.marquee.x0),s=Math.abs(e.marquee.y1-e.marquee.y0);t.fillStyle="rgba(58,122,254,0.15)",t.fillRect(r,a,o,s),t.strokeStyle="rgba(58,122,254,0.8)",t.setLineDash([4,3]),t.strokeRect(r+.5,a+.5,o-1,s-1),t.setLineDash([])}function Te(t,e,n,r,a){for(let o=n.length-1;o>=0;o--){const s=n[o],d=Math.round(s.startTick/T*r),c=Math.max(1,Math.round(s.durationTick/T*r)),l=(95-s.pitch)*a+1,m=a-1;if(t>=d&&t<=d+c&&e>=l&&e<=l+m){const f=Math.min(8,Math.floor(c/3)),p=t<=d+f?"left":t>=d+c-f?"right":"center";return{note:s,edge:p}}}}function mo(t,e,n,r,a,o,s){const d=Math.min(t,n),c=Math.max(t,n),l=Math.min(e,r),m=Math.max(e,r),f=[];for(const p of a){const g=Math.round(p.startTick/T*o),h=Math.max(1,Math.round(p.durationTick/T*o)),k=(95-p.pitch)*s+1,y=s-1,w=g+h,x=k+y;w>=d&&g<=c&&x>=l&&k<=m&&f.push(p)}return f}function fo(t,e,n){t.clearRect(0,0,e.width,e.height);const r=window.devicePixelRatio||1,a=12*n;for(let o=0;o<7;o++){const s=(6-o)*a,d=o%2===1;t.fillStyle=d?"#e6e6e6":"#ffffff",t.fillRect(0,s,e.width/r,a),t.fillStyle="#222",t.font=`${Math.max(10,Math.round(12))}px system-ui, sans-serif`,t.textBaseline="middle",t.textAlign="center";const c="o"+(o+1),l=s+a/2;t.fillText(c,Math.floor(e.width/r/2),Math.floor(l))}}function po(t,e,n,r,a,o,s){const d=e.width,c=e.height,l=window.devicePixelRatio||1;t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,d,c),l!==1&&t.setTransform(l,0,0,l,0,0);const m=d/l,f=c/l;t.fillStyle="#ffffff",t.fillRect(0,0,m,f);const p=Math.floor(n/r),g=Math.ceil((n+m)/r);for(let y=p;y<=g;y++){const w=Math.round(y*r-n)+.5;if(y%a===0){t.strokeStyle="#000000",t.beginPath(),t.moveTo(w,0),t.lineTo(w,f),t.stroke();const L=Math.floor(y/a)+1;t.fillStyle="#222",t.font="12px system-ui, sans-serif",t.textAlign="left",t.textBaseline="top",t.fillText(String(L),w+4,2)}else{t.strokeStyle="rgb(128,128,128)";const L=Math.floor(f*.5);t.beginPath(),t.moveTo(w,L),t.lineTo(w,f),t.stroke()}}const h=o,k=h&&Array.isArray(h.tempoAnchors)?h.tempoAnchors:[];if(k&&k.length>0){t.save();const y=Math.max(9,Math.min(13,Math.floor(f*.6)));t.font=`${y}px system-ui, sans-serif`,t.textAlign="center",t.textBaseline="middle";for(const w of k){const x=w.tick/T*r,L=Math.round(x-n)+.5;if(L<-40||L>m+40)continue;const S=s!=null&&w.tick===s,X="t"+String(w.bpm),M=t.measureText(X),E=(M.actualBoundingBoxAscent||y*.8)+(M.actualBoundingBoxDescent||y*.2),P=Math.max(4,Math.floor(y*.5)),Z=Math.max(2,Math.floor(y*.3)),U=Math.ceil(E)+Z*2,kt=Math.ceil(M.width)+P*2;let Mt=f-U-2;Mt<.5&&(Mt=.5);const It=Math.floor(L-kt/2)+.5,jt=S?"#7cc7ff":"#bfe7ff",Jt=S?"#2f9dff":"#5bb6ff",Tt="#003";t.fillStyle=jt,t.strokeStyle=Jt,t.lineWidth=1,t.beginPath(),t.rect(It,Mt,kt,U),t.fill(),t.stroke(),t.fillStyle=Tt;const Ct=Mt+U/2;t.fillText(X,L,Math.floor(Ct))}t.restore()}}function Je(t,e,n){const r=window.devicePixelRatio||1,a=e.clientHeight||e.height/r;t.save(),t.setTransform(r,0,0,r,0,0),t.strokeStyle="rgba(255,0,0,0.9)",t.lineWidth=2,t.beginPath(),t.moveTo(Math.floor(n)+.5,0),t.lineTo(Math.floor(n)+.5,a),t.stroke(),t.restore()}function ho(t,e,n,r){const a=window.devicePixelRatio||1,o=e.clientHeight||e.height/a;t.save(),t.setTransform(a,0,0,a,0,0),t.fillStyle="rgba(255,0,0,0.12)",t.fillRect(Math.floor(n),0,Math.ceil(r),o),t.restore()}function go(t,e){const n=document.createElement("div");n.style.cssText=`
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    `;const r=document.createElement("div");r.style.cssText=`
        background: #fff;
        width: min(640px, 92vw);
        max-height: 80vh;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        padding: 18px 18px 14px;
        position: relative;
        overflow: auto;
    `;const a=document.createElement("h2");a.textContent=b[v].whatsNewTitle||"What's new",a.style.margin="0 0 8px 0",a.style.fontSize="18px",a.setAttribute("data-i18n","whatsNewTitle");const o=document.createElement("div"),s=(m,f)=>{const p=document.createElement("ul");return p.style.margin="6px 0 0 18px",p.style.padding="0",m.forEach((g,h)=>{const k=document.createElement("li");k.textContent=g;const y=f[h];y&&k.setAttribute("data-i18n",y),p.append(k)}),p};{const m=document.createElement("h3");m.textContent=b[v].whatsNew_20250903_heading||"Tempo edits & Mobile editor",m.setAttribute("data-i18n","whatsNew_20250903_heading"),m.style.margin="8px 0 6px 0";const f=[b[v].whatsNew_20250903_p1||"Tempo is now edited via anchors on the time ruler (create, drag, delete).",b[v].whatsNew_20250903_p2||"Added a mobile-optimized editor (experimental). Some features may be unstable.",b[v].whatsNew_20250903_p3||"Mobile: long-press replaced with double-tap for tempo menu; track MML auto-updates after edits."],p=["whatsNew_20250903_p1","whatsNew_20250903_p2","whatsNew_20250903_p3"];o.append(m,s(f,p))}ue();const d=ae({label:b[v].ok||"OK",size:"sm",variant:"primary"});d.setAttribute("data-i18n","ok"),d.style.marginTop="12px",d.style.alignSelf="flex-end";const c=()=>{n.remove();try{localStorage.setItem("mml_editor_whatsnew_shown_"+t,"1")}catch{}};d.addEventListener("click",c);const l=m=>{m.key==="Escape"&&c()};window.addEventListener("keydown",l,{once:!0}),n.addEventListener("click",m=>{m.target===n&&c()}),r.append(a,o,d),n.appendChild(r),document.body.appendChild(n)}const Et=document.getElementById("footerMmlEditBtn"),pe=document.getElementById("footerMMLText"),yt=document.getElementById("footerLabel"),Zt=document.getElementById("btnPasteMML"),hn="mml_editor_project";let u=sn();const pt=new Dn,i=to(),Re=new Worker(new URL(""+new URL("mmlOptimizerWorker-DYK2yqxc.js",import.meta.url).href,import.meta.url),{type:"module"}),he=new Map,ko=300;let ge=null;const Ze=document.getElementById("progress"),_=document.getElementById("roll"),V=document.getElementById("rollBg"),j=document.getElementById("octaveCanvas");let A=null,O=null,Nt=null,_t=null,bt=null;const B=document.getElementById("timeRuler"),tt=_.getContext("2d"),ie=V?V.getContext("2d"):null,gn=j.getContext("2d"),Ee=B.getContext("2d"),Qe=document.getElementById("tracks"),Xt=document.getElementById("lenBar"),q=document.getElementById("dispSigN");let $=4;const tn="mml_editor_display_timesig_n",R=document.getElementById("rollViewport"),ut=document.getElementById("rulerContainer"),zt=document.getElementById("customScrollbar"),Wt=document.getElementById("customScrollbarThumb"),Le=document.getElementById("btnPlay"),Se=document.getElementById("btnPause"),Ae=document.getElementById("btnStop"),ct=document.getElementById("btnPlayheadMode"),Qt=document.getElementById("btnConvert");let qt=null;function yo(){if(!qt){const t=document.createElement("div");t.style.cssText="position:absolute;pointer-events:none;background:rgba(0,0,0,0.8);color:#fff;padding:4px 6px;border-radius:4px;font:12px system-ui, sans-serif;z-index:10;transform:translate(-50%, -120%);white-space:nowrap;display:none;",ut.style.position="relative",ut.appendChild(t),qt=t}return qt}const Ot=document.getElementById("btnGuide"),st=document.getElementById("btnLoad"),Be=document.getElementById("btnGoToMobile"),te=document.getElementById("langKo"),ee=document.getElementById("langJa"),ne=document.getElementById("langEn"),bo=document.getElementById("btnPushBeat"),vo=document.getElementById("btnPushBar"),xo=document.getElementById("btnCutBeat"),wo=document.getElementById("btnCutBar"),et=document.getElementById("keyHeightRange"),Lt=document.getElementById("keyHeightLabel"),ot="rgba(255,215,0,0.8)";let H=!1,Y=0,Ie=0,xt=!1,Mo=0,Vt=0,Kt=0,De=!1,Ft=null;function mt(){const t=document.getElementById("rulerContextMenu");t&&t.parentNode&&t.parentNode.removeChild(t)}const rt={pitch:null,sampler:null};let ht=-1,ft="area";const kn="mml_editor_key_height";(()=>{const t=()=>{try{cn()}catch{}finally{window.removeEventListener("pointerdown",t),window.removeEventListener("keydown",t)}};window.addEventListener("pointerdown",t,{passive:!0}),window.addEventListener("keydown",t)})();const W=document.createElement("button");Be&&Be.addEventListener("click",()=>{try{window.location.href="./mobile.html"}catch{}});function St(){const t=document.activeElement;if(!t)return;const e=t.tagName.toLowerCase();if((e==="input"||e==="select"||e==="textarea"||e==="button"||t.isContentEditable)&&!t.closest("#rollViewport, #roll, #rollBg, #timeRuler, #rulerContainer"))try{t.blur()}catch{}}function yn(t){const e=t.target;return e?!!e.closest("#rollViewport, #roll, #rollBg, #timeRuler, #rulerContainer"):!1}function en(t){const e={bpm:120,timeSig:{beatsPerBar:4},zoomLevel:1,tracks:[],maxEndTick:0,tpqn:t?.tpqn??T,extendedUnitsEnabled:t?.extendedUnitsEnabled??J},n=Number(t?.bpm);e.bpm=Number.isFinite(n)&&n>0?n:120;const r=Number(t?.timeSig?.beatsPerBar);e.timeSig={beatsPerBar:Number.isFinite(r)&&r>=1?r:4};const a=Number(t?.zoomLevel);e.zoomLevel=Number.isFinite(a)&&a>=1&&a<=9?a:1;try{const c=Number(t?.displayBeatsPerBar);e.displayBeatsPerBar=Number.isFinite(c)&&c>=1&&c<=16?c:void 0}catch{}try{const l=(Array.isArray(t?.tempoAnchors)?t.tempoAnchors:[]).map(p=>({tick:Math.max(0,Math.floor(Number(p?.tick)||0)),bpm:Math.max(20,Math.min(Me,Math.round(Number(p?.bpm)||e.bpm)))})),m=new Map;for(const p of l)m.set(p.tick,p.bpm);const f=Array.from(m.entries()).map(([p,g])=>({tick:p,bpm:g})).sort((p,g)=>p.tick-g.tick);e.tempoAnchors=f}catch{e.tempoAnchors=[]}const o=Array.isArray(t?.tracks)?t.tracks:[],s=Math.max(1,Math.min(6,o.length||6));for(let c=0;c<s;c++){const l=o[c]??{},f=(Array.isArray(l?.notes)?l.notes:[]).map(X=>{const M=typeof X?.id=="string"&&X.id?X.id:crypto.randomUUID(),E=Math.max(0,Math.floor(Number(X?.startTick)||0)),P=Math.max(1,Math.floor(Number(X?.durationTick)||1)),Z=Math.max(0,Math.floor(Number(X?.pitch)||0)),U=Math.max(0,Math.min(15,Math.floor(Number(X?.volume)||I)));return{id:M,startTick:E,durationTick:P,pitch:Z,volume:U}}),p=typeof l?.instrument=="string"&&Ne.includes(l.instrument)?l.instrument:_e,g=Number(l?.id)||c+1,h=Number.isFinite(Number(l?.order))?Number(l.order):c,k=typeof l?.name=="string"&&l.name?l.name:`Track ${c+1}`,y=typeof l?.color=="string"&&l.color?l.color:ve[c%ve.length],w=!!l?.mute,x=!!l?.solo,L=typeof l?.mmlString=="string"?l.mmlString:"",S=typeof l?.optimizedMML=="string"?l.optimizedMML:"";e.tracks.push({id:g,order:h,name:k,color:y,instrument:p,mmlString:L,optimizedMML:S,mute:w,solo:x,notes:f})}e.tracks.sort((c,l)=>c.order-l.order),e.tracks.forEach((c,l)=>{c.order=l});let d=0;for(const c of e.tracks)for(const l of c.notes)d=Math.max(d,l.startTick+l.durationTick);return e.maxEndTick=d,e}function Bt(){ge==null&&(ge=requestAnimationFrame(()=>{ge=null,N()}))}function F(t,e,n){t.setAttribute("data-i18n-title",e),t.title=n||b[v][e]||""}function it(t,e,n){t.classList.add("btn",`btn--${e}`,`btn--${n}`)}function vt(t){return Math.max(0,Math.min(15,t))}function Ut(t){return Math.max(12,Math.min(95,t))}function se(t){return t.sort((e,n)=>e.startTick-n.startTick||e.pitch-n.pitch)}function bn(t){return t.sort((e,n)=>e.startTick-n.startTick||e.id.localeCompare(n.id))}function To(t,e){const n=e.volume??I;if(!i.volumeLabels)return;const r=bn(t.notes.slice()),a=r.findIndex(d=>d.id===e.id),o=a>0?r[a-1].volume??I:I,s=r.slice(0,a).some((d,c,l)=>{const m=i.volumeLabels.has(d.id),f=c>0?l[c-1].volume??I:I,p=(d.volume??I)!==f;return m||p});n===I?s?i.volumeLabels.add(e.id):i.volumeLabels.delete(e.id):n!==o?i.volumeLabels.add(e.id):i.volumeLabels.delete(e.id)}function $t(t){return bn(t.notes.slice())}function vn(t,e,n){if(e<0||e>=t.length)return!1;const r=t[e],a=e>0?t[e-1].volume??I:I,o=r.volume??I;return(n?.has(r.id)??!1)||o!==a}function xn(t,e,n){const r=$t(t),a=r.findIndex(s=>s.id===e.id);if(a<0)return;let o=r.length;for(let s=a+1;s<r.length;s++)if(vn(r,s,i.volumeLabels)){o=s;break}for(let s=a;s<o;s++)r[s].volume=vt(n)}function Eo(t,e,n){const r=$t(t),a=new Map(r.map(d=>[d.id,d.volume??I])),o=r.map((d,c)=>({n:d,i:c})).filter(d=>e.has(d.n.id)).map(d=>d.i).sort((d,c)=>d-c);let s=0;for(;s<o.length;){const d=o[s];let c=s+1;for(;c<o.length&&o[c]===o[c-1]+1;)c++;const l=d,m=o[c-1],f=l>0?a.get(r[l-1].id)??I:I;for(let g=l;g<=m;g++)r[g].volume=vt(n);let p=m+1;for(;p<r.length&&e.has(r[p].id);)p++;p<r.length&&(r[p].volume=f),s=c}}function He(t){if(!i.volumeLabels)return;const e=$t(t),n=new Set(e.map(a=>a.id));for(const a of Array.from(i.volumeLabels))n.has(a)&&i.volumeLabels.delete(a);let r=I;for(const a of e){const o=a.volume??I;o!==r&&i.volumeLabels.add(a.id),r=o}}function Lo(){if(A)return;A=document.createElement("div"),A.style.position="fixed",A.style.zIndex="10000",A.style.background="#fff",A.style.border="1px solid #ccc",A.style.boxShadow="0 4px 12px rgba(0,0,0,0.15)",A.style.borderRadius="8px",A.style.padding="10px 12px",A.style.minWidth="220px",A.style.display="none",A.addEventListener("wheel",o=>o.stopPropagation(),{passive:!1});const t=document.createElement("div");t.style.marginBottom="8px",t.textContent=(b[v].volLabel||"볼륨")+" (0-15)",O=document.createElement("input"),O.type="range",O.min="0",O.max="15",O.step="1",O.value=String(I),O.style.width="100%";const e=document.createElement("div");e.style.fontSize="12px",e.style.color="#555",e.style.marginTop="6px";const n=()=>{e.textContent="V"+(O?.value??String(I))};O.addEventListener("input",n),n();const r=document.createElement("div");r.style.display="flex",r.style.gap="8px",r.style.marginTop="10px",Nt=document.createElement("button"),Nt.className="btn btn--primary btn--sm",Nt.textContent=b[v].volApplyRange||"변경",_t=document.createElement("button"),_t.className="btn btn--secondary btn--sm",_t.textContent=b[v].volApplySelected||"선택한 노트만 변경",r.append(Nt,_t),A.append(t,O,e,r),document.body.appendChild(A);const a=()=>{A&&(A.style.display="none"),bt=null};document.addEventListener("keydown",o=>{A&&A.style.display!=="none"&&o.key==="Escape"&&a()}),document.addEventListener("mousedown",o=>{!A||A.style.display==="none"||A.contains(o.target)||a()}),Nt.addEventListener("click",()=>{if(!bt||!O)return;const o=u.tracks.find(c=>c.id===i.activeTrackId);if(!o)return;const s=o.notes.find(c=>c.id===bt);if(!s)return;const d=vt(parseInt(O.value,10));xn(o,s,d),D(),nt({track:o,recomputeLabels:!0}),A.style.display="none",bt=null}),_t.addEventListener("click",()=>{if(!O)return;const o=u.tracks.find(d=>d.id===i.activeTrackId);if(!o)return;const s=vt(parseInt(O.value,10));Eo(o,new Set(i.selected),s),D(),nt({track:o,recomputeLabels:!0}),A.style.display="none",bt=null})}function Xe(){A&&A.style.display!=="none"&&(A.style.display="none",bt=null)}function So(t,e,n){if(Lo(),!A||!O)return;bt=t.id;const r=t.volume??I;O.value=String(r);const a=A.querySelector("div:nth-child(3)");a&&(a.textContent="V"+r),A.style.display="block";const o=A.getBoundingClientRect(),s=window.innerWidth,d=window.innerHeight;let c=e,l=n;c+o.width>s&&(c=Math.max(0,s-o.width-8)),l+o.height>d&&(l=Math.max(0,d-o.height-8)),A.style.left=`${c}px`,A.style.top=`${l}px`}function wn(t){const e=Math.floor(Y);if(t!==0){for(const n of u.tracks){for(const r of n.notes)(r.startTick>=e||r.startTick+r.durationTick>e)&&(r.startTick+=t);se(n.notes)}{const n=u.tempoAnchors;if(Array.isArray(n)&&n.length>0){const r=n.map(a=>a.tick>=e?{tick:a.tick+t,bpm:a.bpm}:{...a});u.tempoAnchors=En(r)}}u.maxEndTick+=Math.max(0,t),D(),We(u.tracks),K(),Bt()}}function Mn(t){const e=Math.floor(Y);if(t!==0){for(const n of u.tracks){const r=[];for(const a of n.notes){const o=a.startTick,s=a.startTick+a.durationTick;if(s<=e)r.push(a);else{if(o>=e&&o<e+t)continue;if(o>=e+t)r.push({...a,startTick:Math.max(e,o-t)});else if(o<e&&s>e){const d=e-o;d>0&&r.push({...a,durationTick:d})}}}se(r),n.notes=r}{const n=u.tempoAnchors;if(Array.isArray(n)&&n.length>0){const r=n.filter(a=>!(a.tick>=e&&a.tick<e+t)).map(a=>a.tick>=e+t?{tick:a.tick-t,bpm:a.bpm}:{...a});u.tempoAnchors=En(r)}}u.maxEndTick=Math.max(0,u.maxEndTick-t),D(),We(u.tracks),K(),Bt()}}function Tn(){return u.timeSig.beatsPerBar}function En(t){const e=(t||[]).map(r=>({tick:Math.max(0,Math.floor(r.tick)),bpm:Math.round(r.bpm)}));e.sort((r,a)=>r.tick-a.tick||r.bpm-a.bpm);const n=[];for(const r of e){const a=n[n.length-1];!a||a.tick!==r.tick?n.push(r):n[n.length-1]=r}return n.length>0&&n[0].tick!==0&&(t||[]).some(a=>a.tick<=0)&&n.unshift({tick:0,bpm:n[0].bpm}),n.sort((r,a)=>r.tick-a.tick)}function Ao(){try{u.selectedLength=i.selectedLength,u.playheadVisualMode=ft,u.tpqn=T,u.extendedUnitsEnabled=J,u.displayBeatsPerBar=$,u.tempoChanges&&Array.isArray(u.tempoChanges);const t={...u,tracks:u.tracks.map(e=>({id:e.id,notes:e.notes,name:e.name,instrument:e.instrument,optimizedMML:e.optimizedMML,order:e.order,mute:e.mute,solo:e.solo,color:e.color}))};return localStorage.setItem(hn,JSON.stringify(t)),!0}catch{return!1}}let ke=null;function K(){ke&&window.clearTimeout(ke),ke=window.setTimeout(()=>{Ao()},300)}function D(){pt.push(u),K()}function dt(t){const e=he.get(t.id);e&&clearTimeout(e);const n=setTimeout(()=>{try{Re.postMessage({track:t,tpqn:u.tpqn??T,tempoAnchors:u.tempoAnchors||[],defaultBpm:u.bpm})}catch{}he.delete(t.id)},ko);he.set(t.id,n)}function We(t){for(const e of t)try{Re.postMessage({track:e,tpqn:u.tpqn??T,tempoAnchors:u.tempoAnchors||[],defaultBpm:u.bpm})}catch{}}function nt(t={}){const{track:e,recomputeLabels:n}=t;e&&(n&&He(e),dt(e),gt()),Bt()}function qe(){const t=document.querySelector(".panel.canvas-wrap");t&&(t.style.height="")}function gt(){if(!pe)return;const t=u.tracks.find(n=>n.id===i.activeTrackId)||u.tracks[0];let e=t&&(t.optimizedMML?.trim?.()||t.mmlString?.trim?.())||"";e=e.replace(/[\r\n]+/g,""),pe.textContent=e,pe.title=e}function Ln(t,e){const n=(e||"").replace(/[\r\n]+/g,"").trim();t.mmlString=n;try{let r=u.bpm;const a=n.match(/^t(\d+)/);a&&(r=parseInt(a[1],10)),t.notes=Fn("MML@"+n),u.tracks[0]===t&&(u.bpm=r),He(t),D(),dt(t),K(),Bt()}catch{t.notes=[]}}function Bo(){const t=u.tracks.filter(a=>a.solo),e=t.length>0?t:u.tracks.filter(a=>!a.mute),n=a=>Ne.includes(a)?a:_e,r=[];for(const a of e){const o=n(a.instrument||"lute");for(const s of a.notes)r.push({startTick:s.startTick,durationTick:s.durationTick,pitch:s.pitch,trackId:a.id,instrumentKey:o,volume:s.volume})}return r}function Io(){G(),Cn(),R&&new ResizeObserver(()=>{ht=-1,N()}).observe(R),((o,s="ghost")=>{o&&it(o,s,"sm")})(Be,"secondary"),_.addEventListener("pointermove",o=>{yn(o)&&St(),Uo(o)}),_.addEventListener("pointerdown",o=>{St(),o.preventDefault(),Fo(o)},{passive:!1}),window.addEventListener("pointerup",Yo),window.addEventListener("pointermove",$o),window.addEventListener("pointermove",o=>{window.lastPointerX=o.clientX,window.lastPointerY=o.clientY}),window.addEventListener("keydown",zo),window.addEventListener("keyup",_o),window.addEventListener("wheel",Wo,{passive:!1}),window.addEventListener("contextmenu",o=>{o.preventDefault()},{passive:!1}),R.addEventListener("scroll",Xo),B.addEventListener("click",o=>{St(),Gt(o)}),B.addEventListener("pointerdown",o=>{St(),o.preventDefault(),Jo(o)},{passive:!1}),B.addEventListener("contextmenu",o=>{o.preventDefault(),Po(o)},{passive:!1}),window.addEventListener("pointermove",Zo),window.addEventListener("pointerup",Qo),B.addEventListener("mousemove",No),B.addEventListener("mouseleave",()=>{qt&&(qt.style.display="none")}),Le.addEventListener("click",Rn),Se.addEventListener("click",Pe),Ae.addEventListener("click",Pn),et?.addEventListener("input",()=>{const o=Math.max(16,Math.min(32,parseInt(et.value,10)));if(o!==i.keyHeight){i.keyHeight=o;try{localStorage.setItem(kn,String(o))}catch{}Lt&&(Lt.textContent=String(o)),ht=-1,qe(),N()}}),ct&&ct.addEventListener("click",()=>{ft=ft==="area"?"line":"area",ct&&(ct.textContent=ft==="area"?b[v].playheadAreaLabel:b[v].playheadLineLabel),z(),K()}),Qt.addEventListener("click",Co),Zt.addEventListener("click",()=>{H||tr()});let e=!1,n=0,r=0;Wt.addEventListener("pointerdown",o=>{e=!0,n=o.clientX,r=i.scrollX,Wt.setPointerCapture(o.pointerId)}),window.addEventListener("pointermove",o=>{if(!e||H)return;const s=o.clientX-n,d=wt(),c=Math.max(0,d-R.clientWidth),l=Math.max(1,zt.clientWidth-Wt.clientWidth),m=c/l,f=r+s*m;i.scrollX=le(f),z()}),window.addEventListener("pointerup",()=>{e=!1}),Ot.addEventListener("click",Ye),st&&(it(st,"secondary","md"),st.textContent=b[v].load||"Load",F(st,"tooltipLoad",b[v].tooltipLoad||"Load project"),st.addEventListener("click",()=>{try{const o=localStorage.getItem(hn);if(!o){alert(b[v].noSavedProject||"No saved project found");return}const s=JSON.parse(o);if(!s||!s.tracks){alert(b[v].invalidSavedProject||"Saved data is invalid");return}let d=en(s);const c=!!d.extendedUnitsEnabled;ln(c);const l=c?ye:be,m=d.tpqn||l;if(m!==l){const f=l/m;Ce(d,f)}d.tpqn=l,d.extendedUnitsEnabled=c,typeof d.selectedLength=="number"&&(i.selectedLength=d.selectedLength),(d.playheadVisualMode==="area"||d.playheadVisualMode==="line")&&(ft=d.playheadVisualMode),d=en(d),u=d,i.selected.clear();try{i.volumeLabels?.clear()}catch{}for(const f of u.tracks)He(f);gt(),G(),N(),alert(b[v].loadedFromLocal||"Loaded from local storage")}catch{alert(b[v].loadFailed||"Load failed")}}));const a=o=>{qn(o),zn(),ct&&(ct.textContent=ft==="area"?b[v].playheadAreaLabel:b[v].playheadLineLabel),yt&&(yt.textContent=b[v].trackMMLLabel||(o==="ja"?"トラックMML":o==="en"?"Track MML":"트랙MML")),st&&(st.textContent=b[v].load||(o==="ja"?"読み込み":o==="en"?"Load":"불러오기"),F(st,"tooltipLoad",b[v].tooltipLoad||st.title||"Load project")),et&&(et.title=b[v].tooltipKeyHeight||et.title),Lt&&(Lt.textContent=String(i.keyHeight));try{const s=document.getElementById("langKo"),d=document.getElementById("langJa"),c=document.getElementById("langEn");s?.setAttribute("role","radio"),d?.setAttribute("role","radio"),c?.setAttribute("role","radio"),s?.setAttribute("aria-checked",String(o==="ko")),d?.setAttribute("aria-checked",String(o==="ja")),c?.setAttribute("aria-checked",String(o==="en"))}catch{}G(),gt()};te.addEventListener("click",()=>a("ko")),ee.addEventListener("click",()=>a("ja")),ne.addEventListener("click",()=>a("en")),Ot.addEventListener("click",Ye)}function Co(){const t=u.tracks.slice().sort((e,n)=>e.order-n.order);for(const e of t)!(Array.isArray(e.notes)&&e.notes.length>0)||(Kn(e.notes??[])||un(e.notes??[]));$n(u)}function ce(t){const e=_.getBoundingClientRect(),n=t.clientX-e.left+i.scrollX,r=t.clientY-e.top;return{x:n,y:r}}function Sn(t){const e=B.getBoundingClientRect();return{x:t.clientX-e.left+i.scrollX}}function An(t){const e=C[u.zoomLevel-1],n=i.scrollX,r=u.tempoAnchors||[];for(let a=0;a<r.length;a++){const o=Math.round(r[a].tick/T*e-n)+.5;if(Math.abs(o-t)<=6)return{index:a,tick:r[a].tick}}return null}function Po(t){const e=B.getBoundingClientRect(),n=t.clientX-e.left,r=An(n),a=ut,o=document.getElementById("rulerContextMenu");o&&o.parentNode&&o.parentNode.removeChild(o);const s=document.createElement("div");s.id="rulerContextMenu",s.style.cssText="position:absolute;z-index:20;background:#fff;border:1px solid #ccc;border-radius:6px;box-shadow:0 6px 16px rgba(0,0,0,0.2);padding:4px;min-width:160px;font:13px system-ui,sans-serif;";const d=(h,k)=>{const y=document.createElement("button");return y.type="button",y.textContent=h,y.style.cssText="display:block;width:100%;text-align:left;background:none;border:0;padding:8px 10px;cursor:pointer;",y.onmouseenter=()=>y.style.background="#f2f2f2",y.onmouseleave=()=>y.style.background="transparent",y.onclick=()=>{k(),c()},y},c=()=>{s.parentNode&&s.parentNode.removeChild(s)},{x:l}=Sn(t),m=C[u.zoomLevel-1],f=at(i.selectedLength),p=de(Math.max(0,Math.floor(l/m*T)),f);r?(s.appendChild(d(b[v].menuTempoEdit||"템포 수정…",()=>nn(u.tempoAnchors[r.index].bpm,h=>{u.tempoAnchors[r.index].bpm=h,u.tempoAnchors[r.index].tick===0&&(u.bpm=h),u.tempoAnchors.sort((k,y)=>k.tick-y.tick),D();for(const k of u.tracks)dt(k);K(),N()}))),s.appendChild(d(b[v].menuTempoDelete||"템포 삭제",()=>{u.tempoAnchors.splice(r.index,1),Ft=null,D();for(const h of u.tracks)dt(h);K(),N()}))):(s.appendChild(d(b[v].menuTempoCreateHere||"여기에 템포 생성…",()=>nn(u.bpm,h=>{const k=u.tempoAnchors||[];k.push({tick:p,bpm:h}),k.sort((y,w)=>y.tick-w.tick),u.tempoAnchors=k,p===0&&(u.bpm=h),Oe(p),D();for(const y of u.tracks)dt(y);K(),N()}))),s.appendChild(d(b[v].menuTempoRemoveAll||"모든 템포 제거",()=>{if(!(!Array.isArray(u.tempoAnchors)||u.tempoAnchors.length===0)){u.tempoAnchors=[],Ft=null,D();for(const h of u.tracks)dt(h);K(),N()}}))),a.style.position="relative",s.style.left=`${Math.floor(n)}px`;const g=i.keyHeight;s.style.top=`${Math.max(0,Math.floor(g-26))}px`,a.appendChild(s),setTimeout(()=>{const h=k=>{const y=k.target;(!y||!s.contains(y))&&c()};window.addEventListener("mousedown",h,{once:!0,capture:!0}),window.addEventListener("wheel",()=>c(),{once:!0,capture:!0}),window.addEventListener("resize",()=>c(),{once:!0,capture:!0})},0)}function nn(t,e){const n=document.createElement("div");n.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:1000;display:flex;align-items:center;justify-content:center;";const r=document.createElement("div");r.style.cssText="background:#fff;border-radius:8px;padding:16px;min-width:260px;box-shadow:0 10px 24px rgba(0,0,0,0.25);display:flex;flex-direction:column;gap:12px;";const a=document.createElement("div");a.textContent=b[v].tempoModalTitle||"템포 설정";const o=document.createElement("input");o.type="number",o.min="20",o.max=String(Me),o.step="1",o.value=String(t),o.style.cssText="font-size:16px;padding:8px;";const s=document.createElement("div");s.style.cssText="display:flex;gap:8px;justify-content:flex-end;";const d=document.createElement("button");d.textContent=b[v].cancel||"취소";const c=document.createElement("button");c.textContent=b[v].ok||"확인",c.style.cssText="background:#3a7afe;color:#fff;border:0;border-radius:6px;padding:6px 12px;",s.append(d,c),r.append(a,o,s),n.appendChild(r),document.body.appendChild(n);const l=()=>{n.parentNode&&document.body.removeChild(n)};d.onclick=l,c.onclick=()=>{const m=Math.max(20,Math.min(Me,Math.round(Number(o.value||t))));Number.isFinite(m)&&e(m),l()},o.addEventListener("keydown",m=>{m.key==="Enter"&&c.click(),m.key==="Escape"&&l()}),setTimeout(()=>o.focus(),0)}function No(t){const e=yo(),n=B.getBoundingClientRect(),r=t.clientX-n.left,a=C[u.zoomLevel-1],o=i.scrollX,s=u.tempoAnchors||[];let d=null;for(const c of s){const l=Math.round(c.tick/T*a-o)+.5;if(Math.abs(l-r)<=6){d={cssX:l,bpm:c.bpm,tick:c.tick};break}}if(d){const c=Math.floor(d.tick/T/u.timeSig.beatsPerBar)+1,l=Math.floor(d.tick/T%u.timeSig.beatsPerBar)+1;e.textContent=`t${d.bpm} @ ${c}.${l}`,e.style.left=`${Math.floor(d.cssX)}px`;const m=i.keyHeight;e.style.top=`${Math.max(0,Math.floor(m-22))}px`,e.style.display="block"}else e.style.display="none"}function Oe(t){const e=at(i.selectedLength),r=Math.max(0,(a=>de(a,e))(t));for(const a of u.tracks){const o=[];for(const s of a.notes){const d=s.startTick,c=s.startTick+s.durationTick;if(c<=r||d>=r){o.push(s);continue}const l=Math.max(1,r-d),m=Math.max(1,c-r),f={...s,durationTick:l},p={...s,id:crypto.randomUUID(),startTick:r,durationTick:m};p.__tiedFromPrev=!0,o.push(f,p)}o.sort((s,d)=>s.startTick-d.startTick||s.pitch-d.pitch),a.notes=o}}function _o(t){t.key==="Alt"&&(De=!1,N()),mt()}function zo(t){Xe(),mt();const e=document.activeElement;if(e&&(e.tagName==="INPUT"||e.tagName==="TEXTAREA"||e.tagName==="SELECT"||e.isContentEditable))return;t.key==="Alt"&&(t.preventDefault(),De=!0,N());for(let o=1;o<=9;o++)t.key===o.toString()&&an(o-1);if(t.key==="0"&&an(At.length-1),H){t.code==="Space"&&(t.preventDefault(),Pe());return}if((t.key==="ArrowUp"||t.key==="ArrowDown")&&t.shiftKey){const o=document.activeElement;if(o&&(o.tagName==="INPUT"||o.tagName==="SELECT"))return;t.preventDefault();const s=u.tracks.find(p=>p.id===i.activeTrackId);if(!s)return;const d=s.notes.filter(p=>i.selected.has(p.id));if(d.length===0)return;const c=p=>Math.floor(Fe(p)/12),l=Math.min(...d.map(p=>c(p.pitch))),m=Math.max(...d.map(p=>c(p.pitch)));if(t.key==="ArrowUp"&&m>=7||t.key==="ArrowDown"&&l<=1)return;const f=t.key==="ArrowUp"?12:-12;for(const p of s.notes)i.selected.has(p.id)&&(p.pitch=Fe(p.pitch+f));D(),nt({track:s,recomputeLabels:!0});return}if((t.key==="ArrowUp"||t.key==="ArrowDown")&&!t.shiftKey&&!t.ctrlKey&&!t.metaKey&&!t.altKey){const o=document.activeElement;if(o&&(o.tagName==="INPUT"||o.tagName==="SELECT"))return;t.preventDefault();const s=u.tracks.slice().sort((m,f)=>m.order-f.order),d=s.findIndex(m=>m.id===i.activeTrackId);if(d===-1)return;const c=t.key==="ArrowUp"?-1:1,l=Math.max(0,Math.min(s.length-1,d+c));l!==d&&(i.activeTrackId=s[l].id,G(),N(),gt());return}const n=t.ctrlKey||t.metaKey;if(n&&t.key.toLowerCase()==="z"){t.preventDefault();const o=pt.undo(u);o&&(u=o,typeof u.displayBeatsPerBar=="number"&&($=u.displayBeatsPerBar,q&&q.value!==String($)&&(q.value=String($))),i.selected.clear(),N(),G());return}if(n&&t.key.toLowerCase()==="y"){t.preventDefault();const o=pt.redo(u);o&&(u=o,typeof u.displayBeatsPerBar=="number"&&($=u.displayBeatsPerBar,q&&q.value!==String($)&&(q.value=String($))),i.selected.clear(),N(),G());return}if(n&&t.key.toLowerCase()==="a"){t.preventDefault(),Ro();return}if(t.key==="Escape"){i.selected.clear(),i.marquee.active=!1,i.drag=null,i.ghost=null,N();return}if(t.key==="Delete"){Bn();return}if(n&&t.key.toLowerCase()==="c"){t.preventDefault(),In();return}if(n&&t.key.toLowerCase()==="v"){t.preventDefault(),Ho();return}if(n&&t.key.toLowerCase()==="x"){t.preventDefault(),Do();return}if(t.code==="Space"){t.preventDefault(),H?Pe():Rn();return}const r=C[u.zoomLevel-1],a=u.timeSig.beatsPerBar*r;if(t.key==="PageDown"){t.preventDefault(),i.scrollX=Math.max(0,Math.ceil((i.scrollX+1)/a)*a),z();return}if(t.key==="PageUp"){t.preventDefault(),i.scrollX=Math.max(0,Math.floor((i.scrollX-1)/a)*a),z();return}if(t.key==="Home"){t.preventDefault(),i.scrollX=0,z();return}if(t.key==="End"){t.preventDefault();const o=wt();i.scrollX=le(Math.max(0,o-R.clientWidth)),z();return}}function Ro(){i.selected.clear();const t=u.tracks.find(e=>e.id===i.activeTrackId);for(const e of t.notes)i.selected.add(e.id);N()}function Bn(){if(i.selected.size===0)return;const t=u.tracks.find(e=>e.id===i.activeTrackId);t.notes=t.notes.filter(e=>!i.selected.has(e.id)),i.selected.clear(),D(),nt({track:t})}function In(){const e=u.tracks.find(r=>r.id===i.activeTrackId).notes.filter(r=>i.selected.has(r.id));if(e.length===0)return;const n=Math.min(...e.map(r=>r.startTick));i.clipboard=e.map(r=>({...r,startTick:r.startTick-n}))}function Do(){In(),Bn()}function Ho(){if(!i.clipboard||i.clipboard.length===0)return;const t=Math.max(0,Math.floor(Y)),e=u.tracks.find(n=>n.id===i.activeTrackId);e&&xe(async()=>{const{insertNoteWithOverlap:n,ensureBars:r}=await import("./languages-Cgt_gsPd.js").then(a=>a.K);return{insertNoteWithOverlap:n,ensureBars:r}},[],import.meta.url).then(({insertNoteWithOverlap:n,ensureBars:r})=>{if(i.selected.clear(),i.clipboard!=null)for(const a of i.clipboard){const o=crypto.randomUUID(),s={...a,id:o,startTick:Math.max(0,t+a.startTick)};n(u,e.id,s),r(u,s.startTick+s.durationTick),i.selected.add(o)}D(),nt({track:e})})}function Xo(){const e=-R.scrollTop+i.keyHeight;j.style.transform=`translateY(${e}px)`,mt()}function Wo(t){if(yn(t)&&St(),Xe(),mt(),t.ctrlKey){t.preventDefault(),qo(t);return}if(t.altKey&&t.shiftKey&&i.selected.size>0&&!H){t.preventDefault();const e=t.deltaY>0?-1:1,n=u.tracks.find(l=>l.id===i.activeTrackId),r=$t(n),a=new Map(r.map(l=>[l.id,l.volume??I])),o=new Set([...i.selected]),s=r.map((l,m)=>({n:l,i:m})).filter(l=>o.has(l.n.id)).map(l=>l.i).sort((l,m)=>l-m),d=new Map;for(const l of s){const m=r[l].id,f=a.get(m)??I;d.set(l,vt(f+e))}let c=0;for(;c<s.length;){const l=s[c],m=d.get(l);let f=c+1;for(;f<s.length&&s[f]===s[f-1]+1&&d.get(s[f])===m;)f++;const p=l,g=s[f-1],h=p>0?a.get(r[p-1].id)??I:I;for(let y=p;y<=g;y++)r[y].volume=vt(d.get(y));let k=g+1;for(;k<r.length&&o.has(r[k].id);)k++;k<r.length&&(r[k].volume=h,To(n,r[k])),c=f}nt({track:n,recomputeLabels:!0}),D();return}if(t.altKey&&!t.shiftKey&&i.selected.size>0&&!H){t.preventDefault();const e=t.deltaY>0?-1:1,n=u.tracks.find(a=>a.id===i.activeTrackId),r=n.notes.filter(a=>i.selected.has(a.id));if(r.length>0){const a=r.reduce((d,c)=>c.startTick<d.startTick?c:d),o=a.volume??I,s=vt(o+e);xn(n,a,s)}nt({track:n,recomputeLabels:!0}),D();return}if(t.shiftKey){t.preventDefault();const e=C[u.zoomLevel-1],n=u.timeSig.beatsPerBar*e,a=(Math.abs(t.deltaX)>Math.abs(t.deltaY)?t.deltaX:t.deltaY)>0?1:-1,o=wt(),s=Math.max(0,o-R.clientWidth);let d=Math.max(0,Math.min(s,i.scrollX+a*n));if(H){const c=Y/T*e,l=R.clientWidth,m=Math.max(0,Math.min(s,Math.floor(c-l))),f=Math.max(0,Math.min(s,Math.floor(c)));d=Math.max(m,Math.min(f,d));let p=le(d);const g=Math.max(0,Math.min(s,Math.ceil(m/n)*n)),h=Math.max(0,Math.min(s,Math.floor(f/n)*n));g<=h?((p<g||p>h)&&(p=a>0?h:g),d=p):d=i.scrollX}i.scrollX=le(d),z();return}}function qo(t){const e=t.deltaY>0?-1:1,n=Math.max(1,Math.min(9,u.zoomLevel+e));if(n===u.zoomLevel)return;const r=C[u.zoomLevel-1],a=R.getBoundingClientRect(),o=Math.max(0,Math.min(t.clientX-a.left,a.width)),s=i.scrollX+o,d=r*u.timeSig.beatsPerBar,l=Math.max(0,Math.round(s/d)*d)/r*T;u.zoomLevel=n;const m=C[n-1],f=l/T*m,p=wt(),g=Math.max(0,p-R.clientWidth);i.scrollX=Math.max(0,Math.min(g,f-o));const h=m*u.timeSig.beatsPerBar;i.scrollX=Math.max(0,Math.min(g,Math.floor(i.scrollX/h)*h)),ht=-1,N()}function G(){gt();const t=ve;Qe.innerHTML="",u.tracks.slice().sort((n,r)=>n.order-r.order).forEach((n,r)=>{n.color=t[r%t.length],(!n.instrument||!Ne.includes(n.instrument))&&(n.instrument=_e);const a=document.createElement("div");a.dataset.trackId=String(n.id),a.dataset.order=String(n.order);const o=n.id===i.activeTrackId;a.className="track-card",o&&a.classList.add("is-active");const s=document.createElement("div");s.className="track-color",s.style.cssText=`
            background: ${n.color};
        `;const d=document.createElement("div");d.className="track-main";const c=document.createElement("div");c.className="track-row track-row--top";const l=document.createElement("input");l.value=n.name,l.setAttribute("data-i18n-title","tooltipTrackName"),l.title=b[v].tooltipTrackName,c.style.width="100%",l.classList.add("track-name-input"),jn(l,{size:"sm"}),l.addEventListener("change",()=>{pt.push(u),n.name=l.value});const m=document.createElement("div");if(m.className="track-name",m.appendChild(l),c.appendChild(m),o){const g=document.createElement("div");g.className="track-reorder",g.style.marginLeft="auto",g.style.display="inline-flex",g.style.gap="6px";const h=document.createElement("button");h.type="button",h.textContent="▲",h.title="Move up",h.setAttribute("aria-label","Move track up"),h.style.width="24px",h.style.height="24px",h.style.fontSize="12px";const k=document.createElement("button");k.type="button",k.textContent="▼",k.title="Move down",k.setAttribute("aria-label","Move track down"),k.style.width="24px",k.style.height="24px",k.style.fontSize="12px";const y=u.tracks.length-1;h.disabled=n.order===0,k.disabled=n.order===y,h.addEventListener("click",w=>{w.stopPropagation(),on(-1)}),k.addEventListener("click",w=>{w.stopPropagation(),on(1)}),g.append(h,k),c.appendChild(g)}{const g=document.createElement("div");g.className="track-row track-row--middle",g.style.width="100%";const h=Hn(),k=Gn({items:h,value:n.instrument,size:"sm",fullWidth:!0,onChange:M=>{pt.push(u),n.instrument=M}});k.el.setAttribute("data-i18n-title","tooltipInstrument"),k.el.title=b[v].tooltipInstrument;const y=document.createElement("div");y.className="track-instrument",y.appendChild(k.el),g.appendChild(y);const w=document.createElement("div");w.className="track-row track-row--bottom";const x=Ko(n),L=document.createElement("span");L.className="track-charcount";const S=n.optimizedMML?.length||0,X=b[v].charUnit;L.textContent=`${S}${X}`,L.setAttribute("data-i18n-title","tooltipCharCount"),L.title=b[v].tooltipCharCount,w.append(x,L),d.append(c,g,w)}const f=[l];{const g=d.querySelector(".dropdown");g instanceof HTMLElement&&f.push(g),d.querySelectorAll(".track-controls button").forEach(k=>f.push(k))}c.querySelectorAll(".track-reorder button").forEach(g=>f.push(g)),f.forEach(g=>{g.addEventListener("mousedown",h=>h.stopPropagation()),g.addEventListener("mouseup",h=>h.stopPropagation())}),a.addEventListener("click",g=>{const h=g.target.tagName;h==="INPUT"||h==="SELECT"||h==="BUTTON"||g.target.isContentEditable||i.activeTrackId!==n.id&&(i.activeTrackId=n.id,G(),N())}),a.append(s,d),Qe.appendChild(a)})}function on(t){const e=u.tracks.find(s=>s.id===i.activeTrackId);if(!e)return;const n=e.order,r=u.tracks.length-1,a=n+t;if(a<0||a>r)return;const o=u.tracks.find(s=>s.order===a);o&&(e.order=a,o.order=n),D(),G(),K()}function Cn(){Xt.innerHTML="",ue(),At.forEach(t=>{const e=ae({label:String(t),size:"sm",variant:t===i.selectedLength?"primary":"secondary"});t===i.selectedLength&&e.classList.add("active"),e.setAttribute("data-i18n-title","tooltipLength"),t===64?e.title=(b[v].tooltipLength||"Length")+" - 0 (주의: 인게임에서 박자가 어긋날 수 있음)":e.title=b[v].tooltipLength,e.addEventListener("click",()=>{Ve(t)}),t===48&&(e.style.marginRight="12px"),Xt.appendChild(e)}),W.textContent=J?b[v].extendedLessLabel||"더 적은 단위":b[v].extendedMoreLabel||"더 많은 단위",W.title=J?b[v].tooltipExtendedLess||"기본 단위로 돌아가기":b[v].tooltipExtendedMore||"더 많은 단위 사용 (64/128/5/7/11)",W.setAttribute("data-i18n",J?"extendedLessLabel":"extendedMoreLabel"),F(W,J?"tooltipExtendedLess":"tooltipExtendedMore",W.title),W.setAttribute("aria-label",W.title),W.addEventListener("click",Oo),Xt.appendChild(W)}function Oo(){if(!J){const e="mml_editor_warn_extended_shown";let n=!1;try{n=localStorage.getItem(e)==="1"}catch{}if(!n){if(!window.confirm(b[v].confirmEnableExtendedUnits||"Enable more units to use 64/128/5/7/11; existing ticks will be converted. Continue?"))return;try{localStorage.setItem(e,"1")}catch{}}rn(!0)}else rn(!1)}function rn(t){D();const r=(t?ye:be)/(t?be:ye);Ce(u,r),ln(t),u.tpqn=T,u.extendedUnitsEnabled=t;try{pt.transformSnapshots?.(a=>Ce(a,r))}catch{}Vo(),Cn(),N()}function Vo(){if(!At.includes(i.selectedLength)){let t=At[0],e=Math.abs(t-i.selectedLength);for(const n of At){const r=Math.abs(n-i.selectedLength);r<e&&(t=n,e=r)}Ve(t)}}function Ce(t,e){if(!Number.isFinite(e)||e<=0)return;for(const r of t.tracks)for(const a of r.notes)a.startTick=Math.round(a.startTick*e),a.durationTick=Math.max(1,Math.round(a.durationTick*e));const n=t.tempoAnchors;if(Array.isArray(n)){for(const r of n)r.tick=Math.max(0,Math.round(r.tick*e));n.sort((r,a)=>r.tick-a.tick)}t.maxEndTick=Math.round(t.maxEndTick*e)}function Ve(t){if(!Xt)return;i.selectedLength=t;const e=Array.from(Xt.children);e.forEach(n=>n.classList.remove("active")),e.forEach(n=>{if(n instanceof HTMLButtonElement){const a=parseInt(n.textContent||"0",10)===t;a&&n.classList.add("active"),n.classList.remove("btn--primary","btn--secondary"),n.classList.add(a?"btn--primary":"btn--secondary")}}),N(),K()}function Ko(t){const e=document.createElement("div");e.className="track-controls";const n=(o,s,d)=>{const c=document.createElement("button");return c.textContent=o,c.style.cssText=`
            width: 24px;
            height: 24px;
            font-size: 12px;
            font-weight: bold;
            border-radius: 4px;
            border: 1px solid #ccc;
            cursor: pointer;
            background-color: ${s?d:"#fff"};
            color: ${s?"#fff":"#000"};
        `,c},r=n("M",t.mute,"#f44336");r.setAttribute("data-i18n-title","tooltipMute"),r.title=b[v].tooltipMute,r.addEventListener("click",()=>{t.mute=!t.mute,D(),G()});const a=n("S",t.solo,"#ff9800");return a.setAttribute("data-i18n-title","tooltipSolo"),a.title=b[v].tooltipSolo,a.addEventListener("click",()=>{t.solo=!t.solo,D(),G()}),e.append(r,a),e}function an(t){const e=At[t];typeof e=="number"&&Ve(e)}function Uo(t){if(H){i.hover.noteId=null,i.hover.edge=null,_.style.cursor="not-allowed";return}const{x:e,y:n}=ce(t),r=C[u.zoomLevel-1],a=u.tracks.find(o=>o.id===i.activeTrackId);if(!i.drag&&!i.marquee.active){const o=Te(e,n,a.notes,r,i.keyHeight);o?(i.hover.noteId=o.note.id,i.hover.edge=o.edge,_.style.cursor=o.edge==="center"?"move":"ew-resize"):(i.hover.noteId=null,i.hover.edge=null,_.style.cursor="default"),z();return}if(i.marquee.active){i.marquee.x1=e,i.marquee.y1=n;const o=t.ctrlKey||t.metaKey,s=t.shiftKey;i.marquee.mode=o?"toggle":s?"add":"replace";const d=mo(i.marquee.x0,i.marquee.y0,i.marquee.x1,i.marquee.y1,a.notes,r,i.keyHeight),c=new Set(i.selected);if(i.marquee.mode==="replace"){i.selected.clear();for(const l of d)i.selected.add(l.id)}else if(i.marquee.mode==="add")for(const l of d)i.selected.add(l.id);else{i.selected=c;for(const l of d)i.selected.has(l.id)?i.selected.delete(l.id):i.selected.add(l.id)}z()}}function Fo(t){if(St(),mt(),cn(),H){t.preventDefault(),_.style.cursor="not-allowed";return}if(Xe(),t.button===1){t.preventDefault(),xt=!0,Gt(t);return}if(t.button===2){t.preventDefault();const{x:f,y:p}=ce(t),g=C[u.zoomLevel-1],h=u.tracks.find(y=>y.id===i.activeTrackId),k=Te(f,p,h.notes,g,i.keyHeight);if(k)i.selected.has(k.note.id)||(i.selected.clear(),i.selected.add(k.note.id),z()),So(k.note,t.clientX,t.clientY);else{const y=t.ctrlKey||t.metaKey,w=t.shiftKey;i.drag=null,i.ghost=null,i.marquee.active=!0,i.marquee.x0=f,i.marquee.y0=p,i.marquee.x1=f,i.marquee.y1=p,i.marquee.mode=y?"toggle":w?"add":"replace",z()}return}if(t.button!==0)return;const{x:e,y:n}=ce(t),r=C[u.zoomLevel-1],a=u.tracks.find(f=>f.id===i.activeTrackId),o=Te(e,n,a.notes,r,i.keyHeight);if(!o){const f=at(i.selectedLength),p=e/r*T,g=de(p,f),h=Ut(95-Math.floor(n/i.keyHeight)),k=at(i.selectedLength),y=crypto.randomUUID();i.drag={kind:"create",trackId:i.activeTrackId,noteId:y,startTick:g,durationTick:k,pitch:h},i.ghost={startTick:g,durationTick:k,pitch:h,color:ot};const w=u.tracks.find(x=>x.id===i.activeTrackId);w&&oe(h,w.id,w.instrument,rt),z();return}const s=o.note,d=t.ctrlKey||t.metaKey,c=i.selected.has(s.id);d?c||i.selected.add(s.id):c||(i.selected.clear(),i.selected.add(s.id));{const f=u.tracks.find(p=>p.id===i.activeTrackId);f&&oe(s.pitch,f.id,f.instrument,rt)}const l=s.startTick,m=s.startTick+s.durationTick;if(o.edge==="center"){const f=Array.from(i.selected),p=u.tracks.find(h=>h.id===a.id).notes.filter(h=>i.selected.has(h.id)).map(h=>({id:h.id,startTick:h.startTick,pitch:h.pitch,durationTick:h.durationTick,volume:h.volume})),g=at(i.selectedLength);Vt=0,Kt=0,i.moveGroup={trackId:a.id,ids:f,base:p,mouseStartX:e,mouseStartY:n,grid:g},i.drag={kind:"move",trackId:a.id,noteId:s.id,startTick0:l,yPitch0:s.pitch,mouseStartX:e,mouseStartY:n},i.ghost={startTick:s.startTick,durationTick:s.durationTick,pitch:s.pitch,color:ot},z();return}else o.edge==="left"?(i.drag={kind:"resize-left",trackId:a.id,noteId:s.id,startTick0:l,endTick0:m,mouseStartX:e},i.ghost={startTick:s.startTick,durationTick:s.durationTick,pitch:s.pitch,color:ot}):o.edge==="right"&&(i.drag={kind:"resize-right",trackId:a.id,noteId:s.id,startTick0:l,endTick0:m,mouseStartX:e},i.ghost={startTick:s.startTick,durationTick:s.durationTick,pitch:s.pitch,color:ot});z()}function $o(t){if(H)return;if(xt){Gt(t);return}if(i.marquee.active||!i.drag)return;const{x:e,y:n}=ce(t),r=C[u.zoomLevel-1],a=at(i.selectedLength);if(i.drag.kind==="move"||i.drag.kind==="resize-left"||i.drag.kind==="resize-right"){if(i.drag.kind==="move"){const l=document.elementFromPoint(t.clientX,t.clientY)?.closest?.(".track-card");document.querySelectorAll(".track-card.drop-hover").forEach(m=>m.classList.remove("drop-hover")),l&&parseInt(l.dataset.trackId||"-1",10)!==i.drag.trackId&&l.classList.add("drop-hover")}const o=u.tracks.find(c=>i.drag!=null&&c.id===i.drag.trackId),s=o.notes.findIndex(c=>i.drag!=null&&c.id===i.drag.noteId);if(s<0)return;const d=o.notes[s];if(i.drag.kind==="move"){const c=i.moveGroup;if(!c)return;const l=(e-c.mouseStartX)/r,m=Math.floor((c.mouseStartY-n)/i.keyHeight),f=l*T,p=Math.round(f/c.grid)*c.grid;Vt=p,Kt=m;const g=Ut(i.drag.yPitch0+m),h=u.tracks.find(x=>x.id===i.activeTrackId);h&&oe(g,h.id,h.instrument,rt),z();const k=r,y=i.scrollX,w=window.devicePixelRatio||1;tt.save(),tt.setTransform(w,0,0,w,0,0),tt.globalAlpha=.7,tt.fillStyle=ot;for(const x of c.base){const L=Math.max(0,x.startTick+p),S=Math.round(L/T*k)-Math.floor(y)+.5,X=Math.max(1,Math.round(x.durationTick/T*k)),E=(95-Ut(x.pitch+m))*i.keyHeight+.5,P=i.keyHeight-1;tt.fillRect(S,E,X,P)}tt.globalAlpha=1,tt.restore();return}if(i.drag.kind==="resize-left"){const c=(e-i.drag.mouseStartX)/r;let l=i.drag.startTick0+c*T,m=Math.max(0,Math.floor(l/a)*a);m=Math.min(m,i.drag.endTick0-a);const f=i.drag.endTick0-m;i.ghost={startTick:m,durationTick:f,pitch:d.pitch,color:ot};const p=i.drag.endTick0-i.drag.startTick0,g=Math.max(0,p-f),h=at(32),k=u.tracks.find(x=>x.id===i.drag.trackId),y=new Set(i.selected),w=[];if(g>0)for(const x of k.notes){if(x.id===i.drag.noteId||!y.has(x.id))continue;const L=Math.max(h,x.durationTick-g);w.push({startTick:x.startTick,durationTick:L,pitch:x.pitch,color:ot})}i.ghostGroup=w.length?w:null,z();return}if(i.drag.kind==="resize-right"){const c=(e-i.drag.mouseStartX)/r;let l=i.drag.endTick0+c*T,m=Math.max(i.drag.startTick0+a,Math.ceil(l/a)*a);const f=u.tracks.find(S=>S.id===i.drag.trackId),p=i.drag.startTick0,g=f.notes.filter(S=>S.startTick>p).sort((S,X)=>S.startTick-X.startTick)[0];g&&(m=Math.min(m,g.startTick));const h=m-i.drag.startTick0;i.ghost={startTick:i.drag.startTick0,durationTick:h,pitch:d.pitch,color:ot};const k=i.drag.endTick0-i.drag.startTick0,y=Math.max(0,h-k),w=u.tracks.find(S=>S.id===i.drag.trackId),x=new Set(i.selected),L=[];if(y>0)for(const S of w.notes){if(S.id===i.drag.noteId||!x.has(S.id))continue;const X=w.notes.filter(Z=>Z.startTick>S.startTick).sort((Z,U)=>Z.startTick-U.startTick)[0];let M=Number.POSITIVE_INFINITY;X&&(M=Math.max(0,X.startTick-(S.startTick+S.durationTick)));const E=Math.max(0,Math.min(y,M)),P=S.durationTick+E;L.push({startTick:S.startTick,durationTick:P,pitch:S.pitch,color:ot})}i.ghostGroup=L.length?L:null,z();return}}if(i.drag.kind==="create"){const o=i.drag.startTick,s=(e-o/T*r)/r,d=o+Math.max(a,Math.round(s*T)),l=Math.max(o+a,Math.ceil(d/a)*a)-o,m=Ut(95-Math.floor(n/i.keyHeight));i.ghost={startTick:o,durationTick:l,pitch:m,color:ot};const f=u.tracks.find(p=>p.id===i.activeTrackId);f&&oe(m,f.id,f.instrument,rt),z()}}function Yo(){if(H)return;if(xt){xt=!1;return}rt.sampler&&rt.pitch!==null&&(Vn(rt.sampler,rt.pitch),rt.pitch=null,rt.sampler=null);const t=document.activeElement;if(t&&(t.tagName==="INPUT"||t.tagName==="SELECT"||t.isContentEditable))return;if(i.marquee.active){i.marquee.active=!1,z();return}if(!i.drag)return;if(i.drag.kind==="move"&&i.moveGroup){const s=document.elementFromPoint(window.lastPointerX??0,window.lastPointerY??0)?.closest?.(".track-card");if(s){const l=parseInt(s.dataset.trackId||"-1",10),m=i.moveGroup.trackId;if(!Number.isNaN(l)&&l>0&&l!==m){const f=u.tracks.find(k=>k.id===m),p=u.tracks.find(k=>k.id===l),g=new Set(i.moveGroup.ids),h=f.notes.filter(k=>g.has(k.id));if(h.length>0){const k=Math.min(...h.map(x=>x.startTick)),y=Math.max(...h.map(x=>x.startTick+x.durationTick)),w=p.notes.filter(x=>x.startTick<y&&x.startTick+x.durationTick>k);f.notes=f.notes.filter(x=>!g.has(x.id)).concat(w),p.notes=p.notes.filter(x=>!w.includes(x)).concat(h),se(f.notes),se(p.notes),i.selected.clear();for(const x of h)i.selected.add(x.id);i.moveGroup=null,i.drag=null,i.ghost=null,nt({track:f}),nt({track:p}),D(),G();return}}}const d=i.moveGroup;if(Vt===0&&Kt===0){i.moveGroup=null,i.drag=null,i.ghost=null;return}const c=u.tracks.find(l=>l.id===d.trackId);c.notes=c.notes.filter(l=>!d.ids.includes(l.id)),xe(async()=>{const{insertNoteWithOverlap:l,ensureBars:m}=await import("./languages-Cgt_gsPd.js").then(f=>f.K);return{insertNoteWithOverlap:l,ensureBars:m}},[],import.meta.url).then(({insertNoteWithOverlap:l,ensureBars:m})=>{i.selected.clear();for(const f of d.base){const p={id:f.id,startTick:Math.max(0,f.startTick+Vt),durationTick:f.durationTick,pitch:Ut(f.pitch+Kt),velocity:100,volume:f.volume??I};l(u,d.trackId,p),m(u,p.startTick+p.durationTick),i.selected.add(p.id)}i.moveGroup=null,i.drag=null,i.ghost=null,Vt=0,Kt=0,nt({track:c}),D(),K()});return}if(!i.ghost){i.drag=null,document.querySelectorAll(".track-card.drop-hover").forEach(s=>s.classList.remove("drop-hover"));return}const e=i.ghost,n=i.drag.trackId,r=u.tracks.find(s=>s.id===n);let a=I;if(r){const s=$t(r);let d=I;for(let c=0;c<s.length;c++){const l=s[c];if(l.startTick>=e.startTick)break;const m=l.volume??I;vn(s,c,i.volumeLabels),d=m}a=d}const o={id:i.drag.noteId,startTick:e.startTick,durationTick:e.durationTick,pitch:e.pitch,velocity:100,volume:a};xe(async()=>{const{insertNoteWithOverlap:s,ensureBars:d}=await import("./languages-Cgt_gsPd.js").then(c=>c.K);return{insertNoteWithOverlap:s,ensureBars:d}},[],import.meta.url).then(({insertNoteWithOverlap:s,ensureBars:d})=>{const c=u.tracks.find(l=>l.id===n);if(i.drag.kind==="resize-left"||i.drag.kind==="resize-right"){const l=c.notes.findIndex(h=>h.id===i.drag.noteId);l>=0&&c.notes.splice(l,1);const m=i.drag.endTick0-i.drag.startTick0,f=e.durationTick,p=Math.max(0,m-f);if(p>0){const h=at(32),k=new Set(i.selected);for(const y of c.notes)y.id!==i.drag.noteId&&k.has(y.id)&&(y.durationTick=Math.max(h,y.durationTick-p))}const g=Math.max(0,f-m);if(g>0){const h=new Set(i.selected);for(const k of c.notes){if(k.id===i.drag.noteId||!h.has(k.id))continue;const y=c.notes.filter(L=>L.startTick>k.startTick).sort((L,S)=>L.startTick-S.startTick)[0];let w=Number.POSITIVE_INFINITY;y&&(w=Math.max(0,y.startTick-(k.startTick+k.durationTick)));const x=Math.max(0,Math.min(g,w));x>0&&(k.durationTick+=x,d(u,k.startTick+k.durationTick))}}}s(u,n,o),d(u,o.startTick+o.durationTick),i.drag=null,i.ghost=null,i.ghostGroup=null,document.querySelectorAll(".track-card.drop-hover").forEach(l=>l.classList.remove("drop-hover")),nt({track:c,recomputeLabels:!0}),D(),K()})}function z(){Go(),i.isAltDown=De;const t=C[u.zoomLevel-1],e=Y/T*t,n=i.scrollX,r=R.clientWidth,a=n+r;R.clientHeight;const o=u.timeSig.beatsPerBar*t,s=($||u.timeSig.beatsPerBar)*t,d=Math.floor(n/o),c=n-d*o,l=Math.floor(n/s),m=n-l*s;_.style.left=`${-c}px`,V&&(V.style.left=`${-m}px`),V&&ie&&pn(ie,V,u,i,$),eo(tt,u,i,d*o,r+o);const f=e-n;if(H)if(ft==="area"){const h=C[u.zoomLevel-1],k=$||u.timeSig.beatsPerBar,y=h*k,x=Math.floor(e/y)*y-n;ho(tt,_,x,y)}else Je(tt,_,f);else Je(tt,_,f);fo(gn,j,i.keyHeight);const g=-R.scrollTop+i.keyHeight;if(j.style.transform=`translateY(${g}px)`,jo(),H&&e>=a){const h=C[u.zoomLevel-1],k=u.timeSig.beatsPerBar*h,y=Y/T*h,w=Math.floor(y/k)*k,x=wt(),L=Math.max(0,x-R.clientWidth);i.scrollX=Math.max(0,Math.min(L,w))}me(),_n()}function Go(){const t=window.devicePixelRatio||1,e=C[u.zoomLevel-1],r=u.timeSig.beatsPerBar*e,a=(R.clientWidth||800)+r,o=84*i.keyHeight,s=o;_.style.width!==`${a}px`&&(_.style.width=`${a}px`),_.style.height!==`${s}px`&&(_.style.height=`${s}px`);const d=Math.max(1,Math.floor(a*t)),c=Math.max(1,Math.floor(s*t));if((_.width!==d||_.height!==c)&&(_.width=d,_.height=c),V&&ie){const k=(R.clientWidth||800)+r,y=o;V.style.width!==`${k}px`&&(V.style.width=`${k}px`),V.style.height!==`${y}px`&&(V.style.height=`${y}px`);const w=Math.max(1,Math.floor(k*t)),x=Math.max(1,Math.floor(y*t)),L=V.width!==w,S=V.height!==x;(L||S)&&(V.width=w,V.height=x),(L||S||ht!==u.zoomLevel)&&(pn(ie,V,u,i,$),ht=u.zoomLevel)}const l=84*i.keyHeight;(j.width!==Math.floor(48*t)||j.height!==Math.floor(l*t))&&(j.width=Math.floor(48*t),j.height=Math.floor(l*t),t!==1&&gn.setTransform(t,0,0,t,0,0)),j.style.width!=="48px"&&(j.style.width="48px");const m=`${l}px`;j.style.height!==m&&(j.style.height=m);const f=i.keyHeight;ut.style.height!==f+"px"&&(ut.style.height=f+"px");const p=ut.clientWidth||R.clientWidth||800,g=Math.max(1,Math.floor(p*t)),h=Math.max(1,Math.floor(f*t));(B.width!==g||B.height!==h)&&(B.width=g,B.height=h,t!==1&&Ee.setTransform(t,0,0,t,0,0))}function Pe(){H=!1,re().stop(),dn(),me(),_n(),mt()}function Pn(){H=!1,re().stop(),re().position=0,dn(),Y=Mo,me(),z(),mt()}function jo(){const t=C[u.zoomLevel-1],e=$||u.timeSig.beatsPerBar,n=window.devicePixelRatio||1,r=i.keyHeight;ut.style.height!==r+"px"&&(ut.style.height=r+"px");const a=ut.clientWidth||R.clientWidth||800,o=Math.max(1,Math.floor(a*n)),s=Math.max(1,Math.floor(r*n));B.width!==o&&(B.width=o),B.height!==s&&(B.height=s),n!==1&&Ee.setTransform(n,0,0,n,0,0);const d=i.scrollX;po(Ee,B,d,t,e,u,Ft)}function N(){ht=-1,z()}function Nn(){if(!H)return;const t=performance.now(),e=Math.max(0,t-Ie);Ie=t;const n=u.tempoAnchors||[],r=ze(n,u.bpm);Y=On(r,Y,e);const a=Yt();if(Y>=a){Pn();return}z(),requestAnimationFrame(Nn)}function Yt(){let t=0;for(const e of u.tracks)for(const n of e.notes){const r=n.startTick+n.durationTick;r>t&&(t=r)}return t}function me(){if(!Ze)return;const t=Yt(),e=Math.max(0,Math.floor(Y)),n=u.tempoAnchors||[],r=ze(n,u.bpm),a=we(r,e),o=we(r,t);Ze.textContent=`${$e(a)} / ${$e(o)}`}function Jo(t){if(mt(),t.button===2||H)return;const e=B.getBoundingClientRect(),n=t.clientX-e.left,r=An(n);if(r){Ft=r.tick,B._dragAnchorIndex=r.index,B._draggingTempo=!0,B._dragStartTick=r.tick,N();return}xt=!0,Gt(t)}function Zo(t){if(B._draggingTempo===!0){const n=B.getBoundingClientRect(),r=t.clientX-n.left,a=C[u.zoomLevel-1],o=at(i.selectedLength),s=(r+i.scrollX)/a*T,d=de(Math.max(0,Math.floor(s)),o),c=B._dragAnchorIndex,l=u.tempoAnchors||[];c>=0&&c<l.length&&(l[c].tick=d,l.sort((m,f)=>m.tick-f.tick),Ft=d,u.tempoAnchors=l,N());return}xt&&Gt(t)}function Qo(){if(B._draggingTempo===!0){D(),B._draggingTempo=!1,B._dragAnchorIndex=-1,B._dragStartTick=null,K();for(const e of u.tracks)dt(e);N();return}xt=!1}function Gt(t){const{x:e}=Sn(t),n=C[u.zoomLevel-1],r=e/n*T,a=at(i.selectedLength);Y=Math.max(0,Math.floor(r/a)*a),H&&(H=!1),z()}function _n(){const t=wt(),e=t-R.clientWidth;if(e<=1){zt.style.display="none";return}zt.style.display="block";const n=Math.max(20,R.clientWidth/t*zt.clientWidth);Wt.style.width=`${n}px`;const a=i.scrollX/e*(zt.clientWidth-n);Wt.style.left=`${a}px`}function wt(){const t=C[u.zoomLevel-1],e=Math.ceil(Yt()/T);return Math.max(R.clientWidth,Math.ceil(e*t)+R.clientWidth)}function le(t){const e=C[u.zoomLevel-1],n=u.timeSig.beatsPerBar*e,r=Math.round(t/n)*n;return Math.max(0,r)}function zn(){const t=b[v];if(W&&(W.textContent=J?t.extendedLessLabel||"더 적은 단위":t.extendedMoreLabel||"더 많은 단위",W.title=J?t.tooltipExtendedLess||"기본 단위로 돌아가기":t.tooltipExtendedMore||"더 많은 단위 사용 (64/128/5/7/11)",W.setAttribute("data-i18n",J?"extendedLessLabel":"extendedMoreLabel"),W.setAttribute("data-i18n-title",J?"tooltipExtendedLess":"tooltipExtendedMore"),W.setAttribute("aria-label",W.title)),q){const e=t.tooltipDisplayTimeSig||"Display time signature (n/4)";q.title=e,q.setAttribute("data-i18n-title","tooltipDisplayTimeSig"),q.setAttribute("aria-label",e)}}it(W,"ghost","sm");if(q){const t=a=>Math.max(1,Math.min(16,Math.floor(a)));let e=null;try{const a=localStorage.getItem(tn);if(a!=null){const o=Number(a);Number.isFinite(o)&&(e=t(o))}}catch{}const n=e??t(Number(u.displayBeatsPerBar)||Number(u.timeSig?.beatsPerBar)||4);$=n,u.displayBeatsPerBar=n,q.value!==String(n)&&(q.value=String(n));const r=()=>{const a=Number(q.value),o=Number.isFinite(a)?t(a):n;$=o,u.displayBeatsPerBar=o,q.value!==String(o)&&(q.value=String(o));try{localStorage.setItem(tn,String(o))}catch{}ht=-1,D(),N()};q.addEventListener("change",r),q.addEventListener("input",r)}window.addEventListener("resize",()=>{qe(),ht=-1,N()});setTimeout(qe,0);ue();fn();Le&&F(Le,"tooltipPlay",b[v].tooltipPlay);Se&&F(Se,"tooltipPause",b[v].tooltipPause);ct&&(ct.textContent=ft==="area"?b[v].playheadAreaLabel:b[v].playheadLineLabel,F(ct,"tooltipPlayheadToggle",b[v].tooltipPlayheadToggle));Ae&&F(Ae,"tooltipStop",b[v].tooltipStop);Et&&(it(Et,"secondary","md"),Et.setAttribute("data-i18n","edit"),F(Et,"tooltipEditMML",b[v].tooltipEditMML));Qt&&(it(Qt,"secondary","md"),F(Qt,"tooltipConvert",b[v].tooltipConvert));Zt&&(it(Zt,"secondary","md"),F(Zt,"tooltipPaste",b[v].tooltipPaste));Ot&&(it(Ot,"ghost","md"),F(Ot,"tooltipGuide",b[v].tooltipGuide));if(et){const t=(()=>{try{return localStorage.getItem(kn)}catch{return null}})(),e=Math.max(16,Math.min(32,t?parseInt(t,10):i.keyHeight));i.keyHeight=e,et.value=String(e),Lt&&(Lt.textContent=String(e)),et.min="16",et.max="32",et.step="1",F(et,"tooltipKeyHeight",b[v].tooltipKeyHeight||"노트 높이 (16-32)")}te&&(it(te,"ghost","sm"),F(te,"tooltipLangKo",b[v].tooltipLangKo));ee&&(it(ee,"ghost","sm"),F(ee,"tooltipLangJa",b[v].tooltipLangJa));ne&&(it(ne,"ghost","sm"),F(ne,"tooltipLangEn",b[v].tooltipLangEn));_&&(_.setAttribute("data-i18n-title","tooltipPianoRoll"),_.title=b[v].tooltipPianoRoll);B&&(B.setAttribute("data-i18n-title","tooltipRuler"),B.title=b[v].tooltipRuler);Io();N();gt();try{pt.push(u)}catch{}Et?Et.onclick=()=>{const t=u.tracks.find(n=>n.id===i.activeTrackId);if(!t)return;let e=t.optimizedMML?.trim?.()||t.mmlString?.trim?.()||"";if(e=e.replace(/[\r\n]+/g,""),!e)try{e=(un(t.notes??[])||"").trim().replace(/[\r\n]+/g,"")}catch{}Zn(t,n=>{Ln(t,n);try{const r=mn([n],u.bpm);u.tempoAnchors=r,r.length>0&&r[0].tick===0&&Number.isFinite(r[0].bpm)&&(u.bpm=r[0].bpm);for(const a of r)Oe(a.tick)}catch{}u.maxEndTick=Yt(),dt(t);for(const r of u.tracks)r!==t&&dt(r);K(),gt(),G()},e)}:u=sn();zn();W.id="btnToggleExtended";W.style.marginLeft="8px";W.textContent=J?b[v].extendedLessLabel||"더 적은 단위":b[v].extendedMoreLabel||"더 많은 단위";Re.onmessage=t=>{const{trackId:e,optimizedMML:n,originalBody:r}=t.data,a=u.tracks.find(o=>o.id===e);a&&(a.optimizedMML=n,a.originalBody=r??"",G(),gt(),Bt())};bo?.addEventListener("click",()=>{wn(T)});vo?.addEventListener("click",()=>{const t=T*Tn();wn(t)});xo?.addEventListener("click",()=>{Mn(T)});wo?.addEventListener("click",()=>{const t=T*Tn();Mn(t)});(function(){yt&&(yt.textContent=b[v].trackMMLLabel||"트랙MML",yt.setAttribute("data-i18n","trackMMLLabel"),yt.setAttribute("data-i18n-title","tooltipEditMML"),yt.title=b[v].tooltipEditMML)})();i.moveGroup=null;(function(){const e="2025-09-03-tempo-mobile",n="mml_editor_whatsnew_shown_"+e;let r=!1;try{r=localStorage.getItem(n)==="1"}catch{}r||setTimeout(()=>go(e),0)})();async function tr(){try{pt.push(u);const t=await navigator.clipboard.readText();if(!t.trim().startsWith("MML@")){alert(b[v].invalid_mml_format||"MML 형식이 아닙니다.");return}let e=t.trim().substring(4);e=e.replace(/\r?\n/g,"").replace(/;+$/g,"");const n=e.split(",").map(o=>o.replace(/;+$/g,"").trim());if(n.length>6){alert("트랙은 최대 6개까지만 지원합니다.");return}try{const o=mn(n,u.bpm);u.tempoAnchors=o,o.length>0&&o[0].tick===0&&Number.isFinite(o[0].bpm)&&(u.bpm=o[0].bpm)}catch{}const r=[];for(let o=0;o<u.tracks.length;o++){const s=n[o]?n[o]:"",d=u.tracks[o],c=d.notes?.length||0;try{if(s&&s.length>0)try{d.optimizedMML=Un(s)||s}catch{d.optimizedMML=s}else d.optimizedMML="";Ln(d,s),(d.notes?.length||0)>c&&r.push(d)}catch{alert(b[v].invalid_mml_format||"MML 형식이 아닙니다.");return}}u.maxEndTick=Yt();const a=u.tempoAnchors||[];if(a.length>0)for(const o of a)Oe(o.tick);r.length>0&&We(r),G(),Bt(),K()}catch{}}async function Rn(){if(H)return;H=!0,await Xn(),mt();const t=Bo(),e=u.tempoAnchors||[];await Wn(t,u.bpm,{tempoAnchors:e});const n=ze(e,u.bpm);re().position=we(n,Y),Ie=performance.now();{const r=C[u.zoomLevel-1],a=u.timeSig.beatsPerBar*r,o=Y/T*r,s=Math.floor(o/a)*a,d=wt(),c=Math.max(0,d-R.clientWidth);i.scrollX=Math.max(0,Math.min(c,s))}me?.(),Nn()}const Ke=()=>{const t=window.visualViewport?window.visualViewport.height:window.innerHeight;document.documentElement.style.setProperty("--app-100dvh",t+"px")};Ke();window.addEventListener("resize",Ke);window.visualViewport?.addEventListener("resize",Ke);
