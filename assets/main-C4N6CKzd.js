import{t as b,c as v,T,P as C,D as I,a as an,H as Rn,e as sn,s as cn,E as ke,B as ye,b as be,I as Pe,d as Ne,i as Dn,L as At,f as dt,g as _e,p as oe,_ as ve,h as Ue,j as Hn,k as Xn,l as ze,m as xe,n as re,o as ln,q as J,M as we,r as Wn,u as Fe,v as qn,w as On}from"./languages-BtlVKnIV.js";import{notesToMMLRaw as dn,notesToMML as Vn,extractTempoAnchorsFromMMLBodies as un,newOptimizeBody as Kn,mmlToNotes as Un}from"./converter-CkwVJ9Tw.js";import{e as de,c as ae}from"./button-WIurEURm.js";import{showConvertModal as Fn}from"./convertModal-BLF7nzuU.js";import{showGuideModal as $e}from"./guideModal-BdgfNXBJ.js";let Ye=!1;function $n(){if(Ye)return;const t=`
  :root {
    --dd-radius: 6px;
    --dd-border: #cfcfcf;
    --dd-border-hover: #b5b5b5;
    --dd-bg: #fff;
    --dd-text: #111;
    --dd-muted: #6b7280;
    --dd-shadow: 0 8px 24px rgba(0,0,0,0.12), 0 2px 6px rgba(0,0,0,0.08);
    --dd-focus: 0 0 0 3px rgba(33,150,243,0.15);
  }

  .dropdown { position: relative; display: inline-flex; }
  .dropdown--full { width: 100%; }

  .dropdown__button {
    display: inline-flex; align-items: center; justify-content: space-between;
    gap: 8px; width: 100%;
    background: var(--dd-bg);
    color: var(--dd-text);
    border: 1px solid var(--dd-border);
    border-radius: var(--dd-radius);
    cursor: pointer; user-select: none;
    transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
  }
  .dropdown__button:hover { border-color: var(--dd-border-hover); }
  .dropdown__button:focus-visible { outline: none; box-shadow: var(--dd-focus); }

  .dropdown__button--sm { height: 28px; padding: 4px 8px; font-size: 12px; }
  .dropdown__button--md { height: 34px; padding: 6px 10px; font-size: 14px; }
  .dropdown__button--lg { height: 40px; padding: 8px 12px; font-size: 16px; }

  .dropdown__caret { width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 6px solid #888; }

  .dropdown__menu {
    position: absolute; left: 0; top: calc(100% + 4px);
    min-width: 100%;
    background: #fff; border: 1px solid var(--dd-border);
    border-radius: var(--dd-radius);
    box-shadow: var(--dd-shadow);
    padding: 6px; margin: 0; list-style: none;
    z-index: 1000; display: block; opacity: 0; transform: var(--dd-transform, translateY(4px));
    pointer-events: none; transition: opacity .16s ease, transform .16s ease;
  }
  .dropdown__menu[data-open="true"] { opacity: 1; transform: translateY(0); pointer-events: auto; }

  .dropdown__item {
    padding: 6px 8px; border-radius: 6px; cursor: pointer;
    white-space: nowrap; color: var(--dd-text);
  }
  .dropdown__item[aria-selected="true"] { background: #eef6ff; }
  .dropdown__item:hover { background: #f3f4f6; }
  .dropdown__item:focus { outline: none; box-shadow: var(--dd-focus); }
  `,e=document.createElement("style");e.id="dropdown-styles",e.textContent=t,document.head.appendChild(e),Ye=!0}function Yn(t){$n();const e=t.size??"md";let n=t.value??t.items[0]?.value??"",o=t.items;const a=document.createElement("div");a.className="dropdown",a.classList.add("dropdown--full");const r=document.createElement("button");r.type="button",r.className=`dropdown__button dropdown__button--${e}`,r.setAttribute("aria-haspopup","listbox"),r.setAttribute("aria-expanded","false");const s=document.createElement("span");s.textContent=t.items.find(M=>M.value===n)?.label??"";const d=document.createElement("i");d.className="dropdown__caret",r.append(s,d);const c=document.createElement("ul");c.className="dropdown__menu",c.setAttribute("role","listbox"),c.setAttribute("tabindex","-1");const l=a;let m=!1;function f(){c.innerHTML="";for(const M of o){const E=document.createElement("li");E.className="dropdown__item",E.setAttribute("role","option"),E.setAttribute("tabindex","0"),E.setAttribute("aria-selected",String(M.value===n)),E.textContent=M.label,E.addEventListener("click",()=>x(M.value)),E.addEventListener("keydown",P=>{P.key==="Enter"||P.key===" "?(P.preventDefault(),x(M.value)):P.key==="Escape"?(P.preventDefault(),g(),r.focus()):P.key==="ArrowDown"?(P.preventDefault(),L(E)):P.key==="ArrowUp"&&(P.preventDefault(),S(E))}),c.appendChild(E)}}function p(){f(),m||(document.body.appendChild(c),m=!0,c.style.position="fixed",c.style.zIndex="1000");const M=r.getBoundingClientRect();c.style.minWidth=M.width+"px",w(),c.dataset.open="true",r.setAttribute("aria-expanded","true"),window.addEventListener("mousedown",k,{capture:!0}),window.addEventListener("scroll",y,!0),window.addEventListener("resize",y)}function g(){delete c.dataset.open,r.setAttribute("aria-expanded","false"),m&&(l.appendChild(c),m=!1,c.style.position="",c.style.left="",c.style.top="",c.style.minWidth="",c.style.zIndex=""),window.removeEventListener("mousedown",k,{capture:!0}),window.removeEventListener("scroll",y,!0),window.removeEventListener("resize",y)}function h(){c.dataset.open==="true"?g():p()}function k(M){const E=M.target;a.contains(E)||c.contains(E)||g()}function y(){c.dataset.open==="true"&&w()}function w(){const M=r.getBoundingClientRect(),E=c.getBoundingClientRect(),P=window.innerHeight,Z=window.innerWidth,U=8,kt=4,Ke=Math.max(E.width,M.width);let Mt=Math.min(Math.max(M.left,U),Math.max(U,Z-Ke-U));const It=P-M.bottom-U,jt=M.top-U;let Jt=!1,Tt=Math.min(360,Math.max(It-kt,120));E.height>It&&jt>It&&(Jt=!0,Tt=Math.min(360,Math.max(jt-kt,120)));let Ct;Jt?(Ct=Math.max(U,M.top-kt-Math.min(E.height,Tt)),c.dataset.placement="top",c.style.setProperty("--dd-transform","translateY(-4px)")):(Ct=Math.min(P-U-Math.min(E.height,Tt),M.bottom+kt),c.dataset.placement="bottom",c.style.setProperty("--dd-transform","translateY(4px)")),c.style.top=`${Math.round(Ct)}px`,c.style.left=`${Math.round(Mt)}px`,c.style.maxHeight=`${Tt}px`,c.style.overflowY="auto"}function x(M){if(M===n){g(),r.focus();return}n=M,s.textContent=o.find(E=>E.value===n)?.label??"",g(),r.focus(),t.onChange(n)}function L(M){const E=Array.from(c.querySelectorAll(".dropdown__item")),P=E.indexOf(M);E[Math.min(E.length-1,P+1)]?.focus()}function S(M){const E=Array.from(c.querySelectorAll(".dropdown__item")),P=E.indexOf(M);E[Math.max(0,P-1)]?.focus()}r.addEventListener("click",()=>h()),r.addEventListener("keydown",M=>{if(M.key==="ArrowDown"||M.key==="Enter"||M.key===" ")M.preventDefault(),p();else if(M.key==="ArrowUp"){M.preventDefault(),p();const E=c.querySelectorAll(".dropdown__item");E[E.length-1]?.focus()}});function X(M){o=M;const E=o.find(P=>P.value===n);E?s.textContent=E.label:s.textContent="",c.dataset.open==="true"&&f()}return a.append(r,c),{el:a,get value(){return n},set value(M){x(M)},updateItems:X}}let Ge=!1;function mn(){if(Ge)return;const t=`
  :root {
    --fc-radius: 6px;
    --fc-border: #cfcfcf;
    --fc-border-hover: #b5b5b5;
    --fc-border-focus: #2196f3;
    --fc-bg: #ffffff;
    --fc-bg-disabled: #f7f7f7;
    --fc-text: #111;
    --fc-placeholder: #9aa0a6;
    --fc-shadow-focus: 0 0 0 3px rgba(33,150,243,0.15);
  }

  .input, .select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    box-sizing: border-box;
    font: inherit;
    color: var(--fc-text);
    background: var(--fc-bg);
    border: 1px solid var(--fc-border);
    border-radius: var(--fc-radius);
    outline: none;
    transition: border-color .2s ease, box-shadow .2s ease, background .2s ease, transform .15s ease;
  }

  .input::placeholder {
    color: var(--fc-placeholder);
  }

  .input:hover, .select:hover {
    border-color: var(--fc-border-hover);
  }

  .input:focus, .select:focus {
    border-color: var(--fc-border-focus);
    box-shadow: var(--fc-shadow-focus);
  }

  /* Sizes */
  .fc--sm { height: 28px; padding: 4px 8px; font-size: 12px; }
  .fc--md { height: 34px; padding: 6px 10px; font-size: 14px; }
  .fc--lg { height: 40px; padding: 8px 12px; font-size: 16px; }

  /* Full width helper */
  .fc--full { width: 100%; }

  /* Number inputs: right align helper */
  .fc--num-right { text-align: right; }

  /* Disabled */
  .input:disabled, .select:disabled { background: var(--fc-bg-disabled); color: #888; cursor: not-allowed; }

  /* Select arrow */
  .select {
    background-image: url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5' stroke='%23888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 16px 16px;
    padding-right: 28px; /* space for arrow */
  }

  /* Remove default arrow on some browsers */
  .select::-ms-expand { display: none; }
  `,e=document.createElement("style");e.id="form-control-styles",e.textContent=t,document.head.appendChild(e),Ge=!0}function Gn(t,e){mn(),t.classList.add("input");const n=e?.size;t.classList.add(jn(n)),t.classList.add("fc--full"),e?.rightAlign&&t.classList.add("fc--num-right")}function jn(t){return t==="sm"?"fc--sm":t==="lg"?"fc--lg":"fc--md"}let ct=null,Q=null,Rt=null,Dt=null,Pt=null;function Jn(t,e,n){if(ct||Zn(),!ct||!Q||!Rt||!Dt)return;Q.value=(n??t.mmlString)||"",ct.style.display="flex",Q.focus();const o=r=>{r.stopPropagation()};Q.addEventListener("keydown",o),Q.addEventListener("keyup",o);function a(){ct.style.display="none",Q.removeEventListener("keydown",o),Q.removeEventListener("keyup",o),Rt.onclick=null,Dt.onclick=null,Pt&&(window.removeEventListener("keydown",Pt,!0),Pt=null)}Rt.onclick=()=>{e(Q.value),a()},Dt.onclick=a,Pt=r=>{r.key==="Escape"&&(r.stopPropagation(),a())},window.addEventListener("keydown",Pt,!0)}function Zn(){ct=document.createElement("div"),ct.id="mmlEditModal",ct.style.cssText=`
    position: fixed; 
    left: 0; top: 0; 
    width: 100vw; 
    height: 100vh;
    background: rgba(0,0,0,0.25); 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    z-index: 200;
    display: none;
  `;const t=document.createElement("div");t.style.cssText=`
            background: #fff;
            padding: 24px;
            border-radius: 8px;
            min-width: 400px;
            box-shadow: 0 2px 16px #0002;
            display: flex;
            flex-direction: column;
            gap: 12px;
        `,Q=document.createElement("textarea"),Q.style.cssText=`
            width: 100%;
            min-height: 120px;
            font-family: monospace;
            font-size: 15px;
            word-break: break-all;
            overflow-x: wrap;
        `,de(),Rt=ae({label:b[v].ok,variant:"primary",attrs:{"data-i18n":"ok"}}),Dt=ae({label:b[v].cancel,variant:"secondary",attrs:{"data-i18n":"cancel"}});const e=document.createElement("div");e.style.cssText=`
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        `,e.append(Dt,Rt),t.append(Q,e),ct.appendChild(t),document.body.appendChild(ct)}function Qn(){return{scrollX:0,scrollY:0,keyHeight:16,activeTrackId:1,selectedLength:16,hover:{noteId:null,edge:null},drag:null,ghost:null,ghostGroup:null,selected:new Set,marquee:{active:!1,x0:0,y0:0,x1:0,y1:0,mode:"replace"},clipboard:null,volumeLabels:new Set}}function to(t,e,n,o,a,r,s){t.save();const d=window.devicePixelRatio||1;t.setTransform(d,0,0,d,0,0);const c=t.canvas.clientWidth||t.canvas.width/d,l=t.canvas.clientHeight||t.canvas.height/d;t.clearRect(0,0,c,l),ro(t,e,n,o,a),io(t,n,e,o),so(t,e,n,o,a),co(t,e,n,o,a),lo(t,n,o),oo(t,e,o,a,l),t.restore()}function fn(t,e,n,o,a){const r=window.devicePixelRatio||1;t.setTransform(r,0,0,r,0,0);const s=e.clientWidth||e.width/r,d=e.clientHeight||e.height/r;t.clearRect(0,0,s,d),t.fillStyle="#ffffff",t.fillRect(0,0,s,d);const c=84*o.keyHeight;eo(t,0,s,o),no(t,n,0,s,c,a)}function Ht(t,e,n,o,a,r){const s=Math.max(0,Math.min(r,Math.floor(Math.min(o,a)/2))),d=Math.floor(e),c=Math.floor(n),l=d+Math.max(0,o),m=c+Math.max(0,a);if(t.beginPath(),s<=0){t.rect(d,c,o,a);return}t.moveTo(d+s,c),t.lineTo(l-s,c),t.arcTo(l,c,l,c+s,s),t.lineTo(l,m-s),t.arcTo(l,m,l-s,m,s),t.lineTo(d+s,m),t.arcTo(d,m,d,m-s,s),t.lineTo(d,c+s),t.arcTo(d,c,d+s,c,s)}function eo(t,e,n,o){const a=o.keyHeight,r=84*a,s=Math.ceil(r/a);for(let d=0;d<s;d++){const c=d*a,m=((95-d)%12+12)%12,f=m===1||m===3||m===6||m===8||m===10;t.fillStyle=f?"#d6d6d6":"#ffffff",t.fillRect(e,c,Math.max(0,n),a);const p=m===11;t.strokeStyle=p?"#000000":"rgb(153,153,153)",t.beginPath(),t.moveTo(e,c+.5),t.lineTo(e+Math.max(0,n),c+.5),t.stroke()}}function no(t,e,n,o,a,r){const s=C[e.zoomLevel-1],d=r&&r>=1?r:e.timeSig.beatsPerBar,c=Math.max(0,Math.floor(n/s)-2),l=Math.floor((n+o)/s)+2;for(let f=c;f<=l;f++){const p=Math.floor(f*s),g=f%d===0;t.strokeStyle=g?"#000":"rgb(128,128,128)",t.beginPath(),t.moveTo(p,0),t.lineTo(p,a),t.stroke()}const m=e.zoomLevel;m>=4&&me(t,n,o,a,s,2,"rgb(191,191,191)"),m>=6&&me(t,n,o,a,s,4,"rgb(191,191,191)"),m>=8&&me(t,n,o,a,s,8,"rgb(191,191,191)")}function me(t,e,n,o,a,r,s){const d=Math.max(0,Math.floor(e/a)-2),c=Math.floor((e+n)/a)+2;t.strokeStyle=s;for(let l=d;l<=c;l++)for(let m=1;m<r;m+=2){const f=Math.floor((l+m/r)*a);t.beginPath(),t.moveTo(f,0),t.lineTo(f,o),t.stroke()}}function oo(t,e,n,o,a){const r=e.tempoAnchors||[];if(!r||r.length===0)return;const s=C[e.zoomLevel-1];t.save(),t.strokeStyle="rgba(159, 215, 255, 0.9)",t.lineWidth=1;for(const d of r){const c=Math.round(d.tick/T*s);if(c+1<n||c-1>n+o)continue;const l=c-Math.floor(n)+.5;t.beginPath(),t.moveTo(l,0),t.lineTo(l,a),t.stroke()}t.restore()}function ro(t,e,n,o,a){const r=C[e.zoomLevel-1],s=n.activeTrackId,d=[...e.tracks].sort((c,l)=>c.id===s?1:l.id===s?-1:0);for(const c of d){const l=c.id===s?1:.5;t.globalAlpha=l;for(const m of c.notes){const f=Math.round(m.startTick/T*r),p=Math.max(1,Math.round(m.durationTick/T*r));if(f+p<o||f>o+a)continue;const g=f-Math.floor(o);ao(t,g,m,c.color,r,n.keyHeight,n.hover,c.id===s,n.selected.has(m.id))}}t.globalAlpha=1}function ao(t,e,n,o,a,r,s,d,c){const l=Math.max(1,Math.round(n.durationTick/T*a)),m=(95-n.pitch)*r+1,f=r-1,p=Math.min(6,Math.floor(f/2));if(t.fillStyle=o,Ht(t,e,m,l,f,p),t.fill(),t.strokeStyle="rgba(0,0,0,0.3)",t.lineWidth=1,Ht(t,e,m,l-1,f-1,Math.max(0,p-1)),t.stroke(),c&&(t.strokeStyle="#3a7afe",t.lineWidth=2,Ht(t,e,m,l-1,f-1,Math.max(0,p-1)),t.stroke(),t.lineWidth=1),d&&s.noteId===n.id){const g=Math.min(8,Math.floor(l/3));t.fillStyle="rgba(0,0,0,0.15)",t.fillRect(e,m,g,f),t.fillRect(e+l-g,m,g,f)}}function io(t,e,n,o){const a=C[n.zoomLevel-1],r=s=>{const d=Math.round(s.startTick/T*a)-Math.floor(o),c=Math.max(1,Math.round(s.durationTick/T*a)),l=(95-s.pitch)*e.keyHeight+1,m=e.keyHeight-1;t.globalAlpha=.7,t.fillStyle=s.color;const f=Math.min(6,Math.floor(m/2));Ht(t,d,l,c,m,f),t.fill(),t.globalAlpha=1};if(e.ghost&&r(e.ghost),e.ghostGroup)for(const s of e.ghostGroup)r(s)}function so(t,e,n,o,a){const r=C[e.zoomLevel-1],s=n.keyHeight;t.strokeStyle="#3a7afe",t.lineWidth=2;for(const d of e.tracks)for(const c of d.notes){if(!n.selected.has(c.id))continue;const l=Math.round(c.startTick/T*r)-Math.floor(o),m=Math.max(1,Math.round(c.durationTick/T*r)),f=l+Math.floor(o);if(f+m<o||f>o+a)continue;const p=(95-c.pitch)*s+1,g=s-1,h=Math.min(6,Math.floor(g/2));Ht(t,l,p,m-1,g-1,Math.max(0,h-1)),t.stroke()}t.lineWidth=1}function co(t,e,n,o,a){if(!n.volumeLabels||n.volumeLabels.size===0)return;const r=C[e.zoomLevel-1],s=n.keyHeight;t.font="10px sans-serif",t.textAlign="left",t.textBaseline="bottom";for(const d of e.tracks)for(const c of d.notes){if(!n.volumeLabels.has(c.id))continue;const l=Math.round(c.startTick/T*r),m=Math.max(1,Math.round(c.durationTick/T*r));if(l+m<o||l>o+a)continue;const f=l-Math.floor(o),p=(95-c.pitch)*s+1,g="V"+String(c.volume??I);t.fillStyle="rgba(255,255,255,0.9)",t.fillText(g,f+1,p-1),t.fillStyle="rgba(0,0,0,0.85)",t.fillText(g,f,p-2)}}function lo(t,e,n){if(!e.marquee.active)return;const o=Math.min(e.marquee.x0,e.marquee.x1)-Math.floor(n),a=Math.min(e.marquee.y0,e.marquee.y1),r=Math.abs(e.marquee.x1-e.marquee.x0),s=Math.abs(e.marquee.y1-e.marquee.y0);t.fillStyle="rgba(58,122,254,0.15)",t.fillRect(o,a,r,s),t.strokeStyle="rgba(58,122,254,0.8)",t.setLineDash([4,3]),t.strokeRect(o+.5,a+.5,r-1,s-1),t.setLineDash([])}function Me(t,e,n,o,a){for(let r=n.length-1;r>=0;r--){const s=n[r],d=Math.round(s.startTick/T*o),c=Math.max(1,Math.round(s.durationTick/T*o)),l=(95-s.pitch)*a+1,m=a-1;if(t>=d&&t<=d+c&&e>=l&&e<=l+m){const f=Math.min(8,Math.floor(c/3)),p=t<=d+f?"left":t>=d+c-f?"right":"center";return{note:s,edge:p}}}}function uo(t,e,n,o,a,r,s){const d=Math.min(t,n),c=Math.max(t,n),l=Math.min(e,o),m=Math.max(e,o),f=[];for(const p of a){const g=Math.round(p.startTick/T*r),h=Math.max(1,Math.round(p.durationTick/T*r)),k=(95-p.pitch)*s+1,y=s-1,w=g+h,x=k+y;w>=d&&g<=c&&x>=l&&k<=m&&f.push(p)}return f}function mo(t,e,n){t.clearRect(0,0,e.width,e.height);const o=window.devicePixelRatio||1,a=12*n;for(let r=0;r<7;r++){const s=(6-r)*a,d=r%2===1;t.fillStyle=d?"#e6e6e6":"#ffffff",t.fillRect(0,s,e.width/o,a),t.fillStyle="#222",t.font=`${Math.max(10,Math.round(12))}px system-ui, sans-serif`,t.textBaseline="middle",t.textAlign="center";const c="o"+(r+1),l=s+a/2;t.fillText(c,Math.floor(e.width/o/2),Math.floor(l))}}function fo(t,e,n,o,a,r,s){const d=e.width,c=e.height,l=window.devicePixelRatio||1;t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,d,c),l!==1&&t.setTransform(l,0,0,l,0,0);const m=d/l,f=c/l;t.fillStyle="#ffffff",t.fillRect(0,0,m,f);const p=Math.floor(n/o),g=Math.ceil((n+m)/o);for(let y=p;y<=g;y++){const w=Math.round(y*o-n)+.5;if(y%a===0){t.strokeStyle="#000000",t.beginPath(),t.moveTo(w,0),t.lineTo(w,f),t.stroke();const L=Math.floor(y/a)+1;t.fillStyle="#222",t.font="12px system-ui, sans-serif",t.textAlign="left",t.textBaseline="top",t.fillText(String(L),w+4,2)}else{t.strokeStyle="rgb(128,128,128)";const L=Math.floor(f*.5);t.beginPath(),t.moveTo(w,L),t.lineTo(w,f),t.stroke()}}const h=r,k=h&&Array.isArray(h.tempoAnchors)?h.tempoAnchors:[];if(k&&k.length>0){t.save();const y=Math.max(9,Math.min(13,Math.floor(f*.6)));t.font=`${y}px system-ui, sans-serif`,t.textAlign="center",t.textBaseline="middle";for(const w of k){const x=w.tick/T*o,L=Math.round(x-n)+.5;if(L<-40||L>m+40)continue;const S=s!=null&&w.tick===s,X="t"+String(w.bpm),M=t.measureText(X),E=(M.actualBoundingBoxAscent||y*.8)+(M.actualBoundingBoxDescent||y*.2),P=Math.max(4,Math.floor(y*.5)),Z=Math.max(2,Math.floor(y*.3)),U=Math.ceil(E)+Z*2,kt=Math.ceil(M.width)+P*2;let Mt=f-U-2;Mt<.5&&(Mt=.5);const It=Math.floor(L-kt/2)+.5,jt=S?"#7cc7ff":"#bfe7ff",Jt=S?"#2f9dff":"#5bb6ff",Tt="#003";t.fillStyle=jt,t.strokeStyle=Jt,t.lineWidth=1,t.beginPath(),t.rect(It,Mt,kt,U),t.fill(),t.stroke(),t.fillStyle=Tt;const Ct=Mt+U/2;t.fillText(X,L,Math.floor(Ct))}t.restore()}}function je(t,e,n){const o=window.devicePixelRatio||1,a=e.clientHeight||e.height/o;t.save(),t.setTransform(o,0,0,o,0,0),t.strokeStyle="rgba(255,0,0,0.9)",t.lineWidth=2,t.beginPath(),t.moveTo(Math.floor(n)+.5,0),t.lineTo(Math.floor(n)+.5,a),t.stroke(),t.restore()}function po(t,e,n,o){const a=window.devicePixelRatio||1,r=e.clientHeight||e.height/a;t.save(),t.setTransform(a,0,0,a,0,0),t.fillStyle="rgba(255,0,0,0.12)",t.fillRect(Math.floor(n),0,Math.ceil(o),r),t.restore()}function ho(t,e){const n=document.createElement("div");n.style.cssText=`
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    `;const o=document.createElement("div");o.style.cssText=`
        background: #fff;
        width: min(640px, 92vw);
        max-height: 80vh;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        padding: 18px 18px 14px;
        position: relative;
        overflow: auto;
    `;const a=document.createElement("h2");a.textContent=b[v].whatsNewTitle||"What's new",a.style.margin="0 0 8px 0",a.style.fontSize="18px",a.setAttribute("data-i18n","whatsNewTitle");const r=document.createElement("div"),s=(m,f)=>{const p=document.createElement("ul");return p.style.margin="6px 0 0 18px",p.style.padding="0",m.forEach((g,h)=>{const k=document.createElement("li");k.textContent=g;const y=f[h];y&&k.setAttribute("data-i18n",y),p.append(k)}),p};{const m=document.createElement("h3");m.textContent=b[v].whatsNew_20250907_heading||"Mid-tempo conversion caution",m.setAttribute("data-i18n","whatsNew_20250907_heading"),m.style.margin="8px 0 6px 0";const f=[b[v].whatsNew_20250907_p1||"Turning on 'Apply mid-tempo' runs an experimental transform to align mid tempo positions.",b[v].whatsNew_20250907_p2||"Repeatedly reconverting an already fixed output can accumulate timing drift.",b[v].whatsNew_20250907_p3||"Recommendation: Keep original OFF version and regenerated ON version separately."],p=["whatsNew_20250907_p1","whatsNew_20250907_p2","whatsNew_20250907_p3"];r.append(m,s(f,p))}de();const d=ae({label:b[v].ok||"OK",size:"sm",variant:"primary"});d.setAttribute("data-i18n","ok"),d.style.marginTop="12px",d.style.alignSelf="flex-end";const c=()=>{n.remove();try{localStorage.setItem("mml_editor_whatsnew_shown_"+t,"1")}catch{}};d.addEventListener("click",c);const l=m=>{m.key==="Escape"&&c()};window.addEventListener("keydown",l,{once:!0}),n.addEventListener("click",m=>{m.target===n&&c()}),o.append(a,r,d),n.appendChild(o),document.body.appendChild(n)}const Et=document.getElementById("footerMmlEditBtn"),fe=document.getElementById("footerMMLText"),yt=document.getElementById("footerLabel"),Zt=document.getElementById("btnPasteMML"),pn="mml_editor_project";let u=an();const pt=new Rn,i=Qn(),Re=new Worker(new URL(""+new URL("mmlOptimizerWorker-BJRHh5wT.js",import.meta.url).href,import.meta.url),{type:"module"}),pe=new Map,go=300;let he=null;const Je=document.getElementById("progress"),_=document.getElementById("roll"),V=document.getElementById("rollBg"),j=document.getElementById("octaveCanvas");let A=null,O=null,Nt=null,_t=null,bt=null;const B=document.getElementById("timeRuler"),tt=_.getContext("2d"),ie=V?V.getContext("2d"):null,hn=j.getContext("2d"),Te=B.getContext("2d"),Ze=document.getElementById("tracks"),Xt=document.getElementById("lenBar"),q=document.getElementById("dispSigN");let $=4;const Qe="mml_editor_display_timesig_n",R=document.getElementById("rollViewport"),ut=document.getElementById("rulerContainer"),zt=document.getElementById("customScrollbar"),Wt=document.getElementById("customScrollbarThumb"),Ee=document.getElementById("btnPlay"),Le=document.getElementById("btnPause"),Se=document.getElementById("btnStop"),st=document.getElementById("btnPlayheadMode"),Qt=document.getElementById("btnConvert");let qt=null;function ko(){if(!qt){const t=document.createElement("div");t.style.cssText="position:absolute;pointer-events:none;background:rgba(0,0,0,0.8);color:#fff;padding:4px 6px;border-radius:4px;font:12px system-ui, sans-serif;z-index:10;transform:translate(-50%, -120%);white-space:nowrap;display:none;",ut.style.position="relative",ut.appendChild(t),qt=t}return qt}const Ot=document.getElementById("btnGuide"),it=document.getElementById("btnLoad"),Ae=document.getElementById("btnGoToMobile"),te=document.getElementById("langKo"),ee=document.getElementById("langJa"),ne=document.getElementById("langEn"),yo=document.getElementById("btnPushBeat"),bo=document.getElementById("btnPushBar"),vo=document.getElementById("btnCutBeat"),xo=document.getElementById("btnCutBar"),et=document.getElementById("keyHeightRange"),Lt=document.getElementById("keyHeightLabel"),ot="rgba(255,215,0,0.8)";let H=!1,Y=0,Be=0,xt=!1,wo=0,Vt=0,Kt=0,De=!1,Ft=null;function mt(){const t=document.getElementById("rulerContextMenu");t&&t.parentNode&&t.parentNode.removeChild(t)}const rt={pitch:null,sampler:null};let ht=-1,ft="area";const gn="mml_editor_key_height";(()=>{const t=()=>{try{sn()}catch{}finally{window.removeEventListener("pointerdown",t),window.removeEventListener("keydown",t)}};window.addEventListener("pointerdown",t,{passive:!0}),window.addEventListener("keydown",t)})();const W=document.createElement("button");Ae&&Ae.addEventListener("click",()=>{try{window.location.href="./mobile.html"}catch{}});function St(){const t=document.activeElement;if(!t)return;const e=t.tagName.toLowerCase();if((e==="input"||e==="select"||e==="textarea"||e==="button"||t.isContentEditable)&&!t.closest("#rollViewport, #roll, #rollBg, #timeRuler, #rulerContainer"))try{t.blur()}catch{}}function kn(t){const e=t.target;return e?!!e.closest("#rollViewport, #roll, #rollBg, #timeRuler, #rulerContainer"):!1}function tn(t){const e={bpm:120,timeSig:{beatsPerBar:4},zoomLevel:1,tracks:[],maxEndTick:0,tpqn:t?.tpqn??T,extendedUnitsEnabled:t?.extendedUnitsEnabled??J},n=Number(t?.bpm);e.bpm=Number.isFinite(n)&&n>0?n:120;const o=Number(t?.timeSig?.beatsPerBar);e.timeSig={beatsPerBar:Number.isFinite(o)&&o>=1?o:4};const a=Number(t?.zoomLevel);e.zoomLevel=Number.isFinite(a)&&a>=1&&a<=9?a:1;try{const c=Number(t?.displayBeatsPerBar);e.displayBeatsPerBar=Number.isFinite(c)&&c>=1&&c<=16?c:void 0}catch{}try{const l=(Array.isArray(t?.tempoAnchors)?t.tempoAnchors:[]).map(p=>({tick:Math.max(0,Math.floor(Number(p?.tick)||0)),bpm:Math.max(20,Math.min(we,Math.round(Number(p?.bpm)||e.bpm)))})),m=new Map;for(const p of l)m.set(p.tick,p.bpm);const f=Array.from(m.entries()).map(([p,g])=>({tick:p,bpm:g})).sort((p,g)=>p.tick-g.tick);e.tempoAnchors=f}catch{e.tempoAnchors=[]}const r=Array.isArray(t?.tracks)?t.tracks:[],s=Math.max(1,Math.min(6,r.length||6));for(let c=0;c<s;c++){const l=r[c]??{},f=(Array.isArray(l?.notes)?l.notes:[]).map(X=>{const M=typeof X?.id=="string"&&X.id?X.id:crypto.randomUUID(),E=Math.max(0,Math.floor(Number(X?.startTick)||0)),P=Math.max(1,Math.floor(Number(X?.durationTick)||1)),Z=Math.max(0,Math.floor(Number(X?.pitch)||0)),U=Math.max(0,Math.min(15,Math.floor(Number(X?.volume)||I)));return{id:M,startTick:E,durationTick:P,pitch:Z,volume:U}}),p=typeof l?.instrument=="string"&&Pe.includes(l.instrument)?l.instrument:Ne,g=Number(l?.id)||c+1,h=Number.isFinite(Number(l?.order))?Number(l.order):c,k=typeof l?.name=="string"&&l.name?l.name:`Track ${c+1}`,y=typeof l?.color=="string"&&l.color?l.color:be[c%be.length],w=!!l?.mute,x=!!l?.solo,L=typeof l?.mmlString=="string"?l.mmlString:"",S=typeof l?.optimizedMML=="string"?l.optimizedMML:"";e.tracks.push({id:g,order:h,name:k,color:y,instrument:p,mmlString:L,optimizedMML:S,mute:w,solo:x,notes:f})}e.tracks.sort((c,l)=>c.order-l.order),e.tracks.forEach((c,l)=>{c.order=l});let d=0;for(const c of e.tracks)for(const l of c.notes)d=Math.max(d,l.startTick+l.durationTick);return e.maxEndTick=d,e}function Bt(){he==null&&(he=requestAnimationFrame(()=>{he=null,N()}))}function F(t,e,n){t.setAttribute("data-i18n-title",e),t.title=n||b[v][e]||""}function at(t,e,n){t.classList.add("btn",`btn--${e}`,`btn--${n}`)}function vt(t){return Math.max(0,Math.min(15,t))}function Ut(t){return Math.max(12,Math.min(95,t))}function se(t){return t.sort((e,n)=>e.startTick-n.startTick||e.pitch-n.pitch)}function yn(t){return t.sort((e,n)=>e.startTick-n.startTick||e.id.localeCompare(n.id))}function Mo(t,e){const n=e.volume??I;if(!i.volumeLabels)return;const o=yn(t.notes.slice()),a=o.findIndex(d=>d.id===e.id),r=a>0?o[a-1].volume??I:I,s=o.slice(0,a).some((d,c,l)=>{const m=i.volumeLabels.has(d.id),f=c>0?l[c-1].volume??I:I,p=(d.volume??I)!==f;return m||p});n===I?s?i.volumeLabels.add(e.id):i.volumeLabels.delete(e.id):n!==r?i.volumeLabels.add(e.id):i.volumeLabels.delete(e.id)}function $t(t){return yn(t.notes.slice())}function bn(t,e,n){if(e<0||e>=t.length)return!1;const o=t[e],a=e>0?t[e-1].volume??I:I,r=o.volume??I;return(n?.has(o.id)??!1)||r!==a}function vn(t,e,n){const o=$t(t),a=o.findIndex(s=>s.id===e.id);if(a<0)return;let r=o.length;for(let s=a+1;s<o.length;s++)if(bn(o,s,i.volumeLabels)){r=s;break}for(let s=a;s<r;s++)o[s].volume=vt(n)}function To(t,e,n){const o=$t(t),a=new Map(o.map(d=>[d.id,d.volume??I])),r=o.map((d,c)=>({n:d,i:c})).filter(d=>e.has(d.n.id)).map(d=>d.i).sort((d,c)=>d-c);let s=0;for(;s<r.length;){const d=r[s];let c=s+1;for(;c<r.length&&r[c]===r[c-1]+1;)c++;const l=d,m=r[c-1],f=l>0?a.get(o[l-1].id)??I:I;for(let g=l;g<=m;g++)o[g].volume=vt(n);let p=m+1;for(;p<o.length&&e.has(o[p].id);)p++;p<o.length&&(o[p].volume=f),s=c}}function He(t){if(!i.volumeLabels)return;const e=$t(t),n=new Set(e.map(a=>a.id));for(const a of Array.from(i.volumeLabels))n.has(a)&&i.volumeLabels.delete(a);let o=I;for(const a of e){const r=a.volume??I;r!==o&&i.volumeLabels.add(a.id),o=r}}function Eo(){if(A)return;A=document.createElement("div"),A.style.position="fixed",A.style.zIndex="10000",A.style.background="#fff",A.style.border="1px solid #ccc",A.style.boxShadow="0 4px 12px rgba(0,0,0,0.15)",A.style.borderRadius="8px",A.style.padding="10px 12px",A.style.minWidth="220px",A.style.display="none",A.addEventListener("wheel",r=>r.stopPropagation(),{passive:!1});const t=document.createElement("div");t.style.marginBottom="8px",t.textContent=(b[v].volLabel||"볼륨")+" (0-15)",O=document.createElement("input"),O.type="range",O.min="0",O.max="15",O.step="1",O.value=String(I),O.style.width="100%";const e=document.createElement("div");e.style.fontSize="12px",e.style.color="#555",e.style.marginTop="6px";const n=()=>{e.textContent="V"+(O?.value??String(I))};O.addEventListener("input",n),n();const o=document.createElement("div");o.style.display="flex",o.style.gap="8px",o.style.marginTop="10px",Nt=document.createElement("button"),Nt.className="btn btn--primary btn--sm",Nt.textContent=b[v].volApplyRange||"변경",_t=document.createElement("button"),_t.className="btn btn--secondary btn--sm",_t.textContent=b[v].volApplySelected||"선택한 노트만 변경",o.append(Nt,_t),A.append(t,O,e,o),document.body.appendChild(A);const a=()=>{A&&(A.style.display="none"),bt=null};document.addEventListener("keydown",r=>{A&&A.style.display!=="none"&&r.key==="Escape"&&a()}),document.addEventListener("mousedown",r=>{!A||A.style.display==="none"||A.contains(r.target)||a()}),Nt.addEventListener("click",()=>{if(!bt||!O)return;const r=u.tracks.find(c=>c.id===i.activeTrackId);if(!r)return;const s=r.notes.find(c=>c.id===bt);if(!s)return;const d=vt(parseInt(O.value,10));vn(r,s,d),D(),nt({track:r,recomputeLabels:!0}),A.style.display="none",bt=null}),_t.addEventListener("click",()=>{if(!O)return;const r=u.tracks.find(d=>d.id===i.activeTrackId);if(!r)return;const s=vt(parseInt(O.value,10));To(r,new Set(i.selected),s),D(),nt({track:r,recomputeLabels:!0}),A.style.display="none",bt=null})}function Xe(){A&&A.style.display!=="none"&&(A.style.display="none",bt=null)}function Lo(t,e,n){if(Eo(),!A||!O)return;bt=t.id;const o=t.volume??I;O.value=String(o);const a=A.querySelector("div:nth-child(3)");a&&(a.textContent="V"+o),A.style.display="block";const r=A.getBoundingClientRect(),s=window.innerWidth,d=window.innerHeight;let c=e,l=n;c+r.width>s&&(c=Math.max(0,s-r.width-8)),l+r.height>d&&(l=Math.max(0,d-r.height-8)),A.style.left=`${c}px`,A.style.top=`${l}px`}function xn(t){const e=Math.floor(Y);if(t!==0){for(const n of u.tracks){for(const o of n.notes)(o.startTick>=e||o.startTick+o.durationTick>e)&&(o.startTick+=t);se(n.notes)}{const n=u.tempoAnchors;if(Array.isArray(n)&&n.length>0){const o=n.map(a=>a.tick>=e?{tick:a.tick+t,bpm:a.bpm}:{...a});u.tempoAnchors=Tn(o)}}u.maxEndTick+=Math.max(0,t),D(),We(u.tracks),K(),Bt()}}function wn(t){const e=Math.floor(Y);if(t!==0){for(const n of u.tracks){const o=[];for(const a of n.notes){const r=a.startTick,s=a.startTick+a.durationTick;if(s<=e)o.push(a);else{if(r>=e&&r<e+t)continue;if(r>=e+t)o.push({...a,startTick:Math.max(e,r-t)});else if(r<e&&s>e){const d=e-r;d>0&&o.push({...a,durationTick:d})}}}se(o),n.notes=o}{const n=u.tempoAnchors;if(Array.isArray(n)&&n.length>0){const o=n.filter(a=>!(a.tick>=e&&a.tick<e+t)).map(a=>a.tick>=e+t?{tick:a.tick-t,bpm:a.bpm}:{...a});u.tempoAnchors=Tn(o)}}u.maxEndTick=Math.max(0,u.maxEndTick-t),D(),We(u.tracks),K(),Bt()}}function Mn(){return u.timeSig.beatsPerBar}function Tn(t){const e=(t||[]).map(o=>({tick:Math.max(0,Math.floor(o.tick)),bpm:Math.round(o.bpm)}));e.sort((o,a)=>o.tick-a.tick||o.bpm-a.bpm);const n=[];for(const o of e){const a=n[n.length-1];!a||a.tick!==o.tick?n.push(o):n[n.length-1]=o}return n.length>0&&n[0].tick!==0&&(t||[]).some(a=>a.tick<=0)&&n.unshift({tick:0,bpm:n[0].bpm}),n.sort((o,a)=>o.tick-a.tick)}function So(){try{u.selectedLength=i.selectedLength,u.playheadVisualMode=ft,u.tpqn=T,u.extendedUnitsEnabled=J,u.displayBeatsPerBar=$,u.tempoChanges&&Array.isArray(u.tempoChanges);const t={...u,tracks:u.tracks.map(e=>({id:e.id,notes:e.notes,name:e.name,instrument:e.instrument,optimizedMML:e.optimizedMML,order:e.order,mute:e.mute,solo:e.solo,color:e.color}))};return localStorage.setItem(pn,JSON.stringify(t)),!0}catch{return!1}}let ge=null;function K(){ge&&window.clearTimeout(ge),ge=window.setTimeout(()=>{So()},300)}function D(){pt.push(u),K()}function lt(t){const e=pe.get(t.id);e&&clearTimeout(e);const n=setTimeout(()=>{try{Re.postMessage({track:t,tpqn:u.tpqn??T,tempoAnchors:u.tempoAnchors||[],defaultBpm:u.bpm})}catch{}pe.delete(t.id)},go);pe.set(t.id,n)}function We(t){for(const e of t)try{Re.postMessage({track:e,tpqn:u.tpqn??T,tempoAnchors:u.tempoAnchors||[],defaultBpm:u.bpm})}catch{}}function nt(t={}){const{track:e,recomputeLabels:n}=t;e&&(n&&He(e),lt(e),gt()),Bt()}function qe(){const t=document.querySelector(".panel.canvas-wrap");t&&(t.style.height="")}function gt(){if(!fe)return;const t=u.tracks.find(n=>n.id===i.activeTrackId)||u.tracks[0];let e=t&&(t.optimizedMML?.trim?.()||t.mmlString?.trim?.())||"";e=e.replace(/[\r\n]+/g,""),fe.textContent=e,fe.title=e}function En(t,e){const n=(e||"").replace(/[\r\n]+/g,"").trim();t.mmlString=n;try{let o=u.bpm;const a=n.match(/^t(\d+)/);a&&(o=parseInt(a[1],10)),t.notes=Un("MML@"+n),u.tracks[0]===t&&(u.bpm=o),He(t),D(),lt(t),K(),Bt()}catch{t.notes=[]}}function Ao(){const t=u.tracks.filter(a=>a.solo),e=t.length>0?t:u.tracks.filter(a=>!a.mute),n=a=>Pe.includes(a)?a:Ne,o=[];for(const a of e){const r=n(a.instrument||"lute");for(const s of a.notes)o.push({startTick:s.startTick,durationTick:s.durationTick,pitch:s.pitch,trackId:a.id,instrumentKey:r,volume:s.volume})}return o}function Bo(){G(),In(),R&&new ResizeObserver(()=>{ht=-1,N()}).observe(R),((r,s="ghost")=>{r&&at(r,s,"sm")})(Ae,"secondary"),_.addEventListener("pointermove",r=>{kn(r)&&St(),Ko(r)}),_.addEventListener("pointerdown",r=>{St(),r.preventDefault(),Uo(r)},{passive:!1}),window.addEventListener("pointerup",$o),window.addEventListener("pointermove",Fo),window.addEventListener("pointermove",r=>{window.lastPointerX=r.clientX,window.lastPointerY=r.clientY}),window.addEventListener("keydown",_o),window.addEventListener("keyup",No),window.addEventListener("wheel",Xo,{passive:!1}),window.addEventListener("contextmenu",r=>{r.preventDefault()},{passive:!1}),R.addEventListener("scroll",Ho),B.addEventListener("click",r=>{St(),Gt(r)}),B.addEventListener("pointerdown",r=>{St(),r.preventDefault(),jo(r)},{passive:!1}),B.addEventListener("contextmenu",r=>{r.preventDefault(),Co(r)},{passive:!1}),window.addEventListener("pointermove",Jo),window.addEventListener("pointerup",Zo),B.addEventListener("mousemove",Po),B.addEventListener("mouseleave",()=>{qt&&(qt.style.display="none")}),Ee.addEventListener("click",zn),Le.addEventListener("click",Ce),Se.addEventListener("click",Cn),et?.addEventListener("input",()=>{const r=Math.max(16,Math.min(32,parseInt(et.value,10)));if(r!==i.keyHeight){i.keyHeight=r;try{localStorage.setItem(gn,String(r))}catch{}Lt&&(Lt.textContent=String(r)),ht=-1,qe(),N()}}),st&&st.addEventListener("click",()=>{ft=ft==="area"?"line":"area",st&&(st.textContent=ft==="area"?b[v].playheadAreaLabel:b[v].playheadLineLabel),z(),K()}),Qt.addEventListener("click",Io),Zt.addEventListener("click",()=>{H||Qo()});let e=!1,n=0,o=0;Wt.addEventListener("pointerdown",r=>{e=!0,n=r.clientX,o=i.scrollX,Wt.setPointerCapture(r.pointerId)}),window.addEventListener("pointermove",r=>{if(!e||H)return;const s=r.clientX-n,d=wt(),c=Math.max(0,d-R.clientWidth),l=Math.max(1,zt.clientWidth-Wt.clientWidth),m=c/l,f=o+s*m;i.scrollX=le(f),z()}),window.addEventListener("pointerup",()=>{e=!1}),Ot.addEventListener("click",$e),it&&(at(it,"secondary","md"),it.textContent=b[v].load||"Load",F(it,"tooltipLoad",b[v].tooltipLoad||"Load project"),it.addEventListener("click",()=>{try{const r=localStorage.getItem(pn);if(!r){alert(b[v].noSavedProject||"No saved project found");return}const s=JSON.parse(r);if(!s||!s.tracks){alert(b[v].invalidSavedProject||"Saved data is invalid");return}let d=tn(s);const c=!!d.extendedUnitsEnabled;cn(c);const l=c?ke:ye,m=d.tpqn||l;if(m!==l){const f=l/m;Ie(d,f)}d.tpqn=l,d.extendedUnitsEnabled=c,typeof d.selectedLength=="number"&&(i.selectedLength=d.selectedLength),(d.playheadVisualMode==="area"||d.playheadVisualMode==="line")&&(ft=d.playheadVisualMode),d=tn(d),u=d,i.selected.clear();try{i.volumeLabels?.clear()}catch{}for(const f of u.tracks)He(f);gt(),G(),N(),alert(b[v].loadedFromLocal||"Loaded from local storage")}catch{alert(b[v].loadFailed||"Load failed")}}));const a=r=>{Wn(r),_n(),st&&(st.textContent=ft==="area"?b[v].playheadAreaLabel:b[v].playheadLineLabel),yt&&(yt.textContent=b[v].trackMMLLabel||(r==="ja"?"トラックMML":r==="en"?"Track MML":"트랙MML")),it&&(it.textContent=b[v].load||(r==="ja"?"読み込み":r==="en"?"Load":"불러오기"),F(it,"tooltipLoad",b[v].tooltipLoad||it.title||"Load project")),et&&(et.title=b[v].tooltipKeyHeight||et.title),Lt&&(Lt.textContent=String(i.keyHeight));try{const s=document.getElementById("langKo"),d=document.getElementById("langJa"),c=document.getElementById("langEn");s?.setAttribute("role","radio"),d?.setAttribute("role","radio"),c?.setAttribute("role","radio"),s?.setAttribute("aria-checked",String(r==="ko")),d?.setAttribute("aria-checked",String(r==="ja")),c?.setAttribute("aria-checked",String(r==="en"))}catch{}G(),gt()};te.addEventListener("click",()=>a("ko")),ee.addEventListener("click",()=>a("ja")),ne.addEventListener("click",()=>a("en")),Ot.addEventListener("click",$e)}function Io(){const t=u.tracks.slice().sort((e,n)=>e.order-n.order);for(const e of t)!(Array.isArray(e.notes)&&e.notes.length>0)||(Vn(e.notes??[])||dn(e.notes??[]));Fn(u)}function ce(t){const e=_.getBoundingClientRect(),n=t.clientX-e.left+i.scrollX,o=t.clientY-e.top;return{x:n,y:o}}function Ln(t){const e=B.getBoundingClientRect();return{x:t.clientX-e.left+i.scrollX}}function Sn(t){const e=C[u.zoomLevel-1],n=i.scrollX,o=u.tempoAnchors||[];for(let a=0;a<o.length;a++){const r=Math.round(o[a].tick/T*e-n)+.5;if(Math.abs(r-t)<=6)return{index:a,tick:o[a].tick}}return null}function Co(t){const e=B.getBoundingClientRect(),n=t.clientX-e.left,o=Sn(n),a=ut,r=document.getElementById("rulerContextMenu");r&&r.parentNode&&r.parentNode.removeChild(r);const s=document.createElement("div");s.id="rulerContextMenu",s.style.cssText="position:absolute;z-index:20;background:#fff;border:1px solid #ccc;border-radius:6px;box-shadow:0 6px 16px rgba(0,0,0,0.2);padding:4px;min-width:160px;font:13px system-ui,sans-serif;";const d=(h,k)=>{const y=document.createElement("button");return y.type="button",y.textContent=h,y.style.cssText="display:block;width:100%;text-align:left;background:none;border:0;padding:8px 10px;cursor:pointer;",y.onmouseenter=()=>y.style.background="#f2f2f2",y.onmouseleave=()=>y.style.background="transparent",y.onclick=()=>{k(),c()},y},c=()=>{s.parentNode&&s.parentNode.removeChild(s)},{x:l}=Ln(t),m=C[u.zoomLevel-1],f=dt(i.selectedLength),p=_e(Math.max(0,Math.floor(l/m*T)),f);o?(s.appendChild(d(b[v].menuTempoEdit||"템포 수정…",()=>en(u.tempoAnchors[o.index].bpm,h=>{u.tempoAnchors[o.index].bpm=h,u.tempoAnchors[o.index].tick===0&&(u.bpm=h),u.tempoAnchors.sort((k,y)=>k.tick-y.tick),D();for(const k of u.tracks)lt(k);K(),N()}))),s.appendChild(d(b[v].menuTempoDelete||"템포 삭제",()=>{u.tempoAnchors.splice(o.index,1),Ft=null,D();for(const h of u.tracks)lt(h);K(),N()}))):(s.appendChild(d(b[v].menuTempoCreateHere||"여기에 템포 생성…",()=>en(u.bpm,h=>{const k=u.tempoAnchors||[];k.push({tick:p,bpm:h}),k.sort((y,w)=>y.tick-w.tick),u.tempoAnchors=k,p===0&&(u.bpm=h),D();for(const y of u.tracks)lt(y);K(),N()}))),s.appendChild(d(b[v].menuTempoRemoveAll||"모든 템포 제거",()=>{if(!(!Array.isArray(u.tempoAnchors)||u.tempoAnchors.length===0)){u.tempoAnchors=[],Ft=null,D();for(const h of u.tracks)lt(h);K(),N()}}))),a.style.position="relative",s.style.left=`${Math.floor(n)}px`;const g=i.keyHeight;s.style.top=`${Math.max(0,Math.floor(g-26))}px`,a.appendChild(s),setTimeout(()=>{const h=k=>{const y=k.target;(!y||!s.contains(y))&&c()};window.addEventListener("mousedown",h,{once:!0,capture:!0}),window.addEventListener("wheel",()=>c(),{once:!0,capture:!0}),window.addEventListener("resize",()=>c(),{once:!0,capture:!0})},0)}function en(t,e){const n=document.createElement("div");n.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:1000;display:flex;align-items:center;justify-content:center;";const o=document.createElement("div");o.style.cssText="background:#fff;border-radius:8px;padding:16px;min-width:260px;box-shadow:0 10px 24px rgba(0,0,0,0.25);display:flex;flex-direction:column;gap:12px;";const a=document.createElement("div");a.textContent=b[v].tempoModalTitle||"템포 설정";const r=document.createElement("input");r.type="number",r.min="20",r.max=String(we),r.step="1",r.value=String(t),r.style.cssText="font-size:16px;padding:8px;";const s=document.createElement("div");s.style.cssText="display:flex;gap:8px;justify-content:flex-end;";const d=document.createElement("button");d.textContent=b[v].cancel||"취소";const c=document.createElement("button");c.textContent=b[v].ok||"확인",c.style.cssText="background:#3a7afe;color:#fff;border:0;border-radius:6px;padding:6px 12px;",s.append(d,c),o.append(a,r,s),n.appendChild(o),document.body.appendChild(n);const l=()=>{n.parentNode&&document.body.removeChild(n)};d.onclick=l,c.onclick=()=>{const m=Math.max(20,Math.min(we,Math.round(Number(r.value||t))));Number.isFinite(m)&&e(m),l()},r.addEventListener("keydown",m=>{m.key==="Enter"&&c.click(),m.key==="Escape"&&l()}),setTimeout(()=>r.focus(),0)}function Po(t){const e=ko(),n=B.getBoundingClientRect(),o=t.clientX-n.left,a=C[u.zoomLevel-1],r=i.scrollX,s=u.tempoAnchors||[];let d=null;for(const c of s){const l=Math.round(c.tick/T*a-r)+.5;if(Math.abs(l-o)<=6){d={cssX:l,bpm:c.bpm,tick:c.tick};break}}if(d){const c=Math.floor(d.tick/T/u.timeSig.beatsPerBar)+1,l=Math.floor(d.tick/T%u.timeSig.beatsPerBar)+1;e.textContent=`t${d.bpm} @ ${c}.${l}`,e.style.left=`${Math.floor(d.cssX)}px`;const m=i.keyHeight;e.style.top=`${Math.max(0,Math.floor(m-22))}px`,e.style.display="block"}else e.style.display="none"}function No(t){t.key==="Alt"&&(De=!1,N()),mt()}function _o(t){Xe(),mt();const e=document.activeElement;if(e&&(e.tagName==="INPUT"||e.tagName==="TEXTAREA"||e.tagName==="SELECT"||e.isContentEditable))return;t.key==="Alt"&&(t.preventDefault(),De=!0,N());for(let r=1;r<=9;r++)t.key===r.toString()&&rn(r-1);if(t.key==="0"&&rn(At.length-1),H){t.code==="Space"&&(t.preventDefault(),Ce());return}if((t.key==="ArrowUp"||t.key==="ArrowDown")&&t.shiftKey){const r=document.activeElement;if(r&&(r.tagName==="INPUT"||r.tagName==="SELECT"))return;t.preventDefault();const s=u.tracks.find(p=>p.id===i.activeTrackId);if(!s)return;const d=s.notes.filter(p=>i.selected.has(p.id));if(d.length===0)return;const c=p=>Math.floor(Ue(p)/12),l=Math.min(...d.map(p=>c(p.pitch))),m=Math.max(...d.map(p=>c(p.pitch)));if(t.key==="ArrowUp"&&m>=7||t.key==="ArrowDown"&&l<=1)return;const f=t.key==="ArrowUp"?12:-12;for(const p of s.notes)i.selected.has(p.id)&&(p.pitch=Ue(p.pitch+f));D(),nt({track:s,recomputeLabels:!0});return}if((t.key==="ArrowUp"||t.key==="ArrowDown")&&!t.shiftKey&&!t.ctrlKey&&!t.metaKey&&!t.altKey){const r=document.activeElement;if(r&&(r.tagName==="INPUT"||r.tagName==="SELECT"))return;t.preventDefault();const s=u.tracks.slice().sort((m,f)=>m.order-f.order),d=s.findIndex(m=>m.id===i.activeTrackId);if(d===-1)return;const c=t.key==="ArrowUp"?-1:1,l=Math.max(0,Math.min(s.length-1,d+c));l!==d&&(i.activeTrackId=s[l].id,G(),N(),gt());return}const n=t.ctrlKey||t.metaKey;if(n&&t.key.toLowerCase()==="z"){t.preventDefault();const r=pt.undo(u);r&&(u=r,typeof u.displayBeatsPerBar=="number"&&($=u.displayBeatsPerBar,q&&q.value!==String($)&&(q.value=String($))),i.selected.clear(),N(),G());return}if(n&&t.key.toLowerCase()==="y"){t.preventDefault();const r=pt.redo(u);r&&(u=r,typeof u.displayBeatsPerBar=="number"&&($=u.displayBeatsPerBar,q&&q.value!==String($)&&(q.value=String($))),i.selected.clear(),N(),G());return}if(n&&t.key.toLowerCase()==="a"){t.preventDefault(),zo();return}if(t.key==="Escape"){i.selected.clear(),i.marquee.active=!1,i.drag=null,i.ghost=null,N();return}if(t.key==="Delete"){An();return}if(n&&t.key.toLowerCase()==="c"){t.preventDefault(),Bn();return}if(n&&t.key.toLowerCase()==="v"){t.preventDefault(),Do();return}if(n&&t.key.toLowerCase()==="x"){t.preventDefault(),Ro();return}if(t.code==="Space"){t.preventDefault(),H?Ce():zn();return}const o=C[u.zoomLevel-1],a=u.timeSig.beatsPerBar*o;if(t.key==="PageDown"){t.preventDefault(),i.scrollX=Math.max(0,Math.ceil((i.scrollX+1)/a)*a),z();return}if(t.key==="PageUp"){t.preventDefault(),i.scrollX=Math.max(0,Math.floor((i.scrollX-1)/a)*a),z();return}if(t.key==="Home"){t.preventDefault(),i.scrollX=0,z();return}if(t.key==="End"){t.preventDefault();const r=wt();i.scrollX=le(Math.max(0,r-R.clientWidth)),z();return}}function zo(){i.selected.clear();const t=u.tracks.find(e=>e.id===i.activeTrackId);for(const e of t.notes)i.selected.add(e.id);N()}function An(){if(i.selected.size===0)return;const t=u.tracks.find(e=>e.id===i.activeTrackId);t.notes=t.notes.filter(e=>!i.selected.has(e.id)),i.selected.clear(),D(),nt({track:t})}function Bn(){const e=u.tracks.find(o=>o.id===i.activeTrackId).notes.filter(o=>i.selected.has(o.id));if(e.length===0)return;const n=Math.min(...e.map(o=>o.startTick));i.clipboard=e.map(o=>({...o,startTick:o.startTick-n}))}function Ro(){Bn(),An()}function Do(){if(!i.clipboard||i.clipboard.length===0)return;const t=Math.max(0,Math.floor(Y)),e=u.tracks.find(n=>n.id===i.activeTrackId);e&&ve(async()=>{const{insertNoteWithOverlap:n,ensureBars:o}=await import("./languages-BtlVKnIV.js").then(a=>a.K);return{insertNoteWithOverlap:n,ensureBars:o}},[],import.meta.url).then(({insertNoteWithOverlap:n,ensureBars:o})=>{if(i.selected.clear(),i.clipboard!=null)for(const a of i.clipboard){const r=crypto.randomUUID(),s={...a,id:r,startTick:Math.max(0,t+a.startTick)};n(u,e.id,s),o(u,s.startTick+s.durationTick),i.selected.add(r)}D(),nt({track:e})})}function Ho(){const e=-R.scrollTop+i.keyHeight;j.style.transform=`translateY(${e}px)`,mt()}function Xo(t){if(kn(t)&&St(),Xe(),mt(),t.ctrlKey){t.preventDefault(),Wo(t);return}if(t.altKey&&t.shiftKey&&i.selected.size>0&&!H){t.preventDefault();const e=t.deltaY>0?-1:1,n=u.tracks.find(l=>l.id===i.activeTrackId),o=$t(n),a=new Map(o.map(l=>[l.id,l.volume??I])),r=new Set([...i.selected]),s=o.map((l,m)=>({n:l,i:m})).filter(l=>r.has(l.n.id)).map(l=>l.i).sort((l,m)=>l-m),d=new Map;for(const l of s){const m=o[l].id,f=a.get(m)??I;d.set(l,vt(f+e))}let c=0;for(;c<s.length;){const l=s[c],m=d.get(l);let f=c+1;for(;f<s.length&&s[f]===s[f-1]+1&&d.get(s[f])===m;)f++;const p=l,g=s[f-1],h=p>0?a.get(o[p-1].id)??I:I;for(let y=p;y<=g;y++)o[y].volume=vt(d.get(y));let k=g+1;for(;k<o.length&&r.has(o[k].id);)k++;k<o.length&&(o[k].volume=h,Mo(n,o[k])),c=f}nt({track:n,recomputeLabels:!0}),D();return}if(t.altKey&&!t.shiftKey&&i.selected.size>0&&!H){t.preventDefault();const e=t.deltaY>0?-1:1,n=u.tracks.find(a=>a.id===i.activeTrackId),o=n.notes.filter(a=>i.selected.has(a.id));if(o.length>0){const a=o.reduce((d,c)=>c.startTick<d.startTick?c:d),r=a.volume??I,s=vt(r+e);vn(n,a,s)}nt({track:n,recomputeLabels:!0}),D();return}if(t.shiftKey){t.preventDefault();const e=C[u.zoomLevel-1],n=u.timeSig.beatsPerBar*e,a=(Math.abs(t.deltaX)>Math.abs(t.deltaY)?t.deltaX:t.deltaY)>0?1:-1,r=wt(),s=Math.max(0,r-R.clientWidth);let d=Math.max(0,Math.min(s,i.scrollX+a*n));if(H){const c=Y/T*e,l=R.clientWidth,m=Math.max(0,Math.min(s,Math.floor(c-l))),f=Math.max(0,Math.min(s,Math.floor(c)));d=Math.max(m,Math.min(f,d));let p=le(d);const g=Math.max(0,Math.min(s,Math.ceil(m/n)*n)),h=Math.max(0,Math.min(s,Math.floor(f/n)*n));g<=h?((p<g||p>h)&&(p=a>0?h:g),d=p):d=i.scrollX}i.scrollX=le(d),z();return}}function Wo(t){const e=t.deltaY>0?-1:1,n=Math.max(1,Math.min(9,u.zoomLevel+e));if(n===u.zoomLevel)return;const o=C[u.zoomLevel-1],a=R.getBoundingClientRect(),r=Math.max(0,Math.min(t.clientX-a.left,a.width)),s=i.scrollX+r,d=o*u.timeSig.beatsPerBar,l=Math.max(0,Math.round(s/d)*d)/o*T;u.zoomLevel=n;const m=C[n-1],f=l/T*m,p=wt(),g=Math.max(0,p-R.clientWidth);i.scrollX=Math.max(0,Math.min(g,f-r));const h=m*u.timeSig.beatsPerBar;i.scrollX=Math.max(0,Math.min(g,Math.floor(i.scrollX/h)*h)),ht=-1,N()}function G(){gt();const t=be;Ze.innerHTML="",u.tracks.slice().sort((n,o)=>n.order-o.order).forEach((n,o)=>{n.color=t[o%t.length],(!n.instrument||!Pe.includes(n.instrument))&&(n.instrument=Ne);const a=document.createElement("div");a.dataset.trackId=String(n.id),a.dataset.order=String(n.order);const r=n.id===i.activeTrackId;a.className="track-card",r&&a.classList.add("is-active");const s=document.createElement("div");s.className="track-color",s.style.cssText=`
            background: ${n.color};
        `;const d=document.createElement("div");d.className="track-main";const c=document.createElement("div");c.className="track-row track-row--top";const l=document.createElement("input");l.value=n.name,l.setAttribute("data-i18n-title","tooltipTrackName"),l.title=b[v].tooltipTrackName,c.style.width="100%",l.classList.add("track-name-input"),Gn(l,{size:"sm"}),l.addEventListener("change",()=>{pt.push(u),n.name=l.value});const m=document.createElement("div");if(m.className="track-name",m.appendChild(l),c.appendChild(m),r){const g=document.createElement("div");g.className="track-reorder",g.style.marginLeft="auto",g.style.display="inline-flex",g.style.gap="6px";const h=document.createElement("button");h.type="button",h.textContent="▲",h.title="Move up",h.setAttribute("aria-label","Move track up"),h.style.width="24px",h.style.height="24px",h.style.fontSize="12px";const k=document.createElement("button");k.type="button",k.textContent="▼",k.title="Move down",k.setAttribute("aria-label","Move track down"),k.style.width="24px",k.style.height="24px",k.style.fontSize="12px";const y=u.tracks.length-1;h.disabled=n.order===0,k.disabled=n.order===y,h.addEventListener("click",w=>{w.stopPropagation(),nn(-1)}),k.addEventListener("click",w=>{w.stopPropagation(),nn(1)}),g.append(h,k),c.appendChild(g)}{const g=document.createElement("div");g.className="track-row track-row--middle",g.style.width="100%";const h=Dn(),k=Yn({items:h,value:n.instrument,size:"sm",fullWidth:!0,onChange:M=>{pt.push(u),n.instrument=M}});k.el.setAttribute("data-i18n-title","tooltipInstrument"),k.el.title=b[v].tooltipInstrument;const y=document.createElement("div");y.className="track-instrument",y.appendChild(k.el),g.appendChild(y);const w=document.createElement("div");w.className="track-row track-row--bottom";const x=Vo(n),L=document.createElement("span");L.className="track-charcount";const S=n.optimizedMML?.length||0,X=b[v].charUnit;L.textContent=`${S}${X}`,L.setAttribute("data-i18n-title","tooltipCharCount"),L.title=b[v].tooltipCharCount,w.append(x,L),d.append(c,g,w)}const f=[l];{const g=d.querySelector(".dropdown");g instanceof HTMLElement&&f.push(g),d.querySelectorAll(".track-controls button").forEach(k=>f.push(k))}c.querySelectorAll(".track-reorder button").forEach(g=>f.push(g)),f.forEach(g=>{g.addEventListener("mousedown",h=>h.stopPropagation()),g.addEventListener("mouseup",h=>h.stopPropagation())}),a.addEventListener("click",g=>{const h=g.target.tagName;h==="INPUT"||h==="SELECT"||h==="BUTTON"||g.target.isContentEditable||i.activeTrackId!==n.id&&(i.activeTrackId=n.id,G(),N())}),a.append(s,d),Ze.appendChild(a)})}function nn(t){const e=u.tracks.find(s=>s.id===i.activeTrackId);if(!e)return;const n=e.order,o=u.tracks.length-1,a=n+t;if(a<0||a>o)return;const r=u.tracks.find(s=>s.order===a);r&&(e.order=a,r.order=n),D(),G(),K()}function In(){Xt.innerHTML="",de(),At.forEach(t=>{const e=ae({label:String(t),size:"sm",variant:t===i.selectedLength?"primary":"secondary"});t===i.selectedLength&&e.classList.add("active"),e.setAttribute("data-i18n-title","tooltipLength"),t===64?e.title=(b[v].tooltipLength||"Length")+" - 0 (주의: 인게임에서 박자가 어긋날 수 있음)":e.title=b[v].tooltipLength,e.addEventListener("click",()=>{Oe(t)}),t===48&&(e.style.marginRight="12px"),Xt.appendChild(e)}),W.textContent=J?b[v].extendedLessLabel||"더 적은 단위":b[v].extendedMoreLabel||"더 많은 단위",W.title=J?b[v].tooltipExtendedLess||"기본 단위로 돌아가기":b[v].tooltipExtendedMore||"더 많은 단위 사용 (64/128/5/7/11)",W.setAttribute("data-i18n",J?"extendedLessLabel":"extendedMoreLabel"),F(W,J?"tooltipExtendedLess":"tooltipExtendedMore",W.title),W.setAttribute("aria-label",W.title),W.addEventListener("click",qo),Xt.appendChild(W)}function qo(){if(!J){const e="mml_editor_warn_extended_shown";let n=!1;try{n=localStorage.getItem(e)==="1"}catch{}if(!n){if(!window.confirm(b[v].confirmEnableExtendedUnits||"Enable more units to use 64/128/5/7/11; existing ticks will be converted. Continue?"))return;try{localStorage.setItem(e,"1")}catch{}}on(!0)}else on(!1)}function on(t){D();const o=(t?ke:ye)/(t?ye:ke);Ie(u,o),cn(t),u.tpqn=T,u.extendedUnitsEnabled=t;try{pt.transformSnapshots?.(a=>Ie(a,o))}catch{}Oo(),In(),N()}function Oo(){if(!At.includes(i.selectedLength)){let t=At[0],e=Math.abs(t-i.selectedLength);for(const n of At){const o=Math.abs(n-i.selectedLength);o<e&&(t=n,e=o)}Oe(t)}}function Ie(t,e){if(!Number.isFinite(e)||e<=0)return;for(const o of t.tracks)for(const a of o.notes)a.startTick=Math.round(a.startTick*e),a.durationTick=Math.max(1,Math.round(a.durationTick*e));const n=t.tempoAnchors;if(Array.isArray(n)){for(const o of n)o.tick=Math.max(0,Math.round(o.tick*e));n.sort((o,a)=>o.tick-a.tick)}t.maxEndTick=Math.round(t.maxEndTick*e)}function Oe(t){if(!Xt)return;i.selectedLength=t;const e=Array.from(Xt.children);e.forEach(n=>n.classList.remove("active")),e.forEach(n=>{if(n instanceof HTMLButtonElement){const a=parseInt(n.textContent||"0",10)===t;a&&n.classList.add("active"),n.classList.remove("btn--primary","btn--secondary"),n.classList.add(a?"btn--primary":"btn--secondary")}}),N(),K()}function Vo(t){const e=document.createElement("div");e.className="track-controls";const n=(r,s,d)=>{const c=document.createElement("button");return c.textContent=r,c.style.cssText=`
            width: 24px;
            height: 24px;
            font-size: 12px;
            font-weight: bold;
            border-radius: 4px;
            border: 1px solid #ccc;
            cursor: pointer;
            background-color: ${s?d:"#fff"};
            color: ${s?"#fff":"#000"};
        `,c},o=n("M",t.mute,"#f44336");o.setAttribute("data-i18n-title","tooltipMute"),o.title=b[v].tooltipMute,o.addEventListener("click",()=>{t.mute=!t.mute,D(),G()});const a=n("S",t.solo,"#ff9800");return a.setAttribute("data-i18n-title","tooltipSolo"),a.title=b[v].tooltipSolo,a.addEventListener("click",()=>{t.solo=!t.solo,D(),G()}),e.append(o,a),e}function rn(t){const e=At[t];typeof e=="number"&&Oe(e)}function Ko(t){if(H){i.hover.noteId=null,i.hover.edge=null,_.style.cursor="not-allowed";return}const{x:e,y:n}=ce(t),o=C[u.zoomLevel-1],a=u.tracks.find(r=>r.id===i.activeTrackId);if(!i.drag&&!i.marquee.active){const r=Me(e,n,a.notes,o,i.keyHeight);r?(i.hover.noteId=r.note.id,i.hover.edge=r.edge,_.style.cursor=r.edge==="center"?"move":"ew-resize"):(i.hover.noteId=null,i.hover.edge=null,_.style.cursor="default"),z();return}if(i.marquee.active){i.marquee.x1=e,i.marquee.y1=n;const r=t.ctrlKey||t.metaKey,s=t.shiftKey;i.marquee.mode=r?"toggle":s?"add":"replace";const d=uo(i.marquee.x0,i.marquee.y0,i.marquee.x1,i.marquee.y1,a.notes,o,i.keyHeight),c=new Set(i.selected);if(i.marquee.mode==="replace"){i.selected.clear();for(const l of d)i.selected.add(l.id)}else if(i.marquee.mode==="add")for(const l of d)i.selected.add(l.id);else{i.selected=c;for(const l of d)i.selected.has(l.id)?i.selected.delete(l.id):i.selected.add(l.id)}z()}}function Uo(t){if(St(),mt(),sn(),H){t.preventDefault(),_.style.cursor="not-allowed";return}if(Xe(),t.button===1){t.preventDefault(),xt=!0,Gt(t);return}if(t.button===2){t.preventDefault();const{x:f,y:p}=ce(t),g=C[u.zoomLevel-1],h=u.tracks.find(y=>y.id===i.activeTrackId),k=Me(f,p,h.notes,g,i.keyHeight);if(k)i.selected.has(k.note.id)||(i.selected.clear(),i.selected.add(k.note.id),z()),Lo(k.note,t.clientX,t.clientY);else{const y=t.ctrlKey||t.metaKey,w=t.shiftKey;i.drag=null,i.ghost=null,i.marquee.active=!0,i.marquee.x0=f,i.marquee.y0=p,i.marquee.x1=f,i.marquee.y1=p,i.marquee.mode=y?"toggle":w?"add":"replace",z()}return}if(t.button!==0)return;const{x:e,y:n}=ce(t),o=C[u.zoomLevel-1],a=u.tracks.find(f=>f.id===i.activeTrackId),r=Me(e,n,a.notes,o,i.keyHeight);if(!r){const f=dt(i.selectedLength),p=e/o*T,g=_e(p,f),h=Ut(95-Math.floor(n/i.keyHeight)),k=dt(i.selectedLength),y=crypto.randomUUID();i.drag={kind:"create",trackId:i.activeTrackId,noteId:y,startTick:g,durationTick:k,pitch:h},i.ghost={startTick:g,durationTick:k,pitch:h,color:ot};const w=u.tracks.find(x=>x.id===i.activeTrackId);w&&oe(h,w.id,w.instrument,rt),z();return}const s=r.note,d=t.ctrlKey||t.metaKey,c=i.selected.has(s.id);d?c||i.selected.add(s.id):c||(i.selected.clear(),i.selected.add(s.id));{const f=u.tracks.find(p=>p.id===i.activeTrackId);f&&oe(s.pitch,f.id,f.instrument,rt)}const l=s.startTick,m=s.startTick+s.durationTick;if(r.edge==="center"){const f=Array.from(i.selected),p=u.tracks.find(h=>h.id===a.id).notes.filter(h=>i.selected.has(h.id)).map(h=>({id:h.id,startTick:h.startTick,pitch:h.pitch,durationTick:h.durationTick,volume:h.volume})),g=dt(i.selectedLength);Vt=0,Kt=0,i.moveGroup={trackId:a.id,ids:f,base:p,mouseStartX:e,mouseStartY:n,grid:g},i.drag={kind:"move",trackId:a.id,noteId:s.id,startTick0:l,yPitch0:s.pitch,mouseStartX:e,mouseStartY:n},i.ghost={startTick:s.startTick,durationTick:s.durationTick,pitch:s.pitch,color:ot},z();return}else r.edge==="left"?(i.drag={kind:"resize-left",trackId:a.id,noteId:s.id,startTick0:l,endTick0:m,mouseStartX:e},i.ghost={startTick:s.startTick,durationTick:s.durationTick,pitch:s.pitch,color:ot}):r.edge==="right"&&(i.drag={kind:"resize-right",trackId:a.id,noteId:s.id,startTick0:l,endTick0:m,mouseStartX:e},i.ghost={startTick:s.startTick,durationTick:s.durationTick,pitch:s.pitch,color:ot});z()}function Fo(t){if(H)return;if(xt){Gt(t);return}if(i.marquee.active||!i.drag)return;const{x:e,y:n}=ce(t),o=C[u.zoomLevel-1],a=dt(i.selectedLength);if(i.drag.kind==="move"||i.drag.kind==="resize-left"||i.drag.kind==="resize-right"){if(i.drag.kind==="move"){const l=document.elementFromPoint(t.clientX,t.clientY)?.closest?.(".track-card");document.querySelectorAll(".track-card.drop-hover").forEach(m=>m.classList.remove("drop-hover")),l&&parseInt(l.dataset.trackId||"-1",10)!==i.drag.trackId&&l.classList.add("drop-hover")}const r=u.tracks.find(c=>i.drag!=null&&c.id===i.drag.trackId),s=r.notes.findIndex(c=>i.drag!=null&&c.id===i.drag.noteId);if(s<0)return;const d=r.notes[s];if(i.drag.kind==="move"){const c=i.moveGroup;if(!c)return;const l=(e-c.mouseStartX)/o,m=Math.floor((c.mouseStartY-n)/i.keyHeight),f=l*T,p=Math.round(f/c.grid)*c.grid;Vt=p,Kt=m;const g=Ut(i.drag.yPitch0+m),h=u.tracks.find(x=>x.id===i.activeTrackId);h&&oe(g,h.id,h.instrument,rt),z();const k=o,y=i.scrollX,w=window.devicePixelRatio||1;tt.save(),tt.setTransform(w,0,0,w,0,0),tt.globalAlpha=.7,tt.fillStyle=ot;for(const x of c.base){const L=Math.max(0,x.startTick+p),S=Math.round(L/T*k)-Math.floor(y)+.5,X=Math.max(1,Math.round(x.durationTick/T*k)),E=(95-Ut(x.pitch+m))*i.keyHeight+.5,P=i.keyHeight-1;tt.fillRect(S,E,X,P)}tt.globalAlpha=1,tt.restore();return}if(i.drag.kind==="resize-left"){const c=(e-i.drag.mouseStartX)/o;let l=i.drag.startTick0+c*T,m=Math.max(0,Math.floor(l/a)*a);m=Math.min(m,i.drag.endTick0-a);const f=i.drag.endTick0-m;i.ghost={startTick:m,durationTick:f,pitch:d.pitch,color:ot};const p=i.drag.endTick0-i.drag.startTick0,g=Math.max(0,p-f),h=dt(32),k=u.tracks.find(x=>x.id===i.drag.trackId),y=new Set(i.selected),w=[];if(g>0)for(const x of k.notes){if(x.id===i.drag.noteId||!y.has(x.id))continue;const L=Math.max(h,x.durationTick-g);w.push({startTick:x.startTick,durationTick:L,pitch:x.pitch,color:ot})}i.ghostGroup=w.length?w:null,z();return}if(i.drag.kind==="resize-right"){const c=(e-i.drag.mouseStartX)/o;let l=i.drag.endTick0+c*T,m=Math.max(i.drag.startTick0+a,Math.ceil(l/a)*a);const f=u.tracks.find(S=>S.id===i.drag.trackId),p=i.drag.startTick0,g=f.notes.filter(S=>S.startTick>p).sort((S,X)=>S.startTick-X.startTick)[0];g&&(m=Math.min(m,g.startTick));const h=m-i.drag.startTick0;i.ghost={startTick:i.drag.startTick0,durationTick:h,pitch:d.pitch,color:ot};const k=i.drag.endTick0-i.drag.startTick0,y=Math.max(0,h-k),w=u.tracks.find(S=>S.id===i.drag.trackId),x=new Set(i.selected),L=[];if(y>0)for(const S of w.notes){if(S.id===i.drag.noteId||!x.has(S.id))continue;const X=w.notes.filter(Z=>Z.startTick>S.startTick).sort((Z,U)=>Z.startTick-U.startTick)[0];let M=Number.POSITIVE_INFINITY;X&&(M=Math.max(0,X.startTick-(S.startTick+S.durationTick)));const E=Math.max(0,Math.min(y,M)),P=S.durationTick+E;L.push({startTick:S.startTick,durationTick:P,pitch:S.pitch,color:ot})}i.ghostGroup=L.length?L:null,z();return}}if(i.drag.kind==="create"){const r=i.drag.startTick,s=(e-r/T*o)/o,d=r+Math.max(a,Math.round(s*T)),l=Math.max(r+a,Math.ceil(d/a)*a)-r,m=Ut(95-Math.floor(n/i.keyHeight));i.ghost={startTick:r,durationTick:l,pitch:m,color:ot};const f=u.tracks.find(p=>p.id===i.activeTrackId);f&&oe(m,f.id,f.instrument,rt),z()}}function $o(){if(H)return;if(xt){xt=!1;return}rt.sampler&&rt.pitch!==null&&(On(rt.sampler,rt.pitch),rt.pitch=null,rt.sampler=null);const t=document.activeElement;if(t&&(t.tagName==="INPUT"||t.tagName==="SELECT"||t.isContentEditable))return;if(i.marquee.active){i.marquee.active=!1,z();return}if(!i.drag)return;if(i.drag.kind==="move"&&i.moveGroup){const s=document.elementFromPoint(window.lastPointerX??0,window.lastPointerY??0)?.closest?.(".track-card");if(s){const l=parseInt(s.dataset.trackId||"-1",10),m=i.moveGroup.trackId;if(!Number.isNaN(l)&&l>0&&l!==m){const f=u.tracks.find(k=>k.id===m),p=u.tracks.find(k=>k.id===l),g=new Set(i.moveGroup.ids),h=f.notes.filter(k=>g.has(k.id));if(h.length>0){const k=Math.min(...h.map(x=>x.startTick)),y=Math.max(...h.map(x=>x.startTick+x.durationTick)),w=p.notes.filter(x=>x.startTick<y&&x.startTick+x.durationTick>k);f.notes=f.notes.filter(x=>!g.has(x.id)).concat(w),p.notes=p.notes.filter(x=>!w.includes(x)).concat(h),se(f.notes),se(p.notes),i.selected.clear();for(const x of h)i.selected.add(x.id);i.moveGroup=null,i.drag=null,i.ghost=null,nt({track:f}),nt({track:p}),D(),G();return}}}const d=i.moveGroup;if(Vt===0&&Kt===0){i.moveGroup=null,i.drag=null,i.ghost=null;return}const c=u.tracks.find(l=>l.id===d.trackId);c.notes=c.notes.filter(l=>!d.ids.includes(l.id)),ve(async()=>{const{insertNoteWithOverlap:l,ensureBars:m}=await import("./languages-BtlVKnIV.js").then(f=>f.K);return{insertNoteWithOverlap:l,ensureBars:m}},[],import.meta.url).then(({insertNoteWithOverlap:l,ensureBars:m})=>{i.selected.clear();for(const f of d.base){const p={id:f.id,startTick:Math.max(0,f.startTick+Vt),durationTick:f.durationTick,pitch:Ut(f.pitch+Kt),velocity:100,volume:f.volume??I};l(u,d.trackId,p),m(u,p.startTick+p.durationTick),i.selected.add(p.id)}i.moveGroup=null,i.drag=null,i.ghost=null,Vt=0,Kt=0,nt({track:c}),D(),K()});return}if(!i.ghost){i.drag=null,document.querySelectorAll(".track-card.drop-hover").forEach(s=>s.classList.remove("drop-hover"));return}const e=i.ghost,n=i.drag.trackId,o=u.tracks.find(s=>s.id===n);let a=I;if(o){const s=$t(o);let d=I;for(let c=0;c<s.length;c++){const l=s[c];if(l.startTick>=e.startTick)break;const m=l.volume??I;bn(s,c,i.volumeLabels),d=m}a=d}const r={id:i.drag.noteId,startTick:e.startTick,durationTick:e.durationTick,pitch:e.pitch,velocity:100,volume:a};ve(async()=>{const{insertNoteWithOverlap:s,ensureBars:d}=await import("./languages-BtlVKnIV.js").then(c=>c.K);return{insertNoteWithOverlap:s,ensureBars:d}},[],import.meta.url).then(({insertNoteWithOverlap:s,ensureBars:d})=>{const c=u.tracks.find(l=>l.id===n);if(i.drag.kind==="resize-left"||i.drag.kind==="resize-right"){const l=c.notes.findIndex(h=>h.id===i.drag.noteId);l>=0&&c.notes.splice(l,1);const m=i.drag.endTick0-i.drag.startTick0,f=e.durationTick,p=Math.max(0,m-f);if(p>0){const h=dt(32),k=new Set(i.selected);for(const y of c.notes)y.id!==i.drag.noteId&&k.has(y.id)&&(y.durationTick=Math.max(h,y.durationTick-p))}const g=Math.max(0,f-m);if(g>0){const h=new Set(i.selected);for(const k of c.notes){if(k.id===i.drag.noteId||!h.has(k.id))continue;const y=c.notes.filter(L=>L.startTick>k.startTick).sort((L,S)=>L.startTick-S.startTick)[0];let w=Number.POSITIVE_INFINITY;y&&(w=Math.max(0,y.startTick-(k.startTick+k.durationTick)));const x=Math.max(0,Math.min(g,w));x>0&&(k.durationTick+=x,d(u,k.startTick+k.durationTick))}}}s(u,n,r),d(u,r.startTick+r.durationTick),i.drag=null,i.ghost=null,i.ghostGroup=null,document.querySelectorAll(".track-card.drop-hover").forEach(l=>l.classList.remove("drop-hover")),nt({track:c,recomputeLabels:!0}),D(),K()})}function z(){Yo(),i.isAltDown=De;const t=C[u.zoomLevel-1],e=Y/T*t,n=i.scrollX,o=R.clientWidth,a=n+o;R.clientHeight;const r=u.timeSig.beatsPerBar*t,s=($||u.timeSig.beatsPerBar)*t,d=Math.floor(n/r),c=n-d*r,l=Math.floor(n/s),m=n-l*s;_.style.left=`${-c}px`,V&&(V.style.left=`${-m}px`),V&&ie&&fn(ie,V,u,i,$),to(tt,u,i,d*r,o+r);const f=e-n;if(H)if(ft==="area"){const h=C[u.zoomLevel-1],k=$||u.timeSig.beatsPerBar,y=h*k,x=Math.floor(e/y)*y-n;po(tt,_,x,y)}else je(tt,_,f);else je(tt,_,f);mo(hn,j,i.keyHeight);const g=-R.scrollTop+i.keyHeight;if(j.style.transform=`translateY(${g}px)`,Go(),H&&e>=a){const h=C[u.zoomLevel-1],k=u.timeSig.beatsPerBar*h,y=Y/T*h,w=Math.floor(y/k)*k,x=wt(),L=Math.max(0,x-R.clientWidth);i.scrollX=Math.max(0,Math.min(L,w))}ue(),Nn()}function Yo(){const t=window.devicePixelRatio||1,e=C[u.zoomLevel-1],o=u.timeSig.beatsPerBar*e,a=(R.clientWidth||800)+o,r=84*i.keyHeight,s=r;_.style.width!==`${a}px`&&(_.style.width=`${a}px`),_.style.height!==`${s}px`&&(_.style.height=`${s}px`);const d=Math.max(1,Math.floor(a*t)),c=Math.max(1,Math.floor(s*t));if((_.width!==d||_.height!==c)&&(_.width=d,_.height=c),V&&ie){const k=(R.clientWidth||800)+o,y=r;V.style.width!==`${k}px`&&(V.style.width=`${k}px`),V.style.height!==`${y}px`&&(V.style.height=`${y}px`);const w=Math.max(1,Math.floor(k*t)),x=Math.max(1,Math.floor(y*t)),L=V.width!==w,S=V.height!==x;(L||S)&&(V.width=w,V.height=x),(L||S||ht!==u.zoomLevel)&&(fn(ie,V,u,i,$),ht=u.zoomLevel)}const l=84*i.keyHeight;(j.width!==Math.floor(48*t)||j.height!==Math.floor(l*t))&&(j.width=Math.floor(48*t),j.height=Math.floor(l*t),t!==1&&hn.setTransform(t,0,0,t,0,0)),j.style.width!=="48px"&&(j.style.width="48px");const m=`${l}px`;j.style.height!==m&&(j.style.height=m);const f=i.keyHeight;ut.style.height!==f+"px"&&(ut.style.height=f+"px");const p=ut.clientWidth||R.clientWidth||800,g=Math.max(1,Math.floor(p*t)),h=Math.max(1,Math.floor(f*t));(B.width!==g||B.height!==h)&&(B.width=g,B.height=h,t!==1&&Te.setTransform(t,0,0,t,0,0))}function Ce(){H=!1,re().stop(),ln(),ue(),Nn(),mt()}function Cn(){H=!1,re().stop(),re().position=0,ln(),Y=wo,ue(),z(),mt()}function Go(){const t=C[u.zoomLevel-1],e=$||u.timeSig.beatsPerBar,n=window.devicePixelRatio||1,o=i.keyHeight;ut.style.height!==o+"px"&&(ut.style.height=o+"px");const a=ut.clientWidth||R.clientWidth||800,r=Math.max(1,Math.floor(a*n)),s=Math.max(1,Math.floor(o*n));B.width!==r&&(B.width=r),B.height!==s&&(B.height=s),n!==1&&Te.setTransform(n,0,0,n,0,0);const d=i.scrollX;fo(Te,B,d,t,e,u,Ft)}function N(){ht=-1,z()}function Pn(){if(!H)return;const t=performance.now(),e=Math.max(0,t-Be);Be=t;const n=u.tempoAnchors||[],o=ze(n,u.bpm);Y=qn(o,Y,e);const a=Yt();if(Y>=a){Cn();return}z(),requestAnimationFrame(Pn)}function Yt(){let t=0;for(const e of u.tracks)for(const n of e.notes){const o=n.startTick+n.durationTick;o>t&&(t=o)}return t}function ue(){if(!Je)return;const t=Yt(),e=Math.max(0,Math.floor(Y)),n=u.tempoAnchors||[],o=ze(n,u.bpm),a=xe(o,e),r=xe(o,t);Je.textContent=`${Fe(a)} / ${Fe(r)}`}function jo(t){if(mt(),t.button===2||H)return;const e=B.getBoundingClientRect(),n=t.clientX-e.left,o=Sn(n);if(o){Ft=o.tick,B._dragAnchorIndex=o.index,B._draggingTempo=!0,B._dragStartTick=o.tick,N();return}xt=!0,Gt(t)}function Jo(t){if(B._draggingTempo===!0){const n=B.getBoundingClientRect(),o=t.clientX-n.left,a=C[u.zoomLevel-1],r=dt(i.selectedLength),s=(o+i.scrollX)/a*T,d=_e(Math.max(0,Math.floor(s)),r),c=B._dragAnchorIndex,l=u.tempoAnchors||[];c>=0&&c<l.length&&(l[c].tick=d,l.sort((m,f)=>m.tick-f.tick),Ft=d,u.tempoAnchors=l,N());return}xt&&Gt(t)}function Zo(){if(B._draggingTempo===!0){D(),B._draggingTempo=!1,B._dragAnchorIndex=-1,B._dragStartTick=null,K();for(const e of u.tracks)lt(e);N();return}xt=!1}function Gt(t){const{x:e}=Ln(t),n=C[u.zoomLevel-1],o=e/n*T,a=dt(i.selectedLength);Y=Math.max(0,Math.floor(o/a)*a),H&&(H=!1),z()}function Nn(){const t=wt(),e=t-R.clientWidth;if(e<=1){zt.style.display="none";return}zt.style.display="block";const n=Math.max(20,R.clientWidth/t*zt.clientWidth);Wt.style.width=`${n}px`;const a=i.scrollX/e*(zt.clientWidth-n);Wt.style.left=`${a}px`}function wt(){const t=C[u.zoomLevel-1],e=Math.ceil(Yt()/T);return Math.max(R.clientWidth,Math.ceil(e*t)+R.clientWidth)}function le(t){const e=C[u.zoomLevel-1],n=u.timeSig.beatsPerBar*e,o=Math.round(t/n)*n;return Math.max(0,o)}function _n(){const t=b[v];if(W&&(W.textContent=J?t.extendedLessLabel||"더 적은 단위":t.extendedMoreLabel||"더 많은 단위",W.title=J?t.tooltipExtendedLess||"기본 단위로 돌아가기":t.tooltipExtendedMore||"더 많은 단위 사용 (64/128/5/7/11)",W.setAttribute("data-i18n",J?"extendedLessLabel":"extendedMoreLabel"),W.setAttribute("data-i18n-title",J?"tooltipExtendedLess":"tooltipExtendedMore"),W.setAttribute("aria-label",W.title)),q){const e=t.tooltipDisplayTimeSig||"Display time signature (n/4)";q.title=e,q.setAttribute("data-i18n-title","tooltipDisplayTimeSig"),q.setAttribute("aria-label",e)}}at(W,"ghost","sm");if(q){const t=a=>Math.max(1,Math.min(16,Math.floor(a)));let e=null;try{const a=localStorage.getItem(Qe);if(a!=null){const r=Number(a);Number.isFinite(r)&&(e=t(r))}}catch{}const n=e??t(Number(u.displayBeatsPerBar)||Number(u.timeSig?.beatsPerBar)||4);$=n,u.displayBeatsPerBar=n,q.value!==String(n)&&(q.value=String(n));const o=()=>{const a=Number(q.value),r=Number.isFinite(a)?t(a):n;$=r,u.displayBeatsPerBar=r,q.value!==String(r)&&(q.value=String(r));try{localStorage.setItem(Qe,String(r))}catch{}ht=-1,D(),N()};q.addEventListener("change",o),q.addEventListener("input",o)}window.addEventListener("resize",()=>{qe(),ht=-1,N()});setTimeout(qe,0);de();mn();Ee&&F(Ee,"tooltipPlay",b[v].tooltipPlay);Le&&F(Le,"tooltipPause",b[v].tooltipPause);st&&(st.textContent=ft==="area"?b[v].playheadAreaLabel:b[v].playheadLineLabel,F(st,"tooltipPlayheadToggle",b[v].tooltipPlayheadToggle));Se&&F(Se,"tooltipStop",b[v].tooltipStop);Et&&(at(Et,"secondary","md"),Et.setAttribute("data-i18n","edit"),F(Et,"tooltipEditMML",b[v].tooltipEditMML));Qt&&(at(Qt,"secondary","md"),F(Qt,"tooltipConvert",b[v].tooltipConvert));Zt&&(at(Zt,"secondary","md"),F(Zt,"tooltipPaste",b[v].tooltipPaste));Ot&&(at(Ot,"ghost","md"),F(Ot,"tooltipGuide",b[v].tooltipGuide));if(et){const t=(()=>{try{return localStorage.getItem(gn)}catch{return null}})(),e=Math.max(16,Math.min(32,t?parseInt(t,10):i.keyHeight));i.keyHeight=e,et.value=String(e),Lt&&(Lt.textContent=String(e)),et.min="16",et.max="32",et.step="1",F(et,"tooltipKeyHeight",b[v].tooltipKeyHeight||"노트 높이 (16-32)")}te&&(at(te,"ghost","sm"),F(te,"tooltipLangKo",b[v].tooltipLangKo));ee&&(at(ee,"ghost","sm"),F(ee,"tooltipLangJa",b[v].tooltipLangJa));ne&&(at(ne,"ghost","sm"),F(ne,"tooltipLangEn",b[v].tooltipLangEn));_&&(_.setAttribute("data-i18n-title","tooltipPianoRoll"),_.title=b[v].tooltipPianoRoll);B&&(B.setAttribute("data-i18n-title","tooltipRuler"),B.title=b[v].tooltipRuler);Bo();N();gt();try{pt.push(u)}catch{}Et?Et.onclick=()=>{const t=u.tracks.find(n=>n.id===i.activeTrackId);if(!t)return;let e=t.optimizedMML?.trim?.()||t.mmlString?.trim?.()||"";if(e=e.replace(/[\r\n]+/g,""),!e)try{e=(dn(t.notes??[])||"").trim().replace(/[\r\n]+/g,"")}catch{}Jn(t,n=>{En(t,n);try{const o=un([n],u.bpm);u.tempoAnchors=o,o.length>0&&o[0].tick===0&&Number.isFinite(o[0].bpm)&&(u.bpm=o[0].bpm)}catch{}u.maxEndTick=Yt(),lt(t);for(const o of u.tracks)o!==t&&lt(o);K(),gt(),G()},e)}:u=an();_n();W.id="btnToggleExtended";W.style.marginLeft="8px";W.textContent=J?b[v].extendedLessLabel||"더 적은 단위":b[v].extendedMoreLabel||"더 많은 단위";Re.onmessage=t=>{const{trackId:e,optimizedMML:n,originalBody:o}=t.data,a=u.tracks.find(r=>r.id===e);a&&(a.optimizedMML=n,a.originalBody=o??"",G(),gt(),Bt())};yo?.addEventListener("click",()=>{xn(T)});bo?.addEventListener("click",()=>{const t=T*Mn();xn(t)});vo?.addEventListener("click",()=>{wn(T)});xo?.addEventListener("click",()=>{const t=T*Mn();wn(t)});(function(){yt&&(yt.textContent=b[v].trackMMLLabel||"트랙MML",yt.setAttribute("data-i18n","trackMMLLabel"),yt.setAttribute("data-i18n-title","tooltipEditMML"),yt.title=b[v].tooltipEditMML)})();i.moveGroup=null;(function(){const e="2025-09-07-midtempo-warning",n="mml_editor_whatsnew_shown_"+e;let o=!1;try{o=localStorage.getItem(n)==="1"}catch{}o||setTimeout(()=>ho(e),0)})();async function Qo(){try{pt.push(u);const t=await navigator.clipboard.readText();if(!t.trim().startsWith("MML@")){alert(b[v].invalid_mml_format||"MML 형식이 아닙니다.");return}let e=t.trim().substring(4);e=e.replace(/\r?\n/g,"").replace(/;+$/g,"");const n=e.split(",").map(a=>a.replace(/;+$/g,"").trim());if(n.length>6){alert("트랙은 최대 6개까지만 지원합니다.");return}try{const a=un(n,u.bpm);u.tempoAnchors=a,a.length>0&&a[0].tick===0&&Number.isFinite(a[0].bpm)&&(u.bpm=a[0].bpm)}catch{}const o=[];for(let a=0;a<u.tracks.length;a++){const r=n[a]?n[a]:"",s=u.tracks[a],d=s.notes?.length||0;try{if(r&&r.length>0)try{s.optimizedMML=Kn(r,!0,!1)||r}catch{s.optimizedMML=r}else s.optimizedMML="";En(s,r),(s.notes?.length||0)>d&&o.push(s)}catch{alert(b[v].invalid_mml_format||"MML 형식이 아닙니다.");return}}u.maxEndTick=Yt(),o.length>0&&We(o),G(),Bt(),K()}catch{}}async function zn(){if(H)return;H=!0,await Hn(),mt();const t=Ao(),e=u.tempoAnchors||[];await Xn(t,u.bpm,{tempoAnchors:e});const n=ze(e,u.bpm);re().position=xe(n,Y),Be=performance.now();{const o=C[u.zoomLevel-1],a=u.timeSig.beatsPerBar*o,r=Y/T*o,s=Math.floor(r/a)*a,d=wt(),c=Math.max(0,d-R.clientWidth);i.scrollX=Math.max(0,Math.min(c,s))}ue?.(),Pn()}const Ve=()=>{const t=window.visualViewport?window.visualViewport.height:window.innerHeight;document.documentElement.style.setProperty("--app-100dvh",t+"px")};Ve();window.addEventListener("resize",Ve);window.visualViewport?.addEventListener("resize",Ve);
