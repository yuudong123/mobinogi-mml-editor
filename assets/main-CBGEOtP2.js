import{t as v,c as b,T as E,P as _,D as B,a as nn,H as Bn,e as on,s as rn,E as ke,B as ye,b as ve,I as Ae,d as Ne,i as Pn,L as Et,f as ht,g as Cn,p as Zt,_ as be,h as Oe,j as An,k as Nn,l as _e,m as we,n as te,o as an,q as J,r as _n,M as Me,u as Ve,v as zn,w as Rn}from"./languages-BPqcXAKa.js";import{notesToMMLRaw as sn,notesToMML as Dn,newOptimizeBody as Hn,mmlToNotes as Wn}from"./converter-D_KhkxFU.js";import{e as se,c as ee}from"./button-WIurEURm.js";import{showConvertModal as Xn}from"./convertModal-SMyW3ox0.js";import{showGuideModal as Ue}from"./guideModal-BNVMxcvG.js";let Ke=!1;function qn(){if(Ke)return;const t=`
  :root {
    --dd-radius: 6px;
    --dd-border: #cfcfcf;
    --dd-border-hover: #b5b5b5;
    --dd-bg: #fff;
    --dd-text: #111;
    --dd-muted: #6b7280;
    --dd-shadow: 0 8px 24px rgba(0,0,0,0.12), 0 2px 6px rgba(0,0,0,0.08);
    --dd-focus: 0 0 0 3px rgba(33,150,243,0.15);
  }

  .dropdown { position: relative; display: inline-flex; }
  .dropdown--full { width: 100%; }

  .dropdown__button {
    display: inline-flex; align-items: center; justify-content: space-between;
    gap: 8px; width: 100%;
    background: var(--dd-bg);
    color: var(--dd-text);
    border: 1px solid var(--dd-border);
    border-radius: var(--dd-radius);
    cursor: pointer; user-select: none;
    transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
  }
  .dropdown__button:hover { border-color: var(--dd-border-hover); }
  .dropdown__button:focus-visible { outline: none; box-shadow: var(--dd-focus); }

  .dropdown__button--sm { height: 28px; padding: 4px 8px; font-size: 12px; }
  .dropdown__button--md { height: 34px; padding: 6px 10px; font-size: 14px; }
  .dropdown__button--lg { height: 40px; padding: 8px 12px; font-size: 16px; }

  .dropdown__caret { width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 6px solid #888; }

  .dropdown__menu {
    position: absolute; left: 0; top: calc(100% + 4px);
    min-width: 100%;
    background: #fff; border: 1px solid var(--dd-border);
    border-radius: var(--dd-radius);
    box-shadow: var(--dd-shadow);
    padding: 6px; margin: 0; list-style: none;
    z-index: 1000; display: block; opacity: 0; transform: var(--dd-transform, translateY(4px));
    pointer-events: none; transition: opacity .16s ease, transform .16s ease;
  }
  .dropdown__menu[data-open="true"] { opacity: 1; transform: translateY(0); pointer-events: auto; }

  .dropdown__item {
    padding: 6px 8px; border-radius: 6px; cursor: pointer;
    white-space: nowrap; color: var(--dd-text);
  }
  .dropdown__item[aria-selected="true"] { background: #eef6ff; }
  .dropdown__item:hover { background: #f3f4f6; }
  .dropdown__item:focus { outline: none; box-shadow: var(--dd-focus); }
  `,e=document.createElement("style");e.id="dropdown-styles",e.textContent=t,document.head.appendChild(e),Ke=!0}function On(t){qn();const e=t.size??"md";let o=t.value??t.items[0]?.value??"",a=t.items;const i=document.createElement("div");i.className="dropdown",i.classList.add("dropdown--full");const n=document.createElement("button");n.type="button",n.className=`dropdown__button dropdown__button--${e}`,n.setAttribute("aria-haspopup","listbox"),n.setAttribute("aria-expanded","false");const s=document.createElement("span");s.textContent=t.items.find(x=>x.value===o)?.label??"";const d=document.createElement("i");d.className="dropdown__caret",n.append(s,d);const c=document.createElement("ul");c.className="dropdown__menu",c.setAttribute("role","listbox"),c.setAttribute("tabindex","-1");const l=i;let m=!1;function f(){c.innerHTML="";for(const x of a){const T=document.createElement("li");T.className="dropdown__item",T.setAttribute("role","option"),T.setAttribute("tabindex","0"),T.setAttribute("aria-selected",String(x.value===o)),T.textContent=x.label,T.addEventListener("click",()=>w(x.value)),T.addEventListener("keydown",P=>{P.key==="Enter"||P.key===" "?(P.preventDefault(),w(x.value)):P.key==="Escape"?(P.preventDefault(),h(),n.focus()):P.key==="ArrowDown"?(P.preventDefault(),L(T)):P.key==="ArrowUp"&&(P.preventDefault(),S(T))}),c.appendChild(T)}}function p(){f(),m||(document.body.appendChild(c),m=!0,c.style.position="fixed",c.style.zIndex="1000");const x=n.getBoundingClientRect();c.style.minWidth=x.width+"px",M(),c.dataset.open="true",n.setAttribute("aria-expanded","true"),window.addEventListener("mousedown",k,{capture:!0}),window.addEventListener("scroll",y,!0),window.addEventListener("resize",y)}function h(){delete c.dataset.open,n.setAttribute("aria-expanded","false"),m&&(l.appendChild(c),m=!1,c.style.position="",c.style.left="",c.style.top="",c.style.minWidth="",c.style.zIndex=""),window.removeEventListener("mousedown",k,{capture:!0}),window.removeEventListener("scroll",y,!0),window.removeEventListener("resize",y)}function g(){c.dataset.open==="true"?h():p()}function k(x){const T=x.target;i.contains(T)||c.contains(T)||h()}function y(){c.dataset.open==="true"&&M()}function M(){const x=n.getBoundingClientRect(),T=c.getBoundingClientRect(),P=window.innerHeight,Y=window.innerWidth,K=8,St=4,bt=Math.max(T.width,x.width);let de=Math.min(Math.max(x.left,K),Math.max(K,Y-bt-K));const It=P-x.bottom-K,Ft=x.top-K;let $t=!1,wt=Math.min(360,Math.max(It-St,120));T.height>It&&Ft>It&&($t=!0,wt=Math.min(360,Math.max(Ft-St,120)));let ue;$t?(ue=Math.max(K,x.top-St-Math.min(T.height,wt)),c.dataset.placement="top",c.style.setProperty("--dd-transform","translateY(-4px)")):(ue=Math.min(P-K-Math.min(T.height,wt),x.bottom+St),c.dataset.placement="bottom",c.style.setProperty("--dd-transform","translateY(4px)")),c.style.top=`${Math.round(ue)}px`,c.style.left=`${Math.round(de)}px`,c.style.maxHeight=`${wt}px`,c.style.overflowY="auto"}function w(x){if(x===o){h(),n.focus();return}o=x,s.textContent=a.find(T=>T.value===o)?.label??"",h(),n.focus(),t.onChange(o)}function L(x){const T=Array.from(c.querySelectorAll(".dropdown__item")),P=T.indexOf(x);T[Math.min(T.length-1,P+1)]?.focus()}function S(x){const T=Array.from(c.querySelectorAll(".dropdown__item")),P=T.indexOf(x);T[Math.max(0,P-1)]?.focus()}n.addEventListener("click",()=>g()),n.addEventListener("keydown",x=>{if(x.key==="ArrowDown"||x.key==="Enter"||x.key===" ")x.preventDefault(),p();else if(x.key==="ArrowUp"){x.preventDefault(),p();const T=c.querySelectorAll(".dropdown__item");T[T.length-1]?.focus()}});function z(x){a=x;const T=a.find(P=>P.value===o);T?s.textContent=T.label:s.textContent="",c.dataset.open==="true"&&f()}return i.append(n,c),{el:i,get value(){return o},set value(x){w(x)},updateItems:z}}let Fe=!1;function cn(){if(Fe)return;const t=`
  :root {
    --fc-radius: 6px;
    --fc-border: #cfcfcf;
    --fc-border-hover: #b5b5b5;
    --fc-border-focus: #2196f3;
    --fc-bg: #ffffff;
    --fc-bg-disabled: #f7f7f7;
    --fc-text: #111;
    --fc-placeholder: #9aa0a6;
    --fc-shadow-focus: 0 0 0 3px rgba(33,150,243,0.15);
  }

  .input, .select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    box-sizing: border-box;
    font: inherit;
    color: var(--fc-text);
    background: var(--fc-bg);
    border: 1px solid var(--fc-border);
    border-radius: var(--fc-radius);
    outline: none;
    transition: border-color .2s ease, box-shadow .2s ease, background .2s ease, transform .15s ease;
  }

  .input::placeholder {
    color: var(--fc-placeholder);
  }

  .input:hover, .select:hover {
    border-color: var(--fc-border-hover);
  }

  .input:focus, .select:focus {
    border-color: var(--fc-border-focus);
    box-shadow: var(--fc-shadow-focus);
  }

  /* Sizes */
  .fc--sm { height: 28px; padding: 4px 8px; font-size: 12px; }
  .fc--md { height: 34px; padding: 6px 10px; font-size: 14px; }
  .fc--lg { height: 40px; padding: 8px 12px; font-size: 16px; }

  /* Full width helper */
  .fc--full { width: 100%; }

  /* Number inputs: right align helper */
  .fc--num-right { text-align: right; }

  /* Disabled */
  .input:disabled, .select:disabled { background: var(--fc-bg-disabled); color: #888; cursor: not-allowed; }

  /* Select arrow */
  .select {
    background-image: url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5' stroke='%23888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 16px 16px;
    padding-right: 28px; /* space for arrow */
  }

  /* Remove default arrow on some browsers */
  .select::-ms-expand { display: none; }
  `,e=document.createElement("style");e.id="form-control-styles",e.textContent=t,document.head.appendChild(e),Fe=!0}function Vn(t,e){cn(),t.classList.add("input");const o=e?.size;t.classList.add(Un(o)),t.classList.add("fc--full"),e?.rightAlign&&t.classList.add("fc--num-right")}function Un(t){return t==="sm"?"fc--sm":t==="lg"?"fc--lg":"fc--md"}let ct=null,Q=null,Nt=null,_t=null,Bt=null;function Kn(t,e,o){if(ct||Fn(),!ct||!Q||!Nt||!_t)return;Q.value=(o??t.mmlString)||"",ct.style.display="flex",Q.focus();const a=n=>{n.stopPropagation()};Q.addEventListener("keydown",a),Q.addEventListener("keyup",a);function i(){ct.style.display="none",Q.removeEventListener("keydown",a),Q.removeEventListener("keyup",a),Nt.onclick=null,_t.onclick=null,Bt&&(window.removeEventListener("keydown",Bt,!0),Bt=null)}Nt.onclick=()=>{e(Q.value),i()},_t.onclick=i,Bt=n=>{n.key==="Escape"&&(n.stopPropagation(),i())},window.addEventListener("keydown",Bt,!0)}function Fn(){ct=document.createElement("div"),ct.id="mmlEditModal",ct.style.cssText=`
    position: fixed; 
    left: 0; top: 0; 
    width: 100vw; 
    height: 100vh;
    background: rgba(0,0,0,0.25); 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    z-index: 200;
    display: none;
  `;const t=document.createElement("div");t.style.cssText=`
            background: #fff;
            padding: 24px;
            border-radius: 8px;
            min-width: 400px;
            box-shadow: 0 2px 16px #0002;
            display: flex;
            flex-direction: column;
            gap: 12px;
        `,Q=document.createElement("textarea"),Q.style.cssText=`
            width: 100%;
            min-height: 120px;
            font-family: monospace;
            font-size: 15px;
            word-break: break-all;
            overflow-x: wrap;
        `,se(),Nt=ee({label:v[b].ok,variant:"primary",attrs:{"data-i18n":"ok"}}),_t=ee({label:v[b].cancel,variant:"secondary",attrs:{"data-i18n":"cancel"}});const e=document.createElement("div");e.style.cssText=`
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        `,e.append(_t,Nt),t.append(Q,e),ct.appendChild(t),document.body.appendChild(ct)}function $n(){return{scrollX:0,scrollY:0,keyHeight:16,activeTrackId:1,selectedLength:16,hover:{noteId:null,edge:null},drag:null,ghost:null,ghostGroup:null,selected:new Set,marquee:{active:!1,x0:0,y0:0,x1:0,y1:0,mode:"replace"},clipboard:null,volumeLabels:new Set}}function Gn(t,e,o,a,i,n,s){t.save();const d=window.devicePixelRatio||1;t.setTransform(d,0,0,d,0,0);const c=t.canvas.clientWidth||t.canvas.width/d,l=t.canvas.clientHeight||t.canvas.height/d;t.clearRect(0,0,c,l),Qn(t,e,o,a,i),to(t,o,e,a),eo(t,e,o,a,i),no(t,e,o,a,i),oo(t,o,a),Jn(t,e,a,i,l),t.restore()}function ln(t,e,o,a,i){const n=window.devicePixelRatio||1;t.setTransform(n,0,0,n,0,0);const s=e.clientWidth||e.width/n,d=e.clientHeight||e.height/n;t.clearRect(0,0,s,d),t.fillStyle="#ffffff",t.fillRect(0,0,s,d);const c=84*a.keyHeight;Yn(t,0,s,a),jn(t,o,0,s,c,i)}function zt(t,e,o,a,i,n){const s=Math.max(0,Math.min(n,Math.floor(Math.min(a,i)/2))),d=Math.floor(e),c=Math.floor(o),l=d+Math.max(0,a),m=c+Math.max(0,i);if(t.beginPath(),s<=0){t.rect(d,c,a,i);return}t.moveTo(d+s,c),t.lineTo(l-s,c),t.arcTo(l,c,l,c+s,s),t.lineTo(l,m-s),t.arcTo(l,m,l-s,m,s),t.lineTo(d+s,m),t.arcTo(d,m,d,m-s,s),t.lineTo(d,c+s),t.arcTo(d,c,d+s,c,s)}function Yn(t,e,o,a){const i=a.keyHeight,n=84*i,s=Math.ceil(n/i);for(let d=0;d<s;d++){const c=d*i,m=((95-d)%12+12)%12,f=m===1||m===3||m===6||m===8||m===10;t.fillStyle=f?"#d6d6d6":"#ffffff",t.fillRect(e,c,Math.max(0,o),i);const p=m===11;t.strokeStyle=p?"#000000":"rgb(153,153,153)",t.beginPath(),t.moveTo(e,c+.5),t.lineTo(e+Math.max(0,o),c+.5),t.stroke()}}function jn(t,e,o,a,i,n){const s=_[e.zoomLevel-1],d=n&&n>=1?n:e.timeSig.beatsPerBar,c=Math.max(0,Math.floor(o/s)-2),l=Math.floor((o+a)/s)+2;for(let f=c;f<=l;f++){const p=Math.floor(f*s),h=f%d===0;t.strokeStyle=h?"#000":"rgb(128,128,128)",t.beginPath(),t.moveTo(p,0),t.lineTo(p,i),t.stroke()}const m=e.zoomLevel;m>=4&&me(t,o,a,i,s,2,"rgb(191,191,191)"),m>=6&&me(t,o,a,i,s,4,"rgb(191,191,191)"),m>=8&&me(t,o,a,i,s,8,"rgb(191,191,191)")}function me(t,e,o,a,i,n,s){const d=Math.max(0,Math.floor(e/i)-2),c=Math.floor((e+o)/i)+2;t.strokeStyle=s;for(let l=d;l<=c;l++)for(let m=1;m<n;m+=2){const f=Math.floor((l+m/n)*i);t.beginPath(),t.moveTo(f,0),t.lineTo(f,a),t.stroke()}}function Jn(t,e,o,a,i){const n=e.tempoAnchors||[];if(!n||n.length===0)return;const s=_[e.zoomLevel-1];t.save(),t.strokeStyle="rgba(159, 215, 255, 0.9)",t.lineWidth=1;for(const d of n){const c=Math.round(d.tick/E*s);if(c+1<o||c-1>o+a)continue;const l=c-Math.floor(o)+.5;t.beginPath(),t.moveTo(l,0),t.lineTo(l,i),t.stroke()}t.restore()}function Qn(t,e,o,a,i){const n=_[e.zoomLevel-1],s=o.activeTrackId,d=[...e.tracks].sort((c,l)=>c.id===s?1:l.id===s?-1:0);for(const c of d){const l=c.id===s?1:.5;t.globalAlpha=l;for(const m of c.notes){const f=Math.round(m.startTick/E*n),p=Math.max(1,Math.round(m.durationTick/E*n));if(f+p<a||f>a+i)continue;const h=f-Math.floor(a);Zn(t,h,m,c.color,n,o.keyHeight,o.hover,c.id===s,o.selected.has(m.id))}}t.globalAlpha=1}function Zn(t,e,o,a,i,n,s,d,c){const l=Math.max(1,Math.round(o.durationTick/E*i)),m=(95-o.pitch)*n+1,f=n-1,p=Math.min(6,Math.floor(f/2));if(t.fillStyle=a,zt(t,e,m,l,f,p),t.fill(),t.strokeStyle="rgba(0,0,0,0.3)",t.lineWidth=1,zt(t,e,m,l-1,f-1,Math.max(0,p-1)),t.stroke(),c&&(t.strokeStyle="#3a7afe",t.lineWidth=2,zt(t,e,m,l-1,f-1,Math.max(0,p-1)),t.stroke(),t.lineWidth=1),d&&s.noteId===o.id){const h=Math.min(8,Math.floor(l/3));t.fillStyle="rgba(0,0,0,0.15)",t.fillRect(e,m,h,f),t.fillRect(e+l-h,m,h,f)}}function to(t,e,o,a){const i=_[o.zoomLevel-1],n=s=>{const d=Math.round(s.startTick/E*i)-Math.floor(a),c=Math.max(1,Math.round(s.durationTick/E*i)),l=(95-s.pitch)*e.keyHeight+1,m=e.keyHeight-1;t.globalAlpha=.7,t.fillStyle=s.color;const f=Math.min(6,Math.floor(m/2));zt(t,d,l,c,m,f),t.fill(),t.globalAlpha=1};if(e.ghost&&n(e.ghost),e.ghostGroup)for(const s of e.ghostGroup)n(s)}function eo(t,e,o,a,i){const n=_[e.zoomLevel-1],s=o.keyHeight;t.strokeStyle="#3a7afe",t.lineWidth=2;for(const d of e.tracks)for(const c of d.notes){if(!o.selected.has(c.id))continue;const l=Math.round(c.startTick/E*n)-Math.floor(a),m=Math.max(1,Math.round(c.durationTick/E*n)),f=l+Math.floor(a);if(f+m<a||f>a+i)continue;const p=(95-c.pitch)*s+1,h=s-1,g=Math.min(6,Math.floor(h/2));zt(t,l,p,m-1,h-1,Math.max(0,g-1)),t.stroke()}t.lineWidth=1}function no(t,e,o,a,i){if(!o.volumeLabels||o.volumeLabels.size===0)return;const n=_[e.zoomLevel-1],s=o.keyHeight;t.font="10px sans-serif",t.textAlign="left",t.textBaseline="bottom";for(const d of e.tracks)for(const c of d.notes){if(!o.volumeLabels.has(c.id))continue;const l=Math.round(c.startTick/E*n),m=Math.max(1,Math.round(c.durationTick/E*n));if(l+m<a||l>a+i)continue;const f=l-Math.floor(a),p=(95-c.pitch)*s+1,h="V"+String(c.volume??B);t.fillStyle="rgba(255,255,255,0.9)",t.fillText(h,f+1,p-1),t.fillStyle="rgba(0,0,0,0.85)",t.fillText(h,f,p-2)}}function oo(t,e,o){if(!e.marquee.active)return;const a=Math.min(e.marquee.x0,e.marquee.x1)-Math.floor(o),i=Math.min(e.marquee.y0,e.marquee.y1),n=Math.abs(e.marquee.x1-e.marquee.x0),s=Math.abs(e.marquee.y1-e.marquee.y0);t.fillStyle="rgba(58,122,254,0.15)",t.fillRect(a,i,n,s),t.strokeStyle="rgba(58,122,254,0.8)",t.setLineDash([4,3]),t.strokeRect(a+.5,i+.5,n-1,s-1),t.setLineDash([])}function xe(t,e,o,a,i){for(let n=o.length-1;n>=0;n--){const s=o[n],d=Math.round(s.startTick/E*a),c=Math.max(1,Math.round(s.durationTick/E*a)),l=(95-s.pitch)*i+1,m=i-1;if(t>=d&&t<=d+c&&e>=l&&e<=l+m){const f=Math.min(8,Math.floor(c/3)),p=t<=d+f?"left":t>=d+c-f?"right":"center";return{note:s,edge:p}}}}function ro(t,e,o,a,i,n,s){const d=Math.min(t,o),c=Math.max(t,o),l=Math.min(e,a),m=Math.max(e,a),f=[];for(const p of i){const h=Math.round(p.startTick/E*n),g=Math.max(1,Math.round(p.durationTick/E*n)),k=(95-p.pitch)*s+1,y=s-1,M=h+g,w=k+y;M>=d&&h<=c&&w>=l&&k<=m&&f.push(p)}return f}function ao(t,e,o){t.clearRect(0,0,e.width,e.height);const a=window.devicePixelRatio||1,i=12*o;for(let n=0;n<7;n++){const s=(6-n)*i,d=n%2===1;t.fillStyle=d?"#e6e6e6":"#ffffff",t.fillRect(0,s,e.width/a,i),t.fillStyle="#222",t.font=`${Math.max(10,Math.round(12))}px system-ui, sans-serif`,t.textBaseline="middle",t.textAlign="center";const c="o"+(n+1),l=s+i/2;t.fillText(c,Math.floor(e.width/a/2),Math.floor(l))}}function io(t,e,o,a,i,n,s){const d=e.width,c=e.height,l=window.devicePixelRatio||1;t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,d,c),l!==1&&t.setTransform(l,0,0,l,0,0);const m=d/l,f=c/l;t.fillStyle="#ffffff",t.fillRect(0,0,m,f);const p=Math.floor(o/a),h=Math.ceil((o+m)/a);for(let y=p;y<=h;y++){const M=Math.round(y*a-o)+.5;if(y%i===0){t.strokeStyle="#000000",t.beginPath(),t.moveTo(M,0),t.lineTo(M,f),t.stroke();const L=Math.floor(y/i)+1;t.fillStyle="#222",t.font="12px system-ui, sans-serif",t.textAlign="left",t.textBaseline="top",t.fillText(String(L),M+4,2)}else{t.strokeStyle="rgb(128,128,128)";const L=Math.floor(f*.5);t.beginPath(),t.moveTo(M,L),t.lineTo(M,f),t.stroke()}}const g=n,k=g&&Array.isArray(g.tempoAnchors)?g.tempoAnchors:[];if(k&&k.length>0){t.save();const y=Math.max(9,Math.min(13,Math.floor(f*.6)));t.font=`${y}px system-ui, sans-serif`,t.textAlign="center",t.textBaseline="middle";for(const M of k){const w=M.tick/E*a,L=Math.round(w-o)+.5;if(L<-40||L>m+40)continue;const S="t"+String(M.bpm),z=t.measureText(S),x=(z.actualBoundingBoxAscent||y*.8)+(z.actualBoundingBoxDescent||y*.2),T=Math.max(4,Math.floor(y*.5)),P=Math.max(2,Math.floor(y*.3)),Y=Math.ceil(x)+P*2,K=Math.ceil(z.width)+T*2;let bt=f-Y-2;bt<.5&&(bt=.5);const de=Math.floor(L-K/2)+.5,It="#bfe7ff",Ft="#5bb6ff",$t="#003";t.fillStyle=It,t.strokeStyle=Ft,t.lineWidth=1,t.beginPath(),t.rect(de,bt,K,Y),t.fill(),t.stroke(),t.fillStyle=$t;const wt=bt+Y/2;t.fillText(S,L,Math.floor(wt))}t.restore()}}function $e(t,e,o){const a=window.devicePixelRatio||1,i=e.clientHeight||e.height/a;t.save(),t.setTransform(a,0,0,a,0,0),t.strokeStyle="rgba(255,0,0,0.9)",t.lineWidth=2,t.beginPath(),t.moveTo(Math.floor(o)+.5,0),t.lineTo(Math.floor(o)+.5,i),t.stroke(),t.restore()}function so(t,e,o,a){const i=window.devicePixelRatio||1,n=e.clientHeight||e.height/i;t.save(),t.setTransform(i,0,0,i,0,0),t.fillStyle="rgba(255,0,0,0.12)",t.fillRect(Math.floor(o),0,Math.ceil(a),n),t.restore()}function co(t,e){const o=document.createElement("div");o.style.cssText=`
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    `;const a=document.createElement("div");a.style.cssText=`
        background: #fff;
        width: min(640px, 92vw);
        max-height: 80vh;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        padding: 18px 18px 14px;
        position: relative;
        overflow: auto;
    `;const i=document.createElement("h2");i.textContent=v[b].whatsNewTitle||"What's new",i.style.margin="0 0 8px 0",i.style.fontSize="18px",i.setAttribute("data-i18n","whatsNewTitle");const n=document.createElement("div"),s=(m,f)=>{const p=document.createElement("ul");return p.style.margin="6px 0 0 18px",p.style.padding="0",m.forEach((h,g)=>{const k=document.createElement("li");k.textContent=h;const y=f[g];y&&k.setAttribute("data-i18n",y),p.append(k)}),p};{const m=document.createElement("h3");m.textContent=v[b].whatsNew_20250907_heading||"Mid-tempo conversion caution",m.setAttribute("data-i18n","whatsNew_20250907_heading"),m.style.margin="8px 0 6px 0";const f=[v[b].whatsNew_20250907_p1||"Turning on 'Apply mid-tempo' runs an experimental transform to align mid tempo positions.",v[b].whatsNew_20250907_p2||"Repeatedly reconverting an already fixed output can accumulate timing drift.",v[b].whatsNew_20250907_p3||"Recommendation: Keep original OFF version and regenerated ON version separately."],p=["whatsNew_20250907_p1","whatsNew_20250907_p2","whatsNew_20250907_p3"];n.append(m,s(f,p))}se();const d=ee({label:v[b].ok||"OK",size:"sm",variant:"primary"});d.setAttribute("data-i18n","ok"),d.style.marginTop="12px",d.style.alignSelf="flex-end";const c=()=>{o.remove();try{localStorage.setItem("mml_editor_whatsnew_shown_"+t,"1")}catch{}};d.addEventListener("click",c);const l=m=>{m.key==="Escape"&&c()};window.addEventListener("keydown",l,{once:!0}),o.addEventListener("click",m=>{m.target===o&&c()}),a.append(i,n,d),o.appendChild(a),document.body.appendChild(o)}const Mt=document.getElementById("footerMmlEditBtn"),fe=document.getElementById("footerMMLText"),ft=document.getElementById("footerLabel"),Gt=document.getElementById("btnPasteMML"),dn="mml_editor_project";let u=nn();const dt=new Bn,r=$n(),ze=new Worker(new URL(""+new URL("mmlOptimizerWorker-yHlGUEBU.js",import.meta.url).href,import.meta.url),{type:"module"}),pe=new Map,lo=300;let he=null;const Ge=document.getElementById("progress"),C=document.getElementById("roll"),V=document.getElementById("rollBg"),j=document.getElementById("octaveCanvas");let I=null,O=null,Pt=null,Ct=null,pt=null;const X=document.getElementById("timeRuler"),Z=C.getContext("2d"),ne=V?V.getContext("2d"):null,un=j.getContext("2d"),Te=X.getContext("2d"),Ye=document.getElementById("tracks"),Rt=document.getElementById("lenBar"),W=document.getElementById("dispSigN");let F=4;const je="mml_editor_display_timesig_n",N=document.getElementById("rollViewport"),Lt=document.getElementById("rulerContainer"),At=document.getElementById("customScrollbar"),Dt=document.getElementById("customScrollbarThumb"),Ee=document.getElementById("btnPlay"),Le=document.getElementById("btnPause"),Se=document.getElementById("btnStop"),st=document.getElementById("btnPlayheadMode"),Yt=document.getElementById("btnConvert"),Ht=document.getElementById("bpmDisplay"),Wt=document.getElementById("btnGuide"),it=document.getElementById("btnLoad"),Ie=document.getElementById("btnGoToMobile"),jt=document.getElementById("langKo"),Jt=document.getElementById("langJa"),Qt=document.getElementById("langEn"),uo=document.getElementById("btnPushBeat"),mo=document.getElementById("btnPushBar"),fo=document.getElementById("btnCutBeat"),po=document.getElementById("btnCutBar"),tt=document.getElementById("keyHeightRange"),xt=document.getElementById("keyHeightLabel"),ot="rgba(255,215,0,0.8)";let R=!1,$=0,Be=0,kt=!1,ho=0,Xt=0,qt=0,Re=!1;const rt={pitch:null,sampler:null};let ut=-1,lt="area";const mn="mml_editor_key_height";(()=>{const t=()=>{try{on()}catch{}finally{window.removeEventListener("pointerdown",t),window.removeEventListener("keydown",t)}};window.addEventListener("pointerdown",t,{passive:!0}),window.addEventListener("keydown",t)})();const D=document.createElement("button");Ie&&Ie.addEventListener("click",()=>{try{window.location.href="./mobile.html"}catch{}});function Tt(){const t=document.activeElement;if(!t)return;const e=t.tagName.toLowerCase();if((e==="input"||e==="select"||e==="textarea"||e==="button"||t.isContentEditable)&&!t.closest("#rollViewport, #roll, #rollBg, #timeRuler, #rulerContainer"))try{t.blur()}catch{}}function fn(t){const e=t.target;return e?!!e.closest("#rollViewport, #roll, #rollBg, #timeRuler, #rulerContainer"):!1}function Je(t){const e={bpm:120,timeSig:{beatsPerBar:4},zoomLevel:1,tracks:[],maxEndTick:0,tpqn:t?.tpqn??E,extendedUnitsEnabled:t?.extendedUnitsEnabled??J},o=Number(t?.bpm);e.bpm=Number.isFinite(o)&&o>0?o:120;const a=Number(t?.timeSig?.beatsPerBar);e.timeSig={beatsPerBar:Number.isFinite(a)&&a>=1?a:4};const i=Number(t?.zoomLevel);e.zoomLevel=Number.isFinite(i)&&i>=1&&i<=9?i:1;try{const c=Number(t?.displayBeatsPerBar);e.displayBeatsPerBar=Number.isFinite(c)&&c>=1&&c<=16?c:void 0}catch{}try{delete e.tempoAnchors}catch{}const n=Array.isArray(t?.tracks)?t.tracks:[],s=Math.max(1,Math.min(6,n.length||6));for(let c=0;c<s;c++){const l=n[c]??{},f=(Array.isArray(l?.notes)?l.notes:[]).map(z=>{const x=typeof z?.id=="string"&&z.id?z.id:crypto.randomUUID(),T=Math.max(0,Math.floor(Number(z?.startTick)||0)),P=Math.max(1,Math.floor(Number(z?.durationTick)||1)),Y=Math.max(0,Math.floor(Number(z?.pitch)||0)),K=Math.max(0,Math.min(15,Math.floor(Number(z?.volume)||B)));return{id:x,startTick:T,durationTick:P,pitch:Y,volume:K}}),p=typeof l?.instrument=="string"&&Ae.includes(l.instrument)?l.instrument:Ne,h=Number(l?.id)||c+1,g=Number.isFinite(Number(l?.order))?Number(l.order):c,k=typeof l?.name=="string"&&l.name?l.name:`Track ${c+1}`,y=typeof l?.color=="string"&&l.color?l.color:ve[c%ve.length],M=!!l?.mute,w=!!l?.solo,L=typeof l?.mmlString=="string"?l.mmlString:"",S=typeof l?.optimizedMML=="string"?l.optimizedMML:"";e.tracks.push({id:h,order:g,name:k,color:y,instrument:p,mmlString:L,optimizedMML:S,mute:M,solo:w,notes:f})}e.tracks.sort((c,l)=>c.order-l.order),e.tracks.forEach((c,l)=>{c.order=l});let d=0;for(const c of e.tracks)for(const l of c.notes)d=Math.max(d,l.startTick+l.durationTick);return e.maxEndTick=d,e}function yt(){he==null&&(he=requestAnimationFrame(()=>{he=null,q()}))}function U(t,e,o){t.setAttribute("data-i18n-title",e),t.title=o||v[b][e]||""}function at(t,e,o){t.classList.add("btn",`btn--${e}`,`btn--${o}`)}function gt(t){return Math.max(0,Math.min(15,t))}function Ot(t){return Math.max(12,Math.min(95,t))}function oe(t){return t.sort((e,o)=>e.startTick-o.startTick||e.pitch-o.pitch)}function pn(t){return t.sort((e,o)=>e.startTick-o.startTick||e.id.localeCompare(o.id))}function go(t,e){const o=e.volume??B;if(!r.volumeLabels)return;const a=pn(t.notes.slice()),i=a.findIndex(d=>d.id===e.id),n=i>0?a[i-1].volume??B:B,s=a.slice(0,i).some((d,c,l)=>{const m=r.volumeLabels.has(d.id),f=c>0?l[c-1].volume??B:B,p=(d.volume??B)!==f;return m||p});o===B?s?r.volumeLabels.add(e.id):r.volumeLabels.delete(e.id):o!==n?r.volumeLabels.add(e.id):r.volumeLabels.delete(e.id)}function Vt(t){return pn(t.notes.slice())}function hn(t,e,o){if(e<0||e>=t.length)return!1;const a=t[e],i=e>0?t[e-1].volume??B:B,n=a.volume??B;return(o?.has(a.id)??!1)||n!==i}function gn(t,e,o){const a=Vt(t),i=a.findIndex(s=>s.id===e.id);if(i<0)return;let n=a.length;for(let s=i+1;s<a.length;s++)if(hn(a,s,r.volumeLabels)){n=s;break}for(let s=i;s<n;s++)a[s].volume=gt(o)}function ko(t,e,o){const a=Vt(t),i=new Map(a.map(d=>[d.id,d.volume??B])),n=a.map((d,c)=>({n:d,i:c})).filter(d=>e.has(d.n.id)).map(d=>d.i).sort((d,c)=>d-c);let s=0;for(;s<n.length;){const d=n[s];let c=s+1;for(;c<n.length&&n[c]===n[c-1]+1;)c++;const l=d,m=n[c-1],f=l>0?i.get(a[l-1].id)??B:B;for(let h=l;h<=m;h++)a[h].volume=gt(o);let p=m+1;for(;p<a.length&&e.has(a[p].id);)p++;p<a.length&&(a[p].volume=f),s=c}}function De(t){if(!r.volumeLabels)return;const e=Vt(t),o=new Set(e.map(i=>i.id));for(const i of Array.from(r.volumeLabels))o.has(i)&&r.volumeLabels.delete(i);let a=B;for(const i of e){const n=i.volume??B;n!==a&&r.volumeLabels.add(i.id),a=n}}function yo(){if(I)return;I=document.createElement("div"),I.style.position="fixed",I.style.zIndex="10000",I.style.background="#fff",I.style.border="1px solid #ccc",I.style.boxShadow="0 4px 12px rgba(0,0,0,0.15)",I.style.borderRadius="8px",I.style.padding="10px 12px",I.style.minWidth="220px",I.style.display="none",I.addEventListener("wheel",n=>n.stopPropagation(),{passive:!1});const t=document.createElement("div");t.style.marginBottom="8px",t.textContent=(v[b].volLabel||"볼륨")+" (0-15)",O=document.createElement("input"),O.type="range",O.min="0",O.max="15",O.step="1",O.value=String(B),O.style.width="100%";const e=document.createElement("div");e.style.fontSize="12px",e.style.color="#555",e.style.marginTop="6px";const o=()=>{e.textContent="V"+(O?.value??String(B))};O.addEventListener("input",o),o();const a=document.createElement("div");a.style.display="flex",a.style.gap="8px",a.style.marginTop="10px",Pt=document.createElement("button"),Pt.className="btn btn--primary btn--sm",Pt.textContent=v[b].volApplyRange||"변경",Ct=document.createElement("button"),Ct.className="btn btn--secondary btn--sm",Ct.textContent=v[b].volApplySelected||"선택한 노트만 변경",a.append(Pt,Ct),I.append(t,O,e,a),document.body.appendChild(I);const i=()=>{I&&(I.style.display="none"),pt=null};document.addEventListener("keydown",n=>{I&&I.style.display!=="none"&&n.key==="Escape"&&i()}),document.addEventListener("mousedown",n=>{!I||I.style.display==="none"||I.contains(n.target)||i()}),Pt.addEventListener("click",()=>{if(!pt||!O)return;const n=u.tracks.find(c=>c.id===r.activeTrackId);if(!n)return;const s=n.notes.find(c=>c.id===pt);if(!s)return;const d=gt(parseInt(O.value,10));gn(n,s,d),H(),et({track:n,recomputeLabels:!0}),I.style.display="none",pt=null}),Ct.addEventListener("click",()=>{if(!O)return;const n=u.tracks.find(d=>d.id===r.activeTrackId);if(!n)return;const s=gt(parseInt(O.value,10));ko(n,new Set(r.selected),s),H(),et({track:n,recomputeLabels:!0}),I.style.display="none",pt=null})}function He(){I&&I.style.display!=="none"&&(I.style.display="none",pt=null)}function vo(t,e,o){if(yo(),!I||!O)return;pt=t.id;const a=t.volume??B;O.value=String(a);const i=I.querySelector("div:nth-child(3)");i&&(i.textContent="V"+a),I.style.display="block";const n=I.getBoundingClientRect(),s=window.innerWidth,d=window.innerHeight;let c=e,l=o;c+n.width>s&&(c=Math.max(0,s-n.width-8)),l+n.height>d&&(l=Math.max(0,d-n.height-8)),I.style.left=`${c}px`,I.style.top=`${l}px`}function kn(t){const e=Math.floor($);if(t!==0){for(const o of u.tracks){for(const a of o.notes)(a.startTick>=e||a.startTick+a.durationTick>e)&&(a.startTick+=t);oe(o.notes)}u.maxEndTick+=Math.max(0,t),H(),ce(u.tracks),nt(),yt()}}function yn(t){const e=Math.floor($);if(t!==0){for(const o of u.tracks){const a=[];for(const i of o.notes){const n=i.startTick,s=i.startTick+i.durationTick;if(s<=e)a.push(i);else{if(n>=e&&n<e+t)continue;if(n>=e+t)a.push({...i,startTick:Math.max(e,n-t)});else if(n<e&&s>e){const d=e-n;d>0&&a.push({...i,durationTick:d})}}}oe(a),o.notes=a}u.maxEndTick=Math.max(0,u.maxEndTick-t),H(),ce(u.tracks),nt(),yt()}}function vn(){return u.timeSig.beatsPerBar}function bo(){try{u.selectedLength=r.selectedLength,u.playheadVisualMode=lt,u.tpqn=E,u.extendedUnitsEnabled=J,u.displayBeatsPerBar=F,u.tempoChanges&&Array.isArray(u.tempoChanges);const t={...u,tracks:u.tracks.map(e=>({id:e.id,notes:e.notes,name:e.name,instrument:e.instrument,optimizedMML:e.optimizedMML,order:e.order,mute:e.mute,solo:e.solo,color:e.color}))};return localStorage.setItem(dn,JSON.stringify(t)),!0}catch{return!1}}let ge=null;function nt(){ge&&window.clearTimeout(ge),ge=window.setTimeout(()=>{bo()},300)}function H(){dt.push(u),nt()}function re(t){const e=pe.get(t.id);e&&clearTimeout(e);const o=setTimeout(()=>{try{ze.postMessage({track:t,tpqn:u.tpqn??E})}catch{}pe.delete(t.id)},lo);pe.set(t.id,o)}function ce(t){for(const e of t)try{ze.postMessage({track:e,tpqn:u.tpqn??E})}catch{}}function et(t={}){const{track:e,recomputeLabels:o}=t;e&&(o&&De(e),re(e),mt()),yt()}function We(){const t=document.querySelector(".panel.canvas-wrap");t&&(t.style.height="")}function mt(){if(!fe)return;const t=u.tracks.find(o=>o.id===r.activeTrackId)||u.tracks[0];let e=t&&(t.optimizedMML?.trim?.()||t.mmlString?.trim?.())||"";e=e.replace(/[\r\n]+/g,""),fe.textContent=e,fe.title=e}function bn(t,e){const o=(e||"").replace(/[\r\n]+/g,"").trim();t.mmlString=o;try{let a=u.bpm;const i=o.match(/^t(\d+)/);i&&(a=parseInt(i[1],10)),t.notes=Wn("MML@"+o),u.tracks[0]===t&&(u.bpm=a),De(t),H(),re(t),nt(),yt()}catch{t.notes=[]}}function wo(){const t=u.tracks.filter(i=>i.solo),e=t.length>0?t:u.tracks.filter(i=>!i.mute),o=i=>Ae.includes(i)?i:Ne,a=[];for(const i of e){const n=o(i.instrument||"lute");for(const s of i.notes)a.push({startTick:s.startTick,durationTick:s.durationTick,pitch:s.pitch,trackId:i.id,instrumentKey:n,volume:s.volume})}return a}function Mo(){G(),xn(),Qe(),N&&new ResizeObserver(()=>{ut=-1,q()}).observe(N),((n,s="ghost")=>{n&&at(n,s,"sm")})(Ie,"secondary"),C.addEventListener("pointermove",n=>{fn(n)&&Tt(),Do(n)}),C.addEventListener("pointerdown",n=>{Tt(),n.preventDefault(),Ho(n)},{passive:!1}),window.addEventListener("pointerup",Xo),window.addEventListener("pointermove",Wo),window.addEventListener("pointermove",n=>{window.lastPointerX=n.clientX,window.lastPointerY=n.clientY}),window.addEventListener("keydown",So),window.addEventListener("keyup",Lo),window.addEventListener("wheel",Ao,{passive:!1}),window.addEventListener("contextmenu",n=>{n.preventDefault()},{passive:!1}),N.addEventListener("scroll",Co),X.addEventListener("click",n=>{Tt(),Kt(n)}),X.addEventListener("pointerdown",n=>{Tt(),n.preventDefault(),Vo(n)},{passive:!1}),X.addEventListener("contextmenu",n=>{n.preventDefault()}),window.addEventListener("pointermove",Uo),window.addEventListener("pointerup",Ko),Ee.addEventListener("click",In),Le.addEventListener("click",Ce),Se.addEventListener("click",Tn),tt?.addEventListener("input",()=>{const n=Math.max(16,Math.min(32,parseInt(tt.value,10)));if(n!==r.keyHeight){r.keyHeight=n;try{localStorage.setItem(mn,String(n))}catch{}xt&&(xt.textContent=String(n)),ut=-1,We(),q()}}),st&&st.addEventListener("click",()=>{lt=lt==="area"?"line":"area",st&&(st.textContent=lt==="area"?v[b].playheadAreaLabel:v[b].playheadLineLabel),A(),nt()}),Yt.addEventListener("click",xo),Gt.addEventListener("click",()=>{R||Fo()});let e=!1,o=0,a=0;Dt.addEventListener("pointerdown",n=>{e=!0,o=n.clientX,a=r.scrollX,Dt.setPointerCapture(n.pointerId)}),window.addEventListener("pointermove",n=>{if(!e||R)return;const s=n.clientX-o,d=vt(),c=Math.max(0,d-N.clientWidth),l=Math.max(1,At.clientWidth-Dt.clientWidth),m=c/l,f=a+s*m;r.scrollX=ie(f),A()}),window.addEventListener("pointerup",()=>{e=!1}),Wt.addEventListener("click",Ue),it&&(at(it,"secondary","md"),it.textContent=v[b].load||"Load",U(it,"tooltipLoad",v[b].tooltipLoad||"Load project"),it.addEventListener("click",()=>{try{const n=localStorage.getItem(dn);if(!n){alert(v[b].noSavedProject||"No saved project found");return}const s=JSON.parse(n);if(!s||!s.tracks){alert(v[b].invalidSavedProject||"Saved data is invalid");return}let d=Je(s);const c=!!d.extendedUnitsEnabled;rn(c);const l=c?ke:ye,m=d.tpqn||l;if(m!==l){const f=l/m;Pe(d,f)}d.tpqn=l,d.extendedUnitsEnabled=c,typeof d.selectedLength=="number"&&(r.selectedLength=d.selectedLength),(d.playheadVisualMode==="area"||d.playheadVisualMode==="line")&&(lt=d.playheadVisualMode),d=Je(d),u=d,r.selected.clear();try{r.volumeLabels?.clear()}catch{}for(const f of u.tracks)De(f);mt(),G(),q(),alert(v[b].loadedFromLocal||"Loaded from local storage")}catch{alert(v[b].loadFailed||"Load failed")}}));const i=n=>{_n(n),Sn(),st&&(st.textContent=lt==="area"?v[b].playheadAreaLabel:v[b].playheadLineLabel),ft&&(ft.textContent=v[b].trackMMLLabel||(n==="ja"?"トラックMML":n==="en"?"Track MML":"트랙MML")),it&&(it.textContent=v[b].load||(n==="ja"?"読み込み":n==="en"?"Load":"불러오기"),U(it,"tooltipLoad",v[b].tooltipLoad||it.title||"Load project")),tt&&(tt.title=v[b].tooltipKeyHeight||tt.title),xt&&(xt.textContent=String(r.keyHeight));try{const s=document.getElementById("langKo"),d=document.getElementById("langJa"),c=document.getElementById("langEn");s?.setAttribute("role","radio"),d?.setAttribute("role","radio"),c?.setAttribute("role","radio"),s?.setAttribute("aria-checked",String(n==="ko")),d?.setAttribute("aria-checked",String(n==="ja")),c?.setAttribute("aria-checked",String(n==="en"))}catch{}G(),mt()};jt.addEventListener("click",()=>i("ko")),Jt.addEventListener("click",()=>i("ja")),Qt.addEventListener("click",()=>i("en")),Wt.addEventListener("click",Ue),Ht&&Ht.addEventListener("click",()=>{Eo(u.bpm,n=>{Number.isFinite(n)&&(n=Math.max(20,Math.min(Me,Math.round(n))),n!==u.bpm&&(u.bpm=n,H(),Qe(),ce(u.tracks),yt()))})})}function xo(){const t=u.tracks.slice().sort((e,o)=>e.order-o.order);for(const e of t)!(Array.isArray(e.notes)&&e.notes.length>0)||(Dn(e.notes??[])||sn(e.notes??[]));Xn(u)}function Qe(){Ht&&(Ht.textContent=`BPM: ${Math.round(u.bpm)}`,Ht.title=(v[b].tempoModalTitle||"템포 설정")+` (${u.bpm})`)}function ae(t){const e=C.getBoundingClientRect(),o=t.clientX-e.left+r.scrollX,a=t.clientY-e.top;return{x:o,y:a}}function To(t){const e=X.getBoundingClientRect();return{x:t.clientX-e.left+r.scrollX}}function Eo(t,e){const o=document.createElement("div");o.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:1000;display:flex;align-items:center;justify-content:center;";const a=document.createElement("div");a.style.cssText="background:#fff;border-radius:8px;padding:16px;min-width:260px;box-shadow:0 10px 24px rgba(0,0,0,0.25);display:flex;flex-direction:column;gap:12px;";const i=document.createElement("div");i.textContent=v[b].tempoModalTitle||"템포 설정";const n=document.createElement("input");n.type="number",n.min="20",n.max=String(Me),n.step="1",n.value=String(t),n.style.cssText="font-size:16px;padding:8px;";const s=document.createElement("div");s.style.cssText="display:flex;gap:8px;justify-content:flex-end;";const d=document.createElement("button");d.textContent=v[b].cancel||"취소";const c=document.createElement("button");c.textContent=v[b].ok||"확인",c.style.cssText="background:#3a7afe;color:#fff;border:0;border-radius:6px;padding:6px 12px;",s.append(d,c),a.append(i,n,s),o.appendChild(a),document.body.appendChild(o);const l=()=>{o.parentNode&&document.body.removeChild(o)};d.onclick=l,c.onclick=()=>{const m=Math.max(20,Math.min(Me,Math.round(Number(n.value||t))));Number.isFinite(m)&&e(m),l()},n.addEventListener("keydown",m=>{m.key==="Enter"&&c.click(),m.key==="Escape"&&l()}),setTimeout(()=>n.focus(),0)}X.addEventListener("contextmenu",t=>{t.preventDefault()},{passive:!1});function Lo(t){t.key==="Alt"&&(Re=!1,q())}function So(t){He();const e=document.activeElement;if(e&&(e.tagName==="INPUT"||e.tagName==="TEXTAREA"||e.tagName==="SELECT"||e.isContentEditable))return;t.key==="Alt"&&(t.preventDefault(),Re=!0,q());for(let n=1;n<=9;n++)t.key===n.toString()&&en(n-1);if(t.key==="0"&&en(Et.length-1),R){t.code==="Space"&&(t.preventDefault(),Ce());return}if((t.key==="ArrowUp"||t.key==="ArrowDown")&&t.shiftKey){const n=document.activeElement;if(n&&(n.tagName==="INPUT"||n.tagName==="SELECT"))return;t.preventDefault();const s=u.tracks.find(p=>p.id===r.activeTrackId);if(!s)return;const d=s.notes.filter(p=>r.selected.has(p.id));if(d.length===0)return;const c=p=>Math.floor(Oe(p)/12),l=Math.min(...d.map(p=>c(p.pitch))),m=Math.max(...d.map(p=>c(p.pitch)));if(t.key==="ArrowUp"&&m>=7||t.key==="ArrowDown"&&l<=1)return;const f=t.key==="ArrowUp"?12:-12;for(const p of s.notes)r.selected.has(p.id)&&(p.pitch=Oe(p.pitch+f));H(),et({track:s,recomputeLabels:!0});return}if((t.key==="ArrowUp"||t.key==="ArrowDown")&&!t.shiftKey&&!t.ctrlKey&&!t.metaKey&&!t.altKey){const n=document.activeElement;if(n&&(n.tagName==="INPUT"||n.tagName==="SELECT"))return;t.preventDefault();const s=u.tracks.slice().sort((m,f)=>m.order-f.order),d=s.findIndex(m=>m.id===r.activeTrackId);if(d===-1)return;const c=t.key==="ArrowUp"?-1:1,l=Math.max(0,Math.min(s.length-1,d+c));l!==d&&(r.activeTrackId=s[l].id,G(),q(),mt());return}const o=t.ctrlKey||t.metaKey;if(o&&t.key.toLowerCase()==="z"){t.preventDefault();const n=dt.undo(u);n&&(u=n,typeof u.displayBeatsPerBar=="number"&&(F=u.displayBeatsPerBar,W&&W.value!==String(F)&&(W.value=String(F))),r.selected.clear(),q(),G());return}if(o&&t.key.toLowerCase()==="y"){t.preventDefault();const n=dt.redo(u);n&&(u=n,typeof u.displayBeatsPerBar=="number"&&(F=u.displayBeatsPerBar,W&&W.value!==String(F)&&(W.value=String(F))),r.selected.clear(),q(),G());return}if(o&&t.key.toLowerCase()==="a"){t.preventDefault(),Io();return}if(t.key==="Escape"){r.selected.clear(),r.marquee.active=!1,r.drag=null,r.ghost=null,q();return}if(t.key==="Delete"){wn();return}if(o&&t.key.toLowerCase()==="c"){t.preventDefault(),Mn();return}if(o&&t.key.toLowerCase()==="v"){t.preventDefault(),Po();return}if(o&&t.key.toLowerCase()==="x"){t.preventDefault(),Bo();return}if(t.code==="Space"){t.preventDefault(),R?Ce():In();return}const a=_[u.zoomLevel-1],i=u.timeSig.beatsPerBar*a;if(t.key==="PageDown"){t.preventDefault(),r.scrollX=Math.max(0,Math.ceil((r.scrollX+1)/i)*i),A();return}if(t.key==="PageUp"){t.preventDefault(),r.scrollX=Math.max(0,Math.floor((r.scrollX-1)/i)*i),A();return}if(t.key==="Home"){t.preventDefault(),r.scrollX=0,A();return}if(t.key==="End"){t.preventDefault();const n=vt();r.scrollX=ie(Math.max(0,n-N.clientWidth)),A();return}}function Io(){r.selected.clear();const t=u.tracks.find(e=>e.id===r.activeTrackId);for(const e of t.notes)r.selected.add(e.id);q()}function wn(){if(r.selected.size===0)return;const t=u.tracks.find(e=>e.id===r.activeTrackId);t.notes=t.notes.filter(e=>!r.selected.has(e.id)),r.selected.clear(),H(),et({track:t})}function Mn(){const e=u.tracks.find(a=>a.id===r.activeTrackId).notes.filter(a=>r.selected.has(a.id));if(e.length===0)return;const o=Math.min(...e.map(a=>a.startTick));r.clipboard=e.map(a=>({...a,startTick:a.startTick-o}))}function Bo(){Mn(),wn()}function Po(){if(!r.clipboard||r.clipboard.length===0)return;const t=Math.max(0,Math.floor($)),e=u.tracks.find(o=>o.id===r.activeTrackId);e&&be(async()=>{const{insertNoteWithOverlap:o,ensureBars:a}=await import("./languages-BPqcXAKa.js").then(i=>i.J);return{insertNoteWithOverlap:o,ensureBars:a}},[],import.meta.url).then(({insertNoteWithOverlap:o,ensureBars:a})=>{if(r.selected.clear(),r.clipboard!=null)for(const i of r.clipboard){const n=crypto.randomUUID(),s={...i,id:n,startTick:Math.max(0,t+i.startTick)};o(u,e.id,s),a(u,s.startTick+s.durationTick),r.selected.add(n)}H(),et({track:e})})}function Co(){const e=-N.scrollTop+r.keyHeight;j.style.transform=`translateY(${e}px)`}function Ao(t){if(fn(t)&&Tt(),He(),t.ctrlKey){t.preventDefault(),No(t);return}if(t.altKey&&t.shiftKey&&r.selected.size>0&&!R){t.preventDefault();const e=t.deltaY>0?-1:1,o=u.tracks.find(l=>l.id===r.activeTrackId),a=Vt(o),i=new Map(a.map(l=>[l.id,l.volume??B])),n=new Set([...r.selected]),s=a.map((l,m)=>({n:l,i:m})).filter(l=>n.has(l.n.id)).map(l=>l.i).sort((l,m)=>l-m),d=new Map;for(const l of s){const m=a[l].id,f=i.get(m)??B;d.set(l,gt(f+e))}let c=0;for(;c<s.length;){const l=s[c],m=d.get(l);let f=c+1;for(;f<s.length&&s[f]===s[f-1]+1&&d.get(s[f])===m;)f++;const p=l,h=s[f-1],g=p>0?i.get(a[p-1].id)??B:B;for(let y=p;y<=h;y++)a[y].volume=gt(d.get(y));let k=h+1;for(;k<a.length&&n.has(a[k].id);)k++;k<a.length&&(a[k].volume=g,go(o,a[k])),c=f}et({track:o,recomputeLabels:!0}),H();return}if(t.altKey&&!t.shiftKey&&r.selected.size>0&&!R){t.preventDefault();const e=t.deltaY>0?-1:1,o=u.tracks.find(i=>i.id===r.activeTrackId),a=o.notes.filter(i=>r.selected.has(i.id));if(a.length>0){const i=a.reduce((d,c)=>c.startTick<d.startTick?c:d),n=i.volume??B,s=gt(n+e);gn(o,i,s)}et({track:o,recomputeLabels:!0}),H();return}if(t.shiftKey){t.preventDefault();const e=_[u.zoomLevel-1],o=u.timeSig.beatsPerBar*e,i=(Math.abs(t.deltaX)>Math.abs(t.deltaY)?t.deltaX:t.deltaY)>0?1:-1,n=vt(),s=Math.max(0,n-N.clientWidth);let d=Math.max(0,Math.min(s,r.scrollX+i*o));if(R){const c=$/E*e,l=N.clientWidth,m=Math.max(0,Math.min(s,Math.floor(c-l))),f=Math.max(0,Math.min(s,Math.floor(c)));d=Math.max(m,Math.min(f,d));let p=ie(d);const h=Math.max(0,Math.min(s,Math.ceil(m/o)*o)),g=Math.max(0,Math.min(s,Math.floor(f/o)*o));h<=g?((p<h||p>g)&&(p=i>0?g:h),d=p):d=r.scrollX}r.scrollX=ie(d),A();return}}function No(t){const e=t.deltaY>0?-1:1,o=Math.max(1,Math.min(9,u.zoomLevel+e));if(o===u.zoomLevel)return;const a=_[u.zoomLevel-1],i=N.getBoundingClientRect(),n=Math.max(0,Math.min(t.clientX-i.left,i.width)),s=r.scrollX+n,d=a*u.timeSig.beatsPerBar,l=Math.max(0,Math.round(s/d)*d)/a*E;u.zoomLevel=o;const m=_[o-1],f=l/E*m,p=vt(),h=Math.max(0,p-N.clientWidth);r.scrollX=Math.max(0,Math.min(h,f-n));const g=m*u.timeSig.beatsPerBar;r.scrollX=Math.max(0,Math.min(h,Math.floor(r.scrollX/g)*g)),ut=-1,q()}function G(){mt();const t=ve;Ye.innerHTML="",u.tracks.slice().sort((o,a)=>o.order-a.order).forEach((o,a)=>{o.color=t[a%t.length],(!o.instrument||!Ae.includes(o.instrument))&&(o.instrument=Ne);const i=document.createElement("div");i.dataset.trackId=String(o.id),i.dataset.order=String(o.order);const n=o.id===r.activeTrackId;i.className="track-card",n&&i.classList.add("is-active");const s=document.createElement("div");s.className="track-color",s.style.cssText=`
            background: ${o.color};
        `;const d=document.createElement("div");d.className="track-main";const c=document.createElement("div");c.className="track-row track-row--top";const l=document.createElement("input");l.value=o.name,l.setAttribute("data-i18n-title","tooltipTrackName"),l.title=v[b].tooltipTrackName,c.style.width="100%",l.classList.add("track-name-input"),Vn(l,{size:"sm"}),l.addEventListener("change",()=>{dt.push(u),o.name=l.value});const m=document.createElement("div");if(m.className="track-name",m.appendChild(l),c.appendChild(m),n){const h=document.createElement("div");h.className="track-reorder",h.style.marginLeft="auto",h.style.display="inline-flex",h.style.gap="6px";const g=document.createElement("button");g.type="button",g.textContent="▲",g.title="Move up",g.setAttribute("aria-label","Move track up"),g.style.width="24px",g.style.height="24px",g.style.fontSize="12px";const k=document.createElement("button");k.type="button",k.textContent="▼",k.title="Move down",k.setAttribute("aria-label","Move track down"),k.style.width="24px",k.style.height="24px",k.style.fontSize="12px";const y=u.tracks.length-1;g.disabled=o.order===0,k.disabled=o.order===y,g.addEventListener("click",M=>{M.stopPropagation(),Ze(-1)}),k.addEventListener("click",M=>{M.stopPropagation(),Ze(1)}),h.append(g,k),c.appendChild(h)}{const h=document.createElement("div");h.className="track-row track-row--middle",h.style.width="100%";const g=Pn(),k=On({items:g,value:o.instrument,size:"sm",fullWidth:!0,onChange:x=>{dt.push(u),o.instrument=x}});k.el.setAttribute("data-i18n-title","tooltipInstrument"),k.el.title=v[b].tooltipInstrument;const y=document.createElement("div");y.className="track-instrument",y.appendChild(k.el),h.appendChild(y);const M=document.createElement("div");M.className="track-row track-row--bottom";const w=Ro(o),L=document.createElement("span");L.className="track-charcount";const S=o.optimizedMML?.length||0,z=v[b].charUnit;L.textContent=`${S}${z}`,L.setAttribute("data-i18n-title","tooltipCharCount"),L.title=v[b].tooltipCharCount,M.append(w,L),d.append(c,h,M)}const f=[l];{const h=d.querySelector(".dropdown");h instanceof HTMLElement&&f.push(h),d.querySelectorAll(".track-controls button").forEach(k=>f.push(k))}c.querySelectorAll(".track-reorder button").forEach(h=>f.push(h)),f.forEach(h=>{h.addEventListener("mousedown",g=>g.stopPropagation()),h.addEventListener("mouseup",g=>g.stopPropagation())}),i.addEventListener("click",h=>{const g=h.target.tagName;g==="INPUT"||g==="SELECT"||g==="BUTTON"||h.target.isContentEditable||r.activeTrackId!==o.id&&(r.activeTrackId=o.id,G(),q())}),i.append(s,d),Ye.appendChild(i)})}function Ze(t){const e=u.tracks.find(s=>s.id===r.activeTrackId);if(!e)return;const o=e.order,a=u.tracks.length-1,i=o+t;if(i<0||i>a)return;const n=u.tracks.find(s=>s.order===i);n&&(e.order=i,n.order=o),H(),G(),nt()}function xn(){Rt.innerHTML="",se(),Et.forEach(t=>{const e=ee({label:String(t),size:"sm",variant:t===r.selectedLength?"primary":"secondary"});t===r.selectedLength&&e.classList.add("active"),e.setAttribute("data-i18n-title","tooltipLength"),t===64?e.title=(v[b].tooltipLength||"Length")+" - 0 (주의: 인게임에서 박자가 어긋날 수 있음)":e.title=v[b].tooltipLength,e.addEventListener("click",()=>{Xe(t)}),t===48&&(e.style.marginRight="12px"),Rt.appendChild(e)}),D.textContent=J?v[b].extendedLessLabel||"더 적은 단위":v[b].extendedMoreLabel||"더 많은 단위",D.title=J?v[b].tooltipExtendedLess||"기본 단위로 돌아가기":v[b].tooltipExtendedMore||"더 많은 단위 사용 (64/128/5/7/11)",D.setAttribute("data-i18n",J?"extendedLessLabel":"extendedMoreLabel"),U(D,J?"tooltipExtendedLess":"tooltipExtendedMore",D.title),D.setAttribute("aria-label",D.title),D.addEventListener("click",_o),Rt.appendChild(D)}function _o(){if(!J){const e="mml_editor_warn_extended_shown";let o=!1;try{o=localStorage.getItem(e)==="1"}catch{}if(!o){if(!window.confirm(v[b].confirmEnableExtendedUnits||"Enable more units to use 64/128/5/7/11; existing ticks will be converted. Continue?"))return;try{localStorage.setItem(e,"1")}catch{}}tn(!0)}else tn(!1)}function tn(t){H();const a=(t?ke:ye)/(t?ye:ke);Pe(u,a),rn(t),u.tpqn=E,u.extendedUnitsEnabled=t;try{dt.transformSnapshots?.(i=>Pe(i,a))}catch{}zo(),xn(),q()}function zo(){if(!Et.includes(r.selectedLength)){let t=Et[0],e=Math.abs(t-r.selectedLength);for(const o of Et){const a=Math.abs(o-r.selectedLength);a<e&&(t=o,e=a)}Xe(t)}}function Pe(t,e){if(!(!Number.isFinite(e)||e<=0)){for(const o of t.tracks)for(const a of o.notes)a.startTick=Math.round(a.startTick*e),a.durationTick=Math.max(1,Math.round(a.durationTick*e));t.maxEndTick=Math.round(t.maxEndTick*e)}}function Xe(t){if(!Rt)return;r.selectedLength=t;const e=Array.from(Rt.children);e.forEach(o=>o.classList.remove("active")),e.forEach(o=>{if(o instanceof HTMLButtonElement){const i=parseInt(o.textContent||"0",10)===t;i&&o.classList.add("active"),o.classList.remove("btn--primary","btn--secondary"),o.classList.add(i?"btn--primary":"btn--secondary")}}),q(),nt()}function Ro(t){const e=document.createElement("div");e.className="track-controls";const o=(n,s,d)=>{const c=document.createElement("button");return c.textContent=n,c.style.cssText=`
            width: 24px;
            height: 24px;
            font-size: 12px;
            font-weight: bold;
            border-radius: 4px;
            border: 1px solid #ccc;
            cursor: pointer;
            background-color: ${s?d:"#fff"};
            color: ${s?"#fff":"#000"};
        `,c},a=o("M",t.mute,"#f44336");a.setAttribute("data-i18n-title","tooltipMute"),a.title=v[b].tooltipMute,a.addEventListener("click",()=>{t.mute=!t.mute,H(),G()});const i=o("S",t.solo,"#ff9800");return i.setAttribute("data-i18n-title","tooltipSolo"),i.title=v[b].tooltipSolo,i.addEventListener("click",()=>{t.solo=!t.solo,H(),G()}),e.append(a,i),e}function en(t){const e=Et[t];typeof e=="number"&&Xe(e)}function Do(t){if(R){r.hover.noteId=null,r.hover.edge=null,C.style.cursor="not-allowed";return}const{x:e,y:o}=ae(t),a=_[u.zoomLevel-1],i=u.tracks.find(n=>n.id===r.activeTrackId);if(!r.drag&&!r.marquee.active){const n=xe(e,o,i.notes,a,r.keyHeight);n?(r.hover.noteId=n.note.id,r.hover.edge=n.edge,C.style.cursor=n.edge==="center"?"move":"ew-resize"):(r.hover.noteId=null,r.hover.edge=null,C.style.cursor="default"),A();return}if(r.marquee.active){r.marquee.x1=e,r.marquee.y1=o;const n=t.ctrlKey||t.metaKey,s=t.shiftKey;r.marquee.mode=n?"toggle":s?"add":"replace";const d=ro(r.marquee.x0,r.marquee.y0,r.marquee.x1,r.marquee.y1,i.notes,a,r.keyHeight),c=new Set(r.selected);if(r.marquee.mode==="replace"){r.selected.clear();for(const l of d)r.selected.add(l.id)}else if(r.marquee.mode==="add")for(const l of d)r.selected.add(l.id);else{r.selected=c;for(const l of d)r.selected.has(l.id)?r.selected.delete(l.id):r.selected.add(l.id)}A()}}function Ho(t){if(Tt(),on(),R){t.preventDefault(),C.style.cursor="not-allowed";return}if(He(),t.button===1){t.preventDefault(),kt=!0,Kt(t);return}if(t.button===2){t.preventDefault();const{x:f,y:p}=ae(t),h=_[u.zoomLevel-1],g=u.tracks.find(y=>y.id===r.activeTrackId),k=xe(f,p,g.notes,h,r.keyHeight);if(k)r.selected.has(k.note.id)||(r.selected.clear(),r.selected.add(k.note.id),A()),vo(k.note,t.clientX,t.clientY);else{const y=t.ctrlKey||t.metaKey,M=t.shiftKey;r.drag=null,r.ghost=null,r.marquee.active=!0,r.marquee.x0=f,r.marquee.y0=p,r.marquee.x1=f,r.marquee.y1=p,r.marquee.mode=y?"toggle":M?"add":"replace",A()}return}if(t.button!==0)return;const{x:e,y:o}=ae(t),a=_[u.zoomLevel-1],i=u.tracks.find(f=>f.id===r.activeTrackId),n=xe(e,o,i.notes,a,r.keyHeight);if(!n){const f=ht(r.selectedLength),p=e/a*E,h=Cn(p,f),g=Ot(95-Math.floor(o/r.keyHeight)),k=ht(r.selectedLength),y=crypto.randomUUID();r.drag={kind:"create",trackId:r.activeTrackId,noteId:y,startTick:h,durationTick:k,pitch:g},r.ghost={startTick:h,durationTick:k,pitch:g,color:ot};const M=u.tracks.find(w=>w.id===r.activeTrackId);M&&Zt(g,M.id,M.instrument,rt),A();return}const s=n.note,d=t.ctrlKey||t.metaKey,c=r.selected.has(s.id);d?c||r.selected.add(s.id):c||(r.selected.clear(),r.selected.add(s.id));{const f=u.tracks.find(p=>p.id===r.activeTrackId);f&&Zt(s.pitch,f.id,f.instrument,rt)}const l=s.startTick,m=s.startTick+s.durationTick;if(n.edge==="center"){const f=Array.from(r.selected),p=u.tracks.find(g=>g.id===i.id).notes.filter(g=>r.selected.has(g.id)).map(g=>({id:g.id,startTick:g.startTick,pitch:g.pitch,durationTick:g.durationTick,volume:g.volume})),h=ht(r.selectedLength);Xt=0,qt=0,r.moveGroup={trackId:i.id,ids:f,base:p,mouseStartX:e,mouseStartY:o,grid:h},r.drag={kind:"move",trackId:i.id,noteId:s.id,startTick0:l,yPitch0:s.pitch,mouseStartX:e,mouseStartY:o},r.ghost={startTick:s.startTick,durationTick:s.durationTick,pitch:s.pitch,color:ot},A();return}else n.edge==="left"?(r.drag={kind:"resize-left",trackId:i.id,noteId:s.id,startTick0:l,endTick0:m,mouseStartX:e},r.ghost={startTick:s.startTick,durationTick:s.durationTick,pitch:s.pitch,color:ot}):n.edge==="right"&&(r.drag={kind:"resize-right",trackId:i.id,noteId:s.id,startTick0:l,endTick0:m,mouseStartX:e},r.ghost={startTick:s.startTick,durationTick:s.durationTick,pitch:s.pitch,color:ot});A()}function Wo(t){if(R)return;if(kt){Kt(t);return}if(r.marquee.active||!r.drag)return;const{x:e,y:o}=ae(t),a=_[u.zoomLevel-1],i=ht(r.selectedLength);if(r.drag.kind==="move"||r.drag.kind==="resize-left"||r.drag.kind==="resize-right"){if(r.drag.kind==="move"){const l=document.elementFromPoint(t.clientX,t.clientY)?.closest?.(".track-card");document.querySelectorAll(".track-card.drop-hover").forEach(m=>m.classList.remove("drop-hover")),l&&parseInt(l.dataset.trackId||"-1",10)!==r.drag.trackId&&l.classList.add("drop-hover")}const n=u.tracks.find(c=>r.drag!=null&&c.id===r.drag.trackId),s=n.notes.findIndex(c=>r.drag!=null&&c.id===r.drag.noteId);if(s<0)return;const d=n.notes[s];if(r.drag.kind==="move"){const c=r.moveGroup;if(!c)return;const l=(e-c.mouseStartX)/a,m=Math.floor((c.mouseStartY-o)/r.keyHeight),f=l*E,p=Math.round(f/c.grid)*c.grid;Xt=p,qt=m;const h=Ot(r.drag.yPitch0+m),g=u.tracks.find(w=>w.id===r.activeTrackId);g&&Zt(h,g.id,g.instrument,rt),A();const k=a,y=r.scrollX,M=window.devicePixelRatio||1;Z.save(),Z.setTransform(M,0,0,M,0,0),Z.globalAlpha=.7,Z.fillStyle=ot;for(const w of c.base){const L=Math.max(0,w.startTick+p),S=Math.round(L/E*k)-Math.floor(y)+.5,z=Math.max(1,Math.round(w.durationTick/E*k)),T=(95-Ot(w.pitch+m))*r.keyHeight+.5,P=r.keyHeight-1;Z.fillRect(S,T,z,P)}Z.globalAlpha=1,Z.restore();return}if(r.drag.kind==="resize-left"){const c=(e-r.drag.mouseStartX)/a;let l=r.drag.startTick0+c*E,m=Math.max(0,Math.floor(l/i)*i);m=Math.min(m,r.drag.endTick0-i);const f=r.drag.endTick0-m;r.ghost={startTick:m,durationTick:f,pitch:d.pitch,color:ot};const p=r.drag.endTick0-r.drag.startTick0,h=Math.max(0,p-f),g=ht(32),k=u.tracks.find(w=>w.id===r.drag.trackId),y=new Set(r.selected),M=[];if(h>0)for(const w of k.notes){if(w.id===r.drag.noteId||!y.has(w.id))continue;const L=Math.max(g,w.durationTick-h);M.push({startTick:w.startTick,durationTick:L,pitch:w.pitch,color:ot})}r.ghostGroup=M.length?M:null,A();return}if(r.drag.kind==="resize-right"){const c=(e-r.drag.mouseStartX)/a;let l=r.drag.endTick0+c*E,m=Math.max(r.drag.startTick0+i,Math.ceil(l/i)*i);const f=u.tracks.find(S=>S.id===r.drag.trackId),p=r.drag.startTick0,h=f.notes.filter(S=>S.startTick>p).sort((S,z)=>S.startTick-z.startTick)[0];h&&(m=Math.min(m,h.startTick));const g=m-r.drag.startTick0;r.ghost={startTick:r.drag.startTick0,durationTick:g,pitch:d.pitch,color:ot};const k=r.drag.endTick0-r.drag.startTick0,y=Math.max(0,g-k),M=u.tracks.find(S=>S.id===r.drag.trackId),w=new Set(r.selected),L=[];if(y>0)for(const S of M.notes){if(S.id===r.drag.noteId||!w.has(S.id))continue;const z=M.notes.filter(Y=>Y.startTick>S.startTick).sort((Y,K)=>Y.startTick-K.startTick)[0];let x=Number.POSITIVE_INFINITY;z&&(x=Math.max(0,z.startTick-(S.startTick+S.durationTick)));const T=Math.max(0,Math.min(y,x)),P=S.durationTick+T;L.push({startTick:S.startTick,durationTick:P,pitch:S.pitch,color:ot})}r.ghostGroup=L.length?L:null,A();return}}if(r.drag.kind==="create"){const n=r.drag.startTick,s=(e-n/E*a)/a,d=n+Math.max(i,Math.round(s*E)),l=Math.max(n+i,Math.ceil(d/i)*i)-n,m=Ot(95-Math.floor(o/r.keyHeight));r.ghost={startTick:n,durationTick:l,pitch:m,color:ot};const f=u.tracks.find(p=>p.id===r.activeTrackId);f&&Zt(m,f.id,f.instrument,rt),A()}}function Xo(){if(R)return;if(kt){kt=!1;return}rt.sampler&&rt.pitch!==null&&(Rn(rt.sampler,rt.pitch),rt.pitch=null,rt.sampler=null);const t=document.activeElement;if(t&&(t.tagName==="INPUT"||t.tagName==="SELECT"||t.isContentEditable))return;if(r.marquee.active){r.marquee.active=!1,A();return}if(!r.drag)return;if(r.drag.kind==="move"&&r.moveGroup){const s=document.elementFromPoint(window.lastPointerX??0,window.lastPointerY??0)?.closest?.(".track-card");if(s){const l=parseInt(s.dataset.trackId||"-1",10),m=r.moveGroup.trackId;if(!Number.isNaN(l)&&l>0&&l!==m){const f=u.tracks.find(k=>k.id===m),p=u.tracks.find(k=>k.id===l),h=new Set(r.moveGroup.ids),g=f.notes.filter(k=>h.has(k.id));if(g.length>0){const k=Math.min(...g.map(w=>w.startTick)),y=Math.max(...g.map(w=>w.startTick+w.durationTick)),M=p.notes.filter(w=>w.startTick<y&&w.startTick+w.durationTick>k);f.notes=f.notes.filter(w=>!h.has(w.id)).concat(M),p.notes=p.notes.filter(w=>!M.includes(w)).concat(g),oe(f.notes),oe(p.notes),r.selected.clear();for(const w of g)r.selected.add(w.id);r.moveGroup=null,r.drag=null,r.ghost=null,et({track:f}),et({track:p}),H(),G();return}}}const d=r.moveGroup;if(Xt===0&&qt===0){r.moveGroup=null,r.drag=null,r.ghost=null;return}const c=u.tracks.find(l=>l.id===d.trackId);c.notes=c.notes.filter(l=>!d.ids.includes(l.id)),be(async()=>{const{insertNoteWithOverlap:l,ensureBars:m}=await import("./languages-BPqcXAKa.js").then(f=>f.J);return{insertNoteWithOverlap:l,ensureBars:m}},[],import.meta.url).then(({insertNoteWithOverlap:l,ensureBars:m})=>{r.selected.clear();for(const f of d.base){const p={id:f.id,startTick:Math.max(0,f.startTick+Xt),durationTick:f.durationTick,pitch:Ot(f.pitch+qt),velocity:100,volume:f.volume??B};l(u,d.trackId,p),m(u,p.startTick+p.durationTick),r.selected.add(p.id)}r.moveGroup=null,r.drag=null,r.ghost=null,Xt=0,qt=0,et({track:c}),H(),nt()});return}if(!r.ghost){r.drag=null,document.querySelectorAll(".track-card.drop-hover").forEach(s=>s.classList.remove("drop-hover"));return}const e=r.ghost,o=r.drag.trackId,a=u.tracks.find(s=>s.id===o);let i=B;if(a){const s=Vt(a);let d=B;for(let c=0;c<s.length;c++){const l=s[c];if(l.startTick>=e.startTick)break;const m=l.volume??B;hn(s,c,r.volumeLabels),d=m}i=d}const n={id:r.drag.noteId,startTick:e.startTick,durationTick:e.durationTick,pitch:e.pitch,velocity:100,volume:i};be(async()=>{const{insertNoteWithOverlap:s,ensureBars:d}=await import("./languages-BPqcXAKa.js").then(c=>c.J);return{insertNoteWithOverlap:s,ensureBars:d}},[],import.meta.url).then(({insertNoteWithOverlap:s,ensureBars:d})=>{const c=u.tracks.find(l=>l.id===o);if(r.drag.kind==="resize-left"||r.drag.kind==="resize-right"){const l=c.notes.findIndex(g=>g.id===r.drag.noteId);l>=0&&c.notes.splice(l,1);const m=r.drag.endTick0-r.drag.startTick0,f=e.durationTick,p=Math.max(0,m-f);if(p>0){const g=ht(32),k=new Set(r.selected);for(const y of c.notes)y.id!==r.drag.noteId&&k.has(y.id)&&(y.durationTick=Math.max(g,y.durationTick-p))}const h=Math.max(0,f-m);if(h>0){const g=new Set(r.selected);for(const k of c.notes){if(k.id===r.drag.noteId||!g.has(k.id))continue;const y=c.notes.filter(L=>L.startTick>k.startTick).sort((L,S)=>L.startTick-S.startTick)[0];let M=Number.POSITIVE_INFINITY;y&&(M=Math.max(0,y.startTick-(k.startTick+k.durationTick)));const w=Math.max(0,Math.min(h,M));w>0&&(k.durationTick+=w,d(u,k.startTick+k.durationTick))}}}s(u,o,n),d(u,n.startTick+n.durationTick),r.drag=null,r.ghost=null,r.ghostGroup=null,document.querySelectorAll(".track-card.drop-hover").forEach(l=>l.classList.remove("drop-hover")),et({track:c,recomputeLabels:!0}),H(),nt()})}function A(){qo(),r.isAltDown=Re;const t=_[u.zoomLevel-1],e=$/E*t,o=r.scrollX,a=N.clientWidth,i=o+a;N.clientHeight;const n=u.timeSig.beatsPerBar*t,s=(F||u.timeSig.beatsPerBar)*t,d=Math.floor(o/n),c=o-d*n,l=Math.floor(o/s),m=o-l*s;C.style.left=`${-c}px`,V&&(V.style.left=`${-m}px`),V&&ne&&ln(ne,V,u,r,F),Gn(Z,u,r,d*n,a+n);const f=e-o;if(R)if(lt==="area"){const g=_[u.zoomLevel-1],k=F||u.timeSig.beatsPerBar,y=g*k,w=Math.floor(e/y)*y-o;so(Z,C,w,y)}else $e(Z,C,f);else $e(Z,C,f);ao(un,j,r.keyHeight);const h=-N.scrollTop+r.keyHeight;if(j.style.transform=`translateY(${h}px)`,Oo(),R&&e>=i){const g=_[u.zoomLevel-1],k=u.timeSig.beatsPerBar*g,y=$/E*g,M=Math.floor(y/k)*k,w=vt(),L=Math.max(0,w-N.clientWidth);r.scrollX=Math.max(0,Math.min(L,M))}le(),Ln()}function qo(){const t=window.devicePixelRatio||1,e=_[u.zoomLevel-1],a=u.timeSig.beatsPerBar*e,i=(N.clientWidth||800)+a,n=84*r.keyHeight,s=n;C.style.width!==`${i}px`&&(C.style.width=`${i}px`),C.style.height!==`${s}px`&&(C.style.height=`${s}px`);const d=Math.max(1,Math.floor(i*t)),c=Math.max(1,Math.floor(s*t));if((C.width!==d||C.height!==c)&&(C.width=d,C.height=c),V&&ne){const k=(N.clientWidth||800)+a,y=n;V.style.width!==`${k}px`&&(V.style.width=`${k}px`),V.style.height!==`${y}px`&&(V.style.height=`${y}px`);const M=Math.max(1,Math.floor(k*t)),w=Math.max(1,Math.floor(y*t)),L=V.width!==M,S=V.height!==w;(L||S)&&(V.width=M,V.height=w),(L||S||ut!==u.zoomLevel)&&(ln(ne,V,u,r,F),ut=u.zoomLevel)}const l=84*r.keyHeight;(j.width!==Math.floor(48*t)||j.height!==Math.floor(l*t))&&(j.width=Math.floor(48*t),j.height=Math.floor(l*t),t!==1&&un.setTransform(t,0,0,t,0,0)),j.style.width!=="48px"&&(j.style.width="48px");const m=`${l}px`;j.style.height!==m&&(j.style.height=m);const f=r.keyHeight;Lt.style.height!==f+"px"&&(Lt.style.height=f+"px");const p=Lt.clientWidth||N.clientWidth||800,h=Math.max(1,Math.floor(p*t)),g=Math.max(1,Math.floor(f*t));(X.width!==h||X.height!==g)&&(X.width=h,X.height=g,t!==1&&Te.setTransform(t,0,0,t,0,0))}function Ce(){R=!1,te().stop(),an(),le(),Ln()}function Tn(){R=!1,te().stop(),te().position=0,an(),$=ho,le(),A()}function Oo(){const t=_[u.zoomLevel-1],e=F||u.timeSig.beatsPerBar,o=window.devicePixelRatio||1,a=r.keyHeight;Lt.style.height!==a+"px"&&(Lt.style.height=a+"px");const i=Lt.clientWidth||N.clientWidth||800,n=Math.max(1,Math.floor(i*o)),s=Math.max(1,Math.floor(a*o));X.width!==n&&(X.width=n),X.height!==s&&(X.height=s),o!==1&&Te.setTransform(o,0,0,o,0,0);const d=r.scrollX;io(Te,X,d,t,e,u)}function q(){ut=-1,A()}function En(){if(!R)return;const t=performance.now(),e=Math.max(0,t-Be);Be=t;const o=_e([],u.bpm);$=zn(o,$,e);const a=Ut();if($>=a){Tn();return}A(),requestAnimationFrame(En)}function Ut(){let t=0;for(const e of u.tracks)for(const o of e.notes){const a=o.startTick+o.durationTick;a>t&&(t=a)}return t}function le(){if(!Ge)return;const t=Ut(),e=Math.max(0,Math.floor($)),o=_e([],u.bpm),a=we(o,e),i=we(o,t);Ge.textContent=`${Ve(a)} / ${Ve(i)}`}function Vo(t){t.button!==2&&(R||(kt=!0,Kt(t)))}function Uo(t){kt&&Kt(t)}function Ko(){kt=!1}function Kt(t){const{x:e}=To(t),o=_[u.zoomLevel-1],a=e/o*E,i=ht(r.selectedLength);$=Math.max(0,Math.floor(a/i)*i),R&&(R=!1),A()}function Ln(){const t=vt(),e=t-N.clientWidth;if(e<=1){At.style.display="none";return}At.style.display="block";const o=Math.max(20,N.clientWidth/t*At.clientWidth);Dt.style.width=`${o}px`;const i=r.scrollX/e*(At.clientWidth-o);Dt.style.left=`${i}px`}function vt(){const t=_[u.zoomLevel-1],e=Math.ceil(Ut()/E);return Math.max(N.clientWidth,Math.ceil(e*t)+N.clientWidth)}function ie(t){const e=_[u.zoomLevel-1],o=u.timeSig.beatsPerBar*e,a=Math.round(t/o)*o;return Math.max(0,a)}function Sn(){const t=v[b];if(D&&(D.textContent=J?t.extendedLessLabel||"더 적은 단위":t.extendedMoreLabel||"더 많은 단위",D.title=J?t.tooltipExtendedLess||"기본 단위로 돌아가기":t.tooltipExtendedMore||"더 많은 단위 사용 (64/128/5/7/11)",D.setAttribute("data-i18n",J?"extendedLessLabel":"extendedMoreLabel"),D.setAttribute("data-i18n-title",J?"tooltipExtendedLess":"tooltipExtendedMore"),D.setAttribute("aria-label",D.title)),W){const e=t.tooltipDisplayTimeSig||"Display time signature (n/4)";W.title=e,W.setAttribute("data-i18n-title","tooltipDisplayTimeSig"),W.setAttribute("aria-label",e)}}at(D,"ghost","sm");if(W){const t=i=>Math.max(1,Math.min(16,Math.floor(i)));let e=null;try{const i=localStorage.getItem(je);if(i!=null){const n=Number(i);Number.isFinite(n)&&(e=t(n))}}catch{}const o=e??t(Number(u.displayBeatsPerBar)||Number(u.timeSig?.beatsPerBar)||4);F=o,u.displayBeatsPerBar=o,W.value!==String(o)&&(W.value=String(o));const a=()=>{const i=Number(W.value),n=Number.isFinite(i)?t(i):o;F=n,u.displayBeatsPerBar=n,W.value!==String(n)&&(W.value=String(n));try{localStorage.setItem(je,String(n))}catch{}ut=-1,H(),q()};W.addEventListener("change",a),W.addEventListener("input",a)}window.addEventListener("resize",()=>{We(),ut=-1,q()});setTimeout(We,0);se();cn();Ee&&U(Ee,"tooltipPlay",v[b].tooltipPlay);Le&&U(Le,"tooltipPause",v[b].tooltipPause);st&&(st.textContent=lt==="area"?v[b].playheadAreaLabel:v[b].playheadLineLabel,U(st,"tooltipPlayheadToggle",v[b].tooltipPlayheadToggle));Se&&U(Se,"tooltipStop",v[b].tooltipStop);Mt&&(at(Mt,"secondary","md"),Mt.setAttribute("data-i18n","edit"),U(Mt,"tooltipEditMML",v[b].tooltipEditMML));Yt&&(at(Yt,"secondary","md"),U(Yt,"tooltipConvert",v[b].tooltipConvert));Gt&&(at(Gt,"secondary","md"),U(Gt,"tooltipPaste",v[b].tooltipPaste));Wt&&(at(Wt,"ghost","md"),U(Wt,"tooltipGuide",v[b].tooltipGuide));if(tt){const t=(()=>{try{return localStorage.getItem(mn)}catch{return null}})(),e=Math.max(16,Math.min(32,t?parseInt(t,10):r.keyHeight));r.keyHeight=e,tt.value=String(e),xt&&(xt.textContent=String(e)),tt.min="16",tt.max="32",tt.step="1",U(tt,"tooltipKeyHeight",v[b].tooltipKeyHeight||"노트 높이 (16-32)")}jt&&(at(jt,"ghost","sm"),U(jt,"tooltipLangKo",v[b].tooltipLangKo));Jt&&(at(Jt,"ghost","sm"),U(Jt,"tooltipLangJa",v[b].tooltipLangJa));Qt&&(at(Qt,"ghost","sm"),U(Qt,"tooltipLangEn",v[b].tooltipLangEn));C&&(C.setAttribute("data-i18n-title","tooltipPianoRoll"),C.title=v[b].tooltipPianoRoll);X&&(X.setAttribute("data-i18n-title","tooltipRuler"),X.title=v[b].tooltipRuler);Mo();q();mt();try{dt.push(u)}catch{}Mt?Mt.onclick=()=>{const t=u.tracks.find(o=>o.id===r.activeTrackId);if(!t)return;let e=t.optimizedMML?.trim?.()||t.mmlString?.trim?.()||"";if(e=e.replace(/[\r\n]+/g,""),!e)try{e=(sn(t.notes??[])||"").trim().replace(/[\r\n]+/g,"")}catch{}Kn(t,o=>{bn(t,o),u.maxEndTick=Ut(),re(t);for(const a of u.tracks)a!==t&&re(a);nt(),mt(),G()},e)}:u=nn();Sn();D.id="btnToggleExtended";D.style.marginLeft="8px";D.textContent=J?v[b].extendedLessLabel||"더 적은 단위":v[b].extendedMoreLabel||"더 많은 단위";ze.onmessage=t=>{const{trackId:e,optimizedMML:o,originalBody:a}=t.data,i=u.tracks.find(n=>n.id===e);i&&(i.optimizedMML=o,i.originalBody=a??"",G(),mt(),yt())};uo?.addEventListener("click",()=>{kn(E)});mo?.addEventListener("click",()=>{const t=E*vn();kn(t)});fo?.addEventListener("click",()=>{yn(E)});po?.addEventListener("click",()=>{const t=E*vn();yn(t)});(function(){ft&&(ft.textContent=v[b].trackMMLLabel||"트랙MML",ft.setAttribute("data-i18n","trackMMLLabel"),ft.setAttribute("data-i18n-title","tooltipEditMML"),ft.title=v[b].tooltipEditMML)})();r.moveGroup=null;(function(){const e="2025-09-07-midtempo-warning",o="mml_editor_whatsnew_shown_"+e;let a=!1;try{a=localStorage.getItem(o)==="1"}catch{}a||setTimeout(()=>co(e),0)})();async function Fo(){try{dt.push(u);const t=await navigator.clipboard.readText();if(!t.trim().startsWith("MML@")){alert(v[b].invalid_mml_format||"MML 형식이 아닙니다.");return}let e=t.trim().substring(4);e=e.replace(/\r?\n/g,"").replace(/;+$/g,"");const o=e.split(",").map(i=>i.replace(/;+$/g,"").trim());if(o.length>6){alert("트랙은 최대 6개까지만 지원합니다.");return}try{if(o.length>0){const i=o[0],n=/^t(\d{1,3})(.*)$/.exec(i);if(n){const s=parseInt(n[1],10);s>=20&&s<=999&&(u.bpm=s),o[0]=n[2]}}}catch{}const a=[];for(let i=0;i<u.tracks.length;i++){const n=o[i]?o[i]:"",s=u.tracks[i],d=s.notes?.length||0;try{if(n&&n.length>0)try{s.optimizedMML=Hn(n,!0)||n}catch{s.optimizedMML=n}else s.optimizedMML="";bn(s,n),(s.notes?.length||0)>d&&a.push(s)}catch{alert(v[b].invalid_mml_format||"MML 형식이 아닙니다.");return}}u.maxEndTick=Ut(),a.length>0&&ce(a),G(),yt(),nt()}catch{}}async function In(){if(R)return;R=!0,await An();const t=wo();await Nn(t,u.bpm,{});const e=_e([],u.bpm);te().position=we(e,$),Be=performance.now();{const o=_[u.zoomLevel-1],a=u.timeSig.beatsPerBar*o,i=$/E*o,n=Math.floor(i/a)*a,s=vt(),d=Math.max(0,s-N.clientWidth);r.scrollX=Math.max(0,Math.min(d,n))}le?.(),En()}const qe=()=>{const t=window.visualViewport?window.visualViewport.height:window.innerHeight;document.documentElement.style.setProperty("--app-100dvh",t+"px")};qe();window.addEventListener("resize",qe);window.visualViewport?.addEventListener("resize",qe);
