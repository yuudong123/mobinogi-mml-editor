const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./tempoModal-CU1-jXle.js","./languages-Cgt_gsPd.js","./guideModal-DTHVvsmR.js","./button-WIurEURm.js","./converter-Bxff0mca.js","./convertModal-BoFIxvxa.js"])))=>i.map(i=>d[i]);
import{D as j,T as M,_ as T,x as O,y as U,p as K,w as X,S as W,l as D,m as C,n as S,u as Y,v as q,j as V,k as $,z as J,c as Q,i as Z,r as tt,I as et,A as it,t as N,H as st,a as ot,N as nt,e as rt}from"./languages-Cgt_gsPd.js";class L{static instance=null;static getInstance(){return this.instance||(this.instance=new L),this.instance}splitNotesAtTickAcrossTracks(t){if(!this.project)return;const e=Math.max(0,Math.floor(t));for(const i of this.project.tracks){const s=[];for(const o of i.notes){const r=o.startTick,n=o.startTick+o.durationTick;if(n<=e||r>=e){s.push(o);continue}const c=Math.max(1,e-r),a=Math.max(1,n-e),h={...o,durationTick:c},l={...o,id:globalThis.crypto?.randomUUID?.()||String(Date.now()+Math.random()),startTick:e,durationTick:a};l.__tiedFromPrev=!0,s.push(h,l)}s.sort((o,r)=>o.startTick-r.startTick||o.pitch-r.pitch),i.notes=s}}canvas=null;timeRulerCanvas=null;selectedTempoAnchorTick=null;isDraggingTempo=!1;draggingTempoIndex=-1;pendingTempoIndex=-1;pointerDownAt=null;playhead=null;project=null;currentTrack=null;pxPerBeat=96;minPxPerBeat=24;maxPxPerBeat=192;keyHeight=24;minKeyHeight=24;scrollX=0;scrollY=0;playheadTick=0;trailingBars=4;displayBeatsPerBar=4;editLeftGutter=44;minPitch=60;maxPitch=72;noteRange=13;isDragging=!1;lastX=0;isPinching=!1;initialPinchDistance=0;lastPxPerBeat=0;lastCenterX=0;lastCenterY=0;vScrollBarMargin=3;vScrollBarWidth=8;vScrollThumbMin=36;isVScrollDragging=!1;vScrollDragOffsetY=0;previewNotes=[];lastPlayed={pitch:null,sampler:null};volumeLabels=new Set;selection=new Set;selectingRect=null;isNoteCreationMode=!1;dragMode="none";dragStart={x:0,y:0};dragNoteAnchor=null;longPressTimer=null;tempNote=null;selectionAnchors=new Map;static GHOST_COLOR="rgba(255,215,0,0.8)";init(){this.canvas=document.getElementById("pianorollCanvas"),this.timeRulerCanvas=document.getElementById("timeRulerCanvas"),this.playhead=document.getElementById("playhead");const t=document.querySelector(".pianoroll-main");!this.canvas||!this.timeRulerCanvas||!t||(t.addEventListener("mousedown",e=>this.onMouseDown(e)),document.addEventListener("mousemove",e=>this.onMouseMove(e)),document.addEventListener("mouseup",()=>this.onMouseUp()),t.addEventListener("wheel",e=>this.onWheel(e),{passive:!1}),t.addEventListener("touchstart",e=>this.onTouchStart(e),{passive:!1}),t.addEventListener("touchmove",e=>this.onTouchMove(e),{passive:!1}),t.addEventListener("touchend",e=>this.onTouchEnd(e)),this.resize(),this.ensureRulerEvents())}getPxPerBeat(){return this.pxPerBeat}setMinKeyHeight(t){const e=Math.max(1,Math.min(64,Math.floor(t)));e!==this.minKeyHeight&&(this.minKeyHeight=e,this.resize())}setTrailingBars(t){const e=Math.max(0,Math.floor(t));e!==this.trailingBars&&(this.trailingBars=e,this.clampScrollToBounds(),this.draw())}setDisplayBeatsPerBar(t){const e=Math.max(1,Math.floor(t));e!==this.displayBeatsPerBar&&(this.displayBeatsPerBar=e,this.clampScrollToBounds(),this.draw())}setNoteCreationMode(t){this.isNoteCreationMode=!!t}setSelectedLength(t){this.project&&(this.project.selectedLength=t)}setProject(t){this.project=t;const e=this.project?.timeSig?.beatsPerBar;Number.isFinite(e)&&e>=1&&(this.displayBeatsPerBar=Math.floor(e)),this.recomputeVolumeLabelsForAllTracks(this.project),this.updateNoteRange(),this.clampScrollToBounds(),this.draw()}setCurrentTrack(t){this.currentTrack=t,this.draw()}getCurrentTrack(){return this.currentTrack}adjustTrackVolume(t){if(!this.project)return;const e=this.currentTrack||this.project.tracks[0];if(!e||!Array.isArray(e.notes)||e.notes.length===0||!this.selection||this.selection.size===0)return;const i=e.notes.slice().sort((c,a)=>c.startTick-a.startTick||String(c.id).localeCompare(String(a.id))),s=[];let o=j;for(let c=0;c<i.length;c++){const a=Number.isFinite(i[c].volume)?i[c].volume:o;s[c]=a,o=a}const r=new Map;for(let c=0;c<i.length;c++)r.set(i[c].id,c);let n=!1;for(const c of e.notes){if(!this.selection.has(c.id))continue;const a=r.get(c.id),h=a!==void 0?s[a]??j:Number.isFinite(c.volume)?c.volume:j,l=Math.max(0,Math.min(15,h+t));(!Number.isFinite(c.volume)||c.volume!==l)&&(c.volume=l,n=!0)}n&&(this.recomputeVolumeLabelsForTrack(e),this.commitEditedNotes(),this.draw())}setPreviewNotes(t){if(this.previewNotes=Array.isArray(t)?t:[],this.updateNoteRange(),document.body.classList.contains("edit-mode")&&this.canvas&&this.previewNotes.length>0){const e=this.canvas.clientHeight,i=Math.min(...this.previewNotes.map(l=>l.pitch)),o=95-Math.max(...this.previewNotes.map(l=>l.pitch)),r=95-i,n=o*this.keyHeight,a=(r+1)*this.keyHeight-n,h=Math.max(0,n-Math.max(0,(e-a)/2));this.scrollY=h}this.clampScrollToBounds(),this.draw()}clearPreviewNotes(){this.previewNotes=[],this.updateNoteRange(),this.clampScrollToBounds(),this.draw()}setPlayheadPosition(t){this.updatePlayhead()}setPlayheadTick(t){this.playheadTick=Math.max(0,t|0),this.updatePlayhead()}onMouseDown(t){const e=document.body.classList.contains("edit-mode"),i=this.canvas;if(e&&i){const s=i.clientWidth,o=i.clientHeight,r=84*this.keyHeight;if(r>o){const n=s-this.vScrollBarMargin-this.vScrollBarWidth;if(t.offsetX>=n){const{thumbY:c,thumbH:a}=this.computeVScrollThumb(o,r),h=t.offsetY;this.isVScrollDragging=!0,this.vScrollDragOffsetY=Math.min(Math.max(0,h-c),a),t.preventDefault();return}}}if(e&&i){const s=this.hitTestNote(t.offsetX,t.offsetY);if(s){const{id:o,mode:r}=s;this.selection.has(o)||(this.selection.clear(),this.selection.add(o)),this.dragMode=r,this.dragStart={x:t.clientX,y:t.clientY};const n=this.findNoteById(o);n&&(this.dragNoteAnchor={tick:n.startTick,pitch:n.pitch,len:n.durationTick}),this.selectionAnchors.clear();const c=this.currentTrack||this.project?.tracks?.[0];if(c&&Array.isArray(c.notes))for(const a of c.notes)this.selection.has(a.id)&&this.selectionAnchors.set(a.id,{tick:a.startTick,pitch:a.pitch,len:a.durationTick});if(this.longPressTimer&&clearTimeout(this.longPressTimer),n)try{this.playPreviewSound(n.pitch)}catch{}this.draw(),t.preventDefault()}else if(this.isNoteCreationMode){const o=i.getBoundingClientRect(),r=t.clientX-o.left,n=t.clientY-o.top;this.beginCreateTempNote(r,n),t.preventDefault()}else{const o=i.getBoundingClientRect(),r=t.clientX-o.left,n=t.clientY-o.top;this.longPressTimer&&clearTimeout(this.longPressTimer),this.dragStart={x:t.clientX,y:t.clientY},this.longPressTimer=setTimeout(()=>{this.selectingRect={x0:r,y0:n,x1:r,y1:n},this.dragMode="marquee",this.draw()},350)}}this.isDragging=!0,this.lastX=t.clientX,t.preventDefault()}onMouseMove(t){const e=this.canvas;if(!e)return;if(this.isVScrollDragging){const s=e.clientHeight,o=84*this.keyHeight,{thumbH:r}=this.computeVScrollThumb(s,o),n=Math.max(0,s-r),c=Math.min(Math.max(0,t.offsetY-this.vScrollDragOffsetY),n),a=Math.max(0,o-s);this.scrollY=n>0?c/n*a:0,this.clampScrollToBounds(),this.draw();return}if(document.body.classList.contains("edit-mode")){if(Math.hypot(t.clientX-this.dragStart.x,t.clientY-this.dragStart.y)>4&&this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.dragMode==="marquee"&&this.selectingRect){const o=e.getBoundingClientRect();this.selectingRect.x1=t.clientX-o.left,this.selectingRect.y1=t.clientY-o.top,this.draw();return}if(this.dragMode!=="none"){const o=t.clientX-this.dragStart.x,r=t.clientY-this.dragStart.y;this.applyDragToSelection(o,r),this.dragMode==="move"&&this.dragNoteAnchor&&this.previewDuringMove(r),this.draw();return}if(this.isNoteCreationMode&&this.tempNote){this.updateTempNote(t.clientX,t.clientY),this.draw();return}}if(!this.isDragging)return;const i=t.clientX-this.lastX;this.scrollX-=i,this.clampScrollToBounds(),this.lastX=t.clientX,this.draw()}onMouseUp(){if(this.isDragging=!1,this.isVScrollDragging=!1,this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),document.body.classList.contains("edit-mode")){if(this.dragMode==="marquee"&&this.selectingRect){this.performMarqueeSelection(),this.selectingRect=null,this.dragMode="none",this.draw();return}if(this.isNoteCreationMode&&this.tempNote){this.finalizeTempNote(),this.draw();return}if(this.dragMode!=="none"&&this.dragNoteAnchor){this.commitEditedNotes(),this.dragMode="none",this.dragNoteAnchor=null,this.selectionAnchors.clear(),this.stopPreviewSound();return}!this.selectingRect&&!this.isNoteCreationMode&&(this.selection.clear(),this.draw())}}onWheel(t){t.preventDefault(),t.deltaY<0?this.zoomIn():this.zoomOut()}onTouchStart(t){if(t.touches.length===1){const e=document.body.classList.contains("edit-mode"),i=this.canvas;if(e&&i){const s=i.getBoundingClientRect(),o=i.clientWidth,r=i.clientHeight,n=84*this.keyHeight,c=t.touches[0].clientX-s.left,a=t.touches[0].clientY-s.top;if(n>r){const l=o-this.vScrollBarMargin-this.vScrollBarWidth;if(c>=l){const{thumbY:u,thumbH:m}=this.computeVScrollThumb(r,n);this.isVScrollDragging=!0,this.vScrollDragOffsetY=Math.min(Math.max(0,a-u),m),t.preventDefault();return}}const h=this.hitTestNote(c,a);if(h){const{id:l,mode:u}=h;this.selection.has(l)||(this.selection.clear(),this.selection.add(l)),this.dragMode=u,this.dragStart={x:t.touches[0].clientX,y:t.touches[0].clientY};const m=this.findNoteById(l);m&&(this.dragNoteAnchor={tick:m.startTick,pitch:m.pitch,len:m.durationTick}),this.selectionAnchors.clear();const d=this.currentTrack||this.project?.tracks?.[0];if(d&&Array.isArray(d.notes))for(const p of d.notes)this.selection.has(p.id)&&this.selectionAnchors.set(p.id,{tick:p.startTick,pitch:p.pitch,len:p.durationTick});if(this.longPressTimer&&clearTimeout(this.longPressTimer),m)try{this.playPreviewSound(m.pitch)}catch{}this.draw(),t.preventDefault()}else this.isNoteCreationMode?(this.beginCreateTempNote(c,a),t.preventDefault()):(this.dragMode="none",this.longPressTimer&&clearTimeout(this.longPressTimer),this.dragStart={x:t.touches[0].clientX,y:t.touches[0].clientY},this.longPressTimer=setTimeout(()=>{this.selectingRect={x0:c,y0:a,x1:c,y1:a},this.dragMode="marquee",this.draw()},350))}this.isDragging=!0,this.lastX=t.touches[0].clientX,t.preventDefault()}else if(t.touches.length===2){this.isPinching=!0,this.isDragging=!1;const e=t.touches[0],i=t.touches[1];this.initialPinchDistance=Math.hypot(i.clientX-e.clientX,i.clientY-e.clientY),this.lastPxPerBeat=this.pxPerBeat,this.lastCenterX=(e.clientX+i.clientX)/2,this.lastCenterY=(e.clientY+i.clientY)/2,t.preventDefault()}}onTouchMove(t){if(this.isVScrollDragging&&t.touches.length===1){const e=this.canvas;if(!e)return;const i=e.getBoundingClientRect(),s=e.clientHeight,o=84*this.keyHeight,r=t.touches[0].clientY-i.top,{thumbH:n}=this.computeVScrollThumb(s,o),c=Math.max(0,s-n),a=Math.min(Math.max(0,r-this.vScrollDragOffsetY),c),h=Math.max(0,o-s);this.scrollY=c>0?a/c*h:0,this.clampScrollToBounds(),this.draw(),t.preventDefault();return}if(this.isDragging&&t.touches.length===1){if(document.body.classList.contains("edit-mode")){const i=t.touches[0].clientX-this.dragStart.x,s=t.touches[0].clientY-this.dragStart.y;if(this.dragMode==="marquee"&&this.selectingRect){const r=this.canvas.getBoundingClientRect();this.selectingRect.x1=t.touches[0].clientX-r.left,this.selectingRect.y1=t.touches[0].clientY-r.top,this.draw(),t.preventDefault();return}if(this.dragMode!=="none"){this.applyDragToSelection(i,s),this.dragMode==="move"&&this.dragNoteAnchor&&this.previewDuringMove(s),this.draw(),t.preventDefault();return}if(this.isNoteCreationMode&&this.tempNote){this.updateTempNote(t.touches[0].clientX,t.touches[0].clientY),this.draw(),t.preventDefault();return}}const e=t.touches[0].clientX-this.lastX;this.scrollX-=e,this.clampScrollToBounds(),this.lastX=t.touches[0].clientX,this.draw(),t.preventDefault();return}if(this.isPinching&&t.touches.length===2){const e=t.touches[0],i=t.touches[1],o=Math.hypot(i.clientX-e.clientX,i.clientY-e.clientY)/this.initialPinchDistance;this.pxPerBeat=Math.max(this.minPxPerBeat,Math.min(this.maxPxPerBeat,this.lastPxPerBeat*o));const r=(e.clientX+i.clientX)/2,n=(e.clientY+i.clientY)/2,c=r-this.lastCenterX,a=n-this.lastCenterY;this.scrollX-=c,this.scrollY-=a,this.clampScrollToBounds(),this.lastCenterX=r,this.lastCenterY=n,this.draw(),t.preventDefault()}}onTouchEnd(t){if(t.touches.length===0&&(this.isDragging=!1,this.isPinching=!1,this.isVScrollDragging=!1,this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),document.body.classList.contains("edit-mode"))){if(this.dragMode==="marquee"&&this.selectingRect){this.performMarqueeSelection(),this.selectingRect=null,this.dragMode="none",this.draw();return}if(this.isNoteCreationMode&&this.tempNote){this.finalizeTempNote(),this.draw();return}if(this.dragMode!=="none"&&this.dragNoteAnchor){this.commitEditedNotes(),this.dragMode="none",this.dragNoteAnchor=null,this.selectionAnchors.clear(),this.stopPreviewSound();return}this.selectingRect||(this.selection.clear(),this.draw())}}calculateKeyHeight(){if(!this.canvas)return this.minKeyHeight;if(document.body.classList.contains("edit-mode"))return this.minKeyHeight;const e=(this.canvas?.clientHeight??0)-20,i=Math.floor(e/Math.max(1,this.noteRange));return Math.max(1,i)}zoomIn(){this.pxPerBeat=Math.min(this.maxPxPerBeat,this.pxPerBeat*1.2),this.clampScrollToBounds(),this.draw()}zoomOut(){this.pxPerBeat=Math.max(this.minPxPerBeat,this.pxPerBeat/1.2),this.clampScrollToBounds(),this.draw()}drawBackground(){if(!this.canvas)return;const t=this.canvas.getContext("2d");if(!t)return;const e=window.devicePixelRatio||1,i=this.canvas.clientWidth,s=this.canvas.clientHeight;this.keyHeight=this.calculateKeyHeight(),t.setTransform(e,0,0,e,0,0),t.clearRect(0,0,i,s);const o=document.body.classList.contains("edit-mode"),r=o?this.editLeftGutter:0;t.fillStyle="#ffffff",t.fillRect(0,0,i,s);const n=this.noteRange*this.keyHeight,c=o?0:(s-n)/2;if(o&&this.drawPitchRows(t,r,i-r,s),this.drawVerticalGrid(t,i,s,r,o),this.drawNotes(t,c,r,s),o&&this.drawOctaveLabels(t,r,s),o&&this.selectingRect){t.save();const a=Math.min(this.selectingRect.x0,this.selectingRect.x1),h=Math.max(this.selectingRect.x0,this.selectingRect.x1),l=Math.min(this.selectingRect.y0,this.selectingRect.y1),u=Math.max(this.selectingRect.y0,this.selectingRect.y1);t.strokeStyle="#3a7afe",t.setLineDash([6,4]),t.lineWidth=1,t.strokeRect(a+.5,l+.5,Math.max(0,h-a),Math.max(0,u-l)),t.fillStyle="rgba(58,122,254,0.12)",t.fillRect(a,l,Math.max(0,h-a),Math.max(0,u-l)),t.restore()}o&&this.drawVerticalScrollbar(t,i,s)}drawPitchRows(t,e,i,s){const r=Math.max(0,Math.floor(this.scrollY/this.keyHeight)),n=Math.min(84-r,Math.ceil(s/this.keyHeight)+1);for(let c=0;c<n;c++){const a=r+c,h=a*this.keyHeight-this.scrollY,u=((95-a)%12+12)%12,m=u===1||u===3||u===6||u===8||u===10;t.fillStyle=m?"#d6d6d6":"#ffffff",t.fillRect(e,Math.floor(h),Math.max(0,i),this.keyHeight);const d=u===11;t.strokeStyle=d?"#000000":"rgb(153,153,153)",t.lineWidth=1,t.beginPath(),t.moveTo(e,Math.floor(h)+.5),t.lineTo(e+Math.max(0,i),Math.floor(h)+.5),t.stroke()}}drawOctaveLabels(t,e,i){const s=12*this.keyHeight,o=7,r=Math.max(0,Math.floor(this.scrollY/s));let n=r*s-this.scrollY;for(let c=r;c<o&&!(n>=i);c++){const a=7-c,h=a%2===0;t.fillStyle=h?"#e6e6e6":"#ffffff";const l=Math.min(s,i-Math.floor(n));t.fillRect(0,Math.floor(n),e,l),t.fillStyle="#222",t.textAlign="center",t.textBaseline="middle",t.font=`${Math.max(10,Math.round(12))}px system-ui, sans-serif`;const u=n+l/2;t.fillText("o"+a,Math.floor(e/2),Math.floor(u)),n+=s}t.strokeStyle="#e0e0e0",t.beginPath(),t.moveTo(e+.5,0),t.lineTo(e+.5,i),t.stroke()}drawVerticalGrid(t,e,i,s,o){const r=Math.max(0,e-s),n=Math.floor(this.scrollX/this.pxPerBeat)-1,c=Math.ceil((this.scrollX+r)/this.pxPerBeat)+1;if(o){const a=this.pxPerBeat,h=(l,u)=>{const m=n,d=c;t.strokeStyle=u,t.lineWidth=.5;for(let p=m;p<=d;p++)for(let f=1;f<l;f+=2){const y=(p+f/l)*this.pxPerBeat-this.scrollX+s;t.beginPath(),t.moveTo(Math.floor(y)+.5,0),t.lineTo(Math.floor(y)+.5,i),t.stroke()}};a>=48&&h(2,"rgb(191,191,191)"),a>=96&&h(4,"rgb(191,191,191)"),a>=144&&h(8,"rgb(191,191,191)")}for(let a=n;a<=c;a++){const h=a*this.pxPerBeat-this.scrollX+s,l=a%this.displayBeatsPerBar===0;o?(t.strokeStyle=l?"#000000":"rgb(128,128,128)",t.lineWidth=1):l?(t.strokeStyle="rgb(170,170,170)",t.lineWidth=1):(t.strokeStyle="rgb(210,210,210)",t.lineWidth=1),t.beginPath(),t.moveTo(Math.floor(h)+.5,0),t.lineTo(Math.floor(h)+.5,i),t.stroke()}}drawNotes(t,e,i,s){const o=document.body.classList.contains("edit-mode");if(!this.project){this.drawSampleNotes(t,e,i,s);return}if(o){for(const n of this.project.tracks){const c=!this.currentTrack||n===this.currentTrack;t.save(),c||(t.globalAlpha=.35);const a=n.color||"#3a7afe";for(const h of n.notes){if(h.pitch<12||h.pitch>95)continue;const l=h.startTick/480*this.pxPerBeat-this.scrollX+i+1,u=Math.max(1,h.durationTick/480*this.pxPerBeat-2)+1,d=(95-h.pitch)*this.keyHeight-this.scrollY+1,p=this.keyHeight-2+1;if(d+p<0||d>s)continue;const f=n===this.currentTrack&&this.selection.has(h.id),y=this.dragNoteAnchor&&f&&(this.dragMode==="move"||this.dragMode==="resize-left"||this.dragMode==="resize-right")?this.dragMode:"none";this.drawNoteRect(t,l,d,u,p,a,f,y)}t.restore()}if(this.previewNotes&&this.previewNotes.length>0){const n=L.GHOST_COLOR;for(const c of this.previewNotes){if(c.pitch<12||c.pitch>95)continue;const a=c.startTick/480*this.pxPerBeat-this.scrollX+i+1,h=Math.max(1,c.durationTick/480*this.pxPerBeat-2)+1,u=(95-c.pitch)*this.keyHeight-this.scrollY+1,m=this.keyHeight-2+1;u+m<0||u>s||this.drawNoteRect(t,a,u,h,m,c.color||n,!1,"none")}}this.drawVolumeLabels(t,i,s);return}const r=this.currentTrack;for(const n of this.project.tracks){const c=n.color||"#3a7afe";t.save(),r&&n!==r&&(t.globalAlpha=.35);for(const a of n.notes){if(a.pitch<this.minPitch||a.pitch>this.maxPitch)continue;const h=a.startTick/480*this.pxPerBeat-this.scrollX+i+1,l=Math.max(1,a.durationTick/480*this.pxPerBeat-2)+1,u=this.maxPitch-a.pitch,m=e+u*this.keyHeight+1,d=this.keyHeight-2+1;this.drawNoteRect(t,h,m,l,d,c,!1,"none")}t.restore()}if(this.drawVolumeLabels(t,i,s),this.previewNotes&&this.previewNotes.length>0){const n=L.GHOST_COLOR;for(const c of this.previewNotes){if(c.pitch<12||c.pitch>95)continue;const a=c.startTick/480*this.pxPerBeat-this.scrollX+i+1,h=Math.max(1,c.durationTick/480*this.pxPerBeat-2)+1,l=document.body.classList.contains("edit-mode")?95-c.pitch:this.maxPitch-c.pitch,u=(document.body.classList.contains("edit-mode")?l*this.keyHeight-this.scrollY:e+l*this.keyHeight)+1,m=this.keyHeight-2+1;document.body.classList.contains("edit-mode")&&(u+m<0||u>s)||this.drawNoteRect(t,a,u,h,m,c.color||n,!1,"none")}}}drawSampleNotes(t,e,i,s){const o=[{pitch:60,start:0,duration:1},{pitch:64,start:1,duration:1},{pitch:67,start:2,duration:1},{pitch:72,start:3,duration:1}],r="#3a7afe";for(const n of o){if(n.pitch<this.minPitch||n.pitch>this.maxPitch)continue;const c=n.start*this.pxPerBeat-this.scrollX+i+1,a=Math.max(1,n.duration*this.pxPerBeat-2)+1,h=document.body.classList.contains("edit-mode")?95-n.pitch:this.maxPitch-n.pitch,l=(document.body.classList.contains("edit-mode")?h*this.keyHeight-this.scrollY:e+h*this.keyHeight)+1,u=this.keyHeight-2+1;document.body.classList.contains("edit-mode")&&(l+u<0||l>s)||this.drawNoteRect(t,c,l,a,u,r,!1,"none")}}drawTimeRuler(){if(!this.timeRulerCanvas)return;const t=this.timeRulerCanvas.getContext("2d");if(!t)return;const e=window.devicePixelRatio||1,i=this.timeRulerCanvas.clientWidth,s=this.timeRulerCanvas.clientHeight;t.setTransform(e,0,0,e,0,0),t.clearRect(0,0,i,s);const o=document.body.classList.contains("edit-mode"),r=o?this.editLeftGutter:0;t.fillStyle="#f8f9fa",t.fillRect(0,0,i,s),o&&(t.strokeStyle="#e0e0e0",t.beginPath(),t.moveTo(r+.5,0),t.lineTo(r+.5,s),t.stroke());const n=Math.max(0,i-r),c=Math.floor(this.scrollX/this.pxPerBeat)-1,a=Math.ceil((this.scrollX+n)/this.pxPerBeat)+1;for(let u=c;u<=a;u++){const m=u*this.pxPerBeat-this.scrollX+r;if(u%this.displayBeatsPerBar===0){const p=Math.floor(u/this.displayBeatsPerBar)+1;t.strokeStyle="#000000",t.lineWidth=1,t.beginPath(),t.moveTo(m+.5,0),t.lineTo(m+.5,s),t.stroke(),t.fillStyle="#333333",t.font="11px system-ui, sans-serif",t.textAlign="left",t.textBaseline="top",t.fillText(String(p),m+2,2)}else t.strokeStyle="#888888",t.lineWidth=1,t.beginPath(),t.moveTo(m+.5,s*.6),t.lineTo(m+.5,s),t.stroke()}const h=this.project,l=h&&Array.isArray(h.tempoAnchors)?h.tempoAnchors:[];if(o&&l.length>0){const u=Math.max(12,Math.floor(s*.6));for(const m of l){const d=m.tick/M*this.pxPerBeat-this.scrollX+r,p=14,f=u,y=Math.floor(d-p/2)+.5,b=Math.floor(s-f-2)+.5;t.fillStyle=this.selectedTempoAnchorTick===m.tick?"#3a7afe":"#90caf9",t.fillRect(y,b,p,f),t.strokeStyle="#1e88e5",t.strokeRect(y,b,p,f);const P=String(Math.round(m.bpm||0));t.font="bold 12px system-ui, sans-serif",t.textAlign="center",t.textBaseline="bottom";const _=Math.ceil(t.measureText(P).width),R=6,B=3,g=_+R*2,k=16+B;let v=Math.floor(d-g/2)+.5,x=Math.floor(b-6)+.5;v=Math.max(.5,Math.min(v,i-g-.5)),x=Math.max(.5+1,Math.min(x,s-k-.5)),t.fillStyle="rgba(255,255,255,0.9)",t.strokeStyle="rgba(0,0,0,0.15)",t.lineWidth=1,t.fillRect(v,x,g,k),t.strokeRect(v,x,g,k),t.fillStyle="#1e88e5",t.fillText(P,Math.floor(v+g/2)+.5,Math.floor(x+k-B)+.5)}}}attachRulerEventsOnce=!1;ensureRulerEvents(){if(this.attachRulerEventsOnce)return;const t=this.timeRulerCanvas;if(!t)return;this.attachRulerEventsOnce=!0;let e=0;const i=6,s=l=>{document.body.classList.contains("edit-mode")&&(l.preventDefault(),this.openRulerContextMenu(l.clientX,l.clientY))},o=l=>{if(!document.body.classList.contains("edit-mode")||l.button===2)return;const u=t.getBoundingClientRect(),m=l.clientX-u.left,d=this.hitTempoAnchorAtCssX(m);if(d){l.preventDefault(),this.pendingTempoIndex=d.index,this.pointerDownAt={x:l.clientX,y:l.clientY},this.selectedTempoAnchorTick=d.tick;return}},r=l=>{if(!document.body.classList.contains("edit-mode")||l.touches.length!==1)return;const u=l.touches[0],m=Date.now(),d=m-e<300;e=m;const p=t.getBoundingClientRect(),f=u.clientX-p.left,y=this.hitTempoAnchorAtCssX(f);if(y){if(l.preventDefault(),this.pendingTempoIndex=y.index,this.pointerDownAt={x:u.clientX,y:u.clientY},this.selectedTempoAnchorTick=y.tick,d){this.openRulerContextMenu(u.clientX,u.clientY);return}return}if(d){this.openRulerContextMenu(u.clientX,u.clientY);return}},n=l=>{if(this.pendingTempoIndex!==-1&&!this.isDraggingTempo&&this.pointerDownAt){const u=Math.abs(l.clientX-this.pointerDownAt.x),m=Math.abs(l.clientY-this.pointerDownAt.y);(u>i||m>i)&&(this.isDraggingTempo=!0,this.draggingTempoIndex=this.pendingTempoIndex,this.pendingTempoIndex=-1)}this.isDraggingTempo&&(l.preventDefault(),this.updateDraggingTempoByClientX(l.clientX))},c=l=>{if(l.touches.length!==1)return;const u=l.touches[0];if(this.pendingTempoIndex!==-1&&!this.isDraggingTempo&&this.pointerDownAt){const m=Math.abs(u.clientX-this.pointerDownAt.x),d=Math.abs(u.clientY-this.pointerDownAt.y);(m>i||d>i)&&(this.isDraggingTempo=!0,this.draggingTempoIndex=this.pendingTempoIndex,this.pendingTempoIndex=-1)}this.isDraggingTempo&&(l.preventDefault(),this.updateDraggingTempoByClientX(u.clientX))},a=()=>{this.isDraggingTempo&&this.finishDraggingTempo()},h=()=>{this.pendingTempoIndex=-1,this.pointerDownAt=null};t.addEventListener("contextmenu",s),t.addEventListener("mousedown",o),window.addEventListener("mousemove",n),window.addEventListener("mouseup",()=>{this.isDraggingTempo&&a(),h()}),t.addEventListener("touchstart",r,{passive:!1}),window.addEventListener("touchmove",c,{passive:!1}),window.addEventListener("touchend",()=>{this.isDraggingTempo&&a(),h()},{passive:!0})}updateDraggingTempoByClientX(t){if(!this.timeRulerCanvas||!this.project)return;const e=this.timeRulerCanvas.getBoundingClientRect(),i=t-e.left,s=this.getLeftGutter(),o=Math.max(0,i-s+this.scrollX),r=Math.max(0,Math.round(o/this.pxPerBeat*M)),n=this.getGrid(),c=Math.max(0,Math.floor(r/n)*n),a=this.project,h=Array.isArray(a.tempoAnchors)?a.tempoAnchors:[];if(!(this.draggingTempoIndex<0||this.draggingTempoIndex>=h.length)){h[this.draggingTempoIndex].tick=c,h.sort((l,u)=>l.tick-u.tick);for(let l=1;l<h.length;l++)h[l].tick===h[l-1].tick&&(h.splice(l-1,1),l--);a.tempoAnchors=h,this.selectedTempoAnchorTick=c,this.drawTimeRuler()}}finishDraggingTempo(){if(!this.project){this.isDraggingTempo=!1,this.draggingTempoIndex=-1;return}this.isDraggingTempo=!1,this.draggingTempoIndex=-1;try{window.mobileApp?.getHistory?.().push(this.project)}catch{}T(()=>Promise.resolve().then(()=>F),void 0,import.meta.url).then(()=>{window.mobileApp?.getTransport?.()?.setProject?.(this.project)}).catch(()=>{}),T(()=>import("./optimizer-BoRb_Nid.js"),[],import.meta.url).then(t=>t.scheduleOptimizeAll(this.project)).catch(()=>{})}hitTempoAnchorAtCssX(t){const e=this.project,i=e&&Array.isArray(e.tempoAnchors)?e.tempoAnchors:[];for(let s=0;s<i.length;s++){const o=Math.round(i[s].tick/M*this.pxPerBeat-this.scrollX+this.getLeftGutter())+.5;if(Math.abs(o-t)<=8)return{index:s,tick:i[s].tick}}return null}async openRulerContextMenu(t,e){if(!this.timeRulerCanvas||!document.body.classList.contains("edit-mode"))return;const i=this.timeRulerCanvas.getBoundingClientRect(),s=t-i.left,o=this.hitTempoAnchorAtCssX(s),r=document.getElementById("mobileRulerContextMenu");r&&r.parentNode&&r.parentNode.removeChild(r);const n=document.createElement("div");n.id="mobileRulerContextMenu",n.style.cssText="position:fixed;z-index:2147483647;background:#fff;border:1px solid #ccc;border-radius:8px;box-shadow:0 10px 24px rgba(0,0,0,0.25);padding:6px;min-width:180px;font:14px system-ui,sans-serif;";const c=(g,k)=>{const v=document.createElement("button");return v.type="button",v.textContent=g,v.style.cssText="display:block;width:100%;text-align:left;background:none;border:0;padding:10px;cursor:pointer;border-radius:6px;",v.onmouseenter=()=>v.style.background="#f5f5f5",v.onmouseleave=()=>v.style.background="transparent",v.onclick=()=>{k(),a()},v},a=()=>{n.parentNode&&n.parentNode.removeChild(n)},h=this.getGrid(),l=this.getLeftGutter(),u=Math.max(0,s-l+this.scrollX),m=Math.max(0,Math.round(u/this.pxPerBeat*M)),d=Math.max(0,Math.floor(m/h)*h),p=()=>{try{window.mobileApp?.getHistory?.().push(this.project)}catch{}T(()=>Promise.resolve().then(()=>F),void 0,import.meta.url).then(()=>{window.mobileApp?.getTransport?.()?.setProject?.(this.project)}).catch(()=>{}),T(()=>import("./optimizer-BoRb_Nid.js"),[],import.meta.url).then(g=>g.scheduleOptimizeAll(this.project)).catch(()=>{}),this.draw()},f=async(g,k)=>{const v=await T(()=>import("./tempoModal-CU1-jXle.js"),__vite__mapDeps([0,1]),import.meta.url),x={...this.project||{},bpm:g};v.showTempoModal(x,I=>{k(I),p()})},y=await T(()=>import("./languages-Cgt_gsPd.js").then(g=>g.O),[],import.meta.url).then(g=>{const k=g.currentLang,v=g.translations?.[k]||{};return{edit:v.menuTempoEdit||"Edit tempo…",del:v.menuTempoDelete||"Delete tempo",create:v.menuTempoCreateHere||"Create tempo here…",removeAll:v.menuTempoRemoveAll||"Remove all tempos"}}).catch(()=>({edit:"Edit tempo…",del:"Delete tempo",create:"Create tempo here…",removeAll:"Remove all tempos"}));o?(this.selectedTempoAnchorTick=o.tick,n.appendChild(c(y.edit,()=>{const g=this.project;if(!g)return;const k=g.tempoAnchors||[],v=k[o.index]?.bpm??(this.project?.bpm||120);f(v,x=>{k[o.index].bpm=x,k[o.index].tick===0&&this.project&&(this.project.bpm=x),k.sort((I,A)=>I.tick-A.tick),g.tempoAnchors=k})})),n.appendChild(c(y.del,()=>{const g=this.project;if(!g)return;const k=g.tempoAnchors||[];k.splice(o.index,1),this.selectedTempoAnchorTick=null,g.tempoAnchors=k,p()}))):(this.selectedTempoAnchorTick=null,n.appendChild(c(y.create,()=>{const g=this.project?.bpm||120;f(g,k=>{const v=this.project;if(!v)return;const x=Array.isArray(v.tempoAnchors)?v.tempoAnchors:[];x.push({tick:d,bpm:k}),x.sort((I,A)=>I.tick-A.tick),v.tempoAnchors=x,d===0&&this.project&&(this.project.bpm=k);try{this.splitNotesAtTickAcrossTracks(d)}catch{}})})),n.appendChild(c(y.removeAll,()=>{const g=this.project;g&&(!Array.isArray(g.tempoAnchors)||g.tempoAnchors.length===0||(g.tempoAnchors=[],this.selectedTempoAnchorTick=null,p()))}))),n.style.visibility="hidden",n.style.left="0px",n.style.top="0px",document.body.appendChild(n);const b=8,P=Math.max(n.offsetWidth,180),_=Math.max(n.offsetHeight,44);let R=Math.floor(t),B=Math.floor(e-10);R=Math.max(b,Math.min(R,(window.innerWidth||document.documentElement.clientWidth)-P-b)),B=Math.max(b,Math.min(B,(window.innerHeight||document.documentElement.clientHeight)-_-b)),n.style.left=`${R}px`,n.style.top=`${B}px`,n.style.visibility="visible",setTimeout(()=>{const g=k=>{const v=k.target;(!v||!n.contains(v))&&a()};window.addEventListener("mousedown",g,{once:!0,capture:!0}),window.addEventListener("wheel",()=>a(),{once:!0,capture:!0}),window.addEventListener("resize",()=>a(),{once:!0,capture:!0}),window.addEventListener("scroll",()=>a(),{once:!0,capture:!0}),document.addEventListener("scroll",()=>a(),{once:!0,capture:!0}),window.addEventListener("touchstart",g,{once:!0,capture:!0})},0)}computeVScrollThumb(t,e){const i=t/e,s=Math.max(this.vScrollThumbMin,Math.floor(t*i)),o=Math.max(0,e-t),r=Math.max(0,t-s);return{thumbY:o>0?Math.floor(this.scrollY/o*r):0,thumbH:s}}drawVerticalScrollbar(t,e,i){const s=84*this.keyHeight;if(s<=i)return;const o=e-this.vScrollBarMargin-this.vScrollBarWidth;t.fillStyle="rgba(0,0,0,0.06)",t.fillRect(o,0,this.vScrollBarWidth,i);const{thumbY:r,thumbH:n}=this.computeVScrollThumb(i,s);t.fillStyle="rgba(0,0,0,0.25)",t.fillRect(o,r,this.vScrollBarWidth,n)}updatePlayhead(){if(!this.playhead)return;const e=document.body.classList.contains("edit-mode")?this.editLeftGutter:0,i=this.playheadTick/M*this.pxPerBeat;this.playhead.style.left=i-this.scrollX+e+"px"}draw(){this.drawBackground(),this.drawTimeRuler(),this.ensureRulerEvents(),this.updatePlayhead()}resize(){if(!this.canvas||!this.timeRulerCanvas)return;const t=window.devicePixelRatio||1,e=this.canvas.clientWidth,i=this.canvas.clientHeight;if(e>0&&i>0){const r=Math.floor(e*t),n=Math.floor(i*t);this.canvas.width!==r&&(this.canvas.width=r),this.canvas.height!==n&&(this.canvas.height=n)}const s=this.timeRulerCanvas.clientWidth,o=this.timeRulerCanvas.clientHeight;if(s>0&&o>0){const r=Math.floor(s*t),n=Math.floor(o*t);this.timeRulerCanvas.width!==r&&(this.timeRulerCanvas.width=r),this.timeRulerCanvas.height!==n&&(this.timeRulerCanvas.height=n)}this.clampScrollToBounds(),this.draw()}updateNoteRange(){if(!this.project)return;let t=127,e=0;for(const i of this.project.tracks)for(const s of i.notes)t=Math.min(t,s.pitch),e=Math.max(e,s.pitch);if(this.previewNotes&&this.previewNotes.length>0)for(const i of this.previewNotes)t=Math.min(t,i.pitch),e=Math.max(e,i.pitch);t<=e&&(this.minPitch=Math.max(0,t-2),this.maxPitch=Math.min(127,e+2),this.noteRange=this.maxPitch-this.minPitch+1)}ensurePlayheadInViewPaginate(t){if(!this.canvas)return;const i=document.body.classList.contains("edit-mode")?this.editLeftGutter:0,s=this.canvas.clientWidth,o=Math.max(0,s-i),r=Math.max(0,t|0)/M*this.pxPerBeat,n=r-this.scrollX+i;n>=o-1?(this.scrollX=Math.floor(r-i),this.clampScrollToBounds(),this.draw()):n<i&&(this.scrollX=Math.max(0,Math.floor(r-i)),this.clampScrollToBounds(),this.draw())}drawNoteRect(t,e,i,s,o,r,n,c){const a=Math.min(6,Math.floor(o/2));if(t.fillStyle=r,this.roundedRectPath(t,e,i,s,o,a),t.fill(),t.strokeStyle="rgba(0,0,0,0.3)",t.lineWidth=1,this.roundedRectPath(t,e,i,s-1,o-1,Math.max(0,a-1)),t.stroke(),n&&(t.strokeStyle="#3a7afe",t.lineWidth=2,this.roundedRectPath(t,e,i,s-1,o-1,Math.max(0,a-1)),t.stroke(),t.lineWidth=1),c&&c!=="none"){const h=Math.max(4,Math.min(10,Math.floor(s/5))),l=Math.max(4,Math.min(10,Math.floor(s/6)));if(c==="move"){const u=Math.floor(e+(s-l)/2);t.fillStyle="rgba(58,122,254,0.18)",t.fillRect(u,i,l,o)}else c==="resize-left"?(t.fillStyle="rgba(58,122,254,0.22)",t.fillRect(e,i,h,o),t.strokeStyle="rgba(255,255,255,0.9)",t.beginPath(),t.moveTo(Math.floor(e+h-2)+.5,i+2),t.lineTo(Math.floor(e+h-2)+.5,i+o-2),t.stroke()):c==="resize-right"&&(t.fillStyle="rgba(58,122,254,0.22)",t.fillRect(e+s-h,i,h,o),t.strokeStyle="rgba(255,255,255,0.9)",t.beginPath(),t.moveTo(Math.floor(e+s-h+1)+.5,i+2),t.lineTo(Math.floor(e+s-h+1)+.5,i+o-2),t.stroke())}}roundedRectPath(t,e,i,s,o,r){const n=Math.max(0,Math.min(r,Math.floor(Math.min(s,o)/2))),c=Math.floor(e),a=Math.floor(i),h=c+Math.max(0,s),l=a+Math.max(0,o);if(t.beginPath(),n<=0){t.rect(c,a,s,o);return}t.moveTo(c+n,a),t.lineTo(h-n,a),t.arcTo(h,a,h,a+n,n),t.lineTo(h,l-n),t.arcTo(h,l,h-n,l,n),t.lineTo(c+n,l),t.arcTo(c,l,c,l-n,n),t.lineTo(c,a+n),t.arcTo(c,a,c+n,a,n)}getLastEndTick(){if(this.project&&this.project.tracks?.length){let t=0;for(const e of this.project.tracks)for(const i of e.notes){const s=i.startTick+i.durationTick;s>t&&(t=s)}return Number.isFinite(this.project.maxEndTick)&&(t=Math.max(t,this.project.maxEndTick||0)),t}return 480*4}clampScrollToBounds(){if(!this.canvas){this.scrollX=Math.max(0,this.scrollX),this.scrollY=Math.max(0,this.scrollY);return}const t=this.canvas.clientWidth||0,e=this.canvas.clientHeight||0,i=document.body.classList.contains("edit-mode"),s=i?this.editLeftGutter:0,o=Math.max(0,t-s),c=(this.getLastEndTick()/480+this.trailingBars*this.displayBeatsPerBar)*this.pxPerBeat,a=Math.max(0,Math.floor(c-o));if(Number.isFinite(this.scrollX)||(this.scrollX=0),this.scrollX=Math.max(0,Math.min(this.scrollX,a)),!i)this.scrollY=0;else{const h=84*this.keyHeight,l=Math.max(0,Math.floor(h-e));Number.isFinite(this.scrollY)||(this.scrollY=0),this.scrollY=Math.max(0,Math.min(this.scrollY,l))}}getLeftGutter(){return document.body.classList.contains("edit-mode")?this.editLeftGutter:0}pxToTick(t){const e=this.getLeftGutter(),s=(t+this.scrollX-e)/this.pxPerBeat;return Math.max(0,Math.round(s*M))}pxToPitch(t){const e=t+this.scrollY,s=95-Math.floor(e/this.keyHeight);return Math.max(0,Math.min(127,s))}getGrid(){const t=this.project?.selectedLength,e=Number.isFinite(t)&&t>0?t:16;return Math.round(M*(4/e))}findNoteById(t){if(!t||!this.project)return null;const e=this.currentTrack||this.project.tracks[0];return e&&e.notes.find(i=>i.id===t)||null}hitTestNote(t,e){if(!this.project)return null;const i=this.currentTrack||this.project.tracks[0];if(!i)return null;const s=this.getLeftGutter(),o=6;for(const r of i.notes){if(r.pitch<12||r.pitch>95)continue;const n=r.startTick/M*this.pxPerBeat-this.scrollX+s+1,c=Math.max(1,r.durationTick/M*this.pxPerBeat-2)+1,h=(95-r.pitch)*this.keyHeight-this.scrollY+1,l=this.keyHeight-2+1;if(t>=n&&t<=n+c&&e>=h&&e<=h+l)return t<=n+o?{id:r.id,mode:"resize-left"}:t>=n+c-o?{id:r.id,mode:"resize-right"}:{id:r.id,mode:"move"}}return null}applyDragToSelection(t,e){if(!this.project||!this.dragNoteAnchor)return;const i=this.currentTrack||this.project.tracks[0];if(!i)return;const s=this.getGrid(),o=Math.round(t/this.pxPerBeat*M),r=-Math.round(e/this.keyHeight),n=12,c=95;for(const a of i.notes){if(!this.selection.has(a.id))continue;const h=this.selectionAnchors.get(a.id)||{tick:a.startTick,pitch:a.pitch,len:a.durationTick};if(this.dragMode==="move"){let l=Math.max(0,h.tick+o);l=Math.max(0,Math.floor(l/s)*s);let u=Math.max(n,Math.min(c,h.pitch+r));a.startTick=l,a.pitch=u}else if(this.dragMode==="resize-left"){const l=h.tick,u=h.len;let m=Math.max(0,l+o);m=Math.max(0,Math.floor(m/s)*s);const d=l+u;let p=Math.max(s,d-m);a.startTick=m,a.durationTick=p}else if(this.dragMode==="resize-right"){const l=h.len;let u=Math.max(s,Math.floor((l+o)/s)*s);a.durationTick=u}}}performMarqueeSelection(){if(!this.project||!this.selectingRect)return;const t=this.currentTrack||this.project.tracks[0];if(!t)return;const e=this.selectingRect,i=Math.min(e.x0,e.x1),s=Math.max(e.x0,e.x1),o=Math.min(e.y0,e.y1),r=Math.max(e.y0,e.y1);this.selection.clear();const n=this.getLeftGutter();for(const c of t.notes){if(c.pitch<12||c.pitch>95)continue;const a=c.startTick/M*this.pxPerBeat-this.scrollX+n+1,h=Math.max(1,c.durationTick/M*this.pxPerBeat-2)+1,u=(95-c.pitch)*this.keyHeight-this.scrollY+1,m=this.keyHeight-2+1;a<=s&&a+h>=i&&u<=r&&u+m>=o&&this.selection.add(c.id)}}commitEditedNotes(){if(!this.project)return;const t=this.currentTrack||this.project.tracks[0];if(!t)return;const e=t.id??0,i=t.notes.slice().sort((n,c)=>n.startTick-c.startTick||String(n.id).localeCompare(String(c.id))),s=new Set(this.selection),o=i.filter(n=>!s.has(n.id)),r=i.filter(n=>s.has(n.id));t.notes=[];for(const n of o)O(this.project,e,n);for(const n of r)O(this.project,e,n);this.recomputeVolumeLabelsForTrack(t);try{window.mobileApp?.getHistory?.().push(this.project)}catch{}T(()=>import("./optimizer-BoRb_Nid.js"),[],import.meta.url).then(n=>n.scheduleOptimizeTrack(this.project,t)).catch(()=>{})}beginCreateTempNote(t,e){const i=this.getGrid(),s=Math.max(0,Math.floor(this.pxToTick(t)/i)*i),o=this.pxToPitch(e);this.tempNote={startTick:s,durationTick:i,pitch:o},this.previewNotes=[{...this.tempNote,color:L.GHOST_COLOR}],this.draw(),this.playPreviewSound(o)}updateTempNote(t,e){if(!this.canvas||!this.tempNote)return;const i=this.canvas.getBoundingClientRect(),s=t-i.left,o=e-i.top,r=this.getGrid(),n=Math.max(this.tempNote.startTick+r,Math.floor(this.pxToTick(s)/r)*r);this.tempNote.durationTick=Math.max(r,n-this.tempNote.startTick);const c=this.pxToPitch(o);this.tempNote.pitch=c,this.previewNotes=[{...this.tempNote,color:L.GHOST_COLOR}],this.playPreviewSound(c)}finalizeTempNote(){if(!this.project||!this.tempNote){this.previewNotes=[],this.stopPreviewSound();return}const t=this.currentTrack||this.project.tracks[0];if(!t){this.previewNotes=[],this.tempNote=null,this.stopPreviewSound();return}const e=t.notes.filter(o=>o.startTick<=this.tempNote.startTick).sort((o,r)=>r.startTick-o.startTick)[0],i=Number.isFinite(e?.volume)?e.volume:j,s={id:globalThis.crypto?.randomUUID?.()||String(Date.now()),startTick:this.tempNote.startTick,durationTick:this.tempNote.durationTick,pitch:this.tempNote.pitch,volume:i};O(this.project,t.id??0,s),U(this.project,s.startTick+s.durationTick),this.recomputeVolumeLabelsForTrack(t),this.previewNotes=[],this.tempNote=null,this.commitEditedNotes(),this.stopPreviewSound()}getActiveTrackInfo(){const t=this.currentTrack||(this.project?this.project.tracks[0]:null),e=t&&typeof t.id=="number"?t.id:this.project?this.project.tracks.indexOf(t):0,i=t&&typeof t.instrument=="string"?t.instrument:"piano";return{track:t,trackId:e,instrumentKey:i}}async playPreviewSound(t){if(!this.project)return;const{trackId:e,instrumentKey:i}=this.getActiveTrackInfo();try{await K(t,e||0,i,this.lastPlayed)}catch{}}stopPreviewSound(){try{X(this.lastPlayed.sampler,this.lastPlayed.pitch)}catch{}this.lastPlayed.pitch=null,this.lastPlayed.sampler=null}getSortedNotesWithId(t){return(t?.notes||[]).slice().sort((e,i)=>e.startTick-i.startTick||String(e.id).localeCompare(String(i.id)))}recomputeVolumeLabelsForTrack(t){if(!t||!Array.isArray(t.notes))return;const e=this.getSortedNotesWithId(t),i=new Set(e.map(o=>o.id));for(const o of Array.from(this.volumeLabels))i.has(o)&&this.volumeLabels.delete(o);let s=j;for(const o of e){const r=Number.isFinite(o.volume)?o.volume:j;r!==s&&this.volumeLabels.add(o.id),s=r}}recomputeVolumeLabelsForAllTracks(t){if(this.volumeLabels.clear(),!!t)for(const e of t.tracks)this.recomputeVolumeLabelsForTrack(e)}drawVolumeLabels(t,e,i){if(!(!this.project||this.volumeLabels.size===0)){t.save(),t.font="10px sans-serif",t.textAlign="left",t.textBaseline="bottom";for(const s of this.project.tracks)for(const o of s.notes){if(!this.volumeLabels.has(o.id))continue;const n=Math.round(o.startTick/M*this.pxPerBeat)-Math.floor(this.scrollX)+e,c=(95-o.pitch)*this.keyHeight-this.scrollY+1;if(c<-20||c>i+20)continue;const a="V"+String(Number.isFinite(o.volume)?o.volume:j);t.fillStyle="rgba(255,255,255,0.9)",t.fillText(a,n+1,c-1),t.fillStyle="rgba(0,0,0,0.85)",t.fillText(a,n,c-2)}t.restore()}}previewDuringMove(t){if(!this.dragNoteAnchor)return;const e=-Math.round(t/this.keyHeight),i=Math.max(12,Math.min(95,this.dragNoteAnchor.pitch+e));this.playPreviewSound(i)}}const w=Object.freeze(Object.defineProperty({__proto__:null,PianorollMobile:L},Symbol.toStringTag,{value:"Module"}));class z{project=null;isPlaying=!1;currentTick=0;lastFrameTime=0;rafId=null;metronomeEnabled=!1;metroHigh=null;metroLow=null;metroVolume=.65;backingVolume=1;isRecording=!1;recorded=[];activePitch=null;lastPreview={pitch:null,sampler:null};playBtn=null;pauseBtn=null;stopBtn=null;recordBtn=null;metronomeBtn=null;timeDisplay=null;timeRulerCanvas=null;inRecordPreRoll=!1;init(){this.playBtn=document.getElementById("btnPlay"),this.pauseBtn=document.getElementById("btnPause"),this.stopBtn=document.getElementById("btnStop"),this.recordBtn=document.getElementById("btnRecord"),this.metronomeBtn=document.getElementById("btnMetronome"),this.timeDisplay=document.getElementById("timeDisplay"),this.timeRulerCanvas=document.getElementById("timeRulerCanvas"),document.getElementById("btnRecVolume")?.addEventListener("click",t=>{t.preventDefault(),this.openRecordVolumeModal()}),this.playBtn?.addEventListener("click",()=>{this.isRecording||this.onPlay()}),this.pauseBtn?.addEventListener("click",()=>{this.isRecording||this.onPause()}),this.stopBtn?.addEventListener("click",()=>this.onStop()),this.recordBtn?.addEventListener("click",async t=>{t.preventDefault(),!this.isRecording&&await this.startRecordWithPreRoll()}),this.metronomeBtn?.addEventListener("click",t=>{t.preventDefault(),this.metronomeEnabled=!this.metronomeEnabled,this.metronomeBtn?.classList.toggle("active",this.metronomeEnabled)}),this.updateTimeDisplay(),this.metronomeBtn?.classList.toggle("active",this.metronomeEnabled),this.attachRulerScrub()}playKeyPreview(t){const e=window.mobileApp,i=e?.getProject?.()||null,s=e&&typeof e.getUIControls=="function"?e.getUIControls():null,o=s?.getSelectedTrackIndex?.()??0;let r="piano",n=o;if(i&&i.tracks&&i.tracks[o]){const c=i.tracks[o];r=c.instrument||r,typeof c.id=="number"&&(n=c.id)}else s?.getSelectedInstrument&&(r=s.getSelectedInstrument()||r);K(t,n,r,this.lastPreview)}isRecordingActive(){return this.isRecording}setProject(t){this.project=t,this.updateTimeDisplay()}attachRulerScrub(){const t=this.timeRulerCanvas;if(!t)return;let e=!1;const i=c=>{const a=t.getBoundingClientRect(),h=c-a.left;return T(async()=>{const{PianorollMobile:l}=await Promise.resolve().then(()=>w);return{PianorollMobile:l}},void 0,import.meta.url).then(({PianorollMobile:l})=>{const m=l.getInstance().getPxPerBeat(),d=h/m*M,p=M;return Math.max(0,Math.floor(d/p)*p)})},s=async c=>{let a=0;c instanceof TouchEvent?a=c.touches[0]?.clientX??0:a=c.clientX;const h=await i(a);this.setCurrentTick(h)},o=async c=>{c.preventDefault(),!this.isPlaying&&(e=!0,await s(c))},r=async c=>{e&&(c.preventDefault(),await s(c))},n=()=>{e=!1};t.addEventListener("mousedown",o),window.addEventListener("mousemove",r),window.addEventListener("mouseup",n),t.addEventListener("touchstart",o,{passive:!1}),window.addEventListener("touchmove",r,{passive:!1}),window.addEventListener("touchend",n),window.addEventListener("touchcancel",n)}getGlobalEndTick(){if(!this.project)return 0;let t=0;for(const e of this.project.tracks)for(const i of e.notes){const s=i.startTick+i.durationTick;s>t&&(t=s)}return t}collectEvents(){if(!this.project)return[];const t=this.project.tracks.filter(o=>o.solo),e=t.length>0?t:this.project.tracks.filter(o=>!o.mute),i=o=>["lute","mandolin","piano","xylophone","violin","flute","chalumeau"].includes(o)?o:"lute",s=[];for(const o of e){const r=i(o.instrument||"lute");for(const n of o.notes)s.push({startTick:n.startTick,durationTick:n.durationTick,pitch:n.pitch,trackId:o.id,instrumentKey:r,volume:n.volume})}return s}async ensureMetronomePlayers(){if(this.metroHigh&&this.metroLow)return;const t=new W({oscillator:{type:"square"},envelope:{attack:.001,decay:.05,sustain:0,release:.01}}).toDestination(),e=new W({oscillator:{type:"square"},envelope:{attack:.001,decay:.06,sustain:0,release:.01}}).toDestination();this.metroHigh={start:i=>t.triggerAttackRelease(1760,"32n",i,this.metroVolume)},this.metroLow={start:i=>e.triggerAttackRelease(880,"32n",i,Math.max(0,Math.min(1,this.metroVolume*.77)))}}scheduleMetronome(){if(!this.project||!this.metronomeEnabled||!this.metroHigh||!this.metroLow)return;const t=this.project.bpm||this.project.tempo||120,e=Math.max(1,Math.floor(this.project.timeSig?.beatsPerBar||4)),i=Math.max(this.getGlobalEndTick(),this.currentTick+M*4*4);let s=0;const o=this.project?.tempoAnchors||[],r=D(o,t);for(let n=0;n<=i;n+=M){const c=C(r,n),h=s%e===0?this.metroHigh:this.metroLow;S().schedule(l=>{try{h.start(l)}catch{}},c),s++}}scheduleMetronomePreRoll(){if(!this.project||!this.metroHigh||!this.metroLow)return;const t=this.project.bpm||this.project.tempo||120,e=Math.max(1,Math.floor(this.project.timeSig?.beatsPerBar||4)),i=e,s=60/t;for(let o=0;o<i;o++){const n=o%e===0?this.metroHigh:this.metroLow;S().schedule(c=>{try{n.start(c)}catch{}},o*s)}}updateTimeDisplay(){if(!this.timeDisplay||!this.project)return;const t=this.getGlobalEndTick(),e=Math.max(0,Math.floor(this.currentTick)),i=this.project.bpm||this.project.tempo||120,s=this.project?.tempoAnchors||[],o=D(s,i),r=C(o,e),n=C(o,t);this.timeDisplay.textContent=`${Y(r)} / ${Y(n)}`}rafTick(){if(!this.isPlaying||!this.project)return;const t=performance.now(),e=Math.max(0,t-this.lastFrameTime);if(this.lastFrameTime=t,this.inRecordPreRoll){this.rafId=requestAnimationFrame(()=>this.rafTick());return}const i=this.project?.tempoAnchors||[],s=D(i,this.project.bpm||this.project.tempo||120);this.currentTick=q(s,this.currentTick,e);const o=this.getGlobalEndTick();if(!this.isRecording&&this.currentTick>=o){this.onStop();return}T(async()=>{const{PianorollMobile:r}=await Promise.resolve().then(()=>w);return{PianorollMobile:r}},void 0,import.meta.url).then(({PianorollMobile:r})=>{const n=r.getInstance();n.setPlayheadTick(this.currentTick),n.ensurePlayheadInViewPaginate(this.currentTick)}),this.updateTimeDisplay(),this.rafId=requestAnimationFrame(()=>this.rafTick())}async onPlay(){if(this.isPlaying||!this.project)return;this.isPlaying=!0,document.body.classList.add("playing-mode"),await V();const t=this.collectEvents(),e=this.project.bpm||this.project.tempo||120,i=this.project?.tempoAnchors||[];await $(t,e,{tempoAnchors:i});const s=D(i,e);S().position=C(s,this.currentTick),this.metronomeEnabled&&(await this.ensureMetronomePlayers(),this.scheduleMetronome()),this.lastFrameTime=performance.now(),this.rafId=requestAnimationFrame(()=>this.rafTick())}async startRecordWithPreRoll(){if(!this.project)return;await V();const t=this.project.bpm||this.project.tempo||120,i=Math.max(1,Math.floor(this.project.timeSig?.beatsPerBar||4));S().stop(),S().cancel(),S().bpm.value=t,await V(),await this.ensureMetronomePlayers(),this.scheduleMetronomePreRoll();const s=i*(60/t);this.isRecording=!0,this.isPlaying=!0,this.inRecordPreRoll=!0,document.body.classList.add("recording-mode"),this.recorded=[],this.activePitch=null,this.lockKeyboardViewport(!0);try{const{PianorollMobile:o}=await T(async()=>{const{PianorollMobile:r}=await Promise.resolve().then(()=>w);return{PianorollMobile:r}},void 0,import.meta.url);o.getInstance().setTrailingBars(32)}catch{}if(this.recordBtn?.classList.add("active"),this.playBtn?.setAttribute("disabled","true"),this.pauseBtn?.setAttribute("disabled","true"),this.hookKeyboardRecording(!0),this.metronomeEnabled&&this.scheduleMetronomeAfter(s,0),this.project){const o=this.project.bpm||this.project.tempo||120,r=this.collectEvents(),a=window.mobileApp?.getUIControls?.()?.getSelectedTrackIndex?.()??0,l=this.project.tracks[a]?.id,u=Math.max(0,Math.floor(this.currentTick)),m=r.filter(d=>d.trackId!==l&&d.startTick>=u).map(d=>({...d,startTick:d.startTick-u}));await J(m,o,s,{velocityScale:Math.max(0,Math.min(1,this.backingVolume))})}S().start("+0"),this.lastFrameTime=performance.now(),this.rafId=requestAnimationFrame(()=>this.rafTick()),S().scheduleOnce(()=>{if(this.captureHeldKeyAtRecordStart(),this.inRecordPreRoll=!1,this.activePitch!=null)try{this.playKeyPreview(this.activePitch)}catch{}},s)}captureHeldKeyAtRecordStart(){if(!this.isRecording||this.activePitch!=null)return;const t=document.getElementById("keyboard");if(!t)return;const e=Array.from(t.querySelectorAll(".key.pressed"));if(e.length===0)return;let i=null;for(const s of e){const o=parseInt(s.dataset.note||"");Number.isFinite(o)&&(i==null||o<i)&&(i=o)}if(i!=null){this.activePitch=i,this.recorded.push({pitch:i,startTick:Math.max(0,Math.floor(this.currentTick))});try{this.playKeyPreview(i)}catch{}}}lockKeyboardViewport(t){try{T(async()=>{const{KeyboardMobile:e}=await Promise.resolve().then(()=>G);return{KeyboardMobile:e}},void 0,import.meta.url).then(({KeyboardMobile:e})=>{e.getInstance().setViewportLocked(t)}).catch(()=>{})}catch{}}hookKeyboardRecording(t){const e=document.getElementById("keyboard");if(!e)return;const i=(u,m)=>{if(u==null)return;const d=e.querySelector(`.key[data-note="${u}"]`);d&&(m?d.classList.add("pressed"):d.classList.remove("pressed"))},s=u=>{if(!this.isRecording||this.inRecordPreRoll)return;const m=u.target||null,d=m?m.closest(".key"):null,p=parseInt(d?.dataset?.note||"");Number.isFinite(p)&&this.activePitch==null&&(this.activePitch=p,this.recorded.push({pitch:p,startTick:Math.max(0,Math.floor(this.currentTick))}),i(p,!0),this.playKeyPreview(p))},o=u=>{if(!this.isRecording||this.inRecordPreRoll||this.activePitch==null)return;let m=0,d=0;if(window.TouchEvent&&u instanceof TouchEvent){const P=u.touches[0];if(!P)return;m=P.clientX,d=P.clientY}else if(u.clientX!=null){const P=u;if(P.buttons===0)return;m=P.clientX,d=P.clientY}else return;const p=document.elementFromPoint(m,d);if(!p)return;const f=p.closest(".key");if(!f)return;const y=parseInt(f.dataset.note||"");if(!Number.isFinite(y)||y===this.activePitch)return;const b=this.recorded[this.recorded.length-1];b&&b.endTick==null&&(b.endTick=Math.max(0,Math.floor(this.currentTick))),i(this.activePitch,!1),this.activePitch=y,this.recorded.push({pitch:y,startTick:Math.max(0,Math.floor(this.currentTick))}),i(y,!0),this.playKeyPreview(y)},r=u=>{if(!(!this.isRecording||this.inRecordPreRoll)&&this.activePitch!=null){const m=this.recorded[this.recorded.length-1];m&&m.endTick==null&&(m.endTick=Math.max(0,Math.floor(this.currentTick))),i(this.activePitch,!1),this.activePitch=null;try{X(this.lastPreview.sampler,this.lastPreview.pitch)}catch{}this.lastPreview.pitch=null}},n={capture:!0,passive:!0},c={capture:!0,passive:!0},a={capture:!0,passive:!0},h={capture:!0},l={capture:!0};if(t)e.addEventListener("touchstart",s,n),e.addEventListener("mousedown",s,h),e.addEventListener("touchmove",o,a),e.addEventListener("mousemove",o,l),e.addEventListener("touchend",r,c),e.addEventListener("mouseup",r,h),this._recPress=s,this._recRelease=r,this._recMove=o,this._recOptsTouchStart=n,this._recOptsTouchEnd=c,this._recOptsTouchMove=a,this._recOptsMouse=h,this._recOptsMouseMove=l;else try{e.removeEventListener("touchstart",this._recPress,this._recOptsTouchStart),e.removeEventListener("mousedown",this._recPress,this._recOptsMouse),e.removeEventListener("touchmove",this._recMove,this._recOptsTouchMove),e.removeEventListener("mousemove",this._recMove,this._recOptsMouseMove),e.removeEventListener("touchend",this._recRelease,this._recOptsTouchEnd),e.removeEventListener("mouseup",this._recRelease,this._recOptsMouse)}catch{}}onPause(){this.isPlaying&&(this.isPlaying=!1,document.body.classList.remove("playing-mode"),S().stop(),this.rafId!==null&&cancelAnimationFrame(this.rafId),this.rafId=null,this.updateTimeDisplay())}onStop(){const t=this.isRecording;this.isRecording=!1,this.isPlaying=!1,this.inRecordPreRoll=!1,document.body.classList.remove("playing-mode"),S().stop(),S().position=0,this.rafId!==null&&cancelAnimationFrame(this.rafId),this.rafId=null,this.currentTick=0,T(async()=>{const{PianorollMobile:e}=await Promise.resolve().then(()=>w);return{PianorollMobile:e}},void 0,import.meta.url).then(({PianorollMobile:e})=>{e.getInstance().setPlayheadTick(0),e.getInstance().setTrailingBars(4)}),this.updateTimeDisplay(),this.hookKeyboardRecording(!1),this.lockKeyboardViewport(!1),document.body.classList.remove("recording-mode"),this.recordBtn?.classList.remove("active"),this.playBtn?.removeAttribute("disabled"),this.pauseBtn?.removeAttribute("disabled"),t&&this.onRecordingStopped()}openRecordVolumeModal(){const t=document.createElement("div");t.className="modal-overlay open";const e=document.createElement("div");e.className="modal",e.style.marginBottom="env(safe-area-inset-bottom, 12px)";const i=document.createElement("div");i.className="modal__header",i.textContent="녹음 볼륨 설정";const s=document.createElement("div");s.className="modal__body";const o=document.createElement("div");o.className="modal__row";const r=document.createElement("label");r.textContent="메트로놈";const n=document.createElement("input");n.type="range",n.min="0",n.max="100",n.value=String(Math.round(this.metroVolume*100)),n.oninput=()=>{this.metroVolume=Math.max(0,Math.min(1,Number(n.value)/100))},o.append(r,n);const c=document.createElement("div");c.className="modal__row";const a=document.createElement("label");a.textContent="반주(다른 트랙)";const h=document.createElement("input");h.type="range",h.min="0",h.max="100",h.value=String(Math.round(this.backingVolume*100)),h.oninput=()=>{this.backingVolume=Math.max(0,Math.min(1,Number(h.value)/100))},c.append(a,h),s.append(o,c);const l=document.createElement("div");l.className="modal__footer";const u=document.createElement("button");u.className="btn",u.textContent="닫기",u.onclick=()=>{t.classList.remove("open"),t.remove()},l.append(u),e.append(i,s,l),t.appendChild(e),document.body.appendChild(t)}scheduleMetronomeAfter(t,e){if(!this.project||!this.metroHigh||!this.metroLow)return;const i=this.project.bpm||this.project.tempo||120,s=Math.max(1,Math.floor(this.project.timeSig?.beatsPerBar||4)),o=this.project?.tempoAnchors||[],r=D(o,i),n=Math.max(this.getGlobalEndTick(),M*64*s);let c=e;for(let a=0,h=0;h<=n;a++,h+=M){const l=t+C(r,h),m=c%s===0?this.metroHigh:this.metroLow;S().schedule(d=>{try{m.start(d)}catch{}},l),c++}}onRecordingStopped(){const t=this.recorded.filter(e=>(e.endTick??0)>(e.startTick||0));t.length!==0&&this.showQuantizeModal(t)}async showQuantizeModal(t){const e=await T(()=>import("./quantizeModal-DfWwqVJC.js"),[],import.meta.url),{PianorollMobile:i}=await T(async()=>{const{PianorollMobile:n}=await Promise.resolve().then(()=>w);return{PianorollMobile:n}},void 0,import.meta.url),s=i.getInstance(),o=(n,c)=>{const a=Math.round(M*(4/n)*(c?.6666666666666666:1)),h=t.filter(d=>(d.endTick??0)>(d.startTick||0)),l=[],u=new Map;for(const d of h){const p=P=>Math.max(0,Math.floor((P+a/2)/a)*a);let f=p(d.startTick),y=d.endTick??d.startTick+a,b=p(y);b<=f&&(b=f+a),!u.has(f)&&(u.set(f,!0),l.push({startTick:f,endTick:b,pitch:d.pitch}))}l.sort((d,p)=>d.startTick-p.startTick);const m=[];for(const d of l){let p=d.startTick,f=d.endTick;if(m.length>0){const y=m[m.length-1],b=y.startTick+y.durationTick;p<b&&(p=b),f<=p&&(f=p+a)}m.push({startTick:p,durationTick:f-p,pitch:d.pitch,color:"#ff7a00"})}s.setPreviewNotes(m)},r=await e.QuantizeModal.open(n=>o(n.gridDenom,n.triplet));s.clearPreviewNotes(),r&&this.commitRecordedNotes(t,r.gridDenom,r.triplet)}commitRecordedNotes(t,e,i){if(!this.project)return;const s=Math.round(M*(4/e)*(i?2/3:1)),o=window.mobileApp,r=o?.getHistory?.(),c=o?.getUIControls?.()?.getSelectedTrackIndex?.()??0,a=this.project.tracks[c],h=t.filter(d=>(d.endTick??0)>(d.startTick||0)),l=new Map,u=[];for(const d of h){const p=P=>Math.max(0,Math.floor((P+s/2)/s)*s);let f=p(d.startTick),y=d.endTick??d.startTick+s,b=p(y);b<=f&&(b=f+s),!l.has(f)&&(l.set(f,!0),u.push({startTick:f,endTick:b,pitch:d.pitch}))}u.sort((d,p)=>d.startTick-p.startTick);const m=[];for(const d of u){let p=d.startTick,f=d.endTick;if(m.length>0){const y=m[m.length-1],b=y.startTick+y.durationTick;p<b&&(p=b),f<=p&&(f=p+s)}m.push({startTick:p,durationTick:f-p,pitch:d.pitch})}if(m.length>0){const d=m[0].startTick,p=m[m.length-1].startTick+m[m.length-1].durationTick;a.notes=a.notes.filter(f=>f.startTick+f.durationTick<=d||f.startTick>=p)}for(const d of m)a.notes.push({id:crypto.randomUUID(),startTick:d.startTick,durationTick:d.durationTick,pitch:d.pitch,volume:15}),this.project.maxEndTick=Math.max(this.project.maxEndTick,d.startTick+d.durationTick);a.notes.sort((d,p)=>d.startTick-p.startTick||d.pitch-p.pitch),T(async()=>{const{PianorollMobile:d}=await Promise.resolve().then(()=>w);return{PianorollMobile:d}},void 0,import.meta.url).then(({PianorollMobile:d})=>{d.getInstance().setProject(this.project)}),r&&this.project&&r.push(this.project);try{T(()=>import("./optimizer-BoRb_Nid.js"),[],import.meta.url).then(d=>d.scheduleOptimizeTrack(this.project,a)).catch(()=>{})}catch{}}getIsPlaying(){return this.isPlaying}getCurrentTick(){return this.currentTick}setCurrentTick(t){this.currentTick=Math.max(0,t|0),T(async()=>{const{PianorollMobile:e}=await Promise.resolve().then(()=>w);return{PianorollMobile:e}},void 0,import.meta.url).then(({PianorollMobile:e})=>{e.getInstance().setPlayheadTick(this.currentTick)}),this.updateTimeDisplay()}}const F=Object.freeze(Object.defineProperty({__proto__:null,TransportMobile:z},Symbol.toStringTag,{value:"Module"}));class ct{project=null;timeSigSelect=null;trackSelect=null;instrumentSelect=null;editPianorollBtn=null;isPianorollEditMode=!1;currentTrackId=0;langButtons=null;currentLanguage="ko";isUpdatingUI=!1;init(){this.timeSigSelect=document.getElementById("timeSigSelect"),this.trackSelect=document.getElementById("trackSelect"),this.instrumentSelect=document.getElementById("instrumentSelect"),this.editPianorollBtn=document.getElementById("btnEditPianoroll"),this.langButtons=document.querySelectorAll(".btn--lang"),this.setupEventListeners(),this.setupInstrumentOptions(),this.updateUI()}setupEventListeners(){this.timeSigSelect?.addEventListener("change",this.onTimeSigChange.bind(this)),this.trackSelect?.addEventListener("change",this.onTrackChange.bind(this)),this.instrumentSelect?.addEventListener("change",this.onInstrumentChange.bind(this)),this.applyLangActive(Q),document.getElementById("langKo")?.addEventListener("click",()=>this.onLangClick("ko")),document.getElementById("langJa")?.addEventListener("click",()=>this.onLangClick("ja")),document.getElementById("langEn")?.addEventListener("click",()=>this.onLangClick("en")),document.getElementById("btnEditPianoroll")?.addEventListener("click",this.editPianoroll.bind(this));const t=document.getElementById("keyHeightRangeMobile"),e=document.getElementById("keyHeightLabel");t?.addEventListener("input",()=>{const m=parseInt(t.value)||24;e&&(e.textContent=`${m}px`),T(async()=>{const{PianorollMobile:d}=await Promise.resolve().then(()=>w);return{PianorollMobile:d}},void 0,import.meta.url).then(({PianorollMobile:d})=>{const p=d.getInstance();if(typeof p.setMinKeyHeight=="function")p.setMinKeyHeight(m);else try{p.minKeyHeight=m}catch{}p.resize()})});const i=document.getElementById("noteLengthSelect");i?.addEventListener("change",()=>{const m=parseInt(i.value)||16;T(async()=>{const{PianorollMobile:d}=await Promise.resolve().then(()=>w);return{PianorollMobile:d}},void 0,import.meta.url).then(({PianorollMobile:d})=>{d.getInstance().setSelectedLength?.(m)})});const s=document.getElementById("btnNoteCreate");s?.addEventListener("click",()=>{s.classList.toggle("active");const m=s.classList.contains("active");T(async()=>{const{PianorollMobile:d}=await Promise.resolve().then(()=>w);return{PianorollMobile:d}},void 0,import.meta.url).then(({PianorollMobile:d})=>{d.getInstance().setNoteCreationMode?.(m)})});const o=document.getElementById("btnVolumeDown"),r=document.getElementById("btnVolumeUp"),n=m=>{T(async()=>{const{PianorollMobile:d}=await Promise.resolve().then(()=>w);return{PianorollMobile:d}},void 0,import.meta.url).then(({PianorollMobile:d})=>{const p=d.getInstance();!p||typeof p.getCurrentTrack!="function"||!(p.getCurrentTrack()||this.project&&this.project.tracks[0])||typeof p.adjustTrackVolume=="function"&&p.adjustTrackVolume(m)})};o?.addEventListener("click",()=>n(-1)),r?.addEventListener("click",()=>n(1));const c=document.getElementById("btnPushBeat"),a=document.getElementById("btnPushBar"),h=document.getElementById("btnCutBeat"),l=document.getElementById("btnCutBar"),u=()=>this.project?.timeSig?.beatsPerBar??4;c?.addEventListener("click",()=>this.shiftRightFromPlayhead(M)),a?.addEventListener("click",()=>this.shiftRightFromPlayhead(M*u())),h?.addEventListener("click",()=>this.cutAndPullFromPlayhead(M)),l?.addEventListener("click",()=>this.cutAndPullFromPlayhead(M*u()))}setupInstrumentOptions(){this.instrumentSelect&&(this.instrumentSelect.innerHTML="",Z().forEach(({value:t,label:e})=>{const i=document.createElement("option");i.value=t,i.textContent=e,this.instrumentSelect.appendChild(i)}))}getCurrentTick(){try{return Math.max(0,Math.floor(window.mobileApp?.getTransport?.().getCurrentTick()??0))}catch{return 0}}normalizeTempoAnchors(t){const e=(t||[]).map(s=>({tick:Math.max(0,Math.floor(s.tick)),bpm:Math.round(s.bpm)}));e.sort((s,o)=>s.tick-o.tick||s.bpm-o.bpm);const i=[];for(const s of e){const o=i[i.length-1];!o||o.tick!==s.tick?i.push(s):i[i.length-1]=s}return i.length>0&&i[0].tick!==0&&(t||[]).some(o=>o.tick<=0)&&i.unshift({tick:0,bpm:i[0].bpm}),i.sort((s,o)=>s.tick-o.tick)}shiftRightFromPlayhead(t){if(!this.project||!Number.isFinite(t)||t===0)return;const e=this.getCurrentTick();for(const s of this.project.tracks){for(const o of s.notes)(o.startTick>=e||o.startTick+o.durationTick>e)&&(o.startTick+=t);s.notes.sort((o,r)=>o.startTick-r.startTick||o.pitch-r.pitch)}const i=this.project.tempoAnchors;if(Array.isArray(i)&&i.length>0){const s=i.map(o=>o.tick>=e?{tick:o.tick+t,bpm:o.bpm}:{...o});this.project.tempoAnchors=this.normalizeTempoAnchors(s)}this.project.maxEndTick+=Math.max(0,t);try{window.mobileApp?.getHistory?.().push(this.project)}catch{}T(()=>import("./optimizer-BoRb_Nid.js"),[],import.meta.url).then(s=>s.scheduleOptimizeAll(this.project)).catch(()=>{}),T(async()=>{const{PianorollMobile:s}=await Promise.resolve().then(()=>w);return{PianorollMobile:s}},void 0,import.meta.url).then(({PianorollMobile:s})=>{s.getInstance().draw?.()}),this.updateTracksPanel()}cutAndPullFromPlayhead(t){if(!this.project||!Number.isFinite(t)||t===0)return;const e=this.getCurrentTick();for(const s of this.project.tracks){const o=[];for(const r of s.notes){const n=r.startTick,c=r.startTick+r.durationTick;if(c<=e)o.push(r);else{if(n>=e&&n<e+t)continue;if(n>=e+t)o.push({...r,startTick:Math.max(e,n-t)});else if(n<e&&c>e){const a=e-n;a>0&&o.push({...r,durationTick:a})}}}o.sort((r,n)=>r.startTick-n.startTick||r.pitch-n.pitch),s.notes=o}const i=this.project.tempoAnchors;if(Array.isArray(i)&&i.length>0){const s=i.filter(o=>!(o.tick>=e&&o.tick<e+t)).map(o=>o.tick>=e+t?{tick:o.tick-t,bpm:o.bpm}:{...o});this.project.tempoAnchors=this.normalizeTempoAnchors(s)}this.project.maxEndTick=Math.max(0,this.project.maxEndTick-t);try{window.mobileApp?.getHistory?.().push(this.project)}catch{}T(()=>import("./optimizer-BoRb_Nid.js"),[],import.meta.url).then(s=>s.scheduleOptimizeAll(this.project)).catch(()=>{}),T(async()=>{const{PianorollMobile:s}=await Promise.resolve().then(()=>w);return{PianorollMobile:s}},void 0,import.meta.url).then(({PianorollMobile:s})=>{s.getInstance().draw?.()}),this.updateTracksPanel()}onTimeSigChange(){if(this.isUpdatingUI||!this.timeSigSelect)return;const t=this.timeSigSelect.value,e=parseInt(t,10);if(this.project&&Number.isFinite(e)&&e>=1){this.project.timeSig={...this.project.timeSig||{beatsPerBar:4},beatsPerBar:e},T(async()=>{const{PianorollMobile:i}=await Promise.resolve().then(()=>w);return{PianorollMobile:i}},void 0,import.meta.url).then(({PianorollMobile:i})=>{i.getInstance().setDisplayBeatsPerBar?.(e)});try{window.mobileApp?.getHistory?.().push(this.project)}catch{}T(()=>import("./optimizer-BoRb_Nid.js"),[],import.meta.url).then(i=>i.scheduleOptimizeAll(this.project)).catch(()=>{})}}onTrackChange(){if(this.isUpdatingUI||!this.trackSelect)return;const t=parseInt(this.trackSelect.value);if(this.currentTrackId=t,this.project&&this.project.tracks[t]){const e=this.project.tracks[t];this.instrumentSelect&&(this.instrumentSelect.value=e.instrument),this.updatePianorollTrack(e)}this.isPianorollEditMode&&this.updateTracksPanel()}updatePianorollTrack(t){const e=window.mobileApp?.pianoroll;e&&typeof e.setCurrentTrack=="function"&&e.setCurrentTrack(t)}onInstrumentChange(){if(this.isUpdatingUI||!this.instrumentSelect||!this.trackSelect)return;const t=parseInt(this.trackSelect.value),e=this.instrumentSelect.value;if(this.project&&this.project.tracks[t]){this.project.tracks[t].instrument=e,this.updatePianorollTrack(this.project.tracks[t]);try{window.mobileApp?.getHistory?.().push(this.project)}catch{}T(()=>import("./optimizer-BoRb_Nid.js"),[],import.meta.url).then(i=>i.scheduleOptimizeTrack(this.project,this.project.tracks[t])).catch(()=>{})}}onLangClick(t){tt(t),this.currentLanguage=t,this.applyLangActive(t),this.setupInstrumentOptions(),this.isPianorollEditMode&&this.updateTracksPanel()}applyLangActive(t){const e=document.getElementById("langKo"),i=document.getElementById("langJa"),s=document.getElementById("langEn");this.langButtons?.forEach(n=>n.classList.remove("active"));const o=t==="ko"?"langKo":t==="ja"?"langJa":"langEn";document.getElementById(o)?.classList.add("active"),e?.setAttribute("role","radio"),i?.setAttribute("role","radio"),s?.setAttribute("role","radio"),e?.setAttribute("aria-checked",String(t==="ko")),i?.setAttribute("aria-checked",String(t==="ja")),s?.setAttribute("aria-checked",String(t==="en"))}editPianoroll(){this.isPianorollEditMode=!this.isPianorollEditMode;const t=document.body;this.editPianorollBtn&&(this.isPianorollEditMode?(this.editPianorollBtn.classList.add("active"),t.classList.add("edit-mode"),this.updateTracksPanel()):(this.editPianorollBtn.classList.remove("active"),t.classList.remove("edit-mode"))),T(async()=>{const{PianorollMobile:e}=await Promise.resolve().then(()=>w);return{PianorollMobile:e}},void 0,import.meta.url).then(({PianorollMobile:e})=>{const i=e.getInstance(),s=()=>{if(this.isPianorollEditMode){const o=document.getElementById("keyHeightRangeMobile"),r=o&&parseInt(o.value)||24;typeof i.setMinKeyHeight=="function"&&i.setMinKeyHeight(r)}i.resize()};s(),requestAnimationFrame(()=>requestAnimationFrame(s))})}updateTracksPanel(){const t=document.getElementById("tracks");if(!t||!this.project)return;t.innerHTML="";const e=this.project;e.tracks.slice().sort((s,o)=>s.order-o.order).forEach(s=>{const o=e.tracks.indexOf(s),r=document.createElement("div");r.className="track-card",o===this.currentTrackId&&r.classList.add("is-active");const n=document.createElement("div");n.className="track-color",n.style.backgroundColor=s.color||"#3a7afe";const c=document.createElement("div");c.className="track-main";const a=document.createElement("div");a.className="track-row";const h=document.createElement("div");h.className="track-name";const l=document.createElement("input");if(l.value=s.name||`Track ${o+1}`,l.addEventListener("change",()=>{if(s.name=l.value,this.trackSelect){const g=this.trackSelect.options[o];g&&(g.text=s.name)}}),h.appendChild(l),o===this.currentTrackId){const g=document.createElement("div");g.className="track-reorder",g.style.marginLeft="auto",g.style.display="inline-flex",g.style.gap="6px";const k=document.createElement("button");k.type="button",k.textContent="▲",k.title="Move up",k.setAttribute("aria-label","Move track up"),k.style.width="24px",k.style.height="24px",k.style.fontSize="12px";const v=document.createElement("button");v.type="button",v.textContent="▼",v.title="Move down",v.setAttribute("aria-label","Move track down"),v.style.width="24px",v.style.height="24px",v.style.fontSize="12px";const x=e.tracks.length-1,I=e.tracks[o];k.disabled=I.order===0,v.disabled=I.order===x,k.addEventListener("click",A=>{A.stopPropagation(),this.reorderActiveTrack(-1)}),v.addEventListener("click",A=>{A.stopPropagation(),this.reorderActiveTrack(1)}),g.append(k,v),a.appendChild(g)}const u=document.createElement("div");u.className="track-instrument";const m=document.createElement("select");et.forEach(g=>{const k=document.createElement("option");k.value=g,k.textContent=it(g,this.currentLanguage),s.instrument===g&&(k.selected=!0),m.appendChild(k)}),m.addEventListener("change",()=>{s.instrument=m.value,this.instrumentSelect&&this.currentTrackId===o&&(this.instrumentSelect.value=s.instrument),this.updatePianorollTrack(s)}),u.appendChild(m),a.append(h);const d=document.createElement("div");d.className="track-row track-row--bottom";const p=document.createElement("div");p.className="track-controls";const f=document.createElement("button");f.textContent="M",f.title=N[this.currentLanguage].tooltipMute,f.setAttribute("data-i18n-title","tooltipMute"),f.setAttribute("data-kind","mute");const y=document.createElement("button");y.textContent="S",y.title=N[this.currentLanguage].tooltipSolo,y.setAttribute("data-i18n-title","tooltipSolo"),y.setAttribute("data-kind","solo"),f.classList.toggle("is-active",!!s.mute),y.classList.toggle("is-active",!!s.solo),f.addEventListener("click",g=>{g.stopPropagation(),s.mute=!s.mute,f.classList.toggle("is-active",!!s.mute),this.refreshAfterTrackStateChange()}),y.addEventListener("click",g=>{g.stopPropagation(),s.solo=!s.solo,y.classList.toggle("is-active",!!s.solo),this.refreshAfterTrackStateChange()}),p.append(f,y);const b=document.createElement("div");b.className="track-charcount";const _=N[this.currentLanguage].charUnit,B=(s.optimizedMML?.trim?.()||s.mmlString?.trim?.()||"").length;b.textContent=`${B}${_}`,b.setAttribute("data-i18n-title","tooltipCharCount"),b.title=N[this.currentLanguage].tooltipCharCount,d.append(p,b),c.append(a,u,d),r.append(n,c),r.addEventListener("click",()=>this.selectTrack(o)),t.appendChild(r)})}reorderActiveTrack(t){if(!this.project)return;const e=this.project.tracks[this.currentTrackId];if(!e)return;const i=e.order,s=this.project.tracks.length-1,o=i+t;if(o<0||o>s)return;const r=this.project.tracks.find(n=>n.order===o);r&&(e.order=o,r.order=i);try{window.mobileApp?.getHistory?.().push(this.project)}catch{}T(()=>import("./optimizer-BoRb_Nid.js"),[],import.meta.url).then(n=>n.scheduleOptimizeAll(this.project)).catch(()=>{}),T(async()=>{const{PianorollMobile:n}=await Promise.resolve().then(()=>w);return{PianorollMobile:n}},void 0,import.meta.url).then(({PianorollMobile:n})=>{n.getInstance().draw?.()}),this.updateTracksPanel()}refreshAfterTrackStateChange(){try{window.mobileApp?.getHistory?.().push(this.project)}catch{}T(async()=>{const{PianorollMobile:t}=await Promise.resolve().then(()=>w);return{PianorollMobile:t}},void 0,import.meta.url).then(({PianorollMobile:t})=>{t.getInstance().draw?.()}),this.updateTracksPanel()}selectTrack(t){if(t!==this.currentTrackId){if(this.currentTrackId=t,this.trackSelect&&(this.trackSelect.value=t.toString()),this.updateTracksPanel(),this.project&&this.project.tracks&&this.project.tracks[t]){const e=this.project.tracks[t];this.instrumentSelect&&e.instrument&&(this.instrumentSelect.value=e.instrument)}this.updatePianorollForTrack(t)}}updatePianorollForTrack(t){if(!this.project)return;const e=this.project.tracks[t];e&&this.updatePianorollTrack(e)}updateUI(){if(this.project){if(this.isUpdatingUI=!0,this.timeSigSelect){const t=this.project?.timeSig?.beatsPerBar,e=Number.isFinite(t)&&t>=1?String(Math.floor(t)):"4";this.timeSigSelect.value=e}this.trackSelect&&(this.trackSelect.innerHTML="",this.project.tracks.forEach((t,e)=>{const i=document.createElement("option");if(i.value=e.toString(),t.name&&t.name.trim().length>0)i.textContent=t.name;else{const o=N[this.currentLanguage].track||"Track";i.textContent=`${o} ${e+1}`}this.trackSelect.appendChild(i)})),this.instrumentSelect&&this.project.tracks.length>0&&(this.instrumentSelect.value=this.project.tracks[0].instrument),this.isUpdatingUI=!1}}setProject(t){this.project=t,this.updateUI(),this.project&&this.project.tracks&&this.project.tracks.length>0&&(this.currentTrackId=0,this.trackSelect&&(this.trackSelect.value="0"),this.updatePianorollTrack(this.project.tracks[0]))}refreshTracksPanel(){this.updateTracksPanel()}getCurrentLanguage(){return this.currentLanguage}getCurrentTrackId(){return this.currentTrackId}getSelectedTrackIndex(){return this.trackSelect&&parseInt(this.trackSelect.value)||0}getSelectedInstrument(){return this.instrumentSelect?this.instrumentSelect.value:"lute"}}class at{project=null;pianoroll;transport;uiControls;history=new st;constructor(){this.pianoroll=L.getInstance(),this.transport=new z,this.uiControls=new ct,this.setupEventListeners(),this.initializeComponents(),this.loadDefaultProject()}setupEventListeners(){document.getElementById("btnDesktop")?.addEventListener("click",this.goToDesktop.bind(this)),document.getElementById("btnGuide")?.addEventListener("click",this.showGuide.bind(this)),document.getElementById("btnLoad")?.addEventListener("click",this.loadProject.bind(this)),document.getElementById("btnPasteMML")?.addEventListener("click",this.pasteMML.bind(this)),document.getElementById("btnConvert")?.addEventListener("click",this.convert.bind(this)),document.getElementById("btnUndo")?.addEventListener("click",()=>{if(!this.project)return;const t=this.history.undo(this.project);t&&this.setProject(t)}),document.getElementById("btnRedo")?.addEventListener("click",()=>{if(!this.project)return;const t=this.history.redo(this.project);t&&this.setProject(t)})}initializeComponents(){this.pianoroll.init(),this.transport.init(),this.uiControls.init(),T(async()=>{const{KeyboardMobile:t}=await Promise.resolve().then(()=>G);return{KeyboardMobile:t}},void 0,import.meta.url).then(({KeyboardMobile:t})=>{t.getInstance().init()})}loadDefaultProject(){if(this.project=this.createDefaultProject(),this.updateComponents(),this.project){this.history.push(this.project);try{this.history.setPersistKey("mml_editor_project")}catch{}}}createDefaultProject(){const t=ot();return t.maxEndTick=0,t}updateComponents(){this.project&&(this.pianoroll.setProject(this.project),this.transport.setProject(this.project),this.uiControls.setProject(this.project))}goToDesktop(){window.location.href="./"}showGuide(){T(async()=>{const{showGuideModal:t}=await import("./guideModal-DTHVvsmR.js");return{showGuideModal:t}},__vite__mapDeps([2,3,1]),import.meta.url).then(({showGuideModal:t})=>t("mobile")).catch(()=>alert("가이드를 열 수 없습니다."))}loadProject(){try{const t=localStorage.getItem("mml_editor_project");if(!t){alert("저장된 프로젝트가 없습니다.");return}const e=JSON.parse(t);if(!e||!e.tracks){alert("저장 데이터 형식이 올바르지 않습니다.");return}const i=e;this.setProject(i),this.project&&this.history.push(this.project),alert("저장된 프로젝트를 불러왔습니다.")}catch{alert("불러오기에 실패했습니다.")}}pasteMML(){(async()=>{if(this.project)try{const i=(await navigator.clipboard.readText()||"").trim();if(!i.startsWith("MML@")){alert("MML 형식이 아닙니다.");return}const o=i.substring(4).replace(/\r?\n/g,"").replace(/;+$/g,"").split(",").map(h=>h.replace(/;+$/g,"").trim());if(o.length>this.project.tracks.length){alert("트랙은 최대 6개까지만 지원합니다.");return}const{mmlToNotes:r,extractTempoAnchorsFromMMLBodies:n}=await T(async()=>{const{mmlToNotes:h,extractTempoAnchorsFromMMLBodies:l}=await import("./converter-Bxff0mca.js");return{mmlToNotes:h,extractTempoAnchorsFromMMLBodies:l}},__vite__mapDeps([4,1]),import.meta.url);try{const h=n(o,this.project.bpm);this.project.tempoAnchors=h,h.length>0&&h[0].tick===0&&Number.isFinite(h[0].bpm)&&(this.project.bpm=h[0].bpm,this.project.tempo=h[0].bpm)}catch{}let c=null;for(let h=0;h<this.project.tracks.length;h++){const l=this.project.tracks[h],m=((o[h]?o[h]:"")||"").replace(/\r?\n/g,"").trim();l.mmlString=m;try{const d=m.match(/^t(\d+)/);d&&h===0&&(c=parseInt(d[1],10)),l.notes=r("MML@"+m)}catch{l.notes=[]}}c&&Number.isFinite(c)&&(this.project.bpm=c,this.project.tempo=c);let a=0;for(const h of this.project.tracks)for(const l of h.notes)a=Math.max(a,l.startTick+l.durationTick);this.project.maxEndTick=a;try{this.pianoroll.recomputeVolumeLabelsForAllTracks(this.project)}catch{}this.updateComponents(),this.history.push(this.project),T(()=>import("./optimizer-BoRb_Nid.js"),[],import.meta.url).then(h=>h.scheduleOptimizeAll(this.project)).catch(()=>{}),alert("MML을 붙여넣었습니다.")}catch{alert("MML 붙여넣기에 실패했습니다.")}})()}convert(){(async()=>{if(this.project)try{(await T(()=>import("./convertModal-BoFIxvxa.js"),__vite__mapDeps([5,3,1,4]),import.meta.url)).showConvertModal(this.project)}catch{alert("변환 창을 열 수 없습니다.")}})()}getProject(){return this.project}setProject(t){this.project=t,this.updateComponents()}getUIControls(){return this.uiControls}getPianoroll(){return this.pianoroll}getTransport(){return this.transport}getHistory(){return this.history}}class H{static instance=null;container=null;keyboard=null;scrollbar=null;scrollbarThumb=null;currentScrollPosition=0;maxScrollPosition=0;containerWidth=0;visibleKeyCount=0;startKeyIndex=0;renderedKeys=[];noteNames=nt;whiteKeyPattern=[0,2,4,5,7,9,11];totalOctaves=7;startOctave=1;totalWhiteKeys=this.totalOctaves*7;isDragging=!1;dragStartX=0;thumbStartX=0;keyWidth=60;lastPlayed={pitch:null,sampler:null};activeKeyEl=null;isMouseDown=!1;viewportLocked=!1;static getInstance(){return this.instance||(this.instance=new H),this.instance}init(){this.container=document.getElementById("keyboardContainer"),this.keyboard=document.getElementById("keyboard"),this.scrollbar=document.getElementById("keyboardScrollbar"),this.scrollbarThumb=document.getElementById("scrollbarThumb"),!(!this.container||!this.keyboard||!this.scrollbar||!this.scrollbarThumb)&&(this.createKeyboard(),this.setupScrollbar(),this.setupTouchControls(),this.setupGlissPreview())}createKeyboard(){if(!this.keyboard||!this.container)return;this.containerWidth=this.container.offsetWidth,this.visibleKeyCount=Math.ceil(this.containerWidth/this.keyWidth)+2;const t=this.totalWhiteKeys*this.keyWidth;this.keyboard.style.width=`${t}px`,this.maxScrollPosition=Math.max(0,t-this.containerWidth),this.currentScrollPosition=14*this.keyWidth,this.renderVisibleKeys(),this.updateKeyboardScroll()}renderVisibleKeys(){if(!this.keyboard)return;this.startKeyIndex=Math.max(0,Math.floor(this.currentScrollPosition/this.keyWidth)-1);const t=Math.min(this.startKeyIndex+this.visibleKeyCount,this.totalWhiteKeys);this.keyboard.innerHTML="",this.renderedKeys=[];for(let e=this.startKeyIndex;e<t;e++)this.createSingleKey(e);this.keyboard.style.transform=`translateX(-${this.currentScrollPosition}px)`}createSingleKey(t){if(!this.keyboard)return;const e=Math.floor(t/7),i=t%7,s=this.startOctave+e,o=this.whiteKeyPattern[i],r=e*12+o+this.startOctave*12,n=document.createElement("div");if(n.className="key white",n.dataset.note=r.toString(),n.dataset.octave=s.toString(),n.dataset.noteName=this.noteNames[o],o===0){const c=document.createElement("span");c.className="key-label",c.textContent=`O${s}`,n.appendChild(c)}n.style.left=`${t*this.keyWidth}px`,this.addKeyEvents(n),this.keyboard.appendChild(n),this.renderedKeys.push(n),this.createBlackKeys(t,e,s)}createBlackKeys(t,e,i){if(!this.keyboard)return;const s=t%7,r=[{after:0,noteIndex:1},{after:1,noteIndex:3},{after:3,noteIndex:6},{after:4,noteIndex:8},{after:5,noteIndex:10}].find(h=>h.after===s);if(!r)return;const n=e*12+r.noteIndex+this.startOctave*12,c=document.createElement("div");c.className="key black",c.dataset.note=n.toString(),c.dataset.octave=i.toString(),c.dataset.noteName=this.noteNames[r.noteIndex];const a=(t+1)*this.keyWidth-36/2;c.style.left=`${a}px`,this.addKeyEvents(c),this.keyboard.appendChild(c),this.renderedKeys.push(c)}addKeyEvents(t){t.addEventListener("touchstart",this.handleKeyPress.bind(this),{passive:!1}),t.addEventListener("touchend",this.handleKeyRelease.bind(this),{passive:!1}),t.addEventListener("mousedown",this.handleKeyPress.bind(this)),t.addEventListener("mouseup",this.handleKeyRelease.bind(this)),t.addEventListener("mouseleave",this.handleKeyRelease.bind(this))}handleKeyPress(t){t.preventDefault();const e=t.target;e.classList.add("pressed"),this.activeKeyEl=e,this.isMouseDown=t.buttons?(t.buttons&1)===1:this.isMouseDown;const i=e.dataset.note;if(!!!window.mobileApp?.getTransport?.()?.isRecordingActive?.()){const c=parseInt(i||"0");this.playNote(c)}}handleKeyRelease(t){t.preventDefault();const e=t.target;if(e.classList.remove("pressed"),this.activeKeyEl&&this.activeKeyEl!==e)try{this.activeKeyEl.classList.remove("pressed")}catch{}if(this.activeKeyEl=null,this.isMouseDown=!1,!!!window.mobileApp?.getTransport?.()?.isRecordingActive?.()){try{X(this.lastPlayed.sampler,this.lastPlayed.pitch)}catch{}this.lastPlayed.pitch=null}}playNote(t){const e=window.mobileApp,i=e?.getProject?.()||null,s=e&&typeof e.getUIControls=="function"?e.getUIControls():null,o=s?.getSelectedTrackIndex?.()??0;let r="piano",n=o;if(i&&i.tracks&&i.tracks[o]){const c=i.tracks[o];r=c.instrument||r,typeof c.id=="number"&&(n=c.id)}else s?.getSelectedInstrument&&(r=s.getSelectedInstrument()||r);K(t,n,r,this.lastPlayed)}setupGlissPreview(){this.container&&(this.container.addEventListener("mousedown",()=>{this.isMouseDown=!0}),document.addEventListener("mouseup",()=>{this.isMouseDown=!1,this.stopPreviewIfAny()}),this.container.addEventListener("mousemove",t=>{this.isMouseDown&&this.handleGlissPoint(t.clientX,t.clientY)}),this.container.addEventListener("touchmove",t=>{if(!!window.mobileApp?.getTransport?.()?.isRecordingActive?.()||t.touches.length!==1)return;const o=t.touches[0];this.handleGlissPoint(o.clientX,o.clientY),t.preventDefault()},{passive:!1}),this.container.addEventListener("touchend",()=>{this.stopPreviewIfAny()},{passive:!0}),this.container.addEventListener("touchcancel",()=>{this.stopPreviewIfAny()},{passive:!0}))}handleGlissPoint(t,e){if(!!window.mobileApp?.getTransport?.()?.isRecordingActive?.())return;const n=document.elementFromPoint(t,e)?.closest?.(".key");if(!n)return;if(this.activeKeyEl!==n){try{this.activeKeyEl?.classList.remove("pressed")}catch{}n.classList.add("pressed"),this.activeKeyEl=n}const c=n.dataset.note;if(!c)return;const a=parseInt(c,10);Number.isFinite(a)&&this.lastPlayed.pitch!==a&&this.playNote(a)}stopPreviewIfAny(){if(!!!window.mobileApp?.getTransport?.()?.isRecordingActive?.()){try{X(this.lastPlayed.sampler,this.lastPlayed.pitch)}catch{}this.lastPlayed.pitch=null}if(this.activeKeyEl){try{this.activeKeyEl.classList.remove("pressed")}catch{}this.activeKeyEl=null}}snapToKey(t){const e=Math.round(t/this.keyWidth)*this.keyWidth;return Math.max(0,Math.min(e,this.maxScrollPosition))}setupScrollbar(){!this.scrollbar||!this.scrollbarThumb||(this.scrollbar.addEventListener("click",t=>{if(this.viewportLocked){t.preventDefault();return}if(t.target===this.scrollbarThumb)return;const e=this.scrollbar.getBoundingClientRect(),i=t.clientX-e.left,s=e.width,o=this.scrollbarThumb.offsetWidth,r=s-o,c=Math.min(Math.max(i-o/2,0),r)/r*this.maxScrollPosition;this.currentScrollPosition=this.snapToKey(c),this.renderVisibleKeys(),this.updateScrollbarThumb()}),this.scrollbarThumb.addEventListener("mousedown",t=>{if(this.viewportLocked){t.preventDefault();return}this.isDragging=!0,this.dragStartX=t.clientX,this.thumbStartX=this.scrollbarThumb.offsetLeft,t.preventDefault()}),this.scrollbarThumb.addEventListener("touchstart",t=>{if(this.viewportLocked){t.preventDefault();return}this.isDragging=!0,this.dragStartX=t.touches[0].clientX,this.thumbStartX=this.scrollbarThumb.offsetLeft,t.preventDefault()},{passive:!1}),document.addEventListener("mousemove",t=>{this.viewportLocked||this.isDragging&&this.handleThumbDrag(t.clientX)}),document.addEventListener("touchmove",t=>{this.viewportLocked||this.isDragging&&this.handleThumbDrag(t.touches[0].clientX)},{passive:!0}),document.addEventListener("mouseup",()=>{if(this.viewportLocked){this.isDragging=!1;return}this.isDragging&&(this.isDragging=!1,this.currentScrollPosition=this.snapToKey(this.currentScrollPosition),this.renderVisibleKeys(),this.updateScrollbarThumb())}),document.addEventListener("touchend",()=>{if(this.viewportLocked){this.isDragging=!1;return}this.isDragging&&(this.isDragging=!1,this.currentScrollPosition=this.snapToKey(this.currentScrollPosition),this.renderVisibleKeys(),this.updateScrollbarThumb())},{passive:!0}),this.updateScrollbarThumb())}handleThumbDrag(t){if(!this.scrollbar||!this.scrollbarThumb||this.viewportLocked)return;const e=t-this.dragStartX,i=this.thumbStartX+e,s=this.scrollbar.offsetWidth,o=this.scrollbarThumb.offsetWidth,r=s-o,n=Math.min(Math.max(i,0),r);this.currentScrollPosition=n/r*this.maxScrollPosition,this.keyboard&&(this.currentScrollPosition=Math.max(0,Math.min(this.currentScrollPosition,this.maxScrollPosition)),this.renderVisibleKeys(),this.updateScrollbarThumb())}updateScrollbarThumb(){if(!this.scrollbar||!this.scrollbarThumb)return;const t=this.scrollbar.offsetWidth,e=this.scrollbarThumb.offsetWidth,i=t-e,s=this.currentScrollPosition/this.maxScrollPosition*i;this.scrollbarThumb.style.left=`${s}px`}setupTouchControls(){if(!this.container)return;let t=0,e=!1;this.container.addEventListener("touchstart",i=>{if(!this.viewportLocked&&i.touches.length===1){const s=i.touches[0],o=this.container.getBoundingClientRect(),r=s.clientX-o.left;(r<20||r>o.width-20)&&(e=!0,t=s.clientX,i.preventDefault())}},{passive:!1}),this.container.addEventListener("touchmove",i=>{if(!this.viewportLocked&&e&&i.touches.length===1){const s=i.touches[0],o=s.clientX-t;this.currentScrollPosition-=o*2,this.currentScrollPosition=Math.max(0,Math.min(this.currentScrollPosition,this.maxScrollPosition)),this.renderVisibleKeys(),this.updateScrollbarThumb(),t=s.clientX,i.preventDefault()}},{passive:!1}),this.container.addEventListener("touchend",i=>{if(this.viewportLocked){e=!1;return}i.touches.length===0&&(e=!1)},{passive:!0})}setViewportLocked(t){this.viewportLocked=!!t,this.viewportLocked&&(this.isDragging=!1);try{this.scrollbar&&(this.scrollbar.style.pointerEvents=this.viewportLocked?"none":""),this.scrollbarThumb&&(this.scrollbarThumb.style.pointerEvents=this.viewportLocked?"none":""),this.container&&this.container.classList.toggle("viewport-locked",this.viewportLocked)}catch{}}updateKeyboardScroll(){if(!this.keyboard)return;this.currentScrollPosition=Math.max(0,Math.min(this.currentScrollPosition,this.maxScrollPosition));const t=Math.max(0,Math.floor(this.currentScrollPosition/this.keyWidth)-1);Math.abs(t-this.startKeyIndex)>=1&&this.renderVisibleKeys(),this.keyboard.style.transform=`translateX(-${this.currentScrollPosition}px)`,this.updateScrollbarThumb()}resize(){if(this.container){this.containerWidth=this.container.offsetWidth,this.visibleKeyCount=Math.ceil(this.containerWidth/this.keyWidth)+2;const t=this.totalWhiteKeys*this.keyWidth;this.maxScrollPosition=Math.max(0,t-this.containerWidth),this.currentScrollPosition=Math.min(this.currentScrollPosition,this.maxScrollPosition)}this.renderVisibleKeys()}getCurrentOctave(){return Math.floor(this.currentScrollPosition/(7*this.keyWidth))+1}scrollToOctave(t){const e=Math.max(0,(t-1)*7*this.keyWidth);this.currentScrollPosition=Math.min(e,this.maxScrollPosition),this.updateKeyboardScroll()}}const G=Object.freeze(Object.defineProperty({__proto__:null,KeyboardMobile:H},Symbol.toStringTag,{value:"Module"}));document.addEventListener("DOMContentLoaded",function(){setTimeout(()=>{try{T(()=>import("./languages-Cgt_gsPd.js").then(E=>E.O),[],import.meta.url).then(E=>E.setLanguage(E.currentLang)).catch(()=>{})}catch{}window.mobileApp=new at},100)});window.addEventListener("resize",()=>{const E=L.getInstance(),t=H.getInstance();E?.resize(),t?.resize()});(()=>{const E=()=>{try{rt()}catch{}finally{window.removeEventListener("pointerdown",E),window.removeEventListener("touchend",E),window.removeEventListener("keydown",E)}};window.addEventListener("pointerdown",E,{passive:!0}),window.addEventListener("touchend",E,{passive:!0}),window.addEventListener("keydown",E)})();
