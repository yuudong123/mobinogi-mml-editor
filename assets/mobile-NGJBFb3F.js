const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./tempoModal-1xZMLwS0.js","./timeline-CN1gSxtj.js","./converter-93tpuols.js"])))=>i.map(i=>d[i]);
import{T as v,p as I,S as x,j as T,i as B,_ as k,g as E,h as N,n as _,m as R,I as L,H as C,c as D,N as H}from"./timeline-CN1gSxtj.js";class P{static instance=null;static getInstance(){return this.instance||(this.instance=new P),this.instance}canvas=null;timeRulerCanvas=null;playhead=null;project=null;currentTrack=null;pxPerBeat=96;minPxPerBeat=24;maxPxPerBeat=192;keyHeight=24;minKeyHeight=24;scrollX=0;scrollY=0;playheadTick=0;trailingBars=4;displayBeatsPerBar=4;editLeftGutter=44;minPitch=60;maxPitch=72;noteRange=13;isDragging=!1;lastX=0;isPinching=!1;initialPinchDistance=0;lastPxPerBeat=0;lastCenterX=0;lastCenterY=0;vScrollBarMargin=3;vScrollBarWidth=8;vScrollThumbMin=36;isVScrollDragging=!1;vScrollDragOffsetY=0;previewNotes=[];selection=new Set;selectingRect=null;isNoteCreationMode=!1;dragMode="none";dragStart={x:0,y:0};dragNoteAnchor=null;longPressTimer=null;hitNoteId=null;tempNote=null;init(){this.canvas=document.getElementById("pianorollCanvas"),this.timeRulerCanvas=document.getElementById("timeRulerCanvas"),this.playhead=document.getElementById("playhead");const t=document.querySelector(".pianoroll-main");!this.canvas||!this.timeRulerCanvas||!t||(t.addEventListener("mousedown",e=>this.onMouseDown(e)),document.addEventListener("mousemove",e=>this.onMouseMove(e)),document.addEventListener("mouseup",()=>this.onMouseUp()),t.addEventListener("wheel",e=>this.onWheel(e),{passive:!1}),t.addEventListener("touchstart",e=>this.onTouchStart(e),{passive:!1}),t.addEventListener("touchmove",e=>this.onTouchMove(e),{passive:!1}),t.addEventListener("touchend",e=>this.onTouchEnd(e)),this.resize())}getPxPerBeat(){return this.pxPerBeat}setMinKeyHeight(t){const e=Math.max(1,Math.min(64,Math.floor(t)));e!==this.minKeyHeight&&(this.minKeyHeight=e,this.resize())}setTrailingBars(t){const e=Math.max(0,Math.floor(t));e!==this.trailingBars&&(this.trailingBars=e,this.clampScrollToBounds(),this.draw())}setDisplayBeatsPerBar(t){const e=Math.max(1,Math.floor(t));e!==this.displayBeatsPerBar&&(this.displayBeatsPerBar=e,this.clampScrollToBounds(),this.draw())}setNoteCreationMode(t){this.isNoteCreationMode=!!t}setSelectedLength(t){this.project&&(this.project.selectedLength=t)}setProject(t){this.project=t;const e=this.project?.timeSig?.beatsPerBar;Number.isFinite(e)&&e>=1&&(this.displayBeatsPerBar=Math.floor(e)),this.updateNoteRange(),this.clampScrollToBounds(),this.draw()}setCurrentTrack(t){this.currentTrack=t,this.draw()}getCurrentTrack(){return this.currentTrack}setPreviewNotes(t){if(this.previewNotes=Array.isArray(t)?t:[],this.updateNoteRange(),document.body.classList.contains("edit-mode")&&this.canvas&&this.previewNotes.length>0){const e=this.canvas.clientHeight,i=Math.min(...this.previewNotes.map(h=>h.pitch)),n=95-Math.max(...this.previewNotes.map(h=>h.pitch)),r=95-i,o=n*this.keyHeight,c=(r+1)*this.keyHeight-o,l=Math.max(0,o-Math.max(0,(e-c)/2));this.scrollY=l}this.clampScrollToBounds(),this.draw()}clearPreviewNotes(){this.previewNotes=[],this.updateNoteRange(),this.clampScrollToBounds(),this.draw()}setPlayheadPosition(t){this.updatePlayhead()}setPlayheadTick(t){this.playheadTick=Math.max(0,t|0),this.updatePlayhead()}onMouseDown(t){const e=document.body.classList.contains("edit-mode"),i=this.canvas;if(e&&i){const s=i.clientWidth,n=i.clientHeight,r=84*this.keyHeight;if(r>n){const o=s-this.vScrollBarMargin-this.vScrollBarWidth;if(t.offsetX>=o){const{thumbY:a,thumbH:c}=this.computeVScrollThumb(n,r),l=t.offsetY;this.isVScrollDragging=!0,this.vScrollDragOffsetY=Math.min(Math.max(0,l-a),c),t.preventDefault();return}}}if(e&&i){const s=this.hitTestNote(t.offsetX,t.offsetY);if(s){const{id:n,mode:r}=s;this.hitNoteId=n,this.selection.has(n)||(this.selection.clear(),this.selection.add(n)),this.dragMode=r,this.dragStart={x:t.clientX,y:t.clientY};const o=this.findNoteById(n);o&&(this.dragNoteAnchor={tick:o.startTick,pitch:o.pitch,len:o.durationTick}),this.longPressTimer&&clearTimeout(this.longPressTimer),this.longPressTimer=setTimeout(()=>{this.showVolumeModalForSelection()},600),t.preventDefault()}else if(this.isNoteCreationMode){const n=i.getBoundingClientRect(),r=t.clientX-n.left,o=t.clientY-n.top;this.beginCreateTempNote(r,o),t.preventDefault()}else{const n=i.getBoundingClientRect(),r=t.clientX-n.left,o=t.clientY-n.top;this.longPressTimer&&clearTimeout(this.longPressTimer),this.dragStart={x:t.clientX,y:t.clientY},this.longPressTimer=setTimeout(()=>{this.selectingRect={x0:r,y0:o,x1:r,y1:o},this.dragMode="marquee",this.draw()},350)}}this.isDragging=!0,this.lastX=t.clientX,t.preventDefault()}onMouseMove(t){const e=this.canvas;if(!e)return;if(this.isVScrollDragging){const s=e.clientHeight,n=84*this.keyHeight,{thumbH:r}=this.computeVScrollThumb(s,n),o=Math.max(0,s-r),a=Math.min(Math.max(0,t.offsetY-this.vScrollDragOffsetY),o),c=Math.max(0,n-s);this.scrollY=o>0?a/o*c:0,this.clampScrollToBounds(),this.draw();return}if(document.body.classList.contains("edit-mode")){if(Math.hypot(t.clientX-this.dragStart.x,t.clientY-this.dragStart.y)>4&&this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.dragMode==="marquee"&&this.selectingRect){const n=e.getBoundingClientRect();this.selectingRect.x1=t.clientX-n.left,this.selectingRect.y1=t.clientY-n.top,this.draw();return}if(this.dragMode!=="none"){const n=t.clientX-this.dragStart.x,r=t.clientY-this.dragStart.y;this.applyDragToSelection(n,r),this.draw();return}}if(!this.isDragging)return;const i=t.clientX-this.lastX;this.scrollX-=i,this.clampScrollToBounds(),this.lastX=t.clientX,this.draw()}onMouseUp(){if(this.isDragging=!1,this.isVScrollDragging=!1,this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),document.body.classList.contains("edit-mode")){if(this.dragMode==="marquee"&&this.selectingRect){this.performMarqueeSelection(),this.selectingRect=null,this.dragMode="none",this.draw();return}if(this.dragMode!=="none"&&this.dragNoteAnchor){this.commitEditedNotes(),this.dragMode="none",this.dragNoteAnchor=null,this.hitNoteId=null;return}!this.selectingRect&&!this.isNoteCreationMode&&(this.selection.clear(),this.draw())}}onWheel(t){t.preventDefault(),t.deltaY<0?this.zoomIn():this.zoomOut()}onTouchStart(t){if(t.touches.length===1){const e=document.body.classList.contains("edit-mode"),i=this.canvas;if(e&&i){const s=i.getBoundingClientRect(),n=i.clientWidth,r=i.clientHeight,o=84*this.keyHeight,a=t.touches[0].clientX-s.left,c=t.touches[0].clientY-s.top;if(o>r){const h=n-this.vScrollBarMargin-this.vScrollBarWidth;if(a>=h){const{thumbY:u,thumbH:m}=this.computeVScrollThumb(r,o);this.isVScrollDragging=!0,this.vScrollDragOffsetY=Math.min(Math.max(0,c-u),m),t.preventDefault();return}}const l=this.hitTestNote(a,c);if(l){const{id:h,mode:u}=l;this.hitNoteId=h,this.selection.has(h)||(this.selection.clear(),this.selection.add(h)),this.dragMode=u,this.dragStart={x:t.touches[0].clientX,y:t.touches[0].clientY};const m=this.findNoteById(h);m&&(this.dragNoteAnchor={tick:m.startTick,pitch:m.pitch,len:m.durationTick}),this.longPressTimer&&clearTimeout(this.longPressTimer),this.longPressTimer=setTimeout(()=>{this.showVolumeModalForSelection()},600),t.preventDefault()}else this.isNoteCreationMode?(this.beginCreateTempNote(a,c),t.preventDefault()):(this.dragMode="none",this.longPressTimer&&clearTimeout(this.longPressTimer),this.dragStart={x:t.touches[0].clientX,y:t.touches[0].clientY},this.longPressTimer=setTimeout(()=>{this.selectingRect={x0:a,y0:c,x1:a,y1:c},this.dragMode="marquee",this.draw()},350))}this.isDragging=!0,this.lastX=t.touches[0].clientX,t.preventDefault()}else if(t.touches.length===2){this.isPinching=!0,this.isDragging=!1;const e=t.touches[0],i=t.touches[1];this.initialPinchDistance=Math.hypot(i.clientX-e.clientX,i.clientY-e.clientY),this.lastPxPerBeat=this.pxPerBeat,this.lastCenterX=(e.clientX+i.clientX)/2,this.lastCenterY=(e.clientY+i.clientY)/2,t.preventDefault()}}onTouchMove(t){if(this.isVScrollDragging&&t.touches.length===1){const e=this.canvas;if(!e)return;const i=e.getBoundingClientRect(),s=e.clientHeight,n=84*this.keyHeight,r=t.touches[0].clientY-i.top,{thumbH:o}=this.computeVScrollThumb(s,n),a=Math.max(0,s-o),c=Math.min(Math.max(0,r-this.vScrollDragOffsetY),a),l=Math.max(0,n-s);this.scrollY=a>0?c/a*l:0,this.clampScrollToBounds(),this.draw(),t.preventDefault();return}if(this.isDragging&&t.touches.length===1){if(document.body.classList.contains("edit-mode")){const i=t.touches[0].clientX-this.dragStart.x,s=t.touches[0].clientY-this.dragStart.y;if(this.dragMode==="marquee"&&this.selectingRect){const r=this.canvas.getBoundingClientRect();this.selectingRect.x1=t.touches[0].clientX-r.left,this.selectingRect.y1=t.touches[0].clientY-r.top,this.draw(),t.preventDefault();return}if(this.dragMode!=="none"){this.applyDragToSelection(i,s),this.draw(),t.preventDefault();return}if(this.isNoteCreationMode&&this.tempNote){this.updateTempNote(t.touches[0].clientX,t.touches[0].clientY),this.draw(),t.preventDefault();return}}const e=t.touches[0].clientX-this.lastX;this.scrollX-=e,this.clampScrollToBounds(),this.lastX=t.touches[0].clientX,this.draw(),t.preventDefault();return}if(this.isPinching&&t.touches.length===2){const e=t.touches[0],i=t.touches[1],n=Math.hypot(i.clientX-e.clientX,i.clientY-e.clientY)/this.initialPinchDistance;this.pxPerBeat=Math.max(this.minPxPerBeat,Math.min(this.maxPxPerBeat,this.lastPxPerBeat*n));const r=(e.clientX+i.clientX)/2,o=(e.clientY+i.clientY)/2,a=r-this.lastCenterX,c=o-this.lastCenterY;this.scrollX-=a,this.scrollY-=c,this.clampScrollToBounds(),this.lastCenterX=r,this.lastCenterY=o,this.draw(),t.preventDefault()}}onTouchEnd(t){if(t.touches.length===0&&(this.isDragging=!1,this.isPinching=!1,this.isVScrollDragging=!1,this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),document.body.classList.contains("edit-mode"))){if(this.dragMode==="marquee"&&this.selectingRect){this.performMarqueeSelection(),this.selectingRect=null,this.dragMode="none",this.draw();return}if(this.isNoteCreationMode&&this.tempNote){this.finalizeTempNote(),this.draw();return}if(this.dragMode!=="none"&&this.dragNoteAnchor){this.commitEditedNotes(),this.dragMode="none",this.dragNoteAnchor=null,this.hitNoteId=null;return}this.selectingRect||(this.selection.clear(),this.draw())}}calculateKeyHeight(){if(!this.canvas)return this.minKeyHeight;if(document.body.classList.contains("edit-mode"))return this.minKeyHeight;const e=(this.canvas?.clientHeight??0)-20,i=Math.floor(e/Math.max(1,this.noteRange));return Math.max(1,i)}zoomIn(){this.pxPerBeat=Math.min(this.maxPxPerBeat,this.pxPerBeat*1.2),this.clampScrollToBounds(),this.draw()}zoomOut(){this.pxPerBeat=Math.max(this.minPxPerBeat,this.pxPerBeat/1.2),this.clampScrollToBounds(),this.draw()}drawBackground(){if(!this.canvas)return;const t=this.canvas.getContext("2d");if(!t)return;const e=window.devicePixelRatio||1,i=this.canvas.clientWidth,s=this.canvas.clientHeight;this.keyHeight=this.calculateKeyHeight(),t.setTransform(e,0,0,e,0,0),t.clearRect(0,0,i,s);const n=document.body.classList.contains("edit-mode"),r=n?this.editLeftGutter:0;t.fillStyle="#ffffff",t.fillRect(0,0,i,s);const o=this.noteRange*this.keyHeight,a=n?0:(s-o)/2;if(n&&this.drawPitchRows(t,r,i-r,s),this.drawVerticalGrid(t,i,s,r,n),n&&this.drawOctaveLabels(t,r,s),this.drawNotes(t,a,r,s),n&&this.selectingRect){t.save();const c=Math.min(this.selectingRect.x0,this.selectingRect.x1),l=Math.max(this.selectingRect.x0,this.selectingRect.x1),h=Math.min(this.selectingRect.y0,this.selectingRect.y1),u=Math.max(this.selectingRect.y0,this.selectingRect.y1);t.strokeStyle="#3a7afe",t.setLineDash([6,4]),t.lineWidth=1,t.strokeRect(c+.5,h+.5,Math.max(0,l-c),Math.max(0,u-h)),t.fillStyle="rgba(58,122,254,0.12)",t.fillRect(c,h,Math.max(0,l-c),Math.max(0,u-h)),t.restore()}n&&this.drawVerticalScrollbar(t,i,s)}drawPitchRows(t,e,i,s){const r=Math.max(0,Math.floor(this.scrollY/this.keyHeight)),o=Math.min(84-r,Math.ceil(s/this.keyHeight)+1);for(let a=0;a<o;a++){const c=r+a,l=c*this.keyHeight-this.scrollY,u=((95-c)%12+12)%12,m=u===1||u===3||u===6||u===8||u===10;t.fillStyle=m?"#d6d6d6":"#ffffff",t.fillRect(e,Math.floor(l),Math.max(0,i),this.keyHeight);const d=u===11;t.strokeStyle=d?"#000000":"rgb(153,153,153)",t.lineWidth=1,t.beginPath(),t.moveTo(e,Math.floor(l)+.5),t.lineTo(e+Math.max(0,i),Math.floor(l)+.5),t.stroke()}}drawOctaveLabels(t,e,i){const s=12*this.keyHeight,n=7,r=Math.max(0,Math.floor(this.scrollY/s));let o=r*s-this.scrollY;for(let a=r;a<n&&!(o>=i);a++){const c=7-a,l=c%2===0;t.fillStyle=l?"#e6e6e6":"#ffffff";const h=Math.min(s,i-Math.floor(o));t.fillRect(0,Math.floor(o),e,h),t.fillStyle="#222",t.textAlign="center",t.textBaseline="middle",t.font=`${Math.max(10,Math.round(12))}px system-ui, sans-serif`;const u=o+h/2;t.fillText("o"+c,Math.floor(e/2),Math.floor(u)),o+=s}t.strokeStyle="#e0e0e0",t.beginPath(),t.moveTo(e+.5,0),t.lineTo(e+.5,i),t.stroke()}drawVerticalGrid(t,e,i,s,n){const r=Math.max(0,e-s),o=Math.floor(this.scrollX/this.pxPerBeat)-1,a=Math.ceil((this.scrollX+r)/this.pxPerBeat)+1;if(n){const c=this.pxPerBeat,l=(h,u)=>{const m=o,d=a;t.strokeStyle=u,t.lineWidth=.5;for(let p=m;p<=d;p++)for(let f=1;f<h;f+=2){const g=(p+f/h)*this.pxPerBeat-this.scrollX+s;t.beginPath(),t.moveTo(Math.floor(g)+.5,0),t.lineTo(Math.floor(g)+.5,i),t.stroke()}};c>=48&&l(2,"rgb(191,191,191)"),c>=96&&l(4,"rgb(191,191,191)"),c>=144&&l(8,"rgb(191,191,191)")}for(let c=o;c<=a;c++){const l=c*this.pxPerBeat-this.scrollX+s,h=c%this.displayBeatsPerBar===0;n?(t.strokeStyle=h?"#000000":"rgb(128,128,128)",t.lineWidth=1):h?(t.strokeStyle="rgb(170,170,170)",t.lineWidth=1):(t.strokeStyle="rgb(210,210,210)",t.lineWidth=1),t.beginPath(),t.moveTo(Math.floor(l)+.5,0),t.lineTo(Math.floor(l)+.5,i),t.stroke()}}drawNotes(t,e,i,s){const n=document.body.classList.contains("edit-mode");if(!this.project){this.drawSampleNotes(t,e,i,s);return}if(n){for(const o of this.project.tracks){const a=!this.currentTrack||o===this.currentTrack;t.save(),a||(t.globalAlpha=.35);const c=o.color||"#3a7afe";for(const l of o.notes){if(l.pitch<12||l.pitch>95)continue;const h=l.startTick/480*this.pxPerBeat-this.scrollX+i+1,u=Math.max(1,l.durationTick/480*this.pxPerBeat-2)+1,d=(95-l.pitch)*this.keyHeight-this.scrollY+1,p=this.keyHeight-2+1;if(d+p<0||d>s)continue;const f=o===this.currentTrack&&this.selection.has(l.id);this.drawNoteRect(t,h,d,u,p,c,f,!1)}t.restore()}return}const r=this.currentTrack;for(const o of this.project.tracks){const a=o.color||"#3a7afe";t.save(),r&&o!==r&&(t.globalAlpha=.35);for(const c of o.notes){if(c.pitch<this.minPitch||c.pitch>this.maxPitch)continue;const l=c.startTick/480*this.pxPerBeat-this.scrollX+i+1,h=Math.max(1,c.durationTick/480*this.pxPerBeat-2)+1,u=this.maxPitch-c.pitch,m=e+u*this.keyHeight+1,d=this.keyHeight-2+1;this.drawNoteRect(t,l,m,h,d,a,!1,!1)}t.restore()}if(this.previewNotes&&this.previewNotes.length>0){const o="#ff7a00";for(const a of this.previewNotes){if(a.pitch<12||a.pitch>95)continue;const c=a.startTick/480*this.pxPerBeat-this.scrollX+i+1,l=Math.max(1,a.durationTick/480*this.pxPerBeat-2)+1,h=document.body.classList.contains("edit-mode")?95-a.pitch:this.maxPitch-a.pitch,u=(document.body.classList.contains("edit-mode")?h*this.keyHeight-this.scrollY:e+h*this.keyHeight)+1,m=this.keyHeight-2+1;document.body.classList.contains("edit-mode")&&(u+m<0||u>s)||this.drawNoteRect(t,c,u,l,m,a.color||o,!1,!1)}}}drawSampleNotes(t,e,i,s){const n=[{pitch:60,start:0,duration:1},{pitch:64,start:1,duration:1},{pitch:67,start:2,duration:1},{pitch:72,start:3,duration:1}],r="#3a7afe";for(const o of n){if(o.pitch<this.minPitch||o.pitch>this.maxPitch)continue;const a=o.start*this.pxPerBeat-this.scrollX+i+1,c=Math.max(1,o.duration*this.pxPerBeat-2)+1,l=document.body.classList.contains("edit-mode")?95-o.pitch:this.maxPitch-o.pitch,h=(document.body.classList.contains("edit-mode")?l*this.keyHeight-this.scrollY:e+l*this.keyHeight)+1,u=this.keyHeight-2+1;document.body.classList.contains("edit-mode")&&(h+u<0||h>s)||this.drawNoteRect(t,a,h,c,u,r,!1,!1)}}drawTimeRuler(){if(!this.timeRulerCanvas)return;const t=this.timeRulerCanvas.getContext("2d");if(!t)return;const e=window.devicePixelRatio||1,i=this.timeRulerCanvas.clientWidth,s=this.timeRulerCanvas.clientHeight;t.setTransform(e,0,0,e,0,0),t.clearRect(0,0,i,s);const n=document.body.classList.contains("edit-mode"),r=n?this.editLeftGutter:0;t.fillStyle="#f8f9fa",t.fillRect(0,0,i,s),n&&(t.strokeStyle="#e0e0e0",t.beginPath(),t.moveTo(r+.5,0),t.lineTo(r+.5,s),t.stroke());const o=Math.max(0,i-r),a=Math.floor(this.scrollX/this.pxPerBeat)-1,c=Math.ceil((this.scrollX+o)/this.pxPerBeat)+1;for(let l=a;l<=c;l++){const h=l*this.pxPerBeat-this.scrollX+r;if(l%this.displayBeatsPerBar===0){const m=Math.floor(l/this.displayBeatsPerBar)+1;t.strokeStyle="#000000",t.lineWidth=1,t.beginPath(),t.moveTo(h+.5,0),t.lineTo(h+.5,s),t.stroke(),t.fillStyle="#333333",t.font="11px system-ui, sans-serif",t.textAlign="left",t.textBaseline="top",t.fillText(String(m),h+2,2)}else t.strokeStyle="#888888",t.lineWidth=1,t.beginPath(),t.moveTo(h+.5,s*.6),t.lineTo(h+.5,s),t.stroke()}}computeVScrollThumb(t,e){const i=t/e,s=Math.max(this.vScrollThumbMin,Math.floor(t*i)),n=Math.max(0,e-t),r=Math.max(0,t-s);return{thumbY:n>0?Math.floor(this.scrollY/n*r):0,thumbH:s}}drawVerticalScrollbar(t,e,i){const s=84*this.keyHeight;if(s<=i)return;const n=e-this.vScrollBarMargin-this.vScrollBarWidth;t.fillStyle="rgba(0,0,0,0.06)",t.fillRect(n,0,this.vScrollBarWidth,i);const{thumbY:r,thumbH:o}=this.computeVScrollThumb(i,s);t.fillStyle="rgba(0,0,0,0.25)",t.fillRect(n,r,this.vScrollBarWidth,o)}updatePlayhead(){if(!this.playhead)return;const e=document.body.classList.contains("edit-mode")?this.editLeftGutter:0,i=this.playheadTick/v*this.pxPerBeat;this.playhead.style.left=i-this.scrollX+e+"px"}draw(){this.drawBackground(),this.drawTimeRuler(),this.updatePlayhead()}resize(){if(!this.canvas||!this.timeRulerCanvas)return;const t=window.devicePixelRatio||1,e=this.canvas.clientWidth,i=this.canvas.clientHeight;if(e>0&&i>0){const r=Math.floor(e*t),o=Math.floor(i*t);this.canvas.width!==r&&(this.canvas.width=r),this.canvas.height!==o&&(this.canvas.height=o)}const s=this.timeRulerCanvas.clientWidth,n=this.timeRulerCanvas.clientHeight;if(s>0&&n>0){const r=Math.floor(s*t),o=Math.floor(n*t);this.timeRulerCanvas.width!==r&&(this.timeRulerCanvas.width=r),this.timeRulerCanvas.height!==o&&(this.timeRulerCanvas.height=o)}this.clampScrollToBounds(),this.draw()}updateNoteRange(){if(!this.project)return;let t=127,e=0;for(const i of this.project.tracks)for(const s of i.notes)t=Math.min(t,s.pitch),e=Math.max(e,s.pitch);if(this.previewNotes&&this.previewNotes.length>0)for(const i of this.previewNotes)t=Math.min(t,i.pitch),e=Math.max(e,i.pitch);t<=e&&(this.minPitch=Math.max(0,t-2),this.maxPitch=Math.min(127,e+2),this.noteRange=this.maxPitch-this.minPitch+1)}ensurePlayheadInViewPaginate(t){if(!this.canvas)return;const i=document.body.classList.contains("edit-mode")?this.editLeftGutter:0,s=this.canvas.clientWidth,n=Math.max(0,s-i),r=Math.max(0,t|0)/v*this.pxPerBeat,o=r-this.scrollX+i;o>=n-1?(this.scrollX=Math.floor(r-i),this.clampScrollToBounds(),this.draw()):o<i&&(this.scrollX=Math.max(0,Math.floor(r-i)),this.clampScrollToBounds(),this.draw())}drawNoteRect(t,e,i,s,n,r,o,a){const c=Math.min(6,Math.floor(n/2));if(t.fillStyle=r,this.roundedRectPath(t,e,i,s,n,c),t.fill(),t.strokeStyle="rgba(0,0,0,0.3)",t.lineWidth=1,this.roundedRectPath(t,e,i,s-1,n-1,Math.max(0,c-1)),t.stroke(),o&&(t.strokeStyle="#3a7afe",t.lineWidth=2,this.roundedRectPath(t,e,i,s-1,n-1,Math.max(0,c-1)),t.stroke(),t.lineWidth=1),a){const l=Math.min(8,Math.floor(s/3));t.fillStyle="rgba(0,0,0,0.15)",t.fillRect(e,i,l,n),t.fillRect(e+s-l,i,l,n)}}roundedRectPath(t,e,i,s,n,r){const o=Math.max(0,Math.min(r,Math.floor(Math.min(s,n)/2))),a=Math.floor(e),c=Math.floor(i),l=a+Math.max(0,s),h=c+Math.max(0,n);if(t.beginPath(),o<=0){t.rect(a,c,s,n);return}t.moveTo(a+o,c),t.lineTo(l-o,c),t.arcTo(l,c,l,c+o,o),t.lineTo(l,h-o),t.arcTo(l,h,l-o,h,o),t.lineTo(a+o,h),t.arcTo(a,h,a,h-o,o),t.lineTo(a,c+o),t.arcTo(a,c,a+o,c,o)}getLastEndTick(){if(this.project&&this.project.tracks?.length){let t=0;for(const e of this.project.tracks)for(const i of e.notes){const s=i.startTick+i.durationTick;s>t&&(t=s)}return Number.isFinite(this.project.maxEndTick)&&(t=Math.max(t,this.project.maxEndTick||0)),t}return 480*4}clampScrollToBounds(){if(!this.canvas){this.scrollX=Math.max(0,this.scrollX),this.scrollY=Math.max(0,this.scrollY);return}const t=this.canvas.clientWidth||0,e=this.canvas.clientHeight||0,i=document.body.classList.contains("edit-mode"),s=i?this.editLeftGutter:0,n=Math.max(0,t-s),a=(this.getLastEndTick()/480+this.trailingBars*this.displayBeatsPerBar)*this.pxPerBeat,c=Math.max(0,Math.floor(a-n));if(Number.isFinite(this.scrollX)||(this.scrollX=0),this.scrollX=Math.max(0,Math.min(this.scrollX,c)),!i)this.scrollY=0;else{const l=84*this.keyHeight,h=Math.max(0,Math.floor(l-e));Number.isFinite(this.scrollY)||(this.scrollY=0),this.scrollY=Math.max(0,Math.min(this.scrollY,h))}}getLeftGutter(){return document.body.classList.contains("edit-mode")?this.editLeftGutter:0}pxToTick(t){const e=this.getLeftGutter(),s=(t+this.scrollX-e)/this.pxPerBeat;return Math.max(0,Math.round(s*v))}pxToPitch(t){const e=t+this.scrollY,s=95-Math.floor(e/this.keyHeight);return Math.max(0,Math.min(127,s))}getGrid(){const t=this.project?.selectedLength,e=Number.isFinite(t)&&t>0?t:16;return Math.round(v*(4/e))}findNoteById(t){if(!t||!this.project)return null;const e=this.currentTrack||this.project.tracks[0];return e&&e.notes.find(i=>i.id===t)||null}hitTestNote(t,e){if(!this.project)return null;const i=this.currentTrack||this.project.tracks[0];if(!i)return null;const s=this.getLeftGutter(),n=6;for(const r of i.notes){if(r.pitch<12||r.pitch>95)continue;const o=r.startTick/v*this.pxPerBeat-this.scrollX+s+1,a=Math.max(1,r.durationTick/v*this.pxPerBeat-2)+1,l=(95-r.pitch)*this.keyHeight-this.scrollY+1,h=this.keyHeight-2+1;if(t>=o&&t<=o+a&&e>=l&&e<=l+h)return t<=o+n?{id:r.id,mode:"resize-left"}:t>=o+a-n?{id:r.id,mode:"resize-right"}:{id:r.id,mode:"move"}}return null}applyDragToSelection(t,e){if(!this.project||!this.dragNoteAnchor)return;const i=this.currentTrack||this.project.tracks[0];if(!i)return;const s=this.getGrid(),n=Math.round(t/this.pxPerBeat*v),r=-Math.round(e/this.keyHeight);for(const o of i.notes)if(this.selection.has(o.id)){if(this.dragMode==="move"){const a=o.id===this.hitNoteId&&this.dragNoteAnchor?this.dragNoteAnchor.tick:o.startTick,c=o.id===this.hitNoteId&&this.dragNoteAnchor?this.dragNoteAnchor.pitch:o.pitch;let l=Math.max(0,a+n);l=Math.max(0,Math.floor(l/s)*s);let h=Math.max(0,Math.min(127,c+r));o.startTick=l,o.pitch=h}else if(this.dragMode==="resize-left"){const a=o.id===this.hitNoteId&&this.dragNoteAnchor?this.dragNoteAnchor.tick:o.startTick,c=o.id===this.hitNoteId&&this.dragNoteAnchor?this.dragNoteAnchor.len:o.durationTick;let l=Math.max(0,a+n);l=Math.max(0,Math.floor(l/s)*s);let h=Math.max(s,c+(a-l));o.startTick=l,o.durationTick=h}else if(this.dragMode==="resize-right"){const a=o.id===this.hitNoteId&&this.dragNoteAnchor?this.dragNoteAnchor.len:o.durationTick;let c=Math.max(s,Math.floor((a+n)/s)*s);o.durationTick=c}}}performMarqueeSelection(){if(!this.project||!this.selectingRect)return;const t=this.currentTrack||this.project.tracks[0];if(!t)return;const e=this.selectingRect,i=Math.min(e.x0,e.x1),s=Math.max(e.x0,e.x1),n=Math.min(e.y0,e.y1),r=Math.max(e.y0,e.y1);this.selection.clear();const o=this.getLeftGutter();for(const a of t.notes){if(a.pitch<12||a.pitch>95)continue;const c=a.startTick/v*this.pxPerBeat-this.scrollX+o+1,l=Math.max(1,a.durationTick/v*this.pxPerBeat-2)+1,u=(95-a.pitch)*this.keyHeight-this.scrollY+1,m=this.keyHeight-2+1;c<=s&&c+l>=i&&u<=r&&u+m>=n&&this.selection.add(a.id)}}commitEditedNotes(){if(!this.project)return;let t=0;for(const e of this.project.tracks)for(const i of e.notes)t=Math.max(t,i.startTick+i.durationTick);this.project.maxEndTick=t;try{window.mobileApp?.getHistory?.().push(this.project)}catch{}}showVolumeModalForSelection(){if(!this.project)return;const t=this.currentTrack||this.project.tracks[0];if(!t)return;const e=Array.from(this.selection);if(e.length===0)return;const i="volumeModalMobile";let s=document.getElementById(i);s?s.classList.add("open"):(s=document.createElement("div"),s.id=i,s.className="modal-overlay open",s.innerHTML=`
        <div class="modal" style="margin-bottom: env(safe-area-inset-bottom, 12px);">
          <div class="modal__header">노트 볼륨</div>
          <div class="modal__body">
            <div class="modal__row" style="grid-template-columns: 1fr;">
              <input type="range" id="noteVolRange" min="0" max="15" step="1" />
            </div>
          </div>
          <div class="modal__footer">
            <button class="btn" id="noteVolCancel">취소</button>
            <button class="btn btn--primary" id="noteVolOk">확인</button>
          </div>
        </div>`,document.body.appendChild(s));const n=s.querySelector("#noteVolRange"),r=t.notes.find(a=>e.includes(a.id));n.value=String(r?.volume??12);const o=()=>s.classList.remove("open");s.querySelector("#noteVolCancel").onclick=o,s.querySelector("#noteVolOk").onclick=()=>{const a=Math.max(0,Math.min(15,parseInt(n.value)||12));for(const c of t.notes)e.includes(c.id)&&(c.volume=a);this.commitEditedNotes(),this.draw(),o()}}beginCreateTempNote(t,e){const i=this.getGrid(),s=Math.max(0,Math.floor(this.pxToTick(t)/i)*i),n=this.pxToPitch(e);this.tempNote={startTick:s,durationTick:i,pitch:n},this.previewNotes=[{...this.tempNote,color:"#ff7a00"}]}updateTempNote(t,e){if(!this.canvas||!this.tempNote)return;const i=this.canvas.getBoundingClientRect(),s=t-i.left,n=e-i.top,r=this.getGrid(),o=Math.max(this.tempNote.startTick+r,Math.floor(this.pxToTick(s)/r)*r);this.tempNote.durationTick=Math.max(r,o-this.tempNote.startTick),this.tempNote.pitch=this.pxToPitch(n),this.previewNotes=[{...this.tempNote,color:"#ff7a00"}]}finalizeTempNote(){if(!this.project||!this.tempNote){this.previewNotes=[];return}const t=this.currentTrack||this.project.tracks[0];if(!t){this.previewNotes=[],this.tempNote=null;return}const e={id:globalThis.crypto?.randomUUID?.()||String(Date.now()),startTick:this.tempNote.startTick,durationTick:this.tempNote.durationTick,pitch:this.tempNote.pitch,volume:15};t.notes.push(e),this.previewNotes=[],this.tempNote=null,this.commitEditedNotes()}}const b=Object.freeze(Object.defineProperty({__proto__:null,PianorollMobile:P},Symbol.toStringTag,{value:"Module"}));class X{project=null;isPlaying=!1;currentTick=0;lastFrameTime=0;rafId=null;metronomeEnabled=!1;metroHigh=null;metroLow=null;metroVolume=.65;backingVolume=1;isRecording=!1;recorded=[];activePitch=null;lastPreview={pitch:null,sampler:null};playBtn=null;pauseBtn=null;stopBtn=null;recordBtn=null;metronomeBtn=null;timeDisplay=null;timeRulerCanvas=null;inRecordPreRoll=!1;init(){this.playBtn=document.getElementById("btnPlay"),this.pauseBtn=document.getElementById("btnPause"),this.stopBtn=document.getElementById("btnStop"),this.recordBtn=document.getElementById("btnRecord"),this.metronomeBtn=document.getElementById("btnMetronome"),this.timeDisplay=document.getElementById("timeDisplay"),this.timeRulerCanvas=document.getElementById("timeRulerCanvas"),document.getElementById("btnRecVolume")?.addEventListener("click",t=>{t.preventDefault(),this.openRecordVolumeModal()}),this.playBtn?.addEventListener("click",()=>{this.isRecording||this.onPlay()}),this.pauseBtn?.addEventListener("click",()=>{this.isRecording||this.onPause()}),this.stopBtn?.addEventListener("click",()=>this.onStop()),this.recordBtn?.addEventListener("click",async t=>{t.preventDefault(),!this.isRecording&&await this.startRecordWithPreRoll()}),this.metronomeBtn?.addEventListener("click",t=>{t.preventDefault(),this.metronomeEnabled=!this.metronomeEnabled,this.metronomeBtn?.classList.toggle("active",this.metronomeEnabled)}),this.updateTimeDisplay(),this.metronomeBtn?.classList.toggle("active",this.metronomeEnabled),this.attachRulerScrub()}playKeyPreview(t){const e=window.mobileApp,i=e?.getProject?.()||null,s=e&&typeof e.getUIControls=="function"?e.getUIControls():null,n=s?.getSelectedTrackIndex?.()??0;let r="piano",o=n;if(i&&i.tracks&&i.tracks[n]){const a=i.tracks[n];r=a.instrument||r,typeof a.id=="number"&&(o=a.id)}else s?.getSelectedInstrument&&(r=s.getSelectedInstrument()||r);I(t,o,r,this.lastPreview)}isRecordingActive(){return this.isRecording}setProject(t){this.project=t,this.updateTimeDisplay()}attachRulerScrub(){const t=this.timeRulerCanvas;if(!t)return;let e=!1;const i=a=>{const c=t.getBoundingClientRect(),l=a-c.left;return k(async()=>{const{PianorollMobile:h}=await Promise.resolve().then(()=>b);return{PianorollMobile:h}},void 0,import.meta.url).then(({PianorollMobile:h})=>{const m=h.getInstance().getPxPerBeat(),d=l/m*v,p=v;return Math.max(0,Math.floor(d/p)*p)})},s=async a=>{let c=0;a instanceof TouchEvent?c=a.touches[0]?.clientX??0:c=a.clientX;const l=await i(c);this.setCurrentTick(l)},n=async a=>{a.preventDefault(),!this.isPlaying&&(e=!0,await s(a))},r=async a=>{e&&(a.preventDefault(),await s(a))},o=()=>{e=!1};t.addEventListener("mousedown",n),window.addEventListener("mousemove",r),window.addEventListener("mouseup",o),t.addEventListener("touchstart",n,{passive:!1}),window.addEventListener("touchmove",r,{passive:!1}),window.addEventListener("touchend",o),window.addEventListener("touchcancel",o)}getGlobalEndTick(){if(!this.project)return 0;let t=0;for(const e of this.project.tracks)for(const i of e.notes){const s=i.startTick+i.durationTick;s>t&&(t=s)}return t}collectEvents(){if(!this.project)return[];const t=this.project.tracks.filter(n=>n.solo),e=t.length>0?t:this.project.tracks.filter(n=>!n.mute),i=n=>["lute","mandolin","piano","xylophone","violin","flute","chalumeau"].includes(n)?n:"lute",s=[];for(const n of e){const r=i(n.instrument||"lute");for(const o of n.notes)s.push({startTick:o.startTick,durationTick:o.durationTick,pitch:o.pitch,trackId:n.id,instrumentKey:r,volume:o.volume})}return s}async ensureMetronomePlayers(){if(this.metroHigh&&this.metroLow)return;const t=new x({oscillator:{type:"square"},envelope:{attack:.001,decay:.05,sustain:0,release:.01}}).toDestination(),e=new x({oscillator:{type:"square"},envelope:{attack:.001,decay:.06,sustain:0,release:.01}}).toDestination();this.metroHigh={start:i=>t.triggerAttackRelease(1760,"32n",i,this.metroVolume)},this.metroLow={start:i=>e.triggerAttackRelease(880,"32n",i,Math.max(0,Math.min(1,this.metroVolume*.77)))}}scheduleMetronome(){if(!this.project||!this.metronomeEnabled||!this.metroHigh||!this.metroLow)return;const t=this.project.bpm||this.project.tempo||120,e=Math.max(1,Math.floor(this.project.timeSig?.beatsPerBar||4)),i=Math.max(this.getGlobalEndTick(),this.currentTick+v*4*4);let s=0;for(let n=0;n<=i;n+=v){const r=B(n,t),a=s%e===0?this.metroHigh:this.metroLow;T().schedule(c=>{try{a.start(c)}catch{}},r),s++}}scheduleMetronomePreRoll(){if(!this.project||!this.metroHigh||!this.metroLow)return;const t=this.project.bpm||this.project.tempo||120,e=Math.max(1,Math.floor(this.project.timeSig?.beatsPerBar||4)),i=e,s=60/t;for(let n=0;n<i;n++){const o=n%e===0?this.metroHigh:this.metroLow;T().schedule(a=>{try{o.start(a)}catch{}},n*s)}}updateTimeDisplay(){if(!this.timeDisplay||!this.project)return;const t=this.getGlobalEndTick(),e=Math.max(0,Math.floor(this.currentTick)),i=this.project.bpm||this.project.tempo||120,s=n=>{const r=n/v*(60/i),o=Math.floor(r/60),a=Math.floor(r%60),c=Math.floor((r-Math.floor(r))*1e3),l=String(o).padStart(2,"0"),h=String(a).padStart(2,"0"),u=String(c).padStart(3,"0");return`${l}:${h}.${u}`};this.timeDisplay.textContent=`${s(e)} / ${s(t)}`}rafTick(){if(!this.isPlaying||!this.project)return;const t=performance.now(),e=Math.max(0,t-this.lastFrameTime);if(this.lastFrameTime=t,this.inRecordPreRoll){this.rafId=requestAnimationFrame(()=>this.rafTick());return}const i=v*((this.project.bpm||this.project.tempo||120)/60)/1e3;this.currentTick+=e*i;const s=this.getGlobalEndTick();if(!this.isRecording&&this.currentTick>=s){this.onStop();return}k(async()=>{const{PianorollMobile:n}=await Promise.resolve().then(()=>b);return{PianorollMobile:n}},void 0,import.meta.url).then(({PianorollMobile:n})=>{const r=n.getInstance();r.setPlayheadTick(this.currentTick),r.ensurePlayheadInViewPaginate(this.currentTick)}),this.updateTimeDisplay(),this.rafId=requestAnimationFrame(()=>this.rafTick())}async onPlay(){if(this.isPlaying||!this.project)return;this.isPlaying=!0,document.body.classList.add("playing-mode"),await E();const t=this.collectEvents(),e=this.project.bpm||this.project.tempo||120;await N(t,e),T().position=this.currentTick/v*(60/e),this.metronomeEnabled&&(await this.ensureMetronomePlayers(),this.scheduleMetronome()),this.lastFrameTime=performance.now(),this.rafId=requestAnimationFrame(()=>this.rafTick())}async startRecordWithPreRoll(){if(!this.project)return;await E();const t=this.project.bpm||this.project.tempo||120,i=Math.max(1,Math.floor(this.project.timeSig?.beatsPerBar||4));T().stop(),T().cancel(),T().bpm.value=t,await E(),await this.ensureMetronomePlayers(),this.scheduleMetronomePreRoll();const s=i*(60/t);this.isRecording=!0,this.isPlaying=!0,this.inRecordPreRoll=!0,document.body.classList.add("recording-mode"),this.recorded=[],this.activePitch=null,this.lockKeyboardViewport(!0);try{const{PianorollMobile:n}=await k(async()=>{const{PianorollMobile:r}=await Promise.resolve().then(()=>b);return{PianorollMobile:r}},void 0,import.meta.url);n.getInstance().setTrailingBars(32)}catch{}if(this.recordBtn?.classList.add("active"),this.playBtn?.setAttribute("disabled","true"),this.pauseBtn?.setAttribute("disabled","true"),this.hookKeyboardRecording(!0),this.metronomeEnabled&&this.scheduleMetronomeAfter(s,0),this.project){const n=this.project.bpm||this.project.tempo||120,r=this.collectEvents(),c=window.mobileApp?.getUIControls?.()?.getSelectedTrackIndex?.()??0,h=this.project.tracks[c]?.id,u=Math.max(0,Math.floor(this.currentTick)),m=r.filter(d=>d.trackId!==h&&d.startTick>=u).map(d=>({...d,startTick:d.startTick-u}));await _(m,n,s,{velocityScale:Math.max(0,Math.min(1,this.backingVolume))})}T().start("+0"),this.lastFrameTime=performance.now(),this.rafId=requestAnimationFrame(()=>this.rafTick()),T().scheduleOnce(()=>{if(this.captureHeldKeyAtRecordStart(),this.inRecordPreRoll=!1,this.activePitch!=null)try{this.playKeyPreview(this.activePitch)}catch{}},s)}captureHeldKeyAtRecordStart(){if(!this.isRecording||this.activePitch!=null)return;const t=document.getElementById("keyboard");if(!t)return;const e=Array.from(t.querySelectorAll(".key.pressed"));if(e.length===0)return;let i=null;for(const s of e){const n=parseInt(s.dataset.note||"");Number.isFinite(n)&&(i==null||n<i)&&(i=n)}if(i!=null){this.activePitch=i,this.recorded.push({pitch:i,startTick:Math.max(0,Math.floor(this.currentTick))});try{this.playKeyPreview(i)}catch{}}}lockKeyboardViewport(t){try{k(async()=>{const{KeyboardMobile:e}=await Promise.resolve().then(()=>j);return{KeyboardMobile:e}},void 0,import.meta.url).then(({KeyboardMobile:e})=>{e.getInstance().setViewportLocked(t)}).catch(()=>{})}catch{}}hookKeyboardRecording(t){const e=document.getElementById("keyboard");if(!e)return;const i=(u,m)=>{if(u==null)return;const d=e.querySelector(`.key[data-note="${u}"]`);d&&(m?d.classList.add("pressed"):d.classList.remove("pressed"))},s=u=>{if(!this.isRecording||this.inRecordPreRoll)return;const m=u.target||null,d=m?m.closest(".key"):null,p=parseInt(d?.dataset?.note||"");Number.isFinite(p)&&this.activePitch==null&&(this.activePitch=p,this.recorded.push({pitch:p,startTick:Math.max(0,Math.floor(this.currentTick))}),i(p,!0),this.playKeyPreview(p))},n=u=>{if(!this.isRecording||this.inRecordPreRoll||this.activePitch==null)return;let m=0,d=0;if(window.TouchEvent&&u instanceof TouchEvent){const M=u.touches[0];if(!M)return;m=M.clientX,d=M.clientY}else if(u.clientX!=null){const M=u;if(M.buttons===0)return;m=M.clientX,d=M.clientY}else return;const p=document.elementFromPoint(m,d);if(!p)return;const f=p.closest(".key");if(!f)return;const g=parseInt(f.dataset.note||"");if(!Number.isFinite(g)||g===this.activePitch)return;const y=this.recorded[this.recorded.length-1];y&&y.endTick==null&&(y.endTick=Math.max(0,Math.floor(this.currentTick))),i(this.activePitch,!1),this.activePitch=g,this.recorded.push({pitch:g,startTick:Math.max(0,Math.floor(this.currentTick))}),i(g,!0),this.playKeyPreview(g)},r=u=>{if(!(!this.isRecording||this.inRecordPreRoll)&&this.activePitch!=null){const m=this.recorded[this.recorded.length-1];m&&m.endTick==null&&(m.endTick=Math.max(0,Math.floor(this.currentTick))),i(this.activePitch,!1),this.activePitch=null;try{R(this.lastPreview.sampler,this.lastPreview.pitch)}catch{}this.lastPreview.pitch=null}},o={capture:!0,passive:!0},a={capture:!0,passive:!0},c={capture:!0,passive:!0},l={capture:!0},h={capture:!0};if(t)e.addEventListener("touchstart",s,o),e.addEventListener("mousedown",s,l),e.addEventListener("touchmove",n,c),e.addEventListener("mousemove",n,h),e.addEventListener("touchend",r,a),e.addEventListener("mouseup",r,l),this._recPress=s,this._recRelease=r,this._recMove=n,this._recOptsTouchStart=o,this._recOptsTouchEnd=a,this._recOptsTouchMove=c,this._recOptsMouse=l,this._recOptsMouseMove=h;else try{e.removeEventListener("touchstart",this._recPress,this._recOptsTouchStart),e.removeEventListener("mousedown",this._recPress,this._recOptsMouse),e.removeEventListener("touchmove",this._recMove,this._recOptsTouchMove),e.removeEventListener("mousemove",this._recMove,this._recOptsMouseMove),e.removeEventListener("touchend",this._recRelease,this._recOptsTouchEnd),e.removeEventListener("mouseup",this._recRelease,this._recOptsMouse)}catch{}}onPause(){this.isPlaying&&(this.isPlaying=!1,document.body.classList.remove("playing-mode"),T().stop(),this.rafId!==null&&cancelAnimationFrame(this.rafId),this.rafId=null,this.updateTimeDisplay())}onStop(){const t=this.isRecording;this.isRecording=!1,this.isPlaying=!1,this.inRecordPreRoll=!1,document.body.classList.remove("playing-mode"),T().stop(),T().position=0,this.rafId!==null&&cancelAnimationFrame(this.rafId),this.rafId=null,this.currentTick=0,k(async()=>{const{PianorollMobile:e}=await Promise.resolve().then(()=>b);return{PianorollMobile:e}},void 0,import.meta.url).then(({PianorollMobile:e})=>{e.getInstance().setPlayheadTick(0),e.getInstance().setTrailingBars(4)}),this.updateTimeDisplay(),this.hookKeyboardRecording(!1),this.lockKeyboardViewport(!1),document.body.classList.remove("recording-mode"),this.recordBtn?.classList.remove("active"),this.playBtn?.removeAttribute("disabled"),this.pauseBtn?.removeAttribute("disabled"),t&&this.onRecordingStopped()}openRecordVolumeModal(){const t=document.createElement("div");t.className="modal-overlay open";const e=document.createElement("div");e.className="modal",e.style.marginBottom="env(safe-area-inset-bottom, 12px)";const i=document.createElement("div");i.className="modal__header",i.textContent="녹음 볼륨 설정";const s=document.createElement("div");s.className="modal__body";const n=document.createElement("div");n.className="modal__row";const r=document.createElement("label");r.textContent="메트로놈";const o=document.createElement("input");o.type="range",o.min="0",o.max="100",o.value=String(Math.round(this.metroVolume*100)),o.oninput=()=>{this.metroVolume=Math.max(0,Math.min(1,Number(o.value)/100))},n.append(r,o);const a=document.createElement("div");a.className="modal__row";const c=document.createElement("label");c.textContent="반주(다른 트랙)";const l=document.createElement("input");l.type="range",l.min="0",l.max="100",l.value=String(Math.round(this.backingVolume*100)),l.oninput=()=>{this.backingVolume=Math.max(0,Math.min(1,Number(l.value)/100))},a.append(c,l),s.append(n,a);const h=document.createElement("div");h.className="modal__footer";const u=document.createElement("button");u.className="btn",u.textContent="닫기",u.onclick=()=>{t.classList.remove("open"),t.remove()},h.append(u),e.append(i,s,h),t.appendChild(e),document.body.appendChild(t)}scheduleMetronomeAfter(t,e){if(!this.project||!this.metroHigh||!this.metroLow)return;const i=this.project.bpm||this.project.tempo||120,s=Math.max(1,Math.floor(this.project.timeSig?.beatsPerBar||4)),n=60/i,r=B(Math.max(this.getGlobalEndTick(),v*64*s),i),o=Math.ceil((r-t)/n);let a=e;for(let c=0;c<=o;c++){const l=t+c*n,u=a%s===0?this.metroHigh:this.metroLow;T().schedule(m=>{try{u.start(m)}catch{}},l),a++}}onRecordingStopped(){const t=this.recorded.filter(e=>(e.endTick??0)>(e.startTick||0));t.length!==0&&this.showQuantizeModal(t)}async showQuantizeModal(t){const e=await k(()=>import("./quantizeModal-DfWwqVJC.js"),[],import.meta.url),{PianorollMobile:i}=await k(async()=>{const{PianorollMobile:o}=await Promise.resolve().then(()=>b);return{PianorollMobile:o}},void 0,import.meta.url),s=i.getInstance(),n=(o,a)=>{const c=Math.round(v*(4/o)*(a?.6666666666666666:1)),l=t.filter(d=>(d.endTick??0)>(d.startTick||0)),h=[],u=new Map;for(const d of l){const p=M=>Math.max(0,Math.floor((M+c/2)/c)*c);let f=p(d.startTick),g=d.endTick??d.startTick+c,y=p(g);y<=f&&(y=f+c),!u.has(f)&&(u.set(f,!0),h.push({startTick:f,endTick:y,pitch:d.pitch}))}h.sort((d,p)=>d.startTick-p.startTick);const m=[];for(const d of h){let p=d.startTick,f=d.endTick;if(m.length>0){const g=m[m.length-1],y=g.startTick+g.durationTick;p<y&&(p=y),f<=p&&(f=p+c)}m.push({startTick:p,durationTick:f-p,pitch:d.pitch,color:"#ff7a00"})}s.setPreviewNotes(m)},r=await e.QuantizeModal.open(o=>n(o.gridDenom,o.triplet));s.clearPreviewNotes(),r&&this.commitRecordedNotes(t,r.gridDenom,r.triplet)}commitRecordedNotes(t,e,i){if(!this.project)return;const s=Math.round(v*(4/e)*(i?2/3:1)),n=window.mobileApp,r=n?.getHistory?.(),a=n?.getUIControls?.()?.getSelectedTrackIndex?.()??0,c=this.project.tracks[a],l=t.filter(d=>(d.endTick??0)>(d.startTick||0)),h=new Map,u=[];for(const d of l){const p=M=>Math.max(0,Math.floor((M+s/2)/s)*s);let f=p(d.startTick),g=d.endTick??d.startTick+s,y=p(g);y<=f&&(y=f+s),!h.has(f)&&(h.set(f,!0),u.push({startTick:f,endTick:y,pitch:d.pitch}))}u.sort((d,p)=>d.startTick-p.startTick);const m=[];for(const d of u){let p=d.startTick,f=d.endTick;if(m.length>0){const g=m[m.length-1],y=g.startTick+g.durationTick;p<y&&(p=y),f<=p&&(f=p+s)}m.push({startTick:p,durationTick:f-p,pitch:d.pitch})}if(m.length>0){const d=m[0].startTick,p=m[m.length-1].startTick+m[m.length-1].durationTick;c.notes=c.notes.filter(f=>f.startTick+f.durationTick<=d||f.startTick>=p)}for(const d of m)c.notes.push({id:crypto.randomUUID(),startTick:d.startTick,durationTick:d.durationTick,pitch:d.pitch,volume:15}),this.project.maxEndTick=Math.max(this.project.maxEndTick,d.startTick+d.durationTick);c.notes.sort((d,p)=>d.startTick-p.startTick||d.pitch-p.pitch),k(async()=>{const{PianorollMobile:d}=await Promise.resolve().then(()=>b);return{PianorollMobile:d}},void 0,import.meta.url).then(({PianorollMobile:d})=>{d.getInstance().setProject(this.project)}),r&&this.project&&r.push(this.project)}getIsPlaying(){return this.isPlaying}getCurrentTick(){return this.currentTick}setCurrentTick(t){this.currentTick=Math.max(0,t|0),k(async()=>{const{PianorollMobile:e}=await Promise.resolve().then(()=>b);return{PianorollMobile:e}},void 0,import.meta.url).then(({PianorollMobile:e})=>{e.getInstance().setPlayheadTick(this.currentTick)}),this.updateTimeDisplay()}}class K{project=null;tempoDisplay=null;timeSigSelect=null;trackSelect=null;instrumentSelect=null;editPianorollBtn=null;isPianorollEditMode=!1;currentTrackId=0;langButtons=null;currentLanguage="Ko";isUpdatingUI=!1;init(){console.log("UIControls init started"),this.tempoDisplay=document.getElementById("tempoDisplay"),this.timeSigSelect=document.getElementById("timeSigSelect"),this.trackSelect=document.getElementById("trackSelect"),this.instrumentSelect=document.getElementById("instrumentSelect"),this.editPianorollBtn=document.getElementById("btnEditPianoroll"),this.langButtons=document.querySelectorAll(".btn--lang"),console.log("Edit Pianoroll button found:",this.editPianorollBtn),this.setupEventListeners(),this.setupInstrumentOptions(),this.updateUI(),console.log("UIControls init completed")}setupEventListeners(){this.tempoDisplay?.addEventListener("click",this.editTempo.bind(this)),this.timeSigSelect?.addEventListener("change",this.onTimeSigChange.bind(this)),this.trackSelect?.addEventListener("change",this.onTrackChange.bind(this)),this.instrumentSelect?.addEventListener("change",this.onInstrumentChange.bind(this)),document.getElementById("langKo")?.addEventListener("click",()=>this.selectLanguage("Ko")),document.getElementById("langJa")?.addEventListener("click",()=>this.selectLanguage("Ja")),document.getElementById("langEn")?.addEventListener("click",()=>this.selectLanguage("En")),document.getElementById("btnGuide")?.addEventListener("click",this.showGuide.bind(this)),document.getElementById("btnEditPianoroll")?.addEventListener("click",this.editPianoroll.bind(this));const t=document.getElementById("keyHeightRangeMobile"),e=document.getElementById("keyHeightLabel");t?.addEventListener("input",()=>{const n=parseInt(t.value)||24;e&&(e.textContent=`${n}px`),k(async()=>{const{PianorollMobile:r}=await Promise.resolve().then(()=>b);return{PianorollMobile:r}},void 0,import.meta.url).then(({PianorollMobile:r})=>{const o=r.getInstance();if(typeof o.setMinKeyHeight=="function")o.setMinKeyHeight(n);else try{o.minKeyHeight=n}catch{}o.resize()})});const i=document.getElementById("noteLengthSelect");i?.addEventListener("change",()=>{const n=parseInt(i.value)||16;k(async()=>{const{PianorollMobile:r}=await Promise.resolve().then(()=>b);return{PianorollMobile:r}},void 0,import.meta.url).then(({PianorollMobile:r})=>{r.getInstance().setSelectedLength?.(n)})});const s=document.getElementById("btnNoteCreate");s?.addEventListener("click",()=>{s.classList.toggle("active");const n=s.classList.contains("active");k(async()=>{const{PianorollMobile:r}=await Promise.resolve().then(()=>b);return{PianorollMobile:r}},void 0,import.meta.url).then(({PianorollMobile:r})=>{r.getInstance().setNoteCreationMode?.(n)})})}setupInstrumentOptions(){if(!this.instrumentSelect)return;const t={piano:"Piano",lute:"Lute",mandolin:"Mandolin",violin:"Violin",flute:"Flute",chalumeau:"Chalumeau",xylophone:"Xylophone"};this.instrumentSelect.innerHTML="",L.forEach(e=>{const i=document.createElement("option");i.value=e,i.textContent=t[e]||e,this.instrumentSelect.appendChild(i)})}async editTempo(){if(!(!this.tempoDisplay||!this.project))try{(await k(()=>import("./tempoModal-1xZMLwS0.js").then(e=>e.b),__vite__mapDeps([0,1]),import.meta.url)).showTempoModal(this.project,e=>{this.tempoDisplay&&(this.tempoDisplay.textContent=String(e)),this.project.bpm=e,this.project.tempo!==void 0&&(this.project.tempo=e);try{window.mobileApp?.getHistory?.().push(this.project)}catch{}console.log("Tempo changed to (modal):",e)})}catch(t){console.error("Failed to open tempo modal, fallback to prompt",t);const e=this.project.bpm||120,i=prompt("새 템포를 입력하세요 (1-1000)",e.toString());if(i&&!isNaN(Number(i))){const s=Number(i);if(s>=1&&s<=1e3){this.tempoDisplay.textContent=s.toString(),this.project.bpm=s,this.project.tempo!==void 0&&(this.project.tempo=s);try{window.mobileApp?.getHistory?.().push(this.project)}catch{}}}}}onTimeSigChange(){if(this.isUpdatingUI||!this.timeSigSelect)return;const t=this.timeSigSelect.value,e=parseInt(t,10);if(console.log("Time signature changed to:",t+"/4"),this.project&&Number.isFinite(e)&&e>=1){this.project.timeSig={...this.project.timeSig||{beatsPerBar:4},beatsPerBar:e},k(async()=>{const{PianorollMobile:i}=await Promise.resolve().then(()=>b);return{PianorollMobile:i}},void 0,import.meta.url).then(({PianorollMobile:i})=>{i.getInstance().setDisplayBeatsPerBar?.(e)});try{window.mobileApp?.getHistory?.().push(this.project)}catch{}}}onTrackChange(){if(this.isUpdatingUI||!this.trackSelect)return;const t=parseInt(this.trackSelect.value);if(this.currentTrackId=t,console.log("Track changed to:",this.trackSelect.options[this.trackSelect.selectedIndex].text),this.project&&this.project.tracks[t]){const e=this.project.tracks[t];this.instrumentSelect&&(this.instrumentSelect.value=e.instrument),this.updatePianorollTrack(e)}this.isPianorollEditMode&&this.updateTracksPanel()}updatePianorollTrack(t){const e=window.mobileApp?.pianoroll;e&&typeof e.setCurrentTrack=="function"&&e.setCurrentTrack(t)}onInstrumentChange(){if(this.isUpdatingUI||!this.instrumentSelect||!this.trackSelect)return;const t=parseInt(this.trackSelect.value),e=this.instrumentSelect.value;if(console.log("Instrument changed to:",this.instrumentSelect.options[this.instrumentSelect.selectedIndex].text),this.project&&this.project.tracks[t]){this.project.tracks[t].instrument=e,this.updatePianorollTrack(this.project.tracks[t]);try{window.mobileApp?.getHistory?.().push(this.project)}catch{}}}selectLanguage(t){this.langButtons?.forEach(e=>{e.classList.remove("active")}),document.getElementById("lang"+t)?.classList.add("active"),this.currentLanguage=t,console.log("Language changed to:",t),this.updateUILanguage(t)}updateUILanguage(t){}showGuide(){alert(`조작 가이드

• 피아노롤: 음표 편집 영역
• 중단바: 트랙 관리 도구
• 건반: 가상 키보드
• 좌우 스크롤: 스크롤 영역 길게 누르기
• 확대/축소: 핀치 제스처 또는 마우스 휠`)}editPianoroll(){console.log("editPianoroll called, current state:",this.isPianorollEditMode),this.isPianorollEditMode=!this.isPianorollEditMode;const t=document.body;this.editPianorollBtn&&(this.isPianorollEditMode?(this.editPianorollBtn.classList.add("active"),t.classList.add("edit-mode"),this.updateTracksPanel(),console.log("Entered edit mode - keyboard hidden, tracks panel shown")):(this.editPianorollBtn.classList.remove("active"),t.classList.remove("edit-mode"),console.log("Exited edit mode - keyboard shown, tracks panel hidden"))),k(async()=>{const{PianorollMobile:e}=await Promise.resolve().then(()=>b);return{PianorollMobile:e}},void 0,import.meta.url).then(({PianorollMobile:e})=>{const i=e.getInstance(),s=()=>{if(this.isPianorollEditMode){const n=document.getElementById("keyHeightRangeMobile"),r=n&&parseInt(n.value)||24;typeof i.setMinKeyHeight=="function"&&i.setMinKeyHeight(r)}i.resize()};s(),requestAnimationFrame(()=>requestAnimationFrame(s))}),console.log("피아노롤 편집 모드:",this.isPianorollEditMode?"ON":"OFF")}updateTracksPanel(){const t=document.getElementById("tracks");!t||!this.project||(t.innerHTML="",this.project.tracks.forEach((e,i)=>{const s=document.createElement("div");s.className="track-card",i===this.currentTrackId&&s.classList.add("is-active");const n=document.createElement("div");n.className="track-color",n.style.backgroundColor=e.color||"#3a7afe";const r=document.createElement("div");r.className="track-main";const o=document.createElement("div");o.className="track-row";const a=document.createElement("div");a.className="track-name";const c=document.createElement("input");c.value=e.name||`Track ${i+1}`,c.addEventListener("change",()=>{if(e.name=c.value,this.trackSelect){const g=this.trackSelect.options[i];g&&(g.text=e.name)}}),a.appendChild(c);const l=document.createElement("div");l.className="track-instrument";const h=document.createElement("select");L.forEach(g=>{const y=document.createElement("option");y.value=g,y.textContent=g.charAt(0).toUpperCase()+g.slice(1),e.instrument===g&&(y.selected=!0),h.appendChild(y)}),h.addEventListener("change",()=>{e.instrument=h.value,this.instrumentSelect&&this.currentTrackId===i&&(this.instrumentSelect.value=e.instrument),this.updatePianorollTrack(e)}),l.appendChild(h),o.append(a);const u=document.createElement("div");u.className="track-row track-row--bottom";const m=document.createElement("div");m.className="track-controls";const d=document.createElement("button");d.textContent="M",d.title="Mute";const p=document.createElement("button");p.textContent="S",p.title="Solo",d.classList.toggle("is-active",!!e.mute),p.classList.toggle("is-active",!!e.solo),d.addEventListener("click",g=>{g.stopPropagation(),e.mute=!e.mute,d.classList.toggle("is-active",!!e.mute)}),p.addEventListener("click",g=>{g.stopPropagation(),e.solo=!e.solo,p.classList.toggle("is-active",!!e.solo)}),m.append(d,p);const f=document.createElement("div");f.className="track-charcount",f.textContent=`${e.notes?.length||0} notes`,u.append(m,f),r.append(o,l,u),s.append(n,r),s.addEventListener("click",()=>this.selectTrack(i)),t.appendChild(s)}))}selectTrack(t){if(t!==this.currentTrackId){if(this.currentTrackId=t,this.trackSelect&&(this.trackSelect.value=t.toString()),this.updateTracksPanel(),this.project&&this.project.tracks&&this.project.tracks[t]){const e=this.project.tracks[t];this.instrumentSelect&&e.instrument&&(this.instrumentSelect.value=e.instrument)}console.log(`Track ${t+1} selected`),this.updatePianorollForTrack(t)}}updatePianorollForTrack(t){if(console.log(`Updating pianoroll for track ${t+1}`),!this.project)return;const e=this.project.tracks[t];e&&this.updatePianorollTrack(e)}updateUI(){if(this.project){if(this.isUpdatingUI=!0,this.tempoDisplay){const t=this.project.bpm??this.project.tempo??120;this.tempoDisplay.textContent=String(t)}if(this.timeSigSelect){const t=this.project?.timeSig?.beatsPerBar,e=Number.isFinite(t)&&t>=1?String(Math.floor(t)):"4";this.timeSigSelect.value=e}this.trackSelect&&(this.trackSelect.innerHTML="",this.project.tracks.forEach((t,e)=>{const i=document.createElement("option");i.value=e.toString(),i.textContent=t.name||`Track ${e+1}`,this.trackSelect.appendChild(i)})),this.instrumentSelect&&this.project.tracks.length>0&&(this.instrumentSelect.value=this.project.tracks[0].instrument),this.isUpdatingUI=!1}}setProject(t){this.project=t,this.updateUI(),this.project&&this.project.tracks&&this.project.tracks.length>0&&(this.currentTrackId=0,this.trackSelect&&(this.trackSelect.value="0"),this.updatePianorollTrack(this.project.tracks[0]))}getCurrentLanguage(){return this.currentLanguage}getCurrentTrackId(){return this.currentTrackId}getSelectedTrackIndex(){return this.trackSelect&&parseInt(this.trackSelect.value)||0}getSelectedInstrument(){return this.instrumentSelect?this.instrumentSelect.value:"lute"}}class A{project=null;pianoroll;transport;uiControls;history=new C;constructor(){this.pianoroll=P.getInstance(),this.transport=new X,this.uiControls=new K,this.setupEventListeners(),this.initializeComponents(),this.loadDefaultProject()}setupEventListeners(){document.getElementById("btnDesktop")?.addEventListener("click",this.goToDesktop.bind(this)),document.getElementById("btnGuide")?.addEventListener("click",this.showGuide.bind(this)),document.getElementById("btnLoad")?.addEventListener("click",this.loadProject.bind(this)),document.getElementById("btnPasteMML")?.addEventListener("click",this.pasteMML.bind(this)),document.getElementById("btnConvert")?.addEventListener("click",this.convert.bind(this)),document.getElementById("btnUndo")?.addEventListener("click",()=>{if(!this.project)return;const t=this.history.undo(this.project);t&&this.setProject(t)}),document.getElementById("btnRedo")?.addEventListener("click",()=>{if(!this.project)return;const t=this.history.redo(this.project);t&&this.setProject(t)})}initializeComponents(){this.pianoroll.init(),this.transport.init(),this.uiControls.init(),k(async()=>{const{KeyboardMobile:t}=await Promise.resolve().then(()=>j);return{KeyboardMobile:t}},void 0,import.meta.url).then(({KeyboardMobile:t})=>{t.getInstance().init()})}loadDefaultProject(){if(this.project=this.createDefaultProject(),this.updateComponents(),this.project){this.history.push(this.project);try{this.history.setPersistKey("mml_editor_project")}catch{}}}createDefaultProject(){const t=D();return t.maxEndTick=0,t}updateComponents(){this.project&&(this.pianoroll.setProject(this.project),this.transport.setProject(this.project),this.uiControls.setProject(this.project))}goToDesktop(){window.location.href="./"}showGuide(){alert("모바일 가이드가 여기에 표시됩니다.")}loadProject(){try{const t=localStorage.getItem("mml_editor_project");if(!t){alert("저장된 프로젝트가 없습니다.");return}const e=JSON.parse(t);if(!e||!e.tracks){alert("저장 데이터 형식이 올바르지 않습니다.");return}const i=e;this.setProject(i),this.project&&this.history.push(this.project),alert("저장된 프로젝트를 불러왔습니다.")}catch(t){try{console.error("Load failed",t)}catch{}alert("불러오기에 실패했습니다.")}}pasteMML(){(async()=>{if(this.project)try{const i=(await navigator.clipboard.readText()||"").trim();if(!i.startsWith("MML@")){alert("MML 형식이 아닙니다.");return}const n=i.substring(4).replace(/\r?\n/g,"").replace(/;+$/g,"").split(",").map(c=>c.replace(/;+$/g,"").trim());if(n.length>this.project.tracks.length){alert("트랙은 최대 6개까지만 지원합니다.");return}const{mmlToNotes:r}=await k(async()=>{const{mmlToNotes:c}=await import("./converter-93tpuols.js");return{mmlToNotes:c}},__vite__mapDeps([2,1]),import.meta.url);let o=null;for(let c=0;c<this.project.tracks.length;c++){const l=this.project.tracks[c],u=((n[c]?n[c]:"")||"").replace(/\r?\n/g,"").trim();l.mmlString=u;try{const m=u.match(/^t(\d+)/);m&&c===0&&(o=parseInt(m[1],10)),l.notes=r("MML@"+u)}catch{l.notes=[]}}o&&Number.isFinite(o)&&(this.project.bpm=o,this.project.tempo=o);let a=0;for(const c of this.project.tracks)for(const l of c.notes)a=Math.max(a,l.startTick+l.durationTick);this.project.maxEndTick=a,this.updateComponents(),this.history.push(this.project),alert("MML을 붙여넣었습니다.")}catch(e){try{console.error("Paste MML failed",e)}catch{}alert("MML 붙여넣기에 실패했습니다.")}})()}convert(){console.log("Convert clicked")}getProject(){return this.project}setProject(t){this.project=t,this.updateComponents()}getUIControls(){return this.uiControls}getPianoroll(){return this.pianoroll}getTransport(){return this.transport}getHistory(){return this.history}}class w{static instance=null;container=null;keyboard=null;scrollbar=null;scrollbarThumb=null;currentScrollPosition=0;maxScrollPosition=0;containerWidth=0;visibleKeyCount=0;startKeyIndex=0;renderedKeys=[];noteNames=H;whiteKeyPattern=[0,2,4,5,7,9,11];totalOctaves=7;startOctave=1;totalWhiteKeys=this.totalOctaves*7;isDragging=!1;dragStartX=0;thumbStartX=0;keyWidth=60;lastPlayed={pitch:null,sampler:null};viewportLocked=!1;static getInstance(){return this.instance||(this.instance=new w),this.instance}init(){if(this.container=document.getElementById("keyboardContainer"),this.keyboard=document.getElementById("keyboard"),this.scrollbar=document.getElementById("keyboardScrollbar"),this.scrollbarThumb=document.getElementById("scrollbarThumb"),!this.container||!this.keyboard||!this.scrollbar||!this.scrollbarThumb){console.error("Keyboard elements not found");return}this.createKeyboard(),this.setupScrollbar(),this.setupTouchControls()}createKeyboard(){if(!this.keyboard||!this.container)return;this.containerWidth=this.container.offsetWidth,this.visibleKeyCount=Math.ceil(this.containerWidth/this.keyWidth)+2;const t=this.totalWhiteKeys*this.keyWidth;this.keyboard.style.width=`${t}px`,this.maxScrollPosition=Math.max(0,t-this.containerWidth),this.currentScrollPosition=14*this.keyWidth,this.renderVisibleKeys(),this.updateKeyboardScroll()}renderVisibleKeys(){if(!this.keyboard)return;this.startKeyIndex=Math.max(0,Math.floor(this.currentScrollPosition/this.keyWidth)-1);const t=Math.min(this.startKeyIndex+this.visibleKeyCount,this.totalWhiteKeys);this.keyboard.innerHTML="",this.renderedKeys=[];for(let e=this.startKeyIndex;e<t;e++)this.createSingleKey(e);this.keyboard.style.transform=`translateX(-${this.currentScrollPosition}px)`}createSingleKey(t){if(!this.keyboard)return;const e=Math.floor(t/7),i=t%7,s=this.startOctave+e,n=this.whiteKeyPattern[i],r=e*12+n+this.startOctave*12,o=document.createElement("div");if(o.className="key white",o.dataset.note=r.toString(),o.dataset.octave=s.toString(),o.dataset.noteName=this.noteNames[n],n===0){const a=document.createElement("span");a.className="key-label",a.textContent=`O${s}`,o.appendChild(a)}o.style.left=`${t*this.keyWidth}px`,this.addKeyEvents(o),this.keyboard.appendChild(o),this.renderedKeys.push(o),this.createBlackKeys(t,e,s)}createBlackKeys(t,e,i){if(!this.keyboard)return;const s=t%7,r=[{after:0,noteIndex:1},{after:1,noteIndex:3},{after:3,noteIndex:6},{after:4,noteIndex:8},{after:5,noteIndex:10}].find(l=>l.after===s);if(!r)return;const o=e*12+r.noteIndex+this.startOctave*12,a=document.createElement("div");a.className="key black",a.dataset.note=o.toString(),a.dataset.octave=i.toString(),a.dataset.noteName=this.noteNames[r.noteIndex];const c=(t+1)*this.keyWidth-36/2;a.style.left=`${c}px`,this.addKeyEvents(a),this.keyboard.appendChild(a),this.renderedKeys.push(a)}addKeyEvents(t){t.addEventListener("touchstart",this.handleKeyPress.bind(this),{passive:!1}),t.addEventListener("touchend",this.handleKeyRelease.bind(this),{passive:!1}),t.addEventListener("mousedown",this.handleKeyPress.bind(this)),t.addEventListener("mouseup",this.handleKeyRelease.bind(this)),t.addEventListener("mouseleave",this.handleKeyRelease.bind(this))}handleKeyPress(t){t.preventDefault();const e=t.target;e.classList.add("pressed");const i=e.dataset.note,s=e.dataset.octave,n=e.dataset.noteName;if(console.log(`Key pressed: ${n}${s} (MIDI: ${i})`),!!!window.mobileApp?.getTransport?.()?.isRecordingActive?.()){const l=parseInt(i||"0");this.playNote(l)}}handleKeyRelease(t){if(t.preventDefault(),t.target.classList.remove("pressed"),!!!window.mobileApp?.getTransport?.()?.isRecordingActive?.()){try{R(this.lastPlayed.sampler,this.lastPlayed.pitch)}catch{}this.lastPlayed.pitch=null}}playNote(t){const e=window.mobileApp,i=e?.getProject?.()||null,s=e&&typeof e.getUIControls=="function"?e.getUIControls():null,n=s?.getSelectedTrackIndex?.()??0;let r="piano",o=n;if(i&&i.tracks&&i.tracks[n]){const a=i.tracks[n];r=a.instrument||r,typeof a.id=="number"&&(o=a.id)}else s?.getSelectedInstrument&&(r=s.getSelectedInstrument()||r);I(t,o,r,this.lastPlayed)}snapToKey(t){const e=Math.round(t/this.keyWidth)*this.keyWidth;return Math.max(0,Math.min(e,this.maxScrollPosition))}setupScrollbar(){!this.scrollbar||!this.scrollbarThumb||(this.scrollbar.addEventListener("click",t=>{if(this.viewportLocked){t.preventDefault();return}if(t.target===this.scrollbarThumb)return;const e=this.scrollbar.getBoundingClientRect(),i=t.clientX-e.left,s=e.width,n=this.scrollbarThumb.offsetWidth,r=s-n,a=Math.min(Math.max(i-n/2,0),r)/r*this.maxScrollPosition;this.currentScrollPosition=this.snapToKey(a),this.renderVisibleKeys(),this.updateScrollbarThumb()}),this.scrollbarThumb.addEventListener("mousedown",t=>{if(this.viewportLocked){t.preventDefault();return}this.isDragging=!0,this.dragStartX=t.clientX,this.thumbStartX=this.scrollbarThumb.offsetLeft,t.preventDefault()}),this.scrollbarThumb.addEventListener("touchstart",t=>{if(this.viewportLocked){t.preventDefault();return}this.isDragging=!0,this.dragStartX=t.touches[0].clientX,this.thumbStartX=this.scrollbarThumb.offsetLeft,t.preventDefault()},{passive:!1}),document.addEventListener("mousemove",t=>{this.viewportLocked||this.isDragging&&this.handleThumbDrag(t.clientX)}),document.addEventListener("touchmove",t=>{this.viewportLocked||this.isDragging&&this.handleThumbDrag(t.touches[0].clientX)},{passive:!0}),document.addEventListener("mouseup",()=>{if(this.viewportLocked){this.isDragging=!1;return}this.isDragging&&(this.isDragging=!1,this.currentScrollPosition=this.snapToKey(this.currentScrollPosition),this.renderVisibleKeys(),this.updateScrollbarThumb())}),document.addEventListener("touchend",()=>{if(this.viewportLocked){this.isDragging=!1;return}this.isDragging&&(this.isDragging=!1,this.currentScrollPosition=this.snapToKey(this.currentScrollPosition),this.renderVisibleKeys(),this.updateScrollbarThumb())},{passive:!0}),this.updateScrollbarThumb())}handleThumbDrag(t){if(!this.scrollbar||!this.scrollbarThumb||this.viewportLocked)return;const e=t-this.dragStartX,i=this.thumbStartX+e,s=this.scrollbar.offsetWidth,n=this.scrollbarThumb.offsetWidth,r=s-n,o=Math.min(Math.max(i,0),r);this.currentScrollPosition=o/r*this.maxScrollPosition,this.keyboard&&(this.currentScrollPosition=Math.max(0,Math.min(this.currentScrollPosition,this.maxScrollPosition)),this.renderVisibleKeys(),this.updateScrollbarThumb())}updateScrollbarThumb(){if(!this.scrollbar||!this.scrollbarThumb)return;const t=this.scrollbar.offsetWidth,e=this.scrollbarThumb.offsetWidth,i=t-e,s=this.currentScrollPosition/this.maxScrollPosition*i;this.scrollbarThumb.style.left=`${s}px`}setupTouchControls(){if(!this.container)return;let t=0,e=!1;this.container.addEventListener("touchstart",i=>{if(!this.viewportLocked&&i.touches.length===1){const s=i.touches[0],n=this.container.getBoundingClientRect(),r=s.clientX-n.left;(r<20||r>n.width-20)&&(e=!0,t=s.clientX,i.preventDefault())}},{passive:!1}),this.container.addEventListener("touchmove",i=>{if(!this.viewportLocked&&e&&i.touches.length===1){const s=i.touches[0],n=s.clientX-t;this.currentScrollPosition-=n*2,this.currentScrollPosition=Math.max(0,Math.min(this.currentScrollPosition,this.maxScrollPosition)),this.renderVisibleKeys(),this.updateScrollbarThumb(),t=s.clientX,i.preventDefault()}},{passive:!1}),this.container.addEventListener("touchend",i=>{if(this.viewportLocked){e=!1;return}i.touches.length===0&&(e=!1)},{passive:!0})}setViewportLocked(t){this.viewportLocked=!!t,this.viewportLocked&&(this.isDragging=!1);try{this.scrollbar&&(this.scrollbar.style.pointerEvents=this.viewportLocked?"none":""),this.scrollbarThumb&&(this.scrollbarThumb.style.pointerEvents=this.viewportLocked?"none":""),this.container&&this.container.classList.toggle("viewport-locked",this.viewportLocked)}catch{}}updateKeyboardScroll(){if(!this.keyboard)return;this.currentScrollPosition=Math.max(0,Math.min(this.currentScrollPosition,this.maxScrollPosition));const t=Math.max(0,Math.floor(this.currentScrollPosition/this.keyWidth)-1);Math.abs(t-this.startKeyIndex)>=1&&this.renderVisibleKeys(),this.keyboard.style.transform=`translateX(-${this.currentScrollPosition}px)`,this.updateScrollbarThumb()}resize(){if(this.container){this.containerWidth=this.container.offsetWidth,this.visibleKeyCount=Math.ceil(this.containerWidth/this.keyWidth)+2;const t=this.totalWhiteKeys*this.keyWidth;this.maxScrollPosition=Math.max(0,t-this.containerWidth),this.currentScrollPosition=Math.min(this.currentScrollPosition,this.maxScrollPosition)}this.renderVisibleKeys()}getCurrentOctave(){return Math.floor(this.currentScrollPosition/(7*this.keyWidth))+1}scrollToOctave(t){const e=Math.max(0,(t-1)*7*this.keyWidth);this.currentScrollPosition=Math.min(e,this.maxScrollPosition),this.updateKeyboardScroll()}}const j=Object.freeze(Object.defineProperty({__proto__:null,KeyboardMobile:w},Symbol.toStringTag,{value:"Module"}));document.addEventListener("DOMContentLoaded",function(){setTimeout(()=>{window.mobileApp=new A,console.log("Mobile app initialized")},100)});window.addEventListener("resize",()=>{const S=P.getInstance(),t=w.getInstance();S?.resize(),t?.resize()});console.log("Screen size:",window.innerWidth,"x",window.innerHeight);console.log("Viewport size:",document.documentElement.clientWidth,"x",document.documentElement.clientHeight);
