import{T as L,P as q,D as W,c as En,H as ao,e as Ln,s as Sn,E as Ne,B as _e,a as ze,I as Ge,b as Ye,L as Vt,t as xt,d as Te,p as ke,_ as Re,f as dn,g as io,h as so,i as je,j as De,k as ye,l as Cn,m as ft,M as We,n as un,o as co,q as lo}from"./timeline-Cty6ufw_.js";import{notesToMMLWithTempos as uo,notesToMML as An,notesToMMLRaw as Je,newOptimizeBody as Bn,extractTempoAnchorsFromMMLBodies as In,mmlToNotes as mo}from"./converter-CLYNbzq6.js";import{t as y,c as v,u as fo,i as po,s as ho}from"./languages-BJzYuuIl.js";let mn=!1;function Ot(){if(mn)return;const t=document.createElement("style");t.id="app-button-styles",t.textContent=`
  :root {
    --btn-font: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    --btn-radius: 8px;
    --btn-pad-y: 6px; --btn-pad-x: 12px;
    --btn-fg: #1f2937; --btn-bg: #ffffff; --btn-bd: #cfd3d8;
    --btn-fg-primary: #ffffff; --btn-bg-primary: #3a7afe; --btn-bd-primary: #2f65d2;
    --btn-fg-danger: #ffffff; --btn-bg-danger: #ef4444; --btn-bd-danger: #dc2626;
    --btn-fg-ghost: #374151; --btn-bg-ghost: transparent; --btn-bd-ghost: #d1d5db;
    --btn-hover: 0.97; --btn-active: 0.94;
  }
  .btn { font: 500 13px/1 var(--btn-font); padding: var(--btn-pad-y) var(--btn-pad-x); border-radius: var(--btn-radius); cursor: pointer; border:1px solid var(--btn-bd); background: var(--btn-bg); color: var(--btn-fg); transition: filter .15s ease, background .15s ease, border-color .15s ease, transform .15s ease, box-shadow .15s ease; }
  .btn:hover { filter: brightness(var(--btn-hover)); }
  .btn:active { filter: brightness(var(--btn-active)); transform: translateY(0.5px); }
  .btn:disabled { opacity: .6; cursor: not-allowed; }
  .btn--primary { color: var(--btn-fg-primary); background: var(--btn-bg-primary); border-color: var(--btn-bd-primary); }
  .btn--danger { color: var(--btn-fg-danger); background: var(--btn-bg-danger); border-color: var(--btn-bd-danger); }
  .btn--ghost { color: var(--btn-fg-ghost); background: var(--btn-bg-ghost); border-color: var(--btn-bd-ghost); }
  .btn--secondary { /* defaults already set by .btn */ }
  .btn--sm { padding: 4px 8px; font-size: 12px; }
  .btn--md { padding: 6px 12px; font-size: 13px; }
  .btn--lg { padding: 10px 16px; font-size: 15px; }
  `,document.head.appendChild(t),mn=!0}function go(t,e){Ot();const n=e?.variant??"secondary",r=e?.size??"md";return t.classList.add("btn",`btn--${n}`,`btn--${r}`),e?.label!=null&&(t.textContent=e.label),e?.title&&(t.title=e.title),e?.disabled!=null&&(t.disabled=e.disabled),e?.onClick&&(t.onclick=e.onClick),e?.attrs&&Object.entries(e.attrs).forEach(([a,o])=>t.setAttribute(a,o)),t}function Nt(t){const e=document.createElement("button");return go(e,t)}let fn=!1;function bo(){if(fn)return;const t=`
  :root {
    --dd-radius: 6px;
    --dd-border: #cfcfcf;
    --dd-border-hover: #b5b5b5;
    --dd-bg: #fff;
    --dd-text: #111;
    --dd-muted: #6b7280;
    --dd-shadow: 0 8px 24px rgba(0,0,0,0.12), 0 2px 6px rgba(0,0,0,0.08);
    --dd-focus: 0 0 0 3px rgba(33,150,243,0.15);
  }

  .dropdown { position: relative; display: inline-flex; }
  .dropdown--full { width: 100%; }

  .dropdown__button {
    display: inline-flex; align-items: center; justify-content: space-between;
    gap: 8px; width: 100%;
    background: var(--dd-bg);
    color: var(--dd-text);
    border: 1px solid var(--dd-border);
    border-radius: var(--dd-radius);
    cursor: pointer; user-select: none;
    transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
  }
  .dropdown__button:hover { border-color: var(--dd-border-hover); }
  .dropdown__button:focus-visible { outline: none; box-shadow: var(--dd-focus); }

  .dropdown__button--sm { height: 28px; padding: 4px 8px; font-size: 12px; }
  .dropdown__button--md { height: 34px; padding: 6px 10px; font-size: 14px; }
  .dropdown__button--lg { height: 40px; padding: 8px 12px; font-size: 16px; }

  .dropdown__caret { width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 6px solid #888; }

  .dropdown__menu {
    position: absolute; left: 0; top: calc(100% + 4px);
    min-width: 100%;
    background: #fff; border: 1px solid var(--dd-border);
    border-radius: var(--dd-radius);
    box-shadow: var(--dd-shadow);
    padding: 6px; margin: 0; list-style: none;
    z-index: 1000; display: block; opacity: 0; transform: var(--dd-transform, translateY(4px));
    pointer-events: none; transition: opacity .16s ease, transform .16s ease;
  }
  .dropdown__menu[data-open="true"] { opacity: 1; transform: translateY(0); pointer-events: auto; }

  .dropdown__item {
    padding: 6px 8px; border-radius: 6px; cursor: pointer;
    white-space: nowrap; color: var(--dd-text);
  }
  .dropdown__item[aria-selected="true"] { background: #eef6ff; }
  .dropdown__item:hover { background: #f3f4f6; }
  .dropdown__item:focus { outline: none; box-shadow: var(--dd-focus); }
  `,e=document.createElement("style");e.id="dropdown-styles",e.textContent=t,document.head.appendChild(e),fn=!0}function ko(t){bo();const e=t.size??"md";let n=t.value??t.items[0]?.value??"",r=t.items;const a=document.createElement("div");a.className="dropdown",a.classList.add("dropdown--full");const o=document.createElement("button");o.type="button",o.className=`dropdown__button dropdown__button--${e}`,o.setAttribute("aria-haspopup","listbox"),o.setAttribute("aria-expanded","false");const i=document.createElement("span");i.textContent=t.items.find(M=>M.value===n)?.label??"";const d=document.createElement("i");d.className="dropdown__caret",o.append(i,d);const c=document.createElement("ul");c.className="dropdown__menu",c.setAttribute("role","listbox"),c.setAttribute("tabindex","-1");const l=a;let m=!1;function f(){c.innerHTML="";for(const M of r){const S=document.createElement("li");S.className="dropdown__item",S.setAttribute("role","option"),S.setAttribute("tabindex","0"),S.setAttribute("aria-selected",String(M.value===n)),S.textContent=M.label,S.addEventListener("click",()=>w(M.value)),S.addEventListener("keydown",H=>{H.key==="Enter"||H.key===" "?(H.preventDefault(),w(M.value)):H.key==="Escape"?(H.preventDefault(),g(),o.focus()):H.key==="ArrowDown"?(H.preventDefault(),A(S)):H.key==="ArrowUp"&&(H.preventDefault(),B(S))}),c.appendChild(S)}}function p(){f(),m||(document.body.appendChild(c),m=!0,c.style.position="fixed",c.style.zIndex="1000");const M=o.getBoundingClientRect();c.style.minWidth=M.width+"px",x(),c.dataset.open="true",o.setAttribute("aria-expanded","true"),window.addEventListener("mousedown",b,{capture:!0}),window.addEventListener("scroll",k,!0),window.addEventListener("resize",k)}function g(){delete c.dataset.open,o.setAttribute("aria-expanded","false"),m&&(l.appendChild(c),m=!1,c.style.position="",c.style.left="",c.style.top="",c.style.minWidth="",c.style.zIndex=""),window.removeEventListener("mousedown",b,{capture:!0}),window.removeEventListener("scroll",k,!0),window.removeEventListener("resize",k)}function h(){c.dataset.open==="true"?g():p()}function b(M){const S=M.target;a.contains(S)||c.contains(S)||g()}function k(){c.dataset.open==="true"&&x()}function x(){const M=o.getBoundingClientRect(),S=c.getBoundingClientRect(),H=window.innerHeight,C=window.innerWidth,E=8,N=4,I=Math.max(S.width,M.width);let X=Math.min(Math.max(M.left,E),Math.max(E,C-I-E));const at=H-M.bottom-E,dt=M.top-E;let ut=!1,At=Math.min(360,Math.max(at-N,120));S.height>at&&dt>at&&(ut=!0,At=Math.min(360,Math.max(dt-N,120)));let Bt;ut?(Bt=Math.max(E,M.top-N-Math.min(S.height,At)),c.dataset.placement="top",c.style.setProperty("--dd-transform","translateY(-4px)")):(Bt=Math.min(H-E-Math.min(S.height,At),M.bottom+N),c.dataset.placement="bottom",c.style.setProperty("--dd-transform","translateY(4px)")),c.style.top=`${Math.round(Bt)}px`,c.style.left=`${Math.round(X)}px`,c.style.maxHeight=`${At}px`,c.style.overflowY="auto"}function w(M){if(M===n){g(),o.focus();return}n=M,i.textContent=r.find(S=>S.value===n)?.label??"",g(),o.focus(),t.onChange(n)}function A(M){const S=Array.from(c.querySelectorAll(".dropdown__item")),H=S.indexOf(M);S[Math.min(S.length-1,H+1)]?.focus()}function B(M){const S=Array.from(c.querySelectorAll(".dropdown__item")),H=S.indexOf(M);S[Math.max(0,H-1)]?.focus()}o.addEventListener("click",()=>h()),o.addEventListener("keydown",M=>{if(M.key==="ArrowDown"||M.key==="Enter"||M.key===" ")M.preventDefault(),p();else if(M.key==="ArrowUp"){M.preventDefault(),p();const S=c.querySelectorAll(".dropdown__item");S[S.length-1]?.focus()}});function $(M){r=M;const S=r.find(H=>H.value===n);S?i.textContent=S.label:i.textContent="",c.dataset.open==="true"&&f()}return a.append(o,c),{el:a,get value(){return n},set value(M){w(M)},updateItems:$}}let pn=!1;function Pn(){if(pn)return;const t=`
  :root {
    --fc-radius: 6px;
    --fc-border: #cfcfcf;
    --fc-border-hover: #b5b5b5;
    --fc-border-focus: #2196f3;
    --fc-bg: #ffffff;
    --fc-bg-disabled: #f7f7f7;
    --fc-text: #111;
    --fc-placeholder: #9aa0a6;
    --fc-shadow-focus: 0 0 0 3px rgba(33,150,243,0.15);
  }

  .input, .select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    box-sizing: border-box;
    font: inherit;
    color: var(--fc-text);
    background: var(--fc-bg);
    border: 1px solid var(--fc-border);
    border-radius: var(--fc-radius);
    outline: none;
    transition: border-color .2s ease, box-shadow .2s ease, background .2s ease, transform .15s ease;
  }

  .input::placeholder {
    color: var(--fc-placeholder);
  }

  .input:hover, .select:hover {
    border-color: var(--fc-border-hover);
  }

  .input:focus, .select:focus {
    border-color: var(--fc-border-focus);
    box-shadow: var(--fc-shadow-focus);
  }

  /* Sizes */
  .fc--sm { height: 28px; padding: 4px 8px; font-size: 12px; }
  .fc--md { height: 34px; padding: 6px 10px; font-size: 14px; }
  .fc--lg { height: 40px; padding: 8px 12px; font-size: 16px; }

  /* Full width helper */
  .fc--full { width: 100%; }

  /* Number inputs: right align helper */
  .fc--num-right { text-align: right; }

  /* Disabled */
  .input:disabled, .select:disabled { background: var(--fc-bg-disabled); color: #888; cursor: not-allowed; }

  /* Select arrow */
  .select {
    background-image: url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5' stroke='%23888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 16px 16px;
    padding-right: 28px; /* space for arrow */
  }

  /* Remove default arrow on some browsers */
  .select::-ms-expand { display: none; }
  `,e=document.createElement("style");e.id="form-control-styles",e.textContent=t,document.head.appendChild(e),pn=!0}function yo(t,e){Pn(),t.classList.add("input");const n=e?.size;t.classList.add(vo(n)),t.classList.add("fc--full"),e?.rightAlign&&t.classList.add("fc--num-right")}function vo(t){return t==="sm"?"fc--sm":t==="lg"?"fc--lg":"fc--md"}function xo(t){const e=document.createElement("div");e.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
   `;const n=document.createElement("div");n.style.cssText=`
      background: #fff;
      padding: 24px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
   `;const r=document.createElement("div");r.style.cssText=`
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #eee;
      padding: 8px;
      margin-bottom: 16px;
   `;const a=document.createElement("div");a.style.cssText=`
            display: flex;
            align-items: center;
            gap: 8px;
        `;const o=document.createElement("label");o.setAttribute("for","convertFilenameInput"),o.textContent=y[v].convertFilenameLabel||"파일명",o.setAttribute("data-i18n","convertFilenameLabel"),o.style.cssText=`
            min-width: 72px;
            color: #666;
            font-size: 12px;
        `;const i=document.createElement("input");i.type="text",i.id="convertFilenameInput",i.placeholder=y[v].convertFilenamePlaceholder||"예: my-song.txt",i.setAttribute("data-i18n-placeholder","convertFilenamePlaceholder"),i.style.cssText=`
            flex: 1 1 auto;
            padding: 6px 8px;
            border: 1px solid #cfcfcf;
            border-radius: 6px;
            font-size: 12px;
        `;const d=new Date().toISOString().replace(/[:.]/g,"-");i.value=`mml-${d}.txt`,a.append(o,i);const c=document.createElement("div");c.style.cssText=`
            display: flex;
            align-items: center;
            gap: 8px;
        `;const l=document.createElement("input");l.type="checkbox",l.id="convertMidTempoFix",l.style.cursor="pointer";const m=document.createElement("label");m.htmlFor="convertMidTempoFix",m.textContent="중간템포버그수정",m.style.cssText=`
            color: #666;
            font-size: 12px;
        `;let f=l.checked;l.addEventListener("change",()=>{const C=l.checked;!f&&C?H():f&&!C&&S(),f=C}),c.append(l,m);const p=document.createElement("textarea");p.style.cssText=`
            width: 100%;
            min-height: 200px;
            box-sizing: border-box;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            word-break: break-all;
            overflow-y: auto;
        `,p.readOnly=!0;const g=document.createElement("div");g.style.cssText=`
      display: flex;
      justify-content: flex-end;
      gap: 8px;
   `,Ot();const h=Nt({label:y[v].convertCopy,variant:"primary",attrs:{"data-i18n":"convertCopy"}}),b=Nt({label:y[v].convertSaveTxt,variant:"secondary",attrs:{"data-i18n":"convertSaveTxt"}}),k=Nt({label:y[v].modalClose,variant:"secondary",attrs:{"data-i18n":"modalClose"}});g.append(h,b,k),n.append(r,a,c,p,g),e.appendChild(n),document.body.appendChild(e);function x(){window.removeEventListener("keydown",w,!0),e.parentNode&&document.body.removeChild(e)}function w(C){C.key==="Escape"&&x()}r.innerHTML="";let A=[];const B=new Map,$=()=>{let E=p.value||"";E.startsWith("MML@")&&(E=E.slice(4)),E.endsWith(";")&&(E=E.slice(0,-1));const N=E.length>0?E.split(",").map(I=>I.trim()):[];for(const I of t.tracks){const X=B.get(I.id);if(!X)continue;const at=A.indexOf(I.id),dt=at>=0&&at<N.length?N[at].length:0;X.textContent=`${I.name} (${dt}${y[v].charUnit})`}};[...t.tracks].slice().sort((C,E)=>C.order-E.order).forEach(C=>{const E=document.createElement("div");E.style.cssText=`
            display: flex;
            align-items: center;
            margin-bottom: 8px;
         `;const N=document.createElement("input");N.type="checkbox",N.id=`track-${C.id}`,N.value=String(C.id),N.checked=C.notes.length>0,N.disabled=C.notes.length===0,N.style.margin="0 4px 0 0",N.style.cursor="pointer";const I=document.createElement("label");I.htmlFor=`track-${C.id}`,B.set(C.id,I),I.textContent=`${C.name}`,I.style.cssText=`
                margin-left: 8px;
                ${C.notes.length===0?"color: #aaa;":""}
            `,N.addEventListener("change",()=>{S(),$()}),E.append(N,I),r.appendChild(E)});function M(C,E){const N=C.slice().sort((X,at)=>X.order-at.order),I=[];for(const X of N){if(!(Array.isArray(X.notes)&&X.notes.length>0))continue;const dt=t.tempoAnchors;let ut=uo(X.notes??[],dt??[],E)||An(X.notes??[])||Je(X.notes??"")||"";ut&&(ut=Bn(ut,!0)||ut),ut&&I.push(ut)}return`MML@${I.join(",")};`}function S(){const C=[];r.querySelectorAll('input[type="checkbox"]').forEach(I=>{I.checked&&C.push(parseInt(I.value))});const E=t.tracks.filter(I=>C.includes(I.id));A=E.slice().sort((I,X)=>I.order-X.order).map(I=>I.id);const N=M(E,t.bpm);p.value=N,$()}function H(){let C=p.value;if(!C.startsWith("MML@")||!C.endsWith(";"))return;const E=C.slice(4,-1),N=E.length>0?E.split(",").map(I=>I.trim()).filter(I=>I.length>0):[];if(N.length>=2){const I=()=>({c:0,d:0,e:0,f:0,g:0,a:0,b:0,r:0,n:0}),X=T=>T.split(/t\s*[1-9]\d*/i).filter(Boolean),at=T=>{const P=I(),V=T.toLowerCase();for(let R=0;R<V.length;R++)switch(V[R]){case"c":P.c++;break;case"d":P.d++;break;case"e":P.e++;break;case"f":P.f++;break;case"g":P.g++;break;case"a":P.a++;break;case"b":P.b++;break;case"r":P.r++;break;case"n":P.n++;break}return P};N.map(T=>{const P=X(T).map(at),V=P.reduce((R,O)=>({c:R.c+O.c,d:R.d+O.d,e:R.e+O.e,f:R.f+O.f,g:R.g+O.g,a:R.a+O.a,b:R.b+O.b,r:R.r+O.r,n:R.n+O.n}),I());return{perSegment:P,total:V}});const dt=N.map(T=>X(T)),ut=N.map(T=>T.match(/t\s*[1-9]\d*/ig)||[]),At=N.map(T=>/^\s*t\s*[1-9]\d*/i.test(T)),Bt=dt.length>0?Math.min(...dt.map(T=>T.length)):0,Le=Array.from({length:Bt},(T,P)=>dt.map(V=>V[P])),cn=Le.map(T=>T.map(P=>at(P))),ln=T=>T.c+T.d+T.e+T.f+T.g+T.a+T.b+T.r+T.n;Le.map((T,P)=>T.map((V,R)=>[V,ln(cn[P][R])]));const Se=(T,P,V)=>{if(V<=0)return T==="r"?`r${P}`:`${T}${P}`;const O=1<<Math.floor(Math.log2(V+1)),pt=P*O,tt=V-(O-1),F=[];for(let et=0;et<O;et++)et<Math.min(tt,O)?F.push(pt*2,pt*2):F.push(pt);let D="",It=-1;const me=et=>{It!==et&&(D+=`l${et}`,It=et)};if(T==="r"){for(let et=0;et<F.length;et++)me(F[et]),D+="r";return D}else{for(let et=0;et<F.length;et++)me(F[et]),et>0&&(D+="&"),D+=T;return D}},no=(T,P)=>{if(P<=0)return T;const R=/r(\d+)/i.exec(T);if(R){const D=parseInt(R[1],10),It=Se("r",D,P);return T.slice(0,R.index)+It+T.slice(R.index+R[0].length)}const pt=/r(?!\d)/i.exec(T);if(pt){const It=Se("r",8,P);return T.slice(0,pt.index)+It+T.slice(pt.index+1)}const F=/([cdefgabn])(\d+)/i.exec(T);if(F){const D=F[1],It=parseInt(F[2],10),me=Se(D,It,P);return T.slice(0,F.index)+me+T.slice(F.index+F[0].length)}return T},oo=Le.map((T,P)=>{const V=cn[P].map(ln),R=Math.max(...V);return T.map((O,pt)=>{const tt=V[pt],F=R-tt;return no(O,F)})}),ro=N.map((T,P)=>{const V=oo.map(D=>D[P]||""),R=(dt[P]||[]).slice(Bt),O=ut[P]||[],pt=At[P],tt=[];let F=0;if(pt){for(let D=0;D<V.length;D++)F<O.length&&tt.push(O[F++]),tt.push(V[D]);for(let D=0;D<R.length;D++)F<O.length&&tt.push(O[F++]),tt.push(R[D])}else{V.length>0&&tt.push(V[0]);for(let D=1;D<V.length;D++)F<O.length&&tt.push(O[F++]),tt.push(V[D]);for(let D=0;D<R.length;D++)F<O.length&&tt.push(O[F++]),tt.push(R[D])}for(;F<O.length;)tt.push(O[F++]);return tt.join("")});p.value=`MML@${ro.join(",")};`,$()}}S(),k.onclick=x,e.onclick=C=>{C.target===e&&x()},h.onclick=()=>{navigator.clipboard.writeText(p.value),h.textContent=y[v].copied,setTimeout(()=>{h.textContent=y[v].convertCopy},2e3)},b.onclick=()=>{try{const C=new Blob([p.value],{type:"text/plain;charset=utf-8"}),E=document.createElement("a");E.href=URL.createObjectURL(C);const N=(i.value||"").trim(),I=`mml-${new Date().toISOString().replace(/[:.]/g,"-")}.txt`;let X=N.length>0?N:I;X=X.replace(/[\\\/:*?"<>|]/g,"_"),/\.txt$/i.test(X)||(X+=".txt"),E.download=X,document.body.appendChild(E),E.click(),setTimeout(()=>{URL.revokeObjectURL(E.href),E.parentNode&&E.parentNode.removeChild(E)},0)}catch{}},window.addEventListener("keydown",w,!0)}function hn(){const t=document.createElement("div");t.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `;const e=document.createElement("div");e.id="guideModalContent",e.style.cssText=`
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        max-width: 600px;
        width: 90%;
        max-height: 80%;
        overflow-y: auto;
        position: relative;
    `,Ot();const n=Nt({label:"✕",variant:"ghost",size:"sm",title:y[v].modalClose,attrs:{"data-i18n-title":"modalClose"}});n.style.position="absolute",n.style.top="10px",n.style.right="10px";const r=o=>{o.key==="Escape"&&a()};function a(){window.removeEventListener("keydown",r,!0),t.parentNode&&document.body.removeChild(t)}n.onclick=a,fo(e),e.appendChild(n),t.appendChild(e),document.body.appendChild(t),window.addEventListener("keydown",r,!0)}let Et=null,ht=null,Zt=null,Qt=null,Gt=null;function wo(t,e,n){if(Et||Mo(),!Et||!ht||!Zt||!Qt)return;ht.value=(n??t.mmlString)||"",Et.style.display="flex",ht.focus();const r=o=>{o.stopPropagation()};ht.addEventListener("keydown",r),ht.addEventListener("keyup",r);function a(){Et.style.display="none",ht.removeEventListener("keydown",r),ht.removeEventListener("keyup",r),Zt.onclick=null,Qt.onclick=null,Gt&&(window.removeEventListener("keydown",Gt,!0),Gt=null)}Zt.onclick=()=>{e(ht.value),a()},Qt.onclick=a,Gt=o=>{o.key==="Escape"&&(o.stopPropagation(),a())},window.addEventListener("keydown",Gt,!0)}function Mo(){Et=document.createElement("div"),Et.id="mmlEditModal",Et.style.cssText=`
    position: fixed; 
    left: 0; top: 0; 
    width: 100vw; 
    height: 100vh;
    background: rgba(0,0,0,0.25); 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    z-index: 200;
    display: none;
  `;const t=document.createElement("div");t.style.cssText=`
            background: #fff;
            padding: 24px;
            border-radius: 8px;
            min-width: 400px;
            box-shadow: 0 2px 16px #0002;
            display: flex;
            flex-direction: column;
            gap: 12px;
        `,ht=document.createElement("textarea"),ht.style.cssText=`
            width: 100%;
            min-height: 120px;
            font-family: monospace;
            font-size: 15px;
            word-break: break-all;
            overflow-x: wrap;
        `,Ot(),Zt=Nt({label:y[v].ok,variant:"primary",attrs:{"data-i18n":"ok"}}),Qt=Nt({label:y[v].cancel,variant:"secondary",attrs:{"data-i18n":"cancel"}});const e=document.createElement("div");e.style.cssText=`
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        `,e.append(Qt,Zt),t.append(ht,e),Et.appendChild(t),document.body.appendChild(Et)}function To(){return{scrollX:0,scrollY:0,keyHeight:16,activeTrackId:1,selectedLength:16,hover:{noteId:null,edge:null},drag:null,ghost:null,ghostGroup:null,selected:new Set,marquee:{active:!1,x0:0,y0:0,x1:0,y1:0,mode:"replace"},clipboard:null,volumeLabels:new Set}}function Eo(t,e,n,r,a,o,i){t.save();const d=window.devicePixelRatio||1;t.setTransform(d,0,0,d,0,0);const c=t.canvas.clientWidth||t.canvas.width/d,l=t.canvas.clientHeight||t.canvas.height/d;t.clearRect(0,0,c,l),Ao(t,e,n,r,a),Io(t,n,e,r),Po(t,e,n,r,a),No(t,e,n,r,a),_o(t,n,r),Co(t,e,r,a,l),t.restore()}function Nn(t,e,n,r,a){const o=window.devicePixelRatio||1;t.setTransform(o,0,0,o,0,0);const i=e.clientWidth||e.width/o,d=e.clientHeight||e.height/o;t.clearRect(0,0,i,d),t.fillStyle="#ffffff",t.fillRect(0,0,i,d);const c=84*r.keyHeight;Lo(t,0,i,r),So(t,n,0,i,c,a)}function te(t,e,n,r,a,o){const i=Math.max(0,Math.min(o,Math.floor(Math.min(r,a)/2))),d=Math.floor(e),c=Math.floor(n),l=d+Math.max(0,r),m=c+Math.max(0,a);if(t.beginPath(),i<=0){t.rect(d,c,r,a);return}t.moveTo(d+i,c),t.lineTo(l-i,c),t.arcTo(l,c,l,c+i,i),t.lineTo(l,m-i),t.arcTo(l,m,l-i,m,i),t.lineTo(d+i,m),t.arcTo(d,m,d,m-i,i),t.lineTo(d,c+i),t.arcTo(d,c,d+i,c,i)}function Lo(t,e,n,r){const a=r.keyHeight,o=84*a,i=Math.ceil(o/a);for(let d=0;d<i;d++){const c=d*a,m=((95-d)%12+12)%12,f=m===1||m===3||m===6||m===8||m===10;t.fillStyle=f?"#d6d6d6":"#ffffff",t.fillRect(e,c,Math.max(0,n),a);const p=m===11;t.strokeStyle=p?"#000000":"rgb(153,153,153)",t.beginPath(),t.moveTo(e,c+.5),t.lineTo(e+Math.max(0,n),c+.5),t.stroke()}}function So(t,e,n,r,a,o){const i=q[e.zoomLevel-1],d=o&&o>=1?o:e.timeSig.beatsPerBar,c=Math.max(0,Math.floor(n/i)-2),l=Math.floor((n+r)/i)+2;for(let f=c;f<=l;f++){const p=Math.floor(f*i),g=f%d===0;t.strokeStyle=g?"#000":"rgb(128,128,128)",t.beginPath(),t.moveTo(p,0),t.lineTo(p,a),t.stroke()}const m=e.zoomLevel;m>=4&&Ce(t,n,r,a,i,2,"rgb(191,191,191)"),m>=6&&Ce(t,n,r,a,i,4,"rgb(191,191,191)"),m>=8&&Ce(t,n,r,a,i,8,"rgb(191,191,191)")}function Ce(t,e,n,r,a,o,i){const d=Math.max(0,Math.floor(e/a)-2),c=Math.floor((e+n)/a)+2;t.strokeStyle=i;for(let l=d;l<=c;l++)for(let m=1;m<o;m+=2){const f=Math.floor((l+m/o)*a);t.beginPath(),t.moveTo(f,0),t.lineTo(f,r),t.stroke()}}function Co(t,e,n,r,a){const o=e.tempoAnchors||[];if(!o||o.length===0)return;const i=q[e.zoomLevel-1];t.save(),t.strokeStyle="rgba(159, 215, 255, 0.9)",t.lineWidth=1;for(const d of o){const c=Math.round(d.tick/L*i);if(c+1<n||c-1>n+r)continue;const l=c-Math.floor(n)+.5;t.beginPath(),t.moveTo(l,0),t.lineTo(l,a),t.stroke()}t.restore()}function Ao(t,e,n,r,a){const o=q[e.zoomLevel-1],i=n.activeTrackId,d=[...e.tracks].sort((c,l)=>c.id===i?1:l.id===i?-1:0);for(const c of d){const l=c.id===i?1:.5;t.globalAlpha=l;for(const m of c.notes){const f=Math.round(m.startTick/L*o),p=Math.max(1,Math.round(m.durationTick/L*o));if(f+p<r||f>r+a)continue;const g=f-Math.floor(r);Bo(t,g,m,c.color,o,n.keyHeight,n.hover,c.id===i,n.selected.has(m.id))}}t.globalAlpha=1}function Bo(t,e,n,r,a,o,i,d,c){const l=Math.max(1,Math.round(n.durationTick/L*a)),m=(95-n.pitch)*o+1,f=o-1,p=Math.min(6,Math.floor(f/2));if(t.fillStyle=r,te(t,e,m,l,f,p),t.fill(),t.strokeStyle="rgba(0,0,0,0.3)",t.lineWidth=1,te(t,e,m,l-1,f-1,Math.max(0,p-1)),t.stroke(),c&&(t.strokeStyle="#3a7afe",t.lineWidth=2,te(t,e,m,l-1,f-1,Math.max(0,p-1)),t.stroke(),t.lineWidth=1),d&&i.noteId===n.id){const g=Math.min(8,Math.floor(l/3));t.fillStyle="rgba(0,0,0,0.15)",t.fillRect(e,m,g,f),t.fillRect(e+l-g,m,g,f)}}function Io(t,e,n,r){const a=q[n.zoomLevel-1],o=i=>{const d=Math.round(i.startTick/L*a)-Math.floor(r),c=Math.max(1,Math.round(i.durationTick/L*a)),l=(95-i.pitch)*e.keyHeight+1,m=e.keyHeight-1;t.globalAlpha=.7,t.fillStyle=i.color;const f=Math.min(6,Math.floor(m/2));te(t,d,l,c,m,f),t.fill(),t.globalAlpha=1};if(e.ghost&&o(e.ghost),e.ghostGroup)for(const i of e.ghostGroup)o(i)}function Po(t,e,n,r,a){const o=q[e.zoomLevel-1],i=n.keyHeight;t.strokeStyle="#3a7afe",t.lineWidth=2;for(const d of e.tracks)for(const c of d.notes){if(!n.selected.has(c.id))continue;const l=Math.round(c.startTick/L*o)-Math.floor(r),m=Math.max(1,Math.round(c.durationTick/L*o)),f=l+Math.floor(r);if(f+m<r||f>r+a)continue;const p=(95-c.pitch)*i+1,g=i-1,h=Math.min(6,Math.floor(g/2));te(t,l,p,m-1,g-1,Math.max(0,h-1)),t.stroke()}t.lineWidth=1}function No(t,e,n,r,a){if(!n.volumeLabels||n.volumeLabels.size===0)return;const o=q[e.zoomLevel-1],i=n.keyHeight;t.font="10px sans-serif",t.textAlign="left",t.textBaseline="bottom";for(const d of e.tracks)for(const c of d.notes){if(!n.volumeLabels.has(c.id))continue;const l=Math.round(c.startTick/L*o),m=Math.max(1,Math.round(c.durationTick/L*o));if(l+m<r||l>r+a)continue;const f=l-Math.floor(r),p=(95-c.pitch)*i+1,g="V"+String(c.volume??W);t.fillStyle="rgba(255,255,255,0.9)",t.fillText(g,f+1,p-1),t.fillStyle="rgba(0,0,0,0.85)",t.fillText(g,f,p-2)}}function _o(t,e,n){if(!e.marquee.active)return;const r=Math.min(e.marquee.x0,e.marquee.x1)-Math.floor(n),a=Math.min(e.marquee.y0,e.marquee.y1),o=Math.abs(e.marquee.x1-e.marquee.x0),i=Math.abs(e.marquee.y1-e.marquee.y0);t.fillStyle="rgba(58,122,254,0.15)",t.fillRect(r,a,o,i),t.strokeStyle="rgba(58,122,254,0.8)",t.setLineDash([4,3]),t.strokeRect(r+.5,a+.5,o-1,i-1),t.setLineDash([])}function He(t,e,n,r,a){for(let o=n.length-1;o>=0;o--){const i=n[o],d=Math.round(i.startTick/L*r),c=Math.max(1,Math.round(i.durationTick/L*r)),l=(95-i.pitch)*a+1,m=a-1;if(t>=d&&t<=d+c&&e>=l&&e<=l+m){const f=Math.min(8,Math.floor(c/3)),p=t<=d+f?"left":t>=d+c-f?"right":"center";return{note:i,edge:p}}}}function zo(t,e,n,r,a,o,i){const d=Math.min(t,n),c=Math.max(t,n),l=Math.min(e,r),m=Math.max(e,r),f=[];for(const p of a){const g=Math.round(p.startTick/L*o),h=Math.max(1,Math.round(p.durationTick/L*o)),b=(95-p.pitch)*i+1,k=i-1,x=g+h,w=b+k;x>=d&&g<=c&&w>=l&&b<=m&&f.push(p)}return f}function Ro(t,e,n){t.clearRect(0,0,e.width,e.height);const r=window.devicePixelRatio||1,a=12*n;for(let o=0;o<7;o++){const i=(6-o)*a,d=o%2===1;t.fillStyle=d?"#e6e6e6":"#ffffff",t.fillRect(0,i,e.width/r,a),t.fillStyle="#222",t.font=`${Math.max(10,Math.round(12))}px system-ui, sans-serif`,t.textBaseline="middle",t.textAlign="center";const c="o"+(o+1),l=i+a/2;t.fillText(c,Math.floor(e.width/r/2),Math.floor(l))}}function Do(t,e,n,r,a,o,i){const d=e.width,c=e.height,l=window.devicePixelRatio||1;t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,d,c),l!==1&&t.setTransform(l,0,0,l,0,0);const m=d/l,f=c/l;t.fillStyle="#ffffff",t.fillRect(0,0,m,f);const p=Math.floor(n/r),g=Math.ceil((n+m)/r);for(let k=p;k<=g;k++){const x=Math.round(k*r-n)+.5;if(k%a===0){t.strokeStyle="#000000",t.beginPath(),t.moveTo(x,0),t.lineTo(x,f),t.stroke();const A=Math.floor(k/a)+1;t.fillStyle="#222",t.font="12px system-ui, sans-serif",t.textAlign="left",t.textBaseline="top",t.fillText(String(A),x+4,2)}else{t.strokeStyle="rgb(128,128,128)";const A=Math.floor(f*.5);t.beginPath(),t.moveTo(x,A),t.lineTo(x,f),t.stroke()}}const h=o,b=h&&Array.isArray(h.tempoAnchors)?h.tempoAnchors:[];if(b&&b.length>0){t.save();const k=Math.max(9,Math.min(13,Math.floor(f*.6)));t.font=`${k}px system-ui, sans-serif`,t.textAlign="center",t.textBaseline="middle";for(const x of b){const w=x.tick/L*r,A=Math.round(w-n)+.5;if(A<-40||A>m+40)continue;const B=i!=null&&x.tick===i,$="t"+String(x.bpm),M=t.measureText($),S=(M.actualBoundingBoxAscent||k*.8)+(M.actualBoundingBoxDescent||k*.2),H=Math.max(4,Math.floor(k*.5)),C=Math.max(2,Math.floor(k*.3)),E=Math.ceil(S)+C*2,N=Math.ceil(M.width)+H*2;let X=f-E-2;X<.5&&(X=.5);const at=Math.floor(A-N/2)+.5,dt=B?"#7cc7ff":"#bfe7ff",ut=B?"#2f9dff":"#5bb6ff",At="#003";t.fillStyle=dt,t.strokeStyle=ut,t.lineWidth=1,t.beginPath(),t.rect(at,X,N,E),t.fill(),t.stroke(),t.fillStyle=At;const Bt=X+E/2;t.fillText($,A,Math.floor(Bt))}t.restore()}}function gn(t,e,n){const r=window.devicePixelRatio||1,a=e.clientHeight||e.height/r;t.save(),t.setTransform(r,0,0,r,0,0),t.strokeStyle="rgba(255,0,0,0.9)",t.lineWidth=2,t.beginPath(),t.moveTo(Math.floor(n)+.5,0),t.lineTo(Math.floor(n)+.5,a),t.stroke(),t.restore()}function Wo(t,e,n,r){const a=window.devicePixelRatio||1,o=e.clientHeight||e.height/a;t.save(),t.setTransform(a,0,0,a,0,0),t.fillStyle="rgba(255,0,0,0.12)",t.fillRect(Math.floor(n),0,Math.ceil(r),o),t.restore()}function Ho(t,e){const n=document.createElement("div");n.style.cssText=`
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    `;const r=document.createElement("div");r.style.cssText=`
        background: #fff;
        width: min(640px, 92vw);
        max-height: 80vh;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        padding: 18px 18px 14px;
        position: relative;
        overflow: auto;
    `;const a=document.createElement("h2");a.textContent=y[v].whatsNewTitle||"What's new",a.style.margin="0 0 8px 0",a.style.fontSize="18px",a.setAttribute("data-i18n","whatsNewTitle");const o=document.createElement("div"),i=document.createElement("h3");i.textContent=y[v].whatsNew_20250827_heading||"Load behavior changed",i.setAttribute("data-i18n","whatsNew_20250827_heading"),i.style.margin="8px 0 6px 0";const d=document.createElement("ul");d.style.margin="6px 0 0 18px",d.style.padding="0";const c=document.createElement("li");c.textContent=y[v].whatsNew_20250827_p1||"Removed auto-load on page start.",c.setAttribute("data-i18n","whatsNew_20250827_p1");const l=document.createElement("li");l.textContent=y[v].whatsNew_20250827_p2||"Use the 'Load' button in the toolbar to restore saved work.",l.setAttribute("data-i18n","whatsNew_20250827_p2"),d.append(c,l),o.append(i,d),Ot();const m=Nt({label:y[v].ok||"OK",size:"sm",variant:"primary"});m.setAttribute("data-i18n","ok"),m.style.marginTop="12px",m.style.alignSelf="flex-end";const f=()=>{n.remove();try{localStorage.setItem("mml_editor_whatsnew_shown_"+t,"1")}catch{}};m.addEventListener("click",f);const p=g=>{g.key==="Escape"&&f()};window.addEventListener("keydown",p,{once:!0}),n.addEventListener("click",g=>{g.target===n&&f()}),r.append(a,o,m),n.appendChild(r),document.body.appendChild(n)}const Ft=document.getElementById("footerMmlEditBtn"),Ae=document.getElementById("footerMMLText"),Dt=document.getElementById("footerLabel"),fe=document.getElementById("btnPasteMML"),_n="mml_editor_project";let u=En();const _t=new ao,s=To(),Ze=new Worker(new URL(""+new URL("mmlOptimizerWorker-Ci7VCWUf.js",import.meta.url).href,import.meta.url),{type:"module"}),Be=new Map,Xo=300;let Ie=null;const bn=document.getElementById("progress"),K=document.getElementById("roll"),ot=document.getElementById("rollBg"),mt=document.getElementById("octaveCanvas");let _=null,nt=null,Yt=null,jt=null,Wt=null;const z=document.getElementById("timeRuler"),gt=K.getContext("2d"),ve=ot?ot.getContext("2d"):null,zn=mt.getContext("2d"),Xe=z.getContext("2d"),kn=document.getElementById("tracks"),ee=document.getElementById("lenBar"),Q=document.getElementById("dispSigN");let st=4;const yn="mml_editor_display_timesig_n",Y=document.getElementById("rollViewport"),St=document.getElementById("rulerContainer"),Jt=document.getElementById("customScrollbar"),ne=document.getElementById("customScrollbarThumb"),Oe=document.getElementById("btnPlay"),qe=document.getElementById("btnPause"),Fe=document.getElementById("btnStop"),Tt=document.getElementById("btnPlayheadMode"),pe=document.getElementById("btnConvert");let oe=null;function Oo(){if(!oe){const t=document.createElement("div");t.style.cssText="position:absolute;pointer-events:none;background:rgba(0,0,0,0.8);color:#fff;padding:4px 6px;border-radius:4px;font:12px system-ui, sans-serif;z-index:10;transform:translate(-50%, -120%);white-space:nowrap;display:none;",St.style.position="relative",St.appendChild(t),oe=t}return oe}const re=document.getElementById("btnGuide"),Mt=document.getElementById("btnLoad"),$e=document.getElementById("btnGoToMobile"),he=document.getElementById("langKo"),ge=document.getElementById("langJa"),be=document.getElementById("langEn"),qo=document.getElementById("btnPushBeat"),Fo=document.getElementById("btnPushBar"),$o=document.getElementById("btnCutBeat"),Uo=document.getElementById("btnCutBar"),bt=document.getElementById("keyHeightRange"),$t=document.getElementById("keyHeightLabel"),yt="rgba(255,215,0,0.8)";let J=!1,ct=0,Ue=0,Xt=!1,Vo=0,ae=0,ie=0,Qe=!1,ce=null;function Ct(){const t=document.getElementById("rulerContextMenu");t&&t.parentNode&&t.parentNode.removeChild(t)}const vt={pitch:null,sampler:null};let zt=-1,Pt="area";const Rn="mml_editor_key_height";(()=>{const t=()=>{try{Ln()}catch{}finally{window.removeEventListener("pointerdown",t),window.removeEventListener("keydown",t)}};window.addEventListener("pointerdown",t,{passive:!0}),window.addEventListener("keydown",t)})();const Z=document.createElement("button");$e&&$e.addEventListener("click",()=>{try{window.location.href="./mobile.html"}catch{}});function Ut(){const t=document.activeElement;if(!t)return;const e=t.tagName.toLowerCase();if((e==="input"||e==="select"||e==="textarea"||e==="button"||t.isContentEditable)&&!t.closest("#rollViewport, #roll, #rollBg, #timeRuler, #rulerContainer"))try{t.blur()}catch{}}function Dn(t){const e=t.target;return e?!!e.closest("#rollViewport, #roll, #rollBg, #timeRuler, #rulerContainer"):!1}function vn(t){const e={bpm:120,timeSig:{beatsPerBar:4},zoomLevel:1,tracks:[],maxEndTick:0,tpqn:t?.tpqn??L,extendedUnitsEnabled:t?.extendedUnitsEnabled??ft},n=Number(t?.bpm);e.bpm=Number.isFinite(n)&&n>0?n:120;const r=Number(t?.timeSig?.beatsPerBar);e.timeSig={beatsPerBar:Number.isFinite(r)&&r>=1?r:4};const a=Number(t?.zoomLevel);e.zoomLevel=Number.isFinite(a)&&a>=1&&a<=9?a:1;try{const c=Number(t?.displayBeatsPerBar);e.displayBeatsPerBar=Number.isFinite(c)&&c>=1&&c<=16?c:void 0}catch{}try{const l=(Array.isArray(t?.tempoAnchors)?t.tempoAnchors:[]).map(p=>({tick:Math.max(0,Math.floor(Number(p?.tick)||0)),bpm:Math.max(20,Math.min(We,Math.round(Number(p?.bpm)||e.bpm)))})),m=new Map;for(const p of l)m.set(p.tick,p.bpm);const f=Array.from(m.entries()).map(([p,g])=>({tick:p,bpm:g})).sort((p,g)=>p.tick-g.tick);e.tempoAnchors=f}catch{e.tempoAnchors=[]}const o=Array.isArray(t?.tracks)?t.tracks:[],i=Math.max(1,Math.min(6,o.length||6));for(let c=0;c<i;c++){const l=o[c]??{},f=(Array.isArray(l?.notes)?l.notes:[]).map($=>{const M=typeof $?.id=="string"&&$.id?$.id:crypto.randomUUID(),S=Math.max(0,Math.floor(Number($?.startTick)||0)),H=Math.max(1,Math.floor(Number($?.durationTick)||1)),C=Math.max(0,Math.floor(Number($?.pitch)||0)),E=Math.max(0,Math.min(15,Math.floor(Number($?.volume)||W)));return{id:M,startTick:S,durationTick:H,pitch:C,volume:E}}),p=typeof l?.instrument=="string"&&Ge.includes(l.instrument)?l.instrument:Ye,g=Number(l?.id)||c+1,h=Number.isFinite(Number(l?.order))?Number(l.order):c,b=typeof l?.name=="string"&&l.name?l.name:`Track ${c+1}`,k=typeof l?.color=="string"&&l.color?l.color:ze[c%ze.length],x=!!l?.mute,w=!!l?.solo,A=typeof l?.mmlString=="string"?l.mmlString:"",B=typeof l?.optimizedMML=="string"?l.optimizedMML:"";e.tracks.push({id:g,order:h,name:b,color:k,instrument:p,mmlString:A,optimizedMML:B,mute:x,solo:w,notes:f})}e.tracks.sort((c,l)=>c.order-l.order),e.tracks.forEach((c,l)=>{c.order=l});let d=0;for(const c of e.tracks)for(const l of c.notes)d=Math.max(d,l.startTick+l.durationTick);return e.maxEndTick=d,e}function Kt(){Ie==null&&(Ie=requestAnimationFrame(()=>{Ie=null,U()}))}function it(t,e,n){t.setAttribute("data-i18n-title",e),t.title=n||y[v][e]||""}function wt(t,e,n){t.classList.add("btn",`btn--${e}`,`btn--${n}`)}function Ht(t){return Math.max(0,Math.min(15,t))}function se(t){return Math.max(12,Math.min(95,t))}function xe(t){return t.sort((e,n)=>e.startTick-n.startTick||e.pitch-n.pitch)}function Wn(t){return t.sort((e,n)=>e.startTick-n.startTick||e.id.localeCompare(n.id))}function Ko(t,e){const n=e.volume??W;if(!s.volumeLabels)return;const r=Wn(t.notes.slice()),a=r.findIndex(d=>d.id===e.id),o=a>0?r[a-1].volume??W:W,i=r.slice(0,a).some((d,c,l)=>{const m=s.volumeLabels.has(d.id),f=c>0?l[c-1].volume??W:W,p=(d.volume??W)!==f;return m||p});n===W?i?s.volumeLabels.add(e.id):s.volumeLabels.delete(e.id):n!==o?s.volumeLabels.add(e.id):s.volumeLabels.delete(e.id)}function le(t){return Wn(t.notes.slice())}function Hn(t,e,n){if(e<0||e>=t.length)return!1;const r=t[e],a=e>0?t[e-1].volume??W:W,o=r.volume??W;return(n?.has(r.id)??!1)||o!==a}function Xn(t,e,n){const r=le(t),a=r.findIndex(i=>i.id===e.id);if(a<0)return;let o=r.length;for(let i=a+1;i<r.length;i++)if(Hn(r,i,s.volumeLabels)){o=i;break}for(let i=a;i<o;i++)r[i].volume=Ht(n)}function Go(t,e,n){const r=le(t),a=new Map(r.map(d=>[d.id,d.volume??W])),o=r.map((d,c)=>({n:d,i:c})).filter(d=>e.has(d.n.id)).map(d=>d.i).sort((d,c)=>d-c);let i=0;for(;i<o.length;){const d=o[i];let c=i+1;for(;c<o.length&&o[c]===o[c-1]+1;)c++;const l=d,m=o[c-1],f=l>0?a.get(r[l-1].id)??W:W;for(let g=l;g<=m;g++)r[g].volume=Ht(n);let p=m+1;for(;p<r.length&&e.has(r[p].id);)p++;p<r.length&&(r[p].volume=f),i=c}}function tn(t){if(!s.volumeLabels)return;const e=le(t),n=new Set(e.map(a=>a.id));for(const a of Array.from(s.volumeLabels))n.has(a)&&s.volumeLabels.delete(a);let r=W;for(const a of e){const o=a.volume??W;o!==r&&s.volumeLabels.add(a.id),r=o}}function Yo(){if(_)return;_=document.createElement("div"),_.style.position="fixed",_.style.zIndex="10000",_.style.background="#fff",_.style.border="1px solid #ccc",_.style.boxShadow="0 4px 12px rgba(0,0,0,0.15)",_.style.borderRadius="8px",_.style.padding="10px 12px",_.style.minWidth="220px",_.style.display="none",_.addEventListener("wheel",o=>o.stopPropagation(),{passive:!1});const t=document.createElement("div");t.style.marginBottom="8px",t.textContent=(y[v].volLabel||"볼륨")+" (0-15)",nt=document.createElement("input"),nt.type="range",nt.min="0",nt.max="15",nt.step="1",nt.value=String(W),nt.style.width="100%";const e=document.createElement("div");e.style.fontSize="12px",e.style.color="#555",e.style.marginTop="6px";const n=()=>{e.textContent="V"+(nt?.value??String(W))};nt.addEventListener("input",n),n();const r=document.createElement("div");r.style.display="flex",r.style.gap="8px",r.style.marginTop="10px",Yt=document.createElement("button"),Yt.className="btn btn--primary btn--sm",Yt.textContent=y[v].volApplyRange||"변경",jt=document.createElement("button"),jt.className="btn btn--secondary btn--sm",jt.textContent=y[v].volApplySelected||"선택한 노트만 변경",r.append(Yt,jt),_.append(t,nt,e,r),document.body.appendChild(_);const a=()=>{_&&(_.style.display="none"),Wt=null};document.addEventListener("keydown",o=>{_&&_.style.display!=="none"&&o.key==="Escape"&&a()}),document.addEventListener("mousedown",o=>{!_||_.style.display==="none"||_.contains(o.target)||a()}),Yt.addEventListener("click",()=>{if(!Wt||!nt)return;const o=u.tracks.find(c=>c.id===s.activeTrackId);if(!o)return;const i=o.notes.find(c=>c.id===Wt);if(!i)return;const d=Ht(parseInt(nt.value,10));Xn(o,i,d),j(),kt({track:o,recomputeLabels:!0}),_.style.display="none",Wt=null}),jt.addEventListener("click",()=>{if(!nt)return;const o=u.tracks.find(d=>d.id===s.activeTrackId);if(!o)return;const i=Ht(parseInt(nt.value,10));Go(o,new Set(s.selected),i),j(),kt({track:o,recomputeLabels:!0}),_.style.display="none",Wt=null})}function en(){_&&_.style.display!=="none"&&(_.style.display="none",Wt=null)}function jo(t,e,n){if(Yo(),!_||!nt)return;Wt=t.id;const r=t.volume??W;nt.value=String(r);const a=_.querySelector("div:nth-child(3)");a&&(a.textContent="V"+r),_.style.display="block";const o=_.getBoundingClientRect(),i=window.innerWidth,d=window.innerHeight;let c=e,l=n;c+o.width>i&&(c=Math.max(0,i-o.width-8)),l+o.height>d&&(l=Math.max(0,d-o.height-8)),_.style.left=`${c}px`,_.style.top=`${l}px`}function On(t){const e=Math.floor(ct);if(t!==0){for(const n of u.tracks){for(const r of n.notes)(r.startTick>=e||r.startTick+r.durationTick>e)&&(r.startTick+=t);xe(n.notes)}{const n=u.tempoAnchors;if(Array.isArray(n)&&n.length>0){const r=n.map(a=>a.tick>=e?{tick:a.tick+t,bpm:a.bpm}:{...a});u.tempoAnchors=$n(r)}}u.maxEndTick+=Math.max(0,t),j(),nn(u.tracks),rt(),Kt()}}function qn(t){const e=Math.floor(ct);if(t!==0){for(const n of u.tracks){const r=[];for(const a of n.notes){const o=a.startTick,i=a.startTick+a.durationTick;if(i<=e)r.push(a);else{if(o>=e&&o<e+t)continue;if(o>=e+t)r.push({...a,startTick:Math.max(e,o-t)});else if(o<e&&i>e){const d=e-o;d>0&&r.push({...a,durationTick:d})}}}xe(r),n.notes=r}{const n=u.tempoAnchors;if(Array.isArray(n)&&n.length>0){const r=n.filter(a=>!(a.tick>=e&&a.tick<e+t)).map(a=>a.tick>=e+t?{tick:a.tick-t,bpm:a.bpm}:{...a});u.tempoAnchors=$n(r)}}u.maxEndTick=Math.max(0,u.maxEndTick-t),j(),nn(u.tracks),rt(),Kt()}}function Fn(){return u.timeSig.beatsPerBar}function $n(t){const e=(t||[]).map(r=>({tick:Math.max(0,Math.floor(r.tick)),bpm:Math.round(r.bpm)}));e.sort((r,a)=>r.tick-a.tick||r.bpm-a.bpm);const n=[];for(const r of e){const a=n[n.length-1];!a||a.tick!==r.tick?n.push(r):n[n.length-1]=r}return n.length>0&&n[0].tick!==0&&(t||[]).some(a=>a.tick<=0)&&n.unshift({tick:0,bpm:n[0].bpm}),n.sort((r,a)=>r.tick-a.tick)}function Jo(){try{u.selectedLength=s.selectedLength,u.playheadVisualMode=Pt,u.tpqn=L,u.extendedUnitsEnabled=ft,u.displayBeatsPerBar=st,u.tempoChanges&&Array.isArray(u.tempoChanges);const t={...u,tracks:u.tracks.map(e=>({id:e.id,notes:e.notes,name:e.name,instrument:e.instrument,optimizedMML:e.optimizedMML,order:e.order,mute:e.mute,solo:e.solo,color:e.color}))};return localStorage.setItem(_n,JSON.stringify(t)),!0}catch(t){try{console.error("Save failed",t)}catch{}return!1}}let Pe=null;function rt(){Pe&&window.clearTimeout(Pe),Pe=window.setTimeout(()=>{Jo()},300)}function j(){_t.push(u),rt()}function Lt(t){const e=Be.get(t.id);e&&clearTimeout(e);const n=setTimeout(()=>{try{Ze.postMessage({track:t,tpqn:u.tpqn??L,tempoAnchors:u.tempoAnchors||[],defaultBpm:u.bpm})}catch{}Be.delete(t.id)},Xo);Be.set(t.id,n)}function nn(t){for(const e of t)try{Ze.postMessage({track:e,tpqn:u.tpqn??L,tempoAnchors:u.tempoAnchors||[],defaultBpm:u.bpm})}catch{}}function kt(t={}){const{track:e,recomputeLabels:n}=t;e&&(n&&tn(e),Lt(e),Rt()),Kt()}function on(){const t=document.querySelector(".panel.canvas-wrap");t&&(t.style.height="")}function Rt(){if(!Ae)return;const t=u.tracks.find(n=>n.id===s.activeTrackId)||u.tracks[0];let e=t&&(t.optimizedMML?.trim?.()||t.mmlString?.trim?.())||"";e=e.replace(/[\r\n]+/g,""),Ae.textContent=e,Ae.title=e}function Un(t,e){const n=(e||"").replace(/[\r\n]+/g,"").trim();t.mmlString=n;try{let r=u.bpm;const a=n.match(/^t(\d+)/);a&&(r=parseInt(a[1],10)),t.notes=mo("MML@"+n),u.tracks[0]===t&&(u.bpm=r),tn(t),j(),Lt(t),rt(),Kt()}catch{t.notes=[]}}function Zo(){const t=u.tracks.filter(a=>a.solo),e=t.length>0?t:u.tracks.filter(a=>!a.mute),n=a=>Ge.includes(a)?a:Ye,r=[];for(const a of e){const o=n(a.instrument||"lute");for(const i of a.notes)r.push({startTick:i.startTick,durationTick:i.durationTick,pitch:i.pitch,trackId:a.id,instrumentKey:o,volume:i.volume})}return r}function Qo(){lt(),jn(),Y&&new ResizeObserver(()=>{zt=-1,U()}).observe(Y),((o,i="ghost")=>{o&&wt(o,i,"sm")})($e,"secondary"),K.addEventListener("pointermove",o=>{Dn(o)&&Ut(),pr(o)}),K.addEventListener("pointerdown",o=>{Ut(),o.preventDefault(),hr(o)},{passive:!1}),window.addEventListener("pointerup",br),window.addEventListener("pointermove",gr),window.addEventListener("pointermove",o=>{window.lastPointerX=o.clientX,window.lastPointerY=o.clientY}),window.addEventListener("keydown",rr),window.addEventListener("keyup",or),window.addEventListener("wheel",lr,{passive:!1}),window.addEventListener("contextmenu",o=>{o.preventDefault()},{passive:!1}),Y.addEventListener("scroll",cr),z.addEventListener("click",o=>{Ut(),ue(o)}),z.addEventListener("pointerdown",o=>{Ut(),o.preventDefault(),vr(o)},{passive:!1}),z.addEventListener("contextmenu",o=>{o.preventDefault(),er(o)},{passive:!1}),window.addEventListener("pointermove",xr),window.addEventListener("pointerup",wr),z.addEventListener("mousemove",nr),z.addEventListener("mouseleave",()=>{oe&&(oe.style.display="none")}),Oe.addEventListener("click",eo),qe.addEventListener("click",Ke),Fe.addEventListener("click",Jn),bt?.addEventListener("input",()=>{const o=Math.max(16,Math.min(32,parseInt(bt.value,10)));if(o!==s.keyHeight){s.keyHeight=o;try{localStorage.setItem(Rn,String(o))}catch{}$t&&($t.textContent=String(o)),zt=-1,on(),U()}}),Tt&&Tt.addEventListener("click",()=>{Pt=Pt==="area"?"line":"area",Tt&&(Tt.textContent=Pt==="area"?y[v].playheadAreaLabel:y[v].playheadLineLabel),G(),rt()}),pe.addEventListener("click",tr),fe.addEventListener("click",()=>{J||Mr()});let e=!1,n=0,r=0;ne.addEventListener("pointerdown",o=>{e=!0,n=o.clientX,r=s.scrollX,ne.setPointerCapture(o.pointerId)}),window.addEventListener("pointermove",o=>{if(!e||J)return;const i=o.clientX-n,d=qt(),c=Math.max(0,d-Y.clientWidth),l=Math.max(1,Jt.clientWidth-ne.clientWidth),m=c/l,f=r+i*m;s.scrollX=Me(f),G()}),window.addEventListener("pointerup",()=>{e=!1}),re.addEventListener("click",hn),Mt&&(wt(Mt,"secondary","md"),Mt.textContent=y[v].load||"Load",it(Mt,"tooltipLoad",y[v].tooltipLoad||"Load project"),Mt.addEventListener("click",()=>{try{const o=localStorage.getItem(_n);if(!o){alert(y[v].noSavedProject||"No saved project found");return}const i=JSON.parse(o);if(!i||!i.tracks){alert(y[v].invalidSavedProject||"Saved data is invalid");return}let d=vn(i);const c=!!d.extendedUnitsEnabled;Sn(c);const l=c?Ne:_e,m=d.tpqn||l;if(m!==l){const f=l/m;Ve(d,f)}d.tpqn=l,d.extendedUnitsEnabled=c,typeof d.selectedLength=="number"&&(s.selectedLength=d.selectedLength),(d.playheadVisualMode==="area"||d.playheadVisualMode==="line")&&(Pt=d.playheadVisualMode),d=vn(d),u=d,s.selected.clear();try{s.volumeLabels?.clear()}catch{}for(const f of u.tracks)tn(f);Rt(),lt(),U(),alert(y[v].loadedFromLocal||"Loaded from local storage")}catch(o){try{console.error("Load failed",o)}catch{}alert(y[v].loadFailed||"Load failed")}}));const a=o=>{ho(o),to(),Tt&&(Tt.textContent=Pt==="area"?y[v].playheadAreaLabel:y[v].playheadLineLabel),Dt&&(Dt.textContent=y[v].trackMMLLabel||(o==="ja"?"トラックMML":o==="en"?"Track MML":"트랙MML")),Mt&&(Mt.textContent=y[v].load||(o==="ja"?"読み込み":o==="en"?"Load":"불러오기"),it(Mt,"tooltipLoad",y[v].tooltipLoad||Mt.title||"Load project")),bt&&(bt.title=y[v].tooltipKeyHeight||bt.title),$t&&($t.textContent=String(s.keyHeight)),lt(),Rt()};he.addEventListener("click",()=>a("ko")),ge.addEventListener("click",()=>a("ja")),be.addEventListener("click",()=>a("en")),re.addEventListener("click",hn)}function tr(){const t=u.tracks.slice().sort((e,n)=>e.order-n.order);for(const e of t)!(Array.isArray(e.notes)&&e.notes.length>0)||(An(e.notes??[])||Je(e.notes??[]));xo(u)}function we(t){const e=K.getBoundingClientRect(),n=t.clientX-e.left+s.scrollX,r=t.clientY-e.top;return{x:n,y:r}}function Vn(t){const e=z.getBoundingClientRect();return{x:t.clientX-e.left+s.scrollX}}function Kn(t){const e=q[u.zoomLevel-1],n=s.scrollX,r=u.tempoAnchors||[];for(let a=0;a<r.length;a++){const o=Math.round(r[a].tick/L*e-n)+.5;if(Math.abs(o-t)<=6)return{index:a,tick:r[a].tick}}return null}function er(t){const e=z.getBoundingClientRect(),n=t.clientX-e.left,r=Kn(n),a=St,o=document.getElementById("rulerContextMenu");o&&o.parentNode&&o.parentNode.removeChild(o);const i=document.createElement("div");i.id="rulerContextMenu",i.style.cssText="position:absolute;z-index:20;background:#fff;border:1px solid #ccc;border-radius:6px;box-shadow:0 6px 16px rgba(0,0,0,0.2);padding:4px;min-width:160px;font:13px system-ui,sans-serif;";const d=(h,b)=>{const k=document.createElement("button");return k.type="button",k.textContent=h,k.style.cssText="display:block;width:100%;text-align:left;background:none;border:0;padding:8px 10px;cursor:pointer;",k.onmouseenter=()=>k.style.background="#f2f2f2",k.onmouseleave=()=>k.style.background="transparent",k.onclick=()=>{b(),c()},k},c=()=>{i.parentNode&&i.parentNode.removeChild(i)},{x:l}=Vn(t),m=q[u.zoomLevel-1],f=xt(s.selectedLength),p=Te(Math.max(0,Math.floor(l/m*L)),f);r?(i.appendChild(d("템포 수정…",()=>xn(u.tempoAnchors[r.index].bpm,h=>{u.tempoAnchors[r.index].bpm=h,u.tempoAnchors[r.index].tick===0&&(u.bpm=h),u.tempoAnchors.sort((b,k)=>b.tick-k.tick),j();for(const b of u.tracks)Lt(b);rt(),U()}))),i.appendChild(d("템포 삭제",()=>{u.tempoAnchors.splice(r.index,1),ce=null,j();for(const h of u.tracks)Lt(h);rt(),U()}))):(i.appendChild(d("여기에 템포 생성…",()=>xn(u.bpm,h=>{const b=u.tempoAnchors||[];b.push({tick:p,bpm:h}),b.sort((k,x)=>k.tick-x.tick),u.tempoAnchors=b,p===0&&(u.bpm=h),rn(p),j();for(const k of u.tracks)Lt(k);rt(),U()}))),i.appendChild(d("모든 템포 제거",()=>{if(!(!Array.isArray(u.tempoAnchors)||u.tempoAnchors.length===0)){u.tempoAnchors=[],ce=null,j();for(const h of u.tracks)Lt(h);rt(),U()}}))),a.style.position="relative",i.style.left=`${Math.floor(n)}px`;const g=s.keyHeight;i.style.top=`${Math.max(0,Math.floor(g-26))}px`,a.appendChild(i),setTimeout(()=>{const h=b=>{const k=b.target;(!k||!i.contains(k))&&c()};window.addEventListener("mousedown",h,{once:!0,capture:!0}),window.addEventListener("wheel",()=>c(),{once:!0,capture:!0}),window.addEventListener("resize",()=>c(),{once:!0,capture:!0})},0)}function xn(t,e){const n=document.createElement("div");n.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:1000;display:flex;align-items:center;justify-content:center;";const r=document.createElement("div");r.style.cssText="background:#fff;border-radius:8px;padding:16px;min-width:260px;box-shadow:0 10px 24px rgba(0,0,0,0.25);display:flex;flex-direction:column;gap:12px;";const a=document.createElement("div");a.textContent="템포 설정";const o=document.createElement("input");o.type="number",o.min="20",o.max=String(We),o.step="1",o.value=String(t),o.style.cssText="font-size:16px;padding:8px;";const i=document.createElement("div");i.style.cssText="display:flex;gap:8px;justify-content:flex-end;";const d=document.createElement("button");d.textContent="취소";const c=document.createElement("button");c.textContent="확인",c.style.cssText="background:#3a7afe;color:#fff;border:0;border-radius:6px;padding:6px 12px;",i.append(d,c),r.append(a,o,i),n.appendChild(r),document.body.appendChild(n);const l=()=>{n.parentNode&&document.body.removeChild(n)};d.onclick=l,c.onclick=()=>{const m=Math.max(20,Math.min(We,Math.round(Number(o.value||t))));Number.isFinite(m)&&e(m),l()},o.addEventListener("keydown",m=>{m.key==="Enter"&&c.click(),m.key==="Escape"&&l()}),setTimeout(()=>o.focus(),0)}function nr(t){const e=Oo(),n=z.getBoundingClientRect(),r=t.clientX-n.left,a=q[u.zoomLevel-1],o=s.scrollX,i=u.tempoAnchors||[];let d=null;for(const c of i){const l=Math.round(c.tick/L*a-o)+.5;if(Math.abs(l-r)<=6){d={cssX:l,bpm:c.bpm,tick:c.tick};break}}if(d){const c=Math.floor(d.tick/L/u.timeSig.beatsPerBar)+1,l=Math.floor(d.tick/L%u.timeSig.beatsPerBar)+1;e.textContent=`t${d.bpm} @ ${c}.${l}`,e.style.left=`${Math.floor(d.cssX)}px`;const m=s.keyHeight;e.style.top=`${Math.max(0,Math.floor(m-22))}px`,e.style.display="block"}else e.style.display="none"}function rn(t){const e=xt(s.selectedLength),r=Math.max(0,(a=>Te(a,e))(t));for(const a of u.tracks){const o=[];for(const i of a.notes){const d=i.startTick,c=i.startTick+i.durationTick;if(c<=r||d>=r){o.push(i);continue}const l=Math.max(1,r-d),m=Math.max(1,c-r),f={...i,durationTick:l},p={...i,id:crypto.randomUUID(),startTick:r,durationTick:m};p.__tiedFromPrev=!0,o.push(f,p)}o.sort((i,d)=>i.startTick-d.startTick||i.pitch-d.pitch),a.notes=o}}function or(t){t.key==="Alt"&&(Qe=!1,U()),Ct()}function rr(t){en(),Ct();const e=document.activeElement;if(e&&(e.tagName==="INPUT"||e.tagName==="TEXTAREA"||e.tagName==="SELECT"||e.isContentEditable))return;t.key==="Alt"&&(t.preventDefault(),Qe=!0,U());for(let o=1;o<=9;o++)t.key===o.toString()&&Tn(o-1);if(t.key==="0"&&Tn(Vt.length-1),J){t.code==="Space"&&(t.preventDefault(),Ke());return}if((t.key==="ArrowUp"||t.key==="ArrowDown")&&t.shiftKey){const o=document.activeElement;if(o&&(o.tagName==="INPUT"||o.tagName==="SELECT"))return;t.preventDefault();const i=u.tracks.find(p=>p.id===s.activeTrackId);if(!i)return;const d=i.notes.filter(p=>s.selected.has(p.id));if(d.length===0)return;const c=p=>Math.floor(dn(p)/12),l=Math.min(...d.map(p=>c(p.pitch))),m=Math.max(...d.map(p=>c(p.pitch)));if(t.key==="ArrowUp"&&m>=7||t.key==="ArrowDown"&&l<=1)return;const f=t.key==="ArrowUp"?12:-12;for(const p of i.notes)s.selected.has(p.id)&&(p.pitch=dn(p.pitch+f));j(),kt({track:i,recomputeLabels:!0});return}if((t.key==="ArrowUp"||t.key==="ArrowDown")&&!t.shiftKey&&!t.ctrlKey&&!t.metaKey&&!t.altKey){const o=document.activeElement;if(o&&(o.tagName==="INPUT"||o.tagName==="SELECT"))return;t.preventDefault();const i=u.tracks.slice().sort((m,f)=>m.order-f.order),d=i.findIndex(m=>m.id===s.activeTrackId);if(d===-1)return;const c=t.key==="ArrowUp"?-1:1,l=Math.max(0,Math.min(i.length-1,d+c));l!==d&&(s.activeTrackId=i[l].id,lt(),U(),Rt());return}const n=t.ctrlKey||t.metaKey;if(n&&t.key.toLowerCase()==="z"){t.preventDefault();const o=_t.undo(u);o&&(u=o,typeof u.displayBeatsPerBar=="number"&&(st=u.displayBeatsPerBar,Q&&Q.value!==String(st)&&(Q.value=String(st))),s.selected.clear(),U(),lt());return}if(n&&t.key.toLowerCase()==="y"){t.preventDefault();const o=_t.redo(u);o&&(u=o,typeof u.displayBeatsPerBar=="number"&&(st=u.displayBeatsPerBar,Q&&Q.value!==String(st)&&(Q.value=String(st))),s.selected.clear(),U(),lt());return}if(n&&t.key.toLowerCase()==="a"){t.preventDefault(),ar();return}if(t.key==="Escape"){s.selected.clear(),s.marquee.active=!1,s.drag=null,s.ghost=null,U();return}if(t.key==="Delete"){Gn();return}if(n&&t.key.toLowerCase()==="c"){t.preventDefault(),Yn();return}if(n&&t.key.toLowerCase()==="v"){t.preventDefault(),sr();return}if(n&&t.key.toLowerCase()==="x"){t.preventDefault(),ir();return}if(t.code==="Space"){t.preventDefault(),J?Ke():eo();return}const r=q[u.zoomLevel-1],a=u.timeSig.beatsPerBar*r;if(t.key==="PageDown"){t.preventDefault(),s.scrollX=Math.max(0,Math.ceil((s.scrollX+1)/a)*a),G();return}if(t.key==="PageUp"){t.preventDefault(),s.scrollX=Math.max(0,Math.floor((s.scrollX-1)/a)*a),G();return}if(t.key==="Home"){t.preventDefault(),s.scrollX=0,G();return}if(t.key==="End"){t.preventDefault();const o=qt();s.scrollX=Me(Math.max(0,o-Y.clientWidth)),G();return}}function ar(){s.selected.clear();const t=u.tracks.find(e=>e.id===s.activeTrackId);for(const e of t.notes)s.selected.add(e.id);U()}function Gn(){if(s.selected.size===0)return;const t=u.tracks.find(e=>e.id===s.activeTrackId);t.notes=t.notes.filter(e=>!s.selected.has(e.id)),s.selected.clear(),j(),kt({track:t})}function Yn(){const e=u.tracks.find(r=>r.id===s.activeTrackId).notes.filter(r=>s.selected.has(r.id));if(e.length===0)return;const n=Math.min(...e.map(r=>r.startTick));s.clipboard=e.map(r=>({...r,startTick:r.startTick-n}))}function ir(){Yn(),Gn()}function sr(){if(!s.clipboard||s.clipboard.length===0)return;const t=Math.max(0,Math.floor(ct)),e=u.tracks.find(n=>n.id===s.activeTrackId);e&&Re(async()=>{const{insertNoteWithOverlap:n,ensureBars:r}=await import("./timeline-Cty6ufw_.js").then(a=>a.z);return{insertNoteWithOverlap:n,ensureBars:r}},[],import.meta.url).then(({insertNoteWithOverlap:n,ensureBars:r})=>{if(s.selected.clear(),s.clipboard!=null)for(const a of s.clipboard){const o=crypto.randomUUID(),i={...a,id:o,startTick:Math.max(0,t+a.startTick)};n(u,e.id,i),r(u,i.startTick+i.durationTick),s.selected.add(o)}j(),kt({track:e})})}function cr(){const e=-Y.scrollTop+s.keyHeight;mt.style.transform=`translateY(${e}px)`,Ct()}function lr(t){if(Dn(t)&&Ut(),en(),Ct(),t.ctrlKey){t.preventDefault(),dr(t);return}if(t.altKey&&t.shiftKey&&s.selected.size>0&&!J){t.preventDefault();const e=t.deltaY>0?-1:1,n=u.tracks.find(l=>l.id===s.activeTrackId),r=le(n),a=new Map(r.map(l=>[l.id,l.volume??W])),o=new Set([...s.selected]),i=r.map((l,m)=>({n:l,i:m})).filter(l=>o.has(l.n.id)).map(l=>l.i).sort((l,m)=>l-m),d=new Map;for(const l of i){const m=r[l].id,f=a.get(m)??W;d.set(l,Ht(f+e))}let c=0;for(;c<i.length;){const l=i[c],m=d.get(l);let f=c+1;for(;f<i.length&&i[f]===i[f-1]+1&&d.get(i[f])===m;)f++;const p=l,g=i[f-1],h=p>0?a.get(r[p-1].id)??W:W;for(let k=p;k<=g;k++)r[k].volume=Ht(d.get(k));let b=g+1;for(;b<r.length&&o.has(r[b].id);)b++;b<r.length&&(r[b].volume=h,Ko(n,r[b])),c=f}kt({track:n,recomputeLabels:!0}),j();return}if(t.altKey&&!t.shiftKey&&s.selected.size>0&&!J){t.preventDefault();const e=t.deltaY>0?-1:1,n=u.tracks.find(a=>a.id===s.activeTrackId),r=n.notes.filter(a=>s.selected.has(a.id));if(r.length>0){const a=r.reduce((d,c)=>c.startTick<d.startTick?c:d),o=a.volume??W,i=Ht(o+e);Xn(n,a,i)}kt({track:n,recomputeLabels:!0}),j();return}if(t.shiftKey){t.preventDefault();const e=q[u.zoomLevel-1],n=u.timeSig.beatsPerBar*e,a=(Math.abs(t.deltaX)>Math.abs(t.deltaY)?t.deltaX:t.deltaY)>0?1:-1,o=qt(),i=Math.max(0,o-Y.clientWidth);let d=Math.max(0,Math.min(i,s.scrollX+a*n));if(J){const c=ct/L*e,l=Y.clientWidth,m=Math.max(0,Math.min(i,Math.floor(c-l))),f=Math.max(0,Math.min(i,Math.floor(c)));d=Math.max(m,Math.min(f,d));let p=Me(d);const g=Math.max(0,Math.min(i,Math.ceil(m/n)*n)),h=Math.max(0,Math.min(i,Math.floor(f/n)*n));g<=h?((p<g||p>h)&&(p=a>0?h:g),d=p):d=s.scrollX}s.scrollX=Me(d),G();return}}function dr(t){const e=t.deltaY>0?-1:1,n=Math.max(1,Math.min(9,u.zoomLevel+e));if(n===u.zoomLevel)return;const r=q[u.zoomLevel-1],a=Y.getBoundingClientRect(),o=Math.max(0,Math.min(t.clientX-a.left,a.width)),i=s.scrollX+o,d=r*u.timeSig.beatsPerBar,l=Math.max(0,Math.round(i/d)*d)/r*L;u.zoomLevel=n;const m=q[n-1],f=l/L*m,p=qt(),g=Math.max(0,p-Y.clientWidth);s.scrollX=Math.max(0,Math.min(g,f-o));const h=m*u.timeSig.beatsPerBar;s.scrollX=Math.max(0,Math.min(g,Math.floor(s.scrollX/h)*h)),zt=-1,U()}function lt(){Rt();const t=ze;kn.innerHTML="",u.tracks.slice().sort((n,r)=>n.order-r.order).forEach((n,r)=>{n.color=t[r%t.length],(!n.instrument||!Ge.includes(n.instrument))&&(n.instrument=Ye);const a=document.createElement("div");a.dataset.trackId=String(n.id),a.dataset.order=String(n.order);const o=n.id===s.activeTrackId;a.className="track-card",o&&a.classList.add("is-active");const i=document.createElement("div");i.className="track-color",i.style.cssText=`
            background: ${n.color};
        `;const d=document.createElement("div");d.className="track-main";const c=document.createElement("div");c.className="track-row track-row--top";const l=document.createElement("input");l.value=n.name,l.setAttribute("data-i18n-title","tooltipTrackName"),l.title=y[v].tooltipTrackName,c.style.width="100%",l.classList.add("track-name-input"),yo(l,{size:"sm"}),l.addEventListener("change",()=>{_t.push(u),n.name=l.value});const m=document.createElement("div");if(m.className="track-name",m.appendChild(l),c.appendChild(m),o){const g=document.createElement("div");g.className="track-reorder",g.style.marginLeft="auto",g.style.display="inline-flex",g.style.gap="6px";const h=document.createElement("button");h.type="button",h.textContent="▲",h.title="Move up",h.setAttribute("aria-label","Move track up"),h.style.width="24px",h.style.height="24px",h.style.fontSize="12px";const b=document.createElement("button");b.type="button",b.textContent="▼",b.title="Move down",b.setAttribute("aria-label","Move track down"),b.style.width="24px",b.style.height="24px",b.style.fontSize="12px";const k=u.tracks.length-1;h.disabled=n.order===0,b.disabled=n.order===k,h.addEventListener("click",x=>{x.stopPropagation(),wn(-1)}),b.addEventListener("click",x=>{x.stopPropagation(),wn(1)}),g.append(h,b),c.appendChild(g)}{const g=document.createElement("div");g.className="track-row track-row--middle",g.style.width="100%";const h=po(),b=ko({items:h,value:n.instrument,size:"sm",fullWidth:!0,onChange:M=>{_t.push(u),n.instrument=M}});b.el.setAttribute("data-i18n-title","tooltipInstrument"),b.el.title=y[v].tooltipInstrument;const k=document.createElement("div");k.className="track-instrument",k.appendChild(b.el),g.appendChild(k);const x=document.createElement("div");x.className="track-row track-row--bottom";const w=fr(n),A=document.createElement("span");A.className="track-charcount";const B=n.optimizedMML?.length||0,$=y[v].charUnit;A.textContent=`${B}${$}`,A.setAttribute("data-i18n-title","tooltipCharCount"),A.title=y[v].tooltipCharCount,x.append(w,A),d.append(c,g,x)}const f=[l];{const g=d.querySelector(".dropdown");g instanceof HTMLElement&&f.push(g),d.querySelectorAll(".track-controls button").forEach(b=>f.push(b))}c.querySelectorAll(".track-reorder button").forEach(g=>f.push(g)),f.forEach(g=>{g.addEventListener("mousedown",h=>h.stopPropagation()),g.addEventListener("mouseup",h=>h.stopPropagation())}),a.addEventListener("click",g=>{const h=g.target.tagName;h==="INPUT"||h==="SELECT"||h==="BUTTON"||g.target.isContentEditable||s.activeTrackId!==n.id&&(s.activeTrackId=n.id,lt(),U())}),a.append(i,d),kn.appendChild(a)})}function wn(t){const e=u.tracks.find(i=>i.id===s.activeTrackId);if(!e)return;const n=e.order,r=u.tracks.length-1,a=n+t;if(a<0||a>r)return;const o=u.tracks.find(i=>i.order===a);o&&(e.order=a,o.order=n),j(),lt(),rt()}function jn(){ee.innerHTML="",Ot(),Vt.forEach(t=>{const e=Nt({label:String(t),size:"sm",variant:t===s.selectedLength?"primary":"secondary"});t===s.selectedLength&&e.classList.add("active"),e.setAttribute("data-i18n-title","tooltipLength"),t===64?e.title=(y[v].tooltipLength||"Length")+" - 0 (주의: 인게임에서 박자가 어긋날 수 있음)":e.title=y[v].tooltipLength,e.addEventListener("click",()=>{an(t)}),t===48&&(e.style.marginRight="12px"),ee.appendChild(e)}),Z.textContent=ft?y[v].extendedLessLabel||"더 적은 단위":y[v].extendedMoreLabel||"더 많은 단위",Z.title=ft?y[v].tooltipExtendedLess||"기본 단위로 돌아가기":y[v].tooltipExtendedMore||"더 많은 단위 사용 (64/128/5/7/11)",Z.setAttribute("data-i18n",ft?"extendedLessLabel":"extendedMoreLabel"),it(Z,ft?"tooltipExtendedLess":"tooltipExtendedMore",Z.title),Z.setAttribute("aria-label",Z.title),Z.onclick=ur,ee.appendChild(Z)}function ur(){if(!ft){const e="mml_editor_warn_extended_shown";let n=!1;try{n=localStorage.getItem(e)==="1"}catch{}if(!n){if(!window.confirm(y[v].confirmEnableExtendedUnits||"Enable more units to use 64/128/5/7/11; existing ticks will be converted. Continue?"))return;try{localStorage.setItem(e,"1")}catch{}}Mn(!0)}else Mn(!1)}function Mn(t){j();const r=(t?Ne:_e)/(t?_e:Ne);Ve(u,r),Sn(t),u.tpqn=L,u.extendedUnitsEnabled=t;try{_t.transformSnapshots?.(a=>Ve(a,r))}catch{}mr(),jn(),U()}function mr(){if(!Vt.includes(s.selectedLength)){let t=Vt[0],e=Math.abs(t-s.selectedLength);for(const n of Vt){const r=Math.abs(n-s.selectedLength);r<e&&(t=n,e=r)}an(t)}}function Ve(t,e){if(!Number.isFinite(e)||e<=0)return;for(const r of t.tracks)for(const a of r.notes)a.startTick=Math.round(a.startTick*e),a.durationTick=Math.max(1,Math.round(a.durationTick*e));const n=t.tempoAnchors;if(Array.isArray(n)){for(const r of n)r.tick=Math.max(0,Math.round(r.tick*e));n.sort((r,a)=>r.tick-a.tick)}t.maxEndTick=Math.round(t.maxEndTick*e)}function an(t){if(!ee)return;s.selectedLength=t;const e=Array.from(ee.children);e.forEach(n=>n.classList.remove("active")),e.forEach(n=>{if(n instanceof HTMLButtonElement){const a=parseInt(n.textContent||"0",10)===t;a&&n.classList.add("active"),n.classList.remove("btn--primary","btn--secondary"),n.classList.add(a?"btn--primary":"btn--secondary")}}),U(),rt()}function fr(t){const e=document.createElement("div");e.className="track-controls";const n=(o,i,d)=>{const c=document.createElement("button");return c.textContent=o,c.style.cssText=`
            width: 24px;
            height: 24px;
            font-size: 12px;
            font-weight: bold;
            border-radius: 4px;
            border: 1px solid #ccc;
            cursor: pointer;
            background-color: ${i?d:"#fff"};
            color: ${i?"#fff":"#000"};
        `,c},r=n("M",t.mute,"#f44336");r.setAttribute("data-i18n-title","tooltipMute"),r.title=y[v].tooltipMute,r.addEventListener("click",()=>{t.mute=!t.mute,j(),lt()});const a=n("S",t.solo,"#ff9800");return a.setAttribute("data-i18n-title","tooltipSolo"),a.title=y[v].tooltipSolo,a.addEventListener("click",()=>{t.solo=!t.solo,j(),lt()}),e.append(r,a),e}function Tn(t){const e=Vt[t];typeof e=="number"&&an(e)}function pr(t){if(J){s.hover.noteId=null,s.hover.edge=null,K.style.cursor="not-allowed";return}const{x:e,y:n}=we(t),r=q[u.zoomLevel-1],a=u.tracks.find(o=>o.id===s.activeTrackId);if(!s.drag&&!s.marquee.active){const o=He(e,n,a.notes,r,s.keyHeight);o?(s.hover.noteId=o.note.id,s.hover.edge=o.edge,K.style.cursor=o.edge==="center"?"move":"ew-resize"):(s.hover.noteId=null,s.hover.edge=null,K.style.cursor="default"),G();return}if(s.marquee.active){s.marquee.x1=e,s.marquee.y1=n;const o=t.ctrlKey||t.metaKey,i=t.shiftKey;s.marquee.mode=o?"toggle":i?"add":"replace";const d=zo(s.marquee.x0,s.marquee.y0,s.marquee.x1,s.marquee.y1,a.notes,r,s.keyHeight),c=new Set(s.selected);if(s.marquee.mode==="replace"){s.selected.clear();for(const l of d)s.selected.add(l.id)}else if(s.marquee.mode==="add")for(const l of d)s.selected.add(l.id);else{s.selected=c;for(const l of d)s.selected.has(l.id)?s.selected.delete(l.id):s.selected.add(l.id)}G()}}function hr(t){if(Ut(),Ct(),Ln(),J){t.preventDefault(),K.style.cursor="not-allowed";return}if(en(),t.button===1){t.preventDefault(),Xt=!0,ue(t);return}if(t.button===2){t.preventDefault();const{x:f,y:p}=we(t),g=q[u.zoomLevel-1],h=u.tracks.find(k=>k.id===s.activeTrackId),b=He(f,p,h.notes,g,s.keyHeight);if(b)s.selected.has(b.note.id)||(s.selected.clear(),s.selected.add(b.note.id),G()),jo(b.note,t.clientX,t.clientY);else{const k=t.ctrlKey||t.metaKey,x=t.shiftKey;s.drag=null,s.ghost=null,s.marquee.active=!0,s.marquee.x0=f,s.marquee.y0=p,s.marquee.x1=f,s.marquee.y1=p,s.marquee.mode=k?"toggle":x?"add":"replace",G()}return}if(t.button!==0)return;const{x:e,y:n}=we(t),r=q[u.zoomLevel-1],a=u.tracks.find(f=>f.id===s.activeTrackId),o=He(e,n,a.notes,r,s.keyHeight);if(!o){const f=xt(s.selectedLength),p=e/r*L,g=Te(p,f),h=se(95-Math.floor(n/s.keyHeight)),b=xt(s.selectedLength),k=crypto.randomUUID();s.drag={kind:"create",trackId:s.activeTrackId,noteId:k,startTick:g,durationTick:b,pitch:h},s.ghost={startTick:g,durationTick:b,pitch:h,color:yt};const x=u.tracks.find(w=>w.id===s.activeTrackId);x&&ke(h,x.id,x.instrument,vt),G();return}const i=o.note,d=t.ctrlKey||t.metaKey,c=s.selected.has(i.id);d?c||s.selected.add(i.id):c||(s.selected.clear(),s.selected.add(i.id));{const f=u.tracks.find(p=>p.id===s.activeTrackId);f&&ke(i.pitch,f.id,f.instrument,vt)}const l=i.startTick,m=i.startTick+i.durationTick;if(o.edge==="center"){const f=Array.from(s.selected),p=u.tracks.find(h=>h.id===a.id).notes.filter(h=>s.selected.has(h.id)).map(h=>({id:h.id,startTick:h.startTick,pitch:h.pitch,durationTick:h.durationTick,volume:h.volume})),g=xt(s.selectedLength);ae=0,ie=0,s.moveGroup={trackId:a.id,ids:f,base:p,mouseStartX:e,mouseStartY:n,grid:g},s.drag={kind:"move",trackId:a.id,noteId:i.id,startTick0:l,yPitch0:i.pitch,mouseStartX:e,mouseStartY:n},s.ghost={startTick:i.startTick,durationTick:i.durationTick,pitch:i.pitch,color:yt},G();return}else o.edge==="left"?(s.drag={kind:"resize-left",trackId:a.id,noteId:i.id,startTick0:l,endTick0:m,mouseStartX:e},s.ghost={startTick:i.startTick,durationTick:i.durationTick,pitch:i.pitch,color:yt}):o.edge==="right"&&(s.drag={kind:"resize-right",trackId:a.id,noteId:i.id,startTick0:l,endTick0:m,mouseStartX:e},s.ghost={startTick:i.startTick,durationTick:i.durationTick,pitch:i.pitch,color:yt});G()}function gr(t){if(J)return;if(Xt){ue(t);return}if(s.marquee.active||!s.drag)return;const{x:e,y:n}=we(t),r=q[u.zoomLevel-1],a=xt(s.selectedLength);if(s.drag.kind==="move"||s.drag.kind==="resize-left"||s.drag.kind==="resize-right"){if(s.drag.kind==="move"){const l=document.elementFromPoint(t.clientX,t.clientY)?.closest?.(".track-card");document.querySelectorAll(".track-card.drop-hover").forEach(m=>m.classList.remove("drop-hover")),l&&parseInt(l.dataset.trackId||"-1",10)!==s.drag.trackId&&l.classList.add("drop-hover")}const o=u.tracks.find(c=>s.drag!=null&&c.id===s.drag.trackId),i=o.notes.findIndex(c=>s.drag!=null&&c.id===s.drag.noteId);if(i<0)return;const d=o.notes[i];if(s.drag.kind==="move"){const c=s.moveGroup;if(!c)return;const l=(e-c.mouseStartX)/r,m=Math.floor((c.mouseStartY-n)/s.keyHeight),f=l*L,p=Math.round(f/c.grid)*c.grid;ae=p,ie=m;const g=se(s.drag.yPitch0+m),h=u.tracks.find(w=>w.id===s.activeTrackId);h&&ke(g,h.id,h.instrument,vt),G();const b=r,k=s.scrollX,x=window.devicePixelRatio||1;gt.save(),gt.setTransform(x,0,0,x,0,0),gt.globalAlpha=.7,gt.fillStyle=yt;for(const w of c.base){const A=Math.max(0,w.startTick+p),B=Math.round(A/L*b)-Math.floor(k)+.5,$=Math.max(1,Math.round(w.durationTick/L*b)),S=(95-se(w.pitch+m))*s.keyHeight+.5,H=s.keyHeight-1;gt.fillRect(B,S,$,H)}gt.globalAlpha=1,gt.restore();return}if(s.drag.kind==="resize-left"){const c=(e-s.drag.mouseStartX)/r;let l=s.drag.startTick0+c*L,m=Math.max(0,Math.floor(l/a)*a);m=Math.min(m,s.drag.endTick0-a);const f=s.drag.endTick0-m;s.ghost={startTick:m,durationTick:f,pitch:d.pitch,color:yt};const p=s.drag.endTick0-s.drag.startTick0,g=Math.max(0,p-f),h=xt(32),b=u.tracks.find(w=>w.id===s.drag.trackId),k=new Set(s.selected),x=[];if(g>0)for(const w of b.notes){if(w.id===s.drag.noteId||!k.has(w.id))continue;const A=Math.max(h,w.durationTick-g);x.push({startTick:w.startTick,durationTick:A,pitch:w.pitch,color:yt})}s.ghostGroup=x.length?x:null,G();return}if(s.drag.kind==="resize-right"){const c=(e-s.drag.mouseStartX)/r;let l=s.drag.endTick0+c*L,m=Math.max(s.drag.startTick0+a,Math.ceil(l/a)*a);const f=u.tracks.find(B=>B.id===s.drag.trackId),p=s.drag.startTick0,g=f.notes.filter(B=>B.startTick>p).sort((B,$)=>B.startTick-$.startTick)[0];g&&(m=Math.min(m,g.startTick));const h=m-s.drag.startTick0;s.ghost={startTick:s.drag.startTick0,durationTick:h,pitch:d.pitch,color:yt};const b=s.drag.endTick0-s.drag.startTick0,k=Math.max(0,h-b),x=u.tracks.find(B=>B.id===s.drag.trackId),w=new Set(s.selected),A=[];if(k>0)for(const B of x.notes){if(B.id===s.drag.noteId||!w.has(B.id))continue;const $=x.notes.filter(C=>C.startTick>B.startTick).sort((C,E)=>C.startTick-E.startTick)[0];let M=Number.POSITIVE_INFINITY;$&&(M=Math.max(0,$.startTick-(B.startTick+B.durationTick)));const S=Math.max(0,Math.min(k,M)),H=B.durationTick+S;A.push({startTick:B.startTick,durationTick:H,pitch:B.pitch,color:yt})}s.ghostGroup=A.length?A:null,G();return}}if(s.drag.kind==="create"){const o=s.drag.startTick,i=(e-o/L*r)/r,d=o+Math.max(a,Math.round(i*L)),l=Math.max(o+a,Math.ceil(d/a)*a)-o,m=se(95-Math.floor(n/s.keyHeight));s.ghost={startTick:o,durationTick:l,pitch:m,color:yt};const f=u.tracks.find(p=>p.id===s.activeTrackId);f&&ke(m,f.id,f.instrument,vt),G()}}function br(){if(J)return;if(Xt){Xt=!1;return}vt.sampler&&vt.pitch!==null&&(lo(vt.sampler,vt.pitch),vt.pitch=null,vt.sampler=null);const t=document.activeElement;if(t&&(t.tagName==="INPUT"||t.tagName==="SELECT"||t.isContentEditable))return;if(s.marquee.active){s.marquee.active=!1,G();return}if(!s.drag)return;if(s.drag.kind==="move"&&s.moveGroup){const i=document.elementFromPoint(window.lastPointerX??0,window.lastPointerY??0)?.closest?.(".track-card");if(i){const l=parseInt(i.dataset.trackId||"-1",10),m=s.moveGroup.trackId;if(!Number.isNaN(l)&&l>0&&l!==m){const f=u.tracks.find(b=>b.id===m),p=u.tracks.find(b=>b.id===l),g=new Set(s.moveGroup.ids),h=f.notes.filter(b=>g.has(b.id));if(h.length>0){const b=Math.min(...h.map(w=>w.startTick)),k=Math.max(...h.map(w=>w.startTick+w.durationTick)),x=p.notes.filter(w=>w.startTick<k&&w.startTick+w.durationTick>b);f.notes=f.notes.filter(w=>!g.has(w.id)).concat(x),p.notes=p.notes.filter(w=>!x.includes(w)).concat(h),xe(f.notes),xe(p.notes),s.selected.clear();for(const w of h)s.selected.add(w.id);s.moveGroup=null,s.drag=null,s.ghost=null,kt({track:f}),kt({track:p}),j(),lt();return}}}const d=s.moveGroup;if(ae===0&&ie===0){s.moveGroup=null,s.drag=null,s.ghost=null;return}const c=u.tracks.find(l=>l.id===d.trackId);c.notes=c.notes.filter(l=>!d.ids.includes(l.id)),Re(async()=>{const{insertNoteWithOverlap:l,ensureBars:m}=await import("./timeline-Cty6ufw_.js").then(f=>f.z);return{insertNoteWithOverlap:l,ensureBars:m}},[],import.meta.url).then(({insertNoteWithOverlap:l,ensureBars:m})=>{s.selected.clear();for(const f of d.base){const p={id:f.id,startTick:Math.max(0,f.startTick+ae),durationTick:f.durationTick,pitch:se(f.pitch+ie),velocity:100,volume:f.volume??W};l(u,d.trackId,p),m(u,p.startTick+p.durationTick),s.selected.add(p.id)}s.moveGroup=null,s.drag=null,s.ghost=null,ae=0,ie=0,kt({track:c}),j(),rt()});return}if(!s.ghost){s.drag=null,document.querySelectorAll(".track-card.drop-hover").forEach(i=>i.classList.remove("drop-hover"));return}const e=s.ghost,n=s.drag.trackId,r=u.tracks.find(i=>i.id===n);let a=W;if(r){const i=le(r);let d=W;for(let c=0;c<i.length;c++){const l=i[c];if(l.startTick>=e.startTick)break;const m=l.volume??W;Hn(i,c,s.volumeLabels),d=m}a=d}const o={id:s.drag.noteId,startTick:e.startTick,durationTick:e.durationTick,pitch:e.pitch,velocity:100,volume:a};Re(async()=>{const{insertNoteWithOverlap:i,ensureBars:d}=await import("./timeline-Cty6ufw_.js").then(c=>c.z);return{insertNoteWithOverlap:i,ensureBars:d}},[],import.meta.url).then(({insertNoteWithOverlap:i,ensureBars:d})=>{const c=u.tracks.find(l=>l.id===n);if(s.drag.kind==="resize-left"||s.drag.kind==="resize-right"){const l=c.notes.findIndex(h=>h.id===s.drag.noteId);l>=0&&c.notes.splice(l,1);const m=s.drag.endTick0-s.drag.startTick0,f=e.durationTick,p=Math.max(0,m-f);if(p>0){const h=xt(32),b=new Set(s.selected);for(const k of c.notes)k.id!==s.drag.noteId&&b.has(k.id)&&(k.durationTick=Math.max(h,k.durationTick-p))}const g=Math.max(0,f-m);if(g>0){const h=new Set(s.selected);for(const b of c.notes){if(b.id===s.drag.noteId||!h.has(b.id))continue;const k=c.notes.filter(A=>A.startTick>b.startTick).sort((A,B)=>A.startTick-B.startTick)[0];let x=Number.POSITIVE_INFINITY;k&&(x=Math.max(0,k.startTick-(b.startTick+b.durationTick)));const w=Math.max(0,Math.min(g,x));w>0&&(b.durationTick+=w,d(u,b.startTick+b.durationTick))}}}i(u,n,o),d(u,o.startTick+o.durationTick),s.drag=null,s.ghost=null,s.ghostGroup=null,document.querySelectorAll(".track-card.drop-hover").forEach(l=>l.classList.remove("drop-hover")),kt({track:c,recomputeLabels:!0}),j(),rt()})}function G(){kr(),s.isAltDown=Qe;const t=q[u.zoomLevel-1],e=ct/L*t,n=s.scrollX,r=Y.clientWidth,a=n+r;Y.clientHeight;const o=u.timeSig.beatsPerBar*t,i=(st||u.timeSig.beatsPerBar)*t,d=Math.floor(n/o),c=n-d*o,l=Math.floor(n/i),m=n-l*i;K.style.left=`${-c}px`,ot&&(ot.style.left=`${-m}px`),ot&&ve&&Nn(ve,ot,u,s,st),Eo(gt,u,s,d*o,r+o);const f=e-n;if(J)if(Pt==="area"){const h=q[u.zoomLevel-1],b=st||u.timeSig.beatsPerBar,k=h*b,w=Math.floor(e/k)*k-n;Wo(gt,K,w,k)}else gn(gt,K,f);else gn(gt,K,f);Ro(zn,mt,s.keyHeight);const g=-Y.scrollTop+s.keyHeight;if(mt.style.transform=`translateY(${g}px)`,yr(),J&&e>=a){const h=q[u.zoomLevel-1],b=u.timeSig.beatsPerBar*h,k=ct/L*h,x=Math.floor(k/b)*b,w=qt(),A=Math.max(0,w-Y.clientWidth);s.scrollX=Math.max(0,Math.min(A,x))}Ee(),Qn()}function kr(){const t=window.devicePixelRatio||1,e=q[u.zoomLevel-1],r=u.timeSig.beatsPerBar*e,a=(Y.clientWidth||800)+r,o=84*s.keyHeight,i=o;K.style.width!==`${a}px`&&(K.style.width=`${a}px`),K.style.height!==`${i}px`&&(K.style.height=`${i}px`);const d=Math.max(1,Math.floor(a*t)),c=Math.max(1,Math.floor(i*t));if((K.width!==d||K.height!==c)&&(K.width=d,K.height=c),ot&&ve){const b=(Y.clientWidth||800)+r,k=o;ot.style.width!==`${b}px`&&(ot.style.width=`${b}px`),ot.style.height!==`${k}px`&&(ot.style.height=`${k}px`);const x=Math.max(1,Math.floor(b*t)),w=Math.max(1,Math.floor(k*t)),A=ot.width!==x,B=ot.height!==w;(A||B)&&(ot.width=x,ot.height=w),(A||B||zt!==u.zoomLevel)&&(Nn(ve,ot,u,s,st),zt=u.zoomLevel)}const l=84*s.keyHeight;(mt.width!==Math.floor(48*t)||mt.height!==Math.floor(l*t))&&(mt.width=Math.floor(48*t),mt.height=Math.floor(l*t),t!==1&&zn.setTransform(t,0,0,t,0,0)),mt.style.width!=="48px"&&(mt.style.width="48px");const m=`${l}px`;mt.style.height!==m&&(mt.style.height=m);const f=s.keyHeight;St.style.height!==f+"px"&&(St.style.height=f+"px");const p=St.clientWidth||Y.clientWidth||800,g=Math.max(1,Math.floor(p*t)),h=Math.max(1,Math.floor(f*t));(z.width!==g||z.height!==h)&&(z.width=g,z.height=h,t!==1&&Xe.setTransform(t,0,0,t,0,0))}function Ke(){J=!1,ye().stop(),Cn(),Ee(),Qn(),Ct()}function Jn(){J=!1,ye().stop(),ye().position=0,Cn(),ct=Vo,Ee(),G(),Ct()}function yr(){const t=q[u.zoomLevel-1],e=st||u.timeSig.beatsPerBar,n=window.devicePixelRatio||1,r=s.keyHeight;St.style.height!==r+"px"&&(St.style.height=r+"px");const a=St.clientWidth||Y.clientWidth||800,o=Math.max(1,Math.floor(a*n)),i=Math.max(1,Math.floor(r*n));z.width!==o&&(z.width=o),z.height!==i&&(z.height=i),n!==1&&Xe.setTransform(n,0,0,n,0,0);const d=s.scrollX;Do(Xe,z,d,t,e,u,ce)}function U(){zt=-1,G()}function Zn(){if(!J)return;const t=performance.now(),e=Math.max(0,t-Ue);Ue=t;const n=u.tempoAnchors||[],r=je(n,u.bpm);ct=co(r,ct,e);const a=de();if(ct>=a){Jn();return}G(),requestAnimationFrame(Zn)}function de(){let t=0;for(const e of u.tracks)for(const n of e.notes){const r=n.startTick+n.durationTick;r>t&&(t=r)}return t}function Ee(){if(!bn)return;const t=de(),e=Math.max(0,Math.floor(ct)),n=u.tempoAnchors||[],r=je(n,u.bpm),a=De(r,e),o=De(r,t);bn.textContent=`${un(a)} / ${un(o)}`}function vr(t){if(Ct(),t.button===2||J)return;const e=z.getBoundingClientRect(),n=t.clientX-e.left,r=Kn(n);if(r){ce=r.tick,z._dragAnchorIndex=r.index,z._draggingTempo=!0,z._dragStartTick=r.tick,U();return}Xt=!0,ue(t)}function xr(t){if(z._draggingTempo===!0){const n=z.getBoundingClientRect(),r=t.clientX-n.left,a=q[u.zoomLevel-1],o=xt(s.selectedLength),i=(r+s.scrollX)/a*L,d=Te(Math.max(0,Math.floor(i)),o),c=z._dragAnchorIndex,l=u.tempoAnchors||[];c>=0&&c<l.length&&(l[c].tick=d,l.sort((m,f)=>m.tick-f.tick),ce=d,u.tempoAnchors=l,U());return}Xt&&ue(t)}function wr(){if(z._draggingTempo===!0){j(),z._draggingTempo=!1,z._dragAnchorIndex=-1,z._dragStartTick=null,rt();for(const e of u.tracks)Lt(e);U();return}Xt=!1}function ue(t){const{x:e}=Vn(t),n=q[u.zoomLevel-1],r=e/n*L,a=xt(s.selectedLength);ct=Math.max(0,Math.floor(r/a)*a),J&&(J=!1),G()}function Qn(){const t=qt(),e=t-Y.clientWidth;if(e<=1){Jt.style.display="none";return}Jt.style.display="block";const n=Math.max(20,Y.clientWidth/t*Jt.clientWidth);ne.style.width=`${n}px`;const a=s.scrollX/e*(Jt.clientWidth-n);ne.style.left=`${a}px`}function qt(){const t=q[u.zoomLevel-1],e=Math.ceil(de()/L);return Math.max(Y.clientWidth,Math.ceil(e*t)+Y.clientWidth)}function Me(t){const e=q[u.zoomLevel-1],n=u.timeSig.beatsPerBar*e,r=Math.round(t/n)*n;return Math.max(0,r)}function to(){const t=y[v];if(Z&&(Z.textContent=ft?t.extendedLessLabel||"더 적은 단위":t.extendedMoreLabel||"더 많은 단위",Z.title=ft?t.tooltipExtendedLess||"기본 단위로 돌아가기":t.tooltipExtendedMore||"더 많은 단위 사용 (64/128/5/7/11)",Z.setAttribute("data-i18n",ft?"extendedLessLabel":"extendedMoreLabel"),Z.setAttribute("data-i18n-title",ft?"tooltipExtendedLess":"tooltipExtendedMore"),Z.setAttribute("aria-label",Z.title)),Q){const e=t.tooltipDisplayTimeSig||"Display time signature (n/4)";Q.title=e,Q.setAttribute("data-i18n-title","tooltipDisplayTimeSig"),Q.setAttribute("aria-label",e)}}wt(Z,"ghost","sm");if(Q){const t=a=>Math.max(1,Math.min(16,Math.floor(a)));let e=null;try{const a=localStorage.getItem(yn);if(a!=null){const o=Number(a);Number.isFinite(o)&&(e=t(o))}}catch{}const n=e??t(Number(u.displayBeatsPerBar)||Number(u.timeSig?.beatsPerBar)||4);st=n,u.displayBeatsPerBar=n,Q.value!==String(n)&&(Q.value=String(n));const r=()=>{const a=Number(Q.value),o=Number.isFinite(a)?t(a):n;st=o,u.displayBeatsPerBar=o,Q.value!==String(o)&&(Q.value=String(o));try{localStorage.setItem(yn,String(o))}catch{}zt=-1,j(),U()};Q.addEventListener("change",r),Q.addEventListener("input",r)}window.addEventListener("resize",()=>{on(),zt=-1,U()});setTimeout(on,0);Ot();Pn();Oe&&it(Oe,"tooltipPlay",y[v].tooltipPlay);qe&&it(qe,"tooltipPause",y[v].tooltipPause);Tt&&(Tt.textContent=Pt==="area"?y[v].playheadAreaLabel:y[v].playheadLineLabel,it(Tt,"tooltipPlayheadToggle",y[v].tooltipPlayheadToggle));Fe&&it(Fe,"tooltipStop",y[v].tooltipStop);Ft&&(wt(Ft,"secondary","md"),Ft.setAttribute("data-i18n","edit"),it(Ft,"tooltipEditMML",y[v].tooltipEditMML));pe&&(wt(pe,"secondary","md"),it(pe,"tooltipConvert",y[v].tooltipConvert));fe&&(wt(fe,"secondary","md"),it(fe,"tooltipPaste",y[v].tooltipPaste));re&&(wt(re,"ghost","md"),it(re,"tooltipGuide",y[v].tooltipGuide));if(bt){const t=(()=>{try{return localStorage.getItem(Rn)}catch{return null}})(),e=Math.max(16,Math.min(32,t?parseInt(t,10):s.keyHeight));s.keyHeight=e,bt.value=String(e),$t&&($t.textContent=String(e)),bt.min="16",bt.max="32",bt.step="1",it(bt,"tooltipKeyHeight",y[v].tooltipKeyHeight||"노트 높이 (16-32)")}he&&(wt(he,"ghost","sm"),it(he,"tooltipLangKo",y[v].tooltipLangKo));ge&&(wt(ge,"ghost","sm"),it(ge,"tooltipLangJa",y[v].tooltipLangJa));be&&(wt(be,"ghost","sm"),it(be,"tooltipLangEn",y[v].tooltipLangEn));K&&(K.setAttribute("data-i18n-title","tooltipPianoRoll"),K.title=y[v].tooltipPianoRoll);z&&(z.setAttribute("data-i18n-title","tooltipRuler"),z.title=y[v].tooltipRuler);Qo();U();Rt();try{_t.push(u)}catch{}Ft?Ft.onclick=()=>{const t=u.tracks.find(n=>n.id===s.activeTrackId);if(!t)return;let e=t.optimizedMML?.trim?.()||t.mmlString?.trim?.()||"";if(e=e.replace(/[\r\n]+/g,""),!e)try{e=(Je(t.notes??[])||"").trim().replace(/[\r\n]+/g,"")}catch{}wo(t,n=>{Un(t,n);try{const r=In([n],u.bpm);u.tempoAnchors=r,r.length>0&&r[0].tick===0&&Number.isFinite(r[0].bpm)&&(u.bpm=r[0].bpm);for(const a of r)rn(a.tick)}catch{}u.maxEndTick=de(),Lt(t);for(const r of u.tracks)r!==t&&Lt(r);rt(),Rt(),lt()},e)}:u=En();to();Z.id="btnToggleExtended";Z.style.marginLeft="8px";Z.textContent=ft?y[v].extendedLessLabel||"더 적은 단위":y[v].extendedMoreLabel||"더 많은 단위";Ze.onmessage=t=>{const{trackId:e,optimizedMML:n,originalBody:r}=t.data,a=u.tracks.find(o=>o.id===e);a&&(a.optimizedMML=n,a.originalBody=r??"",lt(),Rt(),Kt())};qo?.addEventListener("click",()=>{On(L)});Fo?.addEventListener("click",()=>{const t=L*Fn();On(t)});$o?.addEventListener("click",()=>{qn(L)});Uo?.addEventListener("click",()=>{const t=L*Fn();qn(t)});(function(){Dt&&(Dt.textContent=y[v].trackMMLLabel||"트랙MML",Dt.setAttribute("data-i18n","trackMMLLabel"),Dt.setAttribute("data-i18n-title","tooltipEditMML"),Dt.title=y[v].tooltipEditMML)})();s.moveGroup=null;(function(){const e="2025-08-27-load-change",n="mml_editor_whatsnew_shown_"+e;let r=!1;try{r=localStorage.getItem(n)==="1"}catch{}r||setTimeout(()=>Ho(e),0)})();async function Mr(){try{_t.push(u);const t=await navigator.clipboard.readText();if(!t.trim().startsWith("MML@")){alert(y[v].invalid_mml_format||"MML 형식이 아닙니다.");return}let e=t.trim().substring(4);e=e.replace(/\r?\n/g,"").replace(/;+$/g,"");const n=e.split(",").map(o=>o.replace(/;+$/g,"").trim());if(n.length>6){alert("트랙은 최대 6개까지만 지원합니다.");return}try{const o=In(n,u.bpm);u.tempoAnchors=o,o.length>0&&o[0].tick===0&&Number.isFinite(o[0].bpm)&&(u.bpm=o[0].bpm)}catch{}const r=[];for(let o=0;o<u.tracks.length;o++){const i=n[o]?n[o]:"",d=u.tracks[o],c=d.notes?.length||0;try{if(i&&i.length>0)try{d.optimizedMML=Bn(i)||i}catch{d.optimizedMML=i}else d.optimizedMML="";Un(d,i),(d.notes?.length||0)>c&&r.push(d)}catch{alert(y[v].invalid_mml_format||"MML 형식이 아닙니다.");return}}u.maxEndTick=de();const a=u.tempoAnchors||[];if(a.length>0)for(const o of a)rn(o.tick);r.length>0&&nn(r),lt(),Kt(),rt()}catch{}}async function eo(){if(J)return;J=!0,await io(),Ct();const t=Zo(),e=u.tempoAnchors||[];await so(t,u.bpm,{tempoAnchors:e});const n=je(e,u.bpm);ye().position=De(n,ct),Ue=performance.now();{const r=q[u.zoomLevel-1],a=u.timeSig.beatsPerBar*r,o=ct/L*r,i=Math.floor(o/a)*a,d=qt(),c=Math.max(0,d-Y.clientWidth);s.scrollX=Math.max(0,Math.min(c,i))}Ee?.(),Zn()}const sn=()=>{const t=window.visualViewport?window.visualViewport.height:window.innerHeight;document.documentElement.style.setProperty("--app-100dvh",t+"px")};sn();window.addEventListener("resize",sn);window.visualViewport?.addEventListener("resize",sn);
