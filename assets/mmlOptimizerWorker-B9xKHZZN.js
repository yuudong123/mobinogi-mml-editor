(function(){"use strict";let X=480;function Q(u){X=u?147840:480}class v extends Error{localizedMessage;constructor(t,e,i){super(t+": "+e),this.name="MMLException",this.localizedMessage=void 0}getLocalizedMessage(){return this.localizedMessage??this.message}static createUndefinedTickException(t,e){return typeof t=="number"&&typeof e=="number"?t===e?new v("Undefined tick table",String(t),"undefined_tick"):new v("Undefined tick table",`${t}/${e}`,"undefined_tick"):new v("Undefined tick table",String(t),"undefined_tick")}static createIllegalNote(t){return new v("Illegal note",String(t),"illegal_note")}}class $ extends Error{constructor(t){super(`Illegal tick offset: ${t}`),this.tickOffset=t,this.name="IllegalTickOffsetException"}}class E{static MAX_TICK=384e4;tickOffset;constructor(t){if(t<=-384e4||t>=E.MAX_TICK)throw new $(t);this.tickOffset=t}setTickOffset(t){if(t<0||t>=E.MAX_TICK)throw new $(t);this.tickOffset=t}getTickOffset(){return this.tickOffset}static insertTick(t,e,i){for(const s of t){const n=s.getTickOffset();n>=e&&s.setTickOffset(n+i)}}static removeTick(t,e,i){const s=[];for(const n of t){const r=n.getTickOffset();r>=e&&(r<e+i?s.push(n):n.setTickOffset(r-i))}for(const n of s){const r=t.indexOf(n);r>=0&&t.splice(r,1)}}equals(t){return t instanceof E?this.tickOffset===t.tickOffset:!1}}class _{array;constructor(t){const e=Math.max(...Array.from(t.keys()));this.array=[];for(let i=0;i<=e;i++)this.array[i]=t.get(i)}max(){return this.array.length}validCount(){return this.array.reduce((t,e)=>e!==void 0?t+1:t,0)}containsKey(t){return t>=0&&t<this.array.length&&this.array[t]!==void 0}get(t){return t>=0&&t<this.array.length?this.array[t]:void 0}}class z{static COMBN=3;static singleton=null;static getInstance(){return this.singleton??(this.singleton=new z)}tickTable;tickInvTable;tickInvTableForMb;mode=null;constructor(){this.tickTable=this.generateTickTable(X,!0);const t=Array.from(this.tickTable.keys());this.tickInvTable=this.generateInvTable(t),this.tickInvTableForMb=this.generateInvTable(["1","1.","2","2.","4","4.","8","8.","16","16.","32","32.","64","64.","6","12","24","48"])}switch(t){this.mode=t}getTable(){return this.tickTable}getInvTable(){return this.mode==="MB"?this.tickInvTableForMb:this.tickInvTable}getPattern(t){return this.getInvTable().get(t)}add(t,e,i,s){let n=Math.trunc(e*4/i);s&&(n+=Math.trunc(n/2)),t.set(i+(s?".":""),n)}generateTickTable(t,e){const i=new Map;for(let s=1;s<=64;s++)this.add(i,t,s,!0),this.add(i,t,s,!1);return i}patternLength(t){let e=0;const i=["1","2","4","8","16"],s=i.map(n=>n+".");for(const n of t)i.indexOf(n)>=0?e+=n.length:s.indexOf(n)>=0?e+=n.length*2:e+=n.length*3;return e+t.length*10}generateInvTable(t){const e=new Map,i=this.tickTable.get("1")*2-1,s=this.tickTable;for(let n=1;n<=z.COMBN;n++){const r=this.combine(t,n);for(const c of r){const o=c.reduce((a,h)=>a+(s.get(h)||0),0);if(o<=i&&o>0){const a=e.get(o);if(!a)e.set(o,{primary:c.slice(),alt:[]});else{const h=this.patternLength(c),l=this.patternLength(a.primary);h<=l?(c.length===2&&a.alt.push([...a.primary]),a.primary=c.slice()):c.length===2&&a.alt.push(c.slice())}}}}return new _(e)}combine(t,e){const i=[],s=(n,r)=>{if(r.length===e){i.push(r.slice());return}for(let c=n;c<t.length;c++)r.push(t[c]),s(c,r),r.pop()};return s(0,[]),i}}class y{constructor(t){this.base=t,y.all.push(this);try{this.tick=p.getTick(t)}catch{this.tick=0}}static all=[];static L64=new y("64");static L32=new y("32");static L16=new y("16");static L48=new y("48");static L24=new y("24");static L12=new y("12");tick=0;getBase(){return this.base}getTick(){return this.tick}static getInstance(t){return y.all.find(e=>e.tick===t)||null}}class p{constructor(t,e,i=!0){this.noteName=t,this.tick=e,this.needTie=i}static tickTable=z.getInstance();static getTick(t){let e=t;for(;!this.tickTable.getTable().has(e);){const i=e.length;if(i===0)break;const s=e.charAt(i-1);if(s<"0"||s>"9")e=e.substring(0,i-1);else throw v.createUndefinedTickException(t)}return this.tickTable.getTable().get(e)}static minimum=null;static minimumTick(){if(this.minimum!=null)return this.minimum;let t;for(const e of this.tickTable.getTable().values())(t===void 0||e<t)&&(t=e);return this.minimum=t,this.minimum}static getAlt(t){const e=this.tickTable.getInvTable().get(t);return e?e.alt:void 0}mmlNotePart(t){const e=Array.isArray(t)?t:[t];let i="";for(const s of e)this.needTie&&(i+="&"),i+=this.noteName+s;return i}makeMMLText(t,e){if(e>0){for(let i=1;i<=64;i*=2){const s=p.getTick(""+i),n=p.tickTable.getInvTable().get(e);if(n){t+=this.mmlNotePart(n.primary),e=0;break}for(;e>=s;)t+=this.mmlNotePart(""+i),e-=s}if(e>0)throw v.createUndefinedTickException(e,p.getTick("1"))}return this.needTie?t.length>0?t.substring(1):"":t}toMMLText(){let t=this.tick,e="";const i=p.getTick("1."),s=p.getTick("1");for(;t>s*2;)e+=this.mmlNotePart("1."),t-=i;return this.makeMMLText(e,t)}toMMLTextByBase(t){let e=this.tick,i="";const s=p.minimumTick(),n=t.getTick();for(;e>=n+s;)i+=this.mmlNotePart(t.getBase()),e-=n;return this.makeMMLText(i,e)}}class k extends E{static INIT_VOL=15;static MAX_VOL=15;note;tick;tuningBase=null;velocity;indexOfMMLString=null;mute=!1;constructor(t,e,i,s=k.INIT_VOL){if(super(i),i+e>=E.MAX_TICK)throw new $(i+e);if(s<0||s>k.MAX_VOL)throw new Error("velocity "+s);this.note=t,this.tick=e,this.velocity=s}getNote(){return this.note}setNote(t){this.note=t}getTick(){return this.tick}getEndTick(){return this.getTickOffset()+this.tick}setTick(t){this.tick=t}isTuningNote(){return this.tuningBase!==null}getTuningBase(){return this.tuningBase}setTuningNote(t){this.tuningBase=t}getVelocity(){return this.velocity}setVelocity(t){t<0?t=0:t>k.MAX_VOL&&(t=k.MAX_VOL),this.velocity=t}modifyVelocity(t){this.setVelocity(this.velocity+(t?1:-1))}getIndexOfMMLString(){return this.indexOfMMLString}setIndexOfMMLString(t){this.indexOfMMLString=t}isMute(){return this.mute}setMute(t){this.mute=t}toString(){return`[Note] note: ${this.note}, tick: ${this.tick}, offset: ${this.getTickOffset()}, velocity: ${this.velocity}`}static noteNameTable=["c","c+","d","d+","e","f","f+","g","g+","a","a+","b"];getNoteName(){return this.note===-1?"c-":k.noteNameTable[this.note%k.noteNameTable.length]}toMMLString(){return this._toMMLString(0)}_toMMLString(t){if(this.note<-1||this.note>=108)throw v.createIllegalNote(this.note);const e=this.getNoteName();let i=this.tick;this.getTickOffset()<t&&(i-=t-this.getTickOffset());const s=new p(e,i);return this.tuningBase?s.toMMLTextByBase(this.tuningBase):s.toMMLText()}toMMLStringWithPrev(t){if(this.note<-1||this.note>=108)throw v.createIllegalNote(this.note);let e="";return e+=this.createMMLSpaceString(t),e+=this.changeOctaveinMMLString(t.getOctave()),t.getVelocity()!==this.velocity&&(e+="v"+this.velocity),e+=this._toMMLString(t.getEndTick()),e}createMMLSpaceString(t){const e=this.getTickOffset()-t.getEndTick();return e>0?new p("r",e,!1).toMMLText():""}changeOctaveinMMLString(t){let e="";const i=">>>>>>>>",s="<<<<<<<<",n=t-this.getOctave();return n>0?e=s.substring(0,n):n<0&&(e=i.substring(0,-n)),e}getOctave(){return this.note<0?0:Math.trunc(this.note/12)}equals(t){if(!(t instanceof k))return!1;const e=t;return this.tick===e.tick&&this.note===e.note&&this.velocity===e.velocity&&super.equals(e)&&this.tuningBase===e.tuningBase}static keyToAbsNote(t){try{const e=new k(t,0,0),i=e.getOctave(),s=e.getNoteName().toUpperCase();return"O"+i+s}catch{return""}}clone(){const t=new k(this.note,this.tick,this.getTickOffset(),this.velocity);return t.setTuningNote(this.tuningBase),t.setIndexOfMMLString(this.indexOfMMLString?[this.indexOfMMLString[0],this.indexOfMMLString[1]]:null),t.setMute(this.mute),t}}class M extends E{static META=81;static INITIAL_TEMPO=120;tempo;isFirst;constructor(t,e,i=!1){if(super(e),t<=0||t>1e3)throw new Error("tempo "+t);this.tempo=t,this.isFirst=i}getTempo(){return this.tempo}setTempo(t){this.tempo=t}toString(){return`${this.getTickOffset()}T${this.tempo}`}static fromString(t){if(!t||t.length===0)return null;const e=t.split("T");return e.length!==2?null:new M(parseInt(e[1],10),parseInt(e[0],10))}toMMLString(){return"t"+this.tempo}appendToListElement(t){let e=0;const i=this.getTickOffset();for(;e<t.length;e++){const s=t[e];if(s.getTickOffset()===i){t.splice(e,1);break}else if(s.getTickOffset()>i)break}(e===0||t[e-1].getTempo()!==this.tempo||!this.isFirst)&&t.splice(e,0,this)}static mergeTempoList(t,e){if(t!==e)for(const i of t)i.appendToListElement(e);return e}static searchOnTick(t,e){let i=M.INITIAL_TEMPO;for(const s of t){if(e<s.getTickOffset())break;i=s.getTempo()}return i}static searchEqualsTick(t,e){for(const i of t){if(i.getTickOffset()===e)return!0;if(i.getTickOffset()>e)break}return!1}static getMaxTempoEvent(t){const e=new M(M.INITIAL_TEMPO,0);for(const i of t){const s=i.getTempo();e.getTempo()<s&&e.setTempo(s)}return e}getMetaData(){const t=Math.trunc(6e7/this.tempo),e=new Uint8Array(3);return e[0]=t>>16&255,e[1]=t>>8&255,e[2]=t&255,e}clone(){return new M(this.tempo,this.getTickOffset(),this.isFirst)}equals(t){return t instanceof M?this.tempo===t.tempo&&super.equals(t):!1}}class tt{index=0;tokens=[];currentOct=4;currentVelocity=k.INIT_VOL;tickOffset;pendingTie=!1;lastNote=null;defaultLengthBase=4;defaultLengthDotted=!1;constructor(t,e){this.tickOffset=e|0;const i=(t||"").toLowerCase().replace(/\s+/g,"").replace(/^mml@/,""),s=/(t\d{1,4})|(o\d)|(l\d+\.)|(l\d+)|(>>+|>+|<<+|<+)|([a-gA-G][+#-]?\d+\.)|([a-gA-G][+#-]?\d*\.)|([a-gA-G][+#-]?\d*)|(r\d+\.)|(r\d*\.)|(r\d*)|(n\d+)|(v\d{1,3})|(&)|([^])/g;let n;for(;n=s.exec(i);){const r=n[0];r.trim().length!==0&&this.tokens.push(r)}}hasNext(){return this.index<this.tokens.length}next(){if(!this.hasNext())return null;const t=this.tokens[this.index++];if(t==="&")return this.pendingTie=!0,null;const e=t.charAt(0).toLowerCase();if(e==="t"){const i=parseInt(t.substring(1),10);return Number.isFinite(i)&&i>0?new M(i,this.tickOffset,this.tickOffset===0):null}if(e==="o"){const i=parseInt(t.substring(1),10);return Number.isFinite(i)&&(this.currentOct=Math.max(0,Math.min(9,i))),null}if(e==="l"){const i=/^l(\d+)(\.)?$/.exec(t);if(i){const s=parseInt(i[1],10);Number.isFinite(s)&&s>0&&(this.defaultLengthBase=s,this.defaultLengthDotted=!!i[2])}return null}if(e===">"||e==="<"){for(const i of t)i===">"?this.currentOct=Math.min(9,this.currentOct+1):i==="<"&&(this.currentOct=Math.max(0,this.currentOct-1));return null}if(e==="v"){const i=parseInt(t.substring(1),10);return Number.isFinite(i)&&(this.currentVelocity=Math.max(0,Math.min(15,i))),null}if(e==="n"){const i=parseInt(t.substring(1),10);if(Number.isFinite(i)){const s=this.defaultLengthBase+(this.defaultLengthDotted?".":""),n=this.parseLength(s)||p.getTick("4"),r=this.currentVelocity;if(this.pendingTie&&this.lastNote&&this.lastNote.getNote()===i&&this.lastNote.getVelocity()===r)return this.lastNote.setTick(this.lastNote.getTick()+n),this.tickOffset+=n,this.pendingTie=!1,null;const c=new k(i,n,this.tickOffset,r);return this.lastNote=c,this.pendingTie=!1,this.tickOffset+=n,c}return null}if(e==="r"){let i=t.substring(1);i==="."?i=this.defaultLengthBase+".":i===""&&(i=this.defaultLengthBase+(this.defaultLengthDotted?".":""));const s=this.parseLength(i)||this.parseLength(this.defaultLengthBase+(this.defaultLengthDotted?".":""))||p.getTick("4");return this.tickOffset+=s,null}if(e>="a"&&e<="g"){const i=/^([a-gA-G][+#-]?)(\d*\.?)*$/.exec(t);if(i){const s=i[1];let r=t.substring(s.length);r==="."?r=this.defaultLengthBase+".":r===""&&(r=this.defaultLengthBase+(this.defaultLengthDotted?".":""));const c=this.calcPitch(s,this.currentOct),o=this.defaultLengthBase+(this.defaultLengthDotted?".":""),a=this.parseLength(r)||this.parseLength(o)||p.getTick("4"),h=this.currentVelocity;if(this.pendingTie&&this.lastNote&&this.lastNote.getNote()===c&&this.lastNote.getVelocity()===h)return this.lastNote.setTick(this.lastNote.getTick()+a),this.tickOffset+=a,this.pendingTie=!1,null;const l=new k(c,a,this.tickOffset,h);return this.lastNote=l,this.pendingTie=!1,this.tickOffset+=a,l}}return null}parseLength(t){if(!t)return null;const e=/^(\d+)(\.)?$/.exec(t);if(!e)return null;const i=parseInt(e[1],10);if(!Number.isFinite(i)||i<=0)return null;const s=p.getTick("4");let n=Math.round(4/i*s);return e[2]&&(n+=n/2),Math.round(n)}calcPitch(t,e){const i={c:0,d:2,e:4,f:5,g:7,a:9,b:11},s=t.charAt(0).toLowerCase();let n=i[s]??0;const r=t.charAt(1);return r==="+"||r==="#"?n+=1:r==="-"&&(n-=1),e*12+n}}class w extends Error{static Entry=class{event;exception;constructor(e,i){this.event=e,this.exception=i}getNote(){return this.event}getException(){return this.exception}};errList;constructor(t){super(t[0].exception.message),this.errList=t,Object.setPrototypeOf(this,w.prototype)}getErr(){return this.errList}get message(){return this.errList[0].exception.message}getLocalizedMessage(){return this.errList[0].exception.message}}class P extends p{static REST="r";static ALT="c";static DIV=4294967295;replaced=!1;lastReplaced=!1;prevNoteEvent;constructor(t,e=null){super(P.REST,t,!1),this.prevNoteEvent=e}calcDivTick(t){return Math.ceil(P.DIV*t/6e7)}vZero(t){for(let e=t.length-1;e>=0;e--){const i=t[e].lastIndexOf(P.REST);if(i>=0){t[e]=t[e].substring(0,i)+P.ALT+t[e].substring(i+1),this.prevNoteEvent&&this.prevNoteEvent.getVelocity()>0&&(t[e]=t[e].substring(0,i)+"v0"+t[e].substring(i),this.prevNoteEvent.setVelocity(0));return}}}getPrevNoteEvent(){return this.prevNoteEvent}isReplaced(){return this.replaced}isLastReplaced(){return this.lastReplaced}toMMLTextWithMotionFix(t){let e=this.tick,i="",s=0;const n=this.calcDivTick(t),r=p.getTick("1."),c=p.getTick("1");for(;e>c*2;){if(i+=this.mmlNotePart("1."),s+=r,s>=n){s=r;const o=[i];this.vZero(o),i=o[0],this.replaced=!0}e-=r}if(s+=e,i=this.makeMMLText(i,e),s>=n){const o=[i];this.vZero(o),i=o[0],this.replaced=this.lastReplaced=!0}return i}}class N{static globalVZeroTempo=!0;static setMMLVZeroTempo(t){this.globalVZeroTempo=t}eventList;startOffset;initOct;errList=[];percussionMotionFix;currentTempo=M.INITIAL_TEMPO;static INIT_OCT=4;constructor(t,e,i,s){this.eventList=t,this.startOffset=e,this.initOct=i,this.percussionMotionFix=s}static create(t,e=0,i=N.INIT_OCT,s=!1){return new N(t,e,i,s)}makeTempoChar(t,e,i){const s=[!0,!0,!0,!0,!0,!0,!0];if(t)for(const n of[e.getTickOffset(),e.getEndTick()])for(const r of t){const c=r.searchOnTickOffset(n);if(c&&c.getOctave()===i){const a=c.toMMLString().toLowerCase().charAt(0).charCodeAt(0)-97;a>=0&&a<s.length&&(s[a]=!1)}}for(let n=0;n<s.length;n++){const r=(n+2)%s.length;if(s[r])return String.fromCharCode(97+r)}return"c"}insertRestNoteEvent(t,e,i){const s=i.getTickOffset()-e.getEndTick(),n=e.clone(),r=new P(s,n);if(s>0)try{t.push(this.percussionMotionFix?r.toMMLTextWithMotionFix(this.currentTempo):r.toMMLText()),n.setTick(e.getTick()+s)}catch(c){this.errList.push(new w.Entry(e,c))}return r}insertTempoMML(t,e,i,s,n){let r=e.clone();if(e.getEndTick()<i.getTickOffset()){const c=e.getOctave(),o=this.insertRestNoteEvent(t,e,i);if(r=o.getPrevNoteEvent()??r,s&&N.globalVZeroTempo&&!o.isLastReplaced()){const a=t.lastIndexOf("r");if(a>=0){t[a]="c";const h=new I(t.join("")).getLastNote();try{const l=this.makeTempoChar(n??null,h,c),f=e.getVelocity()!==0?"v0"+l:""+l;t[a]=f}catch(l){this.errList.push(new w.Entry(h,l))}r.setVelocity(0)}}}return t.push(i.toMMLString()),r}insertNoteWithTempo(t,e,i,s,n,r){const c=s.clone();for(;n&&e.length>0&&c.getTickOffset()<e[0].getTickOffset()&&e[0].getTickOffset()<c.getEndTick();){const o=e[0].getTickOffset(),a=o-c.getTickOffset();try{const l=p.minimumTick(),f=(()=>{try{return new p("c",a).toMMLText(),!0}catch{return!1}})();if(a<l||!f){console.warn("[builder tempo split skipped]",{segLen:a,minTick:l,anchorTick:o,noteStart:s.getTickOffset(),noteEnd:s.getEndTick()});break}}catch{}try{a<=32&&console.warn("[builder tempo split small segment]",{noteStart:s.getTickOffset(),noteEnd:s.getEndTick(),anchorTick:o,segLen:a,remainingBefore:c.getTick(),workingStart:c.getTickOffset(),tempo:e[0].getTempo()})}catch{}const h=new k(c.getNote(),a,c.getTickOffset(),c.getVelocity());try{i=this.insertRestNoteEvent(t,i,h).getPrevNoteEvent()??i,t.push(h.toMMLStringWithPrev(i))}catch(l){this.errList.push(new w.Entry(h,l))}n&&t.push(e[0].toMMLString()),this.currentTempo=e[0].getTempo(),e.shift(),c.setTick(c.getTick()-a),c.setTickOffset(c.getTickOffset()+a),i=h,n&&c.getTick()>0&&t.push("&")}if(c.getTick()>0)try{i=this.insertRestNoteEvent(t,i,c).getPrevNoteEvent()??i,t.push(c.toMMLStringWithPrev(i))}catch(o){this.errList.push(new w.Entry(c,o))}}makeLocalTempoList(t){const e=[...this.eventList.getGlobalTempoList()];for(;e.length>1&&e[1].getTickOffset()<=this.startOffset;)this.currentTempo=e[0].getTempo(),e.shift();return e}totalTickRelationPart(t){let e=this.eventList.getTickLength();if(t)for(const i of t)e<i.getTickLength()&&(e=i.getTickLength());return e}static searchRelationPartCanInsertTempo(t,e){if(t)for(const i of t){const s=i.searchOnTickOffset(e);if(!s||s.getTickOffset()===e)return!0}return!1}static searchRelationPartOnTick(t,e){if(t)for(const i of t){const s=i.searchOnTickOffset(e),n=i.searchPrevNoteOnTickOffset(e);if(s&&s.getTickOffset()===e||n&&n.getEndTick()===e)return!0}return!1}tickDeltaCheck(t){if(t===0)return!0;t<0&&(t=-t);const e=p.minimumTick();return!(t<e)}insertNoteWithTempoMusicQ(t,e,i,s,n,r){let c=n.clone(),o=i;for(;e.length>o;){const a=e[o],h=a.getTickOffset();if(c.getTickOffset()>=h||h>=c.getEndTick())break;if(N.searchRelationPartCanInsertTempo(r??null,h)){o++;continue}const l=a.getTickOffset()-c.getTickOffset(),f=new k(c.getNote(),l,c.getTickOffset(),c.getVelocity());try{s=this.insertRestNoteEvent(t,s,f).getPrevNoteEvent()??s,t.push(f.toMMLStringWithPrev(s))}catch(g){this.errList.push(new w.Entry(f,g))}t.push(a.toMMLString()),e.splice(o,1),c.setTick(c.getTick()-l),c.setTickOffset(c.getTickOffset()+l),s=f,c.setVelocity(0)}if(c.getTick()>0)try{s=this.insertRestNoteEvent(t,s,c).getPrevNoteEvent()??s,t.push(c.toMMLStringWithPrev(s))}catch(a){this.errList.push(new w.Entry(c,a))}return n.getVelocity()!==c.getVelocity()&&t.push("v"+n.getVelocity()),o}toMMLStringMusicQ(t,e,i=!1){const s=this.totalTickRelationPart(e),n=[];let r=0;for(;t.length>r+1&&t[r+1].getTickOffset()<=this.startOffset;)t.splice(r,1);let c=new k(12*this.initOct,0,this.startOffset,k.INIT_VOL);for(const o of this.eventList.getMMLNoteEventList()){for(;t.length>r;){const a=t[r],h=o.getTickOffset()-a.getTickOffset(),l=a.getTickOffset()-c.getEndTick();if(h>=0)!i||this.tickDeltaCheck(h)&&this.tickDeltaCheck(l)?(c=this.insertTempoMML(n,c,a,!0,e),this.currentTempo=t[r].getTempo(),t.splice(r,1)):r++;else break}r=this.insertNoteWithTempoMusicQ(n,t,r,c,o,e),c=o}for(;t.length>r;){const o=t[r].getTickOffset();if(o>=s)break;N.searchRelationPartOnTick(e??null,o)?r++:(c=this.insertTempoMML(n,c,t[r],!0,e),this.currentTempo=t[r].getTempo(),t.splice(r,1))}if(this.errList.length>0)throw new w(this.errList);return n.join("")}toMMLString(){return this.toMMLStringFull(!1,!0)}toMMLStringFull(t,e,i){const s=this.totalTickRelationPart(i),n=this.makeLocalTempoList(s),r=[];let c=new k(12*this.initOct,0,this.startOffset,k.INIT_VOL);for(const o of this.eventList.getMMLNoteEventList()){for(;n.length>0&&n[0].getTickOffset()<=o.getTickOffset();)t&&(c=this.insertTempoMML(r,c,n[0],e,i)),this.currentTempo=n[0].getTempo(),n.shift();this.insertNoteWithTempo(r,n,c,o,t,e),c=o}for(;n.length>0;){const o=n[0];if(e&&o.getTickOffset()>=s)break;t&&(c=this.insertTempoMML(r,c,o,e,i)),this.currentTempo=n[0].getTempo(),n.shift()}if(this.errList.length>0)throw new w(this.errList);return r.join("")}}class I{noteList=[];tempoList;constructor(t,e,i=0){this.tempoList=e??[],this.parseMML(t,i)}parseMML(t,e){const i=new tt(t,e);for(;i.hasNext();){const s=i.next();s instanceof M?s.appendToListElement(this.tempoList):s instanceof k&&this.noteList.push(s)}}setGlobalTempoList(t){this.tempoList=t}getGlobalTempoList(){return this.tempoList}getTickLength(){return this.noteList.length>0?this.noteList[this.noteList.length-1].getEndTick():0}isEmpty(){return this.noteList.length===0}getMMLNoteEventList(){return this.noteList}searchOnTickOffset(t){for(const e of this.noteList)if(e.getTickOffset()<=t){if(t<e.getEndTick())return e}else break;return null}searchOnTickOffsetNextNote(t){for(let e=0;e<this.noteList.length-1;e++){const i=this.noteList[e];if(i.getTickOffset()<=t&&t<i.getEndTick())return this.noteList[e+1]}return null}searchPrevNoteOnTickOffset(t){let e=null;for(const i of this.noteList){if(i.getTickOffset()>=t)break;e=i}return e}indexOfMMLString(t){let e=0;for(const i of this.noteList){const s=i.getIndexOfMMLString();if(s){if(i.getTickOffset()<=t){if(t<i.getEndTick())return s}else return[e,s[0]];e=s[1]}}return[e,e]}addMMLNoteEvent(t){if(t.getNote()<-1||t.getTick()<=0||t.getEndTick()<=0)return;let e=t.getTickOffset();e<0&&(t.setTick(t.getTick()+e),t.setTickOffset(0));let i=0;for(;i<this.noteList.length;i++){const s=this.noteList[i],n=s.getEndTick()-t.getTickOffset();if(t.getTickOffset()<s.getTickOffset())break;if(n>=0){const r=s.getTick()-n;if(r===0){this.noteList.splice(i,1);break}else{s.setTick(r),i++;break}}}for(this.noteList.splice(i++,0,t);i<this.noteList.length;){const s=this.noteList[i];if(t.getEndTick()-s.getTickOffset()>0)this.noteList.splice(i,1);else break}}isOverlapNote(t){let e=0;const i=this.noteList.length;for(;e<i;e++){const s=this.noteList[e];if(t.getTickOffset()<s.getEndTick()){if(t.getTickOffset()>=s.getTickOffset())return!0;break}}for(;e<i;e++){const s=this.noteList[e];if(t.getEndTick()<=s.getEndTick()){if(t.getEndTick()-1>=s.getTickOffset())return!0;break}}return!1}deleteMMLEvent(t){const e=this.noteList.indexOf(t);e>=0&&this.noteList.splice(e,1)}setVelocityCommand(t,e){this.setUnsetVelocityCommand(t,e,!0)}unsetVelocityCommand(t){this.setUnsetVelocityCommand(t,0,!1)}setUnsetVelocityCommand(t,e,i){const s=t.getVelocity();let n=k.INIT_VOL;for(const r of this.noteList)if(r.getTickOffset()>=t.getTickOffset())if(s===r.getVelocity())r.setVelocity(i?e:n);else break;else n=r.getVelocity()}toString(){return this.tempoList.toString()+this.noteList.toString()}clone(){const t=new I("",this.tempoList.map(e=>e.clone()),0);return t.noteList=this.noteList.map(e=>e.clone()),t}getAlignmentStartTick(t,e){const i=t.searchOnTickOffset(e);return i==null||i.getTickOffset()===e?e:t.getAlignmentStartTick(this,i.getTickOffset())}getAlignmentEndTick(t,e){const i=t.searchOnTickOffset(e-1);return i==null||i.getEndTick()===e?e:t.getAlignmentEndTick(this,i.getEndTick())}swap(t,e,i){const s=[],n=[];for(const r of this.noteList)r.getTickOffset()>=e&&r.getEndTick()<=i&&s.push(r);for(const r of s)this.noteList.splice(this.noteList.indexOf(r),1);for(const r of t.getMMLNoteEventList())r.getTickOffset()>=e&&r.getEndTick()<=i&&n.push(r);for(const r of n)t.getMMLNoteEventList().splice(t.getMMLNoteEventList().indexOf(r),1),this.addMMLNoteEvent(r);for(const r of s)t.addMMLNoteEvent(r)}move(t,e,i){const s=[];for(const n of this.noteList)n.getTickOffset()>=e&&n.getEndTick()<=i&&s.push(n);for(const n of s)this.deleteMMLEvent(n),t.addMMLNoteEvent(n)}copy(t,e,i){for(const s of this.noteList)s.getTickOffset()>=e&&s.getEndTick()<=i&&t.addMMLNoteEvent(s.clone())}deleteMinRest(){const t=p.minimumTick();for(let e=1;e<this.noteList.length;e++){const i=this.noteList[e-1],n=this.noteList[e].getTickOffset()-i.getEndTick();if(n>0&&n<t){const r=i.getTick()-t+n;r>=t?i.setTick(r):i.setTick(i.getTick()+n)}}}transpose(t){for(const e of this.noteList)e.setNote(e.getNote()+t)}equals(t){if(!(t instanceof I))return!1;const e=t,i=this.noteList.length===e.noteList.length&&this.noteList.every((n,r)=>n.equals(e.noteList[r])),s=this.tempoList.length===e.tempoList.length&&this.tempoList.every((n,r)=>n.equals(e.tempoList[r]));return i&&s}getLastNote(){return this.noteList.length>0?this.noteList[this.noteList.length-1]:null}getInternalMMLString(){return N.create(this).toMMLStringFull(!1,!1)}static maxEndTick(t){let e=0;for(const i of t){const s=i.getLastNote();s&&e<s.getEndTick()&&(e=s.getEndTick())}return e}}class T{static noteString="abcdefgABCDEFGnNrR";static tokenString=T.noteString+"tToOlLvV<>&, ";static tokenCache=new Map;mml_src;mml_length;mml_charArray;startIndex=0;endIndex=0;constructor(t){this.mml_src=t,this.mml_length=t.length,this.mml_charArray=t.split("")}hasNext(){return this.endIndex<this.mml_length}next(){return this.startIndex=this.endIndex,this.endIndex=this.searchToken(this.endIndex+1),this.mml_src.substring(this.startIndex,this.endIndex)}remove(){this.startIndex=0,this.endIndex=0}getStart(){return this.startIndex}getEnd(){return this.endIndex}getIndex(){return[this.startIndex,this.endIndex]}static isToken(t){return T.tokenString.indexOf(t)>=0}static isNote(t){return T.noteString.indexOf(t)>=0}static noteName(t){let e=t.substring(0,1);if(t.length>1){const i=t.charAt(1);(i==="+"||i==="-"||i==="#")&&(e+=i)}return e}static noteNames(t){const e=this.tokenCache.get(t);if(e)return e;const i=this.noteName(t),s=t.substring(i.length),n=[i,s];return this.tokenCache.set(t,n),n}static isLenOnly(t){return t.endsWith(".")&&(t=t.substring(0,t.length-1)),/^[0-9]+$/.test(t)}searchToken(t){let e;for(e=t;e<this.mml_length;e++){const i=this.mml_charArray[e];if(T.isToken(i))break}return e}backSearchToken(t){let e;for(e=t-1;e>=0;e--){const i=this.mml_charArray[e];if(T.isToken(i))break}return e}}class D{static getOctaveString(t,e){const i=t-e;return Math.abs(i)>2?"o"+e:(i<0?">>":"<<").substring(0,Math.abs(i))}class_OptimizerMap=class extends Map{updateMapMinLength(e,i){const s=this.get(e);(!s||i.length()<s.length())&&this.set(e,i)}};createOptimizerMap(){return new this.class_OptimizerMap}map=this.createOptimizerMap();section="4";octave=4;octD=0;tokenStack=0;constructor(){this.map.set("4",new C)}getMinString(){let t,e=Number.MAX_SAFE_INTEGER;for(const i of this.map.values()){const s=i.length();s<e&&(t=i,e=s)}return t?t.toString():""}addString(t,e=0){for(const i of this.map.values())e===0?i.append(t):i.insert(i.length()-e,t)}newBuilder(t,e,i,s){const n=t.length();return t.insert(n-s,"l"+e),t.append(i),t}extendPatternBuilder(t,e,i,s,n){}fixPattern(t){}addNoteText(t,e,i){let s=e;s===""?s=this.section:s==="."&&(s=this.section+".");const n=new Map,r=this.getMinString(),c=(o,a)=>{if(a.append(t),o!==s){s===o+"."?a.append("."):a.append(s);const h=new C().append(r),l=this.newBuilder(h,s,t,i);if(this.updateMapMinLength(n,s,l),s.endsWith(".")){const f=s.substring(0,s.length-1),g=new C().append(r),O=this.newBuilder(g,f,t+".",i);this.updateMapMinLength(n,f,O)}this.extendPatternBuilder(n,r,t,s,i)}};for(const[o,a]of this.map.entries())c(o,a);for(const[o,a]of n.entries())this.updateMapMinLength(this.map,o,a);q.updateFlexDot(this.map,t,s),this.fixPattern(this.map)}updateMapMinLength(t,e,i){const s=t.get(e);(!s||i.length()<s.length())&&t.set(e,i)}cleanMap(){const t=this.getMinString().length;for(const[e,i]of[...this.map.entries()])i.length()>t+e.length+1&&this.map.delete(e)}resetOctave(){this.octave=4,this.octD=0}insertOxPattern(t){if(this.octD!==0){const e=this.octave+this.octD;this.addString(D.getOctaveString(this.octave,e),t),this.octave=e,this.octD=0}}insertLxPattern(t,e,i){this.addNoteText(t,e,i)}doPattern(t,e,i){this.insertOxPattern(i),this.insertLxPattern(t,e,i)}doToken(t,e){if(t==="o")this.octD=parseInt(e,10)-this.octave;else if(t===">")this.octD++;else if(t==="<")this.octD--;else if(t==="l"){if(e&&this.section!==e){this.section=e,this.addString("l"+e,this.tokenStack);const i=this.getMinString(),s=this.createOptimizerMap();s.set(e,new class extends C{}().append(i)),this.map=s}}else return!1;return!0}nextToken(t){const e=t.charAt(0).toLowerCase(),i=T.noteNames(t);if(e==="n"&&/^n\d+\.?$/i.test(t)){this.addString(t),this.tokenStack>0?this.tokenStack+=t.length:this.tokenStack=0;return}T.isNote(e)?(this.doPattern(i[0],i[1],this.tokenStack),this.tokenStack=0,this.cleanMap()):(this.doToken(e,i[1])||this.addString(t),e==="&"&&(this.tokenStack+=t.length))}}class C{parts=[];append(t){return this.parts.push(t),this}toString(){return this.parts.join("")}length(){return this.parts.reduce((t,e)=>t+e.length,0)}reset(t){return this.parts=[t],this}insert(t,e){const i=this.toString(),s=i.slice(0,t),n=i.slice(t);return this.parts=[s,e,n],this}}class q{static flexList=[64,32,16,8,4].map(t=>new q(t));lCur;lNext;lPrev;constructor(t){this.lCur=t/2+".",this.lNext=""+t,this.lPrev=""+t/4}updatePattern(t,e,i){let s=e;/^[rR]$/.test(e)||(s="&"+e);const n=new Map,r=e+this.lPrev+s+this.lCur;for(const c of t.keys())if(c===this.lNext){const o=t.get(c).toString();if(o.endsWith(r)){const a=o.substring(0,o.length-r.length),h=this.lPrev+".",l=a+e+s+h,f=a+e+"l"+h+s,g=a+e+"l"+this.lPrev+s+".";n.set(c,new C().append(l)),n.set(h,new C().append(f)),n.set(this.lPrev,new C().append(g))}}for(const[c,o]of n.entries()){const a=t.get(c);(!a||o.length()<a.length())&&t.set(c,o)}}static updateFlexDot(t,e,i){for(const s of this.flexList)if(i===s.lCur){s.updatePattern(t,e,i);break}}}class B{builder=[];nCount=0;prevOct;offsetIndex=null;constructor(t,e=""){this.prevOct=t,e&&this.builder.push(e)}clone(){const t=new B(this.prevOct);return t.builder=[...this.builder],t.nCount=this.nCount,this.offsetIndex!=null&&(t.offsetIndex=this.offsetIndex),t}length(){return this.builder.join("").length}toString(){return this.builder.join("")}addOctToken(t){this.offsetIndex==null&&(this.offsetIndex=t)}}class Z{octave=4;builderList=[new B(4)];lastNoteNumber=-1;minStack(t){return!Array.isArray(t)||t.length===0?new B(this.octave):t.reduce((e,i)=>{const s=typeof e.length=="function"?e.length():String(e.toString?.()??"").length,n=typeof i.length=="function"?i.length():String(i.toString?.()??"").length;if(s!==n)return s<n?e:i;const r=e.nCount??0,c=i.nCount??0;return r!==c?r<c?e:i:e})}getCurrentNoteNumber(){return this.lastNoteNumber}calcNoteNumber(t){const e={c:0,d:2,e:4,f:5,g:7,a:9,b:11},i=t.toLowerCase(),s=i.charAt(0);if(!(s in e))return-1;let n=e[s];if(i.length>1){const c=i.charAt(1);c==="+"?n+=1:c==="-"?n-=1:c==="#"&&(n+=1)}return this.octave*12+n}listClone(){return this.builderList.map(t=>t.clone())}cleanList(){const t=this.minStack(this.builderList);this.builderList.length=0,this.builderList.push(t)}clearOctToken(){this.builderList.forEach(t=>t.offsetIndex=null)}addNoteToken(t){this.builderList.forEach(e=>{e.builder.push(this.getOctaveString(e.prevOct,this.octave)),e.builder.push(t),e.prevOct=this.octave}),this.clearOctToken()}addToken(t){this.builderList.forEach(e=>e.builder.push(t))}addPattern(t){const e=this.getCurrentNoteNumber();e<0||e>96||(t.forEach(i=>{i.builder.push("n"+e),i.nCount++}),this.builderList.push(this.minStack(t)),this.clearOctToken())}notePattern(t,e,i){const s=this.listClone();this.addNoteToken(t),this.cleanList(),i.length===0&&this.addPattern(s)}doToken(t){const e=T.noteNames(t),i=e[0].charAt(0).toLowerCase();i>="a"&&i<="g"?(this.lastNoteNumber=this.calcNoteNumber(e[0]),this.notePattern(t,e[0],e[1])):i===">"?(this.octave++,this.addOctToken(t)):i==="<"?(this.octave--,this.addOctToken(t)):i==="o"?(this.octave=parseInt(e[1]||"4",10),this.addOctToken(t)):this.addToken(t)}getOctaveString(t,e){const i=t-e;return Math.abs(i)>2?"o"+e:i===0?"":i<0?">".repeat(-i):"<".repeat(i)}addOctToken(t){this.builderList.forEach(e=>{try{if(e&&typeof e.addOctToken=="function"&&Array.isArray(e.builder))e.addOctToken(e.builder.join("").length);else{const i=Array.isArray(e.builder)?e.builder.join("").length:0;e.offsetIndex==null&&(e.offsetIndex=i)}}catch{}})}nextToken(t){this.doToken(t)}getMinString(){return this.minStack(this.builderList).toString()}}class F extends Z{map=new Map;disableNopt;constructor(t,e,i){typeof t=="boolean"?(super(),this.disableNopt=t):(super(),this.octave=t,this.disableNopt=i===!0,this.builderList.length=0,this.builderList.push(new class{builder=[e||""];nCount=0;prevOct=t;offsetIndex=null}),this.parser.setOctave(t))}addTokenVariant(t,e,i){let s=t.builder.join("");t.prevOct!==e&&(s+=this.getOctaveString(t.prevOct,e)),s+=i;const n=this.map.get(e);(!n||n.length>s.length)&&this.map.set(e,s)}notePattern(t,e,i){this.builderList.forEach(s=>{if(this.addTokenVariant(s,this.octave,t),e==="b"?this.addTokenVariant(s,this.octave+1,"c-"+i):e==="c"&&this.addTokenVariant(s,this.octave-1,"b+"+i),!this.disableNopt&&s.prevOct!==this.octave&&i.length===0){const n=this.getCurrentNoteNumber();n>=0&&n<=96&&this.addTokenVariant(s,s.prevOct,"n"+n)}}),this.builderList=[];for(const[s,n]of this.map.entries())this.builderList.push(new class{builder=[n];nCount=0;prevOct=s;offsetIndex=null});this.map.clear()}getOptimizedLength(){return this.getMinString().length}static optimizeTail(t,e,i,s){const n=new F(t,e,s),r=new T(i);for(;r.hasNext();)n.nextToken(r.next());return n.getOptimizedLength()}}class m extends D{constructor(t){super(),this.disableNopt=t}static FixPattern=class{constructor(e,i,s){this.lStr=e,this.match=i,this.replace=s}patternApply(e,i){if(e===this.lStr||this.lStr==="*"){const s=i.toString();if(s.endsWith(this.match)){const n=s.length-this.match.length,r=s.substring(0,n)+this.replace;i.reset(r)}}}};static pattern=[new m.FixPattern("32","r16.","rrr"),new m.FixPattern("64","r32.","rrr")];createOptimizerMap(){const t=super.createOptimizerMap(),e=this.disableNopt,i=(c,o)=>{let a=0;const h=Math.min(c.length,o.length);for(;a<h&&c.charAt(a)===o.charAt(a);)a++;for(a--,a<0&&(a=0);a>0;){const l=c.charAt(a);if(T.isToken(l)||T.isNote(l))break;a--}return a},s=c=>{let o=4;const a=c.split("");for(let h=0;h<a.length;h++)switch(a[h]){case"<":o--;break;case">":o++;break;case"o":case"O":h++,h<a.length&&(o=a[h].charCodeAt(0)-48);break}return o},n=new Map;d.addCacheList(n);const r=(c,o,a)=>{const h=c.length+":"+o+":"+a+":"+(e?"1":"0"),l=n.get(h);if(l!==void 0)return l;const f=new F(a,c,e),g=new T(o);for(;g.hasNext();)f.nextToken(g.next());const O=f.getMinString().length;return n.set(h,O),O};return t.updateMapMinLength=(c,o)=>{const a=t.get(c);if(!a){t.set(c,o);return}const h=o.toString(),l=a.toString(),f=i(h,l),g=s(h.substring(0,f)),O=h.substring(0,f),b=r(O,h.substring(f),g),x=r(O,l.substring(f),g);b<x&&t.set(c,o)},t}fixPattern(t){for(const[e,i]of t.entries())for(const s of m.pattern)s.patternApply(e,i)}extendPatternBuilder(t,e,i,s,n){const r=e.lastIndexOf("l");let c="4";if(r>=0&&(c=new T(e.substring(r)).next().substring(1)),n>0&&!c.endsWith(".")&&e.endsWith(i+"&")&&s===((parseInt(c)<<1)+".").toString()){const o=""+(parseInt(c)<<2),a=e.substring(0,e.length-1)+"."+e.substring(e.length-1);let h=t.get(o);h||(h=new class{parts=[];append(l){return this.parts.push(l),this}toString(){return this.parts.join("")}length(){return this.parts.reduce((l,f)=>l+f.length,0)}insert(l,f){const g=this.toString();return this.parts=[g.slice(0,l),f,g.slice(l)],this}reset(l){return this.parts=[l],this}}),h.reset(a),t.set(o,h)}}}class et extends Map{constructor(t){super(),this.max=t}order=[];get(t){const e=super.get(t);if(e!==void 0){const i=this.order.indexOf(t);i>=0&&(this.order.splice(i,1),this.order.push(t))}return e}set(t,e){if(super.has(t)){const i=this.order.indexOf(t);i>=0&&(this.order.splice(i,1),this.order.push(t))}else if(this.order.push(t),this.order.length>this.max){const i=this.order.shift();i!==void 0&&super.delete(i)}return super.set(t,e)}delete(t){const e=this.order.indexOf(t);return e>=0&&this.order.splice(e,1),super.delete(t)}clear(){this.order=[],super.clear()}}class R{constructor(t=""){this.buf=t}append(t){return this.buf+=t,this}toString(){return this.buf}length(){return this.buf.length}delete(t,e){return this.buf=this.buf.slice(0,t)+this.buf.slice(e),this}replace(t,e,i){return this.buf=this.buf.slice(0,t)+i+this.buf.slice(e),this}substring(t,e){return this.buf.substring(t,e)}insert(t,e){return this.buf=this.buf.slice(0,t)+e+this.buf.slice(t),this}}class j extends m{static altPatterns=[new m.FixPattern("64","42","."),new m.FixPattern("32","21","."),new m.FixPattern("24","r12","rr"),new m.FixPattern("32","r16","rr"),new m.FixPattern("48","r24","rr"),new m.FixPattern("64","r32","rr"),new m.FixPattern("24","r12.","rrr"),new m.FixPattern("32","r16.","rrr"),new m.FixPattern("48","r24.","rrr"),new m.FixPattern("64","r32.","rrr"),new m.FixPattern("4","r3r9r16","rr5r17")];altPatternMap=new m.OptimizerMap;constructor(t){super(t)}fixPattern(t){this.altPatternMap.clear();for(const[e,i]of t.entries())this.tickAltPattern(this.altPatternMap,e,i);for(const[e,i]of this.altPatternMap.entries())t.updateMapMinLength(e,i);for(const[e,i]of t.entries())for(const s of j.altPatterns)s.patternApply(e,i);super.fixPattern(t)}tickAltPattern(t,e,i){const s=i.toString();let n=s.length,r=n;for(;r>0&&!T.isNote(s.charAt(--r)););if(r===0)return;const c=T.noteNames(s.substring(r,n));let o=r-1;if(c[0]==="r")o++;else if(s.charAt(o)!=="&")return;let a=o;for(;a>0&&!T.isNote(s.charAt(--a)););const h=T.noteNames(s.substring(a,o));if(h[0]!==c[0]||h[0]==="n"||c[0]==="n")return;const l=h[0]!=="r"?"&":"";try{const f=A.getAltList(h[1],c[1],e);if(f){const g=s.substring(0,a),O=f.filter(b=>!b.getLStr().present).map(b=>h[0]+(b.getNeedDot()?"."+l:l)+c[0]+b.getAltPattern()).sort();O.length>0&&(i.delete(a,n),i.append(O[0]));for(const b of f){const x=b.getAltPattern(),S=b.getLStr();if(S.present)t.updateMapMinLength(S.value,new R(g+"l"+S.value+h[0]+x+l+c[0]));else if(b.getNeedDot())t.updateMapMinLength(x,new R(g+h[0]+"."+(e!==x?"l"+x:"")+l+c[0]));else{if(x.endsWith(".")){const V=x.slice(0,-1);t.updateMapMinLength(V,new R(g+h[0]+(e!==V?"l"+V:"")+l+c[0]+"."))}t.updateMapMinLength(x,new R(g+h[0]+"l"+x+l+c[0]))}}}}catch{}}}class A{constructor(t,e,i=null){this.altPattern=t,this.needDot=e,this.lStr=i}static altCache=new et(256);getAltPattern(){return this.altPattern}getNeedDot(){return this.needDot}getLStr(){return{present:this.lStr!=null,value:this.lStr}}static getAltList(t,e,i){if(!T.isLenOnly(t)||!T.isLenOnly(e))return null;const s=t+"&"+e+":"+i,n=this.altCache.get(s);if(n!==void 0)return n;const r=p.getTick(t)+p.getTick(e),c=p.getAlt(r),o=[];if(c&&c.alt)for(const h of c.alt){let l=!1;for(let f=0;f<h.length;f++){const g=h[f===0?1:0],O=h[f];i===O?(o.push(new A(g,!1)),l=!0):i+"."===O&&(g.endsWith(".")||(o.push(new A(g,!0)),l=!0))}if(!l){const f=h[0],g=h[1];g+"."===f&&(o.push(new A(".",!1,g)),o.push(new A(g,!1,f)))}}const a=o.length>0?o:null;return this.altCache.set(s,a),a}}const it=A.altCache;class U{static pattern=[new m.FixPattern("*","r1.r2","r1r1")];sb="";nextToken(t){this.sb+=t;for(const e of U.pattern)e.patternApply("",{toString:()=>this.sb,reset:i=>(this.sb=i,this)})}getMinString(){return this.sb}}class K{tokens=[];nextToken(t){this.tokens.push(t)}getMinString(){if(this.tokens.length===0)return"";const t=this.tokens.join(""),e=[],i=r=>/[a-gA-G]/.test(r),s=r=>{let c=r+1;if(c<t.length){const o=t[c];(o==="+"||o==="-"||o==="#")&&c++}for(;c<t.length&&/[0-9.]/.test(t[c]);)c++;return{token:t.slice(r,c),next:c}};let n=0;for(;n<t.length;){const r=t[n];if(r==="<"){const c=n+1;if(c<t.length&&i(t[c])&&t[c].toLowerCase()==="b"){const{token:o,next:a}=s(c);if(/^[bB][+#-]/.test(o)){e.push(r),n++;continue}if(a<t.length&&t[a]===">"){let h=!1;for(let l=c+1;l<a;l++)if(i(t[l])){h=!0;break}if(!h){const l=(o[0]==="B"?"C-":"c-")+o.slice(1).replace(/^[+#-]?/,"").replace(/^([0-9].*)$/,"$1");e.push(l),n=a+1;continue}}}}else if(r===">"){const c=n+1;if(c<t.length&&i(t[c])&&t[c].toLowerCase()==="c"){const{token:o,next:a}=s(c);if(/^[cC][+#-]/.test(o)){e.push(r);continue}if(a<t.length&&t[a]==="<"){let h=!1;for(let l=c+1;l<a;l++)if(i(t[l])){h=!0;break}if(!h){const l=(o[0]==="C"?"B+":"b+")+o.slice(1).replace(/^[+#-]?/,"").replace(/^([0-9].*)$/,"$1");e.push(l),n=a+1;continue}}}}e.push(r),n++}return e.join("")}}class d{constructor(t){this.originalMML=t}static GEN1=1;static GEN2=2;static GEN3=3;static debug=!1;static optLevel=1;static mmlCache=new Map;static cacheList=[d.mmlCache];static currentContext=null;static setDebug(t){this.debug=t}static getDebug(){return this.debug}static setOptimizeLevel(t){this.optLevel=t}static clearAllCache(){this.cacheList.forEach(t=>t.clear())}static addCacheList(t){this.cacheList.includes(t)||this.cacheList.push(t)}static setContext(t){this.currentContext=t}static getContext(){return this.currentContext}static initAltPatternCache=(d.addCacheList(it),!0);disableNopt=!1;toString(){return this.cachedOptimize(d.GEN1,!1)}preciseOptimize(){return this.cachedOptimize(d.optLevel,this.disableNopt)}setDisableNopt(t){return this.disableNopt=t,this}cachedOptimize(t,e){const i=t+":"+e+":"+this.originalMML,s=d.mmlCache.get(i);if(s)return s;let n;if(t===d.GEN2){const r=this.optimizeGen2();n=this.fallbackIfChanged(r,e)}else if(t===d.GEN3){const r=this.optimizeGen3();n=this.fallbackIfChanged(r,e)}else n=this.optimize(e);return d.mmlCache.set(i,n),n}optimizeGen2(){return this.optimizeChain([new m(this.disableNopt),new F(this.disableNopt)])}optimizeGen3(){return this.optimizeChain([new j(this.disableNopt),new F(this.disableNopt),new U])}optimizeForTextEditor(){return this.optimizeChain([new m(!0)])}optimize(t){return t?this.optimizeChain([new D,new K]):this.optimizeChain([new D,new K,new Z])}optimizeChain(t){let e=this.originalMML;for(const i of t){const s=new T(e);for(;s.hasNext();){let n=null;try{n=s.next(),i.nextToken(n)}catch{}}e=i.getMinString()}return e}fallbackIfChanged(t,e){return this.quickEquivalent(this.originalMML,t)?t:this.optimize(e)}quickEquivalent(t,e){if(t===e)return!0;const i=this.tokenCounts(t),s=this.tokenCounts(e),n=Object.keys(i),r=Object.keys(s);if(n.length!==r.length)return!1;for(const c of n)if(i[c]!==s[c])return!1;return!0}tokenCounts(t){const e={},i=new T(t);for(;i.hasNext();){const s=i.next();e[s]=(e[s]||0)+1}return e}}function st(u,t,e=0){const i=[];t.slice().sort((c,o)=>c.tickOffset-o.tickOffset).forEach((c,o)=>new M(c.tempo,c.tickOffset,o===0).appendToListElement(i));const s=new I("",i,e),n=u.slice().sort((c,o)=>c.offset-o.offset);for(const c of n)try{const o=c.velocity==null?k.INIT_VOL:c.velocity;if(!(c.tick>0)){console.warn("[buildEventList skip non-positive tick]",{ctx:d.getContext?.(),n:c});continue}const a=new k(c.note,c.tick,c.offset,o);s.addMMLNoteEvent(a)}catch(o){console.warn("[buildEventList note error]",{ctx:d.getContext?.(),n:c,err:o})}return s.getMMLNoteEventList().length===0&&n.length>0&&console.warn("[buildEventList result empty]",{ctx:d.getContext?.(),inputCount:n.length,first:n[0],last:n[n.length-1]}),s}function H(u,t,e={}){try{console.log("[noteToMML enter]",{ctx:d.getContext?.(),notes:u?.length,tempos:t?.length})}catch{}Array.isArray(u)||(u=[]),Array.isArray(t)||(t=[]);const{startOffset:i=0,initOct:s=4,percussionMotionFix:n=!1,mabiTempo:r=!0,includeTempo:c=!0,optimizeLevel:o=2,disableNopt:a=!1}=e,h=st(u,t,i),f=N.create(h,i,s,n).toMMLStringFull(c,r),g=d.optLevel;let O=f;try{d.setOptimizeLevel(o),O=new d(f).setDisableNopt(a).preciseOptimize()}catch(S){try{console.warn("[noteToMML optimize error]",{ctx:d.getContext?.(),err:S})}catch{}O=f}finally{try{d.setOptimizeLevel(g)}catch{}}let b=O,x=!1;try{const S=new I(O,[],i);if(!h.equals(S)){try{const V=f,Y=O;let G=0;const ot=Math.min(V.length,Y.length);for(;G<ot&&V[G]===Y[G];G++);}catch{}b=f,x=!0}}catch{b=f,x=!0}return{original:f,optimized:b,fallbackUsed:x}}function J(u){return u.map(t=>({note:t.pitch,tick:t.durationTick,offset:t.startTick,velocity:t.volume}))}function nt(u,t=[],e=!0){try{const i=H(J(u),t,{includeTempo:e});return i.optimized||i.original||""}catch{return W(u,t)}}function rt(u,t=[],e=!0){try{const i=H(J(u),t,{includeTempo:e});return i.original||i.optimized||""}catch{return W(u,t)}}function ct(u){const t=d.optLevel;d.setOptimizeLevel(2);const e=new d(u).preciseOptimize();return d.setOptimizeLevel(t),e}function W(u,t){try{const e=[];t.slice().sort((n,r)=>n.tickOffset-r.tickOffset).forEach((n,r)=>new M(n.tempo,n.tickOffset,r===0).appendToListElement(e));const i=new I("",e,0);return u.slice().sort((n,r)=>n.startTick-r.startTick).forEach(n=>{try{i.addMMLNoteEvent(new k(n.pitch,n.durationTick,n.startTick,n.volume??15))}catch{}}),N.create(i,0,4,!1).toMMLStringFull(!0,!0)||""}catch{return""}}const L={enabled:!1,firstError:null,recoverCount:0};self.onmessage=u=>{const{trackId:t,notes:e,tpqn:i,tempoAnchors:s}=u.data;try{try{d.setContext(`worker-track-${t}`)}catch{}typeof i=="number"&&(i===147840?Q(!0):i===480&&Q(!1));const n=(s||[]).slice().sort((o,a)=>o.tickOffset-a.tickOffset);let r="";if(Array.isArray(e))if(L.enabled)r=W(e,n);else{const o=t===0;r=nt(e,n,o)||rt(e,n,o)||""}let c="";if(r)if(L.enabled)c=r;else try{c=ct(r)||r}catch(o){L.enabled=!0,L.firstError=L.firstError||String(o),c=r}!L.enabled&&L.firstError&&r===c&&(L.recoverCount++,L.recoverCount>=3&&(L.firstError=null,L.recoverCount=0)),self.postMessage({trackId:t,optimizedMML:c,originalBody:r,notesLen:e.length,safeMode:L.enabled,firstError:L.firstError})}catch(n){try{L.enabled||(L.enabled=!0,L.firstError=String(n),L.recoverCount=0);let r="";try{Array.isArray(e)&&(r=W(e,s||[]))}catch{}self.postMessage({trackId:t,optimizedMML:r,originalBody:r,notesLen:Array.isArray(e)?e.length:0,error:String(n),safeMode:L.enabled,firstError:L.firstError})}catch{}}finally{try{d.setContext(null)}catch{}}}})();
