(function(){"use strict";let Q=480;function Z(g){Q=g?147840:480}class $ extends Error{constructor(t){super(`Illegal tick offset: ${t}`),this.tickOffset=t,this.name="IllegalTickOffsetException"}}class E{static MAX_TICK=384e4;tickOffset;constructor(t){if(t<=-384e4||t>=E.MAX_TICK)throw new $(t);this.tickOffset=t}setTickOffset(t){if(t<0||t>=E.MAX_TICK)throw new $(t);this.tickOffset=t}getTickOffset(){return this.tickOffset}static insertTick(t,e,i){for(const s of t){const n=s.getTickOffset();n>=e&&s.setTickOffset(n+i)}}static removeTick(t,e,i){const s=[];for(const n of t){const r=n.getTickOffset();r>=e&&(r<e+i?s.push(n):n.setTickOffset(r-i))}for(const n of s){const r=t.indexOf(n);r>=0&&t.splice(r,1)}}equals(t){return t instanceof E?this.tickOffset===t.tickOffset:!1}}class v extends Error{localizedMessage;constructor(t,e,i){super(t+": "+e),this.name="MMLException",this.localizedMessage=void 0}getLocalizedMessage(){return this.localizedMessage??this.message}static createUndefinedTickException(t,e){return typeof t=="number"&&typeof e=="number"?t===e?new v("Undefined tick table",String(t),"undefined_tick"):new v("Undefined tick table",`${t}/${e}`,"undefined_tick"):new v("Undefined tick table",String(t),"undefined_tick")}static createIllegalNote(t){return new v("Illegal note",String(t),"illegal_note")}}class _{array;constructor(t){const e=Math.max(...Array.from(t.keys()));this.array=[];for(let i=0;i<=e;i++)this.array[i]=t.get(i)}max(){return this.array.length}validCount(){return this.array.reduce((t,e)=>e!==void 0?t+1:t,0)}containsKey(t){return t>=0&&t<this.array.length&&this.array[t]!==void 0}get(t){return t>=0&&t<this.array.length?this.array[t]:void 0}}class B{static COMBN=3;static singleton=null;static getInstance(){return this.singleton??(this.singleton=new B)}tickTable;tickInvTable;tickInvTableForMb;mode=null;constructor(){this.tickTable=this.generateTickTable(Q,!0);const t=Array.from(this.tickTable.keys());this.tickInvTable=this.generateInvTable(t),this.tickInvTableForMb=this.generateInvTable(["1","1.","2","2.","4","4.","8","8.","16","16.","32","32.","64","64.","6","12","24","48"])}switch(t){this.mode=t}getTable(){return this.tickTable}getInvTable(){return this.mode==="MB"?this.tickInvTableForMb:this.tickInvTable}getPattern(t){return this.getInvTable().get(t)}add(t,e,i,s){let n=Math.trunc(e*4/i);s&&(n+=Math.trunc(n/2)),t.set(i+(s?".":""),n)}generateTickTable(t,e){const i=new Map;for(let s=1;s<=64;s++)this.add(i,t,s,!0),this.add(i,t,s,!1);return i}patternLength(t){let e=0;const i=["1","2","4","8","16"],s=i.map(n=>n+".");for(const n of t)i.indexOf(n)>=0?e+=n.length:s.indexOf(n)>=0?e+=n.length*2:e+=n.length*3;return e+t.length*10}generateInvTable(t){const e=new Map,i=this.tickTable.get("1")*2-1,s=this.tickTable;for(let n=1;n<=B.COMBN;n++){const r=this.combine(t,n);for(const o of r){const c=o.reduce((a,h)=>a+(s.get(h)||0),0);if(c<=i&&c>0){const a=e.get(c);if(!a)e.set(c,{primary:o.slice(),alt:[]});else{const h=this.patternLength(o),l=this.patternLength(a.primary);h<=l?(o.length===2&&a.alt.push([...a.primary]),a.primary=o.slice()):o.length===2&&a.alt.push(o.slice())}}}}return new _(e)}combine(t,e){const i=[],s=(n,r)=>{if(r.length===e){i.push(r.slice());return}for(let o=n;o<t.length;o++)r.push(t[o]),s(o,r),r.pop()};return s(0,[]),i}}class y{constructor(t){this.base=t,y.all.push(this);try{this.tick=p.getTick(t)}catch{this.tick=0}}static all=[];static L64=new y("64");static L32=new y("32");static L16=new y("16");static L48=new y("48");static L24=new y("24");static L12=new y("12");tick=0;getBase(){return this.base}getTick(){return this.tick}static getInstance(t){return y.all.find(e=>e.tick===t)||null}}class p{constructor(t,e,i=!0){this.noteName=t,this.tick=e,this.needTie=i}static tickTable=B.getInstance();static getTick(t){let e=t;for(;!this.tickTable.getTable().has(e);){const i=e.length;if(i===0)break;const s=e.charAt(i-1);if(s<"0"||s>"9")e=e.substring(0,i-1);else throw v.createUndefinedTickException(t)}return this.tickTable.getTable().get(e)}static minimum=null;static minimumTick(){if(this.minimum!=null)return this.minimum;let t;for(const e of this.tickTable.getTable().values())(t===void 0||e<t)&&(t=e);return this.minimum=t,this.minimum}static getAlt(t){const e=this.tickTable.getInvTable().get(t);return e?e.alt:void 0}mmlNotePart(t){const e=Array.isArray(t)?t:[t];let i="";for(const s of e)this.needTie&&(i+="&"),i+=this.noteName+s;return i}makeMMLText(t,e){if(e>0){for(let i=1;i<=64;i*=2){const s=p.getTick(""+i),n=p.tickTable.getInvTable().get(e);if(n){t+=this.mmlNotePart(n.primary),e=0;break}for(;e>=s;)t+=this.mmlNotePart(""+i),e-=s}if(e>0)throw v.createUndefinedTickException(e,p.getTick("1"))}return this.needTie?t.length>0?t.substring(1):"":t}toMMLText(){let t=this.tick,e="";const i=p.getTick("1."),s=p.getTick("1");for(;t>s*2;)e+=this.mmlNotePart("1."),t-=i;return this.makeMMLText(e,t)}toMMLTextByBase(t){let e=this.tick,i="";const s=p.minimumTick(),n=t.getTick();for(;e>=n+s;)i+=this.mmlNotePart(t.getBase()),e-=n;return this.makeMMLText(i,e)}}class k extends E{static INIT_VOL=15;static MAX_VOL=15;note;tick;tuningBase=null;velocity;indexOfMMLString=null;mute=!1;constructor(t,e,i,s=k.INIT_VOL){if(super(i),i+e>=E.MAX_TICK)throw new $(i+e);if(s<0||s>k.MAX_VOL)throw new Error("velocity "+s);this.note=t,this.tick=e,this.velocity=s}getNote(){return this.note}setNote(t){this.note=t}getTick(){return this.tick}getEndTick(){return this.getTickOffset()+this.tick}setTick(t){this.tick=t}isTuningNote(){return this.tuningBase!==null}getTuningBase(){return this.tuningBase}setTuningNote(t){this.tuningBase=t}getVelocity(){return this.velocity}setVelocity(t){t<0?t=0:t>k.MAX_VOL&&(t=k.MAX_VOL),this.velocity=t}modifyVelocity(t){this.setVelocity(this.velocity+(t?1:-1))}getIndexOfMMLString(){return this.indexOfMMLString}setIndexOfMMLString(t){this.indexOfMMLString=t}isMute(){return this.mute}setMute(t){this.mute=t}toString(){return`[Note] note: ${this.note}, tick: ${this.tick}, offset: ${this.getTickOffset()}, velocity: ${this.velocity}`}static noteNameTable=["c","c+","d","d+","e","f","f+","g","g+","a","a+","b"];getNoteName(){return this.note===-1?"c-":k.noteNameTable[this.note%k.noteNameTable.length]}toMMLString(){return this._toMMLString(0)}_toMMLString(t){if(this.note<-1||this.note>=108)throw v.createIllegalNote(this.note);const e=this.getNoteName();let i=this.tick;this.getTickOffset()<t&&(i-=t-this.getTickOffset());const s=new p(e,i);return this.tuningBase?s.toMMLTextByBase(this.tuningBase):s.toMMLText()}toMMLStringWithPrev(t){if(this.note<-1||this.note>=108)throw v.createIllegalNote(this.note);let e="";return e+=this.createMMLSpaceString(t),e+=this.changeOctaveinMMLString(t.getOctave()),t.getVelocity()!==this.velocity&&(e+="v"+this.velocity),e+=this._toMMLString(t.getEndTick()),e}createMMLSpaceString(t){const e=this.getTickOffset()-t.getEndTick();return e>0?new p("r",e,!1).toMMLText():""}changeOctaveinMMLString(t){let e="";const i=">>>>>>>>",s="<<<<<<<<",n=t-this.getOctave();return n>0?e=s.substring(0,n):n<0&&(e=i.substring(0,-n)),e}getOctave(){return this.note<0?0:Math.trunc(this.note/12)}equals(t){if(!(t instanceof k))return!1;const e=t;return this.tick===e.tick&&this.note===e.note&&this.velocity===e.velocity&&super.equals(e)&&this.tuningBase===e.tuningBase}static keyToAbsNote(t){try{const e=new k(t,0,0),i=e.getOctave(),s=e.getNoteName().toUpperCase();return"O"+i+s}catch{return""}}clone(){const t=new k(this.note,this.tick,this.getTickOffset(),this.velocity);return t.setTuningNote(this.tuningBase),t.setIndexOfMMLString(this.indexOfMMLString?[this.indexOfMMLString[0],this.indexOfMMLString[1]]:null),t.setMute(this.mute),t}}class O extends E{static META=81;static INITIAL_TEMPO=120;tempo;isFirst;constructor(t,e,i=!1){if(super(e),t<=0||t>1e3)throw new Error("tempo "+t);this.tempo=t,this.isFirst=i}getTempo(){return this.tempo}setTempo(t){this.tempo=t}toString(){return`${this.getTickOffset()}T${this.tempo}`}static fromString(t){if(!t||t.length===0)return null;const e=t.split("T");return e.length!==2?null:new O(parseInt(e[1],10),parseInt(e[0],10))}toMMLString(){return"t"+this.tempo}appendToListElement(t){let e=0;const i=this.getTickOffset();for(;e<t.length;e++){const s=t[e];if(s.getTickOffset()===i){t.splice(e,1);break}else if(s.getTickOffset()>i)break}(e===0||t[e-1].getTempo()!==this.tempo||!this.isFirst)&&t.splice(e,0,this)}static mergeTempoList(t,e){if(t!==e)for(const i of t)i.appendToListElement(e);return e}static searchOnTick(t,e){let i=O.INITIAL_TEMPO;for(const s of t){if(e<s.getTickOffset())break;i=s.getTempo()}return i}static searchEqualsTick(t,e){for(const i of t){if(i.getTickOffset()===e)return!0;if(i.getTickOffset()>e)break}return!1}static getMaxTempoEvent(t){const e=new O(O.INITIAL_TEMPO,0);for(const i of t){const s=i.getTempo();e.getTempo()<s&&e.setTempo(s)}return e}getMetaData(){const t=Math.trunc(6e7/this.tempo),e=new Uint8Array(3);return e[0]=t>>16&255,e[1]=t>>8&255,e[2]=t&255,e}clone(){return new O(this.tempo,this.getTickOffset(),this.isFirst)}equals(t){return t instanceof O?this.tempo===t.tempo&&super.equals(t):!1}}class tt{index=0;tokens=[];currentOct=4;currentVelocity=k.INIT_VOL;tickOffset;pendingTie=!1;lastNote=null;defaultLengthBase=4;defaultLengthDotted=!1;constructor(t,e){this.tickOffset=e|0;const i=(t||"").toLowerCase().replace(/\s+/g,"").replace(/^mml@/,""),s=/(t\d{1,4})|(o\d)|(l\d+\.)|(l\d+)|(>>+|>+|<<+|<+)|([a-gA-G][+#-]?\d+\.)|([a-gA-G][+#-]?\d*\.)|([a-gA-G][+#-]?\d*)|(r\d+\.)|(r\d*\.)|(r\d*)|(n\d+)|(v\d{1,3})|(&)|([^])/g;let n;for(;n=s.exec(i);){const r=n[0];r.trim().length!==0&&this.tokens.push(r)}if(globalThis.MML_DEBUG)try{console.log("[MMLEventParser tokens]",{body:i,tokens:this.tokens})}catch{}}hasNext(){return this.index<this.tokens.length}next(){if(!this.hasNext())return null;const t=this.tokens[this.index++];if(t==="&")return this.pendingTie=!0,null;const e=t.charAt(0).toLowerCase();if(e==="t"){const i=parseInt(t.substring(1),10);return Number.isFinite(i)&&i>0?new O(i,this.tickOffset,this.tickOffset===0):null}if(e==="o"){const i=parseInt(t.substring(1),10);return Number.isFinite(i)&&(this.currentOct=Math.max(0,Math.min(9,i))),null}if(e==="l"){const i=/^l(\d+)(\.)?$/.exec(t);if(i){const s=parseInt(i[1],10);Number.isFinite(s)&&s>0&&(this.defaultLengthBase=s,this.defaultLengthDotted=!!i[2])}return null}if(e===">"||e==="<"){for(const i of t)i===">"?this.currentOct=Math.min(9,this.currentOct+1):i==="<"&&(this.currentOct=Math.max(0,this.currentOct-1));return null}if(e==="v"){const i=parseInt(t.substring(1),10);return Number.isFinite(i)&&(this.currentVelocity=Math.max(0,Math.min(15,i))),null}if(e==="n"){const i=parseInt(t.substring(1),10);if(Number.isFinite(i)){const s=this.defaultLengthBase+(this.defaultLengthDotted?".":""),n=this.parseLength(s)||p.getTick("4"),r=this.currentVelocity;if(this.pendingTie&&this.lastNote&&this.lastNote.getNote()===i&&this.lastNote.getVelocity()===r)return this.lastNote.setTick(this.lastNote.getTick()+n),this.tickOffset+=n,this.pendingTie=!1,null;const o=new k(i,n,this.tickOffset,r);return this.lastNote=o,this.pendingTie=!1,this.tickOffset+=n,o}return null}if(e==="r"){let i=t.substring(1);i==="."?i=this.defaultLengthBase+".":i===""&&(i=this.defaultLengthBase+(this.defaultLengthDotted?".":""));const s=this.parseLength(i)||this.parseLength(this.defaultLengthBase+(this.defaultLengthDotted?".":""))||p.getTick("4");return this.tickOffset+=s,null}if(e>="a"&&e<="g"){const i=/^([a-gA-G][+#-]?)(\d*\.?)*$/.exec(t);if(i){const s=i[1];let r=t.substring(s.length);r==="."?r=this.defaultLengthBase+".":r===""&&(r=this.defaultLengthBase+(this.defaultLengthDotted?".":""));const o=this.calcPitch(s,this.currentOct),c=this.defaultLengthBase+(this.defaultLengthDotted?".":""),a=this.parseLength(r)||this.parseLength(c)||p.getTick("4"),h=this.currentVelocity;if(this.pendingTie&&this.lastNote&&this.lastNote.getNote()===o&&this.lastNote.getVelocity()===h)return this.lastNote.setTick(this.lastNote.getTick()+a),this.tickOffset+=a,this.pendingTie=!1,null;const l=new k(o,a,this.tickOffset,h);return this.lastNote=l,this.pendingTie=!1,this.tickOffset+=a,l}}return null}parseLength(t){if(!t)return null;const e=/^(\d+)(\.)?$/.exec(t);if(!e)return null;const i=parseInt(e[1],10);if(!Number.isFinite(i)||i<=0)return null;const s=p.getTick("4");let n=Math.round(4/i*s);return e[2]&&(n+=n/2),Math.round(n)}calcPitch(t,e){const i={c:0,d:2,e:4,f:5,g:7,a:9,b:11},s=t.charAt(0).toLowerCase();let n=i[s]??0;const r=t.charAt(1);return r==="+"||r==="#"?n+=1:r==="-"&&(n-=1),e*12+n}}class w extends Error{static Entry=class{event;exception;constructor(e,i){this.event=e,this.exception=i}getNote(){return this.event}getException(){return this.exception}};errList;constructor(t){super(t[0].exception.message),this.errList=t,Object.setPrototypeOf(this,w.prototype)}getErr(){return this.errList}get message(){return this.errList[0].exception.message}getLocalizedMessage(){return this.errList[0].exception.message}}class z extends p{static REST="r";static ALT="c";static DIV=4294967295;replaced=!1;lastReplaced=!1;prevNoteEvent;constructor(t,e=null){super(z.REST,t,!1),this.prevNoteEvent=e}calcDivTick(t){return Math.ceil(z.DIV*t/6e7)}vZero(t){for(let e=t.length-1;e>=0;e--){const i=t[e].lastIndexOf(z.REST);if(i>=0){t[e]=t[e].substring(0,i)+z.ALT+t[e].substring(i+1),this.prevNoteEvent&&this.prevNoteEvent.getVelocity()>0&&(t[e]=t[e].substring(0,i)+"v0"+t[e].substring(i),this.prevNoteEvent.setVelocity(0));return}}}getPrevNoteEvent(){return this.prevNoteEvent}isReplaced(){return this.replaced}isLastReplaced(){return this.lastReplaced}toMMLTextWithMotionFix(t){let e=this.tick,i="",s=0;const n=this.calcDivTick(t),r=p.getTick("1."),o=p.getTick("1");for(;e>o*2;){if(i+=this.mmlNotePart("1."),s+=r,s>=n){s=r;const c=[i];this.vZero(c),i=c[0],this.replaced=!0}e-=r}if(s+=e,i=this.makeMMLText(i,e),s>=n){const c=[i];this.vZero(c),i=c[0],this.replaced=this.lastReplaced=!0}return i}}class N{static globalVZeroTempo=!0;static setMMLVZeroTempo(t){this.globalVZeroTempo=t}eventList;startOffset;initOct;errList=[];percussionMotionFix;currentTempo=O.INITIAL_TEMPO;static INIT_OCT=4;constructor(t,e,i,s){this.eventList=t,this.startOffset=e,this.initOct=i,this.percussionMotionFix=s}static create(t,e=0,i=N.INIT_OCT,s=!1){return new N(t,e,i,s)}makeTempoChar(t,e,i){const s=[!0,!0,!0,!0,!0,!0,!0];if(t)for(const n of[e.getTickOffset(),e.getEndTick()])for(const r of t){const o=r.searchOnTickOffset(n);if(o&&o.getOctave()===i){const a=o.toMMLString().toLowerCase().charAt(0).charCodeAt(0)-97;a>=0&&a<s.length&&(s[a]=!1)}}for(let n=0;n<s.length;n++){const r=(n+2)%s.length;if(s[r])return String.fromCharCode(97+r)}return"c"}insertRestNoteEvent(t,e,i){const s=i.getTickOffset()-e.getEndTick(),n=e.clone(),r=new z(s,n);if(s>0)try{t.push(this.percussionMotionFix?r.toMMLTextWithMotionFix(this.currentTempo):r.toMMLText()),n.setTick(e.getTick()+s)}catch(o){this.errList.push(new w.Entry(e,o))}return r}insertTempoMML(t,e,i,s,n){let r=e.clone();if(e.getEndTick()<i.getTickOffset()){const o=e.getOctave(),c=this.insertRestNoteEvent(t,e,i);if(r=c.getPrevNoteEvent()??r,s&&N.globalVZeroTempo&&!c.isLastReplaced()){const a=t.lastIndexOf("r");if(a>=0){t[a]="c";const h=new I(t.join("")).getLastNote();try{const l=this.makeTempoChar(n??null,h,o),f=e.getVelocity()!==0?"v0"+l:""+l;t[a]=f}catch(l){this.errList.push(new w.Entry(h,l))}r.setVelocity(0)}}}return t.push(i.toMMLString()),r}insertNoteWithTempo(t,e,i,s,n,r){const o=s.clone();for(;n&&e.length>0&&o.getTickOffset()<e[0].getTickOffset()&&e[0].getTickOffset()<o.getEndTick();){const c=e[0].getTickOffset(),a=c-o.getTickOffset();try{const l=p.minimumTick(),f=(()=>{try{return new p("c",a).toMMLText(),!0}catch{return!1}})();if(a<l||!f){console.warn("[builder tempo split skipped]",{segLen:a,minTick:l,anchorTick:c,noteStart:s.getTickOffset(),noteEnd:s.getEndTick()});break}}catch{}try{a<=32&&console.warn("[builder tempo split small segment]",{noteStart:s.getTickOffset(),noteEnd:s.getEndTick(),anchorTick:c,segLen:a,remainingBefore:o.getTick(),workingStart:o.getTickOffset(),tempo:e[0].getTempo()})}catch{}const h=new k(o.getNote(),a,o.getTickOffset(),o.getVelocity());try{i=this.insertRestNoteEvent(t,i,h).getPrevNoteEvent()??i,t.push(h.toMMLStringWithPrev(i))}catch(l){this.errList.push(new w.Entry(h,l))}n&&t.push(e[0].toMMLString()),this.currentTempo=e[0].getTempo(),e.shift(),o.setTick(o.getTick()-a),o.setTickOffset(o.getTickOffset()+a),i=h,n&&o.getTick()>0&&t.push("&")}if(o.getTick()>0)try{i=this.insertRestNoteEvent(t,i,o).getPrevNoteEvent()??i,t.push(o.toMMLStringWithPrev(i))}catch(c){this.errList.push(new w.Entry(o,c))}}makeLocalTempoList(t){const e=[...this.eventList.getGlobalTempoList()];for(;e.length>1&&e[1].getTickOffset()<=this.startOffset;)this.currentTempo=e[0].getTempo(),e.shift();return e}totalTickRelationPart(t){let e=this.eventList.getTickLength();if(t)for(const i of t)e<i.getTickLength()&&(e=i.getTickLength());return e}static searchRelationPartCanInsertTempo(t,e){if(t)for(const i of t){const s=i.searchOnTickOffset(e);if(!s||s.getTickOffset()===e)return!0}return!1}static searchRelationPartOnTick(t,e){if(t)for(const i of t){const s=i.searchOnTickOffset(e),n=i.searchPrevNoteOnTickOffset(e);if(s&&s.getTickOffset()===e||n&&n.getEndTick()===e)return!0}return!1}tickDeltaCheck(t){if(t===0)return!0;t<0&&(t=-t);const e=p.minimumTick();return!(t<e)}insertNoteWithTempoMusicQ(t,e,i,s,n,r){let o=n.clone(),c=i;for(;e.length>c;){const a=e[c],h=a.getTickOffset();if(o.getTickOffset()>=h||h>=o.getEndTick())break;if(N.searchRelationPartCanInsertTempo(r??null,h)){c++;continue}const l=a.getTickOffset()-o.getTickOffset(),f=new k(o.getNote(),l,o.getTickOffset(),o.getVelocity());try{s=this.insertRestNoteEvent(t,s,f).getPrevNoteEvent()??s,t.push(f.toMMLStringWithPrev(s))}catch(d){this.errList.push(new w.Entry(f,d))}t.push(a.toMMLString()),e.splice(c,1),o.setTick(o.getTick()-l),o.setTickOffset(o.getTickOffset()+l),s=f,o.setVelocity(0)}if(o.getTick()>0)try{s=this.insertRestNoteEvent(t,s,o).getPrevNoteEvent()??s,t.push(o.toMMLStringWithPrev(s))}catch(a){this.errList.push(new w.Entry(o,a))}return n.getVelocity()!==o.getVelocity()&&t.push("v"+n.getVelocity()),c}toMMLStringMusicQ(t,e,i=!1){const s=this.totalTickRelationPart(e),n=[];let r=0;for(;t.length>r+1&&t[r+1].getTickOffset()<=this.startOffset;)t.splice(r,1);let o=new k(12*this.initOct,0,this.startOffset,k.INIT_VOL);for(const c of this.eventList.getMMLNoteEventList()){for(;t.length>r;){const a=t[r],h=c.getTickOffset()-a.getTickOffset(),l=a.getTickOffset()-o.getEndTick();if(h>=0)!i||this.tickDeltaCheck(h)&&this.tickDeltaCheck(l)?(o=this.insertTempoMML(n,o,a,!0,e),this.currentTempo=t[r].getTempo(),t.splice(r,1)):r++;else break}r=this.insertNoteWithTempoMusicQ(n,t,r,o,c,e),o=c}for(;t.length>r;){const c=t[r].getTickOffset();if(c>=s)break;N.searchRelationPartOnTick(e??null,c)?r++:(o=this.insertTempoMML(n,o,t[r],!0,e),this.currentTempo=t[r].getTempo(),t.splice(r,1))}if(this.errList.length>0)throw new w(this.errList);return n.join("")}toMMLString(){return this.toMMLStringFull(!1,!0)}toMMLStringFull(t,e,i){const s=this.totalTickRelationPart(i),n=this.makeLocalTempoList(s),r=[];let o=new k(12*this.initOct,0,this.startOffset,k.INIT_VOL);for(const c of this.eventList.getMMLNoteEventList()){for(;n.length>0&&n[0].getTickOffset()<=c.getTickOffset();)t&&(o=this.insertTempoMML(r,o,n[0],e,i)),this.currentTempo=n[0].getTempo(),n.shift();this.insertNoteWithTempo(r,n,o,c,t,e),o=c}for(;n.length>0;){const c=n[0];if(e&&c.getTickOffset()>=s)break;t&&(o=this.insertTempoMML(r,o,c,e,i)),this.currentTempo=n[0].getTempo(),n.shift()}if(this.errList.length>0)throw new w(this.errList);return r.join("")}}class I{noteList=[];tempoList;constructor(t,e,i=0){this.tempoList=e??[],this.parseMML(t,i)}parseMML(t,e){const i=new tt(t,e);for(;i.hasNext();){const s=i.next();s instanceof O?s.appendToListElement(this.tempoList):s instanceof k&&this.noteList.push(s)}}setGlobalTempoList(t){this.tempoList=t}getGlobalTempoList(){return this.tempoList}getTickLength(){return this.noteList.length>0?this.noteList[this.noteList.length-1].getEndTick():0}isEmpty(){return this.noteList.length===0}getMMLNoteEventList(){return this.noteList}searchOnTickOffset(t){for(const e of this.noteList)if(e.getTickOffset()<=t){if(t<e.getEndTick())return e}else break;return null}searchOnTickOffsetNextNote(t){for(let e=0;e<this.noteList.length-1;e++){const i=this.noteList[e];if(i.getTickOffset()<=t&&t<i.getEndTick())return this.noteList[e+1]}return null}searchPrevNoteOnTickOffset(t){let e=null;for(const i of this.noteList){if(i.getTickOffset()>=t)break;e=i}return e}indexOfMMLString(t){let e=0;for(const i of this.noteList){const s=i.getIndexOfMMLString();if(s){if(i.getTickOffset()<=t){if(t<i.getEndTick())return s}else return[e,s[0]];e=s[1]}}return[e,e]}addMMLNoteEvent(t){if(t.getNote()<-1||t.getTick()<=0||t.getEndTick()<=0)return;let e=t.getTickOffset();e<0&&(t.setTick(t.getTick()+e),t.setTickOffset(0));let i=0;for(;i<this.noteList.length;i++){const s=this.noteList[i],n=s.getEndTick()-t.getTickOffset();if(t.getTickOffset()<s.getTickOffset())break;if(n>=0){const r=s.getTick()-n;if(r===0){this.noteList.splice(i,1);break}else{s.setTick(r),i++;break}}}for(this.noteList.splice(i++,0,t);i<this.noteList.length;){const s=this.noteList[i];if(t.getEndTick()-s.getTickOffset()>0)this.noteList.splice(i,1);else break}}isOverlapNote(t){let e=0;const i=this.noteList.length;for(;e<i;e++){const s=this.noteList[e];if(t.getTickOffset()<s.getEndTick()){if(t.getTickOffset()>=s.getTickOffset())return!0;break}}for(;e<i;e++){const s=this.noteList[e];if(t.getEndTick()<=s.getEndTick()){if(t.getEndTick()-1>=s.getTickOffset())return!0;break}}return!1}deleteMMLEvent(t){const e=this.noteList.indexOf(t);e>=0&&this.noteList.splice(e,1)}setVelocityCommand(t,e){this.setUnsetVelocityCommand(t,e,!0)}unsetVelocityCommand(t){this.setUnsetVelocityCommand(t,0,!1)}setUnsetVelocityCommand(t,e,i){const s=t.getVelocity();let n=k.INIT_VOL;for(const r of this.noteList)if(r.getTickOffset()>=t.getTickOffset())if(s===r.getVelocity())r.setVelocity(i?e:n);else break;else n=r.getVelocity()}toString(){return this.tempoList.toString()+this.noteList.toString()}clone(){const t=new I("",this.tempoList.map(e=>e.clone()),0);return t.noteList=this.noteList.map(e=>e.clone()),t}getAlignmentStartTick(t,e){const i=t.searchOnTickOffset(e);return i==null||i.getTickOffset()===e?e:t.getAlignmentStartTick(this,i.getTickOffset())}getAlignmentEndTick(t,e){const i=t.searchOnTickOffset(e-1);return i==null||i.getEndTick()===e?e:t.getAlignmentEndTick(this,i.getEndTick())}swap(t,e,i){const s=[],n=[];for(const r of this.noteList)r.getTickOffset()>=e&&r.getEndTick()<=i&&s.push(r);for(const r of s)this.noteList.splice(this.noteList.indexOf(r),1);for(const r of t.getMMLNoteEventList())r.getTickOffset()>=e&&r.getEndTick()<=i&&n.push(r);for(const r of n)t.getMMLNoteEventList().splice(t.getMMLNoteEventList().indexOf(r),1),this.addMMLNoteEvent(r);for(const r of s)t.addMMLNoteEvent(r)}move(t,e,i){const s=[];for(const n of this.noteList)n.getTickOffset()>=e&&n.getEndTick()<=i&&s.push(n);for(const n of s)this.deleteMMLEvent(n),t.addMMLNoteEvent(n)}copy(t,e,i){for(const s of this.noteList)s.getTickOffset()>=e&&s.getEndTick()<=i&&t.addMMLNoteEvent(s.clone())}deleteMinRest(){const t=p.minimumTick();for(let e=1;e<this.noteList.length;e++){const i=this.noteList[e-1],n=this.noteList[e].getTickOffset()-i.getEndTick();if(n>0&&n<t){const r=i.getTick()-t+n;r>=t?i.setTick(r):i.setTick(i.getTick()+n)}}}transpose(t){for(const e of this.noteList)e.setNote(e.getNote()+t)}equals(t){if(!(t instanceof I))return!1;const e=t,i=this.noteList.length===e.noteList.length&&this.noteList.every((n,r)=>n.equals(e.noteList[r])),s=this.tempoList.length===e.tempoList.length&&this.tempoList.every((n,r)=>n.equals(e.tempoList[r]));return i&&s}getLastNote(){return this.noteList.length>0?this.noteList[this.noteList.length-1]:null}getInternalMMLString(){return N.create(this).toMMLStringFull(!1,!1)}static maxEndTick(t){let e=0;for(const i of t){const s=i.getLastNote();s&&e<s.getEndTick()&&(e=s.getEndTick())}return e}}class T{static noteString="abcdefgABCDEFGnNrR";static tokenString=T.noteString+"tToOlLvV<>&, ";static tokenCache=new Map;mml_src;mml_length;mml_charArray;startIndex=0;endIndex=0;constructor(t){this.mml_src=t,this.mml_length=t.length,this.mml_charArray=t.split("")}hasNext(){return this.endIndex<this.mml_length}next(){return this.startIndex=this.endIndex,this.endIndex=this.searchToken(this.endIndex+1),this.mml_src.substring(this.startIndex,this.endIndex)}remove(){this.startIndex=0,this.endIndex=0}getStart(){return this.startIndex}getEnd(){return this.endIndex}getIndex(){return[this.startIndex,this.endIndex]}static isToken(t){return T.tokenString.indexOf(t)>=0}static isNote(t){return T.noteString.indexOf(t)>=0}static noteName(t){let e=t.substring(0,1);if(t.length>1){const i=t.charAt(1);(i==="+"||i==="-"||i==="#")&&(e+=i)}return e}static noteNames(t){const e=this.tokenCache.get(t);if(e)return e;const i=this.noteName(t),s=t.substring(i.length),n=[i,s];return this.tokenCache.set(t,n),n}static isLenOnly(t){return t.endsWith(".")&&(t=t.substring(0,t.length-1)),/^[0-9]+$/.test(t)}searchToken(t){let e;for(e=t;e<this.mml_length;e++){const i=this.mml_charArray[e];if(T.isToken(i))break}return e}backSearchToken(t){let e;for(e=t-1;e>=0;e--){const i=this.mml_charArray[e];if(T.isToken(i))break}return e}}class D{static getOctaveString(t,e){const i=t-e;return Math.abs(i)>2?"o"+e:(i<0?">>":"<<").substring(0,Math.abs(i))}class_OptimizerMap=class extends Map{updateMapMinLength(e,i){const s=this.get(e);(!s||i.length()<s.length())&&this.set(e,i)}};createOptimizerMap(){return new this.class_OptimizerMap}map=this.createOptimizerMap();section="4";octave=4;octD=0;tokenStack=0;constructor(){this.map.set("4",new P)}getMinString(){let t,e=Number.MAX_SAFE_INTEGER;for(const i of this.map.values()){const s=i.length();s<e&&(t=i,e=s)}return t?t.toString():""}addString(t,e=0){for(const i of this.map.values())e===0?i.append(t):i.insert(i.length()-e,t)}newBuilder(t,e,i,s){const n=t.length();return t.insert(n-s,"l"+e),t.append(i),t}extendPatternBuilder(t,e,i,s,n){}fixPattern(t){}addNoteText(t,e,i){let s=e;s===""?s=this.section:s==="."&&(s=this.section+".");const n=new Map,r=this.getMinString(),o=(c,a)=>{if(a.append(t),c!==s){s===c+"."?a.append("."):a.append(s);const h=new P().append(r),l=this.newBuilder(h,s,t,i);if(this.updateMapMinLength(n,s,l),s.endsWith(".")){const f=s.substring(0,s.length-1),d=new P().append(r),x=this.newBuilder(d,f,t+".",i);this.updateMapMinLength(n,f,x)}this.extendPatternBuilder(n,r,t,s,i)}};for(const[c,a]of this.map.entries())o(c,a);for(const[c,a]of n.entries())this.updateMapMinLength(this.map,c,a);q.updateFlexDot(this.map,t,s),this.fixPattern(this.map)}updateMapMinLength(t,e,i){const s=t.get(e);(!s||i.length()<s.length())&&t.set(e,i)}cleanMap(){const t=this.getMinString().length;for(const[e,i]of[...this.map.entries()])i.length()>t+e.length+1&&this.map.delete(e)}resetOctave(){this.octave=4,this.octD=0}insertOxPattern(t){if(this.octD!==0){const e=this.octave+this.octD;this.addString(D.getOctaveString(this.octave,e),t),this.octave=e,this.octD=0}}insertLxPattern(t,e,i){this.addNoteText(t,e,i)}doPattern(t,e,i){this.insertOxPattern(i),this.insertLxPattern(t,e,i)}doToken(t,e){if(t==="o")this.octD=parseInt(e,10)-this.octave;else if(t===">")this.octD++;else if(t==="<")this.octD--;else if(t==="l"){if(e&&this.section!==e){this.section=e,this.addString("l"+e,this.tokenStack);const i=this.getMinString(),s=this.createOptimizerMap();s.set(e,new class extends P{}().append(i)),this.map=s}}else return!1;return!0}nextToken(t){const e=t.charAt(0).toLowerCase(),i=T.noteNames(t);if(e==="n"&&/^n\d+\.?$/i.test(t)){this.addString(t),this.tokenStack>0?this.tokenStack+=t.length:this.tokenStack=0;return}T.isNote(e)?(this.doPattern(i[0],i[1],this.tokenStack),this.tokenStack=0,this.cleanMap()):(this.doToken(e,i[1])||this.addString(t),e==="&"&&(this.tokenStack+=t.length))}}class P{parts=[];append(t){return this.parts.push(t),this}toString(){return this.parts.join("")}length(){return this.parts.reduce((t,e)=>t+e.length,0)}reset(t){return this.parts=[t],this}insert(t,e){const i=this.toString(),s=i.slice(0,t),n=i.slice(t);return this.parts=[s,e,n],this}}class q{static flexList=[64,32,16,8,4].map(t=>new q(t));lCur;lNext;lPrev;constructor(t){this.lCur=t/2+".",this.lNext=""+t,this.lPrev=""+t/4}updatePattern(t,e,i){let s=e;/^[rR]$/.test(e)||(s="&"+e);const n=new Map,r=e+this.lPrev+s+this.lCur;for(const o of t.keys())if(o===this.lNext){const c=t.get(o).toString();if(c.endsWith(r)){const a=c.substring(0,c.length-r.length),h=this.lPrev+".",l=a+e+s+h,f=a+e+"l"+h+s,d=a+e+"l"+this.lPrev+s+".";n.set(o,new P().append(l)),n.set(h,new P().append(f)),n.set(this.lPrev,new P().append(d))}}for(const[o,c]of n.entries()){const a=t.get(o);(!a||c.length()<a.length())&&t.set(o,c)}}static updateFlexDot(t,e,i){for(const s of this.flexList)if(i===s.lCur){s.updatePattern(t,e,i);break}}}class R{builder=[];nCount=0;prevOct;offsetIndex=null;constructor(t,e=""){this.prevOct=t,e&&this.builder.push(e)}clone(){const t=new R(this.prevOct);return t.builder=[...this.builder],t.nCount=this.nCount,this.offsetIndex!=null&&(t.offsetIndex=this.offsetIndex),t}length(){return this.builder.join("").length}toString(){return this.builder.join("")}addOctToken(t){this.offsetIndex==null&&(this.offsetIndex=t)}}class K{octave=4;builderList=[new R(4)];lastNoteNumber=-1;minStack(t){return!Array.isArray(t)||t.length===0?new R(this.octave):t.reduce((e,i)=>{const s=typeof e.length=="function"?e.length():String(e.toString?.()??"").length,n=typeof i.length=="function"?i.length():String(i.toString?.()??"").length;if(s!==n)return s<n?e:i;const r=e.nCount??0,o=i.nCount??0;return r!==o?r<o?e:i:e})}getCurrentNoteNumber(){return this.lastNoteNumber}calcNoteNumber(t){const e={c:0,d:2,e:4,f:5,g:7,a:9,b:11},i=t.toLowerCase(),s=i.charAt(0);if(!(s in e))return-1;let n=e[s];if(i.length>1){const o=i.charAt(1);o==="+"?n+=1:o==="-"?n-=1:o==="#"&&(n+=1)}return this.octave*12+n}listClone(){return this.builderList.map(t=>t.clone())}cleanList(){const t=this.minStack(this.builderList);this.builderList.length=0,this.builderList.push(t)}clearOctToken(){this.builderList.forEach(t=>t.offsetIndex=null)}addNoteToken(t){this.builderList.forEach(e=>{e.builder.push(this.getOctaveString(e.prevOct,this.octave)),e.builder.push(t),e.prevOct=this.octave}),this.clearOctToken()}addToken(t){this.builderList.forEach(e=>e.builder.push(t))}addPattern(t){const e=this.getCurrentNoteNumber();e<0||e>96||(t.forEach(i=>{i.builder.push("n"+e),i.nCount++}),this.builderList.push(this.minStack(t)),this.clearOctToken())}notePattern(t,e,i){const s=this.listClone();this.addNoteToken(t),this.cleanList(),i.length===0&&this.addPattern(s)}doToken(t){const e=T.noteNames(t),i=e[0].charAt(0).toLowerCase();i>="a"&&i<="g"?(this.lastNoteNumber=this.calcNoteNumber(e[0]),this.notePattern(t,e[0],e[1])):i===">"?(this.octave++,this.addOctToken(t)):i==="<"?(this.octave--,this.addOctToken(t)):i==="o"?(this.octave=parseInt(e[1]||"4",10),this.addOctToken(t)):this.addToken(t)}getOctaveString(t,e){const i=t-e;return Math.abs(i)>2?"o"+e:i===0?"":i<0?">".repeat(-i):"<".repeat(i)}addOctToken(t){this.builderList.forEach(e=>{try{if(e&&typeof e.addOctToken=="function"&&Array.isArray(e.builder))e.addOctToken(e.builder.join("").length);else{const i=Array.isArray(e.builder)?e.builder.join("").length:0;e.offsetIndex==null&&(e.offsetIndex=i)}}catch{}})}nextToken(t){this.doToken(t)}getMinString(){return this.minStack(this.builderList).toString()}}class F extends K{map=new Map;disableNopt;constructor(t,e,i){typeof t=="boolean"?(super(),this.disableNopt=t):(super(),this.octave=t,this.disableNopt=i===!0,this.builderList.length=0,this.builderList.push(new class{builder=[e||""];nCount=0;prevOct=t;offsetIndex=null}),this.parser.setOctave(t))}addTokenVariant(t,e,i){let s=t.builder.join("");t.prevOct!==e&&(s+=this.getOctaveString(t.prevOct,e)),s+=i;const n=this.map.get(e);(!n||n.length>s.length)&&this.map.set(e,s)}notePattern(t,e,i){this.builderList.forEach(s=>{if(this.addTokenVariant(s,this.octave,t),e==="b"?this.addTokenVariant(s,this.octave+1,"c-"+i):e==="c"&&this.addTokenVariant(s,this.octave-1,"b+"+i),!this.disableNopt&&s.prevOct!==this.octave&&i.length===0){const n=this.getCurrentNoteNumber();n>=0&&n<=96&&this.addTokenVariant(s,s.prevOct,"n"+n)}}),this.builderList=[];for(const[s,n]of this.map.entries())this.builderList.push(new class{builder=[n];nCount=0;prevOct=s;offsetIndex=null});this.map.clear()}getOptimizedLength(){return this.getMinString().length}static optimizeTail(t,e,i,s){const n=new F(t,e,s),r=new T(i);for(;r.hasNext();)n.nextToken(r.next());return n.getOptimizedLength()}}class m extends D{constructor(t){super(),this.disableNopt=t}static FixPattern=class{constructor(e,i,s){this.lStr=e,this.match=i,this.replace=s}patternApply(e,i){if(e===this.lStr||this.lStr==="*"){const s=i.toString();if(s.endsWith(this.match)){const n=s.length-this.match.length,r=s.substring(0,n)+this.replace;i.reset(r)}}}};static pattern=[new m.FixPattern("32","r16.","rrr"),new m.FixPattern("64","r32.","rrr")];createOptimizerMap(){const t=super.createOptimizerMap(),e=this.disableNopt,i=(o,c)=>{let a=0;const h=Math.min(o.length,c.length);for(;a<h&&o.charAt(a)===c.charAt(a);)a++;for(a--,a<0&&(a=0);a>0;){const l=o.charAt(a);if(T.isToken(l)||T.isNote(l))break;a--}return a},s=o=>{let c=4;const a=o.split("");for(let h=0;h<a.length;h++)switch(a[h]){case"<":c--;break;case">":c++;break;case"o":case"O":h++,h<a.length&&(c=a[h].charCodeAt(0)-48);break}return c},n=new Map;u.addCacheList(n);const r=(o,c,a)=>{const h=o.length+":"+c+":"+a+":"+(e?"1":"0"),l=n.get(h);if(l!==void 0)return l;const f=new F(a,o,e),d=new T(c);for(;d.hasNext();)f.nextToken(d.next());const x=f.getMinString().length;return n.set(h,x),x};return t.updateMapMinLength=(o,c)=>{const a=t.get(o);if(!a){t.set(o,c);return}const h=c.toString(),l=a.toString(),f=i(h,l),d=s(h.substring(0,f)),x=h.substring(0,f),b=r(x,h.substring(f),d),M=r(x,l.substring(f),d);b<M&&t.set(o,c)},t}fixPattern(t){for(const[e,i]of t.entries())for(const s of m.pattern)s.patternApply(e,i)}extendPatternBuilder(t,e,i,s,n){const r=e.lastIndexOf("l");let o="4";if(r>=0&&(o=new T(e.substring(r)).next().substring(1)),n>0&&!o.endsWith(".")&&e.endsWith(i+"&")&&s===((parseInt(o)<<1)+".").toString()){const c=""+(parseInt(o)<<2),a=e.substring(0,e.length-1)+"."+e.substring(e.length-1);let h=t.get(c);h||(h=new class{parts=[];append(l){return this.parts.push(l),this}toString(){return this.parts.join("")}length(){return this.parts.reduce((l,f)=>l+f.length,0)}insert(l,f){const d=this.toString();return this.parts=[d.slice(0,l),f,d.slice(l)],this}reset(l){return this.parts=[l],this}}),h.reset(a),t.set(c,h)}}}class et extends Map{constructor(t){super(),this.max=t}order=[];get(t){const e=super.get(t);if(e!==void 0){const i=this.order.indexOf(t);i>=0&&(this.order.splice(i,1),this.order.push(t))}return e}set(t,e){if(super.has(t)){const i=this.order.indexOf(t);i>=0&&(this.order.splice(i,1),this.order.push(t))}else if(this.order.push(t),this.order.length>this.max){const i=this.order.shift();i!==void 0&&super.delete(i)}return super.set(t,e)}delete(t){const e=this.order.indexOf(t);return e>=0&&this.order.splice(e,1),super.delete(t)}clear(){this.order=[],super.clear()}}class W{constructor(t=""){this.buf=t}append(t){return this.buf+=t,this}toString(){return this.buf}length(){return this.buf.length}delete(t,e){return this.buf=this.buf.slice(0,t)+this.buf.slice(e),this}replace(t,e,i){return this.buf=this.buf.slice(0,t)+i+this.buf.slice(e),this}substring(t,e){return this.buf.substring(t,e)}insert(t,e){return this.buf=this.buf.slice(0,t)+e+this.buf.slice(t),this}}class U extends m{static altPatterns=[new m.FixPattern("64","42","."),new m.FixPattern("32","21","."),new m.FixPattern("24","r12","rr"),new m.FixPattern("32","r16","rr"),new m.FixPattern("48","r24","rr"),new m.FixPattern("64","r32","rr"),new m.FixPattern("24","r12.","rrr"),new m.FixPattern("32","r16.","rrr"),new m.FixPattern("48","r24.","rrr"),new m.FixPattern("64","r32.","rrr"),new m.FixPattern("4","r3r9r16","rr5r17")];altPatternMap=new m.OptimizerMap;constructor(t){super(t)}fixPattern(t){this.altPatternMap.clear();for(const[e,i]of t.entries())this.tickAltPattern(this.altPatternMap,e,i);for(const[e,i]of this.altPatternMap.entries())t.updateMapMinLength(e,i);for(const[e,i]of t.entries())for(const s of U.altPatterns)s.patternApply(e,i);super.fixPattern(t)}tickAltPattern(t,e,i){const s=i.toString();let n=s.length,r=n;for(;r>0&&!T.isNote(s.charAt(--r)););if(r===0)return;const o=T.noteNames(s.substring(r,n));let c=r-1;if(o[0]==="r")c++;else if(s.charAt(c)!=="&")return;let a=c;for(;a>0&&!T.isNote(s.charAt(--a)););const h=T.noteNames(s.substring(a,c));if(h[0]!==o[0]||h[0]==="n"||o[0]==="n")return;const l=h[0]!=="r"?"&":"";try{const f=A.getAltList(h[1],o[1],e);if(f){const d=s.substring(0,a),x=f.filter(b=>!b.getLStr().present).map(b=>h[0]+(b.getNeedDot()?"."+l:l)+o[0]+b.getAltPattern()).sort();x.length>0&&(i.delete(a,n),i.append(x[0]));for(const b of f){const M=b.getAltPattern(),C=b.getLStr();if(C.present)t.updateMapMinLength(C.value,new W(d+"l"+C.value+h[0]+M+l+o[0]));else if(b.getNeedDot())t.updateMapMinLength(M,new W(d+h[0]+"."+(e!==M?"l"+M:"")+l+o[0]));else{if(M.endsWith(".")){const V=M.slice(0,-1);t.updateMapMinLength(V,new W(d+h[0]+(e!==V?"l"+V:"")+l+o[0]+"."))}t.updateMapMinLength(M,new W(d+h[0]+"l"+M+l+o[0]))}}}}catch{}}}class A{constructor(t,e,i=null){this.altPattern=t,this.needDot=e,this.lStr=i}static altCache=new et(256);getAltPattern(){return this.altPattern}getNeedDot(){return this.needDot}getLStr(){return{present:this.lStr!=null,value:this.lStr}}static getAltList(t,e,i){if(!T.isLenOnly(t)||!T.isLenOnly(e))return null;const s=t+"&"+e+":"+i,n=this.altCache.get(s);if(n!==void 0)return n;const r=p.getTick(t)+p.getTick(e),o=p.getAlt(r),c=[];if(o&&o.alt)for(const h of o.alt){let l=!1;for(let f=0;f<h.length;f++){const d=h[f===0?1:0],x=h[f];i===x?(c.push(new A(d,!1)),l=!0):i+"."===x&&(d.endsWith(".")||(c.push(new A(d,!0)),l=!0))}if(!l){const f=h[0],d=h[1];d+"."===f&&(c.push(new A(".",!1,d)),c.push(new A(d,!1,f)))}}const a=c.length>0?c:null;return this.altCache.set(s,a),a}}const it=A.altCache;class j{static pattern=[new m.FixPattern("*","r1.r2","r1r1")];sb="";nextToken(t){this.sb+=t;for(const e of j.pattern)e.patternApply("",{toString:()=>this.sb,reset:i=>(this.sb=i,this)})}getMinString(){return this.sb}}class H{tokens=[];nextToken(t){this.tokens.push(t)}getMinString(){if(this.tokens.length===0)return"";const t=this.tokens.join(""),e=[],i=r=>/[a-gA-G]/.test(r),s=r=>{let o=r+1;if(o<t.length){const c=t[o];(c==="+"||c==="-"||c==="#")&&o++}for(;o<t.length&&/[0-9.]/.test(t[o]);)o++;return{token:t.slice(r,o),next:o}};let n=0;for(;n<t.length;){const r=t[n];if(r==="<"){const o=n+1;if(o<t.length&&i(t[o])&&t[o].toLowerCase()==="b"){const{token:c,next:a}=s(o);if(/^[bB][+#-]/.test(c)){e.push(r),n++;continue}if(a<t.length&&t[a]===">"){let h=!1;for(let l=o+1;l<a;l++)if(i(t[l])){h=!0;break}if(!h){const l=(c[0]==="B"?"C-":"c-")+c.slice(1).replace(/^[+#-]?/,"").replace(/^([0-9].*)$/,"$1");e.push(l),n=a+1;continue}}}}else if(r===">"){const o=n+1;if(o<t.length&&i(t[o])&&t[o].toLowerCase()==="c"){const{token:c,next:a}=s(o);if(/^[cC][+#-]/.test(c)){e.push(r),n++;continue}if(a<t.length&&t[a]==="<"){let h=!1;for(let l=o+1;l<a;l++)if(i(t[l])){h=!0;break}if(!h){const l=(c[0]==="C"?"B+":"b+")+c.slice(1).replace(/^[+#-]?/,"").replace(/^([0-9].*)$/,"$1");e.push(l),n=a+1;continue}}}}e.push(r),n++}return e.join("")}}class u{constructor(t){this.originalMML=t}static GEN1=1;static GEN2=2;static GEN3=3;static debug=!1;static optLevel=1;static mmlCache=new Map;static cacheList=[u.mmlCache];static currentContext=null;static setDebug(t){this.debug=t}static getDebug(){return this.debug}static setOptimizeLevel(t){this.optLevel=t}static clearAllCache(){this.cacheList.forEach(t=>t.clear())}static addCacheList(t){this.cacheList.includes(t)||this.cacheList.push(t)}static setContext(t){this.currentContext=t}static getContext(){return this.currentContext}static initAltPatternCache=(u.addCacheList(it),!0);disableNopt=!1;toString(){return this.cachedOptimize(u.GEN1,!1)}preciseOptimize(){return this.cachedOptimize(u.optLevel,this.disableNopt)}setDisableNopt(t){return this.disableNopt=t,this}cachedOptimize(t,e){const i=t+":"+e+":"+this.originalMML,s=u.mmlCache.get(i);if(s)return s;let n;if(t===u.GEN2){const r=this.optimizeGen2();n=this.fallbackIfChanged(r,e)}else if(t===u.GEN3){const r=this.optimizeGen3();n=this.fallbackIfChanged(r,e)}else n=this.optimize(e);return u.mmlCache.set(i,n),n}optimizeGen2(){return this.optimizeChain([new m(this.disableNopt),new F(this.disableNopt)])}optimizeGen3(){return this.optimizeChain([new U(this.disableNopt),new F(this.disableNopt),new j])}optimizeForTextEditor(){return this.optimizeChain([new m(!0)])}optimize(t){return t?this.optimizeChain([new D,new H]):this.optimizeChain([new D,new H,new K])}optimizeChain(t){let e=this.originalMML;for(const i of t){const s=new T(e);for(;s.hasNext();){let n=null;try{n=s.next(),i.nextToken(n)}catch(r){try{console.error("[MML optimize token error]",{context:u.getContext(),optimizer:i?.constructor?.name,token:n,index:s.getIndex(),mmlSnippet:e.slice(Math.max(0,s.getStart()-20),Math.min(e.length,s.getEnd()+20)),error:r})}catch{}throw r}}e=i.getMinString()}return e}fallbackIfChanged(t,e){return this.quickEquivalent(this.originalMML,t)?t:this.optimize(e)}quickEquivalent(t,e){if(t===e)return!0;const i=this.tokenCounts(t),s=this.tokenCounts(e),n=Object.keys(i),r=Object.keys(s);if(n.length!==r.length)return!1;for(const o of n)if(i[o]!==s[o])return!1;return!0}tokenCounts(t){const e={},i=new T(t);for(;i.hasNext();){const s=i.next();e[s]=(e[s]||0)+1}return e}}function st(g,t,e=0){const i=[];t.slice().sort((o,c)=>o.tickOffset-c.tickOffset).forEach((o,c)=>new O(o.tempo,o.tickOffset,c===0).appendToListElement(i));const s=new I("",i,e),n=g.slice().sort((o,c)=>o.offset-c.offset);for(const o of n)try{const c=o.velocity==null?k.INIT_VOL:o.velocity;if(!(o.tick>0)){console.warn("[buildEventList skip non-positive tick]",{ctx:u.getContext?.(),n:o});continue}const a=new k(o.note,o.tick,o.offset,c);s.addMMLNoteEvent(a)}catch(c){console.warn("[buildEventList note error]",{ctx:u.getContext?.(),n:o,err:c})}return s.getMMLNoteEventList().length===0&&n.length>0&&console.warn("[buildEventList result empty]",{ctx:u.getContext?.(),inputCount:n.length,first:n[0],last:n[n.length-1]}),s}function J(g,t,e={}){try{console.log("[noteToMML enter]",{ctx:u.getContext?.(),notes:g?.length,tempos:t?.length})}catch{}Array.isArray(g)||(g=[]),Array.isArray(t)||(t=[]);const{startOffset:i=0,initOct:s=4,percussionMotionFix:n=!1,mabiTempo:r=!0,includeTempo:o=!0,optimizeLevel:c=2,disableNopt:a=!1}=e,h=st(g,t,i),f=N.create(h,i,s,n).toMMLStringFull(o,r),d=u.optLevel;let x=f;try{u.setOptimizeLevel(c),x=new u(f).setDisableNopt(a).preciseOptimize()}catch(C){try{console.warn("[noteToMML optimize error]",{ctx:u.getContext?.(),err:C})}catch{}x=f}finally{try{u.setOptimizeLevel(d)}catch{}}let b=x,M=!1;try{const C=new I(x,[],i);if(!h.equals(C)){try{const V=f,X=x;let S=0;const ct=Math.min(V.length,X.length);for(;S<ct&&V[S]===X[S];S++);console.warn("[MML optimize fallback mismatch]",{context:u.getContext?.(),reason:"event-inequality",firstDiffPos:S,origSnippet:V.slice(Math.max(0,S-20),S+20),optSnippet:X.slice(Math.max(0,S-20),S+20)})}catch{}b=f,M=!0}}catch{b=f,M=!0}try{console.log("[noteToMML exit]",{ctx:u.getContext?.(),rawLen:f.length,finalLen:b.length,fallbackUsed:M})}catch{}return{original:f,optimized:b,fallbackUsed:M}}function Y(g){return g.map(t=>({note:t.pitch,tick:t.durationTick,offset:t.startTick,velocity:t.volume}))}function nt(g,t=[],e=!0){try{console.log("[notesToMML enter]",{ctx:u.getContext?.(),noteCount:g?.length,tempoCount:t?.length});const i=J(Y(g),t,{includeTempo:e});return console.log("[notesToMML result]",{ctx:u.getContext?.(),optimizedLen:i.optimized?.length,originalLen:i.original?.length,fallback:i.fallbackUsed}),i.optimized||i.original||""}catch(i){return console.warn("[notesToMML error]",{ctx:u.getContext?.(),err:i}),G(g,t)}}function rt(g,t=[],e=!0){try{console.log("[notesToMMLRaw enter]",{ctx:u.getContext?.(),noteCount:g?.length,tempoCount:t?.length});const i=J(Y(g),t,{includeTempo:e});return console.log("[notesToMMLRaw result]",{ctx:u.getContext?.(),optimizedLen:i.optimized?.length,originalLen:i.original?.length,fallback:i.fallbackUsed}),i.original||i.optimized||""}catch(i){return console.warn("[notesToMMLRaw error]",{ctx:u.getContext?.(),err:i}),G(g,t)}}function ot(g){const t=u.optLevel;u.setOptimizeLevel(2);const e=new u(g).preciseOptimize();return u.setOptimizeLevel(t),e}function G(g,t){try{const e=[];t.slice().sort((n,r)=>n.tickOffset-r.tickOffset).forEach((n,r)=>new O(n.tempo,n.tickOffset,r===0).appendToListElement(e));const i=new I("",e,0);return g.slice().sort((n,r)=>n.startTick-r.startTick).forEach(n=>{try{i.addMMLNoteEvent(new k(n.pitch,n.durationTick,n.startTick,n.volume??15))}catch{}}),N.create(i,0,4,!1).toMMLStringFull(!0,!0)||""}catch{return""}}const L={enabled:!1,firstError:null,recoverCount:0};self.onmessage=g=>{const{trackId:t,notes:e,tpqn:i,tempoAnchors:s}=g.data;try{try{u.setContext(`worker-track-${t}`)}catch{}typeof i=="number"&&(i===147840?Z(!0):i===480&&Z(!1));const n=(s||[]).slice().sort((c,a)=>c.tickOffset-a.tickOffset);let r="";if(Array.isArray(e))if(L.enabled)r=G(e,n);else{const c=t===0;r=nt(e,n,c)||rt(e,n,c)||""}let o="";if(r)if(L.enabled)o=r;else{const c=performance.now();try{o=ot(r)||r}catch(a){console.warn("[mmlOptimizerWorker optimize error]",a),L.enabled=!0,L.firstError=L.firstError||String(a),o=r}finally{const a=performance.now()-c;!L.enabled&&a>8&&console.log("[mmlOptimizerWorker optimize] timeMs=",a.toFixed(2))}}!L.enabled&&L.firstError&&r===o&&(L.recoverCount++,L.recoverCount>=3&&(L.firstError=null,L.recoverCount=0)),self.postMessage({trackId:t,optimizedMML:o,originalBody:r,notesLen:e.length,safeMode:L.enabled,firstError:L.firstError})}catch(n){try{L.enabled||(L.enabled=!0,L.firstError=String(n),L.recoverCount=0);let r="";try{Array.isArray(e)&&(r=G(e,s||[]))}catch{}self.postMessage({trackId:t,optimizedMML:r,originalBody:r,notesLen:Array.isArray(e)?e.length:0,error:String(n),safeMode:L.enabled,firstError:L.firstError})}catch{}}finally{try{u.setContext(null)}catch{}}}})();
