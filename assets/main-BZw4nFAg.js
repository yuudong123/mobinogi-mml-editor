import{M as ze,T as L,P as D,D as B,c as Ln,s as Sn,E as Me,B as Te,H as Qn,a as Ee,I as Re,b as De,L as Nt,e as to,t as Mt,d as eo,p as de,_ as Le,f as Je,g as no,h as oo,i as ro,j as ue,k as In,l as et,m as ao}from"./timeline-CN1gSxtj.js";import{notesToMMLRaw as He,notesToMML as io,newOptimizeBody as Cn,mmlToNotes as so}from"./converter-93tpuols.js";import{t as y,c as k,u as co,s as lo,i as uo,a as mo}from"./tempoModal-1xZMLwS0.js";let Qe=!1;function Lt(){if(Qe)return;const t=document.createElement("style");t.id="app-button-styles",t.textContent=`
  :root {
    --btn-font: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    --btn-radius: 8px;
    --btn-pad-y: 6px; --btn-pad-x: 12px;
    --btn-fg: #1f2937; --btn-bg: #ffffff; --btn-bd: #cfd3d8;
    --btn-fg-primary: #ffffff; --btn-bg-primary: #3a7afe; --btn-bd-primary: #2f65d2;
    --btn-fg-danger: #ffffff; --btn-bg-danger: #ef4444; --btn-bd-danger: #dc2626;
    --btn-fg-ghost: #374151; --btn-bg-ghost: transparent; --btn-bd-ghost: #d1d5db;
    --btn-hover: 0.97; --btn-active: 0.94;
  }
  .btn { font: 500 13px/1 var(--btn-font); padding: var(--btn-pad-y) var(--btn-pad-x); border-radius: var(--btn-radius); cursor: pointer; border:1px solid var(--btn-bd); background: var(--btn-bg); color: var(--btn-fg); transition: filter .15s ease, background .15s ease, border-color .15s ease, transform .15s ease, box-shadow .15s ease; }
  .btn:hover { filter: brightness(var(--btn-hover)); }
  .btn:active { filter: brightness(var(--btn-active)); transform: translateY(0.5px); }
  .btn:disabled { opacity: .6; cursor: not-allowed; }
  .btn--primary { color: var(--btn-fg-primary); background: var(--btn-bg-primary); border-color: var(--btn-bd-primary); }
  .btn--danger { color: var(--btn-fg-danger); background: var(--btn-bg-danger); border-color: var(--btn-bd-danger); }
  .btn--ghost { color: var(--btn-fg-ghost); background: var(--btn-bg-ghost); border-color: var(--btn-bd-ghost); }
  .btn--secondary { /* defaults already set by .btn */ }
  .btn--sm { padding: 4px 8px; font-size: 12px; }
  .btn--md { padding: 6px 12px; font-size: 13px; }
  .btn--lg { padding: 10px 16px; font-size: 15px; }
  `,document.head.appendChild(t),Qe=!0}function fo(t,e){Lt();const n=e?.variant??"secondary",r=e?.size??"md";return t.classList.add("btn",`btn--${n}`,`btn--${r}`),e?.label!=null&&(t.textContent=e.label),e?.title&&(t.title=e.title),e?.disabled!=null&&(t.disabled=e.disabled),e?.onClick&&(t.onclick=e.onClick),e?.attrs&&Object.entries(e.attrs).forEach(([a,i])=>t.setAttribute(a,i)),t}function gt(t){const e=document.createElement("button");return fo(e,t)}let tn=!1;function po(){if(tn)return;const t=`
  :root {
    --dd-radius: 6px;
    --dd-border: #cfcfcf;
    --dd-border-hover: #b5b5b5;
    --dd-bg: #fff;
    --dd-text: #111;
    --dd-muted: #6b7280;
    --dd-shadow: 0 8px 24px rgba(0,0,0,0.12), 0 2px 6px rgba(0,0,0,0.08);
    --dd-focus: 0 0 0 3px rgba(33,150,243,0.15);
  }

  .dropdown { position: relative; display: inline-flex; }
  .dropdown--full { width: 100%; }

  .dropdown__button {
    display: inline-flex; align-items: center; justify-content: space-between;
    gap: 8px; width: 100%;
    background: var(--dd-bg);
    color: var(--dd-text);
    border: 1px solid var(--dd-border);
    border-radius: var(--dd-radius);
    cursor: pointer; user-select: none;
    transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
  }
  .dropdown__button:hover { border-color: var(--dd-border-hover); }
  .dropdown__button:focus-visible { outline: none; box-shadow: var(--dd-focus); }

  .dropdown__button--sm { height: 28px; padding: 4px 8px; font-size: 12px; }
  .dropdown__button--md { height: 34px; padding: 6px 10px; font-size: 14px; }
  .dropdown__button--lg { height: 40px; padding: 8px 12px; font-size: 16px; }

  .dropdown__caret { width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 6px solid #888; }

  .dropdown__menu {
    position: absolute; left: 0; top: calc(100% + 4px);
    min-width: 100%;
    background: #fff; border: 1px solid var(--dd-border);
    border-radius: var(--dd-radius);
    box-shadow: var(--dd-shadow);
    padding: 6px; margin: 0; list-style: none;
    z-index: 1000; display: block; opacity: 0; transform: var(--dd-transform, translateY(4px));
    pointer-events: none; transition: opacity .16s ease, transform .16s ease;
  }
  .dropdown__menu[data-open="true"] { opacity: 1; transform: translateY(0); pointer-events: auto; }

  .dropdown__item {
    padding: 6px 8px; border-radius: 6px; cursor: pointer;
    white-space: nowrap; color: var(--dd-text);
  }
  .dropdown__item[aria-selected="true"] { background: #eef6ff; }
  .dropdown__item:hover { background: #f3f4f6; }
  .dropdown__item:focus { outline: none; box-shadow: var(--dd-focus); }
  `,e=document.createElement("style");e.id="dropdown-styles",e.textContent=t,document.head.appendChild(e),tn=!0}function ho(t){po();const e=t.size??"md";let n=t.value??t.items[0]?.value??"",r=t.items;const a=document.createElement("div");a.className="dropdown",a.classList.add("dropdown--full");const i=document.createElement("button");i.type="button",i.className=`dropdown__button dropdown__button--${e}`,i.setAttribute("aria-haspopup","listbox"),i.setAttribute("aria-expanded","false");const s=document.createElement("span");s.textContent=t.items.find(x=>x.value===n)?.label??"";const u=document.createElement("i");u.className="dropdown__caret",i.append(s,u);const c=document.createElement("ul");c.className="dropdown__menu",c.setAttribute("role","listbox"),c.setAttribute("tabindex","-1");const d=a;let l=!1;function f(){c.innerHTML="";for(const x of r){const v=document.createElement("li");v.className="dropdown__item",v.setAttribute("role","option"),v.setAttribute("tabindex","0"),v.setAttribute("aria-selected",String(x.value===n)),v.textContent=x.label,v.addEventListener("click",()=>M(x.value)),v.addEventListener("keydown",T=>{T.key==="Enter"||T.key===" "?(T.preventDefault(),M(x.value)):T.key==="Escape"?(T.preventDefault(),h(),i.focus()):T.key==="ArrowDown"?(T.preventDefault(),I(v)):T.key==="ArrowUp"&&(T.preventDefault(),P(v))}),c.appendChild(v)}}function p(){f(),l||(document.body.appendChild(c),l=!0,c.style.position="fixed",c.style.zIndex="1000");const x=i.getBoundingClientRect();c.style.minWidth=x.width+"px",E(),c.dataset.open="true",i.setAttribute("aria-expanded","true"),window.addEventListener("mousedown",b,{capture:!0}),window.addEventListener("scroll",w,!0),window.addEventListener("resize",w)}function h(){delete c.dataset.open,i.setAttribute("aria-expanded","false"),l&&(d.appendChild(c),l=!1,c.style.position="",c.style.left="",c.style.top="",c.style.minWidth="",c.style.zIndex=""),window.removeEventListener("mousedown",b,{capture:!0}),window.removeEventListener("scroll",w,!0),window.removeEventListener("resize",w)}function g(){c.dataset.open==="true"?h():p()}function b(x){const v=x.target;a.contains(v)||c.contains(v)||h()}function w(){c.dataset.open==="true"&&E()}function E(){const x=i.getBoundingClientRect(),v=c.getBoundingClientRect(),T=window.innerHeight,S=window.innerWidth,N=8,G=4,ct=Math.max(v.width,x.width);let oe=Math.min(Math.max(x.left,N),Math.max(N,S-ct-N));const ge=T-x.bottom-N,je=x.top-N;let Ze=!1,re=Math.min(360,Math.max(ge-G,120));v.height>ge&&je>ge&&(Ze=!0,re=Math.min(360,Math.max(je-G,120)));let be;Ze?(be=Math.max(N,x.top-G-Math.min(v.height,re)),c.dataset.placement="top",c.style.setProperty("--dd-transform","translateY(-4px)")):(be=Math.min(T-N-Math.min(v.height,re),x.bottom+G),c.dataset.placement="bottom",c.style.setProperty("--dd-transform","translateY(4px)")),c.style.top=`${Math.round(be)}px`,c.style.left=`${Math.round(oe)}px`,c.style.maxHeight=`${re}px`,c.style.overflowY="auto"}function M(x){if(x===n){h(),i.focus();return}n=x,s.textContent=r.find(v=>v.value===n)?.label??"",h(),i.focus(),t.onChange(n)}function I(x){const v=Array.from(c.querySelectorAll(".dropdown__item")),T=v.indexOf(x);v[Math.min(v.length-1,T+1)]?.focus()}function P(x){const v=Array.from(c.querySelectorAll(".dropdown__item")),T=v.indexOf(x);v[Math.max(0,T-1)]?.focus()}i.addEventListener("click",()=>g()),i.addEventListener("keydown",x=>{if(x.key==="ArrowDown"||x.key==="Enter"||x.key===" ")x.preventDefault(),p();else if(x.key==="ArrowUp"){x.preventDefault(),p();const v=c.querySelectorAll(".dropdown__item");v[v.length-1]?.focus()}});function W(x){r=x;const v=r.find(T=>T.value===n);v?s.textContent=v.label:s.textContent="",c.dataset.open==="true"&&f()}return a.append(i,c),{el:a,get value(){return n},set value(x){M(x)},updateItems:W}}let en=!1;function Bn(){if(en)return;const t=`
  :root {
    --fc-radius: 6px;
    --fc-border: #cfcfcf;
    --fc-border-hover: #b5b5b5;
    --fc-border-focus: #2196f3;
    --fc-bg: #ffffff;
    --fc-bg-disabled: #f7f7f7;
    --fc-text: #111;
    --fc-placeholder: #9aa0a6;
    --fc-shadow-focus: 0 0 0 3px rgba(33,150,243,0.15);
  }

  .input, .select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    box-sizing: border-box;
    font: inherit;
    color: var(--fc-text);
    background: var(--fc-bg);
    border: 1px solid var(--fc-border);
    border-radius: var(--fc-radius);
    outline: none;
    transition: border-color .2s ease, box-shadow .2s ease, background .2s ease, transform .15s ease;
  }

  .input::placeholder {
    color: var(--fc-placeholder);
  }

  .input:hover, .select:hover {
    border-color: var(--fc-border-hover);
  }

  .input:focus, .select:focus {
    border-color: var(--fc-border-focus);
    box-shadow: var(--fc-shadow-focus);
  }

  /* Sizes */
  .fc--sm { height: 28px; padding: 4px 8px; font-size: 12px; }
  .fc--md { height: 34px; padding: 6px 10px; font-size: 14px; }
  .fc--lg { height: 40px; padding: 8px 12px; font-size: 16px; }

  /* Full width helper */
  .fc--full { width: 100%; }

  /* Number inputs: right align helper */
  .fc--num-right { text-align: right; }

  /* Disabled */
  .input:disabled, .select:disabled { background: var(--fc-bg-disabled); color: #888; cursor: not-allowed; }

  /* Select arrow */
  .select {
    background-image: url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5' stroke='%23888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 16px 16px;
    padding-right: 28px; /* space for arrow */
  }

  /* Remove default arrow on some browsers */
  .select::-ms-expand { display: none; }
  `,e=document.createElement("style");e.id="form-control-styles",e.textContent=t,document.head.appendChild(e),en=!0}function go(t,e){Bn(),t.classList.add("input");const n=e?.size;t.classList.add(bo(n)),t.classList.add("fc--full"),e?.rightAlign&&t.classList.add("fc--num-right")}function bo(t){return t==="sm"?"fc--sm":t==="lg"?"fc--lg":"fc--md"}function yo(t,e){const n=document.createElement("div");n.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
   `;const r=document.createElement("div");r.style.cssText=`
      background: #fff;
      padding: 24px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
   `;const a=document.createElement("div");a.style.cssText=`
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #eee;
      padding: 8px;
      margin-bottom: 16px;
   `;const i=document.createElement("div");i.style.cssText=`
            display: flex;
            align-items: center;
            gap: 8px;
        `;const s=document.createElement("label");s.setAttribute("for","convertFilenameInput"),s.textContent=y[k].convertFilenameLabel||"파일명",s.setAttribute("data-i18n","convertFilenameLabel"),s.style.cssText=`
            min-width: 72px;
            color: #666;
            font-size: 12px;
        `;const u=document.createElement("input");u.type="text",u.id="convertFilenameInput",u.placeholder=y[k].convertFilenamePlaceholder||"예: my-song.txt",u.setAttribute("data-i18n-placeholder","convertFilenamePlaceholder"),u.style.cssText=`
            flex: 1 1 auto;
            padding: 6px 8px;
            border: 1px solid #cfcfcf;
            border-radius: 6px;
            font-size: 12px;
        `;const c=new Date().toISOString().replace(/[:.]/g,"-");u.value=`mml-${c}.txt`,i.append(s,u);const d=document.createElement("textarea");d.style.cssText=`
            width: 100%;
            min-height: 200px;
            box-sizing: border-box;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            word-break: break-all;
            overflow-y: auto;
        `,d.readOnly=!0;const l=document.createElement("div");l.style.cssText=`
      display: flex;
      justify-content: flex-end;
      gap: 8px;
   `,Lt();const f=gt({label:y[k].convertCopy,variant:"primary",attrs:{"data-i18n":"convertCopy"}}),p=gt({label:y[k].convertSaveTxt,variant:"secondary",attrs:{"data-i18n":"convertSaveTxt"}}),h=gt({label:y[k].modalClose,variant:"secondary",attrs:{"data-i18n":"modalClose"}});l.append(f,p,h),r.append(a,i,d,l),n.appendChild(r),document.body.appendChild(n);function g(){window.removeEventListener("keydown",b,!0),n.parentNode&&document.body.removeChild(n)}function b(x){x.key==="Escape"&&g()}a.innerHTML="";let w=[];const E=new Map,M=x=>{const v=x.optimizedMML;if(v&&v.length>0)return v;const T=io(x.notes??[])||"";return T.length>0?T:x.mmlString||""},I=()=>{let v=d.value||"";v.startsWith("MML@")&&(v=v.slice(4)),v.endsWith(";")&&(v=v.slice(0,-1));const T=v.length>0?v.split(",").map(S=>S.trim()):[];for(const S of t.tracks){const N=E.get(S.id);if(!N)continue;const G=w.indexOf(S.id),ct=G>=0&&G<T.length?T[G].length:0;N.textContent=`${S.name} (${ct}${y[k].charUnit})`}};[...t.tracks].slice().sort((x,v)=>x.order-v.order).forEach(x=>{const v=document.createElement("div");v.style.cssText=`
            display: flex;
            align-items: center;
            margin-bottom: 8px;
         `;const T=document.createElement("input");T.type="checkbox",T.id=`track-${x.id}`,T.value=String(x.id),T.checked=x.notes.length>0,T.disabled=x.notes.length===0,T.style.margin="0 4px 0 0",T.style.cursor="pointer";const S=document.createElement("label");S.htmlFor=`track-${x.id}`,E.set(x.id,S),S.textContent=`${x.name}`,S.style.cssText=`
                margin-left: 8px;
                ${x.notes.length===0?"color: #aaa;":""}
            `,T.addEventListener("change",()=>{W(),I()}),v.append(T,S),a.appendChild(v)});function P(x,v){if(e?.prebuiltDefault)return e.prebuiltDefault;const T=x.slice().sort((G,ct)=>G.order-ct.order),S=[];for(const G of T){const ct=M(G);ct&&ct.length>0&&S.push(ct);const oe=He(G.notes??[]);oe&&oe.length>0}const N=S.join(",");return`MML@t${Math.min(v,ze)}${N};`}function W(){const x=[];a.querySelectorAll('input[type="checkbox"]').forEach(S=>{S.checked&&x.push(parseInt(S.value))});const v=t.tracks.filter(S=>x.includes(S.id));w=v.slice().sort((S,N)=>S.order-N.order).map(S=>S.id);const T=P(v,t.bpm);d.value=T}W(),I(),h.onclick=g,n.onclick=x=>{x.target===n&&g()},f.onclick=()=>{navigator.clipboard.writeText(d.value),f.textContent=y[k].copied,setTimeout(()=>{f.textContent=y[k].convertCopy},2e3)},p.onclick=()=>{try{const x=new Blob([d.value],{type:"text/plain;charset=utf-8"}),v=document.createElement("a");v.href=URL.createObjectURL(x);const T=(u.value||"").trim(),S=`mml-${new Date().toISOString().replace(/[:.]/g,"-")}.txt`;let N=T.length>0?T:S;N=N.replace(/[\\\/:*?"<>|]/g,"_"),/\.txt$/i.test(N)||(N+=".txt"),v.download=N,document.body.appendChild(v),v.click(),setTimeout(()=>{URL.revokeObjectURL(v.href),v.parentNode&&v.parentNode.removeChild(v)},0)}catch{}},window.addEventListener("keydown",b,!0)}function nn(){const t=document.createElement("div");t.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `;const e=document.createElement("div");e.id="guideModalContent",e.style.cssText=`
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        max-width: 600px;
        width: 90%;
        max-height: 80%;
        overflow-y: auto;
        position: relative;
    `,Lt();const n=gt({label:"✕",variant:"ghost",size:"sm",title:y[k].modalClose,attrs:{"data-i18n-title":"modalClose"}});n.style.position="absolute",n.style.top="10px",n.style.right="10px";const r=i=>{i.key==="Escape"&&a()};function a(){window.removeEventListener("keydown",r,!0),t.parentNode&&document.body.removeChild(t)}n.onclick=a,co(e),e.appendChild(n),t.appendChild(e),document.body.appendChild(t),window.addEventListener("keydown",r,!0)}let ut=null,J=null,qt=null,Ut=null,Dt=null;function ko(t,e,n){if(ut||vo(),!ut||!J||!qt||!Ut)return;J.value=(n??t.mmlString)||"",ut.style.display="flex",J.focus();const r=i=>{i.stopPropagation()};J.addEventListener("keydown",r),J.addEventListener("keyup",r);function a(){ut.style.display="none",J.removeEventListener("keydown",r),J.removeEventListener("keyup",r),qt.onclick=null,Ut.onclick=null,Dt&&(window.removeEventListener("keydown",Dt,!0),Dt=null)}qt.onclick=()=>{e(J.value),a()},Ut.onclick=a,Dt=i=>{i.key==="Escape"&&(i.stopPropagation(),a())},window.addEventListener("keydown",Dt,!0)}function vo(){ut=document.createElement("div"),ut.id="mmlEditModal",ut.style.cssText=`
    position: fixed; 
    left: 0; top: 0; 
    width: 100vw; 
    height: 100vh;
    background: rgba(0,0,0,0.25); 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    z-index: 200;
    display: none;
  `;const t=document.createElement("div");t.style.cssText=`
            background: #fff;
            padding: 24px;
            border-radius: 8px;
            min-width: 400px;
            box-shadow: 0 2px 16px #0002;
            display: flex;
            flex-direction: column;
            gap: 12px;
        `,J=document.createElement("textarea"),J.style.cssText=`
            width: 100%;
            min-height: 120px;
            font-family: monospace;
            font-size: 15px;
            word-break: break-all;
            overflow-y: auto;
        `,J.wrap="off",Lt(),qt=gt({label:y[k].ok,variant:"primary",attrs:{"data-i18n":"ok"}}),Ut=gt({label:y[k].cancel,variant:"secondary",attrs:{"data-i18n":"cancel"}});const e=document.createElement("div");e.style.cssText=`
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        `,e.append(Ut,qt),t.append(J,e),ut.appendChild(t),document.body.appendChild(ut)}function xo(){return{scrollX:0,scrollY:0,keyHeight:16,activeTrackId:1,selectedLength:16,hover:{noteId:null,edge:null},drag:null,ghost:null,ghostGroup:null,selected:new Set,marquee:{active:!1,x0:0,y0:0,x1:0,y1:0,mode:"replace"},clipboard:null,volumeLabels:new Set}}function wo(t,e,n,r,a,i,s){t.save();const u=window.devicePixelRatio||1;t.setTransform(u,0,0,u,0,0);const c=t.canvas.clientWidth||t.canvas.width/u,d=t.canvas.clientHeight||t.canvas.height/u;t.clearRect(0,0,c,d),Eo(t,e,n,r,a),So(t,n,e,r),Io(t,e,n,r,a),Co(t,e,n,r,a),Bo(t,n,r),t.restore()}function Pn(t,e,n,r,a){const i=window.devicePixelRatio||1;t.setTransform(i,0,0,i,0,0);const s=e.clientWidth||e.width/i,u=e.clientHeight||e.height/i;t.clearRect(0,0,s,u),t.fillStyle="#ffffff",t.fillRect(0,0,s,u);const c=84*r.keyHeight;Mo(t,0,s,r),To(t,n,0,s,c,a)}function Vt(t,e,n,r,a,i){const s=Math.max(0,Math.min(i,Math.floor(Math.min(r,a)/2))),u=Math.floor(e),c=Math.floor(n),d=u+Math.max(0,r),l=c+Math.max(0,a);if(t.beginPath(),s<=0){t.rect(u,c,r,a);return}t.moveTo(u+s,c),t.lineTo(d-s,c),t.arcTo(d,c,d,c+s,s),t.lineTo(d,l-s),t.arcTo(d,l,d-s,l,s),t.lineTo(u+s,l),t.arcTo(u,l,u,l-s,s),t.lineTo(u,c+s),t.arcTo(u,c,u+s,c,s)}function Mo(t,e,n,r){const a=r.keyHeight,i=84*a,s=Math.ceil(i/a);for(let u=0;u<s;u++){const c=u*a,l=((95-u)%12+12)%12,f=l===1||l===3||l===6||l===8||l===10;t.fillStyle=f?"#d6d6d6":"#ffffff",t.fillRect(e,c,Math.max(0,n),a);const p=l===11;t.strokeStyle=p?"#000000":"rgb(153,153,153)",t.beginPath(),t.moveTo(e,c+.5),t.lineTo(e+Math.max(0,n),c+.5),t.stroke()}}function To(t,e,n,r,a,i){const s=D[e.zoomLevel-1],u=i&&i>=1?i:e.timeSig.beatsPerBar,c=Math.max(0,Math.floor(n/s)-2),d=Math.floor((n+r)/s)+2;for(let f=c;f<=d;f++){const p=Math.floor(f*s),h=f%u===0;t.strokeStyle=h?"#000":"rgb(128,128,128)",t.beginPath(),t.moveTo(p,0),t.lineTo(p,a),t.stroke()}const l=e.zoomLevel;l>=4&&ye(t,n,r,a,s,2,"rgb(191,191,191)"),l>=6&&ye(t,n,r,a,s,4,"rgb(191,191,191)"),l>=8&&ye(t,n,r,a,s,8,"rgb(191,191,191)")}function ye(t,e,n,r,a,i,s){const u=Math.max(0,Math.floor(e/a)-2),c=Math.floor((e+n)/a)+2;t.strokeStyle=s;for(let d=u;d<=c;d++)for(let l=1;l<i;l+=2){const f=Math.floor((d+l/i)*a);t.beginPath(),t.moveTo(f,0),t.lineTo(f,r),t.stroke()}}function Eo(t,e,n,r,a){const i=D[e.zoomLevel-1],s=n.activeTrackId,u=[...e.tracks].sort((c,d)=>c.id===s?1:d.id===s?-1:0);for(const c of u){const d=c.id===s?1:.5;t.globalAlpha=d;for(const l of c.notes){const f=Math.round(l.startTick/L*i),p=Math.max(1,Math.round(l.durationTick/L*i));if(f+p<r||f>r+a)continue;const h=f-Math.floor(r);Lo(t,h,l,c.color,i,n.keyHeight,n.hover,c.id===s,n.selected.has(l.id))}}t.globalAlpha=1}function Lo(t,e,n,r,a,i,s,u,c){const d=Math.max(1,Math.round(n.durationTick/L*a)),l=(95-n.pitch)*i+1,f=i-1,p=Math.min(6,Math.floor(f/2));if(t.fillStyle=r,Vt(t,e,l,d,f,p),t.fill(),t.strokeStyle="rgba(0,0,0,0.3)",t.lineWidth=1,Vt(t,e,l,d-1,f-1,Math.max(0,p-1)),t.stroke(),c&&(t.strokeStyle="#3a7afe",t.lineWidth=2,Vt(t,e,l,d-1,f-1,Math.max(0,p-1)),t.stroke(),t.lineWidth=1),u&&s.noteId===n.id){const h=Math.min(8,Math.floor(d/3));t.fillStyle="rgba(0,0,0,0.15)",t.fillRect(e,l,h,f),t.fillRect(e+d-h,l,h,f)}}function So(t,e,n,r){const a=D[n.zoomLevel-1],i=s=>{const u=Math.round(s.startTick/L*a)-Math.floor(r),c=Math.max(1,Math.round(s.durationTick/L*a)),d=(95-s.pitch)*e.keyHeight+1,l=e.keyHeight-1;t.globalAlpha=.7,t.fillStyle=s.color;const f=Math.min(6,Math.floor(l/2));Vt(t,u,d,c,l,f),t.fill(),t.globalAlpha=1};if(e.ghost&&i(e.ghost),e.ghostGroup)for(const s of e.ghostGroup)i(s)}function Io(t,e,n,r,a){const i=D[e.zoomLevel-1],s=n.keyHeight;t.strokeStyle="#3a7afe",t.lineWidth=2;for(const u of e.tracks)for(const c of u.notes){if(!n.selected.has(c.id))continue;const d=Math.round(c.startTick/L*i)-Math.floor(r),l=Math.max(1,Math.round(c.durationTick/L*i)),f=d+Math.floor(r);if(f+l<r||f>r+a)continue;const p=(95-c.pitch)*s+1,h=s-1,g=Math.min(6,Math.floor(h/2));Vt(t,d,p,l-1,h-1,Math.max(0,g-1)),t.stroke()}t.lineWidth=1}function Co(t,e,n,r,a){if(!n.volumeLabels||n.volumeLabels.size===0)return;const i=D[e.zoomLevel-1],s=n.keyHeight;t.font="10px sans-serif",t.textAlign="left",t.textBaseline="bottom";for(const u of e.tracks)for(const c of u.notes){if(!n.volumeLabels.has(c.id))continue;const d=Math.round(c.startTick/L*i),l=Math.max(1,Math.round(c.durationTick/L*i));if(d+l<r||d>r+a)continue;const f=d-Math.floor(r),p=(95-c.pitch)*s+1,h="V"+String(c.volume??B);t.fillStyle="rgba(255,255,255,0.9)",t.fillText(h,f+1,p-1),t.fillStyle="rgba(0,0,0,0.85)",t.fillText(h,f,p-2)}}function Bo(t,e,n){if(!e.marquee.active)return;const r=Math.min(e.marquee.x0,e.marquee.x1)-Math.floor(n),a=Math.min(e.marquee.y0,e.marquee.y1),i=Math.abs(e.marquee.x1-e.marquee.x0),s=Math.abs(e.marquee.y1-e.marquee.y0);t.fillStyle="rgba(58,122,254,0.15)",t.fillRect(r,a,i,s),t.strokeStyle="rgba(58,122,254,0.8)",t.setLineDash([4,3]),t.strokeRect(r+.5,a+.5,i-1,s-1),t.setLineDash([])}function Se(t,e,n,r,a){for(let i=n.length-1;i>=0;i--){const s=n[i],u=Math.round(s.startTick/L*r),c=Math.max(1,Math.round(s.durationTick/L*r)),d=(95-s.pitch)*a+1,l=a-1;if(t>=u&&t<=u+c&&e>=d&&e<=d+l){const f=Math.min(8,Math.floor(c/3)),p=t<=u+f?"left":t>=u+c-f?"right":"center";return{note:s,edge:p}}}}function Po(t,e,n,r,a,i,s){const u=Math.min(t,n),c=Math.max(t,n),d=Math.min(e,r),l=Math.max(e,r),f=[];for(const p of a){const h=Math.round(p.startTick/L*i),g=Math.max(1,Math.round(p.durationTick/L*i)),b=(95-p.pitch)*s+1,w=s-1,E=h+g,M=b+w;E>=u&&h<=c&&M>=d&&b<=l&&f.push(p)}return f}function Ao(t,e,n){t.clearRect(0,0,e.width,e.height);const r=window.devicePixelRatio||1,a=12*n;for(let i=0;i<7;i++){const s=(6-i)*a,u=i%2===1;t.fillStyle=u?"#e6e6e6":"#ffffff",t.fillRect(0,s,e.width/r,a),t.fillStyle="#222",t.font=`${Math.max(10,Math.round(12))}px system-ui, sans-serif`,t.textBaseline="middle",t.textAlign="center";const c="o"+(i+1),d=s+a/2;t.fillText(c,Math.floor(e.width/r/2),Math.floor(d))}}function No(t,e,n,r,a,i){const s=e.width,u=e.height,c=window.devicePixelRatio||1;t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,s,u),c!==1&&t.setTransform(c,0,0,c,0,0);const d=s/c,l=u/c;t.fillStyle="#ffffff",t.fillRect(0,0,d,l);const f=Math.floor(n/r),p=Math.ceil((n+d)/r);for(let h=f;h<=p;h++){const g=Math.round(h*r-n)+.5;if(h%a===0){t.strokeStyle="#000000",t.beginPath(),t.moveTo(g,0),t.lineTo(g,l),t.stroke();const w=Math.floor(h/a)+1;t.fillStyle="#222",t.font="12px system-ui, sans-serif",t.textAlign="left",t.textBaseline="top",t.fillText(String(w),g+4,2)}else{t.strokeStyle="rgb(128,128,128)";const w=Math.floor(l*.5);t.beginPath(),t.moveTo(g,w),t.lineTo(g,l),t.stroke()}}}function on(t,e,n){const r=window.devicePixelRatio||1,a=e.clientHeight||e.height/r;t.save(),t.setTransform(r,0,0,r,0,0),t.strokeStyle="rgba(255,0,0,0.9)",t.lineWidth=2,t.beginPath(),t.moveTo(Math.floor(n)+.5,0),t.lineTo(Math.floor(n)+.5,a),t.stroke(),t.restore()}function _o(t,e,n,r){const a=window.devicePixelRatio||1,i=e.clientHeight||e.height/a;t.save(),t.setTransform(a,0,0,a,0,0),t.fillStyle="rgba(255,0,0,0.12)",t.fillRect(Math.floor(n),0,Math.ceil(r),i),t.restore()}function zo(t,e){const n=document.createElement("div");n.style.cssText=`
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    `;const r=document.createElement("div");r.style.cssText=`
        background: #fff;
        width: min(640px, 92vw);
        max-height: 80vh;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        padding: 18px 18px 14px;
        position: relative;
        overflow: auto;
    `;const a=document.createElement("h2");a.textContent=y[k].whatsNewTitle||"What's new",a.style.margin="0 0 8px 0",a.style.fontSize="18px",a.setAttribute("data-i18n","whatsNewTitle");const i=document.createElement("div"),s=document.createElement("h3");s.textContent=y[k].whatsNew_20250827_heading||"Load behavior changed",s.setAttribute("data-i18n","whatsNew_20250827_heading"),s.style.margin="8px 0 6px 0";const u=document.createElement("ul");u.style.margin="6px 0 0 18px",u.style.padding="0";const c=document.createElement("li");c.textContent=y[k].whatsNew_20250827_p1||"Removed auto-load on page start.",c.setAttribute("data-i18n","whatsNew_20250827_p1");const d=document.createElement("li");d.textContent=y[k].whatsNew_20250827_p2||"Use the 'Load' button in the toolbar to restore saved work.",d.setAttribute("data-i18n","whatsNew_20250827_p2"),u.append(c,d),i.append(s,u),Lt();const l=gt({label:y[k].ok||"OK",size:"sm",variant:"primary"});l.setAttribute("data-i18n","ok"),l.style.marginTop="12px",l.style.alignSelf="flex-end";const f=()=>{n.remove();try{localStorage.setItem("mml_editor_whatsnew_shown_"+t,"1")}catch{}};l.addEventListener("click",f);const p=h=>{h.key==="Escape"&&f()};window.addEventListener("keydown",p,{once:!0}),n.addEventListener("click",h=>{h.target===n&&f()}),r.append(a,i,l),n.appendChild(r),document.body.appendChild(n)}const Pt=document.getElementById("footerMmlEditBtn"),ke=document.getElementById("footerMMLText"),vt=document.getElementById("footerLabel"),ae=document.getElementById("btnPasteMML"),An="mml_editor_project";let m=Ln();const F=new Qn,o=xo(),We=new Worker(new URL(""+new URL("mmlOptimizerWorker-Dw_ZSwXZ.js",import.meta.url).href,import.meta.url),{type:"module"}),ve=new Map,Ro=300;let xe=null;const $t=document.getElementById("progress");let me="time";const R=document.getElementById("roll"),U=document.getElementById("rollBg"),Q=document.getElementById("octaveCanvas");let C=null,q=null,Ht=null,Wt=null,xt=null;const $=document.getElementById("timeRuler"),rt=R.getContext("2d"),fe=U?U.getContext("2d"):null,Nn=Q.getContext("2d"),Ie=$.getContext("2d"),rn=document.getElementById("tracks"),Kt=document.getElementById("lenBar"),tt=document.getElementById("dispSigN");let Tt=4;const an="mml_editor_display_timesig_n",pt=document.getElementById("tempoDisplay"),_=document.getElementById("rollViewport"),_t=document.getElementById("rulerContainer"),Ot=document.getElementById("customScrollbar"),Ft=document.getElementById("customScrollbarThumb"),Ce=document.getElementById("btnPlay"),Be=document.getElementById("btnPause"),Pe=document.getElementById("btnStop"),dt=document.getElementById("btnPlayheadMode"),ie=document.getElementById("btnConvert"),Gt=document.getElementById("btnGuide"),lt=document.getElementById("btnLoad"),ft=document.getElementById("btnToggleTouch"),sn=document.getElementById("btnGoToMobile"),se=document.getElementById("langKo"),ce=document.getElementById("langJa"),le=document.getElementById("langEn"),Do=document.getElementById("btnPushBeat"),Ho=document.getElementById("btnPushBar"),Wo=document.getElementById("btnCutBeat"),Oo=document.getElementById("btnCutBar"),Z=document.getElementById("btnModeSelect"),cn=document.getElementById("btnClearSelection"),ln=document.getElementById("btnCopyNotes"),dn=document.getElementById("btnCutNotes"),un=document.getElementById("btnPasteNotes"),mn=document.getElementById("btnDeleteNotes"),St=document.getElementById("btnUndo"),It=document.getElementById("btnRedo"),fn=document.getElementById("btnVolumeDown"),pn=document.getElementById("btnVolumeUp"),hn=document.getElementById("btnZoomOut"),gn=document.getElementById("btnZoomIn"),bn=document.getElementById("btnSelectAll"),at=document.getElementById("keyHeightRange"),At=document.getElementById("keyHeightLabel"),it="rgba(255,215,0,0.8)";let z=!1,Y=0,Ae=0,Et=!1,Xo=0,Yt=0,jt=0,Oe=!1;const st={pitch:null,sampler:null};let mt=-1,ht="area",Xt=!1;const _n="mml_editor_key_height",Ct=document.getElementById("rulerOverlayLeft"),Bt=document.getElementById("rulerOverlayRight"),O=document.createElement("button");function wt(){const t=document.activeElement;if(!t)return;const e=t.tagName.toLowerCase();if((e==="input"||e==="select"||e==="textarea"||e==="button"||t.isContentEditable)&&!t.closest("#rollViewport, #roll, #rollBg, #timeRuler, #rulerContainer"))try{t.blur()}catch{}}function zn(t){const e=t.target;return e?!!e.closest("#rollViewport, #roll, #rollBg, #timeRuler, #rulerContainer, .ruler-overlay"):!1}function yn(t){const e={bpm:120,timeSig:{beatsPerBar:4},zoomLevel:1,tracks:[],maxEndTick:0,tpqn:t?.tpqn??L,extendedUnitsEnabled:t?.extendedUnitsEnabled??et},n=Number(t?.bpm);e.bpm=Number.isFinite(n)&&n>0?n:120;const r=Number(t?.timeSig?.beatsPerBar);e.timeSig={beatsPerBar:Number.isFinite(r)&&r>=1?r:4};const a=Number(t?.zoomLevel);e.zoomLevel=Number.isFinite(a)&&a>=1&&a<=9?a:1;const i=Array.isArray(t?.tracks)?t.tracks:[],s=Math.max(1,Math.min(6,i.length||6));for(let c=0;c<s;c++){const d=i[c]??{},f=(Array.isArray(d?.notes)?d.notes:[]).map(W=>{const x=typeof W?.id=="string"&&W.id?W.id:crypto.randomUUID(),v=Math.max(0,Math.floor(Number(W?.startTick)||0)),T=Math.max(1,Math.floor(Number(W?.durationTick)||1)),S=Math.max(0,Math.floor(Number(W?.pitch)||0)),N=Math.max(0,Math.min(15,Math.floor(Number(W?.volume)||B)));return{id:x,startTick:v,durationTick:T,pitch:S,volume:N}}),p=typeof d?.instrument=="string"&&Re.includes(d.instrument)?d.instrument:De,h=Number(d?.id)||c+1,g=Number.isFinite(Number(d?.order))?Number(d.order):c,b=typeof d?.name=="string"&&d.name?d.name:`Track ${c+1}`,w=typeof d?.color=="string"&&d.color?d.color:Ee[c%Ee.length],E=!!d?.mute,M=!!d?.solo,I=typeof d?.mmlString=="string"?d.mmlString:"",P=typeof d?.optimizedMML=="string"?d.optimizedMML:"";e.tracks.push({id:h,order:g,name:b,color:w,instrument:p,mmlString:I,optimizedMML:P,mute:E,solo:M,notes:f})}e.tracks.sort((c,d)=>c.order-d.order),e.tracks.forEach((c,d)=>{c.order=d});let u=0;for(const c of e.tracks)for(const d of c.notes)u=Math.max(u,d.startTick+d.durationTick);return e.maxEndTick=u,e}function Rt(){xe==null&&(xe=requestAnimationFrame(()=>{xe=null,H()}))}function X(t,e,n){t.setAttribute("data-i18n-title",e),t.title=n||y[k][e]||""}function nt(t,e,n){t.classList.add("btn",`btn--${e}`,`btn--${n}`)}function bt(t){return Math.max(0,Math.min(15,t))}function Zt(t){return Math.max(12,Math.min(95,t))}function pe(t){return t.sort((e,n)=>e.startTick-n.startTick||e.pitch-n.pitch)}function Rn(t){return t.sort((e,n)=>e.startTick-n.startTick||e.id.localeCompare(n.id))}function Dn(t,e){const n=e.volume??B;if(!o.volumeLabels)return;const r=Rn(t.notes.slice()),a=r.findIndex(u=>u.id===e.id),i=a>0?r[a-1].volume??B:B,s=r.slice(0,a).some((u,c,d)=>{const l=o.volumeLabels.has(u.id),f=c>0?d[c-1].volume??B:B,p=(u.volume??B)!==f;return l||p});n===B?s?o.volumeLabels.add(e.id):o.volumeLabels.delete(e.id):n!==i?o.volumeLabels.add(e.id):o.volumeLabels.delete(e.id)}function Qt(t){return Rn(t.notes.slice())}function Hn(t,e,n){if(e<0||e>=t.length)return!1;const r=t[e],a=e>0?t[e-1].volume??B:B,i=r.volume??B;return(n?.has(r.id)??!1)||i!==a}function Wn(t,e,n){const r=Qt(t),a=r.findIndex(s=>s.id===e.id);if(a<0)return;let i=r.length;for(let s=a+1;s<r.length;s++)if(Hn(r,s,o.volumeLabels)){i=s;break}for(let s=a;s<i;s++)r[s].volume=bt(n)}function qo(t,e,n){const r=Qt(t),a=new Map(r.map(u=>[u.id,u.volume??B])),i=r.map((u,c)=>({n:u,i:c})).filter(u=>e.has(u.n.id)).map(u=>u.i).sort((u,c)=>u-c);let s=0;for(;s<i.length;){const u=i[s];let c=s+1;for(;c<i.length&&i[c]===i[c-1]+1;)c++;const d=u,l=i[c-1],f=d>0?a.get(r[d-1].id)??B:B;for(let h=d;h<=l;h++)r[h].volume=bt(n);let p=l+1;for(;p<r.length&&e.has(r[p].id);)p++;p<r.length&&(r[p].volume=f),s=c}}function Xe(t){if(!o.volumeLabels)return;const e=Qt(t),n=new Set(e.map(a=>a.id));for(const a of Array.from(o.volumeLabels))n.has(a)&&o.volumeLabels.delete(a);let r=B;for(const a of e){const i=a.volume??B;i!==r&&o.volumeLabels.add(a.id),r=i}}function Uo(){if(C)return;C=document.createElement("div"),C.style.position="fixed",C.style.zIndex="10000",C.style.background="#fff",C.style.border="1px solid #ccc",C.style.boxShadow="0 4px 12px rgba(0,0,0,0.15)",C.style.borderRadius="8px",C.style.padding="10px 12px",C.style.minWidth="220px",C.style.display="none",C.addEventListener("wheel",i=>i.stopPropagation(),{passive:!1});const t=document.createElement("div");t.style.marginBottom="8px",t.textContent=(y[k].volLabel||"볼륨")+" (0-15)",q=document.createElement("input"),q.type="range",q.min="0",q.max="15",q.step="1",q.value=String(B),q.style.width="100%";const e=document.createElement("div");e.style.fontSize="12px",e.style.color="#555",e.style.marginTop="6px";const n=()=>{e.textContent="V"+(q?.value??String(B))};q.addEventListener("input",n),n();const r=document.createElement("div");r.style.display="flex",r.style.gap="8px",r.style.marginTop="10px",Ht=document.createElement("button"),Ht.className="btn btn--primary btn--sm",Ht.textContent=y[k].volApplyRange||"변경",Wt=document.createElement("button"),Wt.className="btn btn--secondary btn--sm",Wt.textContent=y[k].volApplySelected||"선택한 노트만 변경",r.append(Ht,Wt),C.append(t,q,e,r),document.body.appendChild(C);const a=()=>{C&&(C.style.display="none"),xt=null};document.addEventListener("keydown",i=>{C&&C.style.display!=="none"&&i.key==="Escape"&&a()}),document.addEventListener("mousedown",i=>{!C||C.style.display==="none"||C.contains(i.target)||a()}),Ht.addEventListener("click",()=>{if(!xt||!q)return;const i=m.tracks.find(c=>c.id===o.activeTrackId);if(!i)return;const s=i.notes.find(c=>c.id===xt);if(!s)return;j();const u=bt(parseInt(q.value,10));Wn(i,s,u),ot({track:i,recomputeLabels:!0}),C.style.display="none",xt=null}),Wt.addEventListener("click",()=>{if(!q)return;const i=m.tracks.find(u=>u.id===o.activeTrackId);if(!i)return;j();const s=bt(parseInt(q.value,10));qo(i,new Set(o.selected),s),ot({track:i,recomputeLabels:!0}),C.style.display="none",xt=null})}function qe(){C&&C.style.display!=="none"&&(C.style.display="none",xt=null)}function Vo(t,e,n){if(Uo(),!C||!q)return;xt=t.id;const r=t.volume??B;q.value=String(r);const a=C.querySelector("div:nth-child(3)");a&&(a.textContent="V"+r),C.style.display="block";const i=C.getBoundingClientRect(),s=window.innerWidth,u=window.innerHeight;let c=e,d=n;c+i.width>s&&(c=Math.max(0,s-i.width-8)),d+i.height>u&&(d=Math.max(0,u-i.height-8)),C.style.left=`${c}px`,C.style.top=`${d}px`}function On(t){const e=Math.floor(Y);if(t!==0){j();for(const n of m.tracks){for(const r of n.notes)(r.startTick>=e||r.startTick+r.durationTick>e)&&(r.startTick+=t);pe(n.notes)}m.maxEndTick+=Math.max(0,t),Ue(m.tracks),V(),Rt()}}function Xn(t){const e=Math.floor(Y);if(t!==0){j();for(const n of m.tracks){const r=[];for(const a of n.notes){const i=a.startTick,s=a.startTick+a.durationTick;if(s<=e)r.push(a);else{if(i>=e&&i<e+t)continue;if(i>=e+t)r.push({...a,startTick:Math.max(e,i-t)});else if(i<e&&s>e){const u=e-i;u>0&&r.push({...a,durationTick:u})}}}pe(r),n.notes=r}m.maxEndTick=Math.max(0,m.maxEndTick-t),Ue(m.tracks),V(),Rt()}}function qn(){return m.timeSig.beatsPerBar}function $o(){try{m.selectedLength=o.selectedLength,m.playheadVisualMode=ht,m.tpqn=L,m.extendedUnitsEnabled=et,m.tempoChanges&&Array.isArray(m.tempoChanges);const t={...m,tracks:m.tracks.map(e=>({id:e.id,notes:e.notes,name:e.name,instrument:e.instrument,optimizedMML:e.optimizedMML,order:e.order,mute:e.mute,solo:e.solo,color:e.color}))};return localStorage.setItem(An,JSON.stringify(t)),!0}catch(t){try{console.error("Save failed",t)}catch{}return!1}}let we=null;function V(){we&&window.clearTimeout(we),we=window.setTimeout(()=>{$o()},300)}function j(){F.push(m),V()}function Un(t){const e=ve.get(t.id);e&&clearTimeout(e);const n=setTimeout(()=>{try{We.postMessage({track:t,tpqn:m.tpqn??L})}catch{}ve.delete(t.id)},Ro);ve.set(t.id,n)}function Ue(t){for(const e of t)try{We.postMessage({track:e,tpqn:m.tpqn??L})}catch{}}function ot(t={}){const{track:e,recomputeLabels:n}=t;e&&(n&&Xe(e),Un(e),yt()),Rt()}function Ve(){const t=document.querySelector(".panel.canvas-wrap");t&&(t.style.height="")}function yt(){if(!ke)return;const t=m.tracks.find(n=>n.id===o.activeTrackId)||m.tracks[0];let e=t&&(t.optimizedMML?.trim?.()||t.mmlString?.trim?.())||"";e=e.replace(/[\r\n]+/g,""),ke.textContent=e,ke.title=e}function Vn(t,e){const n=(e||"").replace(/[\r\n]+/g,"").trim();t.mmlString=n;try{j();let r=m.bpm;const a=n.match(/^t(\d+)/);a&&(r=parseInt(a[1],10)),t.notes=so("MML@"+n),m.tracks[0]===t&&(m.bpm=r),Xe(t),Un(t),V(),Rt()}catch{t.notes=[]}}function Ko(){const t=m.tracks.filter(a=>a.solo),e=t.length>0?t:m.tracks.filter(a=>!a.mute),n=a=>Re.includes(a)?a:De,r=[];for(const a of e){const i=n(a.instrument||"lute");for(const s of a.notes)r.push({startTick:s.startTick,durationTick:s.durationTick,pitch:s.pitch,trackId:a.id,instrumentKey:i,volume:s.volume})}return r}function Fo(){K(),Gn(),_&&new ResizeObserver(()=>{mt=-1,H()}).observe(_);const t=document.getElementById("mobileTools"),e="mml_editor_touch_visible",n=l=>{!t||!ft||(t.style.display=l?"flex":"none",ft.setAttribute("data-i18n-title",l?"tooltipTouchToggleHide":"tooltipTouchToggleShow"),ft.title=y[k][l?"tooltipTouchToggleHide":"tooltipTouchToggleShow"],ft.setAttribute("aria-label",ft.title),ft.classList.toggle("is-active",l),localStorage.setItem(e,l?"1":"0"))},r=localStorage.getItem(e);n(r?r==="1":!1),ft?.addEventListener("click",()=>{const l=t?.style.display!=="none";n(!l)}),sn?.addEventListener("click",()=>{window.location.href="./mobile.html"});const i=(l,f="ghost")=>{l&&nt(l,f,"sm")};if(i(ft,"ghost"),i(sn,"primary"),i(Z,"ghost"),i(cn,"ghost"),i(ln,"ghost"),i(dn,"ghost"),i(un,"secondary"),i(mn,"secondary"),i(fn,"ghost"),i(pn,"ghost"),i(hn,"ghost"),i(gn,"ghost"),i(bn,"ghost"),R.addEventListener("pointermove",l=>{zn(l)&&wt(),rr(l)}),R.addEventListener("pointerdown",l=>{wt(),l.preventDefault(),ar(l)},{passive:!1}),window.addEventListener("pointerup",sr),window.addEventListener("pointermove",ir),window.addEventListener("pointermove",l=>{window.lastPointerX=l.clientX,window.lastPointerY=l.clientY}),window.addEventListener("keydown",Zo),window.addEventListener("keyup",jo),window.addEventListener("wheel",Qo,{passive:!1}),window.addEventListener("contextmenu",l=>{l.preventDefault()},{passive:!1}),_.addEventListener("scroll",Jo),$.addEventListener("click",l=>{wt(),ne(l)}),$.addEventListener("pointerdown",l=>{wt(),l.preventDefault(),dr(l)},{passive:!1}),window.addEventListener("pointermove",ur),window.addEventListener("pointerup",mr),Ce.addEventListener("click",Jn),Be.addEventListener("click",_e),Pe.addEventListener("click",Yn),Z){const l=()=>{Z.setAttribute("data-i18n","selectModeLabel"),Z.textContent=y[k].selectModeLabel||"선택모드";const f=Xt?"tooltipSelectMode":"tooltipDrawMode";Z.setAttribute("data-i18n-title",f),Z.title=y[k][f],Z.setAttribute("aria-label",Z.title),Z.classList.toggle("is-active",Xt)};Z.addEventListener("click",()=>{Xt=!Xt,l()}),l()}cn?.addEventListener("click",()=>{o.selected.clear(),o.marquee.active=!1,o.drag=null,o.ghost=null,H(),V()}),ln?.addEventListener("click",()=>Ke()),dn?.addEventListener("click",()=>Kn()),un?.addEventListener("click",()=>{z||Fn()}),mn?.addEventListener("click",()=>{$e(),V()}),bn?.addEventListener("click",()=>{$n(),V()}),fn?.addEventListener("click",()=>kn(-1)),pn?.addEventListener("click",()=>kn(1)),at?.addEventListener("input",()=>{const l=Math.max(16,Math.min(32,parseInt(at.value,10)));if(l!==o.keyHeight){o.keyHeight=l;try{localStorage.setItem(_n,String(l))}catch{}At&&(At.textContent=String(l)),mt=-1,Ve(),H()}}),hn?.addEventListener("click",()=>vn(-1)),gn?.addEventListener("click",()=>vn(1)),dt&&dt.addEventListener("click",()=>{ht=ht==="area"?"line":"area",dt&&(dt.textContent=ht==="area"?y[k].playheadAreaLabel:y[k].playheadLineLabel),A(),V()}),ie.addEventListener("click",Go),ae.addEventListener("click",()=>{z||pr()}),$t&&$t.addEventListener("click",()=>{me=me==="barbeat"?"time":"barbeat",zt()}),pt&&(pt.textContent=String(m.bpm),pt.addEventListener("click",()=>{z||lo(m,l=>{F.push(m),m.bpm=l,m.bpm=Math.min(l,ze),pt&&(pt.textContent=String(m.bpm)),zt?.(),A(),V()})}));let s=!1,u=0,c=0;Ft.addEventListener("pointerdown",l=>{s=!0,u=l.clientX,c=o.scrollX,Ft.setPointerCapture(l.pointerId)}),window.addEventListener("pointermove",l=>{if(!s||z)return;const f=l.clientX-u,p=kt(),h=Math.max(0,p-_.clientWidth),g=Math.max(1,Ot.clientWidth-Ft.clientWidth),b=h/g,w=c+f*b;o.scrollX=Jt(w),A()}),window.addEventListener("pointerup",()=>{s=!1}),Gt.addEventListener("click",nn),lt&&(nt(lt,"secondary","md"),lt.textContent=y[k].load||"Load",X(lt,"tooltipLoad",y[k].tooltipLoad||"Load project"),lt.addEventListener("click",()=>{try{const l=localStorage.getItem(An);if(!l){alert(y[k].noSavedProject||"No saved project found");return}const f=JSON.parse(l);if(!f||!f.tracks){alert(y[k].invalidSavedProject||"Saved data is invalid");return}let p=yn(f);const h=!!p.extendedUnitsEnabled;Sn(h);const g=h?Me:Te,b=p.tpqn||g;if(b!==g){const w=g/b;Ne(p,w)}p.tpqn=g,p.extendedUnitsEnabled=h,typeof p.selectedLength=="number"&&(o.selectedLength=p.selectedLength),(p.playheadVisualMode==="area"||p.playheadVisualMode==="line")&&(ht=p.playheadVisualMode),p=yn(p),m=p,o.selected.clear();try{o.volumeLabels?.clear()}catch{}for(const w of m.tracks)Xe(w);yt(),K(),H(),alert(y[k].loadedFromLocal||"Loaded from local storage")}catch(l){try{console.error("Load failed",l)}catch{}alert(y[k].loadFailed||"Load failed")}}));const d=l=>{mo(l),Zn(),dt&&(dt.textContent=ht==="area"?y[k].playheadAreaLabel:y[k].playheadLineLabel),Z&&(Z.textContent=y[k].selectModeLabel||(l==="ja"?"選択モード":l==="en"?"Select mode":"선택모드")),vt&&(vt.textContent=y[k].trackMMLLabel||(l==="ja"?"トラックMML":l==="en"?"Track MML":"트랙MML")),St&&(St.title=y[k].guideUndo),It&&(It.title=y[k].guideRedo),lt&&(lt.textContent=y[k].load||(l==="ja"?"読み込み":l==="en"?"Load":"불러오기"),X(lt,"tooltipLoad",y[k].tooltipLoad||lt.title||"Load project")),at&&(at.title=y[k].tooltipKeyHeight||at.title),At&&(At.textContent=String(o.keyHeight)),K(),yt()};se.addEventListener("click",()=>d("ko")),ce.addEventListener("click",()=>d("ja")),le.addEventListener("click",()=>d("en")),St&&(nt(St,"secondary","sm"),X(St,"guideUndo",y[k].guideUndo)),It&&(nt(It,"secondary","sm"),X(It,"guideRedo",y[k].guideRedo)),St?.addEventListener("click",()=>{const l=F.undo(m);l&&(m=l,o.selected.clear(),H(),K(),V())}),It?.addEventListener("click",()=>{const l=F.redo(m);l&&(m=l,o.selected.clear(),H(),K(),V())}),Gt.addEventListener("click",nn)}function Go(){const t=m.tracks.slice().sort((a,i)=>a.order-i.order),e=[];for(const a of t){const i=(a.optimizedMML||"").trim();if(i)e.push(i);else{let s=(He(a.notes??[])||"").trim();if(s||(s=(a.mmlString||"").trim()),s){const u=Cn(s,!0);e.push(u||s)}}}const r=`${`MML@t${Math.min(m.bpm,ze)}`}${e.join(",")};`;yo(m,{prebuiltDefault:r})}function he(t){const e=R.getBoundingClientRect(),n=t.clientX-e.left+o.scrollX,r=t.clientY-e.top;return{x:n,y:r}}function Yo(t){const e=$.getBoundingClientRect();return{x:t.clientX-e.left+o.scrollX}}function jo(t){t.key==="Alt"&&(Oe=!1,H())}function Zo(t){qe();const e=document.activeElement;if(e&&(e.tagName==="INPUT"||e.tagName==="TEXTAREA"||e.tagName==="SELECT"||e.isContentEditable))return;t.key==="Alt"&&(t.preventDefault(),Oe=!0,H());for(let i=1;i<=9;i++)t.key===i.toString()&&Mn(i-1);if(t.key==="0"&&Mn(Nt.length-1),z){t.code==="Space"&&(t.preventDefault(),_e());return}if((t.key==="ArrowUp"||t.key==="ArrowDown")&&t.shiftKey){const i=document.activeElement;if(i&&(i.tagName==="INPUT"||i.tagName==="SELECT"))return;t.preventDefault();const s=m.tracks.find(p=>p.id===o.activeTrackId);if(!s)return;const u=s.notes.filter(p=>o.selected.has(p.id));if(u.length===0)return;const c=p=>Math.floor(Je(p)/12),d=Math.min(...u.map(p=>c(p.pitch))),l=Math.max(...u.map(p=>c(p.pitch)));if(t.key==="ArrowUp"&&l>=7||t.key==="ArrowDown"&&d<=1)return;j();const f=t.key==="ArrowUp"?12:-12;for(const p of s.notes)o.selected.has(p.id)&&(p.pitch=Je(p.pitch+f));ot({track:s,recomputeLabels:!0});return}if((t.key==="ArrowUp"||t.key==="ArrowDown")&&!t.shiftKey&&!t.ctrlKey&&!t.metaKey&&!t.altKey){const i=document.activeElement;if(i&&(i.tagName==="INPUT"||i.tagName==="SELECT"))return;t.preventDefault();const s=m.tracks.slice().sort((l,f)=>l.order-f.order),u=s.findIndex(l=>l.id===o.activeTrackId);if(u===-1)return;const c=t.key==="ArrowUp"?-1:1,d=Math.max(0,Math.min(s.length-1,u+c));d!==u&&(o.activeTrackId=s[d].id,K(),H(),yt());return}const n=t.ctrlKey||t.metaKey;if(n&&t.key.toLowerCase()==="z"){t.preventDefault();const i=F.undo(m);i&&(m=i,o.selected.clear(),H(),K());return}if(n&&t.key.toLowerCase()==="y"){t.preventDefault();const i=F.redo(m);i&&(m=i,o.selected.clear(),H(),K());return}if(n&&t.key.toLowerCase()==="a"){t.preventDefault(),$n();return}if(t.key==="Escape"){o.selected.clear(),o.marquee.active=!1,o.drag=null,o.ghost=null,H();return}if(t.key==="Delete"){$e();return}if(n&&t.key.toLowerCase()==="c"){t.preventDefault(),Ke();return}if(n&&t.key.toLowerCase()==="v"){t.preventDefault(),Fn();return}if(n&&t.key.toLowerCase()==="x"){t.preventDefault(),Kn();return}if(t.code==="Space"){t.preventDefault(),z?_e():Jn();return}const r=D[m.zoomLevel-1],a=m.timeSig.beatsPerBar*r;if(t.key==="PageDown"){t.preventDefault(),o.scrollX=Math.max(0,Math.ceil((o.scrollX+1)/a)*a),A();return}if(t.key==="PageUp"){t.preventDefault(),o.scrollX=Math.max(0,Math.floor((o.scrollX-1)/a)*a),A();return}if(t.key==="Home"){t.preventDefault(),o.scrollX=0,A();return}if(t.key==="End"){t.preventDefault();const i=kt();o.scrollX=Jt(Math.max(0,i-_.clientWidth)),A();return}}function $n(){o.selected.clear();const t=m.tracks.find(e=>e.id===o.activeTrackId);for(const e of t.notes)o.selected.add(e.id);H()}function $e(){if(o.selected.size===0)return;F.push(m);const t=m.tracks.find(e=>e.id===o.activeTrackId);t.notes=t.notes.filter(e=>!o.selected.has(e.id)),o.selected.clear(),ot({track:t})}function Ke(){const e=m.tracks.find(r=>r.id===o.activeTrackId).notes.filter(r=>o.selected.has(r.id));if(e.length===0)return;const n=Math.min(...e.map(r=>r.startTick));o.clipboard=e.map(r=>({...r,startTick:r.startTick-n}))}function Kn(){Ke(),$e()}function Fn(){if(!o.clipboard||o.clipboard.length===0)return;F.push(m);const t=Math.max(0,Math.floor(Y)),e=m.tracks.find(n=>n.id===o.activeTrackId);e&&Le(async()=>{const{insertNoteWithOverlap:n,ensureBars:r}=await import("./timeline-CN1gSxtj.js").then(a=>a.u);return{insertNoteWithOverlap:n,ensureBars:r}},[],import.meta.url).then(({insertNoteWithOverlap:n,ensureBars:r})=>{if(o.selected.clear(),o.clipboard!=null)for(const a of o.clipboard){const i=crypto.randomUUID(),s={...a,id:i,startTick:Math.max(0,t+a.startTick)};n(m,e.id,s),r(m,s.startTick+s.durationTick),o.selected.add(i)}ot({track:e})})}function kn(t){const e=m.tracks.find(r=>r.id===o.activeTrackId);if(!e)return;const n=e.notes.filter(r=>o.selected.has(r.id));if(n.length!==0){F.push(m);for(const r of n){const a=(r.volume??B)+t;r.volume=bt(a),Dn(e,r)}ot({track:e})}}function vn(t){const e=Math.max(1,Math.min(9,m.zoomLevel+t));e!==m.zoomLevel&&(m.zoomLevel=e,mt=-1,H())}function Jo(){const e=-_.scrollTop+o.keyHeight;Q.style.transform=`translateY(${e}px)`}function Qo(t){if(zn(t)&&wt(),qe(),t.ctrlKey){t.preventDefault(),tr(t);return}if(t.altKey&&t.shiftKey&&o.selected.size>0&&!z){t.preventDefault(),j();const e=t.deltaY>0?-1:1,n=m.tracks.find(d=>d.id===o.activeTrackId),r=Qt(n),a=new Map(r.map(d=>[d.id,d.volume??B])),i=new Set([...o.selected]),s=r.map((d,l)=>({n:d,i:l})).filter(d=>i.has(d.n.id)).map(d=>d.i).sort((d,l)=>d-l),u=new Map;for(const d of s){const l=r[d].id,f=a.get(l)??B;u.set(d,bt(f+e))}let c=0;for(;c<s.length;){const d=s[c],l=u.get(d);let f=c+1;for(;f<s.length&&s[f]===s[f-1]+1&&u.get(s[f])===l;)f++;const p=d,h=s[f-1],g=p>0?a.get(r[p-1].id)??B:B;for(let w=p;w<=h;w++)r[w].volume=bt(u.get(w));let b=h+1;for(;b<r.length&&i.has(r[b].id);)b++;b<r.length&&(r[b].volume=g,Dn(n,r[b])),c=f}ot({track:n,recomputeLabels:!0});return}if(t.altKey&&!t.shiftKey&&o.selected.size>0&&!z){t.preventDefault(),j();const e=t.deltaY>0?-1:1,n=m.tracks.find(a=>a.id===o.activeTrackId),r=n.notes.filter(a=>o.selected.has(a.id));if(r.length>0){const a=r.reduce((u,c)=>c.startTick<u.startTick?c:u),i=a.volume??B,s=bt(i+e);Wn(n,a,s)}ot({track:n,recomputeLabels:!0});return}if(t.shiftKey){t.preventDefault();const e=D[m.zoomLevel-1],n=m.timeSig.beatsPerBar*e,a=(Math.abs(t.deltaX)>Math.abs(t.deltaY)?t.deltaX:t.deltaY)>0?1:-1,i=kt(),s=Math.max(0,i-_.clientWidth);let u=Math.max(0,Math.min(s,o.scrollX+a*n));if(z){const c=Y/L*e,d=_.clientWidth,l=Math.max(0,Math.min(s,Math.floor(c-d))),f=Math.max(0,Math.min(s,Math.floor(c)));u=Math.max(l,Math.min(f,u));let p=Jt(u);const h=Math.max(0,Math.min(s,Math.ceil(l/n)*n)),g=Math.max(0,Math.min(s,Math.floor(f/n)*n));h<=g?((p<h||p>g)&&(p=a>0?g:h),u=p):u=o.scrollX}o.scrollX=Jt(u),A();return}}function tr(t){const e=t.deltaY>0?-1:1,n=Math.max(1,Math.min(9,m.zoomLevel+e));if(n===m.zoomLevel)return;const r=D[m.zoomLevel-1],a=_.getBoundingClientRect(),i=Math.max(0,Math.min(t.clientX-a.left,a.width)),s=o.scrollX+i,u=r*m.timeSig.beatsPerBar,d=Math.max(0,Math.round(s/u)*u)/r*L;m.zoomLevel=n;const l=D[n-1],f=d/L*l,p=kt(),h=Math.max(0,p-_.clientWidth);o.scrollX=Math.max(0,Math.min(h,f-i));const g=l*m.timeSig.beatsPerBar;o.scrollX=Math.max(0,Math.min(h,Math.floor(o.scrollX/g)*g)),mt=-1,H(),te()}function K(){yt();const t=Ee;rn.innerHTML="",m.tracks.slice().sort((n,r)=>n.order-r.order).forEach((n,r)=>{n.color=t[r%t.length],(!n.instrument||!Re.includes(n.instrument))&&(n.instrument=De);const a=document.createElement("div");a.dataset.trackId=String(n.id),a.dataset.order=String(n.order);const i=n.id===o.activeTrackId;a.className="track-card",i&&a.classList.add("is-active");const s=document.createElement("div");s.className="track-color",s.style.cssText=`
            background: ${n.color};
        `;const u=document.createElement("div");u.className="track-main";const c=document.createElement("div");c.className="track-row track-row--top";const d=document.createElement("input");d.value=n.name,d.setAttribute("data-i18n-title","tooltipTrackName"),d.title=y[k].tooltipTrackName,c.style.width="100%",d.classList.add("track-name-input"),go(d,{size:"sm"}),d.addEventListener("change",()=>{F.push(m),n.name=d.value});const l=document.createElement("div");if(l.className="track-name",l.appendChild(d),c.appendChild(l),i){const h=document.createElement("div");h.className="track-reorder",h.style.marginLeft="auto",h.style.display="inline-flex",h.style.gap="6px";const g=document.createElement("button");g.type="button",g.textContent="▲",g.title="Move up",g.setAttribute("aria-label","Move track up"),g.style.width="24px",g.style.height="24px",g.style.fontSize="12px";const b=document.createElement("button");b.type="button",b.textContent="▼",b.title="Move down",b.setAttribute("aria-label","Move track down"),b.style.width="24px",b.style.height="24px",b.style.fontSize="12px";const w=m.tracks.length-1;g.disabled=n.order===0,b.disabled=n.order===w,g.addEventListener("click",E=>{E.stopPropagation(),xn(-1)}),b.addEventListener("click",E=>{E.stopPropagation(),xn(1)}),h.append(g,b),c.appendChild(h)}{const h=document.createElement("div");h.className="track-row track-row--middle",h.style.width="100%";const g=uo(),b=ho({items:g,value:n.instrument,size:"sm",fullWidth:!0,onChange:x=>{F.push(m),n.instrument=x}});b.el.setAttribute("data-i18n-title","tooltipInstrument"),b.el.title=y[k].tooltipInstrument;const w=document.createElement("div");w.className="track-instrument",w.appendChild(b.el),h.appendChild(w);const E=document.createElement("div");E.className="track-row track-row--bottom";const M=or(n),I=document.createElement("span");I.className="track-charcount";const P=n.optimizedMML?.length||0,W=y[k].charUnit;I.textContent=`${P}${W}`,I.setAttribute("data-i18n-title","tooltipCharCount"),I.title=y[k].tooltipCharCount,E.append(M,I),u.append(c,h,E)}const f=[d];{const h=u.querySelector(".dropdown");h instanceof HTMLElement&&f.push(h),u.querySelectorAll(".track-controls button").forEach(b=>f.push(b))}c.querySelectorAll(".track-reorder button").forEach(h=>f.push(h)),f.forEach(h=>{h.addEventListener("mousedown",g=>g.stopPropagation()),h.addEventListener("mouseup",g=>g.stopPropagation())}),a.addEventListener("click",h=>{const g=h.target.tagName;g==="INPUT"||g==="SELECT"||g==="BUTTON"||h.target.isContentEditable||o.activeTrackId!==n.id&&(o.activeTrackId=n.id,K(),H())}),a.append(s,u),rn.appendChild(a)})}function xn(t){const e=m.tracks.find(s=>s.id===o.activeTrackId);if(!e)return;const n=e.order,r=m.tracks.length-1,a=n+t;if(a<0||a>r)return;j();const i=m.tracks.find(s=>s.order===a);i&&(e.order=a,i.order=n),K(),V()}function Gn(){Kt.innerHTML="",Lt(),Nt.forEach(t=>{const e=gt({label:String(t),size:"sm",variant:t===o.selectedLength?"primary":"secondary"});t===o.selectedLength&&e.classList.add("active"),e.setAttribute("data-i18n-title","tooltipLength"),t===64?e.title=(y[k].tooltipLength||"Length")+" - 0 (주의: 인게임에서 박자가 어긋날 수 있음)":e.title=y[k].tooltipLength,e.addEventListener("click",()=>{Fe(t)}),t===48&&(e.style.marginRight="12px"),Kt.appendChild(e)}),O.textContent=et?y[k].extendedLessLabel||"더 적은 단위":y[k].extendedMoreLabel||"더 많은 단위",O.title=et?y[k].tooltipExtendedLess||"기본 단위로 돌아가기":y[k].tooltipExtendedMore||"더 많은 단위 사용 (64/128/5/7/11)",O.setAttribute("data-i18n",et?"extendedLessLabel":"extendedMoreLabel"),X(O,et?"tooltipExtendedLess":"tooltipExtendedMore",O.title),O.setAttribute("aria-label",O.title),O.onclick=er,Kt.appendChild(O)}function er(){if(!et){const e="mml_editor_warn_extended_shown";let n=!1;try{n=localStorage.getItem(e)==="1"}catch{}if(!n){if(!window.confirm(y[k].confirmEnableExtendedUnits||"Enable more units to use 64/128/5/7/11; existing ticks will be converted. Continue?"))return;try{localStorage.setItem(e,"1")}catch{}}wn(!0)}else wn(!1)}function wn(t){j();const r=(t?Me:Te)/(t?Te:Me);Ne(m,r),Sn(t),m.tpqn=L,m.extendedUnitsEnabled=t;try{F.transformSnapshots?.(a=>Ne(a,r))}catch{}nr(),Gn(),H()}function nr(){if(!Nt.includes(o.selectedLength)){let t=Nt[0],e=Math.abs(t-o.selectedLength);for(const n of Nt){const r=Math.abs(n-o.selectedLength);r<e&&(t=n,e=r)}Fe(t)}}function Ne(t,e){if(!(!Number.isFinite(e)||e<=0)){for(const n of t.tracks)for(const r of n.notes)r.startTick=Math.round(r.startTick*e),r.durationTick=Math.max(1,Math.round(r.durationTick*e));t.maxEndTick=Math.round(t.maxEndTick*e)}}function Fe(t){if(!Kt)return;o.selectedLength=t;const e=Array.from(Kt.children);e.forEach(n=>n.classList.remove("active")),e.forEach(n=>{if(n instanceof HTMLButtonElement){const a=parseInt(n.textContent||"0",10)===t;a&&n.classList.add("active"),n.classList.remove("btn--primary","btn--secondary"),n.classList.add(a?"btn--primary":"btn--secondary")}}),H(),V()}function or(t){const e=document.createElement("div");e.className="track-controls";const n=(i,s,u)=>{const c=document.createElement("button");return c.textContent=i,c.style.cssText=`
            width: 24px;
            height: 24px;
            font-size: 12px;
            font-weight: bold;
            border-radius: 4px;
            border: 1px solid #ccc;
            cursor: pointer;
            background-color: ${s?u:"#fff"};
            color: ${s?"#fff":"#000"};
        `,c},r=n("M",t.mute,"#f44336");r.setAttribute("data-i18n-title","tooltipMute"),r.title=y[k].tooltipMute,r.addEventListener("click",()=>{j(),t.mute=!t.mute,K()});const a=n("S",t.solo,"#ff9800");return a.setAttribute("data-i18n-title","tooltipSolo"),a.title=y[k].tooltipSolo,a.addEventListener("click",()=>{j(),t.solo=!t.solo,K()}),e.append(r,a),e}function Mn(t){const e=Nt[t];typeof e=="number"&&Fe(e)}function rr(t){if(z){o.hover.noteId=null,o.hover.edge=null,R.style.cursor="not-allowed";return}const{x:e,y:n}=he(t),r=D[m.zoomLevel-1],a=m.tracks.find(i=>i.id===o.activeTrackId);if(!o.drag&&!o.marquee.active){const i=Se(e,n,a.notes,r,o.keyHeight);i?(o.hover.noteId=i.note.id,o.hover.edge=i.edge,R.style.cursor=i.edge==="center"?"move":"ew-resize"):(o.hover.noteId=null,o.hover.edge=null,R.style.cursor="default"),A();return}if(o.marquee.active){o.marquee.x1=e,o.marquee.y1=n;const i=t.ctrlKey||t.metaKey,s=t.shiftKey;o.marquee.mode=i?"toggle":s?"add":"replace";const u=Po(o.marquee.x0,o.marquee.y0,o.marquee.x1,o.marquee.y1,a.notes,r,o.keyHeight),c=new Set(o.selected);if(o.marquee.mode==="replace"){o.selected.clear();for(const d of u)o.selected.add(d.id)}else if(o.marquee.mode==="add")for(const d of u)o.selected.add(d.id);else{o.selected=c;for(const d of u)o.selected.has(d.id)?o.selected.delete(d.id):o.selected.add(d.id)}A()}}function ar(t){if(wt(),to(),z){t.preventDefault(),R.style.cursor="not-allowed";return}if(qe(),t.button===1){t.preventDefault(),Et=!0,ne(t);return}if(t.button===2){t.preventDefault();const{x:f,y:p}=he(t),h=D[m.zoomLevel-1],g=m.tracks.find(w=>w.id===o.activeTrackId),b=Se(f,p,g.notes,h,o.keyHeight);if(b)o.selected.has(b.note.id)||(o.selected.clear(),o.selected.add(b.note.id),A()),Vo(b.note,t.clientX,t.clientY);else{const w=t.ctrlKey||t.metaKey,E=t.shiftKey;o.drag=null,o.ghost=null,o.marquee.active=!0,o.marquee.x0=f,o.marquee.y0=p,o.marquee.x1=f,o.marquee.y1=p,o.marquee.mode=w?"toggle":E?"add":"replace",A()}return}if(t.button!==0)return;const{x:e,y:n}=he(t),r=D[m.zoomLevel-1],a=m.tracks.find(f=>f.id===o.activeTrackId),i=Se(e,n,a.notes,r,o.keyHeight);if(!i){if(Xt){const M=t.ctrlKey||t.metaKey,I=t.shiftKey;o.drag=null,o.ghost=null,o.marquee.active=!0,o.marquee.x0=e,o.marquee.y0=n,o.marquee.x1=e,o.marquee.y1=n,o.marquee.mode=M?"toggle":I?"add":"replace",A();return}const f=Mt(o.selectedLength),p=e/r*L,h=eo(p,f),g=Zt(95-Math.floor(n/o.keyHeight)),b=Mt(o.selectedLength),w=crypto.randomUUID();o.drag={kind:"create",trackId:o.activeTrackId,noteId:w,startTick:h,durationTick:b,pitch:g},o.ghost={startTick:h,durationTick:b,pitch:g,color:it};const E=m.tracks.find(M=>M.id===o.activeTrackId);E&&de(g,E.id,E.instrument,st),A();return}const s=i.note,u=t.ctrlKey||t.metaKey,c=o.selected.has(s.id);u?c||o.selected.add(s.id):c||(o.selected.clear(),o.selected.add(s.id));{const f=m.tracks.find(p=>p.id===o.activeTrackId);f&&de(s.pitch,f.id,f.instrument,st)}const d=s.startTick,l=s.startTick+s.durationTick;if(i.edge==="center"){const f=Array.from(o.selected),p=m.tracks.find(g=>g.id===a.id).notes.filter(g=>o.selected.has(g.id)).map(g=>({id:g.id,startTick:g.startTick,pitch:g.pitch,durationTick:g.durationTick,volume:g.volume})),h=Mt(o.selectedLength);Yt=0,jt=0,o.moveGroup={trackId:a.id,ids:f,base:p,mouseStartX:e,mouseStartY:n,grid:h},o.drag={kind:"move",trackId:a.id,noteId:s.id,startTick0:d,yPitch0:s.pitch,mouseStartX:e,mouseStartY:n},o.ghost={startTick:s.startTick,durationTick:s.durationTick,pitch:s.pitch,color:it},A();return}else i.edge==="left"?(o.drag={kind:"resize-left",trackId:a.id,noteId:s.id,startTick0:d,endTick0:l,mouseStartX:e},o.ghost={startTick:s.startTick,durationTick:s.durationTick,pitch:s.pitch,color:it}):i.edge==="right"&&(o.drag={kind:"resize-right",trackId:a.id,noteId:s.id,startTick0:d,endTick0:l,mouseStartX:e},o.ghost={startTick:s.startTick,durationTick:s.durationTick,pitch:s.pitch,color:it});A()}function ir(t){if(z)return;if(Et){ne(t);return}if(o.marquee.active||!o.drag)return;const{x:e,y:n}=he(t),r=D[m.zoomLevel-1],a=Mt(o.selectedLength);if(o.drag.kind==="move"||o.drag.kind==="resize-left"||o.drag.kind==="resize-right"){if(o.drag.kind==="move"){const d=document.elementFromPoint(t.clientX,t.clientY)?.closest?.(".track-card");document.querySelectorAll(".track-card.drop-hover").forEach(l=>l.classList.remove("drop-hover")),d&&parseInt(d.dataset.trackId||"-1",10)!==o.drag.trackId&&d.classList.add("drop-hover")}const i=m.tracks.find(c=>o.drag!=null&&c.id===o.drag.trackId),s=i.notes.findIndex(c=>o.drag!=null&&c.id===o.drag.noteId);if(s<0)return;const u=i.notes[s];if(o.drag.kind==="move"){const c=o.moveGroup;if(!c)return;const d=(e-c.mouseStartX)/r,l=Math.floor((c.mouseStartY-n)/o.keyHeight),f=d*L,p=Math.round(f/c.grid)*c.grid;Yt=p,jt=l;const h=Zt(o.drag.yPitch0+l),g=m.tracks.find(M=>M.id===o.activeTrackId);g&&de(h,g.id,g.instrument,st),A();const b=r,w=o.scrollX,E=window.devicePixelRatio||1;rt.save(),rt.setTransform(E,0,0,E,0,0),rt.globalAlpha=.7,rt.fillStyle=it;for(const M of c.base){const I=Math.max(0,M.startTick+p),P=Math.round(I/L*b)-Math.floor(w)+.5,W=Math.max(1,Math.round(M.durationTick/L*b)),v=(95-Zt(M.pitch+l))*o.keyHeight+.5,T=o.keyHeight-1;rt.fillRect(P,v,W,T)}rt.globalAlpha=1,rt.restore();return}if(o.drag.kind==="resize-left"){const c=(e-o.drag.mouseStartX)/r;let d=o.drag.startTick0+c*L,l=Math.max(0,Math.floor(d/a)*a);l=Math.min(l,o.drag.endTick0-a);const f=o.drag.endTick0-l;o.ghost={startTick:l,durationTick:f,pitch:u.pitch,color:it};const p=o.drag.endTick0-o.drag.startTick0,h=Math.max(0,p-f),g=Mt(32),b=m.tracks.find(M=>M.id===o.drag.trackId),w=new Set(o.selected),E=[];if(h>0)for(const M of b.notes){if(M.id===o.drag.noteId||!w.has(M.id))continue;const I=Math.max(g,M.durationTick-h);E.push({startTick:M.startTick,durationTick:I,pitch:M.pitch,color:it})}o.ghostGroup=E.length?E:null,A();return}if(o.drag.kind==="resize-right"){const c=(e-o.drag.mouseStartX)/r;let d=o.drag.endTick0+c*L,l=Math.max(o.drag.startTick0+a,Math.ceil(d/a)*a);const f=m.tracks.find(P=>P.id===o.drag.trackId),p=o.drag.startTick0,h=f.notes.filter(P=>P.startTick>p).sort((P,W)=>P.startTick-W.startTick)[0];h&&(l=Math.min(l,h.startTick));const g=l-o.drag.startTick0;o.ghost={startTick:o.drag.startTick0,durationTick:g,pitch:u.pitch,color:it};const b=o.drag.endTick0-o.drag.startTick0,w=Math.max(0,g-b),E=m.tracks.find(P=>P.id===o.drag.trackId),M=new Set(o.selected),I=[];if(w>0)for(const P of E.notes){if(P.id===o.drag.noteId||!M.has(P.id))continue;const W=E.notes.filter(S=>S.startTick>P.startTick).sort((S,N)=>S.startTick-N.startTick)[0];let x=Number.POSITIVE_INFINITY;W&&(x=Math.max(0,W.startTick-(P.startTick+P.durationTick)));const v=Math.max(0,Math.min(w,x)),T=P.durationTick+v;I.push({startTick:P.startTick,durationTick:T,pitch:P.pitch,color:it})}o.ghostGroup=I.length?I:null,A();return}}if(o.drag.kind==="create"){const i=o.drag.startTick,s=(e-i/L*r)/r,u=i+Math.max(a,Math.round(s*L)),d=Math.max(i+a,Math.ceil(u/a)*a)-i,l=Zt(95-Math.floor(n/o.keyHeight));o.ghost={startTick:i,durationTick:d,pitch:l,color:it};const f=m.tracks.find(p=>p.id===o.activeTrackId);f&&de(l,f.id,f.instrument,st),A()}}function sr(){if(z)return;if(Et){Et=!1;return}st.sampler&&st.pitch!==null&&(ao(st.sampler,st.pitch),st.pitch=null,st.sampler=null);const t=document.activeElement;if(t&&(t.tagName==="INPUT"||t.tagName==="SELECT"||t.isContentEditable))return;if(o.marquee.active){o.marquee.active=!1,A();return}if(!o.drag)return;if(o.drag.kind==="move"&&o.moveGroup){const s=document.elementFromPoint(window.lastPointerX??0,window.lastPointerY??0)?.closest?.(".track-card");if(s){const d=parseInt(s.dataset.trackId||"-1",10),l=o.moveGroup.trackId;if(!Number.isNaN(d)&&d>0&&d!==l){const f=m.tracks.find(b=>b.id===l),p=m.tracks.find(b=>b.id===d),h=new Set(o.moveGroup.ids),g=f.notes.filter(b=>h.has(b.id));if(g.length>0){const b=Math.min(...g.map(M=>M.startTick)),w=Math.max(...g.map(M=>M.startTick+M.durationTick)),E=p.notes.filter(M=>M.startTick<w&&M.startTick+M.durationTick>b);F.push(m),f.notes=f.notes.filter(M=>!h.has(M.id)).concat(E),p.notes=p.notes.filter(M=>!E.includes(M)).concat(g),pe(f.notes),pe(p.notes),o.selected.clear();for(const M of g)o.selected.add(M.id);o.moveGroup=null,o.drag=null,o.ghost=null,ot({track:f}),ot({track:p}),K();return}}}const u=o.moveGroup;if(Yt===0&&jt===0){o.moveGroup=null,o.drag=null,o.ghost=null;return}j();const c=m.tracks.find(d=>d.id===u.trackId);c.notes=c.notes.filter(d=>!u.ids.includes(d.id)),Le(async()=>{const{insertNoteWithOverlap:d,ensureBars:l}=await import("./timeline-CN1gSxtj.js").then(f=>f.u);return{insertNoteWithOverlap:d,ensureBars:l}},[],import.meta.url).then(({insertNoteWithOverlap:d,ensureBars:l})=>{o.selected.clear();for(const f of u.base){const p={id:f.id,startTick:Math.max(0,f.startTick+Yt),durationTick:f.durationTick,pitch:Zt(f.pitch+jt),velocity:100,volume:f.volume??B};d(m,u.trackId,p),l(m,p.startTick+p.durationTick),o.selected.add(p.id)}o.moveGroup=null,o.drag=null,o.ghost=null,Yt=0,jt=0,ot({track:c}),V()});return}if(!o.ghost){o.drag=null,document.querySelectorAll(".track-card.drop-hover").forEach(s=>s.classList.remove("drop-hover"));return}const e=o.ghost,n=o.drag.trackId,r=m.tracks.find(s=>s.id===n);let a=B;if(r){const s=Qt(r);let u=B;for(let c=0;c<s.length;c++){const d=s[c];if(d.startTick>=e.startTick)break;const l=d.volume??B;Hn(s,c,o.volumeLabels),u=l}a=u}const i={id:o.drag.noteId,startTick:e.startTick,durationTick:e.durationTick,pitch:e.pitch,velocity:100,volume:a};F.push(m),Le(async()=>{const{insertNoteWithOverlap:s,ensureBars:u}=await import("./timeline-CN1gSxtj.js").then(c=>c.u);return{insertNoteWithOverlap:s,ensureBars:u}},[],import.meta.url).then(({insertNoteWithOverlap:s,ensureBars:u})=>{const c=m.tracks.find(d=>d.id===n);if(o.drag.kind==="resize-left"||o.drag.kind==="resize-right"){const d=c.notes.findIndex(g=>g.id===o.drag.noteId);d>=0&&c.notes.splice(d,1);const l=o.drag.endTick0-o.drag.startTick0,f=e.durationTick,p=Math.max(0,l-f);if(p>0){const g=Mt(32),b=new Set(o.selected);for(const w of c.notes)w.id!==o.drag.noteId&&b.has(w.id)&&(w.durationTick=Math.max(g,w.durationTick-p))}const h=Math.max(0,f-l);if(h>0){const g=new Set(o.selected);for(const b of c.notes){if(b.id===o.drag.noteId||!g.has(b.id))continue;const w=c.notes.filter(I=>I.startTick>b.startTick).sort((I,P)=>I.startTick-P.startTick)[0];let E=Number.POSITIVE_INFINITY;w&&(E=Math.max(0,w.startTick-(b.startTick+b.durationTick)));const M=Math.max(0,Math.min(h,E));M>0&&(b.durationTick+=M,u(m,b.startTick+b.durationTick))}}}s(m,n,i),u(m,i.startTick+i.durationTick),o.drag=null,o.ghost=null,o.ghostGroup=null,document.querySelectorAll(".track-card.drop-hover").forEach(d=>d.classList.remove("drop-hover")),ot({track:c,recomputeLabels:!0}),V()})}function A(){cr(),o.isAltDown=Oe;const t=D[m.zoomLevel-1],e=Y/L*t,n=o.scrollX,r=_.clientWidth,a=n+r;_.clientHeight;const i=m.timeSig.beatsPerBar*t,s=(Tt||m.timeSig.beatsPerBar)*t,u=Math.floor(n/i),c=n-u*i,d=Math.floor(n/s),l=n-d*s;R.style.left=`${-c}px`,U&&(U.style.left=`${-l}px`),U&&fe&&Pn(fe,U,m,o,Tt),wo(rt,m,o,u*i,r+i);const f=e-n;if(z)if(ht==="area"){const g=D[m.zoomLevel-1],b=Tt||m.timeSig.beatsPerBar,w=g*b,M=Math.floor(e/w)*w-n;_o(rt,R,M,w)}else on(rt,R,f);else on(rt,R,f);Ao(Nn,Q,o.keyHeight);const h=-_.scrollTop+o.keyHeight;if(Q.style.transform=`translateY(${h}px)`,lr(),z&&e>=a){const g=D[m.zoomLevel-1],b=m.timeSig.beatsPerBar*g,w=Y/L*g,E=Math.floor(w/b)*b,M=kt(),I=Math.max(0,M-_.clientWidth);o.scrollX=Math.max(0,Math.min(I,E))}zt(),Ge()}function cr(){const t=window.devicePixelRatio||1,e=D[m.zoomLevel-1],r=m.timeSig.beatsPerBar*e,a=(_.clientWidth||800)+r,i=84*o.keyHeight,s=i;R.style.width!==`${a}px`&&(R.style.width=`${a}px`),R.style.height!==`${s}px`&&(R.style.height=`${s}px`);const u=Math.max(1,Math.floor(a*t)),c=Math.max(1,Math.floor(s*t));if((R.width!==u||R.height!==c)&&(R.width=u,R.height=c),U&&fe){const g=(_.clientWidth||800)+r,b=i;U.style.width!==`${g}px`&&(U.style.width=`${g}px`),U.style.height!==`${b}px`&&(U.style.height=`${b}px`);const w=Math.max(1,Math.floor(g*t)),E=Math.max(1,Math.floor(b*t)),M=U.width!==w,I=U.height!==E;(M||I)&&(U.width=w,U.height=E),(M||I||mt!==m.zoomLevel)&&(Pn(fe,U,m,o,Tt),mt=m.zoomLevel)}const d=84*o.keyHeight;(Q.width!==Math.floor(48*t)||Q.height!==Math.floor(d*t))&&(Q.width=Math.floor(48*t),Q.height=Math.floor(d*t),t!==1&&Nn.setTransform(t,0,0,t,0,0)),Q.style.width!=="48px"&&(Q.style.width="48px");const l=`${d}px`;Q.style.height!==l&&(Q.style.height=l),_t.style.height!==o.keyHeight+"px"&&(_t.style.height=o.keyHeight+"px");const f=_t.clientWidth||_.clientWidth||800,p=Math.max(1,Math.floor(f*t)),h=Math.max(1,Math.floor(o.keyHeight*t));($.width!==p||$.height!==h)&&($.width=p,$.height=h,t!==1&&Ie.setTransform(t,0,0,t,0,0))}function te(){pt&&pt.textContent!==String(m.bpm)&&(pt.textContent=String(m.bpm))}function _e(){z=!1,ue().stop(),In(),te(),zt(),Ge()}function Yn(){z=!1,ue().stop(),ue().position=0,In(),Y=Xo,te(),zt(),A()}function lr(){const t=D[m.zoomLevel-1],e=Tt||m.timeSig.beatsPerBar,n=window.devicePixelRatio||1,r=o.keyHeight;_t.style.height!==r+"px"&&(_t.style.height=r+"px");const a=_t.clientWidth||_.clientWidth||800,i=Math.max(1,Math.floor(a*n)),s=Math.max(1,Math.floor(r*n));$.width!==i&&($.width=i),$.height!==s&&($.height=s),n!==1&&Ie.setTransform(n,0,0,n,0,0);const u=o.scrollX;No(Ie,$,u,t,e)}function H(){te(),mt=-1,A()}function jn(){if(!z)return;const t=performance.now(),e=Math.max(0,t-Ae);Ae=t;const n=L*(m.bpm/60)/1e3;Y+=e*n;const r=ee();if(Y>=r){Yn();return}A(),requestAnimationFrame(jn)}function ee(){let t=0;for(const e of m.tracks)for(const n of e.notes){const r=n.startTick+n.durationTick;r>t&&(t=r)}return t}function zt(){if(!$t)return;const t=ee(),e=Math.max(0,Math.floor(Y));if(me==="barbeat"){const n=m.timeSig.beatsPerBar,r=Tn(e,m.bpm,n),a=Tn(t,m.bpm,n),i=(r.beatInBar+1).toFixed(1).replace(/\.0$/,""),s=(a.beatInBar+1).toFixed(1).replace(/\.0$/,"");$t.textContent=`${r.bar}.${i} / ${a.bar}.${s}`;return}if(me==="time"){const n=En(e,m.bpm),r=En(t,m.bpm);$t.textContent=`${n} / ${r}`;return}}function Tn(t,e,n){const r=t/L,a=Math.floor(r/n)+1,i=r%n;return{bar:a,beatInBar:i}}function En(t,e){const n=t/L*(60/e),r=Math.floor(n/60),a=Math.floor(n%60),i=Math.floor((n-Math.floor(n))*1e3),s=String(r).padStart(2,"0"),u=String(a).padStart(2,"0"),c=String(i).padStart(3,"0");return`${s}:${u}.${c}`}function dr(t){t.button!==2&&(z||(Et=!0,ne(t)))}function ur(t){Et&&ne(t)}function mr(){Et=!1}function ne(t){const{x:e}=Yo(t),n=D[m.zoomLevel-1],r=e/n*L,a=Mt(o.selectedLength);Y=Math.max(0,Math.floor(r/a)*a),z&&(z=!1),A()}function Ge(){const t=kt(),e=t-_.clientWidth;if(e<=1){Ot.style.display="none";return}Ot.style.display="block";const n=Math.max(20,_.clientWidth/t*Ot.clientWidth);Ft.style.width=`${n}px`;const a=o.scrollX/e*(Ot.clientWidth-n);Ft.style.left=`${a}px`}function kt(){const t=D[m.zoomLevel-1],e=Math.ceil(ee()/L);return Math.max(_.clientWidth,Math.ceil(e*t)+_.clientWidth)}function Jt(t){const e=D[m.zoomLevel-1],n=m.timeSig.beatsPerBar*e,r=Math.round(t/n)*n;return Math.max(0,r)}function fr(t){const e=D[m.zoomLevel-1],n=m.timeSig.beatsPerBar*e,r=kt(),a=Math.max(0,r-_.clientWidth),i=Math.max(0,Math.min(a,o.scrollX+t*n));o.scrollX=Jt(i),Ge(),A()}function Zn(){const t=y[k];if(Ct&&(Ct.title=t.tooltipRulerPrevBar||"Prev bar",Ct.setAttribute("data-i18n-title","tooltipRulerPrevBar"),Ct.setAttribute("aria-label",Ct.title)),Bt&&(Bt.title=t.tooltipRulerNextBar||"Next bar",Bt.setAttribute("data-i18n-title","tooltipRulerNextBar"),Bt.setAttribute("aria-label",Bt.title)),O&&(O.textContent=et?t.extendedLessLabel||"더 적은 단위":t.extendedMoreLabel||"더 많은 단위",O.title=et?t.tooltipExtendedLess||"기본 단위로 돌아가기":t.tooltipExtendedMore||"더 많은 단위 사용 (64/128/5/7/11)",O.setAttribute("data-i18n",et?"extendedLessLabel":"extendedMoreLabel"),O.setAttribute("data-i18n-title",et?"tooltipExtendedLess":"tooltipExtendedMore"),O.setAttribute("aria-label",O.title)),tt){const e=t.tooltipDisplayTimeSig||"Display time signature (n/4)";tt.title=e,tt.setAttribute("data-i18n-title","tooltipDisplayTimeSig"),tt.setAttribute("aria-label",e)}}nt(O,"ghost","sm");if(tt){const t=a=>Math.max(1,Math.min(16,Math.floor(a)));let e=null;try{const a=localStorage.getItem(an);if(a!=null){const i=Number(a);Number.isFinite(i)&&(e=t(i))}}catch{}const n=e??t(Number(m.timeSig?.beatsPerBar)||4);Tt=n,tt.value!==String(n)&&(tt.value=String(n));const r=()=>{const a=Number(tt.value),i=Number.isFinite(a)?t(a):n;Tt=i,tt.value!==String(i)&&(tt.value=String(i));try{localStorage.setItem(an,String(i))}catch{}mt=-1,H()};tt.addEventListener("change",r),tt.addEventListener("input",r)}window.addEventListener("resize",()=>{Ve(),mt=-1,H()});setTimeout(Ve,0);Lt();Bn();Ce&&X(Ce,"tooltipPlay",y[k].tooltipPlay);Be&&X(Be,"tooltipPause",y[k].tooltipPause);dt&&(dt.textContent=ht==="area"?y[k].playheadAreaLabel:y[k].playheadLineLabel,X(dt,"tooltipPlayheadToggle",y[k].tooltipPlayheadToggle));Pe&&X(Pe,"tooltipStop",y[k].tooltipStop);Pt&&(nt(Pt,"secondary","md"),Pt.setAttribute("data-i18n","edit"),X(Pt,"tooltipEditMML",y[k].tooltipEditMML));ie&&(nt(ie,"secondary","md"),X(ie,"tooltipConvert",y[k].tooltipConvert));ae&&(nt(ae,"secondary","md"),X(ae,"tooltipPaste",y[k].tooltipPaste));Gt&&(nt(Gt,"ghost","md"),X(Gt,"tooltipGuide",y[k].tooltipGuide));if(at){const t=(()=>{try{return localStorage.getItem(_n)}catch{return null}})(),e=Math.max(16,Math.min(32,t?parseInt(t,10):o.keyHeight));o.keyHeight=e,at.value=String(e),At&&(At.textContent=String(e)),at.min="16",at.max="32",at.step="1",X(at,"tooltipKeyHeight",y[k].tooltipKeyHeight||"노트 높이 (16-32)")}se&&(nt(se,"ghost","sm"),X(se,"tooltipLangKo",y[k].tooltipLangKo));ce&&(nt(ce,"ghost","sm"),X(ce,"tooltipLangJa",y[k].tooltipLangJa));le&&(nt(le,"ghost","sm"),X(le,"tooltipLangEn",y[k].tooltipLangEn));R&&(R.setAttribute("data-i18n-title","tooltipPianoRoll"),R.title=y[k].tooltipPianoRoll);$&&($.setAttribute("data-i18n-title","tooltipRuler"),$.title=y[k].tooltipRuler);Fo();H();yt();Pt?Pt.onclick=()=>{const t=m.tracks.find(n=>n.id===o.activeTrackId);if(!t)return;let e=t.optimizedMML?.trim?.()||t.mmlString?.trim?.()||"";if(e=e.replace(/[\r\n]+/g,""),!e)try{e=(He(t.notes??[])||"").trim().replace(/[\r\n]+/g,"")}catch{}ko(t,n=>{Vn(t,n),m.maxEndTick=ee(),yt(),K()},e)}:m=Ln();Zn();O.id="btnToggleExtended";O.style.marginLeft="8px";O.textContent=et?y[k].extendedLessLabel||"더 적은 단위":y[k].extendedMoreLabel||"더 많은 단위";We.onmessage=t=>{const{trackId:e,optimizedMML:n,originalBody:r}=t.data,a=m.tracks.find(i=>i.id===e);a&&(a.optimizedMML=n,a.originalBody=r??"",K(),yt(),Rt())};Do?.addEventListener("click",()=>{On(L)});Ho?.addEventListener("click",()=>{const t=L*qn();On(t)});Wo?.addEventListener("click",()=>{Xn(L)});Oo?.addEventListener("click",()=>{const t=L*qn();Xn(t)});(function(){vt&&(vt.textContent=y[k].trackMMLLabel||"트랙MML",vt.setAttribute("data-i18n","trackMMLLabel"),vt.setAttribute("data-i18n-title","tooltipEditMML"),vt.title=y[k].tooltipEditMML)})();o.moveGroup=null;(function(){const e=(n,r)=>{if(!n)return;let a=null,i=null;const s=()=>{a!==null&&(window.clearTimeout(a),a=null),i!==null&&(window.clearInterval(i),i=null)},u=()=>fr(r);n.addEventListener("pointerdown",c=>{c.preventDefault(),wt(),u(),a=window.setTimeout(()=>{i=window.setInterval(u,120)},350),c.target.setPointerCapture?.(c.pointerId)},{passive:!1}),window.addEventListener("pointerup",s),window.addEventListener("pointercancel",s),n.addEventListener("pointerleave",s)};e(Ct,-1),e(Bt,1)})();(function(){const e="2025-08-27-load-change",n="mml_editor_whatsnew_shown_"+e;let r=!1;try{r=localStorage.getItem(n)==="1"}catch{}r||setTimeout(()=>zo(e),0)})();async function pr(){try{F.push(m);const t=await navigator.clipboard.readText();if(!t.trim().startsWith("MML@")){alert(y[k].invalid_mml_format||"MML 형식이 아닙니다.");return}let e=t.trim().substring(4);e=e.replace(/\r?\n/g,"").replace(/;+$/g,"");const n=e.split(",").map(a=>a.replace(/;+$/g,"").trim());if(n.length>6){alert("트랙은 최대 6개까지만 지원합니다.");return}const r=[];for(let a=0;a<m.tracks.length;a++){const i=n[a]?n[a]:"",s=m.tracks[a],u=s.notes?.length||0;try{if(i&&i.length>0)try{s.optimizedMML=Cn(i)||i}catch{s.optimizedMML=i}else s.optimizedMML="";Vn(s,i),(s.notes?.length||0)>u&&r.push(s)}catch{alert(y[k].invalid_mml_format||"MML 형식이 아닙니다.");return}}m.maxEndTick=ee(),r.length>0&&Ue(r),K(),Rt(),V()}catch{}}async function Jn(){if(z)return;z=!0,await no();const t=Ko();await oo(t,m.bpm),ue().position=ro(Y,m.bpm),Ae=performance.now();{const e=D[m.zoomLevel-1],n=m.timeSig.beatsPerBar*e,r=Y/L*e,a=Math.floor(r/n)*n,i=kt(),s=Math.max(0,i-_.clientWidth);o.scrollX=Math.max(0,Math.min(s,a))}te?.(),zt?.(),jn()}const Ye=()=>{const t=window.visualViewport?window.visualViewport.height:window.innerHeight;document.documentElement.style.setProperty("--app-100dvh",t+"px")};Ye();window.addEventListener("resize",Ye);window.visualViewport?.addEventListener("resize",Ye);
