import{T as E,P as $,D,c as Sn,H as so,e as Cn,s as An,E as ze,B as Re,a as De,I as je,b as Je,L as Kt,t as wt,d as Ee,p as ve,_ as We,f as mn,g as co,h as lo,i as Ze,j as He,k as xe,l as Bn,m as ht,M as Xe,n as pn,o as uo,q as mo}from"./timeline-Cty6ufw_.js";import{notesToMMLWithTempos as po,notesToMML as In,notesToMMLRaw as Qe,newOptimizeBody as Pn,extractTempoAnchorsFromMMLBodies as Nn,mmlToNotes as fo}from"./converter-fJK0iSIn.js";import{t as y,c as v,u as ho,i as go,s as bo}from"./languages-D2lkxtMG.js";let fn=!1;function $t(){if(fn)return;const t=document.createElement("style");t.id="app-button-styles",t.textContent=`
  :root {
    --btn-font: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    --btn-radius: 8px;
    --btn-pad-y: 6px; --btn-pad-x: 12px;
    --btn-fg: #1f2937; --btn-bg: #ffffff; --btn-bd: #cfd3d8;
    --btn-fg-primary: #ffffff; --btn-bg-primary: #3a7afe; --btn-bd-primary: #2f65d2;
    --btn-fg-danger: #ffffff; --btn-bg-danger: #ef4444; --btn-bd-danger: #dc2626;
    --btn-fg-ghost: #374151; --btn-bg-ghost: transparent; --btn-bd-ghost: #d1d5db;
    --btn-hover: 0.97; --btn-active: 0.94;
  }
  .btn { font: 500 13px/1 var(--btn-font); padding: var(--btn-pad-y) var(--btn-pad-x); border-radius: var(--btn-radius); cursor: pointer; border:1px solid var(--btn-bd); background: var(--btn-bg); color: var(--btn-fg); transition: filter .15s ease, background .15s ease, border-color .15s ease, transform .15s ease, box-shadow .15s ease; }
  .btn:hover { filter: brightness(var(--btn-hover)); }
  .btn:active { filter: brightness(var(--btn-active)); transform: translateY(0.5px); }
  .btn:disabled { opacity: .6; cursor: not-allowed; }
  .btn--primary { color: var(--btn-fg-primary); background: var(--btn-bg-primary); border-color: var(--btn-bd-primary); }
  .btn--danger { color: var(--btn-fg-danger); background: var(--btn-bg-danger); border-color: var(--btn-bd-danger); }
  .btn--ghost { color: var(--btn-fg-ghost); background: var(--btn-bg-ghost); border-color: var(--btn-bd-ghost); }
  .btn--secondary { /* defaults already set by .btn */ }
  .btn--sm { padding: 4px 8px; font-size: 12px; }
  .btn--md { padding: 6px 12px; font-size: 13px; }
  .btn--lg { padding: 10px 16px; font-size: 15px; }
  `,document.head.appendChild(t),fn=!0}function ko(t,e){$t();const n=e?.variant??"secondary",r=e?.size??"md";return t.classList.add("btn",`btn--${n}`,`btn--${r}`),e?.label!=null&&(t.textContent=e.label),e?.title&&(t.title=e.title),e?.disabled!=null&&(t.disabled=e.disabled),e?.onClick&&(t.onclick=e.onClick),e?.attrs&&Object.entries(e.attrs).forEach(([a,o])=>t.setAttribute(a,o)),t}function _t(t){const e=document.createElement("button");return ko(e,t)}let hn=!1;function yo(){if(hn)return;const t=`
  :root {
    --dd-radius: 6px;
    --dd-border: #cfcfcf;
    --dd-border-hover: #b5b5b5;
    --dd-bg: #fff;
    --dd-text: #111;
    --dd-muted: #6b7280;
    --dd-shadow: 0 8px 24px rgba(0,0,0,0.12), 0 2px 6px rgba(0,0,0,0.08);
    --dd-focus: 0 0 0 3px rgba(33,150,243,0.15);
  }

  .dropdown { position: relative; display: inline-flex; }
  .dropdown--full { width: 100%; }

  .dropdown__button {
    display: inline-flex; align-items: center; justify-content: space-between;
    gap: 8px; width: 100%;
    background: var(--dd-bg);
    color: var(--dd-text);
    border: 1px solid var(--dd-border);
    border-radius: var(--dd-radius);
    cursor: pointer; user-select: none;
    transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
  }
  .dropdown__button:hover { border-color: var(--dd-border-hover); }
  .dropdown__button:focus-visible { outline: none; box-shadow: var(--dd-focus); }

  .dropdown__button--sm { height: 28px; padding: 4px 8px; font-size: 12px; }
  .dropdown__button--md { height: 34px; padding: 6px 10px; font-size: 14px; }
  .dropdown__button--lg { height: 40px; padding: 8px 12px; font-size: 16px; }

  .dropdown__caret { width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 6px solid #888; }

  .dropdown__menu {
    position: absolute; left: 0; top: calc(100% + 4px);
    min-width: 100%;
    background: #fff; border: 1px solid var(--dd-border);
    border-radius: var(--dd-radius);
    box-shadow: var(--dd-shadow);
    padding: 6px; margin: 0; list-style: none;
    z-index: 1000; display: block; opacity: 0; transform: var(--dd-transform, translateY(4px));
    pointer-events: none; transition: opacity .16s ease, transform .16s ease;
  }
  .dropdown__menu[data-open="true"] { opacity: 1; transform: translateY(0); pointer-events: auto; }

  .dropdown__item {
    padding: 6px 8px; border-radius: 6px; cursor: pointer;
    white-space: nowrap; color: var(--dd-text);
  }
  .dropdown__item[aria-selected="true"] { background: #eef6ff; }
  .dropdown__item:hover { background: #f3f4f6; }
  .dropdown__item:focus { outline: none; box-shadow: var(--dd-focus); }
  `,e=document.createElement("style");e.id="dropdown-styles",e.textContent=t,document.head.appendChild(e),hn=!0}function vo(t){yo();const e=t.size??"md";let n=t.value??t.items[0]?.value??"",r=t.items;const a=document.createElement("div");a.className="dropdown",a.classList.add("dropdown--full");const o=document.createElement("button");o.type="button",o.className=`dropdown__button dropdown__button--${e}`,o.setAttribute("aria-haspopup","listbox"),o.setAttribute("aria-expanded","false");const i=document.createElement("span");i.textContent=t.items.find(T=>T.value===n)?.label??"";const d=document.createElement("i");d.className="dropdown__caret",o.append(i,d);const c=document.createElement("ul");c.className="dropdown__menu",c.setAttribute("role","listbox"),c.setAttribute("tabindex","-1");const l=a;let m=!1;function p(){c.innerHTML="";for(const T of r){const S=document.createElement("li");S.className="dropdown__item",S.setAttribute("role","option"),S.setAttribute("tabindex","0"),S.setAttribute("aria-selected",String(T.value===n)),S.textContent=T.label,S.addEventListener("click",()=>w(T.value)),S.addEventListener("keydown",W=>{W.key==="Enter"||W.key===" "?(W.preventDefault(),w(T.value)):W.key==="Escape"?(W.preventDefault(),g(),o.focus()):W.key==="ArrowDown"?(W.preventDefault(),B(S)):W.key==="ArrowUp"&&(W.preventDefault(),P(S))}),c.appendChild(S)}}function f(){p(),m||(document.body.appendChild(c),m=!0,c.style.position="fixed",c.style.zIndex="1000");const T=o.getBoundingClientRect();c.style.minWidth=T.width+"px",x(),c.dataset.open="true",o.setAttribute("aria-expanded","true"),window.addEventListener("mousedown",b,{capture:!0}),window.addEventListener("scroll",k,!0),window.addEventListener("resize",k)}function g(){delete c.dataset.open,o.setAttribute("aria-expanded","false"),m&&(l.appendChild(c),m=!1,c.style.position="",c.style.left="",c.style.top="",c.style.minWidth="",c.style.zIndex=""),window.removeEventListener("mousedown",b,{capture:!0}),window.removeEventListener("scroll",k,!0),window.removeEventListener("resize",k)}function h(){c.dataset.open==="true"?g():f()}function b(T){const S=T.target;a.contains(S)||c.contains(S)||g()}function k(){c.dataset.open==="true"&&x()}function x(){const T=o.getBoundingClientRect(),S=c.getBoundingClientRect(),W=window.innerHeight,C=window.innerWidth,L=8,_=4,N=Math.max(S.width,T.width);let H=Math.min(Math.max(T.left,L),Math.max(L,C-N-L));const at=W-T.bottom-L,dt=T.top-L;let ut=!1,It=Math.min(360,Math.max(at-_,120));S.height>at&&dt>at&&(ut=!0,It=Math.min(360,Math.max(dt-_,120)));let Pt;ut?(Pt=Math.max(L,T.top-_-Math.min(S.height,It)),c.dataset.placement="top",c.style.setProperty("--dd-transform","translateY(-4px)")):(Pt=Math.min(W-L-Math.min(S.height,It),T.bottom+_),c.dataset.placement="bottom",c.style.setProperty("--dd-transform","translateY(4px)")),c.style.top=`${Math.round(Pt)}px`,c.style.left=`${Math.round(H)}px`,c.style.maxHeight=`${It}px`,c.style.overflowY="auto"}function w(T){if(T===n){g(),o.focus();return}n=T,i.textContent=r.find(S=>S.value===n)?.label??"",g(),o.focus(),t.onChange(n)}function B(T){const S=Array.from(c.querySelectorAll(".dropdown__item")),W=S.indexOf(T);S[Math.min(S.length-1,W+1)]?.focus()}function P(T){const S=Array.from(c.querySelectorAll(".dropdown__item")),W=S.indexOf(T);S[Math.max(0,W-1)]?.focus()}o.addEventListener("click",()=>h()),o.addEventListener("keydown",T=>{if(T.key==="ArrowDown"||T.key==="Enter"||T.key===" ")T.preventDefault(),f();else if(T.key==="ArrowUp"){T.preventDefault(),f();const S=c.querySelectorAll(".dropdown__item");S[S.length-1]?.focus()}});function q(T){r=T;const S=r.find(W=>W.value===n);S?i.textContent=S.label:i.textContent="",c.dataset.open==="true"&&p()}return a.append(o,c),{el:a,get value(){return n},set value(T){w(T)},updateItems:q}}let gn=!1;function _n(){if(gn)return;const t=`
  :root {
    --fc-radius: 6px;
    --fc-border: #cfcfcf;
    --fc-border-hover: #b5b5b5;
    --fc-border-focus: #2196f3;
    --fc-bg: #ffffff;
    --fc-bg-disabled: #f7f7f7;
    --fc-text: #111;
    --fc-placeholder: #9aa0a6;
    --fc-shadow-focus: 0 0 0 3px rgba(33,150,243,0.15);
  }

  .input, .select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    box-sizing: border-box;
    font: inherit;
    color: var(--fc-text);
    background: var(--fc-bg);
    border: 1px solid var(--fc-border);
    border-radius: var(--fc-radius);
    outline: none;
    transition: border-color .2s ease, box-shadow .2s ease, background .2s ease, transform .15s ease;
  }

  .input::placeholder {
    color: var(--fc-placeholder);
  }

  .input:hover, .select:hover {
    border-color: var(--fc-border-hover);
  }

  .input:focus, .select:focus {
    border-color: var(--fc-border-focus);
    box-shadow: var(--fc-shadow-focus);
  }

  /* Sizes */
  .fc--sm { height: 28px; padding: 4px 8px; font-size: 12px; }
  .fc--md { height: 34px; padding: 6px 10px; font-size: 14px; }
  .fc--lg { height: 40px; padding: 8px 12px; font-size: 16px; }

  /* Full width helper */
  .fc--full { width: 100%; }

  /* Number inputs: right align helper */
  .fc--num-right { text-align: right; }

  /* Disabled */
  .input:disabled, .select:disabled { background: var(--fc-bg-disabled); color: #888; cursor: not-allowed; }

  /* Select arrow */
  .select {
    background-image: url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5' stroke='%23888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 16px 16px;
    padding-right: 28px; /* space for arrow */
  }

  /* Remove default arrow on some browsers */
  .select::-ms-expand { display: none; }
  `,e=document.createElement("style");e.id="form-control-styles",e.textContent=t,document.head.appendChild(e),gn=!0}function xo(t,e){_n(),t.classList.add("input");const n=e?.size;t.classList.add(wo(n)),t.classList.add("fc--full"),e?.rightAlign&&t.classList.add("fc--num-right")}function wo(t){return t==="sm"?"fc--sm":t==="lg"?"fc--lg":"fc--md"}function Mo(t){const e=document.createElement("div");e.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
   `;const n=document.createElement("div");n.style.cssText=`
      background: #fff;
      padding: 24px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
   `;const r=document.createElement("div");r.style.cssText=`
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #eee;
      padding: 8px;
      margin-bottom: 16px;
   `;const a=document.createElement("div");a.style.cssText=`
            display: flex;
            align-items: center;
            gap: 8px;
        `;const o=document.createElement("label");o.setAttribute("for","convertFilenameInput"),o.textContent=y[v].convertFilenameLabel||"파일명",o.setAttribute("data-i18n","convertFilenameLabel"),o.style.cssText=`
            min-width: 72px;
            color: #666;
            font-size: 12px;
        `;const i=document.createElement("input");i.type="text",i.id="convertFilenameInput",i.placeholder=y[v].convertFilenamePlaceholder||"예: my-song.txt",i.setAttribute("data-i18n-placeholder","convertFilenamePlaceholder"),i.style.cssText=`
            flex: 1 1 auto;
            padding: 6px 8px;
            border: 1px solid #cfcfcf;
            border-radius: 6px;
            font-size: 12px;
        `;const d=new Date().toISOString().replace(/[:.]/g,"-");i.value=`mml-${d}.txt`,a.append(o,i);const c=document.createElement("div");c.style.cssText=`
            display: flex;
            align-items: center;
            gap: 8px;
        `;const l=document.createElement("input");l.type="checkbox",l.id="convertMidTempoFix",l.style.cursor="pointer";const m=document.createElement("label");m.htmlFor="convertMidTempoFix",m.textContent="중간템포버그수정",m.style.cssText=`
            color: #666;
            font-size: 12px;
        `;let p=l.checked;l.addEventListener("change",()=>{const C=l.checked;!p&&C?W():p&&!C&&S(),p=C}),c.append(l,m);const f=document.createElement("textarea");f.style.cssText=`
            width: 100%;
            min-height: 200px;
            box-sizing: border-box;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            word-break: break-all;
            overflow-y: auto;
        `,f.readOnly=!0;const g=document.createElement("div");g.style.cssText=`
      display: flex;
      justify-content: flex-end;
      gap: 8px;
   `,$t();const h=_t({label:y[v].convertCopy,variant:"primary",attrs:{"data-i18n":"convertCopy"}}),b=_t({label:y[v].convertSaveTxt,variant:"secondary",attrs:{"data-i18n":"convertSaveTxt"}}),k=_t({label:y[v].modalClose,variant:"secondary",attrs:{"data-i18n":"modalClose"}});g.append(h,b,k),n.append(r,a,c,f,g),e.appendChild(n),document.body.appendChild(e);function x(){window.removeEventListener("keydown",w,!0),e.parentNode&&document.body.removeChild(e)}function w(C){C.key==="Escape"&&x()}r.innerHTML="";let B=[];const P=new Map,q=()=>{let L=f.value||"";L.startsWith("MML@")&&(L=L.slice(4)),L.endsWith(";")&&(L=L.slice(0,-1));const _=L.length>0?L.split(",").map(N=>N.trim()):[];for(const N of t.tracks){const H=P.get(N.id);if(!H)continue;const at=B.indexOf(N.id),dt=at>=0&&at<_.length?_[at].length:0;H.textContent=`${N.name} (${dt}${y[v].charUnit})`}};[...t.tracks].slice().sort((C,L)=>C.order-L.order).forEach(C=>{const L=document.createElement("div");L.style.cssText=`
            display: flex;
            align-items: center;
            margin-bottom: 8px;
         `;const _=document.createElement("input");_.type="checkbox",_.id=`track-${C.id}`,_.value=String(C.id),_.checked=C.notes.length>0,_.disabled=C.notes.length===0,_.style.margin="0 4px 0 0",_.style.cursor="pointer";const N=document.createElement("label");N.htmlFor=`track-${C.id}`,P.set(C.id,N),N.textContent=`${C.name}`,N.style.cssText=`
                margin-left: 8px;
                ${C.notes.length===0?"color: #aaa;":""}
            `,_.addEventListener("change",()=>{S(),q()}),L.append(_,N),r.appendChild(L)});function T(C,L){const _=C.slice().sort((H,at)=>H.order-at.order),N=[];for(const H of _){if(!(Array.isArray(H.notes)&&H.notes.length>0))continue;const dt=t.tempoAnchors;let ut=po(H.notes??[],dt??[],L)||In(H.notes??[])||Qe(H.notes??"")||"";ut&&(ut=Pn(ut,!0)||ut),ut&&N.push(ut)}return`MML@${N.join(",")};`}function S(){const C=[];r.querySelectorAll('input[type="checkbox"]').forEach(N=>{N.checked&&C.push(parseInt(N.value))});const L=t.tracks.filter(N=>C.includes(N.id));B=L.slice().sort((N,H)=>N.order-H.order).map(N=>N.id);const _=T(L,t.bpm);f.value=_,q()}function W(){let C=f.value;if(!C.startsWith("MML@")||!C.endsWith(";"))return;const L=C.slice(4,-1),_=L.length>0?L.split(",").map(N=>N.trim()).filter(N=>N.length>0):[];if(_.length>=2){const N=()=>({c:0,d:0,e:0,f:0,g:0,a:0,b:0,r:0,n:0}),H=M=>M.split(/t\s*[1-9]\d*/i).filter(Boolean),at=M=>{const A=N(),V=M.toLowerCase();for(let I=0;I<V.length;I++)switch(V[I]){case"c":A.c++;break;case"d":A.d++;break;case"e":A.e++;break;case"f":A.f++;break;case"g":A.g++;break;case"a":A.a++;break;case"b":A.b++;break;case"r":A.r++;break;case"n":A.n++;break}return A};_.map(M=>{const A=H(M).map(at),V=A.reduce((I,X)=>({c:I.c+X.c,d:I.d+X.d,e:I.e+X.e,f:I.f+X.f,g:I.g+X.g,a:I.a+X.a,b:I.b+X.b,r:I.r+X.r,n:I.n+X.n}),N());return{perSegment:A,total:V}});const dt=_.map(M=>H(M)),ut=M=>{const A=M.split(/(t\s*[1-9]\d*)/ig),V=[];let I=[];for(let X=0;X<A.length;X++){const Z=A[X];X%2===1?Z&&I.push(Z):Z&&Z.length>0&&(V.push(I),I=[])}return{tempoBefore:V,trailing:I}},It=_.map(M=>ut(M)),Pt=dt.length>0?Math.min(...dt.map(M=>M.length)):0,pe=Array.from({length:Pt},(M,A)=>dt.map(V=>V[A])),dn=pe.map(M=>M.map(A=>at(A))),un=M=>M.c+M.d+M.e+M.f+M.g+M.a+M.b+M.r+M.n;pe.map((M,A)=>M.map((V,I)=>[V,un(dn[A][I])]));const Ce=(M,A,V)=>{if(V<=0)return M==="r"?`r${A}`:`${M}${A}`;const X=1<<Math.floor(Math.log2(V+1)),Z=A*X,mt=V-(X-1),O=[];for(let U=0;U<X;U++)U<Math.min(mt,X)?O.push(Z*2,Z*2):O.push(Z);let tt="",pt=-1;const Tt=U=>{pt!==U&&(tt+=`l${U}`,pt=U)};if(M==="r"){for(let U=0;U<O.length;U++)Tt(O[U]),tt+="r";return tt}else{for(let U=0;U<O.length;U++)Tt(O[U]),U>0&&(tt+="&"),tt+=M;return tt}},Ae=M=>{let A=null;const V=/l\s*(\d+)/ig;let I;for(;I=V.exec(M);)A=parseInt(I[1],10);return A},ro=(M,A)=>{if(A<=0)return M;const I=/r(\d+)/i.exec(M);if(I){const tt=parseInt(I[1],10),pt=M.slice(0,I.index),Tt=Ae(pt);let U=Ce("r",tt,A);return U+=`l${Tt??4}`,pt+U+M.slice(I.index+I[0].length)}const Z=/r(?!\d)/i.exec(M);if(Z){const pt=M.slice(0,Z.index),Tt=Ae(pt);let U=Ce("r",8,A);return U+=`l${Tt??4}`,pt+U+M.slice(Z.index+1)}const O=/([cdefgabn])(\d+)/i.exec(M);if(O){const tt=O[1],pt=parseInt(O[2],10),Tt=M.slice(0,O.index),U=Ae(Tt);let fe=Ce(tt,pt,A);return fe+=`l${U??4}`,Tt+fe+M.slice(O.index+O[0].length)}return M},ao=pe.map((M,A)=>{if(A===pe.length-1)return M.slice();const I=dn[A].map(un),X=Math.max(...I);try{const Z=I.map(mt=>X-mt);console.log(`[tempo-fix] group ${A}: counts per track = [${I.join(", ")}], target=${X}, needs=[${Z.join(", ")}]`)}catch{}return M.map((Z,mt)=>{const O=I[mt],tt=X-O;return ro(Z,tt)})}),io=_.map((M,A)=>{const V=ao.map(O=>O[A]||""),I=(dt[A]||[]).slice(Pt),{tempoBefore:X,trailing:Z}=It[A],mt=[];for(let O=0;O<V.length;O++){const tt=X[O]||[];tt.length&&mt.push(tt.join("")),mt.push(V[O])}for(let O=0;O<I.length;O++){const tt=V.length+O,pt=X[tt]||[];pt.length&&mt.push(pt.join("")),mt.push(I[O])}return Z&&Z.length&&mt.push(Z.join("")),mt.join("")});f.value=`MML@${io.join(",")};`,q()}}S(),k.onclick=x,e.onclick=C=>{C.target===e&&x()},h.onclick=()=>{navigator.clipboard.writeText(f.value),h.textContent=y[v].copied,setTimeout(()=>{h.textContent=y[v].convertCopy},2e3)},b.onclick=()=>{try{const C=new Blob([f.value],{type:"text/plain;charset=utf-8"}),L=document.createElement("a");L.href=URL.createObjectURL(C);const _=(i.value||"").trim(),N=`mml-${new Date().toISOString().replace(/[:.]/g,"-")}.txt`;let H=_.length>0?_:N;H=H.replace(/[\\\/:*?"<>|]/g,"_"),/\.txt$/i.test(H)||(H+=".txt"),L.download=H,document.body.appendChild(L),L.click(),setTimeout(()=>{URL.revokeObjectURL(L.href),L.parentNode&&L.parentNode.removeChild(L)},0)}catch{}},window.addEventListener("keydown",w,!0)}function bn(){const t=document.createElement("div");t.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `;const e=document.createElement("div");e.id="guideModalContent",e.style.cssText=`
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        max-width: 600px;
        width: 90%;
        max-height: 80%;
        overflow-y: auto;
        position: relative;
    `,$t();const n=_t({label:"✕",variant:"ghost",size:"sm",title:y[v].modalClose,attrs:{"data-i18n-title":"modalClose"}});n.style.position="absolute",n.style.top="10px",n.style.right="10px";const r=o=>{o.key==="Escape"&&a()};function a(){window.removeEventListener("keydown",r,!0),t.parentNode&&document.body.removeChild(t)}n.onclick=a,ho(e),e.appendChild(n),t.appendChild(e),document.body.appendChild(t),window.addEventListener("keydown",r,!0)}let St=null,gt=null,Qt=null,te=null,Yt=null;function To(t,e,n){if(St||Lo(),!St||!gt||!Qt||!te)return;gt.value=(n??t.mmlString)||"",St.style.display="flex",gt.focus();const r=o=>{o.stopPropagation()};gt.addEventListener("keydown",r),gt.addEventListener("keyup",r);function a(){St.style.display="none",gt.removeEventListener("keydown",r),gt.removeEventListener("keyup",r),Qt.onclick=null,te.onclick=null,Yt&&(window.removeEventListener("keydown",Yt,!0),Yt=null)}Qt.onclick=()=>{e(gt.value),a()},te.onclick=a,Yt=o=>{o.key==="Escape"&&(o.stopPropagation(),a())},window.addEventListener("keydown",Yt,!0)}function Lo(){St=document.createElement("div"),St.id="mmlEditModal",St.style.cssText=`
    position: fixed; 
    left: 0; top: 0; 
    width: 100vw; 
    height: 100vh;
    background: rgba(0,0,0,0.25); 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    z-index: 200;
    display: none;
  `;const t=document.createElement("div");t.style.cssText=`
            background: #fff;
            padding: 24px;
            border-radius: 8px;
            min-width: 400px;
            box-shadow: 0 2px 16px #0002;
            display: flex;
            flex-direction: column;
            gap: 12px;
        `,gt=document.createElement("textarea"),gt.style.cssText=`
            width: 100%;
            min-height: 120px;
            font-family: monospace;
            font-size: 15px;
            word-break: break-all;
            overflow-x: wrap;
        `,$t(),Qt=_t({label:y[v].ok,variant:"primary",attrs:{"data-i18n":"ok"}}),te=_t({label:y[v].cancel,variant:"secondary",attrs:{"data-i18n":"cancel"}});const e=document.createElement("div");e.style.cssText=`
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        `,e.append(te,Qt),t.append(gt,e),St.appendChild(t),document.body.appendChild(St)}function Eo(){return{scrollX:0,scrollY:0,keyHeight:16,activeTrackId:1,selectedLength:16,hover:{noteId:null,edge:null},drag:null,ghost:null,ghostGroup:null,selected:new Set,marquee:{active:!1,x0:0,y0:0,x1:0,y1:0,mode:"replace"},clipboard:null,volumeLabels:new Set}}function So(t,e,n,r,a,o,i){t.save();const d=window.devicePixelRatio||1;t.setTransform(d,0,0,d,0,0);const c=t.canvas.clientWidth||t.canvas.width/d,l=t.canvas.clientHeight||t.canvas.height/d;t.clearRect(0,0,c,l),Io(t,e,n,r,a),No(t,n,e,r),_o(t,e,n,r,a),zo(t,e,n,r,a),Ro(t,n,r),Bo(t,e,r,a,l),t.restore()}function zn(t,e,n,r,a){const o=window.devicePixelRatio||1;t.setTransform(o,0,0,o,0,0);const i=e.clientWidth||e.width/o,d=e.clientHeight||e.height/o;t.clearRect(0,0,i,d),t.fillStyle="#ffffff",t.fillRect(0,0,i,d);const c=84*r.keyHeight;Co(t,0,i,r),Ao(t,n,0,i,c,a)}function ee(t,e,n,r,a,o){const i=Math.max(0,Math.min(o,Math.floor(Math.min(r,a)/2))),d=Math.floor(e),c=Math.floor(n),l=d+Math.max(0,r),m=c+Math.max(0,a);if(t.beginPath(),i<=0){t.rect(d,c,r,a);return}t.moveTo(d+i,c),t.lineTo(l-i,c),t.arcTo(l,c,l,c+i,i),t.lineTo(l,m-i),t.arcTo(l,m,l-i,m,i),t.lineTo(d+i,m),t.arcTo(d,m,d,m-i,i),t.lineTo(d,c+i),t.arcTo(d,c,d+i,c,i)}function Co(t,e,n,r){const a=r.keyHeight,o=84*a,i=Math.ceil(o/a);for(let d=0;d<i;d++){const c=d*a,m=((95-d)%12+12)%12,p=m===1||m===3||m===6||m===8||m===10;t.fillStyle=p?"#d6d6d6":"#ffffff",t.fillRect(e,c,Math.max(0,n),a);const f=m===11;t.strokeStyle=f?"#000000":"rgb(153,153,153)",t.beginPath(),t.moveTo(e,c+.5),t.lineTo(e+Math.max(0,n),c+.5),t.stroke()}}function Ao(t,e,n,r,a,o){const i=$[e.zoomLevel-1],d=o&&o>=1?o:e.timeSig.beatsPerBar,c=Math.max(0,Math.floor(n/i)-2),l=Math.floor((n+r)/i)+2;for(let p=c;p<=l;p++){const f=Math.floor(p*i),g=p%d===0;t.strokeStyle=g?"#000":"rgb(128,128,128)",t.beginPath(),t.moveTo(f,0),t.lineTo(f,a),t.stroke()}const m=e.zoomLevel;m>=4&&Be(t,n,r,a,i,2,"rgb(191,191,191)"),m>=6&&Be(t,n,r,a,i,4,"rgb(191,191,191)"),m>=8&&Be(t,n,r,a,i,8,"rgb(191,191,191)")}function Be(t,e,n,r,a,o,i){const d=Math.max(0,Math.floor(e/a)-2),c=Math.floor((e+n)/a)+2;t.strokeStyle=i;for(let l=d;l<=c;l++)for(let m=1;m<o;m+=2){const p=Math.floor((l+m/o)*a);t.beginPath(),t.moveTo(p,0),t.lineTo(p,r),t.stroke()}}function Bo(t,e,n,r,a){const o=e.tempoAnchors||[];if(!o||o.length===0)return;const i=$[e.zoomLevel-1];t.save(),t.strokeStyle="rgba(159, 215, 255, 0.9)",t.lineWidth=1;for(const d of o){const c=Math.round(d.tick/E*i);if(c+1<n||c-1>n+r)continue;const l=c-Math.floor(n)+.5;t.beginPath(),t.moveTo(l,0),t.lineTo(l,a),t.stroke()}t.restore()}function Io(t,e,n,r,a){const o=$[e.zoomLevel-1],i=n.activeTrackId,d=[...e.tracks].sort((c,l)=>c.id===i?1:l.id===i?-1:0);for(const c of d){const l=c.id===i?1:.5;t.globalAlpha=l;for(const m of c.notes){const p=Math.round(m.startTick/E*o),f=Math.max(1,Math.round(m.durationTick/E*o));if(p+f<r||p>r+a)continue;const g=p-Math.floor(r);Po(t,g,m,c.color,o,n.keyHeight,n.hover,c.id===i,n.selected.has(m.id))}}t.globalAlpha=1}function Po(t,e,n,r,a,o,i,d,c){const l=Math.max(1,Math.round(n.durationTick/E*a)),m=(95-n.pitch)*o+1,p=o-1,f=Math.min(6,Math.floor(p/2));if(t.fillStyle=r,ee(t,e,m,l,p,f),t.fill(),t.strokeStyle="rgba(0,0,0,0.3)",t.lineWidth=1,ee(t,e,m,l-1,p-1,Math.max(0,f-1)),t.stroke(),c&&(t.strokeStyle="#3a7afe",t.lineWidth=2,ee(t,e,m,l-1,p-1,Math.max(0,f-1)),t.stroke(),t.lineWidth=1),d&&i.noteId===n.id){const g=Math.min(8,Math.floor(l/3));t.fillStyle="rgba(0,0,0,0.15)",t.fillRect(e,m,g,p),t.fillRect(e+l-g,m,g,p)}}function No(t,e,n,r){const a=$[n.zoomLevel-1],o=i=>{const d=Math.round(i.startTick/E*a)-Math.floor(r),c=Math.max(1,Math.round(i.durationTick/E*a)),l=(95-i.pitch)*e.keyHeight+1,m=e.keyHeight-1;t.globalAlpha=.7,t.fillStyle=i.color;const p=Math.min(6,Math.floor(m/2));ee(t,d,l,c,m,p),t.fill(),t.globalAlpha=1};if(e.ghost&&o(e.ghost),e.ghostGroup)for(const i of e.ghostGroup)o(i)}function _o(t,e,n,r,a){const o=$[e.zoomLevel-1],i=n.keyHeight;t.strokeStyle="#3a7afe",t.lineWidth=2;for(const d of e.tracks)for(const c of d.notes){if(!n.selected.has(c.id))continue;const l=Math.round(c.startTick/E*o)-Math.floor(r),m=Math.max(1,Math.round(c.durationTick/E*o)),p=l+Math.floor(r);if(p+m<r||p>r+a)continue;const f=(95-c.pitch)*i+1,g=i-1,h=Math.min(6,Math.floor(g/2));ee(t,l,f,m-1,g-1,Math.max(0,h-1)),t.stroke()}t.lineWidth=1}function zo(t,e,n,r,a){if(!n.volumeLabels||n.volumeLabels.size===0)return;const o=$[e.zoomLevel-1],i=n.keyHeight;t.font="10px sans-serif",t.textAlign="left",t.textBaseline="bottom";for(const d of e.tracks)for(const c of d.notes){if(!n.volumeLabels.has(c.id))continue;const l=Math.round(c.startTick/E*o),m=Math.max(1,Math.round(c.durationTick/E*o));if(l+m<r||l>r+a)continue;const p=l-Math.floor(r),f=(95-c.pitch)*i+1,g="V"+String(c.volume??D);t.fillStyle="rgba(255,255,255,0.9)",t.fillText(g,p+1,f-1),t.fillStyle="rgba(0,0,0,0.85)",t.fillText(g,p,f-2)}}function Ro(t,e,n){if(!e.marquee.active)return;const r=Math.min(e.marquee.x0,e.marquee.x1)-Math.floor(n),a=Math.min(e.marquee.y0,e.marquee.y1),o=Math.abs(e.marquee.x1-e.marquee.x0),i=Math.abs(e.marquee.y1-e.marquee.y0);t.fillStyle="rgba(58,122,254,0.15)",t.fillRect(r,a,o,i),t.strokeStyle="rgba(58,122,254,0.8)",t.setLineDash([4,3]),t.strokeRect(r+.5,a+.5,o-1,i-1),t.setLineDash([])}function Oe(t,e,n,r,a){for(let o=n.length-1;o>=0;o--){const i=n[o],d=Math.round(i.startTick/E*r),c=Math.max(1,Math.round(i.durationTick/E*r)),l=(95-i.pitch)*a+1,m=a-1;if(t>=d&&t<=d+c&&e>=l&&e<=l+m){const p=Math.min(8,Math.floor(c/3)),f=t<=d+p?"left":t>=d+c-p?"right":"center";return{note:i,edge:f}}}}function Do(t,e,n,r,a,o,i){const d=Math.min(t,n),c=Math.max(t,n),l=Math.min(e,r),m=Math.max(e,r),p=[];for(const f of a){const g=Math.round(f.startTick/E*o),h=Math.max(1,Math.round(f.durationTick/E*o)),b=(95-f.pitch)*i+1,k=i-1,x=g+h,w=b+k;x>=d&&g<=c&&w>=l&&b<=m&&p.push(f)}return p}function Wo(t,e,n){t.clearRect(0,0,e.width,e.height);const r=window.devicePixelRatio||1,a=12*n;for(let o=0;o<7;o++){const i=(6-o)*a,d=o%2===1;t.fillStyle=d?"#e6e6e6":"#ffffff",t.fillRect(0,i,e.width/r,a),t.fillStyle="#222",t.font=`${Math.max(10,Math.round(12))}px system-ui, sans-serif`,t.textBaseline="middle",t.textAlign="center";const c="o"+(o+1),l=i+a/2;t.fillText(c,Math.floor(e.width/r/2),Math.floor(l))}}function Ho(t,e,n,r,a,o,i){const d=e.width,c=e.height,l=window.devicePixelRatio||1;t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,d,c),l!==1&&t.setTransform(l,0,0,l,0,0);const m=d/l,p=c/l;t.fillStyle="#ffffff",t.fillRect(0,0,m,p);const f=Math.floor(n/r),g=Math.ceil((n+m)/r);for(let k=f;k<=g;k++){const x=Math.round(k*r-n)+.5;if(k%a===0){t.strokeStyle="#000000",t.beginPath(),t.moveTo(x,0),t.lineTo(x,p),t.stroke();const B=Math.floor(k/a)+1;t.fillStyle="#222",t.font="12px system-ui, sans-serif",t.textAlign="left",t.textBaseline="top",t.fillText(String(B),x+4,2)}else{t.strokeStyle="rgb(128,128,128)";const B=Math.floor(p*.5);t.beginPath(),t.moveTo(x,B),t.lineTo(x,p),t.stroke()}}const h=o,b=h&&Array.isArray(h.tempoAnchors)?h.tempoAnchors:[];if(b&&b.length>0){t.save();const k=Math.max(9,Math.min(13,Math.floor(p*.6)));t.font=`${k}px system-ui, sans-serif`,t.textAlign="center",t.textBaseline="middle";for(const x of b){const w=x.tick/E*r,B=Math.round(w-n)+.5;if(B<-40||B>m+40)continue;const P=i!=null&&x.tick===i,q="t"+String(x.bpm),T=t.measureText(q),S=(T.actualBoundingBoxAscent||k*.8)+(T.actualBoundingBoxDescent||k*.2),W=Math.max(4,Math.floor(k*.5)),C=Math.max(2,Math.floor(k*.3)),L=Math.ceil(S)+C*2,_=Math.ceil(T.width)+W*2;let H=p-L-2;H<.5&&(H=.5);const at=Math.floor(B-_/2)+.5,dt=P?"#7cc7ff":"#bfe7ff",ut=P?"#2f9dff":"#5bb6ff",It="#003";t.fillStyle=dt,t.strokeStyle=ut,t.lineWidth=1,t.beginPath(),t.rect(at,H,_,L),t.fill(),t.stroke(),t.fillStyle=It;const Pt=H+L/2;t.fillText(q,B,Math.floor(Pt))}t.restore()}}function kn(t,e,n){const r=window.devicePixelRatio||1,a=e.clientHeight||e.height/r;t.save(),t.setTransform(r,0,0,r,0,0),t.strokeStyle="rgba(255,0,0,0.9)",t.lineWidth=2,t.beginPath(),t.moveTo(Math.floor(n)+.5,0),t.lineTo(Math.floor(n)+.5,a),t.stroke(),t.restore()}function Xo(t,e,n,r){const a=window.devicePixelRatio||1,o=e.clientHeight||e.height/a;t.save(),t.setTransform(a,0,0,a,0,0),t.fillStyle="rgba(255,0,0,0.12)",t.fillRect(Math.floor(n),0,Math.ceil(r),o),t.restore()}function Oo(t,e){const n=document.createElement("div");n.style.cssText=`
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    `;const r=document.createElement("div");r.style.cssText=`
        background: #fff;
        width: min(640px, 92vw);
        max-height: 80vh;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        padding: 18px 18px 14px;
        position: relative;
        overflow: auto;
    `;const a=document.createElement("h2");a.textContent=y[v].whatsNewTitle||"What's new",a.style.margin="0 0 8px 0",a.style.fontSize="18px",a.setAttribute("data-i18n","whatsNewTitle");const o=document.createElement("div"),i=document.createElement("h3");i.textContent=y[v].whatsNew_20250827_heading||"Load behavior changed",i.setAttribute("data-i18n","whatsNew_20250827_heading"),i.style.margin="8px 0 6px 0";const d=document.createElement("ul");d.style.margin="6px 0 0 18px",d.style.padding="0";const c=document.createElement("li");c.textContent=y[v].whatsNew_20250827_p1||"Removed auto-load on page start.",c.setAttribute("data-i18n","whatsNew_20250827_p1");const l=document.createElement("li");l.textContent=y[v].whatsNew_20250827_p2||"Use the 'Load' button in the toolbar to restore saved work.",l.setAttribute("data-i18n","whatsNew_20250827_p2"),d.append(c,l),o.append(i,d),$t();const m=_t({label:y[v].ok||"OK",size:"sm",variant:"primary"});m.setAttribute("data-i18n","ok"),m.style.marginTop="12px",m.style.alignSelf="flex-end";const p=()=>{n.remove();try{localStorage.setItem("mml_editor_whatsnew_shown_"+t,"1")}catch{}};m.addEventListener("click",p);const f=g=>{g.key==="Escape"&&p()};window.addEventListener("keydown",f,{once:!0}),n.addEventListener("click",g=>{g.target===n&&p()}),r.append(a,o,m),n.appendChild(r),document.body.appendChild(n)}const Ft=document.getElementById("footerMmlEditBtn"),Ie=document.getElementById("footerMMLText"),Wt=document.getElementById("footerLabel"),he=document.getElementById("btnPasteMML"),Rn="mml_editor_project";let u=Sn();const zt=new so,s=Eo(),tn=new Worker(new URL(""+new URL("mmlOptimizerWorker-DYK2yqxc.js",import.meta.url).href,import.meta.url),{type:"module"}),Pe=new Map,$o=300;let Ne=null;const yn=document.getElementById("progress"),K=document.getElementById("roll"),ot=document.getElementById("rollBg"),ft=document.getElementById("octaveCanvas");let z=null,nt=null,jt=null,Jt=null,Ht=null;const R=document.getElementById("timeRuler"),bt=K.getContext("2d"),we=ot?ot.getContext("2d"):null,Dn=ft.getContext("2d"),$e=R.getContext("2d"),vn=document.getElementById("tracks"),ne=document.getElementById("lenBar"),et=document.getElementById("dispSigN");let st=4;const xn="mml_editor_display_timesig_n",Y=document.getElementById("rollViewport"),At=document.getElementById("rulerContainer"),Zt=document.getElementById("customScrollbar"),oe=document.getElementById("customScrollbarThumb"),qe=document.getElementById("btnPlay"),Fe=document.getElementById("btnPause"),Ue=document.getElementById("btnStop"),Et=document.getElementById("btnPlayheadMode"),ge=document.getElementById("btnConvert");let re=null;function qo(){if(!re){const t=document.createElement("div");t.style.cssText="position:absolute;pointer-events:none;background:rgba(0,0,0,0.8);color:#fff;padding:4px 6px;border-radius:4px;font:12px system-ui, sans-serif;z-index:10;transform:translate(-50%, -120%);white-space:nowrap;display:none;",At.style.position="relative",At.appendChild(t),re=t}return re}const ae=document.getElementById("btnGuide"),Lt=document.getElementById("btnLoad"),Ve=document.getElementById("btnGoToMobile"),be=document.getElementById("langKo"),ke=document.getElementById("langJa"),ye=document.getElementById("langEn"),Fo=document.getElementById("btnPushBeat"),Uo=document.getElementById("btnPushBar"),Vo=document.getElementById("btnCutBeat"),Ko=document.getElementById("btnCutBar"),kt=document.getElementById("keyHeightRange"),Ut=document.getElementById("keyHeightLabel"),vt="rgba(255,215,0,0.8)";let J=!1,ct=0,Ke=0,Ot=!1,Go=0,ie=0,se=0,en=!1,le=null;function Bt(){const t=document.getElementById("rulerContextMenu");t&&t.parentNode&&t.parentNode.removeChild(t)}const xt={pitch:null,sampler:null};let Rt=-1,Nt="area";const Wn="mml_editor_key_height";(()=>{const t=()=>{try{Cn()}catch{}finally{window.removeEventListener("pointerdown",t),window.removeEventListener("keydown",t)}};window.addEventListener("pointerdown",t,{passive:!0}),window.addEventListener("keydown",t)})();const Q=document.createElement("button");Ve&&Ve.addEventListener("click",()=>{try{window.location.href="./mobile.html"}catch{}});function Vt(){const t=document.activeElement;if(!t)return;const e=t.tagName.toLowerCase();if((e==="input"||e==="select"||e==="textarea"||e==="button"||t.isContentEditable)&&!t.closest("#rollViewport, #roll, #rollBg, #timeRuler, #rulerContainer"))try{t.blur()}catch{}}function Hn(t){const e=t.target;return e?!!e.closest("#rollViewport, #roll, #rollBg, #timeRuler, #rulerContainer"):!1}function wn(t){const e={bpm:120,timeSig:{beatsPerBar:4},zoomLevel:1,tracks:[],maxEndTick:0,tpqn:t?.tpqn??E,extendedUnitsEnabled:t?.extendedUnitsEnabled??ht},n=Number(t?.bpm);e.bpm=Number.isFinite(n)&&n>0?n:120;const r=Number(t?.timeSig?.beatsPerBar);e.timeSig={beatsPerBar:Number.isFinite(r)&&r>=1?r:4};const a=Number(t?.zoomLevel);e.zoomLevel=Number.isFinite(a)&&a>=1&&a<=9?a:1;try{const c=Number(t?.displayBeatsPerBar);e.displayBeatsPerBar=Number.isFinite(c)&&c>=1&&c<=16?c:void 0}catch{}try{const l=(Array.isArray(t?.tempoAnchors)?t.tempoAnchors:[]).map(f=>({tick:Math.max(0,Math.floor(Number(f?.tick)||0)),bpm:Math.max(20,Math.min(Xe,Math.round(Number(f?.bpm)||e.bpm)))})),m=new Map;for(const f of l)m.set(f.tick,f.bpm);const p=Array.from(m.entries()).map(([f,g])=>({tick:f,bpm:g})).sort((f,g)=>f.tick-g.tick);e.tempoAnchors=p}catch{e.tempoAnchors=[]}const o=Array.isArray(t?.tracks)?t.tracks:[],i=Math.max(1,Math.min(6,o.length||6));for(let c=0;c<i;c++){const l=o[c]??{},p=(Array.isArray(l?.notes)?l.notes:[]).map(q=>{const T=typeof q?.id=="string"&&q.id?q.id:crypto.randomUUID(),S=Math.max(0,Math.floor(Number(q?.startTick)||0)),W=Math.max(1,Math.floor(Number(q?.durationTick)||1)),C=Math.max(0,Math.floor(Number(q?.pitch)||0)),L=Math.max(0,Math.min(15,Math.floor(Number(q?.volume)||D)));return{id:T,startTick:S,durationTick:W,pitch:C,volume:L}}),f=typeof l?.instrument=="string"&&je.includes(l.instrument)?l.instrument:Je,g=Number(l?.id)||c+1,h=Number.isFinite(Number(l?.order))?Number(l.order):c,b=typeof l?.name=="string"&&l.name?l.name:`Track ${c+1}`,k=typeof l?.color=="string"&&l.color?l.color:De[c%De.length],x=!!l?.mute,w=!!l?.solo,B=typeof l?.mmlString=="string"?l.mmlString:"",P=typeof l?.optimizedMML=="string"?l.optimizedMML:"";e.tracks.push({id:g,order:h,name:b,color:k,instrument:f,mmlString:B,optimizedMML:P,mute:x,solo:w,notes:p})}e.tracks.sort((c,l)=>c.order-l.order),e.tracks.forEach((c,l)=>{c.order=l});let d=0;for(const c of e.tracks)for(const l of c.notes)d=Math.max(d,l.startTick+l.durationTick);return e.maxEndTick=d,e}function Gt(){Ne==null&&(Ne=requestAnimationFrame(()=>{Ne=null,F()}))}function it(t,e,n){t.setAttribute("data-i18n-title",e),t.title=n||y[v][e]||""}function Mt(t,e,n){t.classList.add("btn",`btn--${e}`,`btn--${n}`)}function Xt(t){return Math.max(0,Math.min(15,t))}function ce(t){return Math.max(12,Math.min(95,t))}function Me(t){return t.sort((e,n)=>e.startTick-n.startTick||e.pitch-n.pitch)}function Xn(t){return t.sort((e,n)=>e.startTick-n.startTick||e.id.localeCompare(n.id))}function Yo(t,e){const n=e.volume??D;if(!s.volumeLabels)return;const r=Xn(t.notes.slice()),a=r.findIndex(d=>d.id===e.id),o=a>0?r[a-1].volume??D:D,i=r.slice(0,a).some((d,c,l)=>{const m=s.volumeLabels.has(d.id),p=c>0?l[c-1].volume??D:D,f=(d.volume??D)!==p;return m||f});n===D?i?s.volumeLabels.add(e.id):s.volumeLabels.delete(e.id):n!==o?s.volumeLabels.add(e.id):s.volumeLabels.delete(e.id)}function de(t){return Xn(t.notes.slice())}function On(t,e,n){if(e<0||e>=t.length)return!1;const r=t[e],a=e>0?t[e-1].volume??D:D,o=r.volume??D;return(n?.has(r.id)??!1)||o!==a}function $n(t,e,n){const r=de(t),a=r.findIndex(i=>i.id===e.id);if(a<0)return;let o=r.length;for(let i=a+1;i<r.length;i++)if(On(r,i,s.volumeLabels)){o=i;break}for(let i=a;i<o;i++)r[i].volume=Xt(n)}function jo(t,e,n){const r=de(t),a=new Map(r.map(d=>[d.id,d.volume??D])),o=r.map((d,c)=>({n:d,i:c})).filter(d=>e.has(d.n.id)).map(d=>d.i).sort((d,c)=>d-c);let i=0;for(;i<o.length;){const d=o[i];let c=i+1;for(;c<o.length&&o[c]===o[c-1]+1;)c++;const l=d,m=o[c-1],p=l>0?a.get(r[l-1].id)??D:D;for(let g=l;g<=m;g++)r[g].volume=Xt(n);let f=m+1;for(;f<r.length&&e.has(r[f].id);)f++;f<r.length&&(r[f].volume=p),i=c}}function nn(t){if(!s.volumeLabels)return;const e=de(t),n=new Set(e.map(a=>a.id));for(const a of Array.from(s.volumeLabels))n.has(a)&&s.volumeLabels.delete(a);let r=D;for(const a of e){const o=a.volume??D;o!==r&&s.volumeLabels.add(a.id),r=o}}function Jo(){if(z)return;z=document.createElement("div"),z.style.position="fixed",z.style.zIndex="10000",z.style.background="#fff",z.style.border="1px solid #ccc",z.style.boxShadow="0 4px 12px rgba(0,0,0,0.15)",z.style.borderRadius="8px",z.style.padding="10px 12px",z.style.minWidth="220px",z.style.display="none",z.addEventListener("wheel",o=>o.stopPropagation(),{passive:!1});const t=document.createElement("div");t.style.marginBottom="8px",t.textContent=(y[v].volLabel||"볼륨")+" (0-15)",nt=document.createElement("input"),nt.type="range",nt.min="0",nt.max="15",nt.step="1",nt.value=String(D),nt.style.width="100%";const e=document.createElement("div");e.style.fontSize="12px",e.style.color="#555",e.style.marginTop="6px";const n=()=>{e.textContent="V"+(nt?.value??String(D))};nt.addEventListener("input",n),n();const r=document.createElement("div");r.style.display="flex",r.style.gap="8px",r.style.marginTop="10px",jt=document.createElement("button"),jt.className="btn btn--primary btn--sm",jt.textContent=y[v].volApplyRange||"변경",Jt=document.createElement("button"),Jt.className="btn btn--secondary btn--sm",Jt.textContent=y[v].volApplySelected||"선택한 노트만 변경",r.append(jt,Jt),z.append(t,nt,e,r),document.body.appendChild(z);const a=()=>{z&&(z.style.display="none"),Ht=null};document.addEventListener("keydown",o=>{z&&z.style.display!=="none"&&o.key==="Escape"&&a()}),document.addEventListener("mousedown",o=>{!z||z.style.display==="none"||z.contains(o.target)||a()}),jt.addEventListener("click",()=>{if(!Ht||!nt)return;const o=u.tracks.find(c=>c.id===s.activeTrackId);if(!o)return;const i=o.notes.find(c=>c.id===Ht);if(!i)return;const d=Xt(parseInt(nt.value,10));$n(o,i,d),j(),yt({track:o,recomputeLabels:!0}),z.style.display="none",Ht=null}),Jt.addEventListener("click",()=>{if(!nt)return;const o=u.tracks.find(d=>d.id===s.activeTrackId);if(!o)return;const i=Xt(parseInt(nt.value,10));jo(o,new Set(s.selected),i),j(),yt({track:o,recomputeLabels:!0}),z.style.display="none",Ht=null})}function on(){z&&z.style.display!=="none"&&(z.style.display="none",Ht=null)}function Zo(t,e,n){if(Jo(),!z||!nt)return;Ht=t.id;const r=t.volume??D;nt.value=String(r);const a=z.querySelector("div:nth-child(3)");a&&(a.textContent="V"+r),z.style.display="block";const o=z.getBoundingClientRect(),i=window.innerWidth,d=window.innerHeight;let c=e,l=n;c+o.width>i&&(c=Math.max(0,i-o.width-8)),l+o.height>d&&(l=Math.max(0,d-o.height-8)),z.style.left=`${c}px`,z.style.top=`${l}px`}function qn(t){const e=Math.floor(ct);if(t!==0){for(const n of u.tracks){for(const r of n.notes)(r.startTick>=e||r.startTick+r.durationTick>e)&&(r.startTick+=t);Me(n.notes)}{const n=u.tempoAnchors;if(Array.isArray(n)&&n.length>0){const r=n.map(a=>a.tick>=e?{tick:a.tick+t,bpm:a.bpm}:{...a});u.tempoAnchors=Vn(r)}}u.maxEndTick+=Math.max(0,t),j(),rn(u.tracks),rt(),Gt()}}function Fn(t){const e=Math.floor(ct);if(t!==0){for(const n of u.tracks){const r=[];for(const a of n.notes){const o=a.startTick,i=a.startTick+a.durationTick;if(i<=e)r.push(a);else{if(o>=e&&o<e+t)continue;if(o>=e+t)r.push({...a,startTick:Math.max(e,o-t)});else if(o<e&&i>e){const d=e-o;d>0&&r.push({...a,durationTick:d})}}}Me(r),n.notes=r}{const n=u.tempoAnchors;if(Array.isArray(n)&&n.length>0){const r=n.filter(a=>!(a.tick>=e&&a.tick<e+t)).map(a=>a.tick>=e+t?{tick:a.tick-t,bpm:a.bpm}:{...a});u.tempoAnchors=Vn(r)}}u.maxEndTick=Math.max(0,u.maxEndTick-t),j(),rn(u.tracks),rt(),Gt()}}function Un(){return u.timeSig.beatsPerBar}function Vn(t){const e=(t||[]).map(r=>({tick:Math.max(0,Math.floor(r.tick)),bpm:Math.round(r.bpm)}));e.sort((r,a)=>r.tick-a.tick||r.bpm-a.bpm);const n=[];for(const r of e){const a=n[n.length-1];!a||a.tick!==r.tick?n.push(r):n[n.length-1]=r}return n.length>0&&n[0].tick!==0&&(t||[]).some(a=>a.tick<=0)&&n.unshift({tick:0,bpm:n[0].bpm}),n.sort((r,a)=>r.tick-a.tick)}function Qo(){try{u.selectedLength=s.selectedLength,u.playheadVisualMode=Nt,u.tpqn=E,u.extendedUnitsEnabled=ht,u.displayBeatsPerBar=st,u.tempoChanges&&Array.isArray(u.tempoChanges);const t={...u,tracks:u.tracks.map(e=>({id:e.id,notes:e.notes,name:e.name,instrument:e.instrument,optimizedMML:e.optimizedMML,order:e.order,mute:e.mute,solo:e.solo,color:e.color}))};return localStorage.setItem(Rn,JSON.stringify(t)),!0}catch(t){try{console.error("Save failed",t)}catch{}return!1}}let _e=null;function rt(){_e&&window.clearTimeout(_e),_e=window.setTimeout(()=>{Qo()},300)}function j(){zt.push(u),rt()}function Ct(t){const e=Pe.get(t.id);e&&clearTimeout(e);const n=setTimeout(()=>{try{tn.postMessage({track:t,tpqn:u.tpqn??E,tempoAnchors:u.tempoAnchors||[],defaultBpm:u.bpm})}catch{}Pe.delete(t.id)},$o);Pe.set(t.id,n)}function rn(t){for(const e of t)try{tn.postMessage({track:e,tpqn:u.tpqn??E,tempoAnchors:u.tempoAnchors||[],defaultBpm:u.bpm})}catch{}}function yt(t={}){const{track:e,recomputeLabels:n}=t;e&&(n&&nn(e),Ct(e),Dt()),Gt()}function an(){const t=document.querySelector(".panel.canvas-wrap");t&&(t.style.height="")}function Dt(){if(!Ie)return;const t=u.tracks.find(n=>n.id===s.activeTrackId)||u.tracks[0];let e=t&&(t.optimizedMML?.trim?.()||t.mmlString?.trim?.())||"";e=e.replace(/[\r\n]+/g,""),Ie.textContent=e,Ie.title=e}function Kn(t,e){const n=(e||"").replace(/[\r\n]+/g,"").trim();t.mmlString=n;try{let r=u.bpm;const a=n.match(/^t(\d+)/);a&&(r=parseInt(a[1],10)),t.notes=fo("MML@"+n),u.tracks[0]===t&&(u.bpm=r),nn(t),j(),Ct(t),rt(),Gt()}catch{t.notes=[]}}function tr(){const t=u.tracks.filter(a=>a.solo),e=t.length>0?t:u.tracks.filter(a=>!a.mute),n=a=>je.includes(a)?a:Je,r=[];for(const a of e){const o=n(a.instrument||"lute");for(const i of a.notes)r.push({startTick:i.startTick,durationTick:i.durationTick,pitch:i.pitch,trackId:a.id,instrumentKey:o,volume:i.volume})}return r}function er(){lt(),Zn(),Y&&new ResizeObserver(()=>{Rt=-1,F()}).observe(Y),((o,i="ghost")=>{o&&Mt(o,i,"sm")})(Ve,"secondary"),K.addEventListener("pointermove",o=>{Hn(o)&&Vt(),gr(o)}),K.addEventListener("pointerdown",o=>{Vt(),o.preventDefault(),br(o)},{passive:!1}),window.addEventListener("pointerup",yr),window.addEventListener("pointermove",kr),window.addEventListener("pointermove",o=>{window.lastPointerX=o.clientX,window.lastPointerY=o.clientY}),window.addEventListener("keydown",ir),window.addEventListener("keyup",ar),window.addEventListener("wheel",ur,{passive:!1}),window.addEventListener("contextmenu",o=>{o.preventDefault()},{passive:!1}),Y.addEventListener("scroll",dr),R.addEventListener("click",o=>{Vt(),me(o)}),R.addEventListener("pointerdown",o=>{Vt(),o.preventDefault(),wr(o)},{passive:!1}),R.addEventListener("contextmenu",o=>{o.preventDefault(),or(o)},{passive:!1}),window.addEventListener("pointermove",Mr),window.addEventListener("pointerup",Tr),R.addEventListener("mousemove",rr),R.addEventListener("mouseleave",()=>{re&&(re.style.display="none")}),qe.addEventListener("click",oo),Fe.addEventListener("click",Ye),Ue.addEventListener("click",Qn),kt?.addEventListener("input",()=>{const o=Math.max(16,Math.min(32,parseInt(kt.value,10)));if(o!==s.keyHeight){s.keyHeight=o;try{localStorage.setItem(Wn,String(o))}catch{}Ut&&(Ut.textContent=String(o)),Rt=-1,an(),F()}}),Et&&Et.addEventListener("click",()=>{Nt=Nt==="area"?"line":"area",Et&&(Et.textContent=Nt==="area"?y[v].playheadAreaLabel:y[v].playheadLineLabel),G(),rt()}),ge.addEventListener("click",nr),he.addEventListener("click",()=>{J||Lr()});let e=!1,n=0,r=0;oe.addEventListener("pointerdown",o=>{e=!0,n=o.clientX,r=s.scrollX,oe.setPointerCapture(o.pointerId)}),window.addEventListener("pointermove",o=>{if(!e||J)return;const i=o.clientX-n,d=qt(),c=Math.max(0,d-Y.clientWidth),l=Math.max(1,Zt.clientWidth-oe.clientWidth),m=c/l,p=r+i*m;s.scrollX=Le(p),G()}),window.addEventListener("pointerup",()=>{e=!1}),ae.addEventListener("click",bn),Lt&&(Mt(Lt,"secondary","md"),Lt.textContent=y[v].load||"Load",it(Lt,"tooltipLoad",y[v].tooltipLoad||"Load project"),Lt.addEventListener("click",()=>{try{const o=localStorage.getItem(Rn);if(!o){alert(y[v].noSavedProject||"No saved project found");return}const i=JSON.parse(o);if(!i||!i.tracks){alert(y[v].invalidSavedProject||"Saved data is invalid");return}let d=wn(i);const c=!!d.extendedUnitsEnabled;An(c);const l=c?ze:Re,m=d.tpqn||l;if(m!==l){const p=l/m;Ge(d,p)}d.tpqn=l,d.extendedUnitsEnabled=c,typeof d.selectedLength=="number"&&(s.selectedLength=d.selectedLength),(d.playheadVisualMode==="area"||d.playheadVisualMode==="line")&&(Nt=d.playheadVisualMode),d=wn(d),u=d,s.selected.clear();try{s.volumeLabels?.clear()}catch{}for(const p of u.tracks)nn(p);Dt(),lt(),F(),alert(y[v].loadedFromLocal||"Loaded from local storage")}catch(o){try{console.error("Load failed",o)}catch{}alert(y[v].loadFailed||"Load failed")}}));const a=o=>{bo(o),no(),Et&&(Et.textContent=Nt==="area"?y[v].playheadAreaLabel:y[v].playheadLineLabel),Wt&&(Wt.textContent=y[v].trackMMLLabel||(o==="ja"?"トラックMML":o==="en"?"Track MML":"트랙MML")),Lt&&(Lt.textContent=y[v].load||(o==="ja"?"読み込み":o==="en"?"Load":"불러오기"),it(Lt,"tooltipLoad",y[v].tooltipLoad||Lt.title||"Load project")),kt&&(kt.title=y[v].tooltipKeyHeight||kt.title),Ut&&(Ut.textContent=String(s.keyHeight)),lt(),Dt()};be.addEventListener("click",()=>a("ko")),ke.addEventListener("click",()=>a("ja")),ye.addEventListener("click",()=>a("en")),ae.addEventListener("click",bn)}function nr(){const t=u.tracks.slice().sort((e,n)=>e.order-n.order);for(const e of t)!(Array.isArray(e.notes)&&e.notes.length>0)||(In(e.notes??[])||Qe(e.notes??[]));Mo(u)}function Te(t){const e=K.getBoundingClientRect(),n=t.clientX-e.left+s.scrollX,r=t.clientY-e.top;return{x:n,y:r}}function Gn(t){const e=R.getBoundingClientRect();return{x:t.clientX-e.left+s.scrollX}}function Yn(t){const e=$[u.zoomLevel-1],n=s.scrollX,r=u.tempoAnchors||[];for(let a=0;a<r.length;a++){const o=Math.round(r[a].tick/E*e-n)+.5;if(Math.abs(o-t)<=6)return{index:a,tick:r[a].tick}}return null}function or(t){const e=R.getBoundingClientRect(),n=t.clientX-e.left,r=Yn(n),a=At,o=document.getElementById("rulerContextMenu");o&&o.parentNode&&o.parentNode.removeChild(o);const i=document.createElement("div");i.id="rulerContextMenu",i.style.cssText="position:absolute;z-index:20;background:#fff;border:1px solid #ccc;border-radius:6px;box-shadow:0 6px 16px rgba(0,0,0,0.2);padding:4px;min-width:160px;font:13px system-ui,sans-serif;";const d=(h,b)=>{const k=document.createElement("button");return k.type="button",k.textContent=h,k.style.cssText="display:block;width:100%;text-align:left;background:none;border:0;padding:8px 10px;cursor:pointer;",k.onmouseenter=()=>k.style.background="#f2f2f2",k.onmouseleave=()=>k.style.background="transparent",k.onclick=()=>{b(),c()},k},c=()=>{i.parentNode&&i.parentNode.removeChild(i)},{x:l}=Gn(t),m=$[u.zoomLevel-1],p=wt(s.selectedLength),f=Ee(Math.max(0,Math.floor(l/m*E)),p);r?(i.appendChild(d(y[v].menuTempoEdit||"템포 수정…",()=>Mn(u.tempoAnchors[r.index].bpm,h=>{u.tempoAnchors[r.index].bpm=h,u.tempoAnchors[r.index].tick===0&&(u.bpm=h),u.tempoAnchors.sort((b,k)=>b.tick-k.tick),j();for(const b of u.tracks)Ct(b);rt(),F()}))),i.appendChild(d(y[v].menuTempoDelete||"템포 삭제",()=>{u.tempoAnchors.splice(r.index,1),le=null,j();for(const h of u.tracks)Ct(h);rt(),F()}))):(i.appendChild(d(y[v].menuTempoCreateHere||"여기에 템포 생성…",()=>Mn(u.bpm,h=>{const b=u.tempoAnchors||[];b.push({tick:f,bpm:h}),b.sort((k,x)=>k.tick-x.tick),u.tempoAnchors=b,f===0&&(u.bpm=h),sn(f),j();for(const k of u.tracks)Ct(k);rt(),F()}))),i.appendChild(d(y[v].menuTempoRemoveAll||"모든 템포 제거",()=>{if(!(!Array.isArray(u.tempoAnchors)||u.tempoAnchors.length===0)){u.tempoAnchors=[],le=null,j();for(const h of u.tracks)Ct(h);rt(),F()}}))),a.style.position="relative",i.style.left=`${Math.floor(n)}px`;const g=s.keyHeight;i.style.top=`${Math.max(0,Math.floor(g-26))}px`,a.appendChild(i),setTimeout(()=>{const h=b=>{const k=b.target;(!k||!i.contains(k))&&c()};window.addEventListener("mousedown",h,{once:!0,capture:!0}),window.addEventListener("wheel",()=>c(),{once:!0,capture:!0}),window.addEventListener("resize",()=>c(),{once:!0,capture:!0})},0)}function Mn(t,e){const n=document.createElement("div");n.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:1000;display:flex;align-items:center;justify-content:center;";const r=document.createElement("div");r.style.cssText="background:#fff;border-radius:8px;padding:16px;min-width:260px;box-shadow:0 10px 24px rgba(0,0,0,0.25);display:flex;flex-direction:column;gap:12px;";const a=document.createElement("div");a.textContent=y[v].tempoModalTitle||"템포 설정";const o=document.createElement("input");o.type="number",o.min="20",o.max=String(Xe),o.step="1",o.value=String(t),o.style.cssText="font-size:16px;padding:8px;";const i=document.createElement("div");i.style.cssText="display:flex;gap:8px;justify-content:flex-end;";const d=document.createElement("button");d.textContent=y[v].cancel||"취소";const c=document.createElement("button");c.textContent=y[v].ok||"확인",c.style.cssText="background:#3a7afe;color:#fff;border:0;border-radius:6px;padding:6px 12px;",i.append(d,c),r.append(a,o,i),n.appendChild(r),document.body.appendChild(n);const l=()=>{n.parentNode&&document.body.removeChild(n)};d.onclick=l,c.onclick=()=>{const m=Math.max(20,Math.min(Xe,Math.round(Number(o.value||t))));Number.isFinite(m)&&e(m),l()},o.addEventListener("keydown",m=>{m.key==="Enter"&&c.click(),m.key==="Escape"&&l()}),setTimeout(()=>o.focus(),0)}function rr(t){const e=qo(),n=R.getBoundingClientRect(),r=t.clientX-n.left,a=$[u.zoomLevel-1],o=s.scrollX,i=u.tempoAnchors||[];let d=null;for(const c of i){const l=Math.round(c.tick/E*a-o)+.5;if(Math.abs(l-r)<=6){d={cssX:l,bpm:c.bpm,tick:c.tick};break}}if(d){const c=Math.floor(d.tick/E/u.timeSig.beatsPerBar)+1,l=Math.floor(d.tick/E%u.timeSig.beatsPerBar)+1;e.textContent=`t${d.bpm} @ ${c}.${l}`,e.style.left=`${Math.floor(d.cssX)}px`;const m=s.keyHeight;e.style.top=`${Math.max(0,Math.floor(m-22))}px`,e.style.display="block"}else e.style.display="none"}function sn(t){const e=wt(s.selectedLength),r=Math.max(0,(a=>Ee(a,e))(t));for(const a of u.tracks){const o=[];for(const i of a.notes){const d=i.startTick,c=i.startTick+i.durationTick;if(c<=r||d>=r){o.push(i);continue}const l=Math.max(1,r-d),m=Math.max(1,c-r),p={...i,durationTick:l},f={...i,id:crypto.randomUUID(),startTick:r,durationTick:m};f.__tiedFromPrev=!0,o.push(p,f)}o.sort((i,d)=>i.startTick-d.startTick||i.pitch-d.pitch),a.notes=o}}function ar(t){t.key==="Alt"&&(en=!1,F()),Bt()}function ir(t){on(),Bt();const e=document.activeElement;if(e&&(e.tagName==="INPUT"||e.tagName==="TEXTAREA"||e.tagName==="SELECT"||e.isContentEditable))return;t.key==="Alt"&&(t.preventDefault(),en=!0,F());for(let o=1;o<=9;o++)t.key===o.toString()&&En(o-1);if(t.key==="0"&&En(Kt.length-1),J){t.code==="Space"&&(t.preventDefault(),Ye());return}if((t.key==="ArrowUp"||t.key==="ArrowDown")&&t.shiftKey){const o=document.activeElement;if(o&&(o.tagName==="INPUT"||o.tagName==="SELECT"))return;t.preventDefault();const i=u.tracks.find(f=>f.id===s.activeTrackId);if(!i)return;const d=i.notes.filter(f=>s.selected.has(f.id));if(d.length===0)return;const c=f=>Math.floor(mn(f)/12),l=Math.min(...d.map(f=>c(f.pitch))),m=Math.max(...d.map(f=>c(f.pitch)));if(t.key==="ArrowUp"&&m>=7||t.key==="ArrowDown"&&l<=1)return;const p=t.key==="ArrowUp"?12:-12;for(const f of i.notes)s.selected.has(f.id)&&(f.pitch=mn(f.pitch+p));j(),yt({track:i,recomputeLabels:!0});return}if((t.key==="ArrowUp"||t.key==="ArrowDown")&&!t.shiftKey&&!t.ctrlKey&&!t.metaKey&&!t.altKey){const o=document.activeElement;if(o&&(o.tagName==="INPUT"||o.tagName==="SELECT"))return;t.preventDefault();const i=u.tracks.slice().sort((m,p)=>m.order-p.order),d=i.findIndex(m=>m.id===s.activeTrackId);if(d===-1)return;const c=t.key==="ArrowUp"?-1:1,l=Math.max(0,Math.min(i.length-1,d+c));l!==d&&(s.activeTrackId=i[l].id,lt(),F(),Dt());return}const n=t.ctrlKey||t.metaKey;if(n&&t.key.toLowerCase()==="z"){t.preventDefault();const o=zt.undo(u);o&&(u=o,typeof u.displayBeatsPerBar=="number"&&(st=u.displayBeatsPerBar,et&&et.value!==String(st)&&(et.value=String(st))),s.selected.clear(),F(),lt());return}if(n&&t.key.toLowerCase()==="y"){t.preventDefault();const o=zt.redo(u);o&&(u=o,typeof u.displayBeatsPerBar=="number"&&(st=u.displayBeatsPerBar,et&&et.value!==String(st)&&(et.value=String(st))),s.selected.clear(),F(),lt());return}if(n&&t.key.toLowerCase()==="a"){t.preventDefault(),sr();return}if(t.key==="Escape"){s.selected.clear(),s.marquee.active=!1,s.drag=null,s.ghost=null,F();return}if(t.key==="Delete"){jn();return}if(n&&t.key.toLowerCase()==="c"){t.preventDefault(),Jn();return}if(n&&t.key.toLowerCase()==="v"){t.preventDefault(),lr();return}if(n&&t.key.toLowerCase()==="x"){t.preventDefault(),cr();return}if(t.code==="Space"){t.preventDefault(),J?Ye():oo();return}const r=$[u.zoomLevel-1],a=u.timeSig.beatsPerBar*r;if(t.key==="PageDown"){t.preventDefault(),s.scrollX=Math.max(0,Math.ceil((s.scrollX+1)/a)*a),G();return}if(t.key==="PageUp"){t.preventDefault(),s.scrollX=Math.max(0,Math.floor((s.scrollX-1)/a)*a),G();return}if(t.key==="Home"){t.preventDefault(),s.scrollX=0,G();return}if(t.key==="End"){t.preventDefault();const o=qt();s.scrollX=Le(Math.max(0,o-Y.clientWidth)),G();return}}function sr(){s.selected.clear();const t=u.tracks.find(e=>e.id===s.activeTrackId);for(const e of t.notes)s.selected.add(e.id);F()}function jn(){if(s.selected.size===0)return;const t=u.tracks.find(e=>e.id===s.activeTrackId);t.notes=t.notes.filter(e=>!s.selected.has(e.id)),s.selected.clear(),j(),yt({track:t})}function Jn(){const e=u.tracks.find(r=>r.id===s.activeTrackId).notes.filter(r=>s.selected.has(r.id));if(e.length===0)return;const n=Math.min(...e.map(r=>r.startTick));s.clipboard=e.map(r=>({...r,startTick:r.startTick-n}))}function cr(){Jn(),jn()}function lr(){if(!s.clipboard||s.clipboard.length===0)return;const t=Math.max(0,Math.floor(ct)),e=u.tracks.find(n=>n.id===s.activeTrackId);e&&We(async()=>{const{insertNoteWithOverlap:n,ensureBars:r}=await import("./timeline-Cty6ufw_.js").then(a=>a.z);return{insertNoteWithOverlap:n,ensureBars:r}},[],import.meta.url).then(({insertNoteWithOverlap:n,ensureBars:r})=>{if(s.selected.clear(),s.clipboard!=null)for(const a of s.clipboard){const o=crypto.randomUUID(),i={...a,id:o,startTick:Math.max(0,t+a.startTick)};n(u,e.id,i),r(u,i.startTick+i.durationTick),s.selected.add(o)}j(),yt({track:e})})}function dr(){const e=-Y.scrollTop+s.keyHeight;ft.style.transform=`translateY(${e}px)`,Bt()}function ur(t){if(Hn(t)&&Vt(),on(),Bt(),t.ctrlKey){t.preventDefault(),mr(t);return}if(t.altKey&&t.shiftKey&&s.selected.size>0&&!J){t.preventDefault();const e=t.deltaY>0?-1:1,n=u.tracks.find(l=>l.id===s.activeTrackId),r=de(n),a=new Map(r.map(l=>[l.id,l.volume??D])),o=new Set([...s.selected]),i=r.map((l,m)=>({n:l,i:m})).filter(l=>o.has(l.n.id)).map(l=>l.i).sort((l,m)=>l-m),d=new Map;for(const l of i){const m=r[l].id,p=a.get(m)??D;d.set(l,Xt(p+e))}let c=0;for(;c<i.length;){const l=i[c],m=d.get(l);let p=c+1;for(;p<i.length&&i[p]===i[p-1]+1&&d.get(i[p])===m;)p++;const f=l,g=i[p-1],h=f>0?a.get(r[f-1].id)??D:D;for(let k=f;k<=g;k++)r[k].volume=Xt(d.get(k));let b=g+1;for(;b<r.length&&o.has(r[b].id);)b++;b<r.length&&(r[b].volume=h,Yo(n,r[b])),c=p}yt({track:n,recomputeLabels:!0}),j();return}if(t.altKey&&!t.shiftKey&&s.selected.size>0&&!J){t.preventDefault();const e=t.deltaY>0?-1:1,n=u.tracks.find(a=>a.id===s.activeTrackId),r=n.notes.filter(a=>s.selected.has(a.id));if(r.length>0){const a=r.reduce((d,c)=>c.startTick<d.startTick?c:d),o=a.volume??D,i=Xt(o+e);$n(n,a,i)}yt({track:n,recomputeLabels:!0}),j();return}if(t.shiftKey){t.preventDefault();const e=$[u.zoomLevel-1],n=u.timeSig.beatsPerBar*e,a=(Math.abs(t.deltaX)>Math.abs(t.deltaY)?t.deltaX:t.deltaY)>0?1:-1,o=qt(),i=Math.max(0,o-Y.clientWidth);let d=Math.max(0,Math.min(i,s.scrollX+a*n));if(J){const c=ct/E*e,l=Y.clientWidth,m=Math.max(0,Math.min(i,Math.floor(c-l))),p=Math.max(0,Math.min(i,Math.floor(c)));d=Math.max(m,Math.min(p,d));let f=Le(d);const g=Math.max(0,Math.min(i,Math.ceil(m/n)*n)),h=Math.max(0,Math.min(i,Math.floor(p/n)*n));g<=h?((f<g||f>h)&&(f=a>0?h:g),d=f):d=s.scrollX}s.scrollX=Le(d),G();return}}function mr(t){const e=t.deltaY>0?-1:1,n=Math.max(1,Math.min(9,u.zoomLevel+e));if(n===u.zoomLevel)return;const r=$[u.zoomLevel-1],a=Y.getBoundingClientRect(),o=Math.max(0,Math.min(t.clientX-a.left,a.width)),i=s.scrollX+o,d=r*u.timeSig.beatsPerBar,l=Math.max(0,Math.round(i/d)*d)/r*E;u.zoomLevel=n;const m=$[n-1],p=l/E*m,f=qt(),g=Math.max(0,f-Y.clientWidth);s.scrollX=Math.max(0,Math.min(g,p-o));const h=m*u.timeSig.beatsPerBar;s.scrollX=Math.max(0,Math.min(g,Math.floor(s.scrollX/h)*h)),Rt=-1,F()}function lt(){Dt();const t=De;vn.innerHTML="",u.tracks.slice().sort((n,r)=>n.order-r.order).forEach((n,r)=>{n.color=t[r%t.length],(!n.instrument||!je.includes(n.instrument))&&(n.instrument=Je);const a=document.createElement("div");a.dataset.trackId=String(n.id),a.dataset.order=String(n.order);const o=n.id===s.activeTrackId;a.className="track-card",o&&a.classList.add("is-active");const i=document.createElement("div");i.className="track-color",i.style.cssText=`
            background: ${n.color};
        `;const d=document.createElement("div");d.className="track-main";const c=document.createElement("div");c.className="track-row track-row--top";const l=document.createElement("input");l.value=n.name,l.setAttribute("data-i18n-title","tooltipTrackName"),l.title=y[v].tooltipTrackName,c.style.width="100%",l.classList.add("track-name-input"),xo(l,{size:"sm"}),l.addEventListener("change",()=>{zt.push(u),n.name=l.value});const m=document.createElement("div");if(m.className="track-name",m.appendChild(l),c.appendChild(m),o){const g=document.createElement("div");g.className="track-reorder",g.style.marginLeft="auto",g.style.display="inline-flex",g.style.gap="6px";const h=document.createElement("button");h.type="button",h.textContent="▲",h.title="Move up",h.setAttribute("aria-label","Move track up"),h.style.width="24px",h.style.height="24px",h.style.fontSize="12px";const b=document.createElement("button");b.type="button",b.textContent="▼",b.title="Move down",b.setAttribute("aria-label","Move track down"),b.style.width="24px",b.style.height="24px",b.style.fontSize="12px";const k=u.tracks.length-1;h.disabled=n.order===0,b.disabled=n.order===k,h.addEventListener("click",x=>{x.stopPropagation(),Tn(-1)}),b.addEventListener("click",x=>{x.stopPropagation(),Tn(1)}),g.append(h,b),c.appendChild(g)}{const g=document.createElement("div");g.className="track-row track-row--middle",g.style.width="100%";const h=go(),b=vo({items:h,value:n.instrument,size:"sm",fullWidth:!0,onChange:T=>{zt.push(u),n.instrument=T}});b.el.setAttribute("data-i18n-title","tooltipInstrument"),b.el.title=y[v].tooltipInstrument;const k=document.createElement("div");k.className="track-instrument",k.appendChild(b.el),g.appendChild(k);const x=document.createElement("div");x.className="track-row track-row--bottom";const w=hr(n),B=document.createElement("span");B.className="track-charcount";const P=n.optimizedMML?.length||0,q=y[v].charUnit;B.textContent=`${P}${q}`,B.setAttribute("data-i18n-title","tooltipCharCount"),B.title=y[v].tooltipCharCount,x.append(w,B),d.append(c,g,x)}const p=[l];{const g=d.querySelector(".dropdown");g instanceof HTMLElement&&p.push(g),d.querySelectorAll(".track-controls button").forEach(b=>p.push(b))}c.querySelectorAll(".track-reorder button").forEach(g=>p.push(g)),p.forEach(g=>{g.addEventListener("mousedown",h=>h.stopPropagation()),g.addEventListener("mouseup",h=>h.stopPropagation())}),a.addEventListener("click",g=>{const h=g.target.tagName;h==="INPUT"||h==="SELECT"||h==="BUTTON"||g.target.isContentEditable||s.activeTrackId!==n.id&&(s.activeTrackId=n.id,lt(),F())}),a.append(i,d),vn.appendChild(a)})}function Tn(t){const e=u.tracks.find(i=>i.id===s.activeTrackId);if(!e)return;const n=e.order,r=u.tracks.length-1,a=n+t;if(a<0||a>r)return;const o=u.tracks.find(i=>i.order===a);o&&(e.order=a,o.order=n),j(),lt(),rt()}function Zn(){ne.innerHTML="",$t(),Kt.forEach(t=>{const e=_t({label:String(t),size:"sm",variant:t===s.selectedLength?"primary":"secondary"});t===s.selectedLength&&e.classList.add("active"),e.setAttribute("data-i18n-title","tooltipLength"),t===64?e.title=(y[v].tooltipLength||"Length")+" - 0 (주의: 인게임에서 박자가 어긋날 수 있음)":e.title=y[v].tooltipLength,e.addEventListener("click",()=>{cn(t)}),t===48&&(e.style.marginRight="12px"),ne.appendChild(e)}),Q.textContent=ht?y[v].extendedLessLabel||"더 적은 단위":y[v].extendedMoreLabel||"더 많은 단위",Q.title=ht?y[v].tooltipExtendedLess||"기본 단위로 돌아가기":y[v].tooltipExtendedMore||"더 많은 단위 사용 (64/128/5/7/11)",Q.setAttribute("data-i18n",ht?"extendedLessLabel":"extendedMoreLabel"),it(Q,ht?"tooltipExtendedLess":"tooltipExtendedMore",Q.title),Q.setAttribute("aria-label",Q.title),Q.onclick=pr,ne.appendChild(Q)}function pr(){if(!ht){const e="mml_editor_warn_extended_shown";let n=!1;try{n=localStorage.getItem(e)==="1"}catch{}if(!n){if(!window.confirm(y[v].confirmEnableExtendedUnits||"Enable more units to use 64/128/5/7/11; existing ticks will be converted. Continue?"))return;try{localStorage.setItem(e,"1")}catch{}}Ln(!0)}else Ln(!1)}function Ln(t){j();const r=(t?ze:Re)/(t?Re:ze);Ge(u,r),An(t),u.tpqn=E,u.extendedUnitsEnabled=t;try{zt.transformSnapshots?.(a=>Ge(a,r))}catch{}fr(),Zn(),F()}function fr(){if(!Kt.includes(s.selectedLength)){let t=Kt[0],e=Math.abs(t-s.selectedLength);for(const n of Kt){const r=Math.abs(n-s.selectedLength);r<e&&(t=n,e=r)}cn(t)}}function Ge(t,e){if(!Number.isFinite(e)||e<=0)return;for(const r of t.tracks)for(const a of r.notes)a.startTick=Math.round(a.startTick*e),a.durationTick=Math.max(1,Math.round(a.durationTick*e));const n=t.tempoAnchors;if(Array.isArray(n)){for(const r of n)r.tick=Math.max(0,Math.round(r.tick*e));n.sort((r,a)=>r.tick-a.tick)}t.maxEndTick=Math.round(t.maxEndTick*e)}function cn(t){if(!ne)return;s.selectedLength=t;const e=Array.from(ne.children);e.forEach(n=>n.classList.remove("active")),e.forEach(n=>{if(n instanceof HTMLButtonElement){const a=parseInt(n.textContent||"0",10)===t;a&&n.classList.add("active"),n.classList.remove("btn--primary","btn--secondary"),n.classList.add(a?"btn--primary":"btn--secondary")}}),F(),rt()}function hr(t){const e=document.createElement("div");e.className="track-controls";const n=(o,i,d)=>{const c=document.createElement("button");return c.textContent=o,c.style.cssText=`
            width: 24px;
            height: 24px;
            font-size: 12px;
            font-weight: bold;
            border-radius: 4px;
            border: 1px solid #ccc;
            cursor: pointer;
            background-color: ${i?d:"#fff"};
            color: ${i?"#fff":"#000"};
        `,c},r=n("M",t.mute,"#f44336");r.setAttribute("data-i18n-title","tooltipMute"),r.title=y[v].tooltipMute,r.addEventListener("click",()=>{t.mute=!t.mute,j(),lt()});const a=n("S",t.solo,"#ff9800");return a.setAttribute("data-i18n-title","tooltipSolo"),a.title=y[v].tooltipSolo,a.addEventListener("click",()=>{t.solo=!t.solo,j(),lt()}),e.append(r,a),e}function En(t){const e=Kt[t];typeof e=="number"&&cn(e)}function gr(t){if(J){s.hover.noteId=null,s.hover.edge=null,K.style.cursor="not-allowed";return}const{x:e,y:n}=Te(t),r=$[u.zoomLevel-1],a=u.tracks.find(o=>o.id===s.activeTrackId);if(!s.drag&&!s.marquee.active){const o=Oe(e,n,a.notes,r,s.keyHeight);o?(s.hover.noteId=o.note.id,s.hover.edge=o.edge,K.style.cursor=o.edge==="center"?"move":"ew-resize"):(s.hover.noteId=null,s.hover.edge=null,K.style.cursor="default"),G();return}if(s.marquee.active){s.marquee.x1=e,s.marquee.y1=n;const o=t.ctrlKey||t.metaKey,i=t.shiftKey;s.marquee.mode=o?"toggle":i?"add":"replace";const d=Do(s.marquee.x0,s.marquee.y0,s.marquee.x1,s.marquee.y1,a.notes,r,s.keyHeight),c=new Set(s.selected);if(s.marquee.mode==="replace"){s.selected.clear();for(const l of d)s.selected.add(l.id)}else if(s.marquee.mode==="add")for(const l of d)s.selected.add(l.id);else{s.selected=c;for(const l of d)s.selected.has(l.id)?s.selected.delete(l.id):s.selected.add(l.id)}G()}}function br(t){if(Vt(),Bt(),Cn(),J){t.preventDefault(),K.style.cursor="not-allowed";return}if(on(),t.button===1){t.preventDefault(),Ot=!0,me(t);return}if(t.button===2){t.preventDefault();const{x:p,y:f}=Te(t),g=$[u.zoomLevel-1],h=u.tracks.find(k=>k.id===s.activeTrackId),b=Oe(p,f,h.notes,g,s.keyHeight);if(b)s.selected.has(b.note.id)||(s.selected.clear(),s.selected.add(b.note.id),G()),Zo(b.note,t.clientX,t.clientY);else{const k=t.ctrlKey||t.metaKey,x=t.shiftKey;s.drag=null,s.ghost=null,s.marquee.active=!0,s.marquee.x0=p,s.marquee.y0=f,s.marquee.x1=p,s.marquee.y1=f,s.marquee.mode=k?"toggle":x?"add":"replace",G()}return}if(t.button!==0)return;const{x:e,y:n}=Te(t),r=$[u.zoomLevel-1],a=u.tracks.find(p=>p.id===s.activeTrackId),o=Oe(e,n,a.notes,r,s.keyHeight);if(!o){const p=wt(s.selectedLength),f=e/r*E,g=Ee(f,p),h=ce(95-Math.floor(n/s.keyHeight)),b=wt(s.selectedLength),k=crypto.randomUUID();s.drag={kind:"create",trackId:s.activeTrackId,noteId:k,startTick:g,durationTick:b,pitch:h},s.ghost={startTick:g,durationTick:b,pitch:h,color:vt};const x=u.tracks.find(w=>w.id===s.activeTrackId);x&&ve(h,x.id,x.instrument,xt),G();return}const i=o.note,d=t.ctrlKey||t.metaKey,c=s.selected.has(i.id);d?c||s.selected.add(i.id):c||(s.selected.clear(),s.selected.add(i.id));{const p=u.tracks.find(f=>f.id===s.activeTrackId);p&&ve(i.pitch,p.id,p.instrument,xt)}const l=i.startTick,m=i.startTick+i.durationTick;if(o.edge==="center"){const p=Array.from(s.selected),f=u.tracks.find(h=>h.id===a.id).notes.filter(h=>s.selected.has(h.id)).map(h=>({id:h.id,startTick:h.startTick,pitch:h.pitch,durationTick:h.durationTick,volume:h.volume})),g=wt(s.selectedLength);ie=0,se=0,s.moveGroup={trackId:a.id,ids:p,base:f,mouseStartX:e,mouseStartY:n,grid:g},s.drag={kind:"move",trackId:a.id,noteId:i.id,startTick0:l,yPitch0:i.pitch,mouseStartX:e,mouseStartY:n},s.ghost={startTick:i.startTick,durationTick:i.durationTick,pitch:i.pitch,color:vt},G();return}else o.edge==="left"?(s.drag={kind:"resize-left",trackId:a.id,noteId:i.id,startTick0:l,endTick0:m,mouseStartX:e},s.ghost={startTick:i.startTick,durationTick:i.durationTick,pitch:i.pitch,color:vt}):o.edge==="right"&&(s.drag={kind:"resize-right",trackId:a.id,noteId:i.id,startTick0:l,endTick0:m,mouseStartX:e},s.ghost={startTick:i.startTick,durationTick:i.durationTick,pitch:i.pitch,color:vt});G()}function kr(t){if(J)return;if(Ot){me(t);return}if(s.marquee.active||!s.drag)return;const{x:e,y:n}=Te(t),r=$[u.zoomLevel-1],a=wt(s.selectedLength);if(s.drag.kind==="move"||s.drag.kind==="resize-left"||s.drag.kind==="resize-right"){if(s.drag.kind==="move"){const l=document.elementFromPoint(t.clientX,t.clientY)?.closest?.(".track-card");document.querySelectorAll(".track-card.drop-hover").forEach(m=>m.classList.remove("drop-hover")),l&&parseInt(l.dataset.trackId||"-1",10)!==s.drag.trackId&&l.classList.add("drop-hover")}const o=u.tracks.find(c=>s.drag!=null&&c.id===s.drag.trackId),i=o.notes.findIndex(c=>s.drag!=null&&c.id===s.drag.noteId);if(i<0)return;const d=o.notes[i];if(s.drag.kind==="move"){const c=s.moveGroup;if(!c)return;const l=(e-c.mouseStartX)/r,m=Math.floor((c.mouseStartY-n)/s.keyHeight),p=l*E,f=Math.round(p/c.grid)*c.grid;ie=f,se=m;const g=ce(s.drag.yPitch0+m),h=u.tracks.find(w=>w.id===s.activeTrackId);h&&ve(g,h.id,h.instrument,xt),G();const b=r,k=s.scrollX,x=window.devicePixelRatio||1;bt.save(),bt.setTransform(x,0,0,x,0,0),bt.globalAlpha=.7,bt.fillStyle=vt;for(const w of c.base){const B=Math.max(0,w.startTick+f),P=Math.round(B/E*b)-Math.floor(k)+.5,q=Math.max(1,Math.round(w.durationTick/E*b)),S=(95-ce(w.pitch+m))*s.keyHeight+.5,W=s.keyHeight-1;bt.fillRect(P,S,q,W)}bt.globalAlpha=1,bt.restore();return}if(s.drag.kind==="resize-left"){const c=(e-s.drag.mouseStartX)/r;let l=s.drag.startTick0+c*E,m=Math.max(0,Math.floor(l/a)*a);m=Math.min(m,s.drag.endTick0-a);const p=s.drag.endTick0-m;s.ghost={startTick:m,durationTick:p,pitch:d.pitch,color:vt};const f=s.drag.endTick0-s.drag.startTick0,g=Math.max(0,f-p),h=wt(32),b=u.tracks.find(w=>w.id===s.drag.trackId),k=new Set(s.selected),x=[];if(g>0)for(const w of b.notes){if(w.id===s.drag.noteId||!k.has(w.id))continue;const B=Math.max(h,w.durationTick-g);x.push({startTick:w.startTick,durationTick:B,pitch:w.pitch,color:vt})}s.ghostGroup=x.length?x:null,G();return}if(s.drag.kind==="resize-right"){const c=(e-s.drag.mouseStartX)/r;let l=s.drag.endTick0+c*E,m=Math.max(s.drag.startTick0+a,Math.ceil(l/a)*a);const p=u.tracks.find(P=>P.id===s.drag.trackId),f=s.drag.startTick0,g=p.notes.filter(P=>P.startTick>f).sort((P,q)=>P.startTick-q.startTick)[0];g&&(m=Math.min(m,g.startTick));const h=m-s.drag.startTick0;s.ghost={startTick:s.drag.startTick0,durationTick:h,pitch:d.pitch,color:vt};const b=s.drag.endTick0-s.drag.startTick0,k=Math.max(0,h-b),x=u.tracks.find(P=>P.id===s.drag.trackId),w=new Set(s.selected),B=[];if(k>0)for(const P of x.notes){if(P.id===s.drag.noteId||!w.has(P.id))continue;const q=x.notes.filter(C=>C.startTick>P.startTick).sort((C,L)=>C.startTick-L.startTick)[0];let T=Number.POSITIVE_INFINITY;q&&(T=Math.max(0,q.startTick-(P.startTick+P.durationTick)));const S=Math.max(0,Math.min(k,T)),W=P.durationTick+S;B.push({startTick:P.startTick,durationTick:W,pitch:P.pitch,color:vt})}s.ghostGroup=B.length?B:null,G();return}}if(s.drag.kind==="create"){const o=s.drag.startTick,i=(e-o/E*r)/r,d=o+Math.max(a,Math.round(i*E)),l=Math.max(o+a,Math.ceil(d/a)*a)-o,m=ce(95-Math.floor(n/s.keyHeight));s.ghost={startTick:o,durationTick:l,pitch:m,color:vt};const p=u.tracks.find(f=>f.id===s.activeTrackId);p&&ve(m,p.id,p.instrument,xt),G()}}function yr(){if(J)return;if(Ot){Ot=!1;return}xt.sampler&&xt.pitch!==null&&(mo(xt.sampler,xt.pitch),xt.pitch=null,xt.sampler=null);const t=document.activeElement;if(t&&(t.tagName==="INPUT"||t.tagName==="SELECT"||t.isContentEditable))return;if(s.marquee.active){s.marquee.active=!1,G();return}if(!s.drag)return;if(s.drag.kind==="move"&&s.moveGroup){const i=document.elementFromPoint(window.lastPointerX??0,window.lastPointerY??0)?.closest?.(".track-card");if(i){const l=parseInt(i.dataset.trackId||"-1",10),m=s.moveGroup.trackId;if(!Number.isNaN(l)&&l>0&&l!==m){const p=u.tracks.find(b=>b.id===m),f=u.tracks.find(b=>b.id===l),g=new Set(s.moveGroup.ids),h=p.notes.filter(b=>g.has(b.id));if(h.length>0){const b=Math.min(...h.map(w=>w.startTick)),k=Math.max(...h.map(w=>w.startTick+w.durationTick)),x=f.notes.filter(w=>w.startTick<k&&w.startTick+w.durationTick>b);p.notes=p.notes.filter(w=>!g.has(w.id)).concat(x),f.notes=f.notes.filter(w=>!x.includes(w)).concat(h),Me(p.notes),Me(f.notes),s.selected.clear();for(const w of h)s.selected.add(w.id);s.moveGroup=null,s.drag=null,s.ghost=null,yt({track:p}),yt({track:f}),j(),lt();return}}}const d=s.moveGroup;if(ie===0&&se===0){s.moveGroup=null,s.drag=null,s.ghost=null;return}const c=u.tracks.find(l=>l.id===d.trackId);c.notes=c.notes.filter(l=>!d.ids.includes(l.id)),We(async()=>{const{insertNoteWithOverlap:l,ensureBars:m}=await import("./timeline-Cty6ufw_.js").then(p=>p.z);return{insertNoteWithOverlap:l,ensureBars:m}},[],import.meta.url).then(({insertNoteWithOverlap:l,ensureBars:m})=>{s.selected.clear();for(const p of d.base){const f={id:p.id,startTick:Math.max(0,p.startTick+ie),durationTick:p.durationTick,pitch:ce(p.pitch+se),velocity:100,volume:p.volume??D};l(u,d.trackId,f),m(u,f.startTick+f.durationTick),s.selected.add(f.id)}s.moveGroup=null,s.drag=null,s.ghost=null,ie=0,se=0,yt({track:c}),j(),rt()});return}if(!s.ghost){s.drag=null,document.querySelectorAll(".track-card.drop-hover").forEach(i=>i.classList.remove("drop-hover"));return}const e=s.ghost,n=s.drag.trackId,r=u.tracks.find(i=>i.id===n);let a=D;if(r){const i=de(r);let d=D;for(let c=0;c<i.length;c++){const l=i[c];if(l.startTick>=e.startTick)break;const m=l.volume??D;On(i,c,s.volumeLabels),d=m}a=d}const o={id:s.drag.noteId,startTick:e.startTick,durationTick:e.durationTick,pitch:e.pitch,velocity:100,volume:a};We(async()=>{const{insertNoteWithOverlap:i,ensureBars:d}=await import("./timeline-Cty6ufw_.js").then(c=>c.z);return{insertNoteWithOverlap:i,ensureBars:d}},[],import.meta.url).then(({insertNoteWithOverlap:i,ensureBars:d})=>{const c=u.tracks.find(l=>l.id===n);if(s.drag.kind==="resize-left"||s.drag.kind==="resize-right"){const l=c.notes.findIndex(h=>h.id===s.drag.noteId);l>=0&&c.notes.splice(l,1);const m=s.drag.endTick0-s.drag.startTick0,p=e.durationTick,f=Math.max(0,m-p);if(f>0){const h=wt(32),b=new Set(s.selected);for(const k of c.notes)k.id!==s.drag.noteId&&b.has(k.id)&&(k.durationTick=Math.max(h,k.durationTick-f))}const g=Math.max(0,p-m);if(g>0){const h=new Set(s.selected);for(const b of c.notes){if(b.id===s.drag.noteId||!h.has(b.id))continue;const k=c.notes.filter(B=>B.startTick>b.startTick).sort((B,P)=>B.startTick-P.startTick)[0];let x=Number.POSITIVE_INFINITY;k&&(x=Math.max(0,k.startTick-(b.startTick+b.durationTick)));const w=Math.max(0,Math.min(g,x));w>0&&(b.durationTick+=w,d(u,b.startTick+b.durationTick))}}}i(u,n,o),d(u,o.startTick+o.durationTick),s.drag=null,s.ghost=null,s.ghostGroup=null,document.querySelectorAll(".track-card.drop-hover").forEach(l=>l.classList.remove("drop-hover")),yt({track:c,recomputeLabels:!0}),j(),rt()})}function G(){vr(),s.isAltDown=en;const t=$[u.zoomLevel-1],e=ct/E*t,n=s.scrollX,r=Y.clientWidth,a=n+r;Y.clientHeight;const o=u.timeSig.beatsPerBar*t,i=(st||u.timeSig.beatsPerBar)*t,d=Math.floor(n/o),c=n-d*o,l=Math.floor(n/i),m=n-l*i;K.style.left=`${-c}px`,ot&&(ot.style.left=`${-m}px`),ot&&we&&zn(we,ot,u,s,st),So(bt,u,s,d*o,r+o);const p=e-n;if(J)if(Nt==="area"){const h=$[u.zoomLevel-1],b=st||u.timeSig.beatsPerBar,k=h*b,w=Math.floor(e/k)*k-n;Xo(bt,K,w,k)}else kn(bt,K,p);else kn(bt,K,p);Wo(Dn,ft,s.keyHeight);const g=-Y.scrollTop+s.keyHeight;if(ft.style.transform=`translateY(${g}px)`,xr(),J&&e>=a){const h=$[u.zoomLevel-1],b=u.timeSig.beatsPerBar*h,k=ct/E*h,x=Math.floor(k/b)*b,w=qt(),B=Math.max(0,w-Y.clientWidth);s.scrollX=Math.max(0,Math.min(B,x))}Se(),eo()}function vr(){const t=window.devicePixelRatio||1,e=$[u.zoomLevel-1],r=u.timeSig.beatsPerBar*e,a=(Y.clientWidth||800)+r,o=84*s.keyHeight,i=o;K.style.width!==`${a}px`&&(K.style.width=`${a}px`),K.style.height!==`${i}px`&&(K.style.height=`${i}px`);const d=Math.max(1,Math.floor(a*t)),c=Math.max(1,Math.floor(i*t));if((K.width!==d||K.height!==c)&&(K.width=d,K.height=c),ot&&we){const b=(Y.clientWidth||800)+r,k=o;ot.style.width!==`${b}px`&&(ot.style.width=`${b}px`),ot.style.height!==`${k}px`&&(ot.style.height=`${k}px`);const x=Math.max(1,Math.floor(b*t)),w=Math.max(1,Math.floor(k*t)),B=ot.width!==x,P=ot.height!==w;(B||P)&&(ot.width=x,ot.height=w),(B||P||Rt!==u.zoomLevel)&&(zn(we,ot,u,s,st),Rt=u.zoomLevel)}const l=84*s.keyHeight;(ft.width!==Math.floor(48*t)||ft.height!==Math.floor(l*t))&&(ft.width=Math.floor(48*t),ft.height=Math.floor(l*t),t!==1&&Dn.setTransform(t,0,0,t,0,0)),ft.style.width!=="48px"&&(ft.style.width="48px");const m=`${l}px`;ft.style.height!==m&&(ft.style.height=m);const p=s.keyHeight;At.style.height!==p+"px"&&(At.style.height=p+"px");const f=At.clientWidth||Y.clientWidth||800,g=Math.max(1,Math.floor(f*t)),h=Math.max(1,Math.floor(p*t));(R.width!==g||R.height!==h)&&(R.width=g,R.height=h,t!==1&&$e.setTransform(t,0,0,t,0,0))}function Ye(){J=!1,xe().stop(),Bn(),Se(),eo(),Bt()}function Qn(){J=!1,xe().stop(),xe().position=0,Bn(),ct=Go,Se(),G(),Bt()}function xr(){const t=$[u.zoomLevel-1],e=st||u.timeSig.beatsPerBar,n=window.devicePixelRatio||1,r=s.keyHeight;At.style.height!==r+"px"&&(At.style.height=r+"px");const a=At.clientWidth||Y.clientWidth||800,o=Math.max(1,Math.floor(a*n)),i=Math.max(1,Math.floor(r*n));R.width!==o&&(R.width=o),R.height!==i&&(R.height=i),n!==1&&$e.setTransform(n,0,0,n,0,0);const d=s.scrollX;Ho($e,R,d,t,e,u,le)}function F(){Rt=-1,G()}function to(){if(!J)return;const t=performance.now(),e=Math.max(0,t-Ke);Ke=t;const n=u.tempoAnchors||[],r=Ze(n,u.bpm);ct=uo(r,ct,e);const a=ue();if(ct>=a){Qn();return}G(),requestAnimationFrame(to)}function ue(){let t=0;for(const e of u.tracks)for(const n of e.notes){const r=n.startTick+n.durationTick;r>t&&(t=r)}return t}function Se(){if(!yn)return;const t=ue(),e=Math.max(0,Math.floor(ct)),n=u.tempoAnchors||[],r=Ze(n,u.bpm),a=He(r,e),o=He(r,t);yn.textContent=`${pn(a)} / ${pn(o)}`}function wr(t){if(Bt(),t.button===2||J)return;const e=R.getBoundingClientRect(),n=t.clientX-e.left,r=Yn(n);if(r){le=r.tick,R._dragAnchorIndex=r.index,R._draggingTempo=!0,R._dragStartTick=r.tick,F();return}Ot=!0,me(t)}function Mr(t){if(R._draggingTempo===!0){const n=R.getBoundingClientRect(),r=t.clientX-n.left,a=$[u.zoomLevel-1],o=wt(s.selectedLength),i=(r+s.scrollX)/a*E,d=Ee(Math.max(0,Math.floor(i)),o),c=R._dragAnchorIndex,l=u.tempoAnchors||[];c>=0&&c<l.length&&(l[c].tick=d,l.sort((m,p)=>m.tick-p.tick),le=d,u.tempoAnchors=l,F());return}Ot&&me(t)}function Tr(){if(R._draggingTempo===!0){j(),R._draggingTempo=!1,R._dragAnchorIndex=-1,R._dragStartTick=null,rt();for(const e of u.tracks)Ct(e);F();return}Ot=!1}function me(t){const{x:e}=Gn(t),n=$[u.zoomLevel-1],r=e/n*E,a=wt(s.selectedLength);ct=Math.max(0,Math.floor(r/a)*a),J&&(J=!1),G()}function eo(){const t=qt(),e=t-Y.clientWidth;if(e<=1){Zt.style.display="none";return}Zt.style.display="block";const n=Math.max(20,Y.clientWidth/t*Zt.clientWidth);oe.style.width=`${n}px`;const a=s.scrollX/e*(Zt.clientWidth-n);oe.style.left=`${a}px`}function qt(){const t=$[u.zoomLevel-1],e=Math.ceil(ue()/E);return Math.max(Y.clientWidth,Math.ceil(e*t)+Y.clientWidth)}function Le(t){const e=$[u.zoomLevel-1],n=u.timeSig.beatsPerBar*e,r=Math.round(t/n)*n;return Math.max(0,r)}function no(){const t=y[v];if(Q&&(Q.textContent=ht?t.extendedLessLabel||"더 적은 단위":t.extendedMoreLabel||"더 많은 단위",Q.title=ht?t.tooltipExtendedLess||"기본 단위로 돌아가기":t.tooltipExtendedMore||"더 많은 단위 사용 (64/128/5/7/11)",Q.setAttribute("data-i18n",ht?"extendedLessLabel":"extendedMoreLabel"),Q.setAttribute("data-i18n-title",ht?"tooltipExtendedLess":"tooltipExtendedMore"),Q.setAttribute("aria-label",Q.title)),et){const e=t.tooltipDisplayTimeSig||"Display time signature (n/4)";et.title=e,et.setAttribute("data-i18n-title","tooltipDisplayTimeSig"),et.setAttribute("aria-label",e)}}Mt(Q,"ghost","sm");if(et){const t=a=>Math.max(1,Math.min(16,Math.floor(a)));let e=null;try{const a=localStorage.getItem(xn);if(a!=null){const o=Number(a);Number.isFinite(o)&&(e=t(o))}}catch{}const n=e??t(Number(u.displayBeatsPerBar)||Number(u.timeSig?.beatsPerBar)||4);st=n,u.displayBeatsPerBar=n,et.value!==String(n)&&(et.value=String(n));const r=()=>{const a=Number(et.value),o=Number.isFinite(a)?t(a):n;st=o,u.displayBeatsPerBar=o,et.value!==String(o)&&(et.value=String(o));try{localStorage.setItem(xn,String(o))}catch{}Rt=-1,j(),F()};et.addEventListener("change",r),et.addEventListener("input",r)}window.addEventListener("resize",()=>{an(),Rt=-1,F()});setTimeout(an,0);$t();_n();qe&&it(qe,"tooltipPlay",y[v].tooltipPlay);Fe&&it(Fe,"tooltipPause",y[v].tooltipPause);Et&&(Et.textContent=Nt==="area"?y[v].playheadAreaLabel:y[v].playheadLineLabel,it(Et,"tooltipPlayheadToggle",y[v].tooltipPlayheadToggle));Ue&&it(Ue,"tooltipStop",y[v].tooltipStop);Ft&&(Mt(Ft,"secondary","md"),Ft.setAttribute("data-i18n","edit"),it(Ft,"tooltipEditMML",y[v].tooltipEditMML));ge&&(Mt(ge,"secondary","md"),it(ge,"tooltipConvert",y[v].tooltipConvert));he&&(Mt(he,"secondary","md"),it(he,"tooltipPaste",y[v].tooltipPaste));ae&&(Mt(ae,"ghost","md"),it(ae,"tooltipGuide",y[v].tooltipGuide));if(kt){const t=(()=>{try{return localStorage.getItem(Wn)}catch{return null}})(),e=Math.max(16,Math.min(32,t?parseInt(t,10):s.keyHeight));s.keyHeight=e,kt.value=String(e),Ut&&(Ut.textContent=String(e)),kt.min="16",kt.max="32",kt.step="1",it(kt,"tooltipKeyHeight",y[v].tooltipKeyHeight||"노트 높이 (16-32)")}be&&(Mt(be,"ghost","sm"),it(be,"tooltipLangKo",y[v].tooltipLangKo));ke&&(Mt(ke,"ghost","sm"),it(ke,"tooltipLangJa",y[v].tooltipLangJa));ye&&(Mt(ye,"ghost","sm"),it(ye,"tooltipLangEn",y[v].tooltipLangEn));K&&(K.setAttribute("data-i18n-title","tooltipPianoRoll"),K.title=y[v].tooltipPianoRoll);R&&(R.setAttribute("data-i18n-title","tooltipRuler"),R.title=y[v].tooltipRuler);er();F();Dt();try{zt.push(u)}catch{}Ft?Ft.onclick=()=>{const t=u.tracks.find(n=>n.id===s.activeTrackId);if(!t)return;let e=t.optimizedMML?.trim?.()||t.mmlString?.trim?.()||"";if(e=e.replace(/[\r\n]+/g,""),!e)try{e=(Qe(t.notes??[])||"").trim().replace(/[\r\n]+/g,"")}catch{}To(t,n=>{Kn(t,n);try{const r=Nn([n],u.bpm);u.tempoAnchors=r,r.length>0&&r[0].tick===0&&Number.isFinite(r[0].bpm)&&(u.bpm=r[0].bpm);for(const a of r)sn(a.tick)}catch{}u.maxEndTick=ue(),Ct(t);for(const r of u.tracks)r!==t&&Ct(r);rt(),Dt(),lt()},e)}:u=Sn();no();Q.id="btnToggleExtended";Q.style.marginLeft="8px";Q.textContent=ht?y[v].extendedLessLabel||"더 적은 단위":y[v].extendedMoreLabel||"더 많은 단위";tn.onmessage=t=>{const{trackId:e,optimizedMML:n,originalBody:r}=t.data,a=u.tracks.find(o=>o.id===e);a&&(a.optimizedMML=n,a.originalBody=r??"",lt(),Dt(),Gt())};Fo?.addEventListener("click",()=>{qn(E)});Uo?.addEventListener("click",()=>{const t=E*Un();qn(t)});Vo?.addEventListener("click",()=>{Fn(E)});Ko?.addEventListener("click",()=>{const t=E*Un();Fn(t)});(function(){Wt&&(Wt.textContent=y[v].trackMMLLabel||"트랙MML",Wt.setAttribute("data-i18n","trackMMLLabel"),Wt.setAttribute("data-i18n-title","tooltipEditMML"),Wt.title=y[v].tooltipEditMML)})();s.moveGroup=null;(function(){const e="2025-08-27-load-change",n="mml_editor_whatsnew_shown_"+e;let r=!1;try{r=localStorage.getItem(n)==="1"}catch{}r||setTimeout(()=>Oo(e),0)})();async function Lr(){try{zt.push(u);const t=await navigator.clipboard.readText();if(!t.trim().startsWith("MML@")){alert(y[v].invalid_mml_format||"MML 형식이 아닙니다.");return}let e=t.trim().substring(4);e=e.replace(/\r?\n/g,"").replace(/;+$/g,"");const n=e.split(",").map(o=>o.replace(/;+$/g,"").trim());if(n.length>6){alert("트랙은 최대 6개까지만 지원합니다.");return}try{const o=Nn(n,u.bpm);u.tempoAnchors=o,o.length>0&&o[0].tick===0&&Number.isFinite(o[0].bpm)&&(u.bpm=o[0].bpm)}catch{}const r=[];for(let o=0;o<u.tracks.length;o++){const i=n[o]?n[o]:"",d=u.tracks[o],c=d.notes?.length||0;try{if(i&&i.length>0)try{d.optimizedMML=Pn(i)||i}catch{d.optimizedMML=i}else d.optimizedMML="";Kn(d,i),(d.notes?.length||0)>c&&r.push(d)}catch{alert(y[v].invalid_mml_format||"MML 형식이 아닙니다.");return}}u.maxEndTick=ue();const a=u.tempoAnchors||[];if(a.length>0)for(const o of a)sn(o.tick);r.length>0&&rn(r),lt(),Gt(),rt()}catch{}}async function oo(){if(J)return;J=!0,await co(),Bt();const t=tr(),e=u.tempoAnchors||[];await lo(t,u.bpm,{tempoAnchors:e});const n=Ze(e,u.bpm);xe().position=He(n,ct),Ke=performance.now();{const r=$[u.zoomLevel-1],a=u.timeSig.beatsPerBar*r,o=ct/E*r,i=Math.floor(o/a)*a,d=qt(),c=Math.max(0,d-Y.clientWidth);s.scrollX=Math.max(0,Math.min(c,i))}Se?.(),to()}const ln=()=>{const t=window.visualViewport?window.visualViewport.height:window.innerHeight;document.documentElement.style.setProperty("--app-100dvh",t+"px")};ln();window.addEventListener("resize",ln);window.visualViewport?.addEventListener("resize",ln);
