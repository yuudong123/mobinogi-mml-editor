const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./tempoModal-CDg7-l-h.js","./languages-BQGPFjgN.js","./pasteSelectTracksModal-DH9w1LR-.js"])))=>i.map(i=>d[i]);
import{t as v,c as b,T as x,P as B,D as A,a as wn,H as eo,e as xn,b as rt,I as Ie,d as Ot,i as no,f as bt,E as Z,L as Dt,s as oo,p as be,U as Et,g as Re,h as pe,j as cn,k as ro,l as io,m as je,n as De,o as we,q as Tn,_ as He,r as Mn,u as Xe,B as Oe,v as ao,w as ln,x as so,y as co}from"./languages-BQGPFjgN.js";import{n as Ln,a as lo,s as uo,b as fo,m as mo,M as po}from"./convertModal-D3Taqyfe.js";import{e as Ae,c as xe}from"./button-WIurEURm.js";import{showGuideModal as dn}from"./guideModal-CeFF17QZ.js";let un=!1;function ho(){if(un)return;const t=`
  :root {
    --dd-radius: 6px;
    --dd-border: #cfcfcf;
    --dd-border-hover: #b5b5b5;
    --dd-bg: #fff;
    --dd-text: #111;
    --dd-muted: #6b7280;
    --dd-shadow: 0 8px 24px rgba(0,0,0,0.12), 0 2px 6px rgba(0,0,0,0.08);
    --dd-focus: 0 0 0 3px rgba(33,150,243,0.15);
  }

  .dropdown { position: relative; display: inline-flex; }
  .dropdown--full { width: 100%; }

  .dropdown__button {
    display: inline-flex; align-items: center; justify-content: space-between;
    gap: 8px; width: 100%;
    background: var(--dd-bg);
    color: var(--dd-text);
    border: 1px solid var(--dd-border);
    border-radius: var(--dd-radius);
    cursor: pointer; user-select: none;
    transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
  }
  .dropdown__button:hover { border-color: var(--dd-border-hover); }
  .dropdown__button:focus-visible { outline: none; box-shadow: var(--dd-focus); }

  .dropdown__button--sm { height: 28px; padding: 4px 8px; font-size: 12px; }
  .dropdown__button--md { height: 34px; padding: 6px 10px; font-size: 14px; }
  .dropdown__button--lg { height: 40px; padding: 8px 12px; font-size: 16px; }

  .dropdown__caret { width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 6px solid #888; }

  .dropdown__menu {
    position: absolute; left: 0; top: calc(100% + 4px);
    min-width: 100%;
    background: #fff; border: 1px solid var(--dd-border);
    border-radius: var(--dd-radius);
    box-shadow: var(--dd-shadow);
    padding: 6px; margin: 0; list-style: none;
    z-index: 1000; display: block; opacity: 0; transform: var(--dd-transform, translateY(4px));
    pointer-events: none; transition: opacity .16s ease, transform .16s ease;
  }
  .dropdown__menu[data-open="true"] { opacity: 1; transform: translateY(0); pointer-events: auto; }

  .dropdown__item {
    padding: 6px 8px; border-radius: 6px; cursor: pointer;
    white-space: nowrap; color: var(--dd-text);
  }
  .dropdown__item[aria-selected="true"] { background: #eef6ff; }
  .dropdown__item:hover { background: #f3f4f6; }
  .dropdown__item:focus { outline: none; box-shadow: var(--dd-focus); }
  `,e=document.createElement("style");e.id="dropdown-styles",e.textContent=t,document.head.appendChild(e),un=!0}function go(t){ho();const e=t.size??"md";let o=t.value??t.items[0]?.value??"",r=t.items;const c=document.createElement("div");c.className="dropdown",c.classList.add("dropdown--full");const n=document.createElement("button");n.type="button",n.className=`dropdown__button dropdown__button--${e}`,n.setAttribute("aria-haspopup","listbox"),n.setAttribute("aria-expanded","false");const i=document.createElement("span");i.textContent=t.items.find(T=>T.value===o)?.label??"";const l=document.createElement("i");l.className="dropdown__caret",n.append(i,l);const a=document.createElement("ul");a.className="dropdown__menu",a.setAttribute("role","listbox"),a.setAttribute("tabindex","-1");const u=c;let f=!1;function m(){a.innerHTML="";for(const T of r){const w=document.createElement("li");w.className="dropdown__item",w.setAttribute("role","option"),w.setAttribute("tabindex","0"),w.setAttribute("aria-selected",String(T.value===o)),w.textContent=T.label,w.addEventListener("click",()=>E(T.value)),w.addEventListener("keydown",C=>{C.key==="Enter"||C.key===" "?(C.preventDefault(),E(T.value)):C.key==="Escape"?(C.preventDefault(),h(),n.focus()):C.key==="ArrowDown"?(C.preventDefault(),L(w)):C.key==="ArrowUp"&&(C.preventDefault(),S(w))}),a.appendChild(w)}}function p(){m(),f||(document.body.appendChild(a),f=!0,a.style.position="fixed",a.style.zIndex="1000");const T=n.getBoundingClientRect();a.style.minWidth=T.width+"px",M(),a.dataset.open="true",n.setAttribute("aria-expanded","true"),window.addEventListener("mousedown",k,{capture:!0}),window.addEventListener("scroll",y,!0),window.addEventListener("resize",y)}function h(){delete a.dataset.open,n.setAttribute("aria-expanded","false"),f&&(u.appendChild(a),f=!1,a.style.position="",a.style.left="",a.style.top="",a.style.minWidth="",a.style.zIndex=""),window.removeEventListener("mousedown",k,{capture:!0}),window.removeEventListener("scroll",y,!0),window.removeEventListener("resize",y)}function g(){a.dataset.open==="true"?h():p()}function k(T){const w=T.target;c.contains(w)||a.contains(w)||h()}function y(){a.dataset.open==="true"&&M()}function M(){const T=n.getBoundingClientRect(),w=a.getBoundingClientRect(),C=window.innerHeight,j=window.innerWidth,Y=8,ht=4,qt=Math.max(w.width,T.width);let ue=Math.min(Math.max(T.left,Y),Math.max(Y,j-qt-Y));const Ct=C-T.bottom-Y,fe=T.top-Y;let Ft=!1,gt=Math.min(360,Math.max(Ct-ht,120));w.height>Ct&&fe>Ct&&(Ft=!0,gt=Math.min(360,Math.max(fe-ht,120)));let Kt;Ft?(Kt=Math.max(Y,T.top-ht-Math.min(w.height,gt)),a.dataset.placement="top",a.style.setProperty("--dd-transform","translateY(-4px)")):(Kt=Math.min(C-Y-Math.min(w.height,gt),T.bottom+ht),a.dataset.placement="bottom",a.style.setProperty("--dd-transform","translateY(4px)")),a.style.top=`${Math.round(Kt)}px`,a.style.left=`${Math.round(ue)}px`,a.style.maxHeight=`${gt}px`,a.style.overflowY="auto"}function E(T){if(T===o){h(),n.focus();return}o=T,i.textContent=r.find(w=>w.value===o)?.label??"",h(),n.focus(),t.onChange(o)}function L(T){const w=Array.from(a.querySelectorAll(".dropdown__item")),C=w.indexOf(T);w[Math.min(w.length-1,C+1)]?.focus()}function S(T){const w=Array.from(a.querySelectorAll(".dropdown__item")),C=w.indexOf(T);w[Math.max(0,C-1)]?.focus()}n.addEventListener("click",()=>g()),n.addEventListener("keydown",T=>{if(T.key==="ArrowDown"||T.key==="Enter"||T.key===" ")T.preventDefault(),p();else if(T.key==="ArrowUp"){T.preventDefault(),p();const w=a.querySelectorAll(".dropdown__item");w[w.length-1]?.focus()}});function G(T){r=T;const w=r.find(C=>C.value===o);w?i.textContent=w.label:i.textContent="",a.dataset.open==="true"&&m()}return c.append(n,a),{el:c,get value(){return o},set value(T){E(T)},updateItems:G}}let fn=!1;function En(){if(fn)return;const t=`
  :root {
    --fc-radius: 6px;
    --fc-border: #cfcfcf;
    --fc-border-hover: #b5b5b5;
    --fc-border-focus: #2196f3;
    --fc-bg: #ffffff;
    --fc-bg-disabled: #f7f7f7;
    --fc-text: #111;
    --fc-placeholder: #9aa0a6;
    --fc-shadow-focus: 0 0 0 3px rgba(33,150,243,0.15);
  }

  .input, .select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    box-sizing: border-box;
    font: inherit;
    color: var(--fc-text);
    background: var(--fc-bg);
    border: 1px solid var(--fc-border);
    border-radius: var(--fc-radius);
    outline: none;
    transition: border-color .2s ease, box-shadow .2s ease, background .2s ease, transform .15s ease;
  }

  .input::placeholder {
    color: var(--fc-placeholder);
  }

  .input:hover, .select:hover {
    border-color: var(--fc-border-hover);
  }

  .input:focus, .select:focus {
    border-color: var(--fc-border-focus);
    box-shadow: var(--fc-shadow-focus);
  }

  /* Sizes */
  .fc--sm { height: 28px; padding: 4px 8px; font-size: 12px; }
  .fc--md { height: 34px; padding: 6px 10px; font-size: 14px; }
  .fc--lg { height: 40px; padding: 8px 12px; font-size: 16px; }

  /* Full width helper */
  .fc--full { width: 100%; }

  /* Number inputs: right align helper */
  .fc--num-right { text-align: right; }

  /* Disabled */
  .input:disabled, .select:disabled { background: var(--fc-bg-disabled); color: #888; cursor: not-allowed; }

  /* Select arrow */
  .select {
    background-image: url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5' stroke='%23888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 16px 16px;
    padding-right: 28px; /* space for arrow */
  }

  /* Remove default arrow on some browsers */
  .select::-ms-expand { display: none; }
  `,e=document.createElement("style");e.id="form-control-styles",e.textContent=t,document.head.appendChild(e),fn=!0}function ko(t,e){En(),t.classList.add("input");const o=e?.size;t.classList.add(yo(o)),t.classList.add("fc--full"),e?.rightAlign&&t.classList.add("fc--num-right")}function yo(t){return t==="sm"?"fc--sm":t==="lg"?"fc--lg":"fc--md"}let ft=null,et=null,Jt=null,Qt=null,Vt=null;function vo(t,e,o){if(ft||bo(),!ft||!et||!Jt||!Qt)return;et.value=(o??t.mmlString)||"",ft.style.display="flex",et.focus();const r=n=>{n.stopPropagation()};et.addEventListener("keydown",r),et.addEventListener("keyup",r);function c(){ft.style.display="none",et.removeEventListener("keydown",r),et.removeEventListener("keyup",r),Jt.onclick=null,Qt.onclick=null,Vt&&(window.removeEventListener("keydown",Vt,!0),Vt=null)}Jt.onclick=()=>{e(et.value),c()},Qt.onclick=c,Vt=n=>{n.key==="Escape"&&(n.stopPropagation(),c())},window.addEventListener("keydown",Vt,!0)}function bo(){ft=document.createElement("div"),ft.id="mmlEditModal",ft.style.cssText=`
    position: fixed; 
    left: 0; top: 0; 
    width: 100vw; 
    height: 100vh;
    background: rgba(0,0,0,0.25); 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    z-index: 200;
    display: none;
  `;const t=document.createElement("div");t.style.cssText=`
            background: #fff;
            padding: 24px;
            border-radius: 8px;
            min-width: 400px;
            box-shadow: 0 2px 16px #0002;
            display: flex;
            flex-direction: column;
            gap: 12px;
        `,et=document.createElement("textarea"),et.style.cssText=`
            width: 100%;
            min-height: 120px;
            font-family: monospace;
            font-size: 15px;
            word-break: break-all;
            overflow-x: wrap;
        `,Ae(),Jt=xe({label:v[b].ok,variant:"primary",attrs:{"data-i18n":"ok"}}),Qt=xe({label:v[b].cancel,variant:"secondary",attrs:{"data-i18n":"cancel"}});const e=document.createElement("div");e.style.cssText=`
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        `,e.append(Qt,Jt),t.append(et,e),ft.appendChild(t),document.body.appendChild(ft)}function wo(){return{scrollX:0,scrollY:0,keyHeight:16,activeTrackId:1,selectedLength:16,hover:{noteId:null,edge:null},drag:null,ghost:null,ghostGroup:null,selected:new Set,marquee:{active:!1,x0:0,y0:0,x1:0,y1:0,mode:"replace"},clipboard:null,volumeLabels:new Set}}function xo(t,e,o,r,c,n,i){t.save();const l=window.devicePixelRatio||1;t.setTransform(l,0,0,l,0,0);const a=t.canvas.clientWidth||t.canvas.width/l,u=t.canvas.clientHeight||t.canvas.height/l;t.clearRect(0,0,a,u),Eo(t,e,o,r,c),Io(t,o,e,r),Ao(t,e,o,r,c),Po(t,e,o,r,c),Bo(t,o,r),Lo(t,e,r,c,u),t.restore()}function Sn(t,e,o,r,c){const n=window.devicePixelRatio||1;t.setTransform(n,0,0,n,0,0);const i=e.clientWidth||e.width/n,l=e.clientHeight||e.height/n;t.clearRect(0,0,i,l),t.fillStyle="#ffffff",t.fillRect(0,0,i,l);const a=84*r.keyHeight;To(t,0,i,r),Mo(t,o,0,i,a,c)}function Zt(t,e,o,r,c,n){const i=Math.max(0,Math.min(n,Math.floor(Math.min(r,c)/2))),l=Math.floor(e),a=Math.floor(o),u=l+Math.max(0,r),f=a+Math.max(0,c);if(t.beginPath(),i<=0){t.rect(l,a,r,c);return}t.moveTo(l+i,a),t.lineTo(u-i,a),t.arcTo(u,a,u,a+i,i),t.lineTo(u,f-i),t.arcTo(u,f,u-i,f,i),t.lineTo(l+i,f),t.arcTo(l,f,l,f-i,i),t.lineTo(l,a+i),t.arcTo(l,a,l+i,a,i)}function To(t,e,o,r){const c=r.keyHeight,n=84*c,i=Math.ceil(n/c);for(let l=0;l<i;l++){const a=l*c,f=((95-l)%12+12)%12,m=f===1||f===3||f===6||f===8||f===10;t.fillStyle=m?"#d6d6d6":"#ffffff",t.fillRect(e,a,Math.max(0,o),c);const p=f===11;t.strokeStyle=p?"#000000":"rgb(153,153,153)",t.beginPath(),t.moveTo(e,a+.5),t.lineTo(e+Math.max(0,o),a+.5),t.stroke()}}function Mo(t,e,o,r,c,n){const i=B[e.zoomLevel-1],l=n&&n>=1?n:e.timeSig.beatsPerBar,a=Math.max(0,Math.floor(o/i)-2),u=Math.floor((o+r)/i)+2;for(let m=a;m<=u;m++){const p=Math.floor(m*i),h=m%l===0;t.strokeStyle=h?"#000":"rgb(128,128,128)",t.beginPath(),t.moveTo(p,0),t.lineTo(p,c),t.stroke()}const f=e.zoomLevel;f>=4&&Be(t,o,r,c,i,2,"rgb(191,191,191)"),f>=6&&Be(t,o,r,c,i,4,"rgb(191,191,191)"),f>=8&&Be(t,o,r,c,i,8,"rgb(191,191,191)")}function Be(t,e,o,r,c,n,i){const l=Math.max(0,Math.floor(e/c)-2),a=Math.floor((e+o)/c)+2;t.strokeStyle=i;for(let u=l;u<=a;u++)for(let f=1;f<n;f+=2){const m=Math.floor((u+f/n)*c);t.beginPath(),t.moveTo(m,0),t.lineTo(m,r),t.stroke()}}function Lo(t,e,o,r,c){const n=e.tempoAnchors;if(!Array.isArray(n)||n.length===0)return;const i=B[e.zoomLevel-1];t.save(),t.strokeStyle="rgba(123, 199, 255, 0.9)",t.lineWidth=1;for(const l of n){const a=typeof l.getTickOffset=="function"?l.getTickOffset():l.tick;if(a==null)continue;const u=a/x*i;if(u+1<o||u-1>o+r)continue;const f=Math.round(u-o)+.5;t.beginPath(),t.moveTo(f,0),t.lineTo(f,c),t.stroke()}t.restore()}function Eo(t,e,o,r,c){const n=B[e.zoomLevel-1],i=o.activeTrackId,l=[...e.tracks].sort((m,p)=>m.id===i?1:p.id===i?-1:0),a=e.tracks.filter(m=>m.solo),u=new Set((a.length>0?a:e.tracks.filter(m=>!m.mute)).map(m=>m.id)),f=[];for(const m of l){let p=m.id===i?1:.5;u.has(m.id)||(p*=.1),t.globalAlpha=p;for(const h of m.notes){const g=Math.round(h.startTick/x*n),k=Math.max(1,Math.round(h.durationTick/x*n));if(g+k<r||g>r+c)continue;const y=g-Math.floor(r);So(t,y,h,m.color,n,o.keyHeight,o.hover,m.id===i,o.selected.has(h.id))}f.push({id:m.id,len:m.notes.length})}t.globalAlpha=1}function So(t,e,o,r,c,n,i,l,a){const u=Math.max(1,Math.round(o.durationTick/x*c)),f=(95-o.pitch)*n+1,m=n-1,p=Math.min(6,Math.floor(m/2));if(t.fillStyle=r,Zt(t,e,f,u,m,p),t.fill(),t.strokeStyle="rgba(0,0,0,0.3)",t.lineWidth=1,Zt(t,e,f,u-1,m-1,Math.max(0,p-1)),t.stroke(),a&&(t.strokeStyle="#3a7afe",t.lineWidth=2,Zt(t,e,f,u-1,m-1,Math.max(0,p-1)),t.stroke(),t.lineWidth=1),l&&i.noteId===o.id){const h=Math.min(8,Math.floor(u/3));t.fillStyle="rgba(0,0,0,0.15)",t.fillRect(e,f,h,m),t.fillRect(e+u-h,f,h,m)}}function Io(t,e,o,r){const c=B[o.zoomLevel-1],n=i=>{const l=Math.round(i.startTick/x*c)-Math.floor(r),a=Math.max(1,Math.round(i.durationTick/x*c)),u=(95-i.pitch)*e.keyHeight+1,f=e.keyHeight-1;t.globalAlpha=.7,t.fillStyle=i.color;const m=Math.min(6,Math.floor(f/2));Zt(t,l,u,a,f,m),t.fill(),t.globalAlpha=1};if(e.ghost&&n(e.ghost),e.ghostGroup)for(const i of e.ghostGroup)n(i)}function Ao(t,e,o,r,c){const n=B[e.zoomLevel-1],i=o.keyHeight;t.strokeStyle="#3a7afe",t.lineWidth=2;for(const l of e.tracks)for(const a of l.notes){if(!o.selected.has(a.id))continue;const u=Math.round(a.startTick/x*n)-Math.floor(r),f=Math.max(1,Math.round(a.durationTick/x*n)),m=u+Math.floor(r);if(m+f<r||m>r+c)continue;const p=(95-a.pitch)*i+1,h=i-1,g=Math.min(6,Math.floor(h/2));Zt(t,u,p,f-1,h-1,Math.max(0,g-1)),t.stroke()}t.lineWidth=1}function Po(t,e,o,r,c){if(!o.volumeLabels||o.volumeLabels.size===0)return;const n=B[e.zoomLevel-1],i=o.keyHeight;t.font="10px sans-serif",t.textAlign="left",t.textBaseline="bottom";for(const l of e.tracks)for(const a of l.notes){if(!o.volumeLabels.has(a.id))continue;const u=Math.round(a.startTick/x*n),f=Math.max(1,Math.round(a.durationTick/x*n));if(u+f<r||u>r+c)continue;const m=u-Math.floor(r),p=(95-a.pitch)*i+1,h="V"+String(a.volume??A);t.fillStyle="rgba(255,255,255,0.9)",t.fillText(h,m+1,p-1),t.fillStyle="rgba(0,0,0,0.85)",t.fillText(h,m,p-2)}}function Bo(t,e,o){if(!e.marquee.active)return;const r=Math.min(e.marquee.x0,e.marquee.x1)-Math.floor(o),c=Math.min(e.marquee.y0,e.marquee.y1),n=Math.abs(e.marquee.x1-e.marquee.x0),i=Math.abs(e.marquee.y1-e.marquee.y0);t.fillStyle="rgba(58,122,254,0.15)",t.fillRect(r,c,n,i),t.strokeStyle="rgba(58,122,254,0.8)",t.setLineDash([4,3]),t.strokeRect(r+.5,c+.5,n-1,i-1),t.setLineDash([])}function We(t,e,o,r,c){for(let n=o.length-1;n>=0;n--){const i=o[n],l=Math.round(i.startTick/x*r),a=Math.max(1,Math.round(i.durationTick/x*r)),u=(95-i.pitch)*c+1,f=c-1;if(t>=l&&t<=l+a&&e>=u&&e<=u+f){const m=Math.min(8,Math.floor(a/3)),p=t<=l+m?"left":t>=l+a-m?"right":"center";return{note:i,edge:p}}}}function Co(t,e,o,r,c,n,i){const l=Math.min(t,o),a=Math.max(t,o),u=Math.min(e,r),f=Math.max(e,r),m=[];for(const p of c){const h=Math.round(p.startTick/x*n),g=Math.max(1,Math.round(p.durationTick/x*n)),k=(95-p.pitch)*i+1,y=i-1,M=h+g,E=k+y;M>=l&&h<=a&&E>=u&&k<=f&&m.push(p)}return m}function _o(t,e,o){t.clearRect(0,0,e.width,e.height);const r=window.devicePixelRatio||1,c=12*o;for(let n=0;n<7;n++){const i=(6-n)*c,l=n%2===1;t.fillStyle=l?"#e6e6e6":"#ffffff",t.fillRect(0,i,e.width/r,c),t.fillStyle="#222",t.font=`${Math.max(10,Math.round(12))}px system-ui, sans-serif`,t.textBaseline="middle",t.textAlign="center";const a="o"+(n+1),u=i+c/2;t.fillText(a,Math.floor(e.width/r/2),Math.floor(u))}}function No(t,e,o,r,c,n,i){const l=e.width,a=e.height,u=window.devicePixelRatio||1;t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,l,a),u!==1&&t.setTransform(u,0,0,u,0,0);const f=l/u,m=a/u;t.fillStyle="#ffffff",t.fillRect(0,0,f,m);const p=Math.floor(o/r),h=Math.ceil((o+f)/r);for(let y=p;y<=h;y++){const M=Math.round(y*r-o)+.5;if(y%c===0){t.strokeStyle="#000000",t.beginPath(),t.moveTo(M,0),t.lineTo(M,m),t.stroke();const L=Math.floor(y/c)+1;t.fillStyle="#222",t.font="12px system-ui, sans-serif",t.textAlign="left",t.textBaseline="top",t.fillText(String(L),M+4,2)}else{t.strokeStyle="rgb(128,128,128)";const L=Math.floor(m*.5);t.beginPath(),t.moveTo(M,L),t.lineTo(M,m),t.stroke()}}const g=n,k=g&&Array.isArray(g.tempoAnchors)?g.tempoAnchors:[];if(k&&k.length>0){t.save();const y=new Map;for(const L of k){const S=typeof L.getTickOffset=="function"?L.getTickOffset():L.tick;y.has(S)||y.set(S,[]),y.get(S).push(L)}const M=Math.max(9,Math.min(13,Math.floor(m*.6)));t.font=`${M}px system-ui, sans-serif`,t.textAlign="center",t.textBaseline="middle";const E=12;for(const[L,S]of y.entries()){const G=L/x*r,T=Math.round(G-o)+.5;if(T<-80||T>f+80)continue;const w=S.length,C=(w-1)/2;S.forEach((j,Y)=>{const ht=typeof j.getTempo=="function"?j.getTempo():j.bpm,qt=(Y-C)*E,ue=T+qt,Ct=i!=null&&L===i,fe=w>1?`#${Y+1}`:"",Ft="t"+String(ht)+fe,gt=t.measureText(Ft),Kt=(gt.actualBoundingBoxAscent||M*.8)+(gt.actualBoundingBoxDescent||M*.2),Yn=Math.max(4,Math.floor(M*.5)),Gn=Math.max(2,Math.floor(M*.3)),Pe=Math.ceil(Kt)+Gn*2,sn=Math.ceil(gt.width)+Yn*2;let me=m-Pe-2;me<.5&&(me=.5);const jn=Math.floor(ue-sn/2)+.5,Jn=Ct?"#7cc7ff":"#bfe7ff",Qn=Ct?"#2f9dff":"#5bb6ff",Zn="#003";t.fillStyle=Jn,t.strokeStyle=Qn,t.lineWidth=1,t.beginPath(),t.rect(jn,me,sn,Pe),t.fill(),t.stroke(),t.fillStyle=Zn;const to=me+Pe/2;t.fillText(Ft,ue,Math.floor(to))})}t.restore()}}function mn(t,e,o){const r=window.devicePixelRatio||1,c=e.clientHeight||e.height/r;t.save(),t.setTransform(r,0,0,r,0,0),t.strokeStyle="rgba(255,0,0,0.9)",t.lineWidth=2,t.beginPath(),t.moveTo(Math.floor(o)+.5,0),t.lineTo(Math.floor(o)+.5,c),t.stroke(),t.restore()}function zo(t,e,o,r){const c=window.devicePixelRatio||1,n=e.clientHeight||e.height/c;t.save(),t.setTransform(c,0,0,c,0,0),t.fillStyle="rgba(255,0,0,0.12)",t.fillRect(Math.floor(o),0,Math.ceil(r),n),t.restore()}function Ro(t,e){const o=document.createElement("div");o.style.cssText=`
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    `;const r=document.createElement("div");r.style.cssText=`
        background: #fff;
        width: min(640px, 92vw);
        max-height: 80vh;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        padding: 18px 18px 14px;
        position: relative;
        overflow: auto;
    `;const c=document.createElement("h2");c.textContent=v[b].whatsNewTitle||"What's new",c.style.margin="0 0 8px 0",c.style.fontSize="18px",c.setAttribute("data-i18n","whatsNewTitle");const n=document.createElement("div"),i=(f,m)=>{const p=document.createElement("ul");return p.style.margin="6px 0 0 18px",p.style.padding="0",f.forEach((h,g)=>{const k=document.createElement("li");k.textContent=h;const y=m[g];y&&k.setAttribute("data-i18n",y),p.append(k)}),p};{const f=document.createElement("h3");f.textContent=v[b].whatsNew_20250913_heading||"Tempo rework & notices",f.setAttribute("data-i18n","whatsNew_20250913_heading"),f.style.margin="8px 0 6px 0";const m=[v[b].whatsNew_20250913_p1||"Tempo system reimplemented for improved stability and precision.",v[b].whatsNew_20250913_p2||"Keep BOTH original (OFF) and fixed (ON) mid-tempo versions saved separately.",v[b].whatsNew_20250913_p3||"Mobile optimized editor temporarily paused (no new features)."],p=["whatsNew_20250913_p1","whatsNew_20250913_p2","whatsNew_20250913_p3"];n.append(f,i(m,p))}Ae();const l=xe({label:v[b].ok||"OK",size:"sm",variant:"primary"});l.setAttribute("data-i18n","ok"),l.style.marginTop="12px",l.style.alignSelf="flex-end";const a=()=>{o.remove();try{localStorage.setItem("mml_editor_whatsnew_shown_"+t,"1")}catch{}};l.addEventListener("click",a);const u=f=>{f.key==="Escape"&&a()};window.addEventListener("keydown",u,{once:!0}),o.addEventListener("click",f=>{f.target===o&&a()}),r.append(c,n,l),o.appendChild(r),document.body.appendChild(o)}const Do=mo,zt=document.getElementById("footerMmlEditBtn"),Ce=document.getElementById("footerMMLText"),Tt=document.getElementById("footerLabel"),he=document.getElementById("btnPasteMML"),In="mml_editor_project";let d=wn();const ae=new eo,s=wo(),Je=new Worker(new URL(""+new URL("mmlOptimizerWorker-DAJdBDKe.js",import.meta.url).href,import.meta.url),{type:"module"}),_e=new Map,Ho=300;let Ne=null;const pn=document.getElementById("progress"),z=document.getElementById("roll"),V=document.getElementById("rollBg"),J=document.getElementById("octaveCanvas");let I=null,K=null,Ut=null,$t=null,Mt=null;const P=document.getElementById("timeRuler"),nt=z.getContext("2d"),Te=V?V.getContext("2d"):null,An=J.getContext("2d"),Me=P.getContext("2d"),_t=document.getElementById("tracks"),te=document.getElementById("lenBar"),X=document.getElementById("dispSigN");let F=4,Gt=!1;window.addEventListener("keyup",t=>{(t.key.toLowerCase()==="z"||t.key.toLowerCase()==="y")&&(t.ctrlKey||t.metaKey)&&(Gt=!1)});const hn="mml_editor_display_timesig_n",D=document.getElementById("rollViewport"),Ht=document.getElementById("rulerContainer"),jt=document.getElementById("customScrollbar"),ee=document.getElementById("customScrollbarThumb"),qe=document.getElementById("btnPlay"),Fe=document.getElementById("btnPause"),Ke=document.getElementById("btnStop"),ut=document.getElementById("btnPlayheadMode"),ge=document.getElementById("btnConvert"),ne=document.getElementById("btnGuide"),dt=document.getElementById("btnLoad"),Ve=document.getElementById("btnGoToMobile"),ke=document.getElementById("langKo"),ye=document.getElementById("langJa"),ve=document.getElementById("langEn"),Xo=document.getElementById("btnPushBeat"),Oo=document.getElementById("btnPushBar"),Wo=document.getElementById("btnCutBeat"),qo=document.getElementById("btnCutBar"),ot=document.getElementById("keyHeightRange"),yt=document.getElementById("keyHeightLabel"),st="rgba(255,215,0,0.8)";let H=!1,W=0,Ue=0,St=!1,Fo=0,oe=0,re=0,Qe=!1,Ze=null,Q=null;function Ko(t){const e=s.selectedLength||d.selectedLength;let o=x;if(e&&typeof e=="number"&&e>0)try{o=rt(e)}catch{}return o<=0&&(o=x),Math.max(0,Math.round(t/o)*o)}const ct={pitch:null,sampler:null};let wt=-1,vt="area";const Pn="mml_editor_key_height";(()=>{const t=()=>{try{xn()}catch{}finally{window.removeEventListener("pointerdown",t),window.removeEventListener("keydown",t)}};window.addEventListener("pointerdown",t,{passive:!0}),window.addEventListener("keydown",t)})();const O=document.createElement("button");Ve&&Ve.addEventListener("click",()=>{try{window.location.href="./mobile.html"}catch{}});function Rt(){const t=document.activeElement;if(!t)return;const e=t.tagName.toLowerCase();if((e==="input"||e==="select"||e==="textarea"||e==="button"||t.isContentEditable)&&!t.closest("#rollViewport, #roll, #rollBg, #timeRuler, #rulerContainer"))try{t.blur()}catch{}}function Bn(t){const e=t.target;return e?!!e.closest("#rollViewport, #roll, #rollBg, #timeRuler, #rulerContainer"):!1}function gn(t){const e={timeSig:{beatsPerBar:4},zoomLevel:1,tracks:[],maxEndTick:0,tpqn:t?.tpqn??x,extendedUnitsEnabled:t?.extendedUnitsEnabled??Z},o=Number(t?.timeSig?.beatsPerBar);e.timeSig={beatsPerBar:Number.isFinite(o)&&o>=1?o:4};const r=Number(t?.zoomLevel);e.zoomLevel=Number.isFinite(r)&&r>=1&&r<=9?r:1;try{const f=Number(t?.displayBeatsPerBar);e.displayBeatsPerBar=Number.isFinite(f)&&f>=1&&f<=16?f:void 0}catch{}const c=Array.isArray(t?.tempoAnchors)?t.tempoAnchors:[],n=[];for(const f of c){const m=Number(f?.tempo??f?.bpm??f?.T??f?.t),p=Number(f?.tickOffset??f?.tick??f?.offset);if(!(!Number.isFinite(m)||m<=0||m>1e3)&&!(!Number.isFinite(p)||p<0))try{n.push(new po(Math.round(m),Math.floor(p)))}catch{}}n.sort((f,m)=>f.getTickOffset()-m.getTickOffset()),e.tempoAnchors=n;const i=Array.isArray(t?.tracks)?t.tracks:[],a=Math.max(1,Math.min(24,i.length||6));for(let f=0;f<a;f++){const m=i[f]??{},h=(Array.isArray(m?.notes)?m.notes:[]).map(w=>{const C=typeof w?.id=="string"&&w.id?w.id:crypto.randomUUID(),j=Math.max(0,Math.floor(Number(w?.startTick)||0)),Y=Math.max(1,Math.floor(Number(w?.durationTick)||1)),ht=Math.max(0,Math.floor(Number(w?.pitch)||0)),qt=Math.max(0,Math.min(15,Math.floor(Number(w?.volume)||A)));return new Et(C,ht,j,Y,qt)}),g=typeof m?.instrument=="string"&&Ie.includes(m.instrument)?m.instrument:Ot,k=Number(m?.id)||f+1,y=Number.isFinite(Number(m?.order))?Number(m.order):f,M=typeof m?.name=="string"&&m.name?m.name:`Track ${f+1}`,E=typeof m?.color=="string"&&m.color?m.color:bt[f%bt.length],L=!!m?.mute,S=!!m?.solo,G=typeof m?.mmlString=="string"?m.mmlString:"",T=typeof m?.optimizedMML=="string"?m.optimizedMML:"";e.tracks.push({id:k,order:y,name:M,color:E,instrument:g,mmlString:G,optimizedMML:T,mute:L,solo:S,notes:h})}e.tracks.sort((f,m)=>f.order-m.order),e.tracks.forEach((f,m)=>{f.order=m});let u=0;for(const f of e.tracks)for(const m of f.notes)u=Math.max(u,m.startTick+m.durationTick);return e.maxEndTick=u,e}function Cn(){d.tracks.slice().sort((t,e)=>t.order-e.order).forEach((t,e)=>{t.color=bt[e%bt.length]})}function Vo(t=In){try{const e=localStorage.getItem(t);if(!e)return alert(v[b].noSavedProject||"No saved project found"),!1;const o=JSON.parse(e);if(!o||!o.tracks)return alert(v[b].invalidSavedProject||"Saved data is invalid"),!1;let r=gn(o);const c=!!r.extendedUnitsEnabled;Mn(c);const n=c?Xe:Oe,i=r.tpqn||n;if(i!==n){const l=n/i;Ye(r,l)}r.tpqn=n,r.extendedUnitsEnabled=c,typeof r.selectedLength=="number"&&(s.selectedLength=r.selectedLength),(r.playheadVisualMode==="area"||r.playheadVisualMode==="line")&&(vt=r.playheadVisualMode),typeof r.displayBeatsPerBar=="number"&&(F=r.displayBeatsPerBar),r=gn(r),d=$e(r),d.tracks.some(l=>l.id===s.activeTrackId)||(s.activeTrackId=d.tracks.length?d.tracks[0].id:1);try{s.volumeLabels?.clear()}catch{}for(const l of d.tracks)se(l);for(const l of d.tracks)if((l.notes?.length??0)===0&&l.mmlString&&l.mmlString.trim().length>0)try{on(l,l.mmlString)}catch{}try{d.maxEndTick=Wt()}catch{}try{const l=d.tracks.flatMap(a=>a.notes).reduce((a,u)=>u.startTick<a.startTick?u:a,{startTick:1/0});if(Number.isFinite(l.startTick)&&l.startTick!==1/0){const a=B[d.zoomLevel-1],u=l.startTick/x*a;s.scrollX=Math.max(0,u-40)}}catch{}qn(),yt&&(yt.textContent=String(s.keyHeight)),X&&X.value!==String(F)&&(X.value=String(F)),pt(),q(),R(),N();try{console.log("[loadProjectFromStorage] tracks",d.tracks.map(l=>({id:l.id,notes:l.notes.length,first:l.notes[0]?.startTick}))),console.log("[loadProjectFromStorage] scrollX(px)",s.scrollX)}catch{}return alert(v[b].loadedFromLocal||"Loaded from local storage"),!0}catch(e){try{console.warn("[loadProjectFromStorage] error",e)}catch{}return alert(v[b].loadFailed||"Load failed"),!1}}function xt(){Ne==null&&(Ne=requestAnimationFrame(()=>{Ne=null,R()}))}function $(t,e,o){t.setAttribute("data-i18n-title",e),t.title=o||v[b][e]||""}function lt(t,e,o){t.classList.add("btn",`btn--${e}`,`btn--${o}`)}function Lt(t){return Math.max(0,Math.min(15,t))}function ie(t){return Math.max(12,Math.min(95,t))}function Le(t){return t.sort((e,o)=>e.startTick-o.startTick||e.pitch-o.pitch)}function _n(t){return t.sort((e,o)=>e.startTick-o.startTick||e.id.localeCompare(o.id))}function Uo(t,e){const o=e.volume??A;if(!s.volumeLabels)return;const r=_n(t.notes.slice()),c=r.findIndex(l=>l.id===e.id),n=c>0?r[c-1].volume??A:A,i=r.slice(0,c).some((l,a,u)=>{const f=s.volumeLabels.has(l.id),m=a>0?u[a-1].volume??A:A,p=(l.volume??A)!==m;return f||p});o===A?i?s.volumeLabels.add(e.id):s.volumeLabels.delete(e.id):o!==n?s.volumeLabels.add(e.id):s.volumeLabels.delete(e.id)}function ce(t){return _n(t.notes.slice())}function Nn(t,e,o){if(e<0||e>=t.length)return!1;const r=t[e],c=e>0?t[e-1].volume??A:A,n=r.volume??A;return(o?.has(r.id)??!1)||n!==c}function zn(t,e,o){const r=ce(t),c=r.findIndex(i=>i.id===e.id);if(c<0)return;let n=r.length;for(let i=c+1;i<r.length;i++)if(Nn(r,i,s.volumeLabels)){n=i;break}for(let i=c;i<n;i++)r[i].volume=Lt(o)}function $o(t,e,o){const r=ce(t),c=new Map(r.map(l=>[l.id,l.volume??A])),n=r.map((l,a)=>({n:l,i:a})).filter(l=>e.has(l.n.id)).map(l=>l.i).sort((l,a)=>l-a);let i=0;for(;i<n.length;){const l=n[i];let a=i+1;for(;a<n.length&&n[a]===n[a-1]+1;)a++;const u=l,f=n[a-1],m=u>0?c.get(r[u-1].id)??A:A;for(let h=u;h<=f;h++)r[h].volume=Lt(o);let p=f+1;for(;p<r.length&&e.has(r[p].id);)p++;p<r.length&&(r[p].volume=m),i=a}}function se(t){if(!s.volumeLabels)return;const e=ce(t),o=new Set(e.map(c=>c.id));for(const c of Array.from(s.volumeLabels))o.has(c)&&s.volumeLabels.delete(c);let r=A;for(const c of e){const n=c.volume??A;n!==r&&s.volumeLabels.add(c.id),r=n}}function Yo(){if(I)return;I=document.createElement("div"),I.style.position="fixed",I.style.zIndex="10000",I.style.background="#fff",I.style.border="1px solid #ccc",I.style.boxShadow="0 4px 12px rgba(0,0,0,0.15)",I.style.borderRadius="8px",I.style.padding="10px 12px",I.style.minWidth="220px",I.style.display="none",I.addEventListener("wheel",n=>n.stopPropagation(),{passive:!1});const t=document.createElement("div");t.style.marginBottom="8px",t.textContent=(v[b].volLabel||"볼륨")+" (0-15)",K=document.createElement("input"),K.type="range",K.min="0",K.max="15",K.step="1",K.value=String(A),K.style.width="100%";const e=document.createElement("div");e.style.fontSize="12px",e.style.color="#555",e.style.marginTop="6px";const o=()=>{e.textContent="V"+(K?.value??String(A))};K.addEventListener("input",o),o();const r=document.createElement("div");r.style.display="flex",r.style.gap="8px",r.style.marginTop="10px",Ut=document.createElement("button"),Ut.className="btn btn--primary btn--sm",Ut.textContent=v[b].volApplyRange||"변경",$t=document.createElement("button"),$t.className="btn btn--secondary btn--sm",$t.textContent=v[b].volApplySelected||"선택한 노트만 변경",r.append(Ut,$t),I.append(t,K,e,r),document.body.appendChild(I);const c=()=>{I&&(I.style.display="none"),Mt=null};document.addEventListener("keydown",n=>{I&&I.style.display!=="none"&&n.key==="Escape"&&c()}),document.addEventListener("mousedown",n=>{!I||I.style.display==="none"||I.contains(n.target)||c()}),Ut.addEventListener("click",()=>{if(!Mt||!K)return;const n=d.tracks.find(a=>a.id===s.activeTrackId);if(!n)return;const i=n.notes.find(a=>a.id===Mt);if(!i)return;const l=Lt(parseInt(K.value,10));zn(n,i,l),_(),tt({track:n,recomputeLabels:!0}),I.style.display="none",Mt=null}),$t.addEventListener("click",()=>{if(!K)return;const n=d.tracks.find(l=>l.id===s.activeTrackId);if(!n)return;const i=Lt(parseInt(K.value,10));$o(n,new Set(s.selected),i),_(),tt({track:n,recomputeLabels:!0}),I.style.display="none",Mt=null})}function tn(){I&&I.style.display!=="none"&&(I.style.display="none",Mt=null)}function Go(t,e,o){if(Yo(),!I||!K)return;Mt=t.id;const r=t.volume??A;K.value=String(r);const c=I.querySelector("div:nth-child(3)");c&&(c.textContent="V"+r),I.style.display="block";const n=I.getBoundingClientRect(),i=window.innerWidth,l=window.innerHeight;let a=e,u=o;a+n.width>i&&(a=Math.max(0,i-n.width-8)),u+n.height>l&&(u=Math.max(0,l-n.height-8)),I.style.left=`${a}px`,I.style.top=`${u}px`}function Rn(t){const e=Math.floor(W);if(t!==0){for(const o of d.tracks){for(const r of o.notes)(r.startTick>=e||r.startTick+r.durationTick>e)&&(r.startTick+=t);Le(o.notes)}d.maxEndTick+=Math.max(0,t),_(),en(d.tracks),at(),xt()}}function Dn(t){const e=Math.floor(W);if(t!==0){for(const o of d.tracks){const r=[];for(const c of o.notes){const n=c.startTick,i=c.startTick+c.durationTick;if(i<=e)r.push(c);else{if(n>=e&&n<e+t)continue;if(n>=e+t){const l=c.cloneUI();l.startTick=Math.max(e,n-t),r.push(l)}else if(n<e&&i>e){const l=e-n;if(l>0){const a=c.cloneUI();a.durationTick=l,r.push(a)}}}}Le(r),o.notes=r}d.maxEndTick=Math.max(0,d.maxEndTick-t),_(),en(d.tracks),at(),xt()}}function Hn(){return d.timeSig.beatsPerBar}function jo(){try{d.selectedLength=s.selectedLength,d.playheadVisualMode=vt,d.tpqn=x,d.extendedUnitsEnabled=Z,d.displayBeatsPerBar=F,d.tempoChanges&&Array.isArray(d.tempoChanges);const t={...d,tracks:d.tracks.map(e=>({id:e.id,notes:e.notes.map(o=>({id:o.id,startTick:o.startTick,durationTick:o.durationTick,pitch:o.pitch,volume:o.volume})),name:e.name,instrument:e.instrument,optimizedMML:e.optimizedMML,order:e.order,mute:e.mute,solo:e.solo,color:e.color}))};return localStorage.setItem(In,JSON.stringify(t)),!0}catch{return!1}}let ze=null;function at(){ze&&window.clearTimeout(ze),ze=window.setTimeout(()=>{jo()},300)}function _(){ae.push(d),at()}function $e(t){for(const e of t.tracks)e.notes=e.notes.map(o=>{if(o instanceof Et)return o;try{const r=(o.startTick??o.tickOffset??o.tick_start??0)|0,c=(o.durationTick??o.tick??o.len??0)|0,n=(o.pitch??o.note??60)|0,i=(o.volume??o.velocity??A)|0;return new Et(o.id,n,r,c,i)}catch{return o}});return t}function It(t){const e=_e.get(t.id);e&&clearTimeout(e);const o=setTimeout(()=>{try{Je.postMessage({trackId:t.id,notes:t.notes.map(r=>({id:r.id,startTick:r.startTick,durationTick:r.durationTick,pitch:r.pitch,volume:r.volume})),tpqn:d.tpqn??x,tempoAnchors:d.tempoAnchors?.map(r=>({tempo:r.bpm??r.tempo,tickOffset:r.tick??r.tickOffset}))||[]})}catch{}_e.delete(t.id)},Ho);_e.set(t.id,o)}function en(t){for(const e of t)try{Je.postMessage({trackId:e.id,notes:e.notes.map(o=>({id:o.id,startTick:o.startTick,durationTick:o.durationTick,pitch:o.pitch,volume:o.volume})),tpqn:d.tpqn??x,tempoAnchors:d.tempoAnchors?.map(o=>({tempo:o.bpm??o.tempo,tickOffset:o.tick??o.tickOffset}))||[]})}catch{}}function tt(t={}){const{track:e,recomputeLabels:o}=t;e&&(o&&se(e),It(e),pt()),xt()}function nn(){const t=document.querySelector(".panel.canvas-wrap");t&&(t.style.height="")}function pt(){if(!Ce)return;const t=d.tracks.find(o=>o.id===s.activeTrackId)||d.tracks[0];let e=t&&(t.optimizedMML?.trim?.()||t.mmlString?.trim?.())||"";e=e.replace(/[\r\n]+/g,""),Ce.textContent=e,Ce.title=e}function on(t,e){const o=(e||"").replace(/^[Mm][Mm][Ll]@/,"").replace(/[\r\n]+/g,"").trim();t.mmlString=o;try{const r=Do(o);if(t.notes=r.notes,t.notes.length===0&&/[a-g][+-]?\d?|r\d?/i.test(o)){const c=[],n=/([a-g][+-]?|r)(\d+)?/ig;let i=0;const l=x;let a;for(;a=n.exec(o);){const u=a[1],f=a[2]?parseInt(a[2],10):4,m=Math.max(1,Math.round(l*(4/f)));if(/r/i.test(u)){i+=m;continue}const p={c:60,d:62,e:64,f:65,g:67,a:69,b:71},h=u[0].toLowerCase();let g=p[h]??60;u.includes("+")?g+=1:u.includes("-")&&(g-=1),c.push(new Et(crypto.randomUUID(),g,i,m,15)),i+=m}c.length&&(t.notes=c)}if(d.tracks[0]===t&&(d.tempoAnchors?.length||0)===0&&r.tempos&&r.tempos.length>0)try{const c=r.tempos.slice().sort((n,i)=>n.tickOffset-i.tickOffset).map(n=>({tick:n.tickOffset,bpm:n.tempo}));d.tempoAnchors=c,mt({pushHistory:!1}),it("import-from-mml-initial")}catch{}if(t.notes.length===0&&o.length>0)try{console.warn("[setTrackMML] 파싱 결과 노트 0개",{trackId:t.id,mmlPreview:o.slice(0,120)})}catch{}se(t),_(),It(t),at(),xt()}catch{t.notes=[];try{console.warn("[setTrackMML] 예외 발생으로 노트 비워짐",{trackId:t.id})}catch{}}}function Jo(){const t=d.tracks.filter(c=>c.solo),e=t.length>0?t:d.tracks.filter(c=>!c.mute),o=c=>Ie.includes(c)?c:Ot,r=[];for(const c of e){const n=o(c.instrument||"lute");for(const i of c.notes)r.push({startTick:i.startTick,durationTick:i.durationTick,pitch:i.pitch,trackId:c.id,instrumentKey:n,volume:i.volume})}if(r.length===0){let c=!1;for(const n of d.tracks)if(n.notes.length>0){c=!0;break}if(c){const n=d.tracks.filter(l=>!l.mute),i=n.length>0?n:d.tracks;for(const l of i){const a=o(l.instrument||"lute");for(const u of l.notes)r.push({startTick:u.startTick,durationTick:u.durationTick,pitch:u.pitch,trackId:l.id,instrumentKey:a,volume:u.volume})}}}return r}function At(t){if(!Array.isArray(t))return[];const e=[],o=[];for(const r of t){const c=Number(r?.tick??r?.tickOffset??r?.getTickOffset?.()),n=Number(r?.bpm??r?.tempo??r?.getTempo?.());if(!Number.isFinite(c)){o.push({original:r,reason:"tick NaN"});continue}if(c<0){o.push({original:r,reason:"tick<0"});continue}if(!Number.isFinite(n)){o.push({original:r,reason:"bpm NaN"});continue}if(n<=0){o.push({original:r,reason:"bpm<=0"});continue}if(n>1e3){o.push({original:r,reason:"bpm>1000"});continue}e.push({tick:Math.floor(c),bpm:Math.round(n)})}return o.length&&console.warn("[normalizePlainAnchors] removed entries",o),e.sort((r,c)=>r.tick-c.tick)}let Yt=[];function it(t){try{const e=d.tempoAnchors||[];if(!Array.isArray(e))return;if(Yt.length&&e.length<Yt.length&&!t.startsWith("context-menu-delete")){const r=Yt.slice().filter(c=>!e.some(n=>n.tick===c.tick&&n.bpm===c.bpm));console.warn("[tempoAnchors guard] anchor count decreased",{before:Yt.length,after:e.length,reason:t,removedDiff:r});try{console.trace("[tempoAnchors guard trace]")}catch{}}Yt=e.map(o=>({tick:o.tick,bpm:o.bpm}))}catch{}}function Qo(){q(),Wn(),D&&new ResizeObserver(()=>{wt=-1,R()}).observe(D),((n,i="ghost")=>{n&&lt(n,i,"sm")})(Ve,"secondary"),z.addEventListener("pointermove",n=>{Bn(n)&&Rt(),fr(n)}),z.addEventListener("pointerdown",n=>{Rt(),n.preventDefault(),mr(n)},{passive:!1}),window.addEventListener("pointerup",hr),window.addEventListener("pointermove",pr),window.addEventListener("pointermove",n=>{window.lastPointerX=n.clientX,window.lastPointerY=n.clientY}),window.__ROLL_KEY_LISTENERS__||(window.__ROLL_KEY_LISTENERS__=!0,window.addEventListener("keydown",nr),window.addEventListener("keyup",er)),window.addEventListener("wheel",sr,{passive:!1}),window.addEventListener("contextmenu",n=>{n.preventDefault()},{passive:!1}),D.addEventListener("scroll",ar),P.addEventListener("click",n=>{Rt(),de(n)}),P.addEventListener("pointerdown",n=>{Rt(),n.preventDefault(),br(n)},{passive:!1}),P.addEventListener("contextmenu",n=>{n.preventDefault()}),window.addEventListener("pointermove",wr),window.addEventListener("pointerup",xr),qe.addEventListener("click",$n),Fe.addEventListener("click",Ge),Ke.addEventListener("click",Fn),ot?.addEventListener("input",()=>{const n=Math.max(16,Math.min(32,parseInt(ot.value,10)));if(n!==s.keyHeight){s.keyHeight=n;try{localStorage.setItem(Pn,String(n))}catch{}yt&&(yt.textContent=String(n)),wt=-1,nn(),R()}}),ut&&ut.addEventListener("click",()=>{vt=vt==="area"?"line":"area",ut&&(ut.textContent=vt==="area"?v[b].playheadAreaLabel:v[b].playheadLineLabel),N(),at()}),ge.addEventListener("click",Zo),he.addEventListener("click",()=>{H||Tr()});let e=!1,o=0,r=0;ee.addEventListener("pointerdown",n=>{e=!0,o=n.clientX,r=s.scrollX,ee.setPointerCapture(n.pointerId)}),window.addEventListener("pointermove",n=>{if(!e||H)return;const i=n.clientX-o,l=Bt(),a=Math.max(0,l-D.clientWidth),u=Math.max(1,jt.clientWidth-ee.clientWidth),f=a/u,m=r+i*f;s.scrollX=Se(m),N()}),window.addEventListener("pointerup",()=>{e=!1}),ne.addEventListener("click",dn),dt&&(lt(dt,"secondary","md"),dt.textContent=v[b].load||"Load",$(dt,"tooltipLoad",v[b].tooltipLoad||"Load project"),dt.addEventListener("click",()=>{Vo()}));const c=n=>{ao(n),Un(),ut&&(ut.textContent=vt==="area"?v[b].playheadAreaLabel:v[b].playheadLineLabel),Tt&&(Tt.textContent=v[b].trackMMLLabel||(n==="ja"?"トラックMML":n==="en"?"Track MML":"트랙MML")),dt&&(dt.textContent=v[b].load||(n==="ja"?"読み込み":n==="en"?"Load":"불러오기"),$(dt,"tooltipLoad",v[b].tooltipLoad||dt.title||"Load project")),ot&&(ot.title=v[b].tooltipKeyHeight||ot.title),yt&&(yt.textContent=String(s.keyHeight));try{const i=document.getElementById("langKo"),l=document.getElementById("langJa"),a=document.getElementById("langEn");i?.setAttribute("role","radio"),l?.setAttribute("role","radio"),a?.setAttribute("role","radio"),i?.setAttribute("aria-checked",String(n==="ko")),l?.setAttribute("aria-checked",String(n==="ja")),a?.setAttribute("aria-checked",String(n==="en"))}catch{}q(),pt()};ke.addEventListener("click",()=>c("ko")),ye.addEventListener("click",()=>c("ja")),ve.addEventListener("click",()=>c("en")),ne.addEventListener("click",dn)}function Zo(){const t=d.tracks.slice().sort((e,o)=>e.order-o.order);for(const e of t)!(Array.isArray(e.notes)&&e.notes.length>0)||(lo(e.notes??[])||Ln(e.notes??[]));uo(d)}P.addEventListener("pointerdown",t=>{const e=d.tempoAnchors||[];if(!e.length)return;const o=P.getBoundingClientRect(),r=t.clientX-o.left,c=B[d.zoomLevel-1],n=P.height/(window.devicePixelRatio||1),i=Math.max(9,Math.min(13,Math.floor(n*.6))),l=Me;l.font=`${i}px system-ui, sans-serif`;let a=null;for(const u of e){const f=typeof u.getTickOffset=="function"?u.getTickOffset():u.tick,m=typeof u.getTempo=="function"?u.getTempo():u.bpm,p=f/x*c,h=Math.round(p-s.scrollX)+.5,g="t"+m,k=l.measureText(g),y=(k.actualBoundingBoxAscent||i*.8)+(k.actualBoundingBoxDescent||i*.2),M=Math.max(4,Math.floor(i*.5)),E=Math.max(2,Math.floor(i*.3)),L=Math.ceil(y)+E*2,S=Math.ceil(k.width)+M*2;let T=n-L-2;T<.5&&(T=.5);const w=Math.floor(h-S/2)+.5;if(r>=w-4&&r<=w+S+4&&t.offsetY>=T&&t.offsetY<=T+L){a=u;break}}if(a){t.preventDefault();const u=typeof a.getTickOffset=="function"?a.getTickOffset():a.tick;Q={originalTick:u,anchor:a,startX:t.clientX,startScrollX:s.scrollX},Ze=u,t.target.setPointerCapture(t.pointerId)}});P.addEventListener("pointermove",t=>{if(!Q)return;const e=d.tempoAnchors||[],o=B[d.zoomLevel-1],r=t.clientX-Q.startX,n=Q.originalTick/x*o+r;let i=Math.round(n/o*x);i=Ko(i),i=Math.max(0,i),typeof Q.anchor.setTickOffset=="function"?Q.anchor.setTickOffset(i):Q.anchor.tick=i;for(let l=e.length-1;l>=0;l--){const a=e[l];if(a===Q.anchor)continue;(typeof a.getTickOffset=="function"?a.getTickOffset():a.tick)===i&&e.splice(l,1)}e.sort((l,a)=>(typeof l.getTickOffset=="function"?l.getTickOffset():l.tick)-(typeof a.getTickOffset=="function"?a.getTickOffset():a.tick)),Ze=i,xt()});P.addEventListener("pointerup",t=>{if(Q){Q=null,_();try{const e=d.tracks.find(o=>o.id===s.activeTrackId)||d.tracks[0];e&&tt({track:e})}catch{}}t.target.releasePointerCapture(t.pointerId)});P.addEventListener("pointerleave",()=>{Q&&(Q=null,_())});function Ee(t){const e=z.getBoundingClientRect(),o=t.clientX-e.left+s.scrollX,r=t.clientY-e.top;return{x:o,y:r}}function tr(t){const e=P.getBoundingClientRect();return{x:t.clientX-e.left+s.scrollX}}P.addEventListener("contextmenu",t=>{t.preventDefault()},{passive:!1});function er(t){t.key==="Alt"&&(Qe=!1,R()),U()}function nr(t){tn(),U();const e=document.activeElement;if(e&&(e.tagName==="INPUT"||e.tagName==="TEXTAREA"||e.tagName==="SELECT"||e.isContentEditable))return;t.key==="Alt"&&(t.preventDefault(),Qe=!0,R());for(let n=1;n<=9;n++)t.key===n.toString()&&bn(n-1);if(t.key==="0"&&bn(Dt.length-1),H){t.code==="Space"&&(t.preventDefault(),Ge());return}if((t.key==="ArrowUp"||t.key==="ArrowDown")&&t.shiftKey){const n=document.activeElement;if(n&&(n.tagName==="INPUT"||n.tagName==="SELECT"))return;t.preventDefault();const i=d.tracks.find(p=>p.id===s.activeTrackId);if(!i)return;const l=i.notes.filter(p=>s.selected.has(p.id));if(l.length===0)return;const a=p=>Math.floor(cn(p)/12),u=Math.min(...l.map(p=>a(p.pitch))),f=Math.max(...l.map(p=>a(p.pitch)));if(t.key==="ArrowUp"&&f>=7||t.key==="ArrowDown"&&u<=1)return;const m=t.key==="ArrowUp"?12:-12;for(const p of i.notes)s.selected.has(p.id)&&(p.pitch=cn(p.pitch+m));_(),tt({track:i,recomputeLabels:!0});return}if((t.key==="ArrowUp"||t.key==="ArrowDown")&&!t.shiftKey&&!t.ctrlKey&&!t.metaKey&&!t.altKey){const n=document.activeElement;if(n&&(n.tagName==="INPUT"||n.tagName==="SELECT"))return;t.preventDefault();const i=d.tracks.slice().sort((f,m)=>f.order-m.order),l=i.findIndex(f=>f.id===s.activeTrackId);if(l===-1)return;const a=t.key==="ArrowUp"?-1:1,u=Math.max(0,Math.min(i.length-1,l+a));u!==l&&(s.activeTrackId=i[u].id,q(),R(),pt());return}const o=t.ctrlKey||t.metaKey;if(o&&t.key.toLowerCase()==="z"){if(t.repeat||Gt)return;Gt=!0,t.preventDefault();const n=ae.undo(d);if(n){d=$e(n),typeof d.displayBeatsPerBar=="number"&&(F=d.displayBeatsPerBar,X&&X.value!==String(F)&&(X.value=String(F)));let i=0;for(const l of d.tracks)for(const a of l.notes)i=Math.max(i,a.startTick+a.durationTick);d.maxEndTick=i;for(const l of d.tracks)try{se(l)}catch{}try{const l=At(d.tempoAnchors||[]);d.tempoAnchors=l}catch{}for(const l of d.tracks)It(l);s.selected.clear(),R(),q()}return}if(o&&t.key.toLowerCase()==="y"){if(t.repeat||Gt)return;Gt=!0,t.preventDefault();const n=ae.redo(d);if(n){d=$e(n),typeof d.displayBeatsPerBar=="number"&&(F=d.displayBeatsPerBar,X&&X.value!==String(F)&&(X.value=String(F)));let i=0;for(const l of d.tracks)for(const a of l.notes)i=Math.max(i,a.startTick+a.durationTick);d.maxEndTick=i;for(const l of d.tracks)try{se(l)}catch{}try{const l=At(d.tempoAnchors||[]);d.tempoAnchors=l}catch{}for(const l of d.tracks)It(l);s.selected.clear(),R(),q()}return}if(o&&t.key.toLowerCase()==="a"){t.preventDefault(),or();return}if(t.key==="Escape"){s.selected.clear(),s.marquee.active=!1,s.drag=null,s.ghost=null,R();return}if(t.key==="Delete"){Xn();return}if(o&&t.key.toLowerCase()==="c"){t.preventDefault(),On();return}if(o&&t.key.toLowerCase()==="v"){t.preventDefault(),ir();return}if(o&&t.key.toLowerCase()==="x"){t.preventDefault(),rr();return}if(t.code==="Space"){t.preventDefault(),H?Ge():$n();return}const r=B[d.zoomLevel-1],c=d.timeSig.beatsPerBar*r;if(t.key==="PageDown"){t.preventDefault(),s.scrollX=Math.max(0,Math.ceil((s.scrollX+1)/c)*c),N();return}if(t.key==="PageUp"){t.preventDefault(),s.scrollX=Math.max(0,Math.floor((s.scrollX-1)/c)*c),N();return}if(t.key==="Home"){t.preventDefault(),s.scrollX=0,N();return}if(t.key==="End"){t.preventDefault();const n=Bt();s.scrollX=Se(Math.max(0,n-D.clientWidth)),N();return}}function or(){s.selected.clear();const t=d.tracks.find(e=>e.id===s.activeTrackId);for(const e of t.notes)s.selected.add(e.id);R()}function Xn(){if(s.selected.size===0)return;const t=d.tracks.find(e=>e.id===s.activeTrackId);t.notes=t.notes.filter(e=>!s.selected.has(e.id)),s.selected.clear(),_(),tt({track:t})}function On(){const e=d.tracks.find(r=>r.id===s.activeTrackId).notes.filter(r=>s.selected.has(r.id));if(e.length===0)return;const o=Math.min(...e.map(r=>r.startTick));s.clipboard=e.map(r=>{const c=r.cloneUI();return c.startTick=r.startTick-o,c})}function rr(){On(),Xn()}function ir(){if(!s.clipboard||s.clipboard.length===0)return;const t=Math.max(0,Math.floor(W)),e=d.tracks.find(o=>o.id===s.activeTrackId);if(e){if(s.selected.clear(),s.clipboard!=null)for(const o of s.clipboard){const r=crypto.randomUUID(),c=Math.max(0,t+o.startTick),n=new Et(r,o.pitch,c,o.durationTick,o.volume??A);Re(d,e.id,{id:n.id,startTick:n.startTick,durationTick:n.durationTick,pitch:n.pitch,volume:n.volume}),pe(d,n.startTick+n.durationTick),s.selected.add(r)}_(),tt({track:e})}}function ar(){const e=-D.scrollTop+s.keyHeight;J.style.transform=`translateY(${e}px)`,U()}function sr(t){if(Bn(t)&&Rt(),tn(),U(),t.ctrlKey){t.preventDefault(),cr(t);return}if(t.altKey&&t.shiftKey&&s.selected.size>0&&!H){t.preventDefault();const e=t.deltaY>0?-1:1,o=d.tracks.find(u=>u.id===s.activeTrackId),r=ce(o),c=new Map(r.map(u=>[u.id,u.volume??A])),n=new Set([...s.selected]),i=r.map((u,f)=>({n:u,i:f})).filter(u=>n.has(u.n.id)).map(u=>u.i).sort((u,f)=>u-f),l=new Map;for(const u of i){const f=r[u].id,m=c.get(f)??A;l.set(u,Lt(m+e))}let a=0;for(;a<i.length;){const u=i[a],f=l.get(u);let m=a+1;for(;m<i.length&&i[m]===i[m-1]+1&&l.get(i[m])===f;)m++;const p=u,h=i[m-1],g=p>0?c.get(r[p-1].id)??A:A;for(let y=p;y<=h;y++)r[y].volume=Lt(l.get(y));let k=h+1;for(;k<r.length&&n.has(r[k].id);)k++;k<r.length&&(r[k].volume=g,Uo(o,r[k])),a=m}tt({track:o,recomputeLabels:!0}),kn();return}if(t.altKey&&!t.shiftKey&&s.selected.size>0&&!H){t.preventDefault();const e=t.deltaY>0?-1:1,o=d.tracks.find(c=>c.id===s.activeTrackId),r=o.notes.filter(c=>s.selected.has(c.id));if(r.length>0){const c=r.reduce((l,a)=>a.startTick<l.startTick?a:l),n=c.volume??A,i=Lt(n+e);zn(o,c,i)}tt({track:o,recomputeLabels:!0}),kn();return}if(t.shiftKey){t.preventDefault();const e=B[d.zoomLevel-1],o=d.timeSig.beatsPerBar*e,c=(Math.abs(t.deltaX)>Math.abs(t.deltaY)?t.deltaX:t.deltaY)>0?1:-1,n=Bt(),i=Math.max(0,n-D.clientWidth);let l=Math.max(0,Math.min(i,s.scrollX+c*o));if(H){const a=W/x*e,u=D.clientWidth,f=Math.max(0,Math.min(i,Math.floor(a-u))),m=Math.max(0,Math.min(i,Math.floor(a)));l=Math.max(f,Math.min(m,l));let p=Se(l);const h=Math.max(0,Math.min(i,Math.ceil(f/o)*o)),g=Math.max(0,Math.min(i,Math.floor(m/o)*o));h<=g?((p<h||p>g)&&(p=c>0?g:h),l=p):l=s.scrollX}s.scrollX=Se(l),N();return}}let Nt=null;function kn(){Nt!=null&&(cancelAnimationFrame(Nt),Nt=null);const t=performance.now(),e=()=>{performance.now()-t>=120?(_(),Nt=null):Nt=requestAnimationFrame(e)};Nt=requestAnimationFrame(e)}function cr(t){const e=t.deltaY>0?-1:1,o=Math.max(1,Math.min(9,d.zoomLevel+e));if(o===d.zoomLevel)return;const r=B[d.zoomLevel-1],c=D.getBoundingClientRect(),n=Math.max(0,Math.min(t.clientX-c.left,c.width)),i=s.scrollX+n,l=r*d.timeSig.beatsPerBar,u=Math.max(0,Math.round(i/l)*l)/r*x;d.zoomLevel=o;const f=B[o-1],m=u/x*f,p=Bt(),h=Math.max(0,p-D.clientWidth);s.scrollX=Math.max(0,Math.min(h,m-n));const g=f*d.timeSig.beatsPerBar;s.scrollX=Math.max(0,Math.min(h,Math.floor(s.scrollX/g)*g)),wt=-1,R()}function lr(t){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function q(){pt(),Cn(),_t.innerHTML="",_t.style.overflowY="auto";const t=d.tracks.slice().sort((n,i)=>n.order-i.order),e=[];t.forEach(n=>{(!n.instrument||!Ie.includes(n.instrument))&&(n.instrument=Ot);const i=n.id===s.activeTrackId,l=n.optimizedMML?.length||0,a=v[b].charUnit,u=d.tracks.length-1,f=n.order===0?"disabled":"",m=n.order===u?"disabled":"";e.push(`
            <div class="track-card${i?" is-active":""}" data-track-id="${n.id}" data-order="${n.order}">
                <div class="track-color" style="background:${n.color};"></div>
                <div class="track-main">
                    <div class="track-row track-row--top" style="width:100%">
                        <div class="track-name">
                            <input class="track-name-input" data-i18n-title="tooltipTrackName" title="${v[b].tooltipTrackName}" value="${lr(n.name)}" />
                        </div>
                        <button type="button" class="track-delete-btn" title="Delete" aria-label="Delete track" style="margin-left:8px;width:20px;height:20px;line-height:18px;font-size:12px;border:1px solid #c33;border-radius:4px;background:#fff;color:#c33;cursor:pointer;padding:0;">✕</button>
                    </div>
                    <div class="track-row track-row--middle" style="width:100%;display:flex;align-items:center;gap:8px">
                        <div class="track-instrument" style="flex:1 1 auto"><!-- dropdown placeholder --></div>
                        ${i?`<div class="track-reorder" style="display:flex;align-items:center;gap:4px">
                            <button type="button" class="btn-reorder-up track-reorder-btn" aria-label="Move track up" title="Move up" ${f} style="width:20px;height:20px;line-height:18px;font-size:11px;border:1px solid #999;border-radius:4px;background:#fff;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;padding:0;">▲</button>
                            <button type="button" class="btn-reorder-down track-reorder-btn" aria-label="Move track down" title="Move down" ${m} style="width:20px;height:20px;line-height:18px;font-size:11px;border:1px solid #999;border-radius:4px;background:#fff;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;padding:0;">▼</button>
                        </div>`:""}
                    </div>
                    <div class="track-row track-row--bottom">
                        <div class="track-controls-placeholder"></div>
                        <span class="track-charcount" data-i18n-title="tooltipCharCount" title="${v[b].tooltipCharCount}">${l}${a}</span>
                    </div>
                </div>
            </div>`)});const o=24-t.length;o>0&&e.push(`
            <div class="track-add-panel" style="padding:8px 6px;display:flex;align-items:center;gap:6px;border:1px dashed #bbb;margin-top:6px;border-radius:4px;">
                <span style="font-size:12px;">트랙추가</span>
                <input type="number" class="track-add-count" min="1" max="${o}" value="1" style="width:30px;padding:2px 4px;font-size:12px;" />
                <button type="button" class="btn btn--secondary track-add-btn btn--sm">+</button>
            </div>`),_t.innerHTML=e.join(""),t.forEach(n=>{const i=_t.querySelector(`.track-card[data-track-id="${n.id}"]`);if(!i)return;const l=i.querySelector("input.track-name-input");if(l&&(ko(l,{size:"sm"}),l.addEventListener("change",()=>{n.name=l.value,_()}),["mousedown","mouseup"].forEach(p=>l.addEventListener(p,h=>h.stopPropagation()))),n.id===s.activeTrackId){const p=i.querySelector("button.btn-reorder-up"),h=i.querySelector("button.btn-reorder-down");p&&(p.addEventListener("click",g=>{g.stopPropagation(),yn(-1)}),["mousedown","mouseup"].forEach(g=>p.addEventListener(g,k=>k.stopPropagation()))),h&&(h.addEventListener("click",g=>{g.stopPropagation(),yn(1)}),["mousedown","mouseup"].forEach(g=>h.addEventListener(g,k=>k.stopPropagation())))}const u=i.querySelector(".track-delete-btn");u&&(["mousedown","mouseup"].forEach(p=>u.addEventListener(p,h=>h.stopPropagation())),u.addEventListener("click",p=>{if(p.stopPropagation(),d.tracks.length<=1)return;const h=d.tracks.findIndex(g=>g.id===n.id);h>=0&&(d.tracks.splice(h,1),d.tracks.sort((g,k)=>g.order-k.order).forEach((g,k)=>g.order=k),d.tracks.some(g=>g.id===s.activeTrackId)||(s.activeTrackId=d.tracks[0].id),_(),q(),R())}));const f=i.querySelector(".track-instrument");if(f){const p=no(),h=go({items:p,value:n.instrument,size:"sm",fullWidth:!0,onChange:g=>{n.instrument=g,_()}});h.el.setAttribute("data-i18n-title","tooltipInstrument"),h.el.title=v[b].tooltipInstrument,f.innerHTML="",f.appendChild(h.el),["mousedown","mouseup"].forEach(g=>h.el.addEventListener(g,k=>k.stopPropagation()))}const m=i.querySelector(".track-controls-placeholder");if(m){const p=ur(n);m.replaceWith(p),p.querySelectorAll("button").forEach(h=>["mousedown","mouseup"].forEach(g=>h.addEventListener(g,k=>k.stopPropagation())))}i.addEventListener("click",p=>{const h=p.target.tagName;h==="INPUT"||h==="SELECT"||h==="BUTTON"||p.target.isContentEditable||s.activeTrackId!==n.id&&(s.activeTrackId=n.id,q(),R())})});const r=_t.querySelector(".track-add-btn"),c=_t.querySelector(".track-add-count");if(r&&c){const n=()=>{const i=24-d.tracks.length,l=Math.min(Math.max(1,parseInt(c.value)||1),i);if(c.value=String(l),c.max=String(i),i<=0){r.style.display="none",c.style.display="none";const a=r.closest(".track-add-panel");a&&(a.style.display="none")}};c.addEventListener("input",n),r.addEventListener("click",()=>{const i=24-d.tracks.length;if(i<=0)return;let l=Math.min(Math.max(1,parseInt(c.value)||1),i);for(let a=0;a<l;a++){const u=d.tracks.reduce((m,p)=>Math.max(m,p.id),0)+1||d.tracks.length+1,f=d.tracks.length;d.tracks.push({id:u,order:f,name:`Track ${f+1}`,color:bt[f%bt.length],instrument:Ot,mmlString:"",optimizedMML:"",mute:!1,solo:!1,notes:[]})}_(),q(),R()}),n()}}function yn(t){const e=d.tracks.find(i=>i.id===s.activeTrackId);if(!e)return;const o=e.order,r=d.tracks.length-1,c=o+t;if(c<0||c>r)return;const n=d.tracks.find(i=>i.order===c);n&&(e.order=c,n.order=o),_(),Cn(),q(),at(),R()}function Wn(){te.innerHTML="",Ae(),Dt.forEach(t=>{const e=xe({label:String(t),size:"sm",variant:t===s.selectedLength?"primary":"secondary"});t===s.selectedLength&&e.classList.add("active"),e.setAttribute("data-i18n-title","tooltipLength"),t===64?e.title=(v[b].tooltipLength||"Length")+" - 0 (주의: 인게임에서 박자가 어긋날 수 있음)":e.title=v[b].tooltipLength,e.addEventListener("click",()=>{rn(t)}),t===48&&(e.style.marginRight="12px"),te.appendChild(e)}),O.textContent=Z?v[b].extendedLessLabel||"더 적은 단위":v[b].extendedMoreLabel||"더 많은 단위",O.title=Z?v[b].tooltipExtendedLess||"기본 단위로 돌아가기":v[b].tooltipExtendedMore||"더 많은 단위 사용 (64/128/5/7/11)",O.setAttribute("data-i18n",Z?"extendedLessLabel":"extendedMoreLabel"),$(O,Z?"tooltipExtendedLess":"tooltipExtendedMore",O.title),O.setAttribute("aria-label",O.title),O.addEventListener("click",dr),te.appendChild(O)}function dr(){if(!Z){const e="mml_editor_warn_extended_shown";let o=!1;try{o=localStorage.getItem(e)==="1"}catch{}if(!o){if(!window.confirm(v[b].confirmEnableExtendedUnits||"Enable more units to use 64/128/5/7/11; existing ticks will be converted. Continue?"))return;try{localStorage.setItem(e,"1")}catch{}}vn(!0)}else vn(!1)}function vn(t){_();const r=(t?Xe:Oe)/(t?Oe:Xe);Ye(d,r),Mn(t),d.tpqn=x,d.extendedUnitsEnabled=t;try{ae.transformSnapshots?.(c=>Ye(c,r))}catch{}qn(),Wn(),R()}function qn(){if(!Dt.includes(s.selectedLength)){let t=Dt[0],e=Math.abs(t-s.selectedLength);for(const o of Dt){const r=Math.abs(o-s.selectedLength);r<e&&(t=o,e=r)}rn(t)}}function Ye(t,e){if(!(!Number.isFinite(e)||e<=0)){for(const o of t.tracks)for(const r of o.notes)r.startTick=Math.round(r.startTick*e),r.durationTick=Math.max(1,Math.round(r.durationTick*e));t.maxEndTick=Math.round(t.maxEndTick*e)}}function rn(t){if(!te)return;s.selectedLength=t;const e=Array.from(te.children);e.forEach(o=>o.classList.remove("active")),e.forEach(o=>{if(o instanceof HTMLButtonElement){const c=parseInt(o.textContent||"0",10)===t;c&&o.classList.add("active"),o.classList.remove("btn--primary","btn--secondary"),o.classList.add(c?"btn--primary":"btn--secondary")}}),R(),at()}function ur(t){const e=document.createElement("div");e.className="track-controls";const o=(n,i,l)=>{const a=document.createElement("button");return a.textContent=n,a.style.cssText=`
            width: 24px;
            height: 24px;
            font-size: 12px;
            font-weight: bold;
            border-radius: 4px;
            border: 1px solid #ccc;
            cursor: pointer;
            background-color: ${i?l:"#fff"};
            color: ${i?"#fff":"#000"};
        `,a},r=o("M",t.mute,"#f44336");r.setAttribute("data-i18n-title","tooltipMute"),r.title=v[b].tooltipMute,r.addEventListener("click",()=>{t.mute=!t.mute,_(),q(),R()});const c=o("S",t.solo,"#ff9800");return c.setAttribute("data-i18n-title","tooltipSolo"),c.title=v[b].tooltipSolo,c.addEventListener("click",()=>{t.solo=!t.solo,_(),q(),R()}),e.append(r,c),e}function bn(t){const e=Dt[t];typeof e=="number"&&rn(e)}function fr(t){if(H){s.hover.noteId=null,s.hover.edge=null,z.style.cursor="not-allowed";return}const{x:e,y:o}=Ee(t),r=B[d.zoomLevel-1],c=d.tracks.find(n=>n.id===s.activeTrackId);if(!s.drag&&!s.marquee.active){const n=We(e,o,c.notes,r,s.keyHeight);n?(s.hover.noteId=n.note.id,s.hover.edge=n.edge,z.style.cursor=n.edge==="center"?"move":"ew-resize"):(s.hover.noteId=null,s.hover.edge=null,z.style.cursor="default"),N();return}if(s.marquee.active){s.marquee.x1=e,s.marquee.y1=o;const n=t.ctrlKey||t.metaKey,i=t.shiftKey;s.marquee.mode=n?"toggle":i?"add":"replace";const l=Co(s.marquee.x0,s.marquee.y0,s.marquee.x1,s.marquee.y1,c.notes,r,s.keyHeight),a=new Set(s.selected);if(s.marquee.mode==="replace"){s.selected.clear();for(const u of l)s.selected.add(u.id)}else if(s.marquee.mode==="add")for(const u of l)s.selected.add(u.id);else{s.selected=a;for(const u of l)s.selected.has(u.id)?s.selected.delete(u.id):s.selected.add(u.id)}N()}}function mr(t){if(Rt(),U(),xn(),H){t.preventDefault(),z.style.cursor="not-allowed";return}if(tn(),t.button===1){t.preventDefault(),St=!0,de(t);return}if(t.button===2){t.preventDefault();const{x:m,y:p}=Ee(t),h=B[d.zoomLevel-1],g=d.tracks.find(y=>y.id===s.activeTrackId),k=We(m,p,g.notes,h,s.keyHeight);if(k)s.selected.has(k.note.id)||(s.selected.clear(),s.selected.add(k.note.id),N()),Go(k.note,t.clientX,t.clientY);else{const y=t.ctrlKey||t.metaKey,M=t.shiftKey;s.drag=null,s.ghost=null,s.marquee.active=!0,s.marquee.x0=m,s.marquee.y0=p,s.marquee.x1=m,s.marquee.y1=p,s.marquee.mode=y?"toggle":M?"add":"replace",N()}return}if(t.button!==0)return;const{x:e,y:o}=Ee(t),r=B[d.zoomLevel-1],c=d.tracks.find(m=>m.id===s.activeTrackId),n=We(e,o,c.notes,r,s.keyHeight);if(!n){const m=rt(s.selectedLength),p=e/r*x,h=oo(p,m),g=ie(95-Math.floor(o/s.keyHeight)),k=rt(s.selectedLength),y=crypto.randomUUID();s.drag={kind:"create",trackId:s.activeTrackId,noteId:y,startTick:h,durationTick:k,pitch:g},s.ghost={startTick:h,durationTick:k,pitch:g,color:st};const M=d.tracks.find(E=>E.id===s.activeTrackId);M&&be(g,M.id,M.instrument,ct),N();return}const i=n.note,l=t.ctrlKey||t.metaKey,a=s.selected.has(i.id);l?a||s.selected.add(i.id):a||(s.selected.clear(),s.selected.add(i.id));{const m=d.tracks.find(p=>p.id===s.activeTrackId);m&&be(i.pitch,m.id,m.instrument,ct)}const u=i.startTick,f=i.startTick+i.durationTick;if(n.edge==="center"){const m=Array.from(s.selected),p=d.tracks.find(g=>g.id===c.id).notes.filter(g=>s.selected.has(g.id)).map(g=>({id:g.id,startTick:g.startTick,pitch:g.pitch,durationTick:g.durationTick,volume:g.volume})),h=rt(s.selectedLength);oe=0,re=0,s.moveGroup={trackId:c.id,ids:m,base:p,mouseStartX:e,mouseStartY:o,grid:h},s.drag={kind:"move",trackId:c.id,noteId:i.id,startTick0:u,yPitch0:i.pitch,mouseStartX:e,mouseStartY:o},s.ghost={startTick:i.startTick,durationTick:i.durationTick,pitch:i.pitch,color:st},N();return}else n.edge==="left"?(s.drag={kind:"resize-left",trackId:c.id,noteId:i.id,startTick0:u,endTick0:f,mouseStartX:e},s.ghost={startTick:i.startTick,durationTick:i.durationTick,pitch:i.pitch,color:st}):n.edge==="right"&&(s.drag={kind:"resize-right",trackId:c.id,noteId:i.id,startTick0:u,endTick0:f,mouseStartX:e},s.ghost={startTick:i.startTick,durationTick:i.durationTick,pitch:i.pitch,color:st});N()}function pr(t){if(H)return;if(St){de(t);return}if(s.marquee.active||!s.drag)return;const{x:e,y:o}=Ee(t),r=B[d.zoomLevel-1],c=rt(s.selectedLength);if(s.drag.kind==="move"||s.drag.kind==="resize-left"||s.drag.kind==="resize-right"){if(s.drag.kind==="move"){const u=document.elementFromPoint(t.clientX,t.clientY)?.closest?.(".track-card");document.querySelectorAll(".track-card.drop-hover").forEach(f=>f.classList.remove("drop-hover")),u&&parseInt(u.dataset.trackId||"-1",10)!==s.drag.trackId&&u.classList.add("drop-hover")}const n=d.tracks.find(a=>s.drag!=null&&a.id===s.drag.trackId),i=n.notes.findIndex(a=>s.drag!=null&&a.id===s.drag.noteId);if(i<0)return;const l=n.notes[i];if(s.drag.kind==="move"){const a=s.moveGroup;if(!a)return;const u=(e-a.mouseStartX)/r,f=Math.floor((a.mouseStartY-o)/s.keyHeight),m=u*x,p=Math.round(m/a.grid)*a.grid;oe=p,re=f;const h=ie(s.drag.yPitch0+f),g=d.tracks.find(E=>E.id===s.activeTrackId);g&&be(h,g.id,g.instrument,ct),N();const k=r,y=s.scrollX,M=window.devicePixelRatio||1;nt.save(),nt.setTransform(M,0,0,M,0,0),nt.globalAlpha=.7,nt.fillStyle=st;for(const E of a.base){const L=Math.max(0,E.startTick+p),S=Math.round(L/x*k)-Math.floor(y)+.5,G=Math.max(1,Math.round(E.durationTick/x*k)),w=(95-ie(E.pitch+f))*s.keyHeight+.5,C=s.keyHeight-1;nt.fillRect(S,w,G,C)}nt.globalAlpha=1,nt.restore();return}if(s.drag.kind==="resize-left"){const a=(e-s.drag.mouseStartX)/r;let u=s.drag.startTick0+a*x,f=Math.max(0,Math.floor(u/c)*c);f=Math.min(f,s.drag.endTick0-c);const m=s.drag.endTick0-f;s.ghost={startTick:f,durationTick:m,pitch:l.pitch,color:st};const p=s.drag.endTick0-s.drag.startTick0,h=Math.max(0,p-m),g=rt(32),k=d.tracks.find(E=>E.id===s.drag.trackId),y=new Set(s.selected),M=[];if(h>0)for(const E of k.notes){if(E.id===s.drag.noteId||!y.has(E.id))continue;const L=Math.max(g,E.durationTick-h);M.push({startTick:E.startTick,durationTick:L,pitch:E.pitch,color:st})}s.ghostGroup=M.length?M:null,N();return}if(s.drag.kind==="resize-right"){const a=(e-s.drag.mouseStartX)/r;let u=s.drag.endTick0+a*x,f=Math.max(s.drag.startTick0+c,Math.ceil(u/c)*c);const m=d.tracks.find(S=>S.id===s.drag.trackId),p=s.drag.startTick0,h=m.notes.filter(S=>S.startTick>p).sort((S,G)=>S.startTick-G.startTick)[0];h&&(f=Math.min(f,h.startTick));const g=f-s.drag.startTick0;s.ghost={startTick:s.drag.startTick0,durationTick:g,pitch:l.pitch,color:st};const k=s.drag.endTick0-s.drag.startTick0,y=Math.max(0,g-k),M=d.tracks.find(S=>S.id===s.drag.trackId),E=new Set(s.selected),L=[];if(y>0)for(const S of M.notes){if(S.id===s.drag.noteId||!E.has(S.id))continue;const G=M.notes.filter(j=>j.startTick>S.startTick).sort((j,Y)=>j.startTick-Y.startTick)[0];let T=Number.POSITIVE_INFINITY;G&&(T=Math.max(0,G.startTick-(S.startTick+S.durationTick)));const w=Math.max(0,Math.min(y,T)),C=S.durationTick+w;L.push({startTick:S.startTick,durationTick:C,pitch:S.pitch,color:st})}s.ghostGroup=L.length?L:null,N();return}}if(s.drag.kind==="create"){const n=s.drag.startTick,i=(e-n/x*r)/r,l=n+Math.max(c,Math.round(i*x)),u=Math.max(n+c,Math.ceil(l/c)*c)-n,f=ie(95-Math.floor(o/s.keyHeight));s.ghost={startTick:n,durationTick:u,pitch:f,color:st};const m=d.tracks.find(p=>p.id===s.activeTrackId);m&&be(f,m.id,m.instrument,ct),N()}}function hr(){if(H)return;if(St){St=!1;return}ct.sampler&&ct.pitch!==null&&(co(ct.sampler,ct.pitch),ct.pitch=null,ct.sampler=null);const t=document.activeElement;if(t&&(t.tagName==="INPUT"||t.tagName==="SELECT"||t.isContentEditable))return;if(s.marquee.active){s.marquee.active=!1,N();return}if(!s.drag)return;if(s.drag.kind==="move"&&s.moveGroup){const l=document.elementFromPoint(window.lastPointerX??0,window.lastPointerY??0)?.closest?.(".track-card");if(l){const f=parseInt(l.dataset.trackId||"-1",10),m=s.moveGroup.trackId;if(!Number.isNaN(f)&&f>0&&f!==m){const p=d.tracks.find(y=>y.id===m),h=d.tracks.find(y=>y.id===f),g=new Set(s.moveGroup.ids),k=p.notes.filter(y=>g.has(y.id));if(k.length>0){const y=Math.min(...k.map(L=>L.startTick)),M=Math.max(...k.map(L=>L.startTick+L.durationTick)),E=h.notes.filter(L=>L.startTick<M&&L.startTick+L.durationTick>y);p.notes=p.notes.filter(L=>!g.has(L.id)).concat(E),h.notes=h.notes.filter(L=>!E.includes(L)).concat(k),Le(p.notes),Le(h.notes),s.selected.clear();for(const L of k)s.selected.add(L.id);s.moveGroup=null,s.drag=null,s.ghost=null,tt({track:p}),tt({track:h}),_(),q();return}}}const a=s.moveGroup;if(oe===0&&re===0){s.moveGroup=null,s.drag=null,s.ghost=null;return}const u=d.tracks.find(f=>f.id===a.trackId);u.notes=u.notes.filter(f=>!a.ids.includes(f.id)),s.selected.clear();for(const f of a.base){const m=Math.max(0,f.startTick+oe),p=ie(f.pitch+re),h=new Et(f.id,p,m,f.durationTick,f.volume??A);Re(d,a.trackId,{id:h.id,startTick:h.startTick,durationTick:h.durationTick,pitch:h.pitch,volume:h.volume}),pe(d,h.startTick+h.durationTick),s.selected.add(h.id)}s.moveGroup=null,s.drag=null,s.ghost=null,oe=0,re=0,tt({track:u}),_(),at();return}if(!s.ghost){s.drag=null,document.querySelectorAll(".track-card.drop-hover").forEach(l=>l.classList.remove("drop-hover"));return}const e=s.ghost,o=s.drag.trackId,r=d.tracks.find(l=>l.id===o);let c=A;if(r){const l=ce(r);let a=A;for(let u=0;u<l.length;u++){const f=l[u];if(f.startTick>=e.startTick)break;const m=f.volume??A;Nn(l,u,s.volumeLabels),a=m}c=a}const n=new Et(s.drag.noteId,e.pitch,e.startTick,e.durationTick,c),i=d.tracks.find(l=>l.id===o);if(s.drag.kind==="resize-left"||s.drag.kind==="resize-right"){const l=i.notes.findIndex(p=>p.id===s.drag.noteId);l>=0&&i.notes.splice(l,1);const a=s.drag.endTick0-s.drag.startTick0,u=e.durationTick,f=Math.max(0,a-u);if(f>0){const p=rt(32),h=new Set(s.selected);for(const g of i.notes)g.id!==s.drag.noteId&&h.has(g.id)&&(g.durationTick=Math.max(p,g.durationTick-f))}const m=Math.max(0,u-a);if(m>0){const p=new Set(s.selected);for(const h of i.notes){if(h.id===s.drag.noteId||!p.has(h.id))continue;const g=i.notes.filter(M=>M.startTick>h.startTick).sort((M,E)=>M.startTick-E.startTick)[0];let k=Number.POSITIVE_INFINITY;g&&(k=Math.max(0,g.startTick-(h.startTick+h.durationTick)));const y=Math.max(0,Math.min(m,k));y>0&&(h.durationTick+=y,pe(d,h.startTick+h.durationTick))}}}Re(d,o,{id:n.id,startTick:n.startTick,durationTick:n.durationTick,pitch:n.pitch,volume:n.volume}),pe(d,n.startTick+n.durationTick),s.drag=null,s.ghost=null,s.ghostGroup=null,document.querySelectorAll(".track-card.drop-hover").forEach(l=>l.classList.remove("drop-hover")),tt({track:i,recomputeLabels:!0}),_(),at()}function N(){gr(),s.isAltDown=Qe;const t=B[d.zoomLevel-1],e=W/x*t,o=s.scrollX,r=D.clientWidth,c=o+r;D.clientHeight;const n=d.timeSig.beatsPerBar*t,i=(F||d.timeSig.beatsPerBar)*t,l=Math.floor(o/n),a=o-l*n,u=Math.floor(o/i),f=o-u*i;z.style.left=`${-a}px`,V&&(V.style.left=`${-f}px`),V&&Te&&Sn(Te,V,d,s,F),xo(nt,d,s,l*n,r+n);const m=e-o;if(H)if(vt==="area"){const g=B[d.zoomLevel-1],k=F||d.timeSig.beatsPerBar,y=g*k,E=Math.floor(e/y)*y-o;zo(nt,z,E,y)}else mn(nt,z,m);else mn(nt,z,m);_o(An,J,s.keyHeight);const h=-D.scrollTop+s.keyHeight;if(J.style.transform=`translateY(${h}px)`,kr(),H&&e>=c){const g=B[d.zoomLevel-1],k=d.timeSig.beatsPerBar*g,y=W/x*g,M=Math.floor(y/k)*k,E=Bt(),L=Math.max(0,E-D.clientWidth);s.scrollX=Math.max(0,Math.min(L,M))}le(),Vn()}function gr(){const t=window.devicePixelRatio||1,e=B[d.zoomLevel-1],r=d.timeSig.beatsPerBar*e,c=(D.clientWidth||800)+r,n=84*s.keyHeight,i=n;z.style.width!==`${c}px`&&(z.style.width=`${c}px`),z.style.height!==`${i}px`&&(z.style.height=`${i}px`);const l=Math.max(1,Math.floor(c*t)),a=Math.max(1,Math.floor(i*t));if((z.width!==l||z.height!==a)&&(z.width=l,z.height=a),V&&Te){const k=(D.clientWidth||800)+r,y=n;V.style.width!==`${k}px`&&(V.style.width=`${k}px`),V.style.height!==`${y}px`&&(V.style.height=`${y}px`);const M=Math.max(1,Math.floor(k*t)),E=Math.max(1,Math.floor(y*t)),L=V.width!==M,S=V.height!==E;(L||S)&&(V.width=M,V.height=E),(L||S||wt!==d.zoomLevel)&&(Sn(Te,V,d,s,F),wt=d.zoomLevel)}const u=84*s.keyHeight;(J.width!==Math.floor(48*t)||J.height!==Math.floor(u*t))&&(J.width=Math.floor(48*t),J.height=Math.floor(u*t),t!==1&&An.setTransform(t,0,0,t,0,0)),J.style.width!=="48px"&&(J.style.width="48px");const f=`${u}px`;J.style.height!==f&&(J.style.height=f);const m=s.keyHeight;Ht.style.height!==m+"px"&&(Ht.style.height=m+"px");const p=Ht.clientWidth||D.clientWidth||800,h=Math.max(1,Math.floor(p*t)),g=Math.max(1,Math.floor(m*t));(P.width!==h||P.height!==g)&&(P.width=h,P.height=g,t!==1&&Me.setTransform(t,0,0,t,0,0))}function Ge(){H=!1,we().stop(),Tn(),le(),Vn(),U()}function Fn(){H=!1,we().stop(),we().position=0,Tn(),W=Fo,le(),N(),U()}function kr(){const t=B[d.zoomLevel-1],e=F||d.timeSig.beatsPerBar,o=window.devicePixelRatio||1,r=s.keyHeight;Ht.style.height!==r+"px"&&(Ht.style.height=r+"px");const c=Ht.clientWidth||D.clientWidth||800,n=Math.max(1,Math.floor(c*o)),i=Math.max(1,Math.floor(r*o));P.width!==n&&(P.width=n),P.height!==i&&(P.height=i),o!==1&&Me.setTransform(o,0,0,o,0,0);const l=s.scrollX;No(Me,P,l,t,e,d,Ze)}let kt=null,Pt=!1,Xt=-1;function yr(){if(kt)return kt;const t=document.createElement("div");return t.style.position="fixed",t.style.zIndex="10000",t.style.background="#222",t.style.color="#fff",t.style.border="1px solid #444",t.style.fontSize="12px",t.style.padding="4px 0",t.style.display="none",t.style.minWidth="120px",t.style.boxShadow="0 2px 6px rgba(0,0,0,0.4)",t.id="tempo-anchor-menu",document.body.appendChild(t),kt=t,document.addEventListener("pointerdown",e=>{kt&&kt.style.display!=="none"&&(kt.contains(e.target)||U())}),t}function U(){kt&&(kt.style.display="none")}function vr(t,e,o,r){const c=yr();c.innerHTML="";const n=(i,l)=>{const a=document.createElement("div");a.textContent=i,a.style.padding="4px 10px",a.style.cursor="pointer",a.onpointerdown=u=>{u.preventDefault(),u.stopPropagation()},a.onclick=()=>{l()},a.onmouseenter=()=>a.style.background="#333",a.onmouseleave=()=>a.style.background="transparent",c.appendChild(a)};r?(n("템포 수정",()=>{const i=d.tempoAnchors||[],l=i.findIndex(a=>a.tick===o);if(l>=0){const a=i[l];He(async()=>{const{showTempoModal:u}=await import("./tempoModal-CDg7-l-h.js");return{showTempoModal:u}},__vite__mapDeps([0,1]),import.meta.url).then(({showTempoModal:u})=>{u(d,f=>{!Number.isFinite(f)||f<=0||f>999||(i[l]={tick:a.tick,bpm:Math.round(f)},d.tempoAnchors=i,mt({pushHistory:!0}))})})}U()}),n("템포 삭제",()=>{let i=d.tempoAnchors||[];i=i.filter(l=>l.tick!==o),d.tempoAnchors=i,mt({pushHistory:!0}),it("context-menu-delete-single"),U()}),n("모든 템포 삭제",()=>{d.tempoAnchors=[],mt({pushHistory:!0}),it("context-menu-delete-all"),U()})):(n("템포 앵커 추가",()=>{He(async()=>{const{showTempoModal:l}=await import("./tempoModal-CDg7-l-h.js");return{showTempoModal:l}},__vite__mapDeps([0,1]),import.meta.url).then(({showTempoModal:l})=>{l(d,a=>{if(!Number.isFinite(a)||a<=0||a>999)return;const u=d.tempoAnchors||[];u.push({tick:o,bpm:Math.round(a)}),d.tempoAnchors=u,mt({pushHistory:!0})})}),U()}),(d.tempoAnchors||[]).length>0&&n("모든 템포 삭제",()=>{d.tempoAnchors=[],mt({pushHistory:!0}),it("context-menu-delete-all"),U()})),c.style.left=t+"px",c.style.top=e+"px",c.style.display="block"}P?.addEventListener("contextmenu",t=>{if(t.preventDefault(),!P)return;const e=P.getBoundingClientRect(),o=t.clientX-e.left,r=B[d.zoomLevel-1],c=(o+s.scrollX)/r*x,n=rt(s.selectedLength),i=Math.max(0,Math.floor(c/n)*n),a=(d.tempoAnchors||[]).some(u=>u.tick===i);vr(t.clientX,t.clientY,i,a)});P?.addEventListener("pointerdown",t=>{if(t.button!==0)return;const e=P.getBoundingClientRect(),o=t.clientX-e.left,r=B[d.zoomLevel-1],c=(o+s.scrollX)/r*x,n=rt(s.selectedLength),i=Math.max(0,Math.floor(c/n)*n),a=(d.tempoAnchors||[]).findIndex(u=>u.tick===i);if(a>=0){Xt=a,Pt=!0;try{t.target.setPointerCapture(t.pointerId)}catch{}}});window.addEventListener("pointermove",t=>{if(!Pt||Xt<0||!P)return;const e=P.getBoundingClientRect(),o=t.clientX-e.left,r=B[d.zoomLevel-1],c=(o+s.scrollX)/r*x,n=rt(s.selectedLength),i=Math.max(0,Math.floor(c/n)*n),l=d.tempoAnchors||[];l[Xt]&&(l[Xt].tick=i,mt({pushHistory:!1,skipNormalize:!0}))});window.addEventListener("pointerup",()=>{Pt&&(Pt=!1,Xt=-1,mt({pushHistory:!0}),it("pointerup-drag-end"))});window.addEventListener("pointercancel",()=>{Pt&&(Pt=!1,Xt=-1,mt({pushHistory:!0}),it("pointercancel-drag-end"))});function R(){wt=-1,N()}function Kn(){if(!H)return;const t=performance.now(),e=Math.max(0,t-Ue);Ue=t;const o=je(d.tempoAnchors||[],120);W=so(o,W,e);const r=Wt();if(W>=r){Fn();return}N(),requestAnimationFrame(Kn)}function Wt(){let t=0;for(const e of d.tracks)for(const o of e.notes){const r=o.startTick+o.durationTick;r>t&&(t=r)}return t}function le(){if(!pn)return;const t=Wt(),e=Math.max(0,Math.floor(W));let o=d.tempoAnchors||[],r;if(Pt)r=At(o);else{const u=o.length,f=At(o);if(r=f,f.length<u){const m=o.map(g=>({tick:g.tick,bpm:g.bpm})),p=new Set(f.map(g=>g.tick+":"+g.bpm)),h=m.filter(g=>!p.has(g.tick+":"+g.bpm));console.warn("[tempoAnchors normalize non-destructive] invalid entries detected (will NOT remove automatically)",{before:u,afterVirtual:f.length,removed:h})}}const c=je(r,120),n=De(c,e),i=De(c,t),l=Number.isFinite(n)?n:0,a=Number.isFinite(i)?i:0;pn.textContent=`${ln(l)} / ${ln(a)}`,it("updateProgress")}function mt(t={}){try{if(!t.skipNormalize){const e=At(d.tempoAnchors||[]);d.tempoAnchors=e}it("onTempoAnchorsChanged"),t.pushHistory?_():at();for(const e of d.tracks)It(e);q(),pt(),xt()}catch{}}function br(t){U(),t.button!==2&&(H||(St=!0,de(t)))}function wr(t){St&&de(t)}function xr(){St=!1}function de(t){const{x:e}=tr(t),o=B[d.zoomLevel-1],r=e/o*x,c=rt(s.selectedLength);W=Math.max(0,Math.floor(r/c)*c),H&&(H=!1),N()}function Vn(){const t=Bt(),e=t-D.clientWidth;if(e<=1){jt.style.display="none";return}jt.style.display="block";const o=Math.max(20,D.clientWidth/t*jt.clientWidth);ee.style.width=`${o}px`;const c=s.scrollX/e*(jt.clientWidth-o);ee.style.left=`${c}px`}function Bt(){const t=B[d.zoomLevel-1],e=Math.ceil(Wt()/x);return Math.max(D.clientWidth,Math.ceil(e*t)+D.clientWidth)}function Se(t){const e=B[d.zoomLevel-1],o=d.timeSig.beatsPerBar*e,r=Math.round(t/o)*o;return Math.max(0,r)}function Un(){const t=v[b];if(O&&(O.textContent=Z?t.extendedLessLabel||"더 적은 단위":t.extendedMoreLabel||"더 많은 단위",O.title=Z?t.tooltipExtendedLess||"기본 단위로 돌아가기":t.tooltipExtendedMore||"더 많은 단위 사용 (64/128/5/7/11)",O.setAttribute("data-i18n",Z?"extendedLessLabel":"extendedMoreLabel"),O.setAttribute("data-i18n-title",Z?"tooltipExtendedLess":"tooltipExtendedMore"),O.setAttribute("aria-label",O.title)),X){const e=t.tooltipDisplayTimeSig||"Display time signature (n/4)";X.title=e,X.setAttribute("data-i18n-title","tooltipDisplayTimeSig"),X.setAttribute("aria-label",e)}}lt(O,"ghost","sm");if(X){const t=c=>Math.max(1,Math.min(16,Math.floor(c)));let e=null;try{const c=localStorage.getItem(hn);if(c!=null){const n=Number(c);Number.isFinite(n)&&(e=t(n))}}catch{}const o=e??t(Number(d.displayBeatsPerBar)||Number(d.timeSig?.beatsPerBar)||4);F=o,d.displayBeatsPerBar=o,X.value!==String(o)&&(X.value=String(o));const r=()=>{const c=Number(X.value),n=Number.isFinite(c)?t(c):o;F=n,d.displayBeatsPerBar=n,X.value!==String(n)&&(X.value=String(n));try{localStorage.setItem(hn,String(n))}catch{}wt=-1,_(),R()};X.addEventListener("change",r),X.addEventListener("input",r)}window.addEventListener("resize",()=>{nn(),wt=-1,R()});setTimeout(nn,0);Ae();En();qe&&$(qe,"tooltipPlay",v[b].tooltipPlay);Fe&&$(Fe,"tooltipPause",v[b].tooltipPause);ut&&(ut.textContent=vt==="area"?v[b].playheadAreaLabel:v[b].playheadLineLabel,$(ut,"tooltipPlayheadToggle",v[b].tooltipPlayheadToggle));Ke&&$(Ke,"tooltipStop",v[b].tooltipStop);zt&&(lt(zt,"secondary","md"),zt.setAttribute("data-i18n","edit"),$(zt,"tooltipEditMML",v[b].tooltipEditMML));ge&&(lt(ge,"secondary","md"),$(ge,"tooltipConvert",v[b].tooltipConvert));he&&(lt(he,"secondary","md"),$(he,"tooltipPaste",v[b].tooltipPaste));ne&&(lt(ne,"ghost","md"),$(ne,"tooltipGuide",v[b].tooltipGuide));if(ot){const t=(()=>{try{return localStorage.getItem(Pn)}catch{return null}})(),e=Math.max(16,Math.min(32,t?parseInt(t,10):s.keyHeight));s.keyHeight=e,ot.value=String(e),yt&&(yt.textContent=String(e)),ot.min="16",ot.max="32",ot.step="1",$(ot,"tooltipKeyHeight",v[b].tooltipKeyHeight||"노트 높이 (16-32)")}ke&&(lt(ke,"ghost","sm"),$(ke,"tooltipLangKo",v[b].tooltipLangKo));ye&&(lt(ye,"ghost","sm"),$(ye,"tooltipLangJa",v[b].tooltipLangJa));ve&&(lt(ve,"ghost","sm"),$(ve,"tooltipLangEn",v[b].tooltipLangEn));z&&(z.setAttribute("data-i18n-title","tooltipPianoRoll"),z.title=v[b].tooltipPianoRoll);P&&(P.setAttribute("data-i18n-title","tooltipRuler"),P.title=v[b].tooltipRuler);Qo();R();pt();try{ae.push(d)}catch{}zt?zt.onclick=()=>{const t=d.tracks.find(o=>o.id===s.activeTrackId);if(!t)return;let e=t.optimizedMML?.trim?.()||t.mmlString?.trim?.()||"";if(e=e.replace(/[\r\n]+/g,""),!e)try{e=(Ln(t.notes??[])||"").trim().replace(/[\r\n]+/g,"")}catch{}vo(t,o=>{on(t,o),d.maxEndTick=Wt(),It(t);for(const r of d.tracks)r!==t&&It(r);at(),pt(),q()},e)}:d=wn();Un();O.id="btnToggleExtended";O.style.marginLeft="8px";O.textContent=Z?v[b].extendedLessLabel||"더 적은 단위":v[b].extendedMoreLabel||"더 많은 단위";Je.onmessage=t=>{const{trackId:e,optimizedMML:o,originalBody:r,notesLen:c}=t.data,n=d.tracks.find(i=>i.id===e);if(n){const i=Array.isArray(n.notes)&&n.notes.length>0;o&&o.length>0?n.optimizedMML=o:(!i||c===0)&&(n.optimizedMML=""),n.originalBody=r??"",t.data.error&&window?.console&&console.warn("[mmlOptimizerWorker error]",t.data.error),q(),pt(),xt()}};Xo?.addEventListener("click",()=>{Rn(x)});Oo?.addEventListener("click",()=>{const t=x*Hn();Rn(t)});Wo?.addEventListener("click",()=>{Dn(x)});qo?.addEventListener("click",()=>{const t=x*Hn();Dn(t)});(function(){Tt&&(Tt.textContent=v[b].trackMMLLabel||"트랙MML",Tt.setAttribute("data-i18n","trackMMLLabel"),Tt.setAttribute("data-i18n-title","tooltipEditMML"),Tt.title=v[b].tooltipEditMML)})();s.moveGroup=null;(function(){const e="2025-09-13-tempo-rework",o="mml_editor_whatsnew_shown_"+e;let r=!1;try{r=localStorage.getItem(o)==="1"}catch{}r||setTimeout(()=>Ro(e),0)})();async function Tr(){try{const t=await navigator.clipboard.readText();if(!t.trim().startsWith("MML@")){alert(v[b].invalid_mml_format||"MML 형식이 아닙니다.");return}let e=t.trim().substring(4);e=e.replace(/\r?\n/g,"").replace(/;+$/g,"");const o=e.split(",").map(n=>n.replace(/;+$/g,"").trim());if(console.log("[paste start]",{rawLength:t.length,bodyLength:e.length,trackCount:o.length,trackLengths:o.map(n=>n.length)}),o.length>24){alert("트랙은 최대 24개까지만 지원합니다.");return}if(o.length>d.tracks.length){const n=Math.min(24,o.length)-d.tracks.length;if(n>0){for(let i=0;i<n;i++){const l=d.tracks.reduce((u,f)=>Math.max(u,f.id),0)+1||d.tracks.length+1,a=d.tracks.length;d.tracks.push({id:l,order:a,name:`Track ${a+1}`,color:bt[a%bt.length],instrument:Ot,mmlString:"",optimizedMML:"",mute:!1,solo:!1,notes:[]})}q()}}try{const n=x*4,i=[],l=/l(\d+)/gi;for(const a of o){let u;for(;(u=l.exec(a))!==null;){const f=parseInt(u[1],10);(!f||n%f!==0)&&i.push(u[0])}}if(i.length>0&&!confirm("표현 불가능한 길이가 포함되어 있습니다. 계속 진행하시겠습니까?"))return}catch(n){console.warn("[paste early l check error]",n)}const r=[];let c=[];if(o.length<d.tracks.length){const{showPasteSelectTracksModal:n}=await He(async()=>{const{showPasteSelectTracksModal:l}=await import("./pasteSelectTracksModal-DH9w1LR-.js");return{showPasteSelectTracksModal:l}},__vite__mapDeps([2,1]),import.meta.url),i=await n(o.length,d.tracks.slice());if(!i||i.length!==o.length){console.log("[paste cancelled - selection modal closed]");return}c=i.sort((l,a)=>l-a)}else c=Array.from({length:d.tracks.length},(n,i)=>i);for(let n=0;n<c.length;n++){const i=c[n],l=o[n]?o[n]:"",a=d.tracks[i],u=a.notes?.length||0;try{if(console.log("[paste track before]",{index:i,trackId:a.id,name:a.name,bodyLen:l.length,snippet:l.slice(0,60)}),l&&l.length>0)try{a.optimizedMML=fo(l)||l}catch{a.optimizedMML=l}else a.optimizedMML="";on(a,l);const f=a.notes?.length||0;console.log("[paste track after]",{trackId:a.id,parsedNotes:f,optimizedLen:a.optimizedMML?.length||0,rawLen:l.length}),f>u&&r.push(a)}catch(f){console.warn("[paste track error]",{index:i,trackId:a.id,err:f}),alert(v[b].invalid_mml_format||"MML 형식이 아닙니다.");return}}d.maxEndTick=Wt(),r.length>0&&en(r);try{d.tempoAnchors=At(d.tempoAnchors||[])}catch{}it("paste-normalize"),it("init-normalize"),W>=d.maxEndTick&&(W=0),q(),xt(),console.log("[paste done]",{changedTrackIds:r.map(n=>n.id)}),_();try{le()}catch{}}catch(t){console.warn("[paste fatal]",t)}}async function $n(){if(H)return;H=!0,await ro(),U();let t=0;for(const c of d.tracks)for(const n of c.notes)t=Math.max(t,n.startTick+n.durationTick);d.maxEndTick=t;let e=Jo();if(e.length===0){const c=i=>Ie.includes(i)?i:Ot,n=[];for(const i of d.tracks){const l=c(i.instrument||"lute");for(const a of i.notes)n.push({startTick:a.startTick,durationTick:a.durationTick,pitch:a.pitch,trackId:i.id,instrumentKey:l,volume:a.volume})}n.length>0&&(e=n)}if(e.length===0){H=!1;return}const o=At(d.tempoAnchors||[]);d.tempoAnchors=o,it("play-normalize"),W>=d.maxEndTick&&(W=0),await io(e,o,120,{});const r=je(o,120);we().position=De(r,W),Ue=performance.now();{const c=B[d.zoomLevel-1],n=d.timeSig.beatsPerBar*c,i=W/x*c,l=Math.floor(i/n)*n,a=Bt(),u=Math.max(0,a-D.clientWidth);s.scrollX=Math.max(0,Math.min(u,l))}le?.(),Kn()}const an=()=>{const t=window.visualViewport?window.visualViewport.height:window.innerHeight;document.documentElement.style.setProperty("--app-100dvh",t+"px")};an();window.addEventListener("resize",an);window.visualViewport?.addEventListener("resize",an);
