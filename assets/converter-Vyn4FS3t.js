import{D,F as C,G as K,J as L,q as R,T as X}from"./languages-B3gKcd-W.js";class k{static noteString="abcdefgABCDEFGnNrR";static tokenString=k.noteString+"tToOlLvV<>&,;";src;length;arr;start=0;end=0;constructor(t){this.src=t||"",this.length=this.src.length,this.arr=this.src.split("")}static isToken(t){return k.tokenString.indexOf(t)>=0}static isNote(t){return k.noteString.indexOf(t)>=0}static noteName(t){let e=t.substring(0,1);if(e.toLowerCase()==="n"){let s=1;for(;s<t.length;){const i=t.charCodeAt(s);if(i<48||i>57)break;s++}e=t.substring(0,s)}else if(t.length>1){const s=t.charAt(1);(s==="+"||s==="-"||s==="#")&&(e+=s)}return e}static noteNames(t){const e=k.noteName(t),n=t.substring(e.length);return[e,n]}[Symbol.iterator](){return{next:()=>this.end>=this.length?{done:!0,value:void 0}:(this.start=this.end,this.end=this.searchToken(this.end+1),{done:!1,value:this.src.substring(this.start,this.end)})}}getIndex(){return[this.start,this.end]}searchToken(t){let e=t;for(;e<this.length;e++){const n=this.arr[e];if(k.isToken(n))break}return e}}class q{section="4";octave=L;octD=0;tokenStack=0;map;atSegmentStart=!0;seenAnyL=!1;constructor(){this.map=this.createOptimizerMap(),this.map.clear(),this.map.set("4",new S)}createOptimizerMap(){const t=new Map;return t.updateMapMinLength=(e,n)=>{const s=t.get(e);(!s||n.length()<s.length())&&t.set(e,n)},t}getMinString(){let t,e=Number.MAX_SAFE_INTEGER,n=Number.MAX_SAFE_INTEGER;for(const s of this.map.values()){const i=s.length();if(i>e)continue;const o=(s.toString().match(/n\d+/g)||[]).length;(i<e||i===e&&o<n)&&(t=s,e=i,n=o)}return t?t.toString():""}addString(t){for(const e of this.map.values())e.append(t)}addStringAtBack(t,e){for(const n of this.map.values())n.insert(n.length()-e,t)}newBuilder(t,e,n,s){return t.insert(t.length()-s,"l"+e),t.append(n),t}extendPatternBuilder(t,e,n,s,i){}updateBuilder(t,e,n,s,i,r,o){let a=i;if(e.append(s),this.atSegmentStart&&!this.seenAnyL&&a.length>0&&a===t)e.append(a);else if(t!==a){a===t+"."?e.append("."):e.append(a);const l=new S(n);if(this.newBuilder(l,a,s,r),o.set(a,l),a.endsWith(".")){const d=a.slice(0,-1),c=new S(n);this.newBuilder(c,d,s+".",r),o.set(d,c)}this.extendPatternBuilder(o,n,s,a,r)}}addNoteText(t,e,n){const s=new Map,i=this.getMinString();this.map.forEach((r,o)=>this.updateBuilder(o,r,i,t,e,n,s)),s.forEach?.((r,o)=>this.map.updateMapMinLength(o,r)),I.updateFlexDot(this.map,t,e),this.atSegmentStart=!1}fixPattern(t){}resetOctave(){this.octave=L,this.octD=0}doPattern(t,e,n){this.insertOxPattern(n),this.insertLxPattern(t,e,n)}insertLxPattern(t,e,n){let s=e;s===""?s=this.section:s==="."&&(s=this.section+"."),this.addNoteText(t,s,n),this.fixPattern(this.map)}insertOxPattern(t){if(this.octD!==0){const e=this.octave+this.octD;this.addStringAtBack(P(this.octave,e),t),this.octave=e,this.octD=0}}doToken(t,e){if(t==="o")this.octD=parseInt(e||"0",10)-this.octave;else if(t===">")this.octD++;else if(t==="<")this.octD--;else if(t==="l")this.section=e||this.section,this.seenAnyL=!0;else return!1;return!0}nextToken(t){const e=t.charAt(0).toLowerCase(),[n,s]=k.noteNames(t);k.isNote(e)?(this.doPattern(n,s,this.tokenStack),this.tokenStack=0,this.cleanMap()):(this.doToken(e,s)||this.addString(t),e==="&"&&(this.tokenStack+=t.length))}printMap(){}cleanMap(){const t=this.getMinString().length,e=[];this.map.forEach((n,s)=>{n.length()>t+s.length+1&&e.push(s)}),e.forEach(n=>this.map.delete(n))}}class I{static flexList=[64,32,16,8,4].map(t=>new I(t));lCur;lNext;lPrev;constructor(t){this.lCur=t/2+".",this.lNext=""+t,this.lPrev=""+t/4}updatePattern(t,e){let n=e;/^r$/i.test(e)||(n="&"+e);const s=new Map,i=e+this.lPrev+n+this.lCur;for(const r of t.keys())if(r===this.lNext){const o=t.get(r).toString();if(o.endsWith(i)){const a=o.substring(0,o.length-i.length),f=this.lPrev+".",l=a+e+n+f,d=a+e+"l"+f+n,c=a+e+"l"+this.lPrev+n+".";s.set(r,new S(l)),s.set(f,new S(d)),s.set(this.lPrev,new S(c))}}s.forEach((r,o)=>t.updateMapMinLength(o,r))}static updateFlexDot(t,e,n){for(const s of I.flexList)if(n===s.lCur){s.updatePattern(t,e);break}}}class $ extends q{disableNopt;constructor(t){super(),this.disableNopt=t}static pattern=[{lStr:"32",match:"r16.",replace:"rrr"},{lStr:"64",match:"r32.",replace:"rrr"}];fixPattern(t){t.forEach((e,n)=>{for(const s of $.pattern)if(n===s.lStr||s.lStr==="*"){const i=e.toString();if(i.endsWith(s.match)){const r=i.length-s.match.length;e.replace(r,i.length,s.replace)}}})}extendPatternBuilder(t,e,n,s,i){const r=e.lastIndexOf("l");let o="4";if(r>=0&&(o=(new k(e.substring(r))[Symbol.iterator]().next().value||"").substring(1)||"4"),i>0&&!o.endsWith(".")&&e.endsWith(n+"&")&&s===String(parseInt(o,10)<<1)+"."){const f=String(parseInt(o,10)<<2),l=new S(e);l.insert(e.length-1,".");const d=new S(l.toString());this.newBuilder(d,f,n,i),t.set(f,d)}}createOptimizerMap(){const t=super.createOptimizerMap(),e=new Map,n=(s,i)=>{const r=t.get(s);if(!r){t.set(s,i);return}const o=Q(i,r),a=H(i.toString().substring(0,o)),f=i.toString().substring(0,o),l=z(f,i.toString().substring(o),a,this.disableNopt,e),d=z(f,r.toString().substring(o),a,this.disableNopt,e);l<d&&t.set(s,i)};return t.updateMapMinLength=n,t}}class j{octave=L;parser=new J("");builderList=[];constructor(){this.builderList.push(new A(this.octave))}getCurrentNoteNumber(){return this.parser.getNoteNumber()}notePattern(t,e,n){const s=this.listClone();this.addNoteToken(t),this.cleanList(),n.length===0&&this.addPattern(s)}addPattern(t){const e=this.getCurrentNoteNumber();e<0||e>96||(t.forEach(n=>{n.builder.append("n").append(String(e)),n.nCount++}),this.builderList.push(this.minStack(t)),this.clearOctToken())}addOctToken(t){this.builderList.forEach(e=>e.addOctToken(e.builder.length(),t))}clearOctToken(){this.builderList.forEach(t=>t.offset=void 0)}listClone(){return this.builderList.map(t=>t.clone())}cleanList(){const t=this.minStack(this.builderList);this.builderList=[t]}minStack(t){return t.slice().sort(A.comparator)[0]}doToken(t){const[e,n]=k.noteNames(t),s=e.charAt(0).toLowerCase();s>="a"&&s<="g"?this.notePattern(t,e,n):s===">"?(this.octave++,this.addOctToken(t)):s==="<"?(this.octave--,this.addOctToken(t)):s==="o"?(this.octave=parseInt(n||"0",10),this.addOctToken(t)):this.addToken(t)}addNoteToken(t){this.builderList.forEach(e=>{e.builder.append(P(e.prevOct,this.octave)),e.builder.append(t),e.prevOct=this.octave}),this.clearOctToken()}addToken(t){this.builderList.forEach(e=>e.builder.append(t))}nextToken(t){try{this.parser.noteGT(t)}catch{}this.doToken(t)}getMinString(){return this.minStack(this.builderList).builder.toString()}}class U extends j{map=new Map;disableNopt;constructor(t,e,n){super(),typeof t=="boolean"?this.disableNopt=t:(this.octave=t,this.disableNopt=!!n,this.builderList=[],this.builderList.push(new A(this.octave,e||"")),this.parser.setOctave(this.octave))}addTokenVariant(t,e,n){const s=new S(t.builder.toString());t.prevOct!==e&&s.append(P(t.prevOct,e)),s.append(n);const i=this.map.get(e);(i==null||i.length>s.length())&&this.map.set(e,s.toString())}notePattern(t,e,n){this.builderList.forEach(s=>{if(this.addTokenVariant(s,this.octave,t),e==="b"?this.addTokenVariant(s,this.octave+1,"c-"+n):e==="c"&&this.addTokenVariant(s,this.octave-1,"b+"+n),!this.disableNopt&&s.prevOct!==this.octave&&n.length===0){const i=this.getCurrentNoteNumber();i>=0&&i<=96&&this.addTokenVariant(s,s.prevOct,"n"+i)}}),this.builderList=[],this.map.forEach((s,i)=>this.builderList.push(new A(i,s))),this.map.clear()}}class S{_s;constructor(t=""){this._s=[t]}append(t){return this._s.push(t),this}insert(t,e){const n=this.toString(),s=Math.max(0,Math.min(t,n.length)),i=n.slice(0,s)+e+n.slice(s);return this._s=[i],this}replace(t,e,n){const s=this.toString(),i=s.slice(0,t)+n+s.slice(e);return this._s=[i],this}toString(){return this._s.join("")}length(){return this.toString().length}}class A{static comparator=(t,e)=>t.builder.length()-e.builder.length()||t.nCount-e.nCount;builder=new S;nCount=0;prevOct;offset;constructor(t,e){this.prevOct=t,e&&(this.builder=new S(e),this.nCount=(e.match(/n\d+/g)||[]).length)}addOctToken(t,e){this.offset===void 0&&(this.offset=t)}clone(){const t=new A(this.prevOct);return t.builder=new S(this.builder.toString()),t.offset=this.offset,t.nCount=this.nCount,t}}class J{mml_L=C;mml_oct=L;noteNumber=Number.MIN_SAFE_INTEGER;constructor(t){}setOctave(t){this.mml_oct=t}getNoteNumber(){return this.noteNumber}noteGT(t){if(!t)return 0;const e=t.charAt(0);if(!k.isNote(e)){const r=e.toLowerCase();return r==="l"?this.mml_L=t.substring(1)||this.mml_L:r==="o"?this.mml_oct=Math.max(1,Math.min(7,parseInt(t.substring(1)||String(this.mml_oct),10))):r==="<"?this.mml_oct=Math.max(1,this.mml_oct-1):r===">"&&(this.mml_oct=Math.min(7,this.mml_oct+1)),0}if(e==="n"||e==="N"){let r=1;for(;r<t.length;){const a=t.charCodeAt(r);if(a<48||a>57)break;r++}const o=parseInt(t.substring(1,r),10);if(!Number.isFinite(o))throw new Error("Illegal n token");return this.noteNumber=o,0}let n=t.charAt(0).toLowerCase(),s=0;switch(n){case"c":s=0;break;case"d":s=2;break;case"e":s=4;break;case"f":s=5;break;case"g":s=7;break;case"a":s=9;break;case"b":s=11;break;case"r":return this.noteNumber=Number.MIN_SAFE_INTEGER,0;default:return this.noteNumber=Number.MIN_SAFE_INTEGER,0}const i=t.charAt(1);return i==="+"?s++:i==="-"&&s--,this.noteNumber=this.mml_oct*12+s,0}}class G{originalMML;disableNopt=!1;constructor(t){this.originalMML=t}setDisableNopt(t){return this.disableNopt=t,this}optimizeGen2(){const t=[new $(this.disableNopt),new U(this.disableNopt)];let e=this.originalMML;for(const n of t){for(const s of new k(e))n.nextToken(s);e=n.getMinString()}return e}}function P(m,t){const e=m-t;if(Math.abs(e)>2)return"o"+t;{let n="<<";return e<0&&(n=">>"),n.substring(0,Math.abs(e))}}function Q(m,t){const e=m.toString(),n=t.toString();let s=0;const i=Math.min(e.length,n.length);for(;s<i&&e.charCodeAt(s)===n.charCodeAt(s);)s++;for(s=s-1,s<0&&(s=0);s>0;){const r=e.charAt(s);if(k.isToken(r)||k.isNote(r))break;s--}return s}function H(m){const t=m.split("");let e=L;for(let n=0;n<t.length;n++)switch(t[n]){case"<":e=Math.max(1,e-1);break;case">":e=Math.min(7,e+1);break;case"o":case"O":n++,n<t.length&&(e=Math.max(1,Math.min(7,t[n].charCodeAt(0)-48)));break}return e}function z(m,t,e,n,s){const i=`${m.length}:${t}:${e}:${n?"1":"0"}`,r=s.get(i);if(r!=null)return r;const o=new U(e,m,n);for(const f of new k(t))o.nextToken(f);const a=o.getMinString().length;return s.set(i,a),a}function Y(){return 4*X}function O(m){const t=m.endsWith("."),e=t?m.slice(0,-1):m,n=parseInt(e,10);if(!n||n<=0)return 0;let s=Math.floor(Y()/n);return t&&(s+=Math.floor(s/2)),s}function y(m){const n=R?[1,2,4,5,6,7,8,11,12,16,24,32,48,64,128]:[1,2,4,6,8,12,16,24,32,48],s=new Set([5,7,11]),i=new Map;for(const f of n){const l=String(f),d=O(l),c={token:l,t:d,cost:l.length,dotted:!1},u=i.get(d);if((!u||u.cost>c.cost||u.cost===c.cost&&u.dotted)&&i.set(d,c),!s.has(f)){const p=l+".",b=O(p),M={token:p,t:b,cost:p.length,dotted:!0},T=i.get(b);(!T||T.cost>M.cost)&&i.set(b,M)}}const r=Array.from(i.values()).sort((f,l)=>l.t-f.t||f.cost-l.cost||(f.dotted?1:0)-(l.dotted?1:0)),o=[];let a=Math.max(0,m|0);for(;a>0;){let f;for(const l of r)if(l.t<=a){f=l;break}if(f||(f=r[r.length-1]),o.push(f.token),a-=f.t,o.length>2048)break}return o}function V(m){const t=Math.max(12,Math.min(95,m|0)),e=t%12,n=K[e],s=n.base,i=n.acc===0?"":n.acc>0?"+":"-",r=Math.max(1,Math.min(7,Math.floor(t/12)));return{base:s,acc:i,octave:r}}function Z(m){const t=[...m||[]].sort((r,o)=>r.startTick-o.startTick||r.pitch-o.pitch);if(t.length===0)return"";let e=0,n=L,s=D,i="o"+n+"l"+C;for(const r of t){const o=Math.max(0,r.startTick-e);o>0&&(y(o).forEach(p=>i+="r"+p),e+=o);const{base:a,acc:f,octave:l}=V(r.pitch);n!==l&&(i+=P(n,l),n=l);const d=r.volume??D;d!==s&&(i+="v"+String(d),s=d),y(Math.max(1,r.durationTick|0)).forEach((u,p)=>{i+=(p>0?"&":"")+a+f+u}),e+=Math.max(1,r.durationTick|0)}return i}function et(m){const t=Z(m);return new G(t).setDisableNopt(!1).optimizeGen2()}function st(m,t=!0,e=!1){try{const n=m||"",s=(()=>{try{const c=F(n.startsWith("MML@")?n:"MML@"+n+";");let u=0;const p={};for(const b of c){u=Math.max(u,b.startTick+b.durationTick);const M=b.pitch+":"+b.durationTick;p[M]=(p[M]||0)+1}return{totalTick:u,count:c.length,byKey:p}}catch{return null}})();if(!e||!/[tT]\d/.test(n)){const c=new G(n).setDisableNopt(!t).optimizeGen2();if(s){const u=F(c.startsWith("MML@")?c:"MML@"+c+";");let p=0;const b={};for(const g of u){p=Math.max(p,g.startTick+g.durationTick);const N=g.pitch+":"+g.durationTick;b[N]=(b[N]||0)+1}const M=p===s.totalTick,T=u.length===s.count;let h=M&&T;if(h){for(const g in s.byKey)if(s.byKey[g]!==b[g]){h=!1;break}for(const g in b)if(s.byKey[g]!==b[g]){h=!1;break}}if(!h)return window.MML_OPT_GUARD_DEBUG&&console.warn("[MML optimize guard] mismatch detected, reverting"),n}return c}const i=[];let r=0,o="";for(const c of new k(n)){const[u]=k.noteNames(c),p=u.charAt(0).toLowerCase();if(p==="t"&&/^t\d+$/i.test(c)){i.push({index:r,token:c});continue}o+=c,(p==="r"||p>="a"&&p<="g"||p==="n")&&r++}const a=new G(o).setDisableNopt(!t).optimizeGen2();if(i.length===0)return a;let f="";r=0;let l=0;const d=c=>{for(;l<i.length&&i[l].index===c;)f+=i[l].token,l++};d(0);for(const c of new k(a)){const[u]=k.noteNames(c),p=u.charAt(0).toLowerCase();p==="r"||p>="a"&&p<="g"||p==="n"?(f+=c,r++,d(r)):f+=c}if(d(r),s){const c=F(f.startsWith("MML@")?f:"MML@"+f+";");let u=0;const p={};for(const h of c){u=Math.max(u,h.startTick+h.durationTick);const g=h.pitch+":"+h.durationTick;p[g]=(p[g]||0)+1}const b=u===s.totalTick,M=c.length===s.count;let T=b&&M;if(T){for(const h in s.byKey)if(s.byKey[h]!==p[h]){T=!1;break}for(const h in p)if(s.byKey[h]!==p[h]){T=!1;break}}if(!T)return window.MML_OPT_GUARD_DEBUG&&console.warn("[MML optimize guard] mismatch(midtempo) detected, reverting"),n}return f}catch{return m}}function F(m){if(!m)return[];let t=m.trim();t.startsWith("MML@")&&(t=t.substring(4),t=t.replace(/\r?\n/g,""),t=t.replace(/;+$/g,""),t=t.split(",").map(l=>l.trim())[0]||""),t=t.replace(/;+$/g,"");const e=[];let n=0,s=L,i=C,r=D,o=!1,a=null;for(const f of new k(t)){const[l,d]=k.noteNames(f),c=l.charAt(0).toLowerCase();if(c==="l")i=d||i;else if(c==="o")s=Math.max(1,Math.min(7,parseInt(d||String(s),10)));else if(c==="<")s=Math.max(1,s-1);else if(c===">")s=Math.min(7,s+1);else if(c==="v"){const u=parseInt(d||String(r),10);Number.isFinite(u)&&(r=u)}else if(c==="&")o=!0;else if(c==="r"){const u=!d||d==="."?i+(d||""):d;n+=O(u),o=!1,a=null}else if(c>="a"&&c<="g"||c==="n"){let u;if(c==="n"){const M=parseInt(l.substring(1),10);u=Math.max(12,Math.min(95,M))}else{let M=0;switch(c){case"c":M=0;break;case"d":M=2;break;case"e":M=4;break;case"f":M=5;break;case"g":M=7;break;case"a":M=9;break;case"b":M=11;break}const T=f.charAt(1);T==="+"||T==="#"?M++:T==="-"&&M--,u=Math.max(12,Math.min(95,s*12+M))}let p=d;(!p||p===".")&&(p=i+(p||""));const b=Math.max(1,O(p));if(o&&a&&a.pitch===u&&a.startTick+a.durationTick===n)a.durationTick+=b;else{const M={id:`${n}-${u}-${Math.random().toString(36).slice(2,8)}`,startTick:n,durationTick:b,pitch:u,volume:r};e.push(M),a=M}n+=b,o=!1}}return e}function nt(m,t){const e=new Map,n=i=>Math.max(20,Math.min(999,Math.round(i||t||120)));for(const i of m||[]){const r=(i||"").replace(/;+$/g,"");let o=0,a=C;for(const f of new k(r)){const[l,d]=k.noteNames(f),c=l.charAt(0).toLowerCase();if(c==="l")a=d||a;else if(c==="r"){const u=!d||d==="."?a+(d||""):d;o+=O(u)}else if(c==="t"){const u=n(parseInt(d||String(t||120),10));e.has(o)||e.set(o,u)}else if(c>="a"&&c<="g"||c==="n"){let u=d;(!u||u===".")&&(u=a+(u||""));const p=Math.max(1,O(u));o+=p}}}const s=Array.from(e.entries()).map(([i,r])=>({tick:i,bpm:r}));return s.sort((i,r)=>i.tick-r.tick),s}function it(m,t,e){if(!m||m.length===0)return"";const n=Array.isArray(t)?t.slice().sort((h,g)=>h.tick-g.tick):[],s=[...m||[]].sort((h,g)=>h.startTick-g.startTick||h.pitch-g.pitch),i=new Set(n.map(h=>Math.max(0,h.tick|0))),r=[];for(const h of s){let g={...h};const N=h.startTick+h.durationTick,v=[...i].filter(x=>x>h.startTick&&x<N).sort((x,_)=>x-_);let w=h.startTick,E=!0;for(const x of v){const _=x-w;r.push({...g,startTick:w,durationTick:_,__tiedFromPrev:E?void 0:!0}),w=x,E=!1}r.push({...g,startTick:w,durationTick:N-w,__tiedFromPrev:E?void 0:!0})}const o=new Map;for(const h of n)o.set(Math.max(0,h.tick|0),Math.max(20,Math.min(999,Math.round(h.bpm))));const a=Array.from(o.keys()).sort((h,g)=>h-g),f=r.sort((h,g)=>h.startTick-g.startTick||h.pitch-g.pitch);let l=0,d=L,c=D,u=Math.max(20,Math.min(999,Math.round(e||120)));const p=o.has(0)?o.get(0):120;let b=`o${d}l${C}t${p}`;u=p;let M=0;const T=h=>{for(;M<a.length&&a[M]<=h;){const g=a[M];if(g<l){M++;continue}if(g>l){const v=g-l;y(v).forEach(E=>b+="r"+E),l=g}const N=o.get(g);N!==u&&(b+=`t${N}`,u=N),M++}};for(const h of f){T(h.startTick),h.startTick>l&&(y(h.startTick-l).forEach(B=>b+="r"+B),l=h.startTick);const{base:g,acc:N,octave:v}=V(h.pitch);v!==d&&(b+=P(d,v),d=v);const w=h.volume??D;w!==c&&(b+="v"+String(w),c=w);const E=y(h.durationTick|0),x=h.__tiedFromPrev===!0;E.forEach((_,B)=>{const W=B>0||x;b+=(W?"&":"")+g+N+_}),l+=h.durationTick}return T(Number.MAX_SAFE_INTEGER),b}export{nt as extractTempoAnchorsFromMMLBodies,F as mmlToNotes,st as newOptimizeBody,et as notesToMML,Z as notesToMMLRaw,it as notesToMMLWithTempos};
